<?php
require 'vendor/autoload.php';
require 'Cryptor.php';

class InformesController extends Zend_Controller_Action
{

    public function init()
    {
        $this->initView();
        $this->view->baseUrl = $this->_request->getBaseUrl();
    }

    public function indexAction()
    {


    }

    public function informenotasAction()
    {

        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $est = new Zend_Session_Namespace('establecimiento');
        $idestablecimiento = $est->establecimiento;

        $usuario = new Zend_Session_Namespace('id');

        $user = $usuario->id;

        $cargo = new Zend_Session_Namespace('cargo');
        $rol = $cargo->cargo;

        $modelalumnos = new Application_Model_DbTable_Alumnos();
        $modelcurso = new Application_Model_DbTable_Cursos();

        if ($rol == '2') {
            $detallecurso = $modelcurso->getcursocuentaestablecimiento($user, $idestablecimiento, $idperiodo);
            if (count($detallecurso) > 1) {
                for ($i = 0; $i < count($detallecurso); $i++) {
                    $lista[$i] = $modelalumnos->listarusuario($idperiodo, $detallecurso[$i]['idCursos']);

                }
                $this->view->variable = 1;
                $this->view->datos = $lista;
                $this->view->monitoreo=$detallecurso[0]['monitoreo'];

            } else {

                if (!empty($detallecurso[0]['idCursos'])) {

                    $lista = $modelalumnos->listarusuario($idperiodo, $detallecurso[0]['idCursos']);
                    $this->view->variable = 0;
                    $this->view->datos = $lista;
                    $this->view->monitoreo=$detallecurso[0]['monitoreo'];
                }

            }

        }
        if ($rol == '1') {

            $listaalumnos = $modelalumnos->listar($idperiodo);
            $this->view->datos = $listaalumnos;

        }

        if ($rol == '3' || $rol == '6') {

            $listaalumnos = $modelalumnos->listarestablecimiento($idestablecimiento, $idperiodo);
            $this->view->datos = $listaalumnos;

        }

    }


    public function generaralumnoanualAction()
    {

        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();


        $idtipoev = new Zend_Session_Namespace('tipoevaluacion');
        $idtevalucacion = $idtipoev->tipoevaluacion;

        $paso = false;
        $id = $this->_getParam('id', 0);

        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;
        $modeldetalle = new Application_Model_DbTable_AlumnosDetalle();

        $verifica = $modeldetalle->get($id, 10, $idperiodo);

        if ($verifica) {

            $verifica = $modeldetalle->get($id, 10, $idperiodo);
            $idp = 10;

            $observacion = $verifica[0]["observaciones"];

            $idd = $verifica[0]["idDetalle"];
            echo "<link href='../../../../../css/formpdf.css' type='text/css' rel='stylesheet' /><div class='col_12 column'><form class='basic-grey' method='post' action='generaralumnoanual'><label  for='obs'><span> Observaciones:</span> <textarea id='obs' name='obs' rows='5' cols='40'>" . $observacion . "</textarea></label><label><span>&nbsp;</span><button name='mod' value='1'>Modificar</button><button name='cont' value='1'>Continuar</button> <input type='hidden' name='id' value='" . $id . "' /><input type='hidden' name='idp' value='10' /><input type='hidden' name='idd' value='" . $idd . "' /></label></form></div>";


        } else {
            echo "<link href='../../../../../css/formpdf.css' type='text/css' rel='stylesheet' /><div class='col_12 column'><form class='basic-grey' method='post' action='generaralumnoanual'><label  for='obs'><span> Observaciones:</span> <textarea id='obs' name='obs' rows='5' cols='40'></textarea></label><label><span>&nbsp;</span><input type='submit' name='submit' value='Enviar'> <input type='hidden' name='id' value='" . $id . "' /><input type='hidden' name='idp' value='10' /></label></form></div>";

        }

        if ($this->getRequest()->isPost()) {

            $id = $_POST["id"];
            $idp = $_POST["idp"];
            $idd = $_POST["idd"];

            if (empty($_POST['cont']) && empty($_POST['mod'])) {
                $modeldetalle->agregar(0, 0, 0, 0, $_POST["obs"], 0, $idp, $_POST["id"], $idperiodo);

            }
            if (empty($_POST['cont']) && $_POST['mod'] == 1) {
                $modeldetalle->cambiar(0, 0, 0, 0, $_POST["obs"], 0, $idp, $_POST["idd"]);
            }
            if ($_POST['cont'] == 1) {
                $paso = true;
            }

            $verifica = $modeldetalle->get($id, $idp, $idperiodo);
            $verifica2 = $modeldetalle->get($id, 1, $idperiodo);

            $observacion = $verifica[0]["observaciones"];
            $apoderado = $verifica2[0]["nombreApoderado"];

            $paso = true;
        }

        if ($paso) {


            $modeloalumnoactual = new Application_Model_DbTable_Alumnosactual();
            $alumnoactual = $modeloalumnoactual->get($id);
            $idalumnoactual = $alumnoactual[0]['idAlumnosActual'];

            if ($idtevalucacion == 1) {
                $this->redirect('/Informes/generaralumnocursoanual/id/' . $idalumnoactual . '/t/1');
            } else {
                $this->redirect('/Informes/generaralumnocursoanualt/id/' . $idalumnoactual . '/t/1');
            }


        }

    }

    public function certificadoalumnoAction()
    {

        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;


        $est = new Zend_Session_Namespace('establecimiento');
        $idestablecimiento = $est->establecimiento;

        $usuario = new Zend_Session_Namespace('id');
        $user = $usuario->id;

        $cargo = new Zend_Session_Namespace('cargo');
        $rol = $cargo->cargo;

        $modelcurso = new Application_Model_DbTable_Cursos();

        $cuenta = $modelcurso->getcursocuentaestablecimiento($user, $idestablecimiento, $idperiodo);

        $modelalumnos = new Application_Model_DbTable_Alumnosactual();

        if ($rol == '2') {
            if (count($cuenta) > 1) {
                for ($i = 0; $i < count($cuenta); $i++) {
                    $lista[$i] = $modelalumnos->listaralumnoscurso($cuenta[$i]['idCursos'], $idperiodo);

                }
                $this->view->variable = 1;
                $this->view->datos = $lista;

            } else {

                if (!empty($cuenta[0]['idCursos'])) {

                    $lista = $modelalumnos->listaralumnoscurso($cuenta[0]['idCursos'], $idperiodo);
                }
                $this->view->variable = 0;
                $this->view->datos = $lista;
            }

        }
        if ($rol == '1') {

            $lista = $modelalumnos->listar($idperiodo);

            $this->view->datos = $lista;

        }
        if ($rol == '3' || $rol == '6') {

            $lista = $modelalumnos->listarestablecimiento($idestablecimiento, $idperiodo);

            $this->view->datos = $lista;

        }

    }

    public function matriculasAction()
    {

        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $est = new Zend_Session_Namespace('establecimiento');
        $idestablecimiento = $est->establecimiento;

        $usuario = new Zend_Session_Namespace('id');
        $user = $usuario->id;

        $cargo = new Zend_Session_Namespace('cargo');
        $rol = $cargo->cargo;

        $modelcurso = new Application_Model_DbTable_Cursos();

        $cuenta = $modelcurso->getcursocuentaestablecimiento($user, $idestablecimiento, $idperiodo);

        $modelalumnos = new Application_Model_DbTable_Alumnosactual();

        if ($rol == '2') {
            if (count($cuenta) > 1) {
                for ($i = 0; $i < count($cuenta); $i++) {
                    $lista[$i] = $modelalumnos->listaralumnoscurso($cuenta[$i]['idCursos'], $idperiodo);

                }
                $this->view->variable = 1;
                $this->view->datos = $lista;

            } else {

                if (!empty($cuenta[0]['idCursos'])) {

                    $lista = $modelalumnos->listaralumnoscurso($cuenta[0]['idCursos'], $idperiodo);
                }
                $this->view->variable = 0;
                $this->view->datos = $lista;
            }

        }
        if ($rol == '1') {

            $lista = $modelalumnos->listar($idperiodo);

            $this->view->datos = $lista;

        }
        if ($rol == '3' || $rol == '6') {

            $lista = $modelalumnos->listarestablecimiento($idestablecimiento, $idperiodo);

            $this->view->datos = $lista;

        }

    }

    public function generacertificadoAction()
    {

        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();

        $id = $this->_getParam('id', 0);

        $tabla = new Application_Model_DbTable_Alumnos();
        $modelCurso = new Application_Model_DbTable_Cursos();
        $tabla2 = $tabla->getcertificadoalumno($id);


        $comuna = new Application_Model_DbTable_Comuna();
        $rowset = $comuna->getcomunasolo($tabla2[0]['comuna']);

        $periodo = new Zend_Session_Namespace('nombreperiodo');
        $nombreperiodo = $periodo->nombreperiodo;

        $periodos = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodos->periodo;

        $rutset = $tabla2[0]['rutAlumno'];
        if (!empty($rutset)) {
            $rest = substr($rutset, 0, -1);
            $ultimo = substr($rutset, -1);
            $formatomiles = number_format($rest, 0, "", ".");
            $formatofinal = $formatomiles . '-' . $ultimo;

        }
        $date = new DateTime;
        $fechain = $date->format('Y-m-d');
        $cortado = explode("-", $fechain);
        $dias = array("Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado");
        $meses = array("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre");

        $fecha_final = $dias[date('w', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]))] . " " . $cortado[2] . " de " . $meses[date('n', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0])) - 1] . " del " . date('Y', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]));

        $modelCuenta = new Application_Model_DbTable_Cuentas();
        $detalleest = $modelCurso->listarcursoid($tabla2[0]['idCursos'], $idperiodo);
        if (!empty($detalleest[0]['idDirector'])) {
            $director = $modelCuenta->get($detalleest[0]['idDirector']);
        } else {
            $director = array();
        }


        if (count($director) == 0) {
            echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta director\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            exit;

        }

        $logo = getcwd();
        $logo .= "/application/documentos/logos/" . $tabla2[0]['extension'];


        $titulo = "CERTIFICADO DE ALUMNO REGULAR";
        $nombrecomuna = strtr(strtoupper($rowset[0]['nombreComuna']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ");
        $nombreestablecimiento = strtr(strtoupper($tabla2[0]['nombreEstablecimiento']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ");
        $nombreestablecimientom = strtr(strtolower($nombreestablecimiento), "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ", "àèìòùáéíóúçñäëïöü");

        $infoder = '<div id="infoder"><p style="text-align:center;"><b>' . $nombreestablecimiento . '</b><br><span style="text-decoration:underline;"><b>' . $nombrecomuna . '</b></span></p></div>';

        if (file_exists($logo)) {
            $encabezado = '<img  src="' . $logo . '" />' . $infoder . '<h4 style="position:absolute;top:200px;text-align:center;text-decoration:underline;">' . $titulo . '</h4>';

        } else {
            $encabezado = '' . $infoder . '<h4 style="position:absolute;top:200px;text-align:center;text-decoration:underline;">' . $titulo . '</h4>';

        }
        $style = "body{
font:14px Arial, Tahoma, Verdana, Helvetica, sans-serif;

color:#000;
}

#infoizq{
position:absolute;
left:0px;
top:115px;
}

#infoder{
position:absolute;
right:0px;
top:60px;
font-size:10px;
text-justify:inter-word;
}

#infoder p{
margin-top:5px;
}
a h1{
font-size:35px;
color:#FFF;
}
img{
width:90px;
height:100px;
position:absolute;
top:60px;
left:60px;
}

table{
width:100%;
height:auto;
margin:25px 0 10px 0;
text-align:left;
color:#000000;

}

table td,th{
padding:6px;
}
 ";

        $nombredirector = strtr(strtoupper($director['nombrescuenta']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ");
        $apdirector = strtr(strtoupper($director['paternocuenta']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ");
        $amdirector = strtr(strtoupper($director['maternocuenta']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ");
        $nombrealumno = strtr(strtoupper($tabla2[0]['nombres']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ");
        $apalumno = strtr(strtoupper($tabla2[0]['apaterno']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ");
        $amalumno = strtr(strtoupper($tabla2[0]['amaterno']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ");

        $nombreniveles = strtr(strtoupper($detalleest[0]['nombreGrado'] . ' ' . $detalleest[0]['letra']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ");

        $html .= "<table align='center'>
<tr>
    <td style='width:80%;'><p align=justify style='text-indent:1.5em;'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>" . $nombredirector . " " . $apdirector . " " . $amdirector . "</b> , Director(a) de " . ucwords($nombreestablecimientom) . ", RBD Nº 00" . $tabla2[0]['rbd'] . " Decreto Cooperador de la función docente Nº " . $detalleest[0]['numeroDecreto'] . " de 1982, Certifica que el alumno(a) <b> " . $nombrealumno . " " . $apalumno . " " . $amalumno . ", RUT: " . $formatofinal . " </b>, se encuentra matriculado(a) en <b>" . $nombreniveles . "</b> según consta con el Nº " . $tabla2[0]['numeromatricula'] . "  en el Registro Escolar de Educación General Básica para el año lectivo " . $nombreperiodo . ".</p></td>
</tr>
</table>
<div style='text-align:center; margin-top:15px;text-indent:2cm;style='width:80%;'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Se extiende el presente certificado a solicitud del apoderado para los fines que estime convenientes.</div>

<div style='text-align:center; margin-top:190px;'><p><i><span style='text-decoration:underline;'>" . $nombredirector . " " . $apdirector . " " . $amdirector . "</span></i><br>Director(a) " . ucwords($nombreestablecimientom) . "</p></div>

<div style='text-align:left; margin-top:90px;'><p>" . strtr(strtoupper($detalleest[0]['nombreComuna']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . ", " . $fecha_final . ".</p></div>
<div style='text-align:center; margin-top:130px;font-size:12px;'>" . $tabla2[0]['direccion'] . ".<br> FONO: " . $tabla2[0]['telefono'] . "</div>
";

        $content = '
        <!doctype html>
        <html>
        <head>
            <style>' . $style . '</style>
        </head>
        <body>  <page_footer>
        <table class="page_footer">

        </table>
    </page_footer>'
            . $encabezado
            . $html .
            '</body>
        </html>';


        if ($content != '') {

            echo '<page>' . $content . '</page>';
            $content = ob_get_clean();
            require 'fpdf/html2pdf.class.php';
            try {
                $pdf = new HTML2PDF('P', 'LETTER', 'es', array(10, 10, 10, 10) /*márgenes*/); //los márgenes también pueden definirse en <page> ver documentación
                $pdf->WriteHTML($content);
                if (preg_match("/MSIE/i", $_SERVER["HTTP_USER_AGENT"])) {
                    header("Content-type: application/PDF");
                } else {
                    header("Content-type: application/PDF");
                    header("Content-Type: application/pdf");
                }

                $pdf->Output('Planificacion.pdf', I);
            } catch (HTML2PDF_exception $e) {
                echo $e;
            }
        }

    }

    public function personalidadAction()
    {

        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $est = new Zend_Session_Namespace('establecimiento');
        $idestablecimiento = $est->establecimiento;

        $usuario = new Zend_Session_Namespace('id');

        $user = $usuario->id;

        $cargo = new Zend_Session_Namespace('cargo');
        $rol = $cargo->cargo;

        $modelcurso = new Application_Model_DbTable_Cursos();

        $cuenta = $modelcurso->getcursocuentaestablecimiento($user, $idestablecimiento, $idperiodo);

        $modelalumnos = new Application_Model_DbTable_Alumnosactual();

        if ($rol == '2') {
            if (count($cuenta) > 1) {
                for ($i = 0; $i < count($cuenta); $i++) {
                    $lista[$i] = $modelalumnos->listaralumnoscurso($cuenta[$i]['idCursos'], $idperiodo);

                }
                $this->view->variable = 1;
                $this->view->datos = $lista;

            } else {

                if (!empty($cuenta[0]['idCursos'])) {

                    $lista = $modelalumnos->listaralumnoscurso($cuenta[0]['idCursos'], $idperiodo);
                }
                $this->view->variable = 0;
                $this->view->datos = $lista;
            }

        }
        if ($rol == '1') {

            $lista = $modelalumnos->listar($idperiodo);

            $this->view->datos = $lista;

        }
        if ($rol == '3' || $rol == '6') {

            $lista = $modelalumnos->listarestablecimiento($idestablecimiento, $idperiodo);

            $this->view->datos = $lista;

        }

    }

    public function personalidadcursoAction()
    {

        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $est = new Zend_Session_Namespace('establecimiento');
        $idestablecimiento = $est->establecimiento;

        $usuario = new Zend_Session_Namespace('id');

        $user = $usuario->id;

        $cargo = new Zend_Session_Namespace('cargo');
        $rol = $cargo->cargo;

        $table = new Application_Model_DbTable_Cursos();

        if ($rol == '3' || $rol == '4' || $rol == '6') {
            $this->view->datos = $table->listartodasactual($idestablecimiento, $idperiodo);

        }
        if ($rol == '1') {

            $this->view->datos = $table->listar($idperiodo);

        }

        if ($rol == '2') {

            $this->view->datos = $table->listarcursoiddocenteactual($user, $idestablecimiento, $idperiodo, 1);

        }

    }

    public function agregapersonalidadAction()
    {
        $this->view->title = "Crear Nuevo Informe de Personalidad";
        $this->view->headTitle($this->view->title);

        $idalumno = $this->_getParam('id', 0);

        if ($idalumno > 0) {
            $alumno = new Application_Model_DbTable_Alumnos();
            $alumnos = $alumno->get($idalumno);
            $form = new Application_Form_Personalidad();
            $this->view->form = $form;
            $this->view->datos = $alumnos;

        } else {
            $messages = $this->_helper->getHelper('FlashMessenger')->addMessage('Error');
            $this->view->assign('messages', $messages);

        }

        if ($this->getRequest()->isPost()) {
            $formData = $this->getRequest()->getPost();
            if ($form->isValid($formData)) {

                $r1 = $form->getValue('R1');
                $r2 = $form->getValue('R2');
                $r3 = $form->getValue('R3');
                $r4 = $form->getValue('R4');
                $r5 = $form->getValue('R5');
                $r6 = $form->getValue('R6');
                $r7 = $form->getValue('R7');
                $r8 = $form->getValue('R8');
                $r9 = $form->getValue('R9');
                $r10 = $form->getValue('R10');
                $r11 = $form->getValue('R11');
                $r12 = $form->getValue('R12');
                $r13 = $form->getValue('R13');
                $r14 = $form->getValue('R14');
                $r15 = $form->getValue('R15');
                $r16 = $form->getValue('R16');
                $r17 = $form->getValue('R17');
                $r18 = $form->getValue('R18');
                $r19 = $form->getValue('R19');
                $segmento = $form->getValue('segmento');
                $curso = $form->getValue('idCursos');
                $idalumno = $form->getValue('idAlumnos');
                $comentario = $form->getValue('comentario');
                $tipo = 1;
                $periodo = new Zend_Session_Namespace('periodo');
                $idperiodo = $periodo->periodo;

                $per = new Application_Model_DbTable_Personalidad();

                $db = Zend_Db_Table_Abstract::getDefaultAdapter();

                $valida = $per->validapersonalidad($idalumno, $idperiodo, $segmento, $tipo);

                $db->beginTransaction();
                if (empty($valida)) {

                    try {
                        $per->agregar($r1, $r2, $r3, $r4, $r5, $r6, $r7, $r8, $r9, $r10, $r11, $r12, $r13, $r14, $r15, $r16, $r17, $r18, $r19, $tipo, $segmento, $idalumno, $curso, $idperiodo, $comentario);
                        $db->commit();
                        $this->_helper->redirector('personalidad');
                    } catch (Exception $e) {
                        $db->rollBack();
                        echo $e;
                    }

                } else {
                    $messages = $this->_helper->getHelper('FlashMessenger')->addMessage('El registro que intenta crear ya existe');
                    $this->view->assign('messages', $messages);
                }
            } else {
                $form->populate($formData);
            }
        } else {
            $idalumno = $this->_getParam('id', 0);
            if ($idalumno > 0) {
                $alumno = new Application_Model_DbTable_Alumnos();
                $alumnos = $alumno->getcomunaalumno($idalumno);
                $form = new Application_Form_Personalidad();
                $this->view->form = $form;
                $form->populate($alumnos[0]);

            }
        }

    }



    public function editarpersonalidadAction()
    {
        $this->view->title = "Modificar Informe de Personalidad";
        $this->view->headTitle($this->view->title);

        $form = new Application_Form_Personalidad();
        $form->removeElement('segmento');

        $idtipoev = new Zend_Session_Namespace('tipoevaluacion');
        $idtevalucacion = $idtipoev->tipoevaluacion;

        if ($this->getRequest()->isPost()) {
            if (empty($_POST['cont'])) {
                $formData = $this->getRequest()->getPost();
                if ($form->isValid($formData)) {
                    $idpersonalidad = $form->getValue('idPersonalidad');
                    $r1 = $form->getValue('R1');
                    $r2 = $form->getValue('R2');
                    $r3 = $form->getValue('R3');
                    $r4 = $form->getValue('R4');
                    $r5 = $form->getValue('R5');
                    $r6 = $form->getValue('R6');
                    $r7 = $form->getValue('R7');
                    $r8 = $form->getValue('R8');
                    $r9 = $form->getValue('R9');
                    $r10 = $form->getValue('R10');
                    $r11 = $form->getValue('R11');
                    $r12 = $form->getValue('R12');
                    $r13 = $form->getValue('R13');
                    $r14 = $form->getValue('R14');
                    $r15 = $form->getValue('R15');
                    $r16 = $form->getValue('R16');
                    $r17 = $form->getValue('R17');
                    $r18 = $form->getValue('R18');
                    $r19 = $form->getValue('R19');
                    $tipo = 1;
                    $comentario = $form->getValue('comentario');

                    $per = new Application_Model_DbTable_Personalidad();

                    $db = Zend_Db_Table_Abstract::getDefaultAdapter();
                    $db->beginTransaction();
                    try {

                        $per->cambiar($idpersonalidad, $r1, $r2, $r3, $r4, $r5, $r6, $r7, $r8, $r9, $r10, $r11, $r12, $r13, $r14, $r15, $r16, $r17, $r18, $r19, $tipo, $comentario);
                        $db->commit();
                        $this->_helper->redirector('personalidad');
                    } catch (Exception $e) {
                        $db->rollBack();
                        echo $e;
                    }
                } else {
                    $this->view->form = $form;
                    $form->populate($formData);
                }
            } else {
                $idalumno = $this->_getParam('id', 0);
                $idseleccion = $_POST['per'];

                $periodo = new Zend_Session_Namespace('periodo');
                $idperiodo = $periodo->periodo;

                $modelpersonalidad = new Application_Model_DbTable_Personalidad();
                $datospersonalidad = $modelpersonalidad->getpersonalidad($idalumno, $idperiodo,$idseleccion);

                $form->populate($datospersonalidad[0]);
                $this->view->form = $form;

            }

        } else {
            $idalumno = $this->_getParam('id', 0);

            if ($idalumno > 0) {

                $periodo = new Zend_Session_Namespace('periodo');
                $idperiodo = $periodo->periodo;

                $modelpersonalidad = new Application_Model_DbTable_Personalidad();
                $datospersonalidad = $modelpersonalidad->getpersonalidad($idalumno, $idperiodo,null);


                if (count($datospersonalidad) > 1) {
                    if($idtevalucacion==1){

                        echo "<link href='../../../../../css/formpdf.css' type='text/css' rel='stylesheet' /><div class='col_12 column'><form class='basic-grey' method='post' action='" . $idalumno . "'><label  for='trab'> <span>Seleccione Periodo:</span> <select name='per'><option value='1'>Primer Semestre</option><option value='2'>Segundo Semestre</option></select> </label><button name='cont'value='1'>Continuar</button></label></form></div>";


                    }elseif($idtevalucacion==2){
                        echo "<link href='../../../../../css/formpdf.css' type='text/css' rel='stylesheet' /><div class='col_12 column'><form class='basic-grey' method='post' action='" . $idalumno . "'><label  for='trab'> <span>Seleccione Periodo:</span> <select name='per'><option value='3'>Primer Trimestre</option><option value='4'>Segundo Trimestre</option><option value='5'>Tercer Trimestre</option></select> </label><button name='cont'value='1'>Continuar</button></label></form></div>";

                    }


                }
                if (count($datospersonalidad) == 1) {

                    $form->populate($datospersonalidad[0]);
                    $this->view->form = $form;

                }
                if (count($datospersonalidad) == 0) {
                    $messages = $this->_helper->getHelper('FlashMessenger')->addMessage('No existen datos para modificar');
                    $this->view->assign('messages', $messages);
                }

            }
        }

    }



    public function generapersonalidadAction()
    {

        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();

        $id = $this->_getParam('id', 0);
        $p = $this->_getParam('p', 0);

        $this->redirect('/Informes/generapersonalidadcurso/id/' . $id . '/p/' . $p . '/t/2');


    }


    public function generaralumnoperiodoAction()
    {

        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();
        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $paso = false;
        $id = $this->_getParam('id', 0);
        $segmento = $this->_getParam('p', 0);
        $modeloalumnodetalle = new Application_Model_DbTable_AlumnosDetalle();

        $verifica = $modeloalumnodetalle->get($id, $segmento, $idperiodo);

        if ($verifica) {
            $verifica = $modeloalumnodetalle->get($id, $segmento, $idperiodo);
            $idp = $segmento;

            $diastrabajados = $verifica[0]["diasTrabajado"];
            $diasin = $verifica[0]["diasInasistencia"];
            $asistencia = $verifica[0]["asistencia"];
            $atraso = $verifica[0]["numeroatrasos"];
            $observacion = $verifica[0]["observaciones"];
            $apoderado = $verifica[0]["nombreApoderado"];
            $idd = $verifica[0]["idDetalle"];
            echo "<link href='../../../../../css/formpdf.css' type='text/css' rel='stylesheet' /><div class='col_12 column'><form class='basic-grey' method='post' action='generaralumnoperiodo'><label  for='trab'> <span>Nº dias Trabajados:</span>  <input class='col_2' type='text' id='trab' value='" . $diastrabajados . "' name='trab' /> </label> <label class='col_10' for='ina'> <span>Nº dias Inasistencia:</span> <input  type='text' id='ina' value='" . $diasin . "' name='ina' /></label>  <label  for='atr'><span> Nº Atrasos: </span> <input type='text' id='atr' value='" . $atraso . "' name='atr' /> </label><label  for='obs'><span> Observaciones:</span> <textarea id='obs' name='obs' rows='5' cols='40'>" . $observacion . "</textarea></label><label for='apod'><span>Nombre de Apoderado</span><input type='text' name='apod' value='" . $apoderado . "' id='apod' /></label><label><span>&nbsp;</span><button name='mod'value='1'>Modificar</button><button name='cont'value='1'>Continuar</button> <input type='hidden' name='id' value='" . $id . "' /><input type='hidden' name='idp' value='" . $segmento . "' /><input type='hidden' name='idd' value='" . $idd . "' /></label></form></div>";

            //si el usuario desea modificar

        } else {
            echo "<link href='../../../../../css/formpdf.css' type='text/css' rel='stylesheet' /><div class='col_12 column'><form class='basic-grey' method='post' action='generaralumnoperiodo'><label  for='trab'> <span>Nº dias Trabajados:</span>  <input class='col_2' type='text' id='trab' name='trab' /> </label> <label class='col_10' for='ina'> <span>Nº dias Inasistencia:</span> <input  type='text' id='ina' name='ina' /></label>  <label  for='atr'><span> Nº Atrasos: </span> <input type='text' id='atr' name='atr' /> </label><label  for='obs'><span> Observaciones:</span> <textarea id='obs' name='obs' rows='5' cols='40'></textarea></label><label for='apod'><span>Nombre de Apoderado</span><input type='text' name='apod' id='apod' /></label><label><span>&nbsp;</span><input type='submit' name='submit' value='Enviar'> <input type='hidden' name='id' value='" . $id . "' /><input type='hidden' name='idp' value='" . $segmento . "' /></label></form></div>";

        }


        if ($this->getRequest()->isPost()) {

            $id = $_POST["id"];
            $idp = $_POST["idp"];
            $idd = $_POST["idd"];

            if (empty($_POST['cont']) && empty($_POST['mod'])) {
                $modeloalumnodetalle->agregar($_POST["trab"], $_POST["ina"], $_POST["asi"], $_POST["atr"], $_POST["obs"], $_POST["apod"], $idp, $_POST["id"], $idperiodo);

            }
            if (empty($_POST['cont']) && $_POST['mod'] == 1) {
                $modeloalumnodetalle->cambiar($_POST["trab"], $_POST["ina"], $_POST["asi"], $_POST["atr"], $_POST["obs"], $_POST["apod"], $idp, $_POST["idd"]);
            }
            if ($_POST['cont'] == 1) {
                $paso = true;
            }

            $verifica = $modeloalumnodetalle->get($id, $idp, $idperiodo);
            $paso = true;
        }

        if ($paso) {

            $modeloalumnoactual = new Application_Model_DbTable_Alumnosactual();
            $alumnoactual = $modeloalumnoactual->get($id);
            $idalumnoactual = $alumnoactual[0]['idAlumnosActual'];

            $this->redirect('/Informes/generaralumnocurso/id/' . $idalumnoactual . '/p/' . $idp . '/t/1');


        }

    }

    public function informecursoAction()
    {

        $table = new Application_Model_DbTable_Cursos();
        $est = new Zend_Session_Namespace('establecimiento');
        $establecimiento = $est->establecimiento;

        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $usuario = new Zend_Session_Namespace('id');
        $user = $usuario->id;

        $cargo = new Zend_Session_Namespace('cargo');
        $rol = $cargo->cargo;


        if ($rol == '3' || $rol == '4' || $rol == '6') {
            $this->view->datos = $table->listartodasactual($establecimiento, $idperiodo);

        }
        if ($rol == '1') {
            $this->view->datos = $table->listaractual($idperiodo);


        }

        if ($rol == '2') {

            $detallecurso[0] = $table->listarcursodocente($user, $idperiodo, $establecimiento)->toArray();

            for ($i = 0; $i < count($detallecurso[0]); $i++) {
                if ($user === $detallecurso[0][$i]['idCuentaJefe']) {
                    $detallecurso[0][$i]['authjefe'] = true;
                    $verifica[] = 1;

                }
            }
            if (empty($verifica)) {
                $cursosjefatura = $table->listarcursoiddocenteactual($user, $establecimiento, $idperiodo, 1);
                for ($i = 0; $i < count($cursosjefatura); $i++) {
                    $cursosjefatura[$i]['authjefe'] = true;
                    $detallecurso[0][] = $cursosjefatura[$i];

                }

            }
            $this->view->datos = $detallecurso;
        }

    }


    public function generapersonalidadcursoAction()
    {

        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();

        $style = "body{
font:10px Arial, Tahoma, Verdana, Helvetica, sans-serif;
font-size:10px;
color:#000;
}
div.inline { float:left; }
.clearBoth { clear:both; }

img{
width:90px;
height:100px;
}
p{
  margin 2px;
}
table{
width:100%;
height:auto;
margin:5px 0 30px 0;
border-collapse:collapse;
text-align:center;
color:#000000;
}
table td,th{
padding:3px;
}
table th{
padding:3px;
text-align:justify;
font-weight:bold;
color:#000000;
}
table td{
text-align:justify;
}

table.page_footer {width: 100%; border: none; border-top: solid 1mm #AAAADD; padding: 2mm;margin-top:30px}
.menu a{
color:#FFF;
}";

// formato de la fecha

        $date = new DateTime;
        $fechain = $date->format('Y-m-d');
        $cortado = explode("-", $fechain);
        $dias = array("Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado");
        $meses = array("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre");
        $fecha_final = $dias[date('w', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]))] . " " . $cortado[2] . " de " . $meses[date('n', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0])) - 1] . " del " . date('Y', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]));


        $periodos = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodos->periodo;

        $est = new Zend_Session_Namespace('establecimiento');
        $idestablecimiento = $est->establecimiento;


        $id = $this->_getParam('id', 0);
        $p = $this->_getParam('p', 0);
        $tipo = $this->_getParam('t', 0);

        $modelCurso = new Application_Model_DbTable_Cursos();
        $modeloalumnoactual = new Application_Model_DbTable_Alumnosactual();
        $tabla = new Application_Model_DbTable_Alumnos();
        if ($tipo == 1) {
            $listadealumnos = $modeloalumnoactual->listaralumnoscursoactual($id, $idperiodo);

        } else {
            $listadealumnos = $modeloalumnoactual->get($id);
            $id = $listadealumnos[0]['idCursosActual'];
        }

        $profesorj = $modelCurso->get($id);

        $modelCuenta = new Application_Model_DbTable_Cuentas();
        if ($profesorj[0]['idCuentaJefe'] != 0 || empty($profesorj[0]['idCuentaJefe'])) {
            $Profesorjefe = $modelCuenta->getusuario($profesorj[0]['idCuentaJefe'], $idperiodo);
        }
        $detalleest = $modelCurso->listarcursoid($id, $idperiodo);

        $director = $modelCuenta->get($detalleest[0]['idDirector']);


        $contadoraux = 0;


        if ($detalleest[0]['idCodigoTipo'] == 110) {
            $titulo = 'INFORME DE DESARROLLO PERSONAL Y SOCIAL ENSEÑANZA BÁSICA';
            $cuenta = 19;
        }
        if ($detalleest[0]['idCodigoTipo'] == 310 || $detalleest[0]['idCodigoTipo'] == 360) {
            $titulo = 'INFORME DE DESARROLLO PERSONAL Y SOCIAL ENSEÑANZA MEDIA HUMANÍSTICO- CIENTÍFICA';
            $cuenta = 19;
        }
        if ($detalleest[0]['idCodigoTipo'] == 410 || $detalleest[0]['idCodigoTipo'] == 463 || $detalleest[0]['idCodigoTipo'] == 510 || $detalleest[0]['idCodigoTipo'] == 610 || $detalleest[0]['idCodigoTipo'] == 710 || $detalleest[0]['idCodigoTipo'] == 810 || $detalleest[0]['idCodigoTipo'] == 910) {
            $titulo = 'INFORME DE DESARROLLO PERSONAL Y SOCIAL ENSEÑANZA MEDIA TÉCNICO PROFESIONAL';
            $cuenta = 21;
        }
        $tituloest = "<b>" . $detalleest[0]['nombreEstablecimiento'] . "</b>";


        $logo = getcwd();
        $logo .= "/application/documentos/logos/" . $detalleest[0]['extension'];




        if (file_exists($logo)) {
            $encabezado = '<p style="position:absolute;top:3px;text-align:center"><img  src="' . $logo . '" /></p><h5 style="position:absolute;top:110px;text-align:center">' . $titulo . '</h5><h4 style="position:absolute;top:130px;text-align:center">' . $tituloest . '</h4>';
        } else {
            $encabezado = '<p style="position:absolute;top:3px;text-align:center"></p><h5 style="position:absolute;top:110px;text-align:center">' . $titulo . '</h5><h4 style="position:absolute;top:130px;text-align:center">' . $tituloest . '</h4>';
        }


        for ($y = 0; $y < count($listadealumnos); $y++) {
            $tabla2 = array();
            $erres = array();

            $tabla2 = $tabla->getcertificadoperso($listadealumnos[$y]['idAlumnos'], $p, $idperiodo);

            if (count($tabla2[0]) == 0) {
                continue;

            }

            $html[$contadoraux] .= $encabezado;

            if ($detalleest[0]['idEstablecimiento'] == 12) {

                $conceptostexto = "<table align='center' border='1'>
                            <tr><th colspan='4' style='text-align:center;'>INDICADORES</th></tr>
                            <tr><td style='width:141px;font-size:12px;'>DE: Desarrollo Excelente</td>
                                <td style='width:141px;font-size:12px;'>DA: Desarrollo Adecuado</td>
                                <td style='width:133px;font-size:12px;'>PS: Puede Superarse</td>
                                <td style='width:133px;font-size:12px;'>NR: Necesita Refuerzo</td>
                              
                            </tr>
                            </table>";
                if (!empty($tabla2[0]['comentario']) || $tabla2[0]['comentario'] != "") {
                    $conceptostexto .= "<table align='center' border='1'>
                            <tr><th style='width:595px;text-align:center;'>Observaciones</th></tr>
                            <tr><td>" . $tabla2[0]['comentario'] . "</td></tr>
                            </table>";

                }


                for ($i = 1; $i < 20; $i++) {
                    $r = 'R' . $i;
                    if ($tabla2[0][$r] == '1') {
                        $erres[$i] = 'DE';
                    }

                    if ($tabla2[0][$r] == '2') {
                        $erres[$i] = 'DA';
                    }

                    if ($tabla2[0][$r] == '3') {
                        $erres[$i] = 'PS';
                    }

                    if ($tabla2[0][$r] == '4') {
                        $erres[$i] = 'NR';
                    }

                }
            } else {
                $conceptostexto = "<table align='center' border='1'>
<tr><th colspan='5' style='text-align:center;'>INDICADORES</th></tr>
<tr><td style='width:107px;font-size:12px;'>S: Siempre</td>
    <td style='width:107px;font-size:12px;'>G: Generalmente</td>
    <td style='width:107px;font-size:12px;'>O: Ocasionalmente</td>
    <td style='width:106px;font-size:12px;'>N: Nunca</td>
    <td style='width:107px;font-size:12px;'>NO: No Observado</td>
</tr>
</table> ";
                for ($i = 1; $i < 20; $i++) {
                    $r = 'R' . $i;
                    if ($tabla2[0][$r] == '1') {
                        $erres[$i] = 'S';
                    }

                    if ($tabla2[0][$r] == '2') {
                        $erres[$i] = 'G';
                    }

                    if ($tabla2[0][$r] == '3') {
                        $erres[$i] = 'O';
                    }

                    if ($tabla2[0][$r] == '4') {
                        $erres[$i] = 'N';
                    }

                    if ($tabla2[0][$r] == '5') {
                        $erres[$i] = 'NO';
                    }


                }
            }


            switch ($tabla2[0]['segmento']){
                case 1:
                    $segmento='I Semestre';
                    break;

                case 2:
                    $segmento='II Semestre';
                    break;

                case 3:
                    $segmento='I Trimestre';
                    break;

                case 4:
                    $segmento='II Trimestre';
                    break;

                case 5:
                    $segmento='III Trimestre';
                    break;

            }


            $html[$contadoraux] .= "<table style='border: none;' align='center'><tr><td colspan='2' style='width: 595px;'><b>Nombre: </b>" . $tabla2[0]['nombres'] . " " . $tabla2[0]['apaterno'] . " " . $tabla2[0]['amaterno'] . "<br></td></tr><tr><td><b>Curso:</b> " . $tabla2[0]['nombreGrado'] . " " . $tabla2[0]['letra'] . "&nbsp;&nbsp; <b>Fecha</b> : " . $fecha_final . "</td></tr></table>";

            $html[$contadoraux] .= "<table align='center' border='1'>
<tr><th>ACCIONES, ACTIVIDADES, CAPACIDADES, RASGOS PERSONALES.</th><th>" . $segmento . "</th></tr>

<tr><th colspan='2'>I CRECIMIENTO Y AUTOAFIRMACIÓN PERSONAL</th></tr>

         <tr><td style='width:520px'>Asiste regularmente a clases</td><td style='text-align:center;'>" . $erres[1] . "</td></tr>
         <tr><td style='width:520px'>Ingresa puntualmente a clases</td><td style='text-align:center;'>" . $erres[2] . "</td></tr>
         <tr><td style='width:520px'>Cuida su higiene y presentación personal</td><td style='text-align:center;'>" . $erres[3] . "</td></tr>
         <tr><td style='width:520px'>Cumple puntualmente con sus tareas y deberes escolares</td><td style='text-align:center;'>" . $erres[4] . "</td></tr>
         <tr><td style='width:520px'>Reconoce sus errores y trata de corregirlos</td><td style='text-align:center;'>" . $erres[5] . "</td></tr>
         <tr><td style='width:520px'>Demuestra creatividad en su trabajo escolar</td><td style='text-align:center;'>" . $erres[6] . "</td></tr>
             
        <tr><th colspan='2'>II FORMACIÓN ETICA</th></tr>
        <tr><td style='width:520px'>Es respetuoso con los miembros de su comunidad escolar</td><td style='text-align:center;'>" . $erres[7] . "</td></tr>
        <tr><td style='width:520px'>Es sincero y veraz en su actuar diario</td><td style='text-align:center;'>" . $erres[8] . "</td></tr>
        <tr><td style='width:520px'>Respeta y valora las ideas y opiniones de los demás</td><td style='text-align:center;'>" . $erres[9] . "</td></tr>
        <tr><td style='width:520px'>Actúa en forma solidaria frente a los problemas de los demás</td><td style='text-align:center;'>" . $erres[10] . "</td></tr>
        <tr><td style='width:520px'>Actúa de acuerdo a las normas establecidas en el Manual de Convivencia Escolar</td><td style='text-align:center;'>" . $erres[11] . "</td></tr>



        <tr><th colspan='2'>III DESARROLLO DEL PENSAMIENTO</th></tr>
        <tr><td style='width:520px'>Comunica sus ideas y convicciones en forma clara y coherente</td><td style='text-align:center;'>" . $erres[12] . "</td></tr>
        <tr><td style='width:520px'>Resuelve en forma autónoma los problemas que se le presentan</td><td style='text-align:center;'>" . $erres[13] . "</td></tr>
        <tr><td style='width:520px'>Demuestra creatividad en la ejecución de tareas y/o trabajos</td><td style='text-align:center;'>" . $erres[14] . "</td></tr>
        
 

        <tr><th colspan='2'>IV LA PERSONA Y SU ENTORNO</th></tr>
        <tr><td style='width:520px'>Trabaja en forma activa y colaborativa</td><td style='text-align:center;'>" . $erres[15] . "</td></tr>
        <tr><td style='width:520px'>Respeta los símbolos y tradiciones patrias</td><td style='text-align:center;'>" . $erres[16] . "</td></tr>
        <tr><td style='width:520px'>Participa con responsabilidad en actividades del curso y del colegio</td><td style='text-align:center;'>" . $erres[17] . "</td></tr>
        <tr><td style='width:520px'>Colabora activamente en el cuidado del entorno y en la mantención de los materiales del establecimiento</td><td style='text-align:center;'>" . $erres[18] . "</td></tr>
        <tr><td style='width:520px'>Mantiene una actitud de respeto, modales y lenguaje adecuado hacia los miembros de su comunidad</td><td style='text-align:center;'>" . $erres[19] . "</td></tr>



</table>"
                . $conceptostexto . "     
<table align='center' style='margin-top:10px;' class='page_firmas'>
            <tr>
            <td style='width: 33%; text-align: center;border:none;'>
                   <p style='text-decoration:underline;margin-left:30px;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</p>
            </td>
                <td style='width: 33%; text-align: center;border:none;'>

                </td>

<td style='width: 33%; text-align: center;border:none;'>
                   <p style='text-decoration:underline;'>" . $director['nombrescuenta'] . " " . $director['paternocuenta'] . " " . $director['maternocuenta'] . "</p>
                </td>
            </tr>

            <tr>
            <td style='width: 33%; text-align:center;border:none;padding-top:10px'>
                Profesor(a) Jefe.
            </td>
                <td style='width: 33%; text-align: center;border:none;padding-top:10px'>

                </td>

<td style='width: 33%; text-align:center;border:none;padding-top:10px'>
                   Director(a).
                </td>
            </tr>


            </table>";


            $contadoraux++;
        }

        if (count($html) > 0) {

            require 'fpdf/html2pdf.class.php';
            try {
                $pdf = new HTML2PDF('P', 'LETTER', 'es', true, 'UTF-8', array(10, 5, 10, 5) /*márgenes*/); //los márgenes también pueden definirse en <page> ver documentación

                for ($j = 0; $j < count($html); $j++) {
                    $pdf->WriteHTML('<page><html>
        <head>
            <style>' . $style . '</style>
        </head>
        <body> <page_footer>
        <table class="page_footer">
            <tr>
            <td style="width: 40%; text-align: left;border:none;"></td>
                <td style="width: 60%; text-align: right;border:none;font-size:8px">

                </td>
            </tr>
        </table>
    </page_footer>' . $html[$j] . '</body></html></page>');
                }

                if (preg_match("/MSIE/i", $_SERVER["HTTP_USER_AGENT"])) {
                    header("Content-type: application/PDF");
                } else {
                    header("Content-type: application/PDF");
                    header("Content-Type: application/pdf");
                }

                $pdf->Output('Planificacion.pdf', I);
            } catch (HTML2PDF_exception $e) {
                //echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, intente nuevamente\");</script>";
                //echo "<script>parent.$.fancybox.close();</script>";
                echo $e;
            }
        } else {
            echo "<script type=\"text/javascript\">alert(\"No existe ningún informe \");</script>";
            echo "<script>parent.$.fancybox.close();</script>";

        }

    }

    public function generaralumnoparcialAction()
    {

        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();
        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;
        $paso = false;

        $id = $this->_getParam('id', 0);
        $segmento = $this->_getParam('p', 0);
        $modeloalumnodetalle = new Application_Model_DbTable_AlumnosDetalle();

        $verifica = $modeloalumnodetalle->get($id, $segmento, $idperiodo);

        if ($verifica) {


            $verifica = $modeloalumnodetalle->get($id, $segmento, $idperiodo);
            $idp = $segmento;

            $observacion = $verifica[0]["observaciones"];

            $idd = $verifica[0]["idDetalle"];
            echo "<link href='../../../../../css/formpdf.css' type='text/css' rel='stylesheet' /><div class='col_12 column'><form class='basic-grey' method='post' action='generaralumnoparcial'><label  for='obs'><span> Observaciones:</span> <textarea id='obs' name='obs' rows='5' cols='40'>" . $observacion . "</textarea></label><label><span>&nbsp;</span><button name='mod'value='1'>Modificar</button><button name='cont'value='1'>Continuar</button> <input type='hidden' name='id' value='" . $id . "' /><input type='hidden' name='idp' value='" . $segmento . "' /><input type='hidden' name='idd' value='" . $idd . "' /></label></form></div>";

        } else {
            echo "<link href='../../../../../css/formpdf.css' type='text/css' rel='stylesheet' /><div class='col_12 column'><form class='basic-grey' method='post' action='generaralumnoparcial'><label  for='obs'><span> Observaciones:</span> <textarea id='obs' name='obs' rows='5' cols='40'></textarea></label><label><span>&nbsp;</span><input type='submit' name='submit' value='Enviar'> <input type='hidden' name='id' value='" . $id . "' /><input type='hidden' name='idp' value='" . $segmento . "' /></label></form></div>";

        }


        if ($this->getRequest()->isPost()) {

            $id = $_POST["id"];
            $idp = $_POST["idp"];
            $idd = $_POST["idd"];

            if (empty($_POST['cont']) && empty($_POST['mod'])) {
                $modeloalumnodetalle->agregar($_POST["trab"], $_POST["ina"], $_POST["asi"], $_POST["atr"], $_POST["obs"], $_POST["apod"], $idp, $_POST["id"], $idperiodo);

            }
            if (empty($_POST['cont']) && $_POST['mod'] == 1) {
                $modeloalumnodetalle->cambiar($_POST["trab"], $_POST["ina"], $_POST["asi"], $_POST["atr"], $_POST["obs"], $_POST["apod"], $idp, $_POST["idd"]);
            }
            if ($_POST['cont'] == 1) {
                $paso = true;
            }

            $verifica = $modeloalumnodetalle->get($id, $idp, $idperiodo);

            $observacion = $verifica[0]["observaciones"];

            $paso = true;
        }

        if ($paso) {

            $modeloalumnoactual = new Application_Model_DbTable_Alumnosactual();
            $alumnoactual = $modeloalumnoactual->get($id);
            $idalumnoactual = $alumnoactual[0]['idAlumnosActual'];

            $this->redirect('/Informes/generarparcial/id/' . $idalumnoactual . '/p/' . $idp . '/t/1');


        }
    }


    public function generaralumnoanualpreAction()
    {

        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();
        $paso = false;

        $id = $this->_getParam('id', 0);

        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;
        $modeldetalle = new Application_Model_DbTable_AlumnosDetalle();

        $verifica = $modeldetalle->get($id, 10, $idperiodo);

        if ($verifica) {

            $verifica = $modeldetalle->get($id, 10, $idperiodo);
            $idp = 10;

            $observacion = $verifica[0]["observaciones"];

            $idd = $verifica[0]["idDetalle"];
            echo "<link href='../../../../../css/formpdf.css' type='text/css' rel='stylesheet' /><div class='col_12 column'><form class='basic-grey' method='post' action='generaralumnoanual'><label  for='obs'><span> Observaciones:</span> <textarea id='obs' name='obs' rows='5' cols='40'>" . $observacion . "</textarea></label><label><span>&nbsp;</span><button name='mod' value='1'>Modificar</button><button name='cont' value='1'>Omitir</button> <input type='hidden' name='id' value='" . $id . "' /><input type='hidden' name='idp' value='10' /><input type='hidden' name='idd' value='" . $idd . "' /></label></form></div>";

        } else {
            echo "<link href='../../../../../css/formpdf.css' type='text/css' rel='stylesheet' /><div class='col_12 column'><form class='basic-grey' method='post' action='generaralumnoanual'><label  for='obs'><span> Observaciones:</span> <textarea id='obs' name='obs' rows='5' cols='40'></textarea></label><label><span>&nbsp;</span><input type='submit' name='submit' value='Enviar'><button name='cont' value='1'>Omitir</button><input type='hidden' name='id' value='" . $id . "' /><input type='hidden' name='idp' value='10' /></label></form></div>";

        }


        if ($this->getRequest()->isPost()) {

            $periodo = new Zend_Session_Namespace('periodo');
            $idperiodo = $periodo->periodo;

            $id = $_POST["id"];
            $idp = $_POST["idp"];
            $idd = $_POST["idd"];

            if (empty($_POST['cont']) && empty($_POST['mod'])) {
                $modeldetalle->agregar(0, 0, 0, 0, $_POST["obs"], 0, $idp, $_POST["id"], $idperiodo);

            }
            if (empty($_POST['cont']) && $_POST['mod'] == 1) {
                $modeldetalle->cambiar(0, 0, 0, 0, $_POST["obs"], 0, $idp, $_POST["idd"]);
            }
            if ($_POST['cont'] == 1) {
                $paso = true;
            }

            $verifica = $modeldetalle->get($id, $idp, $idperiodo);
            $verifica2 = $modeldetalle->get($id, 1, $idperiodo);

            $observacion = $verifica[0]["observaciones"];
            $apoderado = $verifica2[0]["nombreApoderado"];

            $paso = true;

        }

        if ($paso) {

            $this->redirect('/Informes/generaralumnocursoanualprec/id/' . $id . '/t/2');

        }

    }

    public function generaralumnoperiodopreAction()
    {

        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();
        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $paso = false;
        $id = $this->_getParam('id', 0);
        $segmento = $this->_getParam('s', 0);
        $modeloalumnodetalle = new Application_Model_DbTable_AlumnosDetalle();

        $verifica = $modeloalumnodetalle->get($id, $segmento, $idperiodo);

        if ($verifica) {
            $verifica = $modeloalumnodetalle->get($id, $segmento, $idperiodo);
            $idp = $segmento;

            $diastrabajados = $verifica[0]["diasTrabajado"];
            $diasin = $verifica[0]["diasInasistencia"];
            $asistencia = $verifica[0]["asistencia"];
            $atraso = $verifica[0]["numeroatrasos"];
            $observacion = $verifica[0]["observaciones"];
            $apoderado = $verifica[0]["nombreApoderado"];
            $idd = $verifica[0]["idDetalle"];
            echo "<link href='../../../../../css/formpdf.css' type='text/css' rel='stylesheet' /><div class='col_12 column'><form class='basic-grey' method='post' action='generaralumnoperiodo'><label  for='trab'> <span>Nº dias Trabajados:</span>  <input class='col_2' type='text' id='trab' value='" . $diastrabajados . "' name='trab' /> </label> <label class='col_10' for='ina'> <span>Nº dias Inasistencia:</span> <input  type='text' id='ina' value='" . $diasin . "' name='ina' /></label><label  for='obs'><span> Observaciones:</span> <textarea id='obs' name='obs' rows='5' cols='40'>" . $observacion . "</textarea></label><label><span>&nbsp;</span><button name='mod'value='1'>Continuar</button><input type='hidden' name='id' value='" . $id . "' /><input type='hidden' name='idp' value='" . $segmento . "' /><input type='hidden' name='idd' value='" . $idd . "' /></label></form></div>";


        } else {
            echo "<link href='../../../../../css/formpdf.css' type='text/css' rel='stylesheet' /><div class='col_12 column'><form class='basic-grey' method='post' action='generaralumnoperiodo'><label  for='trab'> <span>Nº dias Trabajados:</span>  <input class='col_2' type='text' id='trab' name='trab' /> </label> <label class='col_10' for='ina'> <span>Nº dias Inasistencia:</span> <input  type='text' id='ina' name='ina' /></label><label  for='obs'><span> Observaciones:</span> <textarea id='obs' name='obs' rows='5' cols='40'></textarea></label><label><span>&nbsp;</span><input type='submit' name='submit' value='Enviar'> <input type='hidden' name='id' value='" . $id . "' /><input type='hidden' name='idp' value='" . $segmento . "' /></label></form></div>";

        }


        if ($this->getRequest()->isPost()) {

            $id = $_POST["id"];
            $idp = $_POST["idp"];
            $idd = $_POST["idd"];

            if (empty($_POST['cont']) && empty($_POST['mod'])) {
                $modeloalumnodetalle->agregar($_POST["trab"], $_POST["ina"], null, 0, $_POST["obs"], 0, $idp, $_POST["id"], $idperiodo);

            }
            if ($_POST['mod'] == 1) {
                $modeloalumnodetalle->cambiar($_POST["trab"], $_POST["ina"], null, 0, $_POST["obs"], 0, $idp, $_POST["idd"]);
            }
//            if ($_POST['cont'] == 1) {
////                $paso = true;
////            }

            $verifica = $modeloalumnodetalle->get($id, $idp, $idperiodo);
            $paso = true;
        }

        if ($paso) {

            $modeloalumnoactual = new Application_Model_DbTable_Alumnosactual();
            $alumnoactual = $modeloalumnoactual->get($id);
            $idalumnoactual = $alumnoactual[0]['idAlumnosActual'];
            $this->redirect('/Informes/generaralumnocursoanualprec/id/' . $id . '/t/2/s/' . $idp);
        }

    }

    public function generaralumnocursoanualpreAction()
    {

        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();

        $paso = true;
        $id = $this->_getParam('id', 0);
        $tipo = $this->_getParam('t', 0);
        $segmento = $this->_getParam('s', 0);

        if ($paso) {

            $style = "body{
font:11px Arial, Tahoma, Verdana, Helvetica, sans-serif;

color:#000;
}

#infoizq{

position:absolute;
top: 2%;
left: 40%;
width:30%;
}
h5{
  padding:0;
}

#infoder{

position:absolute;
right:0px;
}

img{
width:90px;
height:100px;

}";

            $periodo = new Zend_Session_Namespace('periodo');
            $idperiodo = $periodo->periodo;

            $modeloalumnoactual = new Application_Model_DbTable_Alumnosactual();
            $modelcurso = new Application_Model_DbTable_Cursos();
            $modelasignatura = new Application_Model_DbTable_Asignaturascursos();
            $tabla = new Application_Model_DbTable_Notas();
            $modeldetalle = new Application_Model_DbTable_AlumnosDetalle();
            $modelcomuna = new Application_Model_DbTable_Comuna();
            $modelCuenta = new Application_Model_DbTable_Cuentas();
            if ($tipo == 1) {
                $listadealumnos = $modeloalumnoactual->listaralumnoscursoactual($id, $idperiodo);

            } else {
                $listadealumnos = $modeloalumnoactual->get($id);
                $id = $listadealumnos[0]['idCursosActual'];
            }

            $largoalumnos = count($listadealumnos);

            $detalleest = $modelcurso->listarcursoid($id, $idperiodo);
            $niveleducacion = $detalleest[0]['idCodigoGrado'];

            $director = $modelCuenta->get($detalleest[0]['idDirector']);
            $Profesorjefe = $modelCuenta->getusuario($detalleest[0]['idCuentaJefe'], $idperiodo);

            if (count($director) == 0) {
                echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta director\");</script>";
                echo "<script>parent.$.fancybox.close();</script>";
                exit;

            }

            if (count($Profesorjefe) == 0 || $Profesorjefe == null) {
                echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta Profesor Jefe\");</script>";
                echo "<script>parent.$.fancybox.close();</script>";
                exit;
            }

            $infoizq = '<div id="infoizq"><h5></h5></div>';
            $logo = getcwd();
            $logo .= "/application/documentos/logos/" . $detalleest[0]['extension'];
            if (file_exists($logo)) {
                $encabezado = '<p style="position:absolute;top:3%;text-align:left"></p><p style="position:absolute;top:3%;text-align:right"><img  src="' . $logo . '" /></p>' . $infoizq . '<h3 style="position:absolute;top:170px;text-align:center">' . $detalleest[0]['nombreEstablecimiento'] . '</h3>';


            } else {
                $encabezado = '<p style="position:absolute;top:3%;text-align:left"></p><p style="position:absolute;top:3%;text-align:right"></p>' . $infoizq . '<h3 style="position:absolute;top:170px;text-align:center">' . $detalleest[0]['nombreEstablecimiento'] . '</h3>';


            }

            $meses = array("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre");
            $datosasignaturas = $modelasignatura->listarporcursopre($id, $idperiodo);
            $nucleosuno = $modelasignatura->listarnucleoporambito(1);
            $nucleosdos = $modelasignatura->listarnucleoporambito(2);
            $nucleostres = $modelasignatura->listarnucleoporambito(3);
            $largoasignatura = count($datosasignaturas);
            $largonucleouno = count($nucleosuno);
            $largonucleodos = count($nucleosdos);
            $largonucleotres = count($nucleostres);
            for ($y = 0; $y < $largoalumnos; $y++) {

                $alumnoactual = array();
                $tabla2 = array();
                $detallecurso = array();
                $tablanotasprimer = array();
                $tablanotassegundo = array();
                $detallecomuna = array();
                $detallealumnoprimer = array();
                $detallealumnosegundo = array();
                $detallealumno = array();
                $promedioprimer = array();
                $promediosegundo = array();
                $promediofinal = array();
                $inicial = array();
                $avanzado = array();
                $mavanzado = array();
                $inicials = array();
                $avanzados = array();
                $mavanzados = array();
                $inicialf = array();
                $avanzadof = array();
                $mavanzadof = array();
                $observacionprimer = '';
                $observacionsegundo = '';
                $observacion = '';


                $alumnoactual = $modeloalumnoactual->get($listadealumnos[$y]['idAlumnosActual']);
                $idalumnoactual = $alumnoactual[0]['idAlumnos'];
                $idalumnoactual2 = $alumnoactual[0]['idAlumnosActual'];
                $idcursoactual = $alumnoactual[0]['idCursosActual'];
                $tabla2 = $tabla->generanotasalumnobasicapre($idalumnoactual, $idperiodo, $idcursoactual);


                //lista Asignaturas del alumno


                if (!empty($tabla2[0]['comuna'])) {
                    $detallecomuna = $modelcomuna->getcomuna($tabla2[0]['comuna']);
                } else {
                    $detallecomuna = 0;
                }

                if ($niveleducacion == '4') {
                    $nombreedu = 'Primer Nivel de Transición';

                }

                if ($niveleducacion == '5') {
                    $nombreedu = 'Segundo Nivel de Transición';

                }

                //Fecha nacimiento
                $fechana = $tabla2[0]['fechanacimiento'];
                $cortado2 = explode("-", $fechana);
                if (count($cortado2) > 0) {
                    if (checkdate($cortado2[1], $cortado2[2], $cortado2[0])) {
                        $fecha_final_nac = $cortado2[2] . " de " . $meses[date('n', mktime(0, 0, 0, $cortado2[1], $cortado2[2], $cortado2[0])) - 1] . " del " . date('Y', mktime(0, 0, 0, $cortado2[1], $cortado2[2], $cortado2[0]));
                    } else {
                        $fecha_final_nac = 'Sin Datos';
                    }
                } else {
                    $fecha_final_nac = 'Sin Datos';
                }

                $html_notas[$y][0] = $encabezado;

                if ($segmento == 1) {
                    $detallealumnoprimer = $modeldetalle->listardetalleperiodo($idalumnoactual2, 1, $idperiodo);
                    $detallealumnosegundo = array();
                    $detallealumno = array();
                } else {
                    $detallealumnoprimer = $modeldetalle->listardetalleperiodo($idalumnoactual2, 1, $idperiodo);
                    $detallealumnosegundo = $modeldetalle->listardetalleperiodo($idalumnoactual2, 2, $idperiodo);
                    $detallealumno = $modeldetalle->listardetalleperiodo($idalumnoactual2, 10, $idperiodo);
                }


                if (count($detallealumnoprimer) > 0) {
                    $diasinprimer = $detallealumnoprimer[0]['diasInasistencia'];
                    $diastrabajadosprimer = $detallealumnoprimer[0]['diasTrabajado'];
                    $atrasoprimer = $detallealumnoprimer[0]['numeroatrasos'];
                    $observacionprimer = $detallealumnoprimer[0]['observaciones'];
                    if ($diasinprimer != 0 && $diastrabajadosprimer > 0) {
                        $valor = $diasinprimer / $diastrabajadosprimer;
                        $aux = 1 - $valor;
                        $total = $aux * 100;
                    } elseif (($diasinprimer == 0 || $diasinprimer == '') && $diastrabajadosprimer > 0) {
                        $valor = $diasinprimer / $diastrabajadosprimer;
                        $aux = 1 - $valor;
                        $total = $aux * 100;
                    } else {
                        $diasinprimer = 0;
                        $diastrabajadosprimer = 0;
                        $atrasoprimer = 0;
                        $total = 0;
                    }
                } else {
                    $observacionprimer = 'Sin Observaciones';
                    $diasinprimer = 0;
                    $diastrabajadosprimer = 0;
                    $atrasoprimer = 0;
                    $total = 0;
                }


                if (count($detallealumnosegundo) > 0) {
                    $diasinsegundo = $detallealumnosegundo[0]['diasInasistencia'];
                    $diastrabajadossegundo = $detallealumnosegundo[0]['diasTrabajado'];
                    $atrasosegundo = $detallealumnosegundo[0]['numeroatrasos'];
                    $observacionsegundo = $detallealumnosegundo[0]['observaciones'];
                    if ($diasinsegundo != 0 && $diastrabajadossegundo > 0) {
                        $valorsegundo = $diasinsegundo / $diastrabajadossegundo;
                        $auxs = 1 - $valorsegundo;
                        $totals = $auxs * 100;
                    } elseif (($diasinsegundo == 0 || $diasinsegundo == '') && $diastrabajadossegundo > 0) {
                        $valorsegundo = $diasinsegundo / $diastrabajadossegundo;
                        $auxs = 1 - $valorsegundo;
                        $totals = $auxs * 100;
                    } else {
                        $diasinsegundo = 0;
                        $diastrabajadossegundo = 0;
                        $atrasosegundo = 0;
                        $totals = 0;
                    }
                } else {
                    $observacionsegundo = 'Sin Observaciones';
                    $diasinsegundo = 0;
                    $diastrabajadossegundo = 0;
                    $atrasosegundo = 0;
                    $totals = 0;
                }
                $largodetallealumno = count($detallealumno);
                if (count($detallealumno) > 0) {
                    $diasin = $diasinprimer + $diasinsegundo;
                    $diastrabajados = $diastrabajadosprimer + $diastrabajadossegundo;
                    $atraso = $detallealumno[0]['numeroatrasos'];
                    $observacion = $detallealumno[0]['observaciones'];
                    if ($diasin != 0 && $diastrabajados > 0) {
                        $valorf = $diasin / $diastrabajados;
                        $auxf = 1 - $valorf;
                        $totalf = $auxf * 100;
                    } elseif (($diasin == 0 || $diasin == '') && $diastrabajados > 0) {
                        $valorf = $diasin / $diastrabajados;
                        $auxf = 1 - $valorf;
                        $totalf = $auxf * 100;
                    } else {
                        $totalf = 0;
                    }
                } else {
                    $observacion = 'Sin Observaciones';
                    $totalf = 0;
                }


                $periodo = new Zend_Session_Namespace('nombreperiodo');
                $nombreperiodo = $periodo->nombreperiodo;

                $html_notas[$y][0] .= "<div style='width:100%;border: 1px double #000;outline: 2px solid #699;outline-offset: -9px;text-align:center; margin:35px 0 0px 0; height:730px;'>
  <h3 style='text-align:center'>INFORME</h3>
  <h3 style='text-align:center'>Evaluación de Aprendizajes</h3>
  <h4 style='text-align:center'>¿Qué ha aprendido mi hijo o hija?</h4>
  <p style='text-align:center'>Año: " . $nombreperiodo . "</p>
      <table style='width:98%;border:none;margin:25px 5px 5px 5px;padding:5px;'>
        <tr>
          <td style='width:19%; text-align:left;border:none;'>Nombre de Alumno(a)</td>
          <td colspan='3' style='width:69%; text-align:left;border:none;'>" . $listadealumnos[$y]['nombres'] . " " . $listadealumnos[$y]['apaterno'] . " " . $listadealumnos[$y]['amaterno'] . "</td>
        </tr>

        <tr>
          <td  style='width:18%; text-align:left;border:none;'>Fecha Nacimiento:</td>
          <td colspan='3' style='width:70%; text-align:left;border:none;'>" . $fecha_final_nac . "</td>
        </tr>

         <tr>
          <td style='width:18%; text-align:left;border:none;'>Educadora:</td>
          <td colspan='3' style='width:70%; text-align:left;border:none;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</td>
        </tr>

        <tr>
          <td style='width:15%; text-align:left;border:none;'>Comuna:</td>
          <td style='width:34%; text-align:left;border:none;;
         '>" . $detallecomuna[0]['nombreComuna'] . "</td>
          <td style='width:7%; text-align:left;border:none;'>Región:</td>
          <td style='width:42%; text-align:left;border:none;'>" . $detallecomuna[0]['nombreRegion'] . "</td>
        </tr>
      </table>

      <table border='1' cellspacing='0' cellpadding='0' style='width:98%;margin:35px 5px 25px 5px;padding:5px;border-collapse:collapse;'>
        <tr>
          <th style='width:30%;' rowspan=2>ASISTENCIA</th>
          <th style='width:38%;' colspan=2>SEMESTRES</th>
          <th style='width:30%;' rowspan=2>TOTAL</th>
        </tr>
        <tr>

          <th>1º</th>
          <th>2º</th>

        </tr>

        <tr>
        <td style='text-align:left;'>Días de Clases</td>
        <td>" . $diastrabajadosprimer . "</td>
        <td>" . $diastrabajadossegundo . "</td>
        <td>" . ($diastrabajadosprimer + $diastrabajadossegundo) . "</td>
        </tr>

        <tr>
        <td style='text-align:left;'>Días de Inasistencia</td>
        <td>" . $diasinprimer . "</td>
        <td>" . $diasinsegundo . "</td>
        <td>" . ($diasinprimer + $diasinsegundo) . "</td>
        </tr>

        <tr>
        <td style='text-align:left;'>Porcentaje de Asistencia</td>
        <td>" . intval($total) . "%</td>
        <td>" . intval($totals) . "%</td>
        <td>" . intval($totalf) . "%</td>
        </tr>
      </table>

      <h3 style='text-align:center;margin-top:35px'>Para la familia de los niños y niñas del</h3>
      <h3 style='text-align:center'>" . $nombreedu . "</h3>

  </div>";

                //Obtenemos las notas de acuerdo a los periodos(Primer y Segundo Semestre)

                $html_notas[$y][1] = "<h3 style='text-align:center;margin-top:25px'>FORMACIÓN PERSONAL Y SOCIAL</h3>";
                //Obtenemos los nucleos pertenecientes al ambito

                for ($i = 0; $i < $largonucleouno; $i++) {
                    $html_notas[$y][1] .= "<table border=1 align=center style='width:100%; margin-top:20px;border-collapse:collapse;'>
    <tr><td></td><td style='text-align:center;' colspan=3>1er Semestre</td><td style='text-align:center;'  colspan=3>2do Semestre</td><td style='text-align:center;'  colspan=3>Informe Final</td></tr>
    <tr><td style='width:50%'>" . $nucleosuno[$i]['nombreNucleo'] . "</td><td style='width:5%;text-align:center;'>I</td><td style='width:5%;text-align:center;'>A</td><td style='width:5%;text-align:center;'>MA</td><td style='width:5%;text-align:center;'>I</td><td style='width:5%;text-align:center;'>A</td><td style='width:5%;text-align:center;'>MA</td><td style='width:5%;text-align:center;'>I</td><td style='width:5%;text-align:center;'>A</td><td style='width:5%;text-align:center;'>MA</td></tr>";

                    //Agregamos las asignaturas correspondientes al nucleo
                    for ($j = 0; $j < $largoasignatura; $j++) {
                        if ($datosasignaturas[$j]['idNucleo'] == $nucleosuno[$i]['idNucleo']) {
                            $html_notas[$y][1] .= "<tr><td style='width:50%'>" . $datosasignaturas[$j]['nombreAsignatura'] . "</td>";

                            if ($segmento == 1) {
                                $promedioprimer[$j] = $tabla->listarpromedioasignatura($idalumnoactual, $idperiodo, 1, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                $promediosegundo[$j] = array();
                            } else {
                                $promedioprimer[$j] = $tabla->listarpromedioasignatura($idalumnoactual, $idperiodo, 1, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                $promediosegundo[$j] = $tabla->listarpromedioasignatura($idalumnoactual, $idperiodo, 2, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);

                            }

                            if ($largodetallealumno > 0) {
                                $promediofinal[$j] = $tabla->listarpromedioasignaturafinal($idalumnoactual, $idperiodo, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                            } else {
                                $promediofinal[$j][0]['nota'] = '';
                            }


                            if ($promedioprimer[$j][0]['nota'] == null) {
                                $inicial[$j] = '';
                                $avanzado[$j] = '';
                                $mavanzado[$j] = '';

                                $inicials[$j] = '';
                                $avanzados[$j] = '';
                                $mavanzados[$j] = '';

                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';
                            }

                            if ($promediosegundo[$j][0]['nota'] == null) {
                                $inicial[$j] = '';
                                $avanzado[$j] = '';
                                $mavanzado[$j] = '';

                                $inicials[$j] = '';
                                $avanzados[$j] = '';
                                $mavanzados[$j] = '';

                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';
                            }

                            if ($promediofinal[$j][0]['nota'] == null) {
                                $inicial[$j] = '';
                                $avanzado[$j] = '';
                                $mavanzado[$j] = '';

                                $inicials[$j] = '';
                                $avanzados[$j] = '';
                                $mavanzados[$j] = '';

                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';
                            }
                            //Primer Semestre
                            if ($promedioprimer[$j][0]['nota'] > 20 && $promedioprimer[$j][0]['nota'] < 40) {
                                $inicial[$j] = 'I';
                                $avanzado[$j] = '';
                                $mavanzado[$j] = '';

                                $inicials[$j] = '';
                                $avanzados[$j] = '';
                                $mavanzados[$j] = '';

                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';
                            }
                            if ($promedioprimer[$j][0]['nota'] > 39 && $promedioprimer[$j][0]['nota'] < 60) {
                                $inicial[$j] = '';
                                $avanzado[$j] = 'A';
                                $mavanzado[$j] = '';

                                $inicials[$j] = '';
                                $avanzados[$j] = '';
                                $mavanzados[$j] = '';

                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';
                            }
                            if ($promedioprimer[$j][0]['nota'] > 59 && $promedioprimer[$j][0]['nota'] <= 70) {
                                $inicial[$j] = '';
                                $avanzado[$j] = '';
                                $mavanzado[$j] = 'MA';

                                $inicials[$j] = '';
                                $avanzados[$j] = '';
                                $mavanzados[$j] = '';

                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';
                            }
                            //Segundo Semestre
                            if ($promediosegundo[$j][0]['nota'] > 20 && $promediosegundo[$j][0]['nota'] < 40) {
                                $inicials[$j] = 'I';
                                $avanzados[$j] = '';
                                $mavanzados[$j] = '';

                                $inicial[$j] = '';
                                $avanzado[$j] = '';
                                $mavanzado[$j] = '';

                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';
                            }
                            if ($promediosegundo[$j][0]['nota'] > 39 && $promediosegundo[$j][0]['nota'] < 60) {
                                $inicials[$j] = '';
                                $avanzados[$j] = 'A';
                                $mavanzados[$j] = '';

                                $inicial[$j] = '';
                                $avanzado[$j] = '';
                                $mavanzado[$j] = '';

                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';
                            }
                            if ($promediosegundo[$j][0]['nota'] > 59 && $promediosegundo[$j][0]['nota'] <= 70) {
                                $inicials[$j] = '';
                                $avanzados[$j] = '';
                                $mavanzados[$j] = 'MA';

                                $inicial[$j] = '';
                                $avanzado[$j] = '';
                                $mavanzado[$j] = '';

                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';
                            }
                            //Promedio Final

                            if ($promediofinal[$j][0]['nota'] > 20 && $promediofinal[$j][0]['nota'] < 40) {
                                $inicialf[$j] = 'I';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';

                            }
                            if ($promediofinal[$j][0]['nota'] > 39 && $promediofinal[$j][0]['nota'] < 60) {
                                $inicialf[$j] = '';
                                $avanzadof[$j] = 'A';
                                $mavanzadof[$j] = '';


                            }
                            if ($promediofinal[$j][0]['nota'] > 59 && $promediofinal[$j][0]['nota'] <= 70) {
                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = 'MA';

                            }

                            $html_notas[$y][1] .= "<td style='width:5%;text-align:center;'>" . $inicial[$j] . "</td><td style='width:5%;text-align:center;'>" . $avanzado[$j] . "</td><td style='width:5%;text-align:center;'>" . $mavanzado[$j] . "</td><td style='width:5%;text-align:center;'>" . $inicials[$j] . "</td><td style='width:5%;text-align:center;'>" . $avanzados[$j] . "</td><td style='width:5%;text-align:center;'>" . $mavanzados[$j] . "</td><td style='width:5%;text-align:center;'>" . $inicialf[$j] . "</td><td style='width:5%;text-align:center;'>" . $avanzadof[$j] . "</td><td style='width:5%;text-align:center;'>" . $mavanzadof[$j] . "</td></tr>";

                        }

                    } //fin for datosasignaturas
                    $html_notas[$y][1] .= "</table>";

                }

                $html_notas[$y][2] = "<h3 style='text-align:center;margin-top:25px'>COMUNICACIÓN</h3>";
                //Obtenemos los nucleos pertenecientes al ambito

                for ($i = 0; $i < $largonucleodos; $i++) {
                    $html_notas[$y][2] .= "<table border=1 align=center style='width:100%; margin-top:20px;border-collapse:collapse;'>
    <tr><td></td><td style='text-align:center;' colspan=3>1er Semestre</td><td style='text-align:center;' colspan=3>2do Semestre</td><td style='text-align:center;' colspan=3>Informe Final</td></tr>
    <tr><td style='width:50%'>" . $nucleosdos[$i]['nombreNucleo'] . "</td><td style='width:5%;text-align:center;'>I</td><td style='width:5%;text-align:center;'>A</td><td style='width:5%;text-align:center;'>MA</td><td style='width:5%;text-align:center;'>I</td><td style='width:5%;text-align:center;'>A</td><td style='width:5%;text-align:center;'>MA</td><td style='width:5%;text-align:center;'>I</td><td style='width:5%;text-align:center;'>A</td><td style='width:5%;text-align:center;'>MA</td></tr>";

                    //Agregamos las asignaturas correspondientes al nucleo
                    for ($j = 0; $j < $largoasignatura; $j++) {
                        if ($datosasignaturas[$j]['idNucleo'] == $nucleosdos[$i]['idNucleo']) {
                            $html_notas[$y][2] .= "<tr><td style='width:50%'>" . $datosasignaturas[$j]['nombreAsignatura'] . "</td>";

                            $promedioprimer[$j] = $tabla->listarpromedioasignatura($idalumnoactual, $idperiodo, 1, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                            $promediosegundo[$j] = $tabla->listarpromedioasignatura($idalumnoactual, $idperiodo, 2, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                            if ($largodetallealumno > 0) {
                                $promediofinal[$j] = $tabla->listarpromedioasignaturafinal($idalumnoactual, $idperiodo, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                            } else {
                                $promediofinal[$j][0]['nota'] = '';
                            }


                            if ($promedioprimer[$j][0]['nota'] == null) {
                                $inicial[$j] = '';
                                $avanzado[$j] = '';
                                $mavanzado[$j] = '';

                                $inicials[$j] = '';
                                $avanzados[$j] = '';
                                $mavanzados[$j] = '';

                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';
                            }

                            if ($promediosegundo[$j][0]['nota'] == null) {
                                $inicial[$j] = '';
                                $avanzado[$j] = '';
                                $mavanzado[$j] = '';

                                $inicials[$j] = '';
                                $avanzados[$j] = '';
                                $mavanzados[$j] = '';

                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';
                            }

                            if ($promediofinal[$j][0]['nota'] == null) {
                                $inicial[$j] = '';
                                $avanzado[$j] = '';
                                $mavanzado[$j] = '';

                                $inicials[$j] = '';
                                $avanzados[$j] = '';
                                $mavanzados[$j] = '';

                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';
                            }
                            //Primer Semestre
                            if ($promedioprimer[$j][0]['nota'] > 20 && $promedioprimer[$j][0]['nota'] < 40) {
                                $inicial[$j] = 'I';
                                $avanzado[$j] = '';
                                $mavanzado[$j] = '';

                                $inicials[$j] = '';
                                $avanzados[$j] = '';
                                $mavanzados[$j] = '';

                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';
                            }
                            if ($promedioprimer[$j][0]['nota'] > 39 && $promedioprimer[$j][0]['nota'] < 60) {
                                $inicial[$j] = '';
                                $avanzado[$j] = 'A';
                                $mavanzado[$j] = '';

                                $inicials[$j] = '';
                                $avanzados[$j] = '';
                                $mavanzados[$j] = '';

                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';
                            }
                            if ($promedioprimer[$j][0]['nota'] > 59 && $promedioprimer[$j][0]['nota'] <= 70) {
                                $inicial[$j] = '';
                                $avanzado[$j] = '';
                                $mavanzado[$j] = 'MA';

                                $inicials[$j] = '';
                                $avanzados[$j] = '';
                                $mavanzados[$j] = '';

                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';
                            }
                            //Segundo Semestre
                            if ($promediosegundo[$j][0]['nota'] > 20 && $promediosegundo[$j][0]['nota'] < 40) {
                                $inicials[$j] = 'I';
                                $avanzados[$j] = '';
                                $mavanzados[$j] = '';

                                $inicial[$j] = '';
                                $avanzado[$j] = '';
                                $mavanzado[$j] = '';

                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';
                            }
                            if ($promediosegundo[$j][0]['nota'] > 39 && $promediosegundo[$j][0]['nota'] < 60) {
                                $inicials[$j] = '';
                                $avanzados[$j] = 'A';
                                $mavanzados[$j] = '';

                                $inicial[$j] = '';
                                $avanzado[$j] = '';
                                $mavanzado[$j] = '';

                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';
                            }
                            if ($promediosegundo[$j][0]['nota'] > 59 && $promediosegundo[$j][0]['nota'] <= 70) {
                                $inicials[$j] = '';
                                $avanzados[$j] = '';
                                $mavanzados[$j] = 'MA';

                                $inicial[$j] = '';
                                $avanzado[$j] = '';
                                $mavanzado[$j] = '';

                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';
                            }
                            //Promedio Final

                            if ($promediofinal[$j][0]['nota'] > 20 && $promediofinal[$j][0]['nota'] < 40) {
                                $inicialf[$j] = 'I';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';

                            }
                            if ($promediofinal[$j][0]['nota'] > 39 && $promediofinal[$j][0]['nota'] < 60) {
                                $inicialf[$j] = '';
                                $avanzadof[$j] = 'A';
                                $mavanzadof[$j] = '';


                            }
                            if ($promediofinal[$j][0]['nota'] > 59 && $promediofinal[$j][0]['nota'] <= 70) {
                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = 'MA';

                            }

                            $html_notas[$y][2] .= "<td style='width:5%;text-align:center;'>" . $inicial[$j] . "</td><td style='width:5%;text-align:center;'>" . $avanzado[$j] . "</td><td style='width:5%;text-align:center;'>" . $mavanzado[$j] . "</td><td style='width:5%;text-align:center;'>" . $inicials[$j] . "</td><td style='width:5%;text-align:center;'>" . $avanzados[$j] . "</td><td style='width:5%;text-align:center;'>" . $mavanzados[$j] . "</td><td style='width:5%;text-align:center;'>" . $inicialf[$j] . "</td><td style='width:5%;text-align:center;'>" . $avanzadof[$j] . "</td><td style='width:5%;text-align:center;'>" . $mavanzadof[$j] . "</td></tr>";

                        }

                    } //fin for datosasignaturas
                    $html_notas[$y][2] .= "</table>";
                }

                $html_notas[$y][3] = "<h3 style='text-align:center;margin-top:45px'>RELACIÓN CON EL MEDIO NATURAL Y CULTURAL</h3>";
                //Obtenemos los nucleos pertenecientes al ambito

                for ($i = 0; $i < $largonucleotres; $i++) {
                    $html_notas[$y][3] .= "<table border=1 align=center style='width:100%; margin-top:20px;border-collapse:collapse;'>
    <tr><td></td><td style='text-align:center;' colspan=3>1er Semestre</td><td style='text-align:center;' colspan=3>2do Semestre</td><td style='text-align:center;' colspan=3>Informe Final</td></tr>
    <tr><td style='width:50%'>" . $nucleostres[$i]['nombreNucleo'] . "</td><td style='width:5%;text-align:center;'>I</td><td style='width:5%;text-align:center;'>A</td><td style='width:5%;text-align:center;'>MA</td><td style='width:5%;text-align:center;'>I</td><td style='width:5%;text-align:center;'>A</td><td style='width:5%;text-align:center;'>MA</td><td style='width:5%;text-align:center;'>I</td><td style='width:5%;text-align:center;'>A</td><td style='width:5%;text-align:center;'>MA</td></tr>";

                    //Agregamos las asignaturas correspondientes al nucleo
                    for ($j = 0; $j < $largoasignatura; $j++) {
                        if ($datosasignaturas[$j]['idNucleo'] == $nucleostres[$i]['idNucleo']) {
                            $html_notas[$y][3] .= "<tr><td style='width:50%'>" . $datosasignaturas[$j]['nombreAsignatura'] . "</td>";

                            $promedioprimer[$j] = $tabla->listarpromedioasignatura($idalumnoactual, $idperiodo, 1, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                            $promediosegundo[$j] = $tabla->listarpromedioasignatura($idalumnoactual, $idperiodo, 2, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                            if ($largodetallealumno > 0) {
                                $promediofinal[$j] = $tabla->listarpromedioasignaturafinal($idalumnoactual, $idperiodo, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                            } else {
                                $promediofinal[$j][0]['nota'] = '';
                            }


                            if ($promedioprimer[$j][0]['nota'] == null) {
                                $inicial[$j] = '';
                                $avanzado[$j] = '';
                                $mavanzado[$j] = '';

                                $inicials[$j] = '';
                                $avanzados[$j] = '';
                                $mavanzados[$j] = '';

                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';
                            }

                            if ($promediosegundo[$j][0]['nota'] == null) {
                                $inicial[$j] = '';
                                $avanzado[$j] = '';
                                $mavanzado[$j] = '';

                                $inicials[$j] = '';
                                $avanzados[$j] = '';
                                $mavanzados[$j] = '';

                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';
                            }

                            if ($promediofinal[$j][0]['nota'] == null) {
                                $inicial[$j] = '';
                                $avanzado[$j] = '';
                                $mavanzado[$j] = '';

                                $inicials[$j] = '';
                                $avanzados[$j] = '';
                                $mavanzados[$j] = '';

                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';
                            }
                            //Primer Semestre
                            if ($promedioprimer[$j][0]['nota'] > 20 && $promedioprimer[$j][0]['nota'] < 40) {
                                $inicial[$j] = 'I';
                                $avanzado[$j] = '';
                                $mavanzado[$j] = '';

                                $inicials[$j] = '';
                                $avanzados[$j] = '';
                                $mavanzados[$j] = '';

                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';
                            }
                            if ($promedioprimer[$j][0]['nota'] > 39 && $promedioprimer[$j][0]['nota'] < 60) {
                                $inicial[$j] = '';
                                $avanzado[$j] = 'A';
                                $mavanzado[$j] = '';

                                $inicials[$j] = '';
                                $avanzados[$j] = '';
                                $mavanzados[$j] = '';

                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';
                            }
                            if ($promedioprimer[$j][0]['nota'] > 59 && $promedioprimer[$j][0]['nota'] <= 70) {
                                $inicial[$j] = '';
                                $avanzado[$j] = '';
                                $mavanzado[$j] = 'MA';

                                $inicials[$j] = '';
                                $avanzados[$j] = '';
                                $mavanzados[$j] = '';

                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';
                            }
                            //Segundo Semestre
                            if ($promediosegundo[$j][0]['nota'] > 20 && $promediosegundo[$j][0]['nota'] < 40) {
                                $inicials[$j] = 'I';
                                $avanzados[$j] = '';
                                $mavanzados[$j] = '';

                                $inicial[$j] = '';
                                $avanzado[$j] = '';
                                $mavanzado[$j] = '';

                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';
                            }
                            if ($promediosegundo[$j][0]['nota'] > 39 && $promediosegundo[$j][0]['nota'] < 60) {
                                $inicials[$j] = '';
                                $avanzados[$j] = 'A';
                                $mavanzados[$j] = '';

                                $inicial[$j] = '';
                                $avanzado[$j] = '';
                                $mavanzado[$j] = '';

                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';
                            }
                            if ($promediosegundo[$j][0]['nota'] > 59 && $promediosegundo[$j][0]['nota'] <= 70) {
                                $inicials[$j] = '';
                                $avanzados[$j] = '';
                                $mavanzados[$j] = 'MA';

                                $inicial[$j] = '';
                                $avanzado[$j] = '';
                                $mavanzado[$j] = '';

                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';
                            }
                            //Promedio Final

                            if ($promediofinal[$j][0]['nota'] > 20 && $promediofinal[$j][0]['nota'] < 40) {
                                $inicialf[$j] = 'I';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = '';

                            }
                            if ($promediofinal[$j][0]['nota'] > 39 && $promediofinal[$j][0]['nota'] < 60) {
                                $inicialf[$j] = '';
                                $avanzadof[$j] = 'A';
                                $mavanzadof[$j] = '';


                            }
                            if ($promediofinal[$j][0]['nota'] > 59 && $promediofinal[$j][0]['nota'] <= 70) {
                                $inicialf[$j] = '';
                                $avanzadof[$j] = '';
                                $mavanzadof[$j] = 'MA';

                            }

                            $html_notas[$y][3] .= "<td style='width:5%;text-align:center;'>" . $inicial[$j] . "</td><td style='width:5%;text-align:center;'>" . $avanzado[$j] . "</td><td style='width:5%;text-align:center;'>" . $mavanzado[$j] . "</td><td style='width:5%;text-align:center;'>" . $inicials[$j] . "</td><td style='width:5%;text-align:center;'>" . $avanzados[$j] . "</td><td style='width:5%;text-align:center;'>" . $mavanzados[$j] . "</td><td style='width:5%;text-align:center;'>" . $inicialf[$j] . "</td><td style='width:5%;text-align:center;'>" . $avanzadof[$j] . "</td><td style='width:5%;text-align:center;'>" . $mavanzadof[$j] . "</td></tr>";

                        }

                    } //fin for datosasignaturas
                    $html_notas[$y][3] .= "</table>";
                }
                $html_notas[$y][4] = "<h3 style='text-align:center;margin-top:45px'>INFORME:Evaluación de Aprendizajes</h3>
  <h5 style='text-align:center;margin-top:45px'>¿Cómo Interpretar y Apoyar a sus hijos con ésta información?</h5>
  <table style='width:95%;border-collapse:collapse;' border=1 align=center >
    <tr>
      <td style='text-align:center; width:10%;'>I</td>
      <td style='text-align:left; width:85%;'>Si su hijo/a tiene una I, significa que está iniciando en el aprendizaje, la familia puede ayudar realizando distintas experiencias en la casa</td>
    </tr>
    <tr>
      <td style='text-align:center; width:10%;'>A</td>
      <td style='text-align:left; width:85%;'>Si su hijo/a tiene una A, quiere decir que ha adquirido el aprendizaje: la familia puede ayudar ejercitando éste mismo aprendizaje para que lo mantenga y se faciliten nuevos aprendizajes</td>
    </tr>
    <tr>
      <td style='text-align:center; width:10%;'>MA</td>
      <td style='text-align:left; width:85%;'>Si su hijo/a tiene una MA, quiere decir que está muy avanzado en el aprendizaje y se pueden presentar nuevos desafios</td>
    </tr>
  </table>";

                //Datos de observaciones del alumno

                $html_notas[$y][4] .= "<h3 style='text-align:center;margin-top:20px'>PRIMER SEMESTRE</h3>
        <table border=1 align=center style='width:95%; border-collapse:collapse;'>
          <tr>
            <td style='width:95%;text-align: left;'>Observaciones y Sugerencia de la Educadora:</td>
          </tr>
          <tr>
            <td style='width:95%;height:5%;text-align:left;'>" . $observacionprimer . "</td>
          </tr>
        </table>

        <table align=center style='width:95%;margin-top:20px;'>
          <tr>
          <td style='width:50%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          </tr>
          <tr>
          <td style='width:50%;text-align:center;border:none;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</td>

          </tr>
          <tr>
          <td style='width:50%;text-align:center;border:none;'>Educadora de Párvulo</td>
          </tr>
        </table>


        <hr style='width:100%'>

        <h3 style='text-align:center;margin-top:20px'>SEGUNDO SEMESTRE</h3>
        <table border=1 align=center style='width:95%;border-collapse:collapse;'>
          <tr>
            <td style='width:95%;text-align: left;'>Observaciones y Sugerencias de la Educadora:</td>
          </tr>
          <tr>
            <td style='width:95%;height:5%;text-align:left;'>" . $observacionsegundo . "</td>
          </tr>
        </table>

         <table align=center style='width:95%;margin-top:20px;'>
          <tr>
          <td style='width:50%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          </tr>
          <tr>
          <td style='width:50%;text-align:center;border:none;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</td>

          </tr>
          <tr>
          <td style='width:50%;text-align:center;border:none;'>Educadora de Párvulo</td>
          </tr>
        </table>


         <hr style='width:100%'>

          <h3 style='text-align:center;margin-top:20px'>INFORME FINAL</h3>
        <table border=1 align=center style='width:95%;border-collapse:collapse;'>
          <tr>
            <td style='width:95%;text-align: left;'>Observaciones y Sugerencias de la Educadora:</td>
          </tr>
          <tr>
            <td style='width:95%;height:5%;text-align:left;'>" . $observacion . "</td>
          </tr>
        </table>

        <table align=center style='width:95%;margin-top:20px;'>
          <tr>
          <td style='width:50%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          </tr>
          <tr>
          <td style='width:50%;text-align:center;border:none;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</td>

          </tr>
          <tr>
          <td style='width:50%;text-align:center;border:none;'>Educadora de Párvulo</td>
          </tr>
        </table>

         <table align=center style='width:95%;margin-top:60px;'>
          <tr>
          <td style='width:50%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          </tr>
          <tr>
          <td style='width:50%;text-align:center;'>" . $director['nombrescuenta'] . " " . $director['paternocuenta'] . " " . $director['maternocuenta'] . "</td>
          </tr>
          <tr>
          <td style='width:50%;text-align:center;'>Director</td>
          </tr>
        </table>";

            }


            if ($html_notas != '') {

                require 'fpdf/html2pdf.class.php';
                try {
                    //Orientación / formato del pdf y el idioma.
                    $pdf = new HTML2PDF('P', 'LETTER', 'es', array(10, 10, 10, 10) /*márgenes*/); //los márgenes también pueden definirse en <page> ver documentación

                    //inicio ciclo

                    for ($j = 0; $j < count($html_notas); $j++) {
                        for ($k = 0; $k < count($html_notas[$j]); $k++) {
                            $pdf->WriteHTML('<page><html>
        <head>
            <style>' . $style . '</style>
        </head>
        <body> <page_footer>
        <table class="page_footer">
            <tr>
            <td style="width: 40%; text-align: left;border:none;"></td>
                <td style="width: 60%; text-align: right;border:none;font-size:8px">

                </td>
            </tr>
        </table>
    </page_footer>' . $html_notas[$j][$k] . '</body></html></page>');
                        }
                    }

                    //fin ciclo

                    if (preg_match("/MSIE/i", $_SERVER["HTTP_USER_AGENT"])) {
                        header("Content-type: application/PDF");
                    } else {
                        header("Content-type: application/PDF");
                        header("Content-Type: application/pdf");
                    }

                    $pdf->Output('Planificacion.pdf', I);
                } catch (HTML2PDF_exception $e) {
                    //echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, intente nuevamente\");</script>";
                    //echo "<script>parent.$.fancybox.close();</script>";
                    echo $e;
                }
            }

        } //fin Paso

    }


    public function informenotascursoAction()
    {
        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();

        $ingreson = new Zend_Session_Namespace('ingresonota');
        $ingresonota = $ingreson->ingresonota;

        $cargo = new Zend_Session_Namespace('cargo');
        $rol = $cargo->cargo;

        $agregadecimas = false;

        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $modelcurso = new Application_Model_DbTable_Cursos();
        $modelnotas = new Application_Model_DbTable_Notas();
        $modelasignatura = new Application_Model_DbTable_Asignaturascursos();
        $modeldetalle = new Application_Model_DbTable_AlumnosDetalle();


        //fecha actual

        $date = new DateTime;
        $fechain = $date->format('Y-m-d');
        $cortado = explode("-", $fechain);
        $dias = array("Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado");
        $meses = array("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre");

        $fecha_final = $dias[date('w', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]))] . " " . $cortado[2] . " de " . $meses[date('n', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0])) - 1] . " del " . date('Y', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]));


        if ($ingresonota == 1) {
            $id = $this->_getParam('id', 0);
            $listaalumnos = $modelnotas->listaralumnoscurso($id, $idperiodo);
            $listanotas = $modelnotas->listarnotascursoperiodo($id, $idperiodo, array(1));
            $datosasignaturas = $modelasignatura->listarporcurso($id, 1, array('1', '3'), $idperiodo);

            //Datos Asignatura Combinadas
            $datosasignaturascombinada = $modelasignatura->getcombinada($id, $idperiodo);
            $largoalumnos = count($listaalumnos);
            $largocombinada = count($datosasignaturascombinada);
            $m = 0;


            //Talleres para Alumnos Separados Primer Semestre
            $datostallersem = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(1));
            $datostallersemseg = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(2));
            $datostalleranual = $modelasignatura->gettalleranual($id, $idperiodo, array(1), 1);
            $datostaller = array_merge($datostallersem, $datostallersemseg, $datostalleranual);
            $largotaller = count($datostaller);

            $modelotallerdetalle = new Application_Model_DbTable_Asignaturascursos();
            //Obtiene los Talleres que son Semestrales Tiempo=2.
            $datostalleres = $modelasignatura->gettaller($id, $idperiodo, array(2), 2, array(1, 2));

            $datoscurso = $modelcurso->listarcursoid($id, $idperiodo);
            //Configuracion de agregar 2 decimas a curso desde 5 a 4to medio cuando el promedio final de asignatura es mayor o igual a 6
            if (($datoscurso[0]['rbd'] == 1863) && (($datoscurso[0]['idCodigo'] == 110 && $datoscurso[0]['idGrado'] > 4) || $datoscurso[0]['idCodigo'] == 310 || $datoscurso[0]['idCodigo'] == 363 || $datoscurso[0]['idCodigo'] == 410 || $datoscurso[0]['idCodigo'] == 510 || $datoscurso[0]['idCodigo'] == 610 || $datoscurso[0]['idCodigo'] == 165)) {
                $agregadecimas = true;
            }

        } else { // se ingresan por asigntaura
            $usuario = new Zend_Session_Namespace('id');
            $user = $usuario->id;
            $idcursoaux = $this->_getParam('id', 0);

            //Validamos si el curso pertece a la jefatura del usuario
            $auxiliar = $modelcurso->listarcursoiddocenteactuals($user, $idperiodo, 1, $idcursoaux);

            if ($auxiliar && ($auxiliar[0]['idCursos'] == $idcursoaux) || $rol != 2) {
                //Asignaturas que pertencen a un curso de jefatura del usuario
                $id = $this->_getParam('id', 0);
                $listaalumnos = $modelnotas->listaralumnoscurso($id, $idperiodo);
                $listanotas = $modelnotas->listarnotascursoperiodo($id, $idperiodo, array('1'));
                $datosasignaturas = $modelasignatura->listarporcurso($id, 1, array('1', '3'), $idperiodo);

                //Datos Asignatura Combinadas
                $datosasignaturascombinada = $modelasignatura->getcombinada($id, $idperiodo);
                $largoalumnos = count($listaalumnos);
                $largocombinada = count($datosasignaturascombinada);
                $m = 0;


                //Talleres para Alumnos Separados Primer Semestre
                $datostallersem = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(1));
                $datostallersemseg = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(2));
                $datostalleranual = $modelasignatura->gettalleranual($id, $idperiodo, array(1), 1);
                $datostaller = array_merge($datostallersem, $datostallersemseg, $datostalleranual);
                $largotaller = count($datostaller);

                $modelotallerdetalle = new Application_Model_DbTable_Asignaturascursos();
                //Obtiene los Talleres que son Semestrales Tiempo=2.
                $datostalleres = $modelasignatura->gettaller($id, $idperiodo, array(2), 2, array(1, 2));

                $datoscurso = $modelcurso->listarcursoid($id, $idperiodo);
                //Configuracion de agregar 2 decimas a curso desde 5 a 4to medio cuando el promedio final de asignatura es mayor o igual a 6
                if (($datoscurso[0]['rbd'] == 1863) && (($datoscurso[0]['idCodigo'] == 110 && $datoscurso[0]['idGrado'] > 4) || $datoscurso[0]['idCodigo'] == 310 || $datoscurso[0]['idCodigo'] == 363 || $datoscurso[0]['idCodigo'] == 410 || $datoscurso[0]['idCodigo'] == 510 || $datoscurso[0]['idCodigo'] == 610 || $datoscurso[0]['idCodigo'] == 165)) {
                    $agregadecimas = true;
                }
            } else {
                //Asignaturas que pertencen a un curso que no es jefatura
                $cursomodel = new Application_Model_DbTable_Detallecursocuenta();
                $id = $this->_getParam('ids', 0);
                $ids = $this->_getParam('id', 0);

                $rowcurso = $cursomodel->listarcursoasignatura($ids);
                $listaasigatura = unserialize($rowcurso[0]['asignaturasLista']);
                $datosasignaturas = $modelasignatura->getasignaturasarray($listaasigatura);

                $listaalumnos = $modelnotas->listaralumnoscurso($id, $idperiodo);
                $listanotas = $modelnotas->listarnotascursoperiodo($id, $idperiodo, array('1'));
                //$datosasignaturas = $modelasignatura->listarporcurso($id, 1, array('1', '3'), $idperiodo);

                //Datos Asignatura Combinadas
                $datosasignaturascombinada = $modelasignatura->getcombinada($id, $idperiodo);
                $largoalumnos = count($listaalumnos);
                $largocombinada = count($datosasignaturascombinada);
                $m = 0;


                //Talleres para Alumnos Separados Primer Semestre
                $datostallersem = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(1));
                $datostallersemseg = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(2));
                $datostalleranual = $modelasignatura->gettalleranual($id, $idperiodo, array(1), 1);
                $datostaller = array_merge($datostallersem, $datostallersemseg, $datostalleranual);
                $largotaller = count($datostaller);

                $modelotallerdetalle = new Application_Model_DbTable_Asignaturascursos();
                //Obtiene los Talleres que son Semestrales Tiempo=2.
                $datostalleres = $modelasignatura->gettaller($id, $idperiodo, array(2), 2, array(1, 2));

                $datoscurso = $modelcurso->listarcursoid($id, $idperiodo);
                //Configuracion de agregar 2 decimas a curso desde 5 a 4to medio cuando el promedio final de asignatura es mayor o igual a 6
                if (($datoscurso[0]['rbd'] == 1863) && (($datoscurso[0]['idCodigo'] == 110 && $datoscurso[0]['idGrado'] > 4) || $datoscurso[0]['idCodigo'] == 310 || $datoscurso[0]['idCodigo'] == 363 || $datoscurso[0]['idCodigo'] == 410 || $datoscurso[0]['idCodigo'] == 510 || $datoscurso[0]['idCodigo'] == 610 || $datoscurso[0]['idCodigo'] == 165)) {
                    $agregadecimas = true;
                }
            }

        }


        ///Fin Definir ingreso de notas


        $promediotalleralumnos = array();
        $promediotalleralumnoss = array();
        if ($datostalleres) {
            for ($j = 0; $j < $largoalumnos; $j++) {
                for ($i = 0; $i < count($datostalleres); $i++) {
                    $detalletaller = $modelotallerdetalle->gettallersegmento($datostalleres[$i]['idConfiguracionTaller'], 1, $listaalumnos[$j]['idAlumnos']);
                    $detalletallers = $modelotallerdetalle->gettallersegmento($datostalleres[$i]['idConfiguracionTaller'], 2, $listaalumnos[$j]['idAlumnos']);


                    //Primer Semestre
                    if ($datostalleres[$i]['tiempoOpcion'] == 1) {
                        if ($detalletaller) {
                            $datosalumnostaller = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 1, $id, $detalletaller[0]['idAsignatura']);

                            if ($datosalumnostaller) {
                                for ($k = 0; $k < count($datosalumnostaller); $k++) {

                                    if ($datostalleres[$i]['idAsignatura'] == $datosalumnostaller[$k]['idAsignatura']) {
                                        if ($datosalumnostaller[$k]['coef'] == 2) {
                                            if ($datosalumnostaller[$k]['nota'] > 0) {
                                                $promediotalleralumnos[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                                $promediotalleralumnos[$j][$i][] = $datosalumnostaller[$k]['nota'];

                                            } else {
                                                $promediotalleralumnos[$j][$i][] = 0;
                                                $promediotalleralumnos[$j][$i][] = 0;
                                            }

                                        } else {
                                            if ($datosalumnostaller[$k]['nota'] > 0) {
                                                $promediotalleralumnos[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                            } else {
                                                $promediotalleralumnos[$j][$i][] = 0;
                                            }

                                        }


                                    }


                                }
                            }
                            if (!empty($promediotalleralumnos[$j][$i])) {
                                $promsetalumnos = array_diff($promediotalleralumnos[$j][$i], array('0'));
                            } else {
                                $promsetalumnos = 0;
                            }

                            if (is_array($promsetalumnos)) {
                                if (count($promsetalumnos) > 0) {

                                    if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                        $promtalleralumnos[$j][$i]['nota'] = round(array_sum($promsetalumnos) / count($promsetalumnos));

                                    } else {
                                        $promtalleralumnos[$j][$i]['nota'] = intval(array_sum($promsetalumnos) / count($promsetalumnos));
                                    }
                                } else {
                                    $promtalleralumnos[$j][$i]['nota'] = 0;
                                }
                            } else {
                                $promtalleralumnos[$j][$i]['nota'] = 0;
                            }


                            $promtalleralumnos[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                            $promtalleralumnos[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                            $promtalleralumnos[$j][$i]['coef'] = 1;
                            $promtalleralumnos[$j][$i]['tiempo'] = 1;
                            $promtalleralumnos[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                            $promtalleralumnos[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];

                        } else {
                            $promtalleralumnoss[$j][$i]['nota'] = 0;
                            $promtalleralumnos[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                            $promtalleralumnos[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                            $promtalleralumnos[$j][$i]['coef'] = 1;
                            $promtalleralumnos[$j][$i]['tiempo'] = 1;
                            $promtalleralumnos[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                            $promtalleralumnos[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];
                        }
                    } else {
                        $promtalleralumnos[$j][$i] = array();
                    }

                    //Segundo Semestre
                    if ($datostalleres[$i]['tiempoOpcion'] == 2) {
                        if ($detalletallers) {
                            $datosalumnostallers = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 2, $id, $detalletallers[0]['idAsignatura']);

                            if ($datosalumnostallers) {
                                for ($k = 0; $k < count($datosalumnostallers); $k++) {

                                    if ($datostalleres[$i]['idAsignatura'] == $datosalumnostallers[$k]['idAsignatura']) {

                                        if ($datosalumnostallers[$k]['coef'] == 2) {
                                            if ($datosalumnostallers[$k]['nota'] > 0) {
                                                $promediotalleralumnoss[$j][$i][] = $datosalumnostallers[$k]['nota'];
                                                $promediotalleralumnoss[$j][$i][] = $datosalumnostallers[$k]['nota'];

                                            } else {
                                                $promediotalleralumnoss[$j][$i][] = 0;
                                                $promediotalleralumnoss[$j][$i][] = 0;
                                            }

                                        } else {
                                            if ($datosalumnostallers[$k]['nota'] > 0) {
                                                $promediotalleralumnoss[$j][$i][] = $datosalumnostallers[$k]['nota'];
                                            } else {
                                                $promediotalleralumnoss[$j][$i][] = 0;
                                            }

                                        }


                                    }


                                }
                            }
                            if (!empty($promediotalleralumnoss[$j][$i])) {
                                $promsetalumnoss = array_diff($promediotalleralumnoss[$j][$i], array('0'));
                            } else {
                                $promsetalumnoss = 0;
                            }

                            if (is_array($promsetalumnoss)) {
                                if (count($promsetalumnoss) > 0) {

                                    if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                        $promtalleralumnoss[$j][$i]['nota'] = round(array_sum($promsetalumnoss) / count($promsetalumnoss));
                                        $promtalleralumnoss[$j][$i]['nota'] = intval($promtalleralumnoss[$j][$i]['nota']);

                                    } else {
                                        $promtalleralumnoss[$j][$i]['nota'] = intval(array_sum($promsetalumnoss) / count($promsetalumnoss));
                                    }
                                } else {
                                    $promtalleralumnoss[$j][$i]['nota'] = 0;
                                }
                            } else {
                                $promtalleralumnoss[$j][$i]['nota'] = 0;
                            }


                            $promtalleralumnoss[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                            $promtalleralumnoss[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                            $promtalleralumnoss[$j][$i]['coef'] = 1;
                            $promtalleralumnoss[$j][$i]['tiempo'] = 2;
                            $promtalleralumnoss[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                            $promtalleralumnoss[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];

                        } else {
                            $promtalleralumnoss[$j][$i]['nota'] = 0;
                            $promtalleralumnoss[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                            $promtalleralumnoss[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                            $promtalleralumnoss[$j][$i]['coef'] = 1;
                            $promtalleralumnoss[$j][$i]['tiempo'] = 2;
                            $promtalleralumnoss[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                            $promtalleralumnoss[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];
                        }
                    } else {
                        $promtalleralumnoss[$j][$i] = array();
                    }


                }//Fin if talleres


                for ($l = 0; $l < count($promtalleralumnos[$j]); $l++) {
                    if (!empty($promtalleralumnos[$j][$l]["idAsignatura"])) {
                        $datosdestino = $modelotallerdetalle->getdestino($promtalleralumnos[$j][$l]["idAsignatura"]);
                        if ($datosdestino[0]['tipoAsignatura'] != 4) {
                            $listapromediostaller[$j][] = $promtalleralumnos[$j][$l];
                        } else {
                            $listapromediostallercom[$j][$promtalleralumnos[$j][$l]['idAsignatura']] = $promtalleralumnos[$j][$l];

                        }
                    }

                }


                for ($l = 0; $l < count($promtalleralumnoss[$j]); $l++) {
                    if (!empty($promtalleralumnoss[$j][$l]["idAsignatura"])) {
                        $datosdestino = $modelotallerdetalle->getdestino($promtalleralumnoss[$j][$l]["idAsignatura"]);
                        if ($datosdestino[0]['tipoAsignatura'] != 4) {
                            $listapromediostallers[$j][] = $promtalleralumnoss[$j][$l];
                        } else {
                            $listapromediostallercoms[$j][$promtalleralumnoss[$j][$l]['idAsignatura']] = $promtalleralumnoss[$j][$l];

                        }
                    }

                }


            }//Fin for Alumnos


        }


        //Fin Talleres

        //Asignaturas Combinadas


        $datosasignaturascombinada = $modelasignatura->getcombinada($id, $idperiodo);

        $largoalumnos = count($listaalumnos);
        $largotaller = count($datostaller);
        $largocombinada = count($datosasignaturascombinada);
        $m = 0;

        if ($largocombinada > 0) {
            $m = 0;

            for ($i = 0; $i < $largocombinada; $i++) {
                $listaasignatura[$i] = unserialize($datosasignaturascombinada[$i]['asignaturas']);

                for ($h = 0; $h < count($listaasignatura[$i]); $h++) {
                    $datocombinada = $modelasignatura->getnombre($listaasignatura[$i][$h]);

                    $validacom[$i][$m] = $datosasignaturascombinada[$i]['idAsignatura'];
                    $m++;
                    $validacom[$i][$m] = $datosasignaturascombinada[$i]['idAsignatura'];

                    //$m++;
                    for ($j = 0; $j < $largoalumnos; $j++) {
                        $datosalumnoscom = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 1, $id, $datocombinada[0]['idAsignatura']);
                        $datosalumnoscoms = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 2, $id, $datocombinada[0]['idAsignatura']);
                        //Primer Semestre
                        if ($listapromediostallercom) {
                            if ($datocombinada[0]['idAsignatura'] == $listapromediostallercom[$j][$datocombinada[0]['idAsignatura']]['idAsignatura']) {
                                $datosalumnoscom[] = $listapromediostallercom[$j][$datocombinada[0]['idAsignatura']];
                            }

                        }
                        //Segundo Semestre
                        if ($listapromediostallercoms) {
                            if ($datocombinada[0]['idAsignatura'] == $listapromediostallercoms[$j][$datocombinada[0]['idAsignatura']]['idAsignatura']) {
                                $datosalumnoscoms[] = $listapromediostallercoms[$j][$datocombinada[0]['idAsignatura']];
                            }

                        }


                        for ($k = 0; $k < count($datosalumnoscom); $k++) {
                            if ($datocombinada[0]['idAsignatura'] == $datosalumnoscom[$k]['idAsignatura']) {
                                if ($datosalumnoscom[$k]['coef'] == 2) {
                                    if ($datosalumnoscom[$k]['nota'] > 0) {
                                        $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];
                                        $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];

                                    } else {
                                        $promediocom[$j][$m][] = 0;
                                        $promediocom[$j][$m][] = 0;
                                    }

                                } else {

                                    if ($datosalumnoscom[$k]['nota'] == 0 || empty($datosalumnoscom[$k]['nota']) || $datosalumnoscom[$k]['nota'] == NULL || $datosalumnoscom[$k]['nota'] == '') {
                                        if (!empty($datosalumnoscom[$k]["forma"])) {
                                            if ($datosalumnoscom[$k]['nota'] == 0) {
                                                $promediocom[$j][$m][] = 0;
                                            }

                                        } else {
                                            $promediocom[$j][$m][] = 0;
                                        }


                                    } else {
                                        if (!empty($datosalumnoscom[$k]["forma"]) && $datosalumnoscom[$k]["forma"] == 2) {
                                            $promtalleraux = $datosalumnoscom[$k]['nota'];
                                            $porcentajetaller = $datosalumnoscom[$k]["porcentaje"];


                                        } elseif (!empty($datosalumnoscom[$k]["forma"]) && $datosalumnoscom[$k]["forma"] == 1) {
                                            $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];
                                            $promtalleraux = array();
                                            $porcentajetaller = array();
                                        } else {
                                            $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];
                                            $promtalleraux = array();
                                            $porcentajetaller = array();
                                        }


                                    }

                                }//fin else


                            }

                        }


                        for ($k = 0; $k < count($datosalumnoscoms); $k++) {
                            if ($datocombinada[0]['idAsignatura'] == $datosalumnoscoms[$k]['idAsignatura']) {
                                if ($datosalumnoscoms[$k]['coef'] == 2) {
                                    if ($datosalumnoscoms[$k]['nota'] > 0) {
                                        $promediocoms[$j][$m][] = $datosalumnoscoms[$k]['nota'];
                                        $promediocoms[$j][$m][] = $datosalumnoscoms[$k]['nota'];

                                    } else {
                                        $promediocoms[$j][$m][] = 0;
                                        $promediocoms[$j][$m][] = 0;
                                    }

                                } else {

                                    if ($datosalumnoscoms[$k]['nota'] == 0 || empty($datosalumnoscoms[$k]['nota']) || $datosalumnoscoms[$k]['nota'] == NULL || $datosalumnoscoms[$k]['nota'] == '') {
                                        if (!empty($datosalumnoscoms[$k]["forma"])) {
                                            if ($datosalumnoscoms[$k]['nota'] == 0) {
                                                $promediocoms[$j][$m][] = 0;
                                            }

                                        } else {
                                            $promediocoms[$j][$m][] = 0;
                                        }


                                    } else {
                                        if (!empty($datosalumnoscoms[$k]["forma"]) && $datosalumnoscoms[$k]["forma"] == 2) {
                                            $promtallerauxs = $datosalumnoscoms[$k]['nota'];
                                            $porcentajetallers = $datosalumnoscoms[$k]["porcentaje"];


                                        } elseif (!empty($datosalumnoscoms[$k]["forma"]) && $datosalumnoscoms[$k]["forma"] == 1) {
                                            $promediocoms[$j][$m][] = $datosalumnoscoms[$k]['nota'];
                                            $promtallerauxs = array();
                                            $porcentajetallers = array();
                                        } else {
                                            $promediocoms[$j][$m][] = $datosalumnoscoms[$k]['nota'];
                                            $promtallerauxs = array();
                                            $porcentajetallers = array();
                                        }


                                    }

                                }//fin else


                            }

                        }
                        //Primer Semestre Promedio
                        if (!empty($promediocom[$j][$m])) {
                            $promset = array_diff($promediocom[$j][$m], array('0'));
                        } else {
                            $promset = 0;
                        }

                        if (is_array($promset)) {
                            if (count($promset) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    if ($porcentajetaller) {
                                        $totalporcentaje = 100;
                                        $porcentajeasig = $totalporcentaje - $porcentajetaller;
                                        $promedioauxalum = array_sum($promset) / count($promset);
                                        //$promcom[$j][$m]['nota'] = round(array_sum($promset) / count($promset));
                                        $promcom[$j][$m]['nota'] = round(($promedioauxalum * ($porcentajeasig / 100)) + ($promtalleraux * ($porcentajetaller / 100)));

                                    } else {
                                        $promcom[$j][$m]['nota'] = round(array_sum($promset) / count($promset));
                                    }

                                } else {
                                    if ($porcentajetaller) {
                                        $totalporcentaje = 100;
                                        $porcentajeasig = $totalporcentaje - $porcentajetaller;
                                        $promedioauxalum = array_sum($promset) / count($promset);
                                        //$promcom[$j][$m]['nota'] = round(array_sum($promset) / count($promset));
                                        $promcom[$j][$m]['nota'] = round(($promedioauxalum * ($porcentajeasig / 100)) + ($promtalleraux * ($porcentajetaller / 100)));
                                        // $promcom[$j][$m]['nota'] = intval(($promedioauxalum * ($porcentajeasig / 100)) + ($promtalleraux * ($porcentajetaller / 100)));

                                    } else {
                                        $promcom[$j][$m]['nota'] = intval(array_sum($promset) / count($promset));
                                    }
                                }
                            } else {
                                $promcom[$j][$m]['nota'] = 0;
                            }

                        } else {

                            $promcom[$j][$m]['nota'] = 0;
                        }
                        $promcom[$j][$m]['idAsignatura'] = $datosasignaturascombinada[$i]['idAsignatura'];
                        $promcom[$j][$m]['coef'] = 1;
                        $promcom[$j][$m]['tiempo'] = 1;

                        //Segundo Semestre
                        if (!empty($promediocoms[$j][$m])) {
                            $promsets = array_diff($promediocoms[$j][$m], array('0'));
                        } else {
                            $promsets = 0;
                        }


                        if (is_array($promsets)) {
                            if (count($promsets) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    if ($porcentajetallers) {
                                        $totalporcentajes = 100;
                                        $porcentajeasigs = $totalporcentajes - $porcentajetallers;
                                        $promedioauxalums = array_sum($promsets) / count($promsets);
                                        $promcoms[$j][$m]['nota'] = round(($promedioauxalums * ($porcentajeasigs / 100)) + ($promtallerauxs * ($porcentajetallers / 100)));


                                    } else {
                                        $promcoms[$j][$m]['nota'] = round(array_sum($promsets) / count($promsets));

                                    }

                                } else {
                                    if ($porcentajetallers) {
                                        $totalporcentajes = 100;
                                        $porcentajeasigs = $totalporcentajes - $porcentajetallers;
                                        $promedioauxalums = array_sum($promsets) / count($promsets);
                                        $promcoms[$j][$m]['nota'] = round(($promedioauxalums * ($porcentajeasigs / 100)) + ($promtallerauxs * ($porcentajetallers / 100)));


                                    } else {
                                        $promcoms[$j][$m]['nota'] = intval(array_sum($promsets) / count($promsets));

                                    }
                                }
                            } else {
                                $promcoms[$j][$m]['nota'] = 0;
                            }

                        } else {


                            $promcoms[$j][$m]['nota'] = 0;
                        }
                        $promcoms[$j][$m]['idAsignatura'] = $datosasignaturascombinada[$i]['idAsignatura'];
                        $promcoms[$j][$m]['coef'] = 1;
                        $promcoms[$j][$m]['tiempo'] = 2;


                    }
                    $m++;
                }

            }
        }


        //Taller Por Segmento Curso Completo
        $datostallersem = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(1));
        $datostallersemseg = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(2));
        $largotallerprimero = count($datostallersem);
        $largotallersegundo = count($datostallersemseg);


        $promediotaller = array();
        if ($largotallerprimero > 0) {

            for ($i = 0; $i < $largotallerprimero; $i++) {
                if (!empty($datostallersem[$i]['idConfiguracionTaller'])) {
                    $validataller[$i] = $datostallersem[$i]['idAsignaturaTaller'];
                    for ($j = 0; $j < $largoalumnos; $j++) {
                        $promediofinal = 0;
                        $datosalumnostaller = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 1, $id, $datostallersem[$i]['idAsignatura']);


                        for ($k = 0; $k < count($datosalumnostaller); $k++) {
                            if ($datostaller[$i]['idAsignatura'] == $datosalumnostaller[$k]['idAsignatura']) {
                                if ($datosalumnostaller[$k]['coef'] == 2) {
                                    if ($datosalumnostaller[$k]['nota'] > 0) {
                                        $promediotaller[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                        $promediotaller[$j][$i][] = $datosalumnostaller[$k]['nota'];

                                    } else {
                                        $promediotaller[$j][$i][] = 0;
                                        $promediotaller[$j][$i][] = 0;
                                    }

                                } else {
                                    if ($datosalumnostaller[$k]['nota'] > 0) {
                                        $promediotaller[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                    } else {
                                        $promediotaller[$j][$i][] = 0;
                                    }

                                }


                            }

                        }


                        //Primer Semestre
                        if (!empty($promediotaller[$j][$i])) {
                            $promset = array_diff($promediotaller[$j][$i], array('0'));
                        } else {
                            $promset = 0;
                        }

                        if (is_array($promset)) {
                            if (count($promset) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    $promtaller[$j][$i]['nota'] = round(array_sum($promset) / count($promset));

                                } else {
                                    $promtaller[$j][$i]['nota'] = intval(array_sum($promset) / count($promset));
                                }
                            } else {
                                $promtaller[$j][$i]['nota'] = 0;
                            }

                        } else {
                            $promtaller[$j][$i]['nota'] = 0;
                        }


                        $promtaller[$j][$i]['idAsignatura'] = $datostallersem[$i]['idAsignaturaTaller'];
                        $promtaller[$j][$i]['coef'] = 1;
                        $promtaller[$j][$i]['tiempo'] = 1;
                        $promtaller[$j][$i]['forma'] = $datostallersem[$i]['forma'];
                        $promtaller[$j][$i]['porcentaje'] = $datostallersem[$i]['porcentaje'];


                    }

                }


            }
        }

        //Segundo Semestre
        if ($largotallersegundo > 0) {

            for ($i = 0; $i < $largotallersegundo; $i++) {
                if (!empty($datostallersemseg[$i]['idConfiguracionTaller'])) {
                    $validatallers[$i] = $datostallersemseg[$i]['idAsignaturaTaller'];
                    for ($j = 0; $j < $largoalumnos; $j++) {
                        $promediofinal = 0;
                        $datosalumnostallers = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 2, $id, $datostallersemseg[$i]['idAsignatura']);

                        for ($k = 0; $k < count($datosalumnostallers); $k++) {
                            if ($datostallersemseg[$i]['idAsignatura'] == $datosalumnostallers[$k]['idAsignatura']) {
                                if ($datosalumnostallers[$k]['coef'] == 2) {
                                    if ($datosalumnostallers[$k]['nota'] > 0) {
                                        $promediotallers[$j][$i][] = $datosalumnostallers[$k]['nota'];
                                        $promediotallers[$j][$i][] = $datosalumnostallers[$k]['nota'];

                                    } else {
                                        $promediotallers[$j][$i][] = 0;
                                        $promediotallers[$j][$i][] = 0;
                                    }

                                } else {
                                    if ($datosalumnostallers[$k]['nota'] > 0) {
                                        $promediotallers[$j][$i][] = $datosalumnostallers[$k]['nota'];
                                    } else {
                                        $promediotallers[$j][$i][] = 0;
                                    }

                                }


                            }


                        }
                        if (!empty($promediotallers[$j][$i])) {
                            $promsets = array_diff($promediotallers[$j][$i], array('0'));
                        } else {
                            $promsets = 0;
                        }

                        if (is_array($promsets)) {
                            if (count($promsets) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    $auxtallers = round(array_sum($promsets) / count($promsets));
                                    $promtallers[$j][$i]['nota'] = intval($auxtallers);

                                } else {
                                    $promtallers[$j][$i]['nota'] = intval(array_sum($promsets) / count($promsets));
                                }
                            } else {
                                $promtallers[$j][$i]['nota'] = 0;
                            }

                        } else {
                            $promtallers[$j][$i]['nota'] = 0;
                        }


                        $promtallers[$j][$i]['idAsignatura'] = $datostallersemseg[$i]['idAsignaturaTaller'];
                        $promtallers[$j][$i]['coef'] = 1;
                        $promtallers[$j][$i]['tiempo'] = 2;
                        $promtallers[$j][$i]['forma'] = $datostallersemseg[$i]['forma'];
                        $promtallers[$j][$i]['porcentaje'] = $datostallersemseg[$i]['porcentaje'];


                    }

                }


            }
        }


        if ($largoalumnos == 0 || count($listanotas) == 0) {
            echo "<script type=\"text/javascript\">alert(\"Sin Notas\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            exit;

        }

        for ($i = 0; $i < $largoalumnos; $i++) {

            $valores = $modelnotas->listarnotasporalumno($listaalumnos[$i]['idAlumnos'], $idperiodo, $id);
            if ($valores != '' || !empty($valores)) {
                $listaalumnos[$i]['listanotas'] = $valores;
            } else {
                $listaalumnos[$i]['listanotas'] = 0;

            }
            for ($j = 0; $j < count($promtaller[$i]); $j++) {
                $listaalumnos[$i]['listanotas'][] = $promtaller[$i][$j];
                //array_unshift($listaalumnos[$i]['listanotas'], $promtaller[$i][$j]);
            }


            foreach ($promcom[$i] as $a => $j) {
                $listaalumnos[$i]['listanotas'][] = $promcom[$i][$a];
            }
            //Segundo Semestre
            for ($j = 0; $j < count($promtallers[$i]); $j++) {
                $listaalumnos[$i]['listanotas'][] = $promtallers[$i][$j];
            }

            foreach ($promcoms[$i] as $a => $j) {
                $listaalumnos[$i]['listanotas'][] = $promcoms[$i][$a];
            }

            if ($listapromediostaller[$i]) {
                for ($j = 0; $j < count($listapromediostaller[$i]); $j++) {
                    $listaalumnos[$i]['listanotas'][] = $listapromediostaller[$i][$j];
                }
            }

            if ($listapromediostallers[$i]) {
                for ($j = 0; $j < count($listapromediostallers[$i]); $j++) {
                    $listaalumnos[$i]['listanotas'][] = $listapromediostallers[$i][$j];
                }
            }


        }


        $nombreseg = 'FINAL';
        $logo = getcwd();
        $logo .= "/application/documentos/logos/" . $datoscurso[0]['extension'];


        // variables para encabezado
        $titulo = strtoupper($datoscurso[0]['nombreEstablecimiento']) . '<br>' . strtoupper($nombreseg);

        if (file_exists($logo)) {
            $encabezado = '<img style="position:absolute;top:10px;left:30px" src="' . $logo . '" /><h4 style="position:absolute;top:50px;text-align:center">' . $titulo . '</h4>';

        } else {
            $encabezado = '<p style="position:absolute;top:5px;text-align:left"></p><h4 style="position:absolute;top:50px;text-align:center">' . $titulo . '</h4>';

        }

        if (!empty($datosasignaturas)) {
            $largoasignatura = count($datosasignaturas);
            for ($i = 0; $i < $largoasignatura; $i++) {

                $datoscuenta[$i] = $modelnotas->listarcantidadnotasanual($id, $idperiodo, $datosasignaturas[$i]['idAsignatura']);
                if (empty($datoscuenta[$i]) && $datosasignaturas[$i]['tipoAsignatura'] == 1) {
                    $datosasig[$i] = 0;
                } else {
                    $largonotas = count($datoscuenta[$i]);
                    $datosasig[$i] = 0;
                    //Primer Semestre
                    for ($j = 0; $j < count($validataller); $j++) {
                        if ($datosasignaturas[$i]['idAsignatura'] == $validataller[$j]) {
                            $datosasig[$i] += 1;
                        }
                    }
                    //Segundo Semestre

                    for ($j = 0; $j < count($validatallers); $j++) {
                        if ($datosasignaturas[$i]['idAsignatura'] == $validatallers[$j]) {
                            $datosasig[$i] += 1;
                        }
                    }
                    for ($j = 0; $j < count($validacom); $j++) {
//                        for ($k = 0; $k < count($validacom[$j]); $k++) {
//                            if ($datosasignaturas[$i]['idAsignatura'] == $validacom[$j][$k]) {
//
//                                $datosasig[$i] += 1;
//                            }
//                        }
                        foreach ($validacom[$j] as $a => $h) {
                            if ($datosasignaturas[$i]['idAsignatura'] == $validacom[$j][$a]) {
                                $datosasig[$i] += 1;
                            }
                        }

                    }

                    for ($j = 0; $j < count($datostalleres); $j++) {
                        if ($datosasignaturas[$i]['idAsignatura'] == $datostalleres[$j]['idAsignaturaTaller']) {
                            $datosasig[$i] += 1;
                        }
                    }

                    for ($j = 0; $j < $largonotas; $j++) {
                        if ($datoscuenta[$i][$j]['tiempo'] == 1 || $datoscuenta[$i][$j]['tiempo'] == 2) {
                            if ($datoscuenta[$i][$j]['coef'] == 2) {
                                $datosasig[$i] += 2;
                            } else {
                                $datosasig[$i] += 1;
                            }
                        }


                    }


                }

                //Si la configuracion indica que se utiliza examen
                if ($datoscurso[0]['examen'] == 1) {
                    $modeloprueba = new Application_Model_DbTable_Pruebas();
                    //Veficiamos que las asignaturas posean examen
                    $datosexamenes[$i] = $modeloprueba->getexamen($id, $idperiodo, $datosasignaturas[$i]['idAsignatura'], 6);

                }

            }
        } else {
            echo "<script type=\"text/javascript\">alert(\"El Curso no Posee Asignaturas en el periodo\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            exit;

        }


        //Estilo pdf
        $style = "body{
font:12px ,Arial, Tahoma, Verdana, Helvetica, sans-serif;

color:#000;
}
img{
  width:60px;
  height:70px;
}


table{
font-size:10px;
width:100%;
height:auto;
margin:10px 0 10px 0;
border-collapse:collapse;
text-align:center;
text-justify:inter-word;
color:#000000;
}

table td,th{
border:1px solid black;
}

table th{
padding:1px;
background-color: #ccc;
}
";

        $pag = 0;
        $cuentapag = 0;
        $max = 23;


        $html[$pag] = $encabezado;
        $html[$pag] .= "<div style='position:absolute;top:75px;left:25px;'><br> Curso: <b>" . $datoscurso[0]['nombreGrado'] . " " . $datoscurso[0]['letra'] . "</b><br> Fecha : <b>" . $fecha_final . "</b></div>";

        $html[$pag] .= '<table align="left" style="margin-left:20px"><tr><th>Nº</th><th>Alumnos</th>';

        for ($i = 0; $i < $largoasignatura; $i++) {


            //obtenemos cuantas notas existen en cada asignatura
            $row = $datosasig[$i];
            $cuentapag = $cuentapag + $row;

            // si la cantidad de notas supera las 28 sumamos al contador de pag
            if ($cuentapag > $max) {
                $pag++;
                if ($pag == 1) {
                    $max = 40;
                }
                if ($pag == 2) {
                    $max = 60;
                }
                if ($pag == 3) {
                    $max = 80;
                }
                if ($pag == 4) {
                    $max = 100;
                }
                if ($pag == 5) {
                    $max = 120;
                }
                if ($pag == 6) {
                    $max = 140;
                }
                if ($pag == 7) {
                    $max = 160;
                }
                $html[$pag] = '<table align="left" style="margin-left:20px"><tr><th>Nº</th><th>Alumno</th>';

            }


            //si row es distinto de cero suma uno a row para crear el promedio
            if ($row != 0) {
                $row = $row + 3;
                if ($datosexamenes[$i]) {
                    //$row+=1;
                    $html[$pag] .= '<th style="width:25px;text-align:left;word-break: break-all;" colspan=' . ($row + 2) . '>' . $datosasignaturas[$i]["nombreAsignatura"] . '</th>';

                } else {
                    $html[$pag] .= '<th style="width:25px;text-align:left;word-break: break-all;" colspan=' . $row . '>' . $datosasignaturas[$i]["nombreAsignatura"] . '</th>';

                }
            } else {

                $html[$pag] .= '<th style="width:25px;text-align:left;word-break: break-all;">' . $datosasignaturas[$i]["nombreAsignatura"] . '</th>';

            }
        }

        $html[$pag] .= "<th>PROM</th><th>Días</th><th>Días</th><th>%</th>";

        $pag = 0;
        $cuentapag = 0;
        $max = 23;
        $cuentapag2 = array();


        $html[$pag] .= '</tr><tr><th colspan="2">Nº Notas/Prom</th>';

        for ($i = 0; $i < $largoasignatura; $i++) {


            $row = $datosasig[$i];
            $cuentapag = $cuentapag + $row;

            // si la cantidad de notas supera las notas que ingresan en una hoja
            if ($cuentapag > $max) {
                $html[$pag] .= '</tr>';
                $pag++;

                if ($pag == 1) {
                    $max = 40;
                }
                if ($pag == 2) {
                    $max = 60;
                }
                if ($pag == 3) {
                    $max = 80;
                }
                if ($pag == 4) {
                    $max = 100;
                }
                if ($pag == 5) {
                    $max = 120;
                }
                if ($pag == 6) {
                    $max = 140;
                }
                if ($pag == 7) {
                    $max = 160;
                }
                $html[$pag] .= '</tr><tr><th colspan="2">Nº Notas/Prom</th>';

            }

            if ($row != 0) {

                for ($j = 1; $j <= $row; $j++) {

                    $html[$pag] .= '<th>N' . $j . '</th>';
                    $cuentapag2[$pag] += 1;
                }
                if ($datosexamenes[$i]) {
                    $html[$pag] .= '<th>I SEM</th>';
                    $html[$pag] .= '<th>II SEM</th>';
                    $html[$pag] .= '<th>FIN</th>';
                    $html[$pag] .= '<th>EX <br>' . $datosexamenes[$i][0]['porcentajeExamen'] . ' %</th>';
                    $html[$pag] .= '<th>FIN + <br>EX ' . $datosexamenes[$i][0]['porcentajeExamen'] . ' %</th>';
                    $cuentapag2[$pag] += 5;
                } else {
                    $html[$pag] .= '<th>I SEM</th>';
                    $html[$pag] .= '<th>II SEM</th>';
                    $html[$pag] .= '<th>FIN</th>';
                    $cuentapag2[$pag] += 3;
                }

                //$cuentapag2[$pag] += 3;
            } else {
                $html[$pag] .= '<th>Sin Notas</th>';
                $cuentapag2[$pag] += 1;

            }


        }


        $html[$pag] .= '<th>PROM</th>';
        $cuentapag2[$pag] += 1;
        $html[$pag] .= '<th>Trab</th><th>Inas</th><th>Asis</th>';


        $html[$pag] .= '</tr>';


        if (!empty($listaalumnos)) {
            $r = 0;

            for ($i = 0; $i < $largoalumnos; $i++) {
                //for ($i = 0; $i < 1; $i++) {
                $pag = 0;
                $cuentapag = 0;
                $max = 23;
                $html[$pag] .= '<tr><td>' . ($i + 1) . '</td><td style="text-align: left;">' . $listaalumnos[$i]["apaterno"] . ' ' . $listaalumnos[$i]["amaterno"] . ' ' . $listaalumnos[$i]["nombres"] . '</td>';
                $r = 0;
                for ($j = 0; $j < $largoasignatura; $j++) {

                    $promtalleraux = array();
                    $porcentajetaller = array();
                    $sumataller = 0;
                    $promtallerauxs = array();
                    $porcentajetallers = array();
                    $sumatallers = 0;
                    $row = $datosasig[$j];
                    $cuentapag = $cuentapag + $row;

                    if ($cuentapag > $max) {
                        $html[$pag] .= '</tr>';
                        $pag++;
                        if ($pag == 1) {
                            $max = 40;
                        }
                        if ($pag == 2) {
                            $max = 60;
                        }
                        if ($pag == 3) {
                            $max = 80;
                        }
                        if ($pag == 4) {
                            $max = 100;
                        }
                        if ($pag == 5) {
                            $max = 120;
                        }
                        if ($pag == 6) {
                            $max = 140;
                        }
                        if ($pag == 7) {
                            $max = 160;
                        }

                        $html[$pag] .= '<tr><td>' . ($i + 1) . '</td><td style="text-align: left;">' . $listaalumnos[$i]["apaterno"] . ' ' . $listaalumnos[$i]["amaterno"] . ' ' . $listaalumnos[$i]["nombres"] . '</td>';

                    }

                    $promedio = 0;
                    $contador = 0;
                    $contadorpromedio = 0;
                    $promedios = 0;
                    $contadorpromedios = 0;
                    if ($row != 0) {
                        $largolistanota = count($listaalumnos[$i]['listanotas']);
                        for ($z = 0; $z < $largolistanota; $z++) {
                            $contadoraux = 0;

                            if ($datosasignaturas[$j]['idAsignatura'] == $listaalumnos[$i]['listanotas'][$z]['idAsignatura']) {


                                $contador += 1;
                                //Primer Semesre
                                if ($listaalumnos[$i]['listanotas'][$z]['tiempo'] == '1') {
                                    $auxiliar[$i][] = $listaalumnos[$i]['listanotas'][$z];
                                    if ($listaalumnos[$i]['listanotas'][$z]['coef'] == '2') {
                                        $contador += 1;
                                        if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == NULL || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {
                                            $promedio += 0;
                                            $contadorpromedio += 0;
                                            $html[$pag] .= '<td> - </td>';
                                            $html[$pag] .= '<td> - </td>';
                                            $notamatriz[$r][] = 0;
                                            $r++;
                                            $notamatriz[$r][] = 0;
                                            $r++;

                                        } else {
                                            $html[$pag] .= '<td>' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                            $html[$pag] .= '<td>' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                            $promedio = $promedio + ($listaalumnos[$i]['listanotas'][$z]['nota'] + $listaalumnos[$i]['listanotas'][$z]['nota']);
                                            $contadorpromedio = $contadorpromedio + 2;
                                            $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                            $r++;
                                            $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                            $r++;


                                        }

                                    } else {

                                        if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == NULL || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {
                                            if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"])) {
                                                if ($listaalumnos[$i]["listanotas"][$z]["nota"] == 0) {

                                                    $promedio += 0;
                                                    $contadorpromedio += 0;
                                                    $html[$pag] .= '<td> - </td>';
                                                    $notamatriz[$r][] = 0;
                                                    $r++;


                                                }

                                            } else {
                                                $promedio += 0;
                                                $contadorpromedio += 0;
                                                $html[$pag] .= '<td> - </td>';
                                                $notamatriz[$r][] = 0;
                                                $r++;

                                            }


                                        } else {

                                            if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"]) && $listaalumnos[$i]["listanotas"][$z]["forma"] == 2) {


                                                $contadorauxtaller = true;
                                                $promtalleraux[] = $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $porcentajetaller[] = $listaalumnos[$i]["listanotas"][$z]["porcentaje"];
                                                $html[$pag] .= '<td bgcolor="#B2B0AF">' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                                $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                                $r++;


                                            } elseif (!empty($listaalumnos[$i]["listanotas"][$z]["forma"]) && $listaalumnos[$i]["listanotas"][$z]["forma"] == 1) {
                                                $html[$pag] .= '<td bgcolor="#B2B0AF">' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                                $promedio = $promedio + $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $contadorpromedio = $contadorpromedio + 1;
                                                $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                                $r++;
                                            } else {
                                                $html[$pag] .= '<td>' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                                $promedio = $promedio + $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $contadorpromedio = $contadorpromedio + 1;
                                                $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                                $r++;

                                            }
//                                            if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"]) && $listaalumnos[$i]["listanotas"][$z]["forma"] == 2) {
//
//                                                $contadorauxtaller = true;
//                                                $promtalleraux[] = $listaalumnos[$i]['listanotas'][$z]['nota'];
//                                                $porcentajetaller[] = $listaalumnos[$i]["listanotas"][$z]["porcentaje"];
//                                                $html[$pag] .= '<td bgcolor="#B2B0AF">' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
//                                                $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
//                                                $r++;
//
//
//                                            } else {
//                                                $promedio = $promedio + $listaalumnos[$i]['listanotas'][$z]['nota'];
//                                                $contadorpromedio = $contadorpromedio + 1;
//                                                $html[$pag] .= '<td>' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
//                                                $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
//                                                $r++;
//
//
//                                            }


                                        }


                                    }
                                } else if ($listaalumnos[$i]['listanotas'][$z]['tiempo'] == '2') {
                                    $auxiliar[$i][] = $listaalumnos[$i]['listanotas'][$z];
                                    //Segundo Semestre
                                    if ($listaalumnos[$i]['listanotas'][$z]['coef'] == '2') {
                                        $contador += 1;
                                        if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == NULL || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {
                                            $promedios += 0;
                                            $contadorpromedios += 0;
                                            $html[$pag] .= '<td> - </td>';
                                            $html[$pag] .= '<td> - </td>';
                                            $notamatriz[$r][] = 0;
                                            $r++;
                                            $notamatriz[$r][] = 0;
                                            $r++;

                                        } else {
                                            $promedios += ($listaalumnos[$i]['listanotas'][$z]['nota'] + $listaalumnos[$i]['listanotas'][$z]['nota']);
                                            $contadorpromedios += 2;
                                            $html[$pag] .= '<td>' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                            $html[$pag] .= '<td>' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                            $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                            $r++;
                                            $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                            $r++;
                                        }

                                    } else {

                                        if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == NULL || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {
                                            if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"])) {
                                                if ($listaalumnos[$i]["listanotas"][$z]["nota"] == 0) {

                                                    $promedios += 0;
                                                    $contadorpromedios += 0;
                                                    $html[$pag] .= '<td> - </td>';
                                                    $notamatriz[$r][] = 0;
                                                    $r++;


                                                }

                                            } else {
                                                $promedios += 0;
                                                $contadorpromedios += 0;
                                                $html[$pag] .= '<td> - </td>';
                                                $notamatriz[$r][] = 0;
                                                $r++;


                                            }


                                        } else {

                                            if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"]) && $listaalumnos[$i]["listanotas"][$z]["forma"] == 2) {


                                                $contadorauxtallers = true;
                                                $promtallerauxs[] = $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $porcentajetallers[] = $listaalumnos[$i]["listanotas"][$z]["porcentaje"];
                                                $html[$pag] .= '<td bgcolor="#B2B0AF">' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                                $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                                $r++;


                                            } elseif (!empty($listaalumnos[$i]["listanotas"][$z]["forma"]) && $listaalumnos[$i]["listanotas"][$z]["forma"] == 1) {
                                                $html[$pag] .= '<td bgcolor="#B2B0AF">' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                                $promedios = $promedios + $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $contadorpromedios = $contadorpromedios + 1;
                                                $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                                $r++;
                                            } else {
                                                $html[$pag] .= '<td>' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                                $promedios = $promedios + $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $contadorpromedios = $contadorpromedios + 1;
                                                $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                                $r++;

                                            }
//                                            if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"]) && $listaalumnos[$i]["listanotas"][$z]["forma"] == 2) {
//
//                                                $contadorauxtallers = true;
//                                                $promtallerauxs[] = $listaalumnos[$i]['listanotas'][$z]['nota'];
//                                                $porcentajetallers[] = $listaalumnos[$i]["listanotas"][$z]["porcentaje"];
//                                                $html[$pag] .= '<td bgcolor="#B2B0AF">' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
//                                                $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
//                                                $r++;
//
//
//                                            } else {
//                                                $promedios += $listaalumnos[$i]['listanotas'][$z]['nota'];
//                                                $contadorpromedios += 1;
//                                                $html[$pag] .= '<td>' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
//                                                $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
//                                                $r++;
//
//
//                                            }


                                        }


                                    }
                                }


                                //Promedios por notas

                                if ($contador == $row) {


                                    if ($contadorpromedio != 0 && $promedio != 0) {
                                        $promedioaux = 0;
                                        //SI el Taller es por porcentaje
                                        if ($contadorauxtaller) {
                                            $totalporcentaje = 100;
                                            if (count($promtalleraux) > 1) {
                                                for ($t = 0; $t < count($promtalleraux); $t++) {
                                                    $totalporcentaje = $totalporcentaje - $porcentajetaller[$t];
                                                    $sumataller += $promtalleraux[$t] * ($porcentajetaller[$t] / 100);
                                                }

                                            } else {
                                                $totalporcentaje = 100 - $porcentajetaller[0];
                                                $sumataller = $promtalleraux[0] * ($porcentajetaller[0] / 100);

                                            }


                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioaux = round($promedio / $contadorpromedio);
                                                $promedioaux = ($promedioaux * ($totalporcentaje / 100)) + $sumataller;
                                                $promedioaux = round($promedioaux);
                                                $notamatriz[$r][] = $promedioaux;

                                            } else {
                                                $promedioaux = round($promedio / $contadorpromedio);
                                                $promedioaux = ($promedioaux * ($totalporcentaje / 100)) + $sumataller;
                                                $promedioaux = intval($promedioaux);
                                                $notamatriz[$r][] = $promedioaux;
                                            }

                                        } else {

                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioaux = round($promedio / $contadorpromedio);
                                                $promfinal[$i][] = $promedioaux;
                                                $notamatriz[$r][] = $promedioaux;

                                            } else {
                                                $promedioaux = intval($promedio / $contadorpromedio);
                                                $promfinal[$i][] = $promedioaux;
                                                $notamatriz[$r][] = $promedioaux;
                                            }

                                        }
                                        $r++;


                                        $html[$pag] .= '<td>' . $promedioaux . '</td>';


                                    } else {
                                        $promedioaux = 0;
                                        $promfinal[$i][] = 0;
                                        $notamatriz[$r][] = 0;
                                        $html[$pag] .= '<td>-</td>';
                                        $r++;


                                    }


                                    //Segundo Semestre
                                    if ($contadorpromedios != 0 && $promedios != 0) {
                                        $promedioauxs = 0;
                                        //SI el Taller es por porcentaje
                                        if ($contadorauxtallers) {
                                            $totalporcentajes = 100;
                                            if (count($promtallerauxs) > 1) {
                                                for ($t = 0; $t < count($promtallerauxs); $t++) {
                                                    $totalporcentajes = $totalporcentajes - $porcentajetallers[$t];
                                                    $sumatallers += $promtallerauxs[$t] * ($porcentajetallers[$t] / 100);
                                                }

                                            } else {
                                                $totalporcentajes = 100 - $porcentajetallers[0];
                                                $sumatallers = $promtallerauxs[0] * ($porcentajetallers[0] / 100);

                                            }


                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioauxs = round($promedios / $contadorpromedios);
                                                $promedioauxs = ($promedioauxs * ($totalporcentajes / 100)) + $sumatallers;
                                                $promedioauxs = round($promedioauxs);
                                                $notamatriz[$r][] = $promedioauxs;

                                            } else {
                                                $promedioauxs = round($promedios / $contadorpromedios);
                                                $promedioauxs = ($promedioauxs * ($totalporcentajes / 100)) + $sumatallers;
                                                $promedioauxs = intval($promedioauxs);
                                                $notamatriz[$r][] = $promedioauxs;
                                            }

                                        } else {

                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioauxs = round($promedios / $contadorpromedios);
                                                $promfinal[$i][] = $promedioauxs;
                                                $notamatriz[$r][] = $promedioauxs;

                                            } else {
                                                $promedioauxs = intval($promedios / $contadorpromedios);
                                                $promfinal[$i][] = $promedioauxs;
                                                $notamatriz[$r][] = $promedioauxs;
                                            }
                                        }
                                        $r++;


                                        $html[$pag] .= '<td>' . $promedioauxs . '</td>';


                                    } else {
                                        $promedioauxs = 0;
                                        $promfinal[$i][] = 0;
                                        $notamatriz[$r][] = 0;
                                        $html[$pag] .= '<td>-</td>';
                                        $r++;


                                    }


                                    //Promedio Final De Asignatura
                                    $finalasignatura = 0;

                                    if ($promedioaux != 0 && $promedioauxs != 0) {

                                        if ($datoscurso[0]['aproxAnual'] == 1) {
                                            $finalasignatura = round(($promedioaux + $promedioauxs) / 2);
                                            if ($finalasignatura == 39 && $datoscurso[0]['rbd'] == '1864') {
                                                $finalasignatura = 40;
                                            }
                                        } else {
                                            $finalasignatura = intval(($promedioaux + $promedioauxs) / 2);
                                            if ($finalasignatura == 39 && $datoscurso[0]['rbd'] == '1864') {
                                                $finalasignatura = 40;
                                            }

                                        }
                                        if ($agregadecimas) {
                                            if ($finalasignatura >= 60) {
                                                $finalasignatura += 2;
                                                if ($finalasignatura > 70) {
                                                    $finalasignatura = 70;

                                                }

                                            }
                                        }


                                    }

                                    if ($promedioaux == 0 && $promedioauxs == 0) {
                                        //$html[$pag] .= '<td>-</td>';
                                        $finalasignatura = 0;


                                    }

                                    if ($promedioaux == 0 && $promedioauxs != 0) {

                                        $finalasignatura = $promedioauxs;

                                        if ($agregadecimas) {
                                            if ($finalasignatura >= 60) {
                                                $finalasignatura += 2;
                                                if ($finalasignatura > 70) {
                                                    $finalasignatura = 70;

                                                }

                                            }
                                        }


                                    }
                                    if ($promedioaux != 0 && $promedioauxs == 0) {
                                        $finalasignatura = $promedioaux;
                                        if ($agregadecimas) {
                                            if ($finalasignatura >= 60) {
                                                $finalasignatura += 2;
                                                if ($finalasignatura > 70) {
                                                    $finalasignatura = 70;

                                                }

                                            }
                                        }


                                    }


                                    //Inicio Examen

                                    if (count($datosexamenes[$j]) > 0) {
                                        //$promediototal[$i][] = $finalasignatura;
                                        $html[$pag] .= '<td>' . $finalasignatura . '</td>';
                                        $notamatriz[$r][] = $finalasignatura;
                                        $r++;

                                        $datosalumnosexamen = $modelnotas->getnotasexamenalumno($datosexamenes[$j][0]['idEvaluacion'], $id, $datosasignaturas[$j]['idAsignatura'], $idperiodo, 6, $listaalumnos[$i]['idAlumnos']);


                                        if (count($datosalumnosexamen) > 0) {


                                            if ($datosalumnosexamen[0]['nota'] > 0) {
                                                $html[$pag] .= '<td>' . $datosalumnosexamen[0]['nota'] . '</td>';
                                                $notamatriz[$r][] = $datosalumnosexamen[0]['nota'];
                                                $r++;

                                                $totalex = 100 - $datosexamenes[$j][0]['porcentajeExamen'];

                                                //nota d examen

                                                $sumaex = $datosalumnosexamen[0]['nota'] * ($datosexamenes[$i][0]['porcentajeExamen'] / 100);

                                                if ($datoscurso[0]['aproxExamen'] == 1) {
                                                    $finalasignatura = round(($finalasignatura * ($totalex / 100)) + $sumaex);
                                                } else {
                                                    $finalasignatura = intval(($finalasignatura * ($totalex / 100)) + $sumaex);
                                                }


                                            } else {
                                                $html[$pag] .= '<td>-</td>';
                                                $notamatriz[$r][] = $datosalumnosexamen[0]['nota'];
                                                $r++;
                                                $finalasignatura = $finalasignatura;
                                            }

                                        } else {
                                            $html[$pag] .= '<td>-</td>';
                                            $notamatriz[$r][] = 0;
                                            $r++;
                                        }
                                        //Promedio FInal
                                        $promediototal[$i][] = $finalasignatura;
                                        $html[$pag] .= '<td>' . $finalasignatura . '</td>';
                                        $notamatriz[$r][] = $finalasignatura;
                                        $r++;
                                    } else {
                                        $promediototal[$i][] = $finalasignatura;
                                        $html[$pag] .= '<td>' . $finalasignatura . '</td>';
                                        $notamatriz[$r][] = $finalasignatura;
                                        $r++;
                                    }


                                }// fin promedio por notas

                            }

                        }// fin for


                    } else {
                        $html[$pag] .= '<td>-</td>';
                        $notamatriz[$r][] = 0;
                        $r++;


                    } //fin if row


                } //fin for Asignaturas


                if ($promediototal[$i] != '' || $promediototal[$i] != null) {

                    if ($datoscurso[0]['aproxFinal'] == 1) {//Aproxima
                        $promediototal[$i] = array_diff($promediototal[$i], array('0'));
                        $promediofinal = round(array_sum($promediototal[$i]) / count($promediototal[$i]));
                        //$promediofinal = array_sum($promediototal[$i]) / count($promediototal[$i]);


                    } else {
                        $promediototal[$i] = array_diff($promediototal[$i], array('0'));
                        $promediofinal = intval(array_sum($promediototal[$i]) / count($promediototal[$i]));
                        //$promediofinal = array_sum($promediototal[$i]) / count($promediototal[$i]);


                    }


                    $html[$pag] .= '<td>' . $promediofinal . '</td>';
                    $notamatriz[$r][] = $promediofinal;

                } else {
                    $html[$pag] .= '<td>-</td>';
                    $notamatriz[$r][] = 0;
                }

                $detallealumnoprimer = $modeldetalle->listardetalleperiodo($listaalumnos[$i]['idAlumnosActual'], 1, $idperiodo);
                $detallealumnosegundo = $modeldetalle->listardetalleperiodo($listaalumnos[$i]['idAlumnosActual'], 2, $idperiodo);

                $diasin = $detallealumnoprimer[0]['diasInasistencia'] + $detallealumnosegundo[0]['diasInasistencia'];
                $diastrabajados = $detallealumnoprimer[0]['diasTrabajado'] + $detallealumnosegundo[0]['diasTrabajado'];
                if ($diasin != 0 && $diastrabajados > 0) {
                    $valor = $diasin / $diastrabajados;
                    $aux = 1 - $valor;
                    $totald = $aux * 100;
                } elseif (($diasin == 0 || $diasin == '') && $diastrabajados > 0) {
                    $valor = $diasin / $diastrabajados;
                    $aux = 1 - $valor;
                    $totald = $aux * 100;
                } else {
                    $totald = 0;
                    $diastrabajados = "-";
                    $diasin = "-";
                }

                $html[$pag] .= '<td>' . $diastrabajados . '</td><td>' . $diasin . '</td><td>' . intval($totald) . '%</td>';


                $html[$pag] .= '</tr>';


            }

            $largoes = count($cuentapag2);

            //Estadistica de notas
            for ($i = 0; $i < count($cuentapag2); $i++) {
                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $largocuenta = $cuentapag2[$i - 1] + $cuentapag2[$i];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Promedio Generales</td>';
                } else {
                    $aux = 0;
                    $largocuenta = $cuentapag2[$i];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Promedio Generales</td>';
                }


                for ($y = $aux; $y < $largocuenta; $y++) {
                    $notamatrizset = array_diff($notamatriz[$y], array('0'));
                    if (array_sum($notamatrizset) != 0) {
                        $html[$i] .= '<td>' . round(array_sum($notamatrizset) / count($notamatrizset)) . '</td>';
                    } else {
                        $html[$i] .= '<td>-</td>';
                    }


                }
                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';


                //Minimos
                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Mínimo</td>';
                } else {
                    $aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Mínimo</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {

                    $valormin = array_sum($notamatriz[$y]);
                    if ($valormin != 0) {
                        $html[$i] .= '<td>' . min(array_diff($notamatriz[$y], array(0))) . '</td>';
                    } else {
                        $html[$i] .= '<td>-</td>';
                    }


                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';

                //Maximos
                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Máximo</td>';
                } else {
                    $aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Máximo</td>';
                }


                for ($y = $aux; $y < $largocuenta; $y++) {
                    $valormax = array_sum($notamatriz[$y]);
                    if ($valormax != 0) {
                        $html[$i] .= '<td>' . max(array_diff($notamatriz[$y], array(0))) . '</td>';
                    } else {
                        $html[$i] .= '<td>-</td>';
                    }
                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';

                //Adecuado

                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Adecuado</td>';
                } else {
                    $aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Adecuado</td>';
                }


                for ($y = $aux; $y < $largocuenta; $y++) {
                    $contadorinicial = 0;
                    $largomatriz = count($notamatriz[$y]);
                    for ($v = 0; $v < $largomatriz; $v++) {
                        if ($notamatriz[$y][$v] > 59 && $notamatriz[$y][$v] <= 70) {
                            $contadorinicial = $contadorinicial + 1;

                        }
                    }
                    $totaladecuado[$y] = $contadorinicial;

                    $html[$i] .= '<td>' . $contadorinicial . '</td>';

                }
                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';

                //Elemntal
                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Elemental</td>';
                } else {
                    $aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Elemental</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {
                    $contadorinicial = 0;
                    $largomatriz = count($notamatriz[$y]);
                    for ($v = 0; $v < $largomatriz; $v++) {
                        if ($notamatriz[$y][$v] > 39 && $notamatriz[$y][$v] < 60) {
                            $contadorinicial = $contadorinicial + 1;

                        }
                    }

                    $totalelemental[$y] = $contadorinicial;
                    $html[$i] .= '<td>' . $contadorinicial . '</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';


                //Insuficiente
                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Insuficiente</td>';
                } else {
                    $aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Insuficiente</td>';
                }


                for ($y = $aux; $y < $largocuenta; $y++) {
                    $contadorinicial = 0;
                    $largomatriz = count($notamatriz[$y]);
                    for ($v = 0; $v < $largomatriz; $v++) {
                        if ($notamatriz[$y][$v] > 10 && $notamatriz[$y][$v] < 40) {
                            $contadorinicial = $contadorinicial + 1;

                        }
                    }

                    $totalinsuficiente[$y] = $contadorinicial;

                    $html[$i] .= '<td>' . $contadorinicial . '</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';


                //Totales
                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Total</td>';
                } else {
                    $aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Total</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {
                    $total[$y] = ($totaladecuado[$y] + $totalelemental[$y] + $totalinsuficiente[$y]);

                    $html[$i] .= '<td>' . $total[$y] . '</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';


                //Porcentaje Adecuado

                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Adecuado</td>';
                } else {
                    $aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Adecuado</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {

                    if ($total[$y] > 0) {
                        $porcentaje = ($totaladecuado[$y] / $total[$y]) * 100;
                    } else {
                        $porcentaje = 0;
                    }

                    $html[$i] .= '<td>' . round($porcentaje) . '%</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';

                //Porcentaje Elemental
                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Elemental</td>';
                } else {
                    $aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Elemental</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {

                    if ($total[$y] > 0) {
                        $porcentaje = ($totalelemental[$y] / $total[$y]) * 100;
                    } else {
                        $porcentaje = 0;
                    }

                    $html[$i] .= '<td>' . round($porcentaje) . '%</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';

                //Porcentaje Suficiente

                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Insuficiente</td>';
                } else {
                    $aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Insuficiente</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {

                    if ($total[$y] > 0) {
                        $porcentaje = ($totalinsuficiente[$y] / $total[$y]) * 100;
                    } else {
                        $porcentaje = 0;
                    }

                    $html[$i] .= '<td>' . round($porcentaje) . '%</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';


            }//Fin ciclo Paginas


        }


        if ($html != '') {

            require 'fpdf/html2pdf.class.php';
            try {
                $width_in_mm = 216;
                $height_in_mm = 330;
                $pdf = new HTML2PDF('L', array($width_in_mm, $height_in_mm), 'es', true, 'UTF-8', array(0, 0, 0, 0) /*márgenes*/); //los márgenes también pueden definirse en <page> ver documentación
                $pdf->pdf->SetDisplayMode('fullpage');
                for ($i = 0; $i < count($html); $i++) {

                    $pdf->WriteHTML('<page><html>
                        <head>
                            <style>' . $style . '</style>
                        </head>
                        <body>' . $html[$i] . '</table></body></html></page>');
                }

                if (preg_match("/MSIE/i", $_SERVER["HTTP_USER_AGENT"])) {
                    header("Content-type: application/PDF");
                } else {
                    header("Content-type: application/PDF");
                    header("Content-Type: application/pdf");
                }

                $pdf->Output('Planificacion.pdf', I);
            } catch (HTML2PDF_exception $e) {
                //echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, intente nuevamente\");</script>";
                //echo "<script>parent.$.fancybox.close();</script>";
                echo $e;
            }
        }


    }

    public function dialogopromedioAction()
    {
        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();
        $paso = false;
        $id = $this->_getParam('id', 0);
        $ids = $this->_getParam('ids', 0);
        //Dialogo si es Pdf o Excel

        echo "<link href='../../../../../css/kickstart.css' type='text/css' rel='stylesheet' /><div class='col_12 column'><form class='basic-grey center' method='post' action='dialogopromedio'><input class='button red large' type='submit' name='pdf' value='PDF'> <input type='hidden' name='id' value='" . $id . "' /><input type='hidden' name='ids' value='" . $ids . "' /><input class='button green large'  type='submit' name='exc' value='EXCEL'></form></div>";


        //si Vienen datos por post

        if ($this->getRequest()->isPost()) {
            $idtipoev = new Zend_Session_Namespace('tipoevaluacion');
            $idtevalucacion = $idtipoev->tipoevaluacion;
            $base_url = 'Informes/informenotascursopromedio/id/';

            $id = $_POST["id"];
            $ids = $_POST["ids"];


            if (empty($_POST['pdf']) && !empty($_POST['exc'])) {

                $paso = false;

            } else {
                $paso = true;
            }

            if ($idtevalucacion == 2) {
                $base_url = 'Informes/informenotascursopromediot/id/';
            }

            if ($ids) {
                $this->redirect($base_url . '' . $id . '/p/' . $paso . '/ids/' . $ids);
            } else {
                $this->redirect($base_url . '' . $id . '/p/' . $paso);
            }


        }
    }


    public function informenotascursopromedioAction()
    {

        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();

        $ingreson = new Zend_Session_Namespace('ingresonota');
        $ingresonota = $ingreson->ingresonota;

        $cargo = new Zend_Session_Namespace('cargo');
        $rol = $cargo->cargo;

        $paso = $this->_getParam('p', 0);
        $agregadecimas = false;


        $seg = $this->_getParam('s', 0);


        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $modelcurso = new Application_Model_DbTable_Cursos();
        $modelnotas = new Application_Model_DbTable_Notas();
        $modelasignatura = new Application_Model_DbTable_Asignaturascursos();
        $modeldetalle = new Application_Model_DbTable_AlumnosDetalle();


        //fecha actual

        $date = new DateTime;
        $fechain = $date->format('Y-m-d');
        $cortado = explode("-", $fechain);
        $dias = array("Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado");
        $meses = array("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre");

        $fecha_final = $dias[date('w', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]))] . " " . $cortado[2] . " de " . $meses[date('n', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0])) - 1] . " del " . date('Y', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]));


        if ($ingresonota == 1) {
            $id = $this->_getParam('id', 0);
            $listaalumnos = $modelnotas->listaralumnoscurso($id, $idperiodo);
            $listanotas = $modelnotas->listarnotascursoperiodo($id, $idperiodo, array('1'));
            $datosasignaturas = $modelasignatura->listarporcurso($id, 1, array('1', '3'), $idperiodo);

            //Datos Asignatura Combinadas
            $datosasignaturascombinada = $modelasignatura->getcombinada($id, $idperiodo);
            $largoalumnos = count($listaalumnos);
            $largocombinada = count($datosasignaturascombinada);
            $m = 0;


            //Talleres para Alumnos Separados Primer Semestre
            $datostallersem = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(1));
            $datostallersemseg = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(2));
            $datostalleranual = $modelasignatura->gettalleranual($id, $idperiodo, array(1), 1);
            $datostaller = array_merge($datostallersem, $datostallersemseg, $datostalleranual);
            $largotaller = count($datostaller);

            $modelotallerdetalle = new Application_Model_DbTable_Asignaturascursos();
            //Obtiene los Talleres que son Semestrales Tiempo=2.
            $datostalleres = $modelasignatura->gettaller($id, $idperiodo, array(2), 2, array(1, 2));

            $datoscurso = $modelcurso->listarcursoid($id, $idperiodo);
            //Configuracion de agregar 2 decimas a curso desde 5 a 4to medio cuando el promedio final de asignatura es mayor o igual a 6
            if (($datoscurso[0]['rbd'] == 1863) && (($datoscurso[0]['idCodigo'] == 110 && $datoscurso[0]['idGrado'] > 4) || $datoscurso[0]['idCodigo'] == 310 || $datoscurso[0]['idCodigo'] == 363 || $datoscurso[0]['idCodigo'] == 410 || $datoscurso[0]['idCodigo'] == 510 || $datoscurso[0]['idCodigo'] == 610 || $datoscurso[0]['idCodigo'] == 165)) {
                $agregadecimas = true;
            }

        } else { // se ingresan por asigntaura
            $usuario = new Zend_Session_Namespace('id');
            $user = $usuario->id;
            $idcursoaux = $this->_getParam('id', 0);

            //Validamos si el curso pertece a la jefatura del usuario
            $auxiliar = $modelcurso->listarcursoiddocenteactuals($user, $idperiodo, 1, $idcursoaux);

            if ($auxiliar && ($auxiliar[0]['idCursos'] == $idcursoaux) || $rol != 2) {
                //Asignaturas que pertencen a un curso de jefatura del usuario
                $id = $this->_getParam('id', 0);
                $listaalumnos = $modelnotas->listaralumnoscurso($id, $idperiodo);
                $listanotas = $modelnotas->listarnotascursoperiodo($id, $idperiodo, array('1'));
                $datosasignaturas = $modelasignatura->listarporcurso($id, 1, array('1', '3'), $idperiodo);

                //Datos Asignatura Combinadas
                $datosasignaturascombinada = $modelasignatura->getcombinada($id, $idperiodo);
                $largoalumnos = count($listaalumnos);
                $largocombinada = count($datosasignaturascombinada);
                $m = 0;


                //Talleres para Alumnos Separados Primer Semestre
                $datostallersem = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(1));
                $datostallersemseg = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(2));
                $datostalleranual = $modelasignatura->gettalleranual($id, $idperiodo, array(1), 1);
                $datostaller = array_merge($datostallersem, $datostallersemseg, $datostalleranual);
                $largotaller = count($datostaller);

                $modelotallerdetalle = new Application_Model_DbTable_Asignaturascursos();
                //Obtiene los Talleres que son Semestrales Tiempo=2.
                $datostalleres = $modelasignatura->gettaller($id, $idperiodo, array(2), 2, array(1, 2));

                $datoscurso = $modelcurso->listarcursoid($id, $idperiodo);
                //Configuracion de agregar 2 decimas a curso desde 5 a 4to medio cuando el promedio final de asignatura es mayor o igual a 6
                if (($datoscurso[0]['rbd'] == 1863) && (($datoscurso[0]['idCodigo'] == 110 && $datoscurso[0]['idGrado'] > 4) || $datoscurso[0]['idCodigo'] == 310 || $datoscurso[0]['idCodigo'] == 363 || $datoscurso[0]['idCodigo'] == 410 || $datoscurso[0]['idCodigo'] == 510 || $datoscurso[0]['idCodigo'] == 610 || $datoscurso[0]['idCodigo'] == 165)) {
                    $agregadecimas = true;
                }
            } else {
                //Asignaturas que pertencen a un curso que no es jefatura
                $cursomodel = new Application_Model_DbTable_Detallecursocuenta();
                $id = $this->_getParam('ids', 0);
                $ids = $this->_getParam('id', 0);

                $rowcurso = $cursomodel->listarcursoasignatura($ids);
                $listaasigatura = unserialize($rowcurso[0]['asignaturasLista']);
                $datosasignaturas = $modelasignatura->getasignaturasarray($listaasigatura);

                $listaalumnos = $modelnotas->listaralumnoscurso($id, $idperiodo);
                $listanotas = $modelnotas->listarnotascursoperiodo($id, $idperiodo, array('1'));
                //$datosasignaturas = $modelasignatura->listarporcurso($id, 1, array('1', '3'), $idperiodo);

                //Datos Asignatura Combinadas
                $datosasignaturascombinada = $modelasignatura->getcombinada($id, $idperiodo);
                $largoalumnos = count($listaalumnos);
                $largocombinada = count($datosasignaturascombinada);
                $m = 0;


                //Talleres para Alumnos Separados Primer Semestre
                $datostallersem = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(1));
                $datostallersemseg = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(2));
                $datostalleranual = $modelasignatura->gettalleranual($id, $idperiodo, array(1), 1);
                $datostaller = array_merge($datostallersem, $datostallersemseg, $datostalleranual);
                $largotaller = count($datostaller);

                $modelotallerdetalle = new Application_Model_DbTable_Asignaturascursos();
                //Obtiene los Talleres que son Semestrales Tiempo=2.
                $datostalleres = $modelasignatura->gettaller($id, $idperiodo, array(2), 2, array(1, 2));

                $datoscurso = $modelcurso->listarcursoid($id, $idperiodo);
                //Configuracion de agregar 2 decimas a curso desde 5 a 4to medio cuando el promedio final de asignatura es mayor o igual a 6
                if (($datoscurso[0]['rbd'] == 1863) && (($datoscurso[0]['idCodigo'] == 110 && $datoscurso[0]['idGrado'] > 4) || $datoscurso[0]['idCodigo'] == 310 || $datoscurso[0]['idCodigo'] == 363 || $datoscurso[0]['idCodigo'] == 410 || $datoscurso[0]['idCodigo'] == 510 || $datoscurso[0]['idCodigo'] == 610 || $datoscurso[0]['idCodigo'] == 165)) {
                    $agregadecimas = true;
                }
            }

        }

//        $this->_helper->viewRenderer->setNeverRender(true);
//        $this->_helper->ViewRenderer->setNoRender(true);
//        $this->_helper->Layout->disableLayout();
//
//        $id = $this->_getParam('id', 0);
//        $paso = $this->_getParam('p', 0);
//        $agregadecimas = false;
//
//        $periodo = new Zend_Session_Namespace('periodo');
//        $idperiodo = $periodo->periodo;
//
//        $modelcurso = new Application_Model_DbTable_Cursos();
//        $modelnotas = new Application_Model_DbTable_Notas();
//        $modelasignatura = new Application_Model_DbTable_Asignaturascursos();
//        $modeldetalle = new Application_Model_DbTable_AlumnosDetalle();
//
//
//        $datoscurso = $modelcurso->listarcursoid($id, $idperiodo);
//        //Configuracion de agregar 2 decimas a curso desde 5 a 4to medio cuando el promedio final de asignatura es mayor o igual a 6
//        if (($datoscurso[0]['rbd'] == 1863 || $datoscurso[0]['rbd'] == 1864) && (($datoscurso[0]['idCodigo'] == 110 && $datoscurso[0]['idGrado'] > 4) || $datoscurso[0]['idCodigo'] == 310 || $datoscurso[0]['idCodigo'] == 363 || $datoscurso[0]['idCodigo'] == 410 || $datoscurso[0]['idCodigo'] == 510 || $datoscurso[0]['idCodigo'] == 610 || $datoscurso[0]['idCodigo'] == 165)) {
//            $agregadecimas = true;
//        }
//
//        //fecha actual
//
//        $date = new DateTime;
//        $fechain = $date->format('Y-m-d');
//        $cortado = explode("-", $fechain);
//        $dias = array("Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado");
//        $meses = array("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre");
//
//        $fecha_final = $dias[date('w', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]))] . " " . $cortado[2] . " de " . $meses[date('n', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0])) - 1] . " del " . date('Y', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]));
//
//
//        $listaalumnos = $modelnotas->listaralumnoscurso($id, $idperiodo);
//        $listanotas = $modelnotas->listarnotascursoperiodo($id, $idperiodo, 1);
//        $datosasignaturas = $modelasignatura->listarporcurso($id, 1, array('1', '3'), $idperiodo);
//
//        //Datos Asignatura Combinadas
//        $datosasignaturascombinada = $modelasignatura->getcombinada($id, $idperiodo);
//        $largoalumnos = count($listaalumnos);
//        $largocombinada = count($datosasignaturascombinada);
//        $m = 0;
//
//
//        //Talleres para Alumnos Separados Primer Semestre
//        $datostallersem = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(1));
//        $datostallersemseg = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(2));
//        $datostalleranual = $modelasignatura->gettalleranual($id, $idperiodo, array(1), 1);
//        $datostaller = array_merge($datostallersem, $datostallersemseg, $datostalleranual);
//        $largotaller = count($datostaller);


        //Configuracion de Taller Buscamos si existen configuraciones por alumnos


        $promediotalleralumnos = array();
        $promediotalleralumnoss = array();
        if ($datostalleres) {
            for ($j = 0; $j < $largoalumnos; $j++) {
                for ($i = 0; $i < count($datostalleres); $i++) {
                    $detalletaller = $modelotallerdetalle->gettallersegmento($datostalleres[$i]['idConfiguracionTaller'], 1, $listaalumnos[$j]['idAlumnos']);
                    $detalletallers = $modelotallerdetalle->gettallersegmento($datostalleres[$i]['idConfiguracionTaller'], 2, $listaalumnos[$j]['idAlumnos']);


                    //Primer Semestre
                    if ($datostalleres[$i]['tiempoOpcion'] == 1) {
                        if ($detalletaller) {
                            $datosalumnostaller = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 1, $id, $detalletaller[0]['idAsignatura']);

                            if ($datosalumnostaller) {
                                for ($k = 0; $k < count($datosalumnostaller); $k++) {

                                    if ($datostalleres[$i]['idAsignatura'] == $datosalumnostaller[$k]['idAsignatura']) {
                                        if ($datosalumnostaller[$k]['coef'] == 2) {
                                            if ($datosalumnostaller[$k]['nota'] > 0) {
                                                $promediotalleralumnos[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                                $promediotalleralumnos[$j][$i][] = $datosalumnostaller[$k]['nota'];

                                            } else {
                                                $promediotalleralumnos[$j][$i][] = 0;
                                                $promediotalleralumnos[$j][$i][] = 0;
                                            }

                                        } else {
                                            if ($datosalumnostaller[$k]['nota'] > 0) {
                                                $promediotalleralumnos[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                            } else {
                                                $promediotalleralumnos[$j][$i][] = 0;
                                            }

                                        }


                                    }


                                }
                            }
                            if (!empty($promediotalleralumnos[$j][$i])) {
                                $promsetalumnos = array_diff($promediotalleralumnos[$j][$i], array('0'));
                            } else {
                                $promsetalumnos = 0;
                            }

                            if (is_array($promsetalumnos)) {
                                if (count($promsetalumnos) > 0) {

                                    if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                        $promtalleralumnos[$j][$i]['nota'] = round(array_sum($promsetalumnos) / count($promsetalumnos));

                                    } else {
                                        $promtalleralumnos[$j][$i]['nota'] = intval(array_sum($promsetalumnos) / count($promsetalumnos));
                                    }
                                } else {
                                    $promtalleralumnos[$j][$i]['nota'] = 0;
                                }
                            } else {
                                $promtalleralumnos[$j][$i]['nota'] = 0;
                            }


                            $promtalleralumnos[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                            $promtalleralumnos[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                            $promtalleralumnos[$j][$i]['coef'] = 1;
                            $promtalleralumnos[$j][$i]['tiempo'] = 1;
                            $promtalleralumnos[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                            $promtalleralumnos[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];

                        } else {
                            $promtalleralumnoss[$j][$i]['nota'] = 0;
                            $promtalleralumnos[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                            $promtalleralumnos[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                            $promtalleralumnos[$j][$i]['coef'] = 1;
                            $promtalleralumnos[$j][$i]['tiempo'] = 1;
                            $promtalleralumnos[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                            $promtalleralumnos[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];
                        }
                    } else {
                        $promtalleralumnos[$j][$i] = array();
                    }

                    //Segundo Semestre
                    if ($datostalleres[$i]['tiempoOpcion'] == 2) {
                        if ($detalletallers) {
                            $datosalumnostallers = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 2, $id, $detalletallers[0]['idAsignatura']);

                            if ($datosalumnostallers) {
                                for ($k = 0; $k < count($datosalumnostallers); $k++) {

                                    if ($datostalleres[$i]['idAsignatura'] == $datosalumnostallers[$k]['idAsignatura']) {

                                        if ($datosalumnostallers[$k]['coef'] == 2) {
                                            if ($datosalumnostallers[$k]['nota'] > 0) {
                                                $promediotalleralumnoss[$j][$i][] = $datosalumnostallers[$k]['nota'];
                                                $promediotalleralumnoss[$j][$i][] = $datosalumnostallers[$k]['nota'];

                                            } else {
                                                $promediotalleralumnoss[$j][$i][] = 0;
                                                $promediotalleralumnoss[$j][$i][] = 0;
                                            }

                                        } else {
                                            if ($datosalumnostallers[$k]['nota'] > 0) {
                                                $promediotalleralumnoss[$j][$i][] = $datosalumnostallers[$k]['nota'];
                                            } else {
                                                $promediotalleralumnoss[$j][$i][] = 0;
                                            }

                                        }


                                    }


                                }
                            }
                            if (!empty($promediotalleralumnoss[$j][$i])) {
                                $promsetalumnoss = array_diff($promediotalleralumnoss[$j][$i], array('0'));
                            } else {
                                $promsetalumnoss = 0;
                            }

                            if (is_array($promsetalumnoss)) {
                                if (count($promsetalumnoss) > 0) {

                                    if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                        $promtalleralumnoss[$j][$i]['nota'] = round(array_sum($promsetalumnoss) / count($promsetalumnoss));
                                        $promtalleralumnoss[$j][$i]['nota'] = intval($promtalleralumnoss[$j][$i]['nota']);

                                    } else {
                                        $promtalleralumnoss[$j][$i]['nota'] = intval(array_sum($promsetalumnoss) / count($promsetalumnoss));
                                    }
                                } else {
                                    $promtalleralumnoss[$j][$i]['nota'] = 0;
                                }
                            } else {
                                $promtalleralumnoss[$j][$i]['nota'] = 0;
                            }


                            $promtalleralumnoss[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                            $promtalleralumnoss[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                            $promtalleralumnoss[$j][$i]['coef'] = 1;
                            $promtalleralumnoss[$j][$i]['tiempo'] = 2;
                            $promtalleralumnoss[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                            $promtalleralumnoss[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];

                        } else {
                            $promtalleralumnoss[$j][$i]['nota'] = 0;
                            $promtalleralumnoss[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                            $promtalleralumnoss[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                            $promtalleralumnoss[$j][$i]['coef'] = 1;
                            $promtalleralumnoss[$j][$i]['tiempo'] = 2;
                            $promtalleralumnoss[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                            $promtalleralumnoss[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];
                        }
                    } else {
                        $promtalleralumnoss[$j][$i] = array();
                    }


                }//Fin if talleres


                for ($l = 0; $l < count($promtalleralumnos[$j]); $l++) {
                    if (!empty($promtalleralumnos[$j][$l]["idAsignatura"])) {
                        $datosdestino = $modelotallerdetalle->getdestino($promtalleralumnos[$j][$l]["idAsignatura"]);
                        if ($datosdestino[0]['tipoAsignatura'] != 4) {
                            $listapromediostaller[$j][] = $promtalleralumnos[$j][$l];
                        } else {
                            $listapromediostallercom[$j][$promtalleralumnos[$j][$l]['idAsignatura']] = $promtalleralumnos[$j][$l];

                        }
                    }

                }


                for ($l = 0; $l < count($promtalleralumnoss[$j]); $l++) {
                    if (!empty($promtalleralumnoss[$j][$l]["idAsignatura"])) {
                        $datosdestino = $modelotallerdetalle->getdestino($promtalleralumnoss[$j][$l]["idAsignatura"]);
                        if ($datosdestino[0]['tipoAsignatura'] != 4) {
                            $listapromediostallers[$j][] = $promtalleralumnoss[$j][$l];
                        } else {
                            $listapromediostallercoms[$j][$promtalleralumnoss[$j][$l]['idAsignatura']] = $promtalleralumnoss[$j][$l];

                        }
                    }

                }


            }//Fin for Alumnos


        }


        //Fin Talleres

        //Asignaturas Combinadas


        $datosasignaturascombinada = $modelasignatura->getcombinada($id, $idperiodo);


        $largoalumnos = count($listaalumnos);
        $largotaller = count($datostaller);
        $largocombinada = count($datosasignaturascombinada);
        $m = 0;

        if ($largocombinada > 0) {
            $m = 0;
            for ($i = 0; $i < $largocombinada; $i++) {
                $listaasignatura[$i] = unserialize($datosasignaturascombinada[$i]['asignaturas']);

                for ($h = 0; $h < count($listaasignatura[$i]); $h++) {
                    $datocombinada = $modelasignatura->getnombre($listaasignatura[$i][$h]);

                    $validacom[$i][$m] = $datosasignaturascombinada[$i]['idAsignatura'];
                    $m++;
                    $validacom[$i][$m] = $datosasignaturascombinada[$i]['idAsignatura'];
                    //$m++;
                    for ($j = 0; $j < $largoalumnos; $j++) {
                        $datosalumnoscom = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 1, $id, $datocombinada[0]['idAsignatura']);
                        $datosalumnoscoms = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 2, $id, $datocombinada[0]['idAsignatura']);
                        //Primer Semestre
                        if ($listapromediostallercom) {
                            if ($datocombinada[0]['idAsignatura'] == $listapromediostallercom[$j][$datocombinada[0]['idAsignatura']]['idAsignatura']) {
                                $datosalumnoscom[] = $listapromediostallercom[$j][$datocombinada[0]['idAsignatura']];
                            }

                        }
                        //Segundo Semestre
                        if ($listapromediostallercoms) {
                            if ($datocombinada[0]['idAsignatura'] == $listapromediostallercoms[$j][$datocombinada[0]['idAsignatura']]['idAsignatura']) {
                                $datosalumnoscoms[] = $listapromediostallercoms[$j][$datocombinada[0]['idAsignatura']];
                            }

                        }


                        for ($k = 0; $k < count($datosalumnoscom); $k++) {
                            if ($datocombinada[0]['idAsignatura'] == $datosalumnoscom[$k]['idAsignatura']) {
                                if ($datosalumnoscom[$k]['coef'] == 2) {
                                    if ($datosalumnoscom[$k]['nota'] > 0) {
                                        $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];
                                        $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];

                                    } else {
                                        $promediocom[$j][$m][] = 0;
                                        $promediocom[$j][$m][] = 0;
                                    }

                                } else {

                                    if ($datosalumnoscom[$k]['nota'] == 0 || empty($datosalumnoscom[$k]['nota']) || $datosalumnoscom[$k]['nota'] == NULL || $datosalumnoscom[$k]['nota'] == '') {
                                        if (!empty($datosalumnoscom[$k]["forma"])) {
                                            if ($datosalumnoscom[$k]['nota'] == 0) {
                                                $promediocom[$j][$m][] = 0;
                                            }

                                        } else {
                                            $promediocom[$j][$m][] = 0;
                                        }


                                    } else {
                                        if (!empty($datosalumnoscom[$k]["forma"]) && $datosalumnoscom[$k]["forma"] == 2) {
                                            $promtalleraux = $datosalumnoscom[$k]['nota'];
                                            $porcentajetaller = $datosalumnoscom[$k]["porcentaje"];


                                        } elseif (!empty($datosalumnoscom[$k]["forma"]) && $datosalumnoscom[$k]["forma"] == 1) {
                                            $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];
                                            $promtalleraux = array();
                                            $porcentajetaller = array();
                                        } else {
                                            $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];
                                            $promtalleraux = array();
                                            $porcentajetaller = array();
                                        }


                                    }

                                }//fin else


                            }

                        }


                        for ($k = 0; $k < count($datosalumnoscoms); $k++) {
                            if ($datocombinada[0]['idAsignatura'] == $datosalumnoscoms[$k]['idAsignatura']) {
                                if ($datosalumnoscoms[$k]['coef'] == 2) {
                                    if ($datosalumnoscoms[$k]['nota'] > 0) {
                                        $promediocoms[$j][$m][] = $datosalumnoscoms[$k]['nota'];
                                        $promediocoms[$j][$m][] = $datosalumnoscoms[$k]['nota'];

                                    } else {
                                        $promediocoms[$j][$m][] = 0;
                                        $promediocoms[$j][$m][] = 0;
                                    }

                                } else {

                                    if ($datosalumnoscoms[$k]['nota'] == 0 || empty($datosalumnoscoms[$k]['nota']) || $datosalumnoscoms[$k]['nota'] == NULL || $datosalumnoscoms[$k]['nota'] == '') {
                                        if (!empty($datosalumnoscoms[$k]["forma"])) {
                                            if ($datosalumnoscoms[$k]['nota'] == 0) {
                                                $promediocoms[$j][$m][] = 0;
                                            }

                                        } else {
                                            $promediocoms[$j][$m][] = 0;
                                        }


                                    } else {
                                        if (!empty($datosalumnoscoms[$k]["forma"]) && $datosalumnoscoms[$k]["forma"] == 2) {
                                            $promtallerauxs = $datosalumnoscoms[$k]['nota'];
                                            $porcentajetallers = $datosalumnoscoms[$k]["porcentaje"];


                                        } elseif (!empty($datosalumnoscoms[$k]["forma"]) && $datosalumnoscoms[$k]["forma"] == 1) {
                                            $promediocoms[$j][$m][] = $datosalumnoscoms[$k]['nota'];
                                            $promtallerauxs = array();
                                            $porcentajetallers = array();
                                        } else {
                                            $promediocoms[$j][$m][] = $datosalumnoscoms[$k]['nota'];
                                            $promtallerauxs = array();
                                            $porcentajetallers = array();
                                        }


                                    }

                                }//fin else


                            }

                        }
                        //Primer Semestre Promedio
                        if (!empty($promediocom[$j][$m])) {
                            $promset = array_diff($promediocom[$j][$m], array('0'));
                        } else {
                            $promset = 0;
                        }

                        if (is_array($promset)) {
                            if (count($promset) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    if ($porcentajetaller) {
                                        $totalporcentaje = 100;
                                        $porcentajeasig = $totalporcentaje - $porcentajetaller;
                                        $promedioauxalum = array_sum($promset) / count($promset);
                                        //$promcom[$j][$m]['nota'] = round(array_sum($promset) / count($promset));
                                        $promcom[$j][$m]['nota'] = round(($promedioauxalum * ($porcentajeasig / 100)) + ($promtalleraux * ($porcentajetaller / 100)));

                                    } else {
                                        $promcom[$j][$m]['nota'] = round(array_sum($promset) / count($promset));
                                    }

                                } else {
                                    if ($porcentajetaller) {
                                        $totalporcentaje = 100;
                                        $porcentajeasig = $totalporcentaje - $porcentajetaller;
                                        $promedioauxalum = array_sum($promset) / count($promset);
                                        //$promcom[$j][$m]['nota'] = round(array_sum($promset) / count($promset));
                                        $promcom[$j][$m]['nota'] = round(($promedioauxalum * ($porcentajeasig / 100)) + ($promtalleraux * ($porcentajetaller / 100)));
                                        // $promcom[$j][$m]['nota'] = intval(($promedioauxalum * ($porcentajeasig / 100)) + ($promtalleraux * ($porcentajetaller / 100)));

                                    } else {
                                        $promcom[$j][$m]['nota'] = intval(array_sum($promset) / count($promset));
                                    }
                                }
                            } else {
                                $promcom[$j][$m]['nota'] = 0;
                            }

                        } else {

                            $promcom[$j][$m]['nota'] = 0;
                        }
                        $promcom[$j][$m]['idAsignatura'] = $datosasignaturascombinada[$i]['idAsignatura'];
                        $promcom[$j][$m]['coef'] = 1;
                        $promcom[$j][$m]['tiempo'] = 1;

                        //Segundo Semestre
                        if (!empty($promediocoms[$j][$m])) {
                            $promsets = array_diff($promediocoms[$j][$m], array('0'));
                        } else {
                            $promsets = 0;
                        }


                        if (is_array($promsets)) {
                            if (count($promsets) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    if ($porcentajetallers) {
                                        $totalporcentajes = 100;
                                        $porcentajeasigs = $totalporcentajes - $porcentajetallers;
                                        $promedioauxalums = array_sum($promsets) / count($promsets);
                                        $promcoms[$j][$m]['nota'] = round(($promedioauxalums * ($porcentajeasigs / 100)) + ($promtallerauxs * ($porcentajetallers / 100)));


                                    } else {
                                        $promcoms[$j][$m]['nota'] = round(array_sum($promsets) / count($promsets));

                                    }

                                } else {
                                    if ($porcentajetallers) {
                                        $totalporcentajes = 100;
                                        $porcentajeasigs = $totalporcentajes - $porcentajetallers;
                                        $promedioauxalums = array_sum($promsets) / count($promsets);
                                        $promcoms[$j][$m]['nota'] = round(($promedioauxalums * ($porcentajeasigs / 100)) + ($promtallerauxs * ($porcentajetallers / 100)));


                                    } else {
                                        $promcoms[$j][$m]['nota'] = intval(array_sum($promsets) / count($promsets));

                                    }
                                }
                            } else {
                                $promcoms[$j][$m]['nota'] = 0;
                            }

                        } else {


                            $promcoms[$j][$m]['nota'] = 0;
                        }
                        $promcoms[$j][$m]['idAsignatura'] = $datosasignaturascombinada[$i]['idAsignatura'];
                        $promcoms[$j][$m]['coef'] = 1;
                        $promcoms[$j][$m]['tiempo'] = 2;


                    }
                    $m++;
                }

            }
        }


        //Taller Por Segmento Curso Completo
        $datostallersem = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(1));
        $datostallersemseg = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(2));
        $largotallerprimero = count($datostallersem);
        $largotallersegundo = count($datostallersemseg);


        $promediotaller = array();
        if ($largotallerprimero > 0) {

            for ($i = 0; $i < $largotallerprimero; $i++) {
                if (!empty($datostallersem[$i]['idConfiguracionTaller'])) {
                    $validataller[$i] = $datostallersem[$i]['idAsignaturaTaller'];
                    for ($j = 0; $j < $largoalumnos; $j++) {
                        $promediofinal = 0;
                        $datosalumnostaller = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 1, $id, $datostallersem[$i]['idAsignatura']);


                        for ($k = 0; $k < count($datosalumnostaller); $k++) {
                            if ($datostaller[$i]['idAsignatura'] == $datosalumnostaller[$k]['idAsignatura']) {
                                if ($datosalumnostaller[$k]['coef'] == 2) {
                                    if ($datosalumnostaller[$k]['nota'] > 0) {
                                        $promediotaller[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                        $promediotaller[$j][$i][] = $datosalumnostaller[$k]['nota'];

                                    } else {
                                        $promediotaller[$j][$i][] = 0;
                                        $promediotaller[$j][$i][] = 0;
                                    }

                                } else {
                                    if ($datosalumnostaller[$k]['nota'] > 0) {
                                        $promediotaller[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                    } else {
                                        $promediotaller[$j][$i][] = 0;
                                    }

                                }


                            }

                        }


                        //Primer Semestre
                        if (!empty($promediotaller[$j][$i])) {
                            $promset = array_diff($promediotaller[$j][$i], array('0'));
                        } else {
                            $promset = 0;
                        }

                        if (is_array($promset)) {
                            if (count($promset) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    $promtaller[$j][$i]['nota'] = round(array_sum($promset) / count($promset));

                                } else {
                                    $promtaller[$j][$i]['nota'] = intval(array_sum($promset) / count($promset));
                                }
                            } else {
                                $promtaller[$j][$i]['nota'] = 0;
                            }

                        } else {
                            $promtaller[$j][$i]['nota'] = 0;
                        }


                        $promtaller[$j][$i]['idAsignatura'] = $datostallersem[$i]['idAsignaturaTaller'];
                        $promtaller[$j][$i]['coef'] = 1;
                        $promtaller[$j][$i]['tiempo'] = 1;
                        $promtaller[$j][$i]['forma'] = $datostallersem[$i]['forma'];
                        $promtaller[$j][$i]['porcentaje'] = $datostallersem[$i]['porcentaje'];


                    }

                }


            }
        }

        //Segundo Semestre
        if ($largotallersegundo > 0) {

            for ($i = 0; $i < $largotallersegundo; $i++) {
                if (!empty($datostallersemseg[$i]['idConfiguracionTaller'])) {
                    $validatallers[$i] = $datostallersemseg[$i]['idAsignaturaTaller'];
                    for ($j = 0; $j < $largoalumnos; $j++) {
                        $promediofinal = 0;
                        $datosalumnostallers = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 2, $id, $datostallersemseg[$i]['idAsignatura']);

                        for ($k = 0; $k < count($datosalumnostallers); $k++) {
                            if ($datostallersemseg[$i]['idAsignatura'] == $datosalumnostallers[$k]['idAsignatura']) {
                                if ($datosalumnostallers[$k]['coef'] == 2) {
                                    if ($datosalumnostallers[$k]['nota'] > 0) {
                                        $promediotallers[$j][$i][] = $datosalumnostallers[$k]['nota'];
                                        $promediotallers[$j][$i][] = $datosalumnostallers[$k]['nota'];

                                    } else {
                                        $promediotallers[$j][$i][] = 0;
                                        $promediotallers[$j][$i][] = 0;
                                    }

                                } else {
                                    if ($datosalumnostallers[$k]['nota'] > 0) {
                                        $promediotallers[$j][$i][] = $datosalumnostallers[$k]['nota'];
                                    } else {
                                        $promediotallers[$j][$i][] = 0;
                                    }

                                }


                            }


                        }
                        if (!empty($promediotallers[$j][$i])) {
                            $promsets = array_diff($promediotallers[$j][$i], array('0'));
                        } else {
                            $promsets = 0;
                        }

                        if (is_array($promsets)) {
                            if (count($promsets) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    $auxtallers = round(array_sum($promsets) / count($promsets));
                                    $promtallers[$j][$i]['nota'] = intval($auxtallers);

                                } else {
                                    $promtallers[$j][$i]['nota'] = intval(array_sum($promsets) / count($promsets));
                                }
                            } else {
                                $promtallers[$j][$i]['nota'] = 0;
                            }

                        } else {
                            $promtallers[$j][$i]['nota'] = 0;
                        }


                        $promtallers[$j][$i]['idAsignatura'] = $datostallersemseg[$i]['idAsignaturaTaller'];
                        $promtallers[$j][$i]['coef'] = 1;
                        $promtallers[$j][$i]['tiempo'] = 2;
                        $promtallers[$j][$i]['forma'] = $datostallersemseg[$i]['forma'];
                        $promtallers[$j][$i]['porcentaje'] = $datostallersemseg[$i]['porcentaje'];


                    }

                }


            }
        }


        if ($largoalumnos == 0) {
            echo "<script type=\"text/javascript\">alert(\"Sin Notas\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            exit;

        }


        for ($i = 0; $i < $largoalumnos; $i++) {

            $valores = $modelnotas->listarnotasporalumno($listaalumnos[$i]['idAlumnos'], $idperiodo, $id);
            if ($valores != '' || !empty($valores)) {
                $listaalumnos[$i]['listanotas'] = $valores;
            } else {
                $listaalumnos[$i]['listanotas'] = 0;

            }
            for ($j = 0; $j < count($promtaller[$i]); $j++) {
                $listaalumnos[$i]['listanotas'][] = $promtaller[$i][$j];
                //array_unshift($listaalumnos[$i]['listanotas'], $promtaller[$i][$j]);
            }


            foreach ($promcom[$i] as $a => $j) {
                $listaalumnos[$i]['listanotas'][] = $promcom[$i][$a];
            }
            //Segundo Semestre
            for ($j = 0; $j < count($promtallers[$i]); $j++) {
                $listaalumnos[$i]['listanotas'][] = $promtallers[$i][$j];
            }

            foreach ($promcoms[$i] as $a => $j) {
                $listaalumnos[$i]['listanotas'][] = $promcoms[$i][$a];
            }

            if ($listapromediostaller[$i]) {
                for ($j = 0; $j < count($listapromediostaller[$i]); $j++) {
                    $listaalumnos[$i]['listanotas'][] = $listapromediostaller[$i][$j];
                }
            }

            if ($listapromediostallers[$i]) {
                for ($j = 0; $j < count($listapromediostallers[$i]); $j++) {
                    $listaalumnos[$i]['listanotas'][] = $listapromediostallers[$i][$j];
                }
            }


        }


        $nombreseg = 'FINAL';
        $logo = getcwd();
        $logo .= "/application/documentos/logos/" . $datoscurso[0]['extension'];


        // variables para encabezado
        $titulo = strtoupper($datoscurso[0]['nombreEstablecimiento']) . '<br>' . strtoupper($nombreseg);

        if (file_exists($logo)) {
            $encabezado = '<img style="position:absolute;top:10px;left:30px;"  src="' . $logo . '" /><h4 style="position:absolute;top:50px;text-align:center">' . $titulo . '</h4>';

        } else {
            $encabezado = '<p style="position:absolute;top:10px;left: 30px"></p><h4 style="position:absolute;top:50px;text-align:center">' . $titulo . '</h4>';

        }

        //Agregamos cantidad de notas por alumno y la asignamos a cada aisgnatura


        if (!empty($datosasignaturas)) {
            $largoasignatura = count($datosasignaturas);
            for ($i = 0; $i < $largoasignatura; $i++) {

                $datoscuenta[$i] = $modelnotas->listarcantidadnotasanual($id, $idperiodo, $datosasignaturas[$i]['idAsignatura']);
                if (empty($datoscuenta[$i]) && $datosasignaturas[$i]['tipoAsignatura'] == 1) {
                    $datosasig[$i] = 0;
                } else {
                    $largonotas = count($datoscuenta[$i]);
                    $datosasig[$i] = 0;
                    //Primer Semestre
                    for ($j = 0; $j < count($validataller); $j++) {
                        if ($datosasignaturas[$i]['idAsignatura'] == $validataller[$j]) {
                            $datosasig[$i] += 1;
                        }
                    }
                    //Segundo Semestre

                    for ($j = 0; $j < count($validatallers); $j++) {
                        if ($datosasignaturas[$i]['idAsignatura'] == $validatallers[$j]) {
                            $datosasig[$i] += 1;
                        }
                    }
                    for ($j = 0; $j < count($validacom); $j++) {
//                        for ($k = 0; $k < count($validacom[$j]); $k++) {
//                            if ($datosasignaturas[$i]['idAsignatura'] == $validacom[$j][$k]) {
//
//                                $datosasig[$i] += 1;
//                            }
//                        }
                        foreach ($validacom[$j] as $a => $h) {
                            if ($datosasignaturas[$i]['idAsignatura'] == $validacom[$j][$a]) {
                                $datosasig[$i] += 1;
                            }
                        }

                    }

                    for ($j = 0; $j < count($datostalleres); $j++) {
                        if ($datosasignaturas[$i]['idAsignatura'] == $datostalleres[$j]['idAsignaturaTaller']) {
                            $datosasig[$i] += 1;
                        }
                    }

                    for ($j = 0; $j < $largonotas; $j++) {

                        if ($datoscuenta[$i][$j]['coef'] == 2) {
                            $datosasig[$i] += 2;
                        } else {
                            $datosasig[$i] += 1;
                        }

                    }


                }

                //Si la configuracion indica que se utiliza examen
                if ($datoscurso[0]['examen'] == 1) {
                    $modeloprueba = new Application_Model_DbTable_Pruebas();
                    //Veficiamos que las asignaturas posean examen
                    $datosexamenes[$i] = $modeloprueba->getexamen($id, $idperiodo, $datosasignaturas[$i]['idAsignatura'], 6);

                }


            }
        } else {
            echo "<script type=\"text/javascript\">alert(\"El Curso no Posee Asignaturas en el periodo\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            exit;

        }


        //Estilo pdf
        $style = "body{
font:12px ,Arial, Tahoma, Verdana, Helvetica, sans-serif;

color:#000;
}
img{
  width:60px;
  height:70px;
}


table{
font-size:10px;
width:100%;
height:auto;
margin:10px 0 10px 0;
border-collapse:collapse;
text-align:center;
text-justify:inter-word;
color:#000000;
}

table td,th{
border:1px solid black;
}

table th{
padding:1px;
background-color: #ccc;
}
";

        $pag = 0;
        $cuentapag = 0;
        if ($paso) {
            $max = 8;
        } else {
            $max = 50;
        }


        $html[$pag] = $encabezado;
        $html[$pag] .= "<div style='position:absolute;top:75px;left:25px;'><br> Curso: <b>" . $datoscurso[0]['nombreGrado'] . " " . $datoscurso[0]['letra'] . "</b><br> Fecha : <b>" . $fecha_final . "</b></div>";

        $html[$pag] .= '<table align="left" style="margin-left:20px"><tr><th>Nº</th><th>Alumnos</th>';


        for ($i = 0; $i < $largoasignatura; $i++) {


            //obtenemos cuantas notas existen en cada asignatura
            $cuentapag += 1;

            // si la cantidad de notas supera las 28 sumamos al contador de pag
            if ($cuentapag > $max) {
                $pag++;
                if ($pag == 1) {
                    $max = 16;
                }
                if ($pag == 2) {
                    $max = 22;
                }

                $html[$pag] = '<table align="left" style="margin-left:20px"><tr><th>Nº</th><th>Alumno</th>';

            }

            if ($datosexamenes[$i]) {
                //$row+=1;
                $html[$pag] .= '<th style="width:80px;text-align:justify;" colspan="5">' . $datosasignaturas[$i]["nombreAsignatura"] . '</th>';

            } else {
                $html[$pag] .= '<th style="width:80px;text-align:justify;" colspan="3">' . $datosasignaturas[$i]["nombreAsignatura"] . '</th>';

            }


        }

        $html[$pag] .= "<th>PROM</th><th>Días</th><th>Días</th><th>%</th>";


        $pag = 0;
        $cuentapag = 0;
        if ($paso) {
            $max = 8;
        } else {
            $max = 50;
        }

        $cuentapag2 = array();
        $contadorpag = 0;


        $html[$pag] .= '</tr><tr><th colspan="2">Promedios</th>';

        for ($i = 0; $i < $largoasignatura; $i++) {
            $cuentapag += 1;

            // si la cantidad de notas supera las notas que ingresan en una hoja
            if ($cuentapag > $max) {
                $html[$pag] .= '</tr>';
                $pag++;
                if ($pag == 1) {
                    $max = 16;
                }
                if ($pag == 2) {
                    $max = 22;
                }

                $html[$pag] .= '</tr><tr><th colspan="2">Promedios</th>';

            }


            if ($datosexamenes[$i]) {
                $html[$pag] .= '<th>I SEM</th>';
                $html[$pag] .= '<th>II SEM</th>';
                $html[$pag] .= '<th>FIN</th>';
                $html[$pag] .= '<th>EX <br>' . $datosexamenes[$i][0]['porcentajeExamen'] . ' %</th>';
                $html[$pag] .= '<th>FIN + <br>EX ' . $datosexamenes[$i][0]['porcentajeExamen'] . ' %</th>';
                $contadorpag++;
                $cuentapag2[$pag] += 5;
            } else {
                $html[$pag] .= '<th>I SEM</th>';
                $html[$pag] .= '<th>II SEM</th>';
                $html[$pag] .= '<th>FIN</th>';
                $contadorpag++;
                $cuentapag2[$pag] += 3;
            }


        }


        $html[$pag] .= '<th>PROM</th>';
        $cuentapag2[$pag] += 1;
        $html[$pag] .= '<th>Trab</th><th>Inas</th><th>Asis</th>';


        $html[$pag] .= '</tr>';


        if (!empty($listaalumnos)) {
            $r = 0;

            for ($i = 0; $i < $largoalumnos; $i++) {


                $pag = 0;
                $cuentapag = 0;
                if ($paso) {
                    $max = 8;
                } else {
                    $max = 50;
                }
                $html[$pag] .= '<tr><td>' . ($i + 1) . '</td><td style="text-align: left;">' . $listaalumnos[$i]["apaterno"] . ' ' . $listaalumnos[$i]["amaterno"] . ' ' . $listaalumnos[$i]["nombres"] . '</td>';
                $r = 0;


                for ($j = 0; $j < $largoasignatura; $j++) {

                    $promtalleraux = array();
                    $porcentajetaller = array();
                    $sumataller = 0;
                    $promtallerauxs = array();
                    $porcentajetallers = array();
                    $sumatallers = 0;
                    $row = $datosasig[$j];
                    $cuentapag += 1;

                    if ($cuentapag > $max) {
                        $html[$pag] .= '</tr>';
                        $pag++;
                        if ($pag == 1) {
                            $max = 16;
                        }
                        if ($pag == 2) {
                            $max = 22;
                        }


                        $html[$pag] .= '<tr><td>' . ($i + 1) . '</td><td style="text-align: left;">' . $listaalumnos[$i]["apaterno"] . ' ' . $listaalumnos[$i]["amaterno"] . ' ' . $listaalumnos[$i]["nombres"] . '</td>';

                    }

                    $promedio = 0;
                    $contador = 0;
                    $contadorpromedio = 0;
                    $promedios = 0;
                    $contadorpromedios = 0;
                    if ($row != 0) {
                        $largolistanota = count($listaalumnos[$i]['listanotas']);
                        for ($z = 0; $z < $largolistanota; $z++) {
                            $contadoraux = 0;

                            //if ($datosasignaturas[$j]['idAsignatura'] == $listaalumnos[$i]['listanotas'][$z]['idAsignatura']) {
                            if ($datosasignaturas[$j]['idAsignatura'] == $listaalumnos[$i]['listanotas'][$z]['idAsignatura']) {


                                //Primer Semesre
                                if ($listaalumnos[$i]['listanotas'][$z]['tiempo'] == 1) {

                                    if ($listaalumnos[$i]['listanotas'][$z]['coef'] == 2) {
                                        $contador += 2;
                                        if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == NULL || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {
                                            $promedio += 0;
                                            $contadorpromedio += 0;


                                        } else {
                                            $promedio += ($listaalumnos[$i]['listanotas'][$z]['nota'] + $listaalumnos[$i]['listanotas'][$z]['nota']);
                                            $contadorpromedio += 2;

                                        }

                                    } else {
                                        $contador += 1;

                                        if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == NULL || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {
                                            if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"])) {
                                                if ($listaalumnos[$i]["listanotas"][$z]["nota"] == 0) {

                                                    $promedio += 0;
                                                    $contadorpromedio += 0;

                                                }

                                            } else {
                                                $promedio += 0;
                                                $contadorpromedio += 0;


                                            }


                                        } else {
                                            if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"]) && $listaalumnos[$i]["listanotas"][$z]["forma"] == 2) {

                                                $contadorauxtaller = true;
                                                $promtalleraux[] = $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $porcentajetaller[] = $listaalumnos[$i]["listanotas"][$z]["porcentaje"];


                                            } else {

                                                $promedio += $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $contadorpromedio += 1;


                                            }


                                        }


                                    }
                                }
                                if ($listaalumnos[$i]['listanotas'][$z]['tiempo'] == 2) {


                                    if ($listaalumnos[$i]['listanotas'][$z]['coef'] == 2) {
                                        $contador += 2;
                                        if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == NULL || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {
                                            $promedios += 0;
                                            $contadorpromedios += 0;


                                        } else {
                                            $promedios += ($listaalumnos[$i]['listanotas'][$z]['nota'] + $listaalumnos[$i]['listanotas'][$z]['nota']);
                                            $contadorpromedios += 2;

                                        }

                                    } else {


                                        $contador += 1;

                                        if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == NULL || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {
                                            if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"])) {
                                                if ($listaalumnos[$i]["listanotas"][$z]["nota"] == 0) {

                                                    $promedios += 0;
                                                    $contadorpromedios += 0;

                                                }

                                            } else {
                                                $promedios += 0;
                                                $contadorpromedios += 0;


                                            }


                                        } else {
                                            if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"]) && $listaalumnos[$i]["listanotas"][$z]["forma"] == 2) {

                                                $contadorauxtallers = true;
                                                $promtallerauxs[] = $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $porcentajetallers[] = $listaalumnos[$i]["listanotas"][$z]["porcentaje"];


                                            } else {

                                                $promedios += $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $contadorpromedios += 1;


                                            }


                                        }


                                    }
                                }


                                //Promedios por notas

                                if ($contador == $row) {


                                    if ($contadorpromedio != 0 && $promedio != 0) {
                                        $promedioaux = 0;
                                        //SI el Taller es por porcentaje
                                        if ($contadorauxtaller) {
                                            $totalporcentaje = 100;
                                            if (count($promtalleraux) > 1) {
                                                for ($t = 0; $t < count($promtalleraux); $t++) {
                                                    $totalporcentaje = $totalporcentaje - $porcentajetaller[$t];
                                                    $sumataller += $promtalleraux[$t] * ($porcentajetaller[$t] / 100);
                                                }

                                            } else {
                                                $totalporcentaje = 100 - $porcentajetaller[0];
                                                $sumataller = $promtalleraux[0] * ($porcentajetaller[0] / 100);

                                            }


                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioaux = round($promedio / $contadorpromedio);
                                                $promedioaux = ($promedioaux * ($totalporcentaje / 100)) + $sumataller;
                                                $promedioaux = round($promedioaux);
                                                $notamatriz[$r][] = $promedioaux;

                                            } else {
                                                $promedioaux = round($promedio / $contadorpromedio);
                                                $promedioaux = ($promedioaux * ($totalporcentaje / 100)) + $sumataller;
                                                $promedioaux = intval($promedioaux);
                                                $notamatriz[$r][] = $promedioaux;
                                            }

                                        } else {

                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioaux = round($promedio / $contadorpromedio);
                                                $promfinal[$i][] = $promedioaux;
                                                $notamatriz[$r][] = $promedioaux;

                                            } else {
                                                $promedioaux = intval($promedio / $contadorpromedio);
                                                $promfinal[$i][] = $promedioaux;
                                                $notamatriz[$r][] = $promedioaux;
                                            }

                                        }
                                        $r++;


                                        $html[$pag] .= '<td>' . $promedioaux . '</td>';


                                    } else {
                                        $promedioaux = 0;
                                        $promfinal[$i][] = 0;
                                        $notamatriz[$r][] = 0;
                                        $html[$pag] .= '<td>-</td>';
                                        $r++;


                                    }


                                    //Segundo Semestre
                                    if ($contadorpromedios != 0 && $promedios != 0) {
                                        $promedioauxs = 0;
                                        //SI el Taller es por porcentaje
                                        if ($contadorauxtallers) {
                                            $totalporcentajes = 100;
                                            if (count($promtallerauxs) > 1) {
                                                for ($t = 0; $t < count($promtallerauxs); $t++) {
                                                    $totalporcentajes = $totalporcentajes - $porcentajetallers[$t];
                                                    $sumatallers += $promtallerauxs[$t] * ($porcentajetallers[$t] / 100);
                                                }

                                            } else {
                                                $totalporcentajes = 100 - $porcentajetallers[0];
                                                $sumatallers = $promtallerauxs[0] * ($porcentajetallers[0] / 100);

                                            }


                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioauxs = round($promedios / $contadorpromedios);
                                                $promedioauxs = ($promedioauxs * ($totalporcentajes / 100)) + $sumatallers;
                                                $promedioauxs = round($promedioauxs);
                                                $notamatriz[$r][] = $promedioauxs;

                                            } else {
                                                $promedioauxs = round($promedios / $contadorpromedios);
                                                $promedioauxs = ($promedioauxs * ($totalporcentajes / 100)) + $sumatallers;
                                                $promedioauxs = intval($promedioauxs);
                                                $notamatriz[$r][] = $promedioauxs;
                                            }

                                        } else {

                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioauxs = round($promedios / $contadorpromedios);
                                                $promfinal[$i][] = $promedioauxs;
                                                $notamatriz[$r][] = $promedioauxs;

                                            } else {
                                                $promedioauxs = intval($promedios / $contadorpromedios);
                                                $promfinal[$i][] = $promedioauxs;
                                                $notamatriz[$r][] = $promedioauxs;
                                            }
                                        }
                                        $r++;


                                        $html[$pag] .= '<td>' . $promedioauxs . '</td>';


                                    } else {
                                        $promedioauxs = 0;
                                        $promfinal[$i][] = 0;
                                        $notamatriz[$r][] = 0;
                                        $html[$pag] .= '<td>-</td>';
                                        $r++;


                                    }


                                    //Promedio Final De Asignatura
                                    $finalasignatura = 0;

                                    if ($promedioaux != 0 && $promedioauxs != 0) {

                                        if ($datoscurso[0]['aproxAnual'] == 1) {
                                            $finalasignatura = round(($promedioaux + $promedioauxs) / 2);
                                            if ($finalasignatura == 39 && $datoscurso[0]['rbd'] == '1864') {
                                                $finalasignatura = 40;
                                            }
                                        } else {
                                            $finalasignatura = intval(($promedioaux + $promedioauxs) / 2);
                                            if ($finalasignatura == 39 && $datoscurso[0]['rbd'] == '1864') {
                                                $finalasignatura = 40;
                                            }

                                        }
                                        if ($agregadecimas) {
                                            if ($finalasignatura >= 60) {
                                                $finalasignatura += 2;
                                                if ($finalasignatura > 70) {
                                                    $finalasignatura = 70;

                                                }

                                            }
                                        }


                                    }

                                    if ($promedioaux == 0 && $promedioauxs == 0) {
                                        $finalasignatura = 0;


                                    }

                                    if ($promedioaux == 0 && $promedioauxs != 0) {

                                        $finalasignatura = $promedioauxs;

                                        if ($agregadecimas) {
                                            if ($finalasignatura >= 60) {
                                                $finalasignatura += 2;
                                                if ($finalasignatura > 70) {
                                                    $finalasignatura = 70;

                                                }

                                            }
                                        }


                                    }
                                    if ($promedioaux != 0 && $promedioauxs == 0) {
                                        $finalasignatura = $promedioaux;
                                        if ($agregadecimas) {
                                            if ($finalasignatura >= 60) {
                                                $finalasignatura += 2;
                                                if ($finalasignatura > 70) {
                                                    $finalasignatura = 70;

                                                }

                                            }
                                        }


                                    }


                                    //Inicio Examen

                                    if (count($datosexamenes[$j]) > 0) {
                                        //$promediototal[$i][] = $finalasignatura;
                                        $html[$pag] .= '<td>' . $finalasignatura . '</td>';
                                        $notamatriz[$r][] = $finalasignatura;
                                        $r++;

                                        $datosalumnosexamen = $modelnotas->getnotasexamenalumno($datosexamenes[$j][0]['idEvaluacion'], $id, $datosasignaturas[$j]['idAsignatura'], $idperiodo, 6, $listaalumnos[$i]['idAlumnos']);


                                        if (count($datosalumnosexamen) > 0) {


                                            if ($datosalumnosexamen[0]['nota'] > 0) {
                                                $html[$pag] .= '<td>' . $datosalumnosexamen[0]['nota'] . '</td>';
                                                $notamatriz[$r][] = $datosalumnosexamen[0]['nota'];
                                                $r++;

                                                $totalex = 100 - $datosexamenes[$j][0]['porcentajeExamen'];

                                                //nota d examen

                                                $sumaex = $datosalumnosexamen[0]['nota'] * ($datosexamenes[$i][0]['porcentajeExamen'] / 100);

                                                if ($datoscurso[0]['aproxExamen'] == 1) {
                                                    $finalasignatura = round(($finalasignatura * ($totalex / 100)) + $sumaex);
                                                } else {
                                                    $finalasignatura = intval(($finalasignatura * ($totalex / 100)) + $sumaex);
                                                }


                                            } else {
                                                $html[$pag] .= '<td>-</td>';
                                                $notamatriz[$r][] = $datosalumnosexamen[0]['nota'];
                                                $r++;
                                                $finalasignatura = $finalasignatura;
                                            }

                                        } else {
                                            $html[$pag] .= '<td>-</td>';
                                            $notamatriz[$r][] = 0;
                                            $r++;
                                        }
                                        //Promedio FInal
                                        $promediototal[$i][] = $finalasignatura;
                                        $html[$pag] .= '<td>' . $finalasignatura . '</td>';
                                        $notamatriz[$r][] = $finalasignatura;
                                        $r++;
                                    } else {
                                        $promediototal[$i][] = $finalasignatura;
                                        $html[$pag] .= '<td>' . $finalasignatura . '</td>';
                                        $notamatriz[$r][] = $finalasignatura;
                                        $r++;
                                    }

                                }// fin promedio por notas

                            }

                        }// fin for


                    } else {
                        $html[$pag] .= '<td>-</td>';
                        $html[$pag] .= '<td>-</td>';
                        $html[$pag] .= '<td>-</td>';
                        $notamatriz[$r][] = 0;
                        $r++;
                        $notamatriz[$r][] = 0;
                        $r++;
                        $notamatriz[$r][] = 0;
                        $r++;


                    } //fin if row


                } //fin for Asignaturas


                if ($promediototal[$i] != '' || $promediototal[$i] != null) {

                    if ($datoscurso[0]['aproxFinal'] == 1) {//Aproxima ytyt
                        $promediototal[$i] = array_diff($promediototal[$i], array('0'));
                        $promediofinal = round(array_sum($promediototal[$i]) / count($promediototal[$i]));

                    } else {
                        $promediototal[$i] = array_diff($promediototal[$i], array('0'));
                        $promediofinal = intval(array_sum($promediototal[$i]) / count($promediototal[$i]));


                    }


                    $html[$pag] .= '<td>' . $promediofinal . '</td>';
                    $notamatriz[$r][] = $promediofinal;

                } else {
                    $html[$pag] .= '<td>-</td>';
                    $notamatriz[$r][] = 0;
                }


                $detallealumnoprimer = $modeldetalle->listardetalleperiodo($listaalumnos[$i]['idAlumnosActual'], 1, $idperiodo);
                $detallealumnosegundo = $modeldetalle->listardetalleperiodo($listaalumnos[$i]['idAlumnosActual'], 2, $idperiodo);

                $diasin = $detallealumnoprimer[0]['diasInasistencia'] + $detallealumnosegundo[0]['diasInasistencia'];
                $diastrabajados = $detallealumnoprimer[0]['diasTrabajado'] + $detallealumnosegundo[0]['diasTrabajado'];
                if ($diasin != 0 && $diastrabajados > 0) {
                    $valor = $diasin / $diastrabajados;
                    $aux = 1 - $valor;
                    $totald = $aux * 100;
                } elseif (($diasin == 0 || $diasin == '') && $diastrabajados > 0) {
                    $valor = $diasin / $diastrabajados;
                    $aux = 1 - $valor;
                    $totald = $aux * 100;
                } else {
                    $totald = 0;
                    $diastrabajados = "-";
                    $diasin = "-";
                }

                $html[$pag] .= '<td>' . $diastrabajados . '</td><td>' . $diasin . '</td><td>' . intval($totald) . '%</td>';


                $html[$pag] .= '</tr>';


            }

            $aux = 0;
            $max = 0;
            $largocuenta = 0;
            $largoes = count($cuentapag2);

            //Estadistica de notas
            for ($i = 0; $i < count($cuentapag2); $i++) {
                $max = $max + $cuentapag2[$i];
                if ($i > 0) {
                    $aux = $aux + $cuentapag2[$i - 1];
                    $largocuenta = $largocuenta + $cuentapag2[$i];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Promedio Generales</td>';
                } else {

                    $aux = 0;
                    $largocuenta = $cuentapag2[$i];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Promedio Generales</td>';
                }


                for ($y = $aux; $y < $largocuenta; $y++) {
                    $notamatrizset = array_diff($notamatriz[$y], array('0'));
                    if (array_sum($notamatrizset) != 0) {
                        $html[$i] .= '<td>' . round(array_sum($notamatrizset) / count($notamatrizset)) . '</td>';
                    } else {
                        $html[$i] .= '<td>-</td>';
                    }


                }
                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';


                //Minimos
                if ($i > 0) {
                    //$aux = $aux+$cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Mínimo</td>';
                } else {
                    //$aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Mínimo</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {

                    $valormin = array_sum($notamatriz[$y]);
                    if ($valormin != 0) {
                        $html[$i] .= '<td>' . min(array_diff($notamatriz[$y], array(0))) . '</td>';
                    } else {
                        $html[$i] .= '<td>-</td>';
                    }


                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';

                //Maximos
                if ($i > 0) {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Máximo</td>';
                } else {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Máximo</td>';
                }


                for ($y = $aux; $y < $largocuenta; $y++) {
                    $valormax = array_sum($notamatriz[$y]);
                    if ($valormax != 0) {
                        $html[$i] .= '<td>' . max(array_diff($notamatriz[$y], array(0))) . '</td>';
                    } else {
                        $html[$i] .= '<td>-</td>';
                    }
                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';

                //Adecuado

                if ($i > 0) {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Adecuado</td>';
                } else {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Adecuado</td>';
                }


                for ($y = $aux; $y < $largocuenta; $y++) {
                    $contadorinicial = 0;
                    $largomatriz = count($notamatriz[$y]);
                    for ($v = 0; $v < $largomatriz; $v++) {
                        if ($notamatriz[$y][$v] > 59 && $notamatriz[$y][$v] <= 70) {
                            $contadorinicial = $contadorinicial + 1;

                        }
                    }
                    $totaladecuado[$y] = $contadorinicial;

                    $html[$i] .= '<td>' . $contadorinicial . '</td>';

                }
                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';

                //Elemntal
                if ($i > 0) {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Elemental</td>';
                } else {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Elemental</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {
                    $contadorinicial = 0;
                    $largomatriz = count($notamatriz[$y]);
                    for ($v = 0; $v < $largomatriz; $v++) {
                        if ($notamatriz[$y][$v] > 39 && $notamatriz[$y][$v] < 60) {
                            $contadorinicial = $contadorinicial + 1;

                        }
                    }

                    $totalelemental[$y] = $contadorinicial;
                    $html[$i] .= '<td>' . $contadorinicial . '</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';


                //Insuficiente
                if ($i > 0) {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Insuficiente</td>';
                } else {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Insuficiente</td>';
                }


                for ($y = $aux; $y < $largocuenta; $y++) {
                    $contadorinicial = 0;
                    $largomatriz = count($notamatriz[$y]);
                    for ($v = 0; $v < $largomatriz; $v++) {
                        if ($notamatriz[$y][$v] > 10 && $notamatriz[$y][$v] < 40) {
                            $contadorinicial = $contadorinicial + 1;

                        }
                    }

                    $totalinsuficiente[$y] = $contadorinicial;

                    $html[$i] .= '<td>' . $contadorinicial . '</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';


                //Totales
                if ($i > 0) {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Total</td>';
                } else {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Total</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {
                    $total[$y] = ($totaladecuado[$y] + $totalelemental[$y] + $totalinsuficiente[$y]);

                    $html[$i] .= '<td>' . $total[$y] . '</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';


                //Porcentaje Adecuado

                if ($i > 0) {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Adecuado</td>';
                } else {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Adecuado</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {

                    if ($total[$y] > 0) {
                        $porcentaje = ($totaladecuado[$y] / $total[$y]) * 100;
                    } else {
                        $porcentaje = 0;
                    }

                    $html[$i] .= '<td>' . round($porcentaje) . '%</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';

                //Porcentaje Elemental
                if ($i > 0) {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Elemental</td>';
                } else {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Elemental</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {

                    if ($total[$y] > 0) {
                        $porcentaje = ($totalelemental[$y] / $total[$y]) * 100;
                    } else {
                        $porcentaje = 0;
                    }

                    $html[$i] .= '<td>' . round($porcentaje) . '%</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';

                //Porcentaje Suficiente

                if ($i > 0) {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Insuficiente</td>';
                } else {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Insuficiente</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {

                    if ($total[$y] > 0) {
                        $porcentaje = ($totalinsuficiente[$y] / $total[$y]) * 100;
                    } else {
                        $porcentaje = 0;
                    }

                    $html[$i] .= '<td>' . round($porcentaje) . '%</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';


            }//Fin ciclo Paginas


        }


        if ($paso) {
            if ($html != '') {

                require 'fpdf/html2pdf.class.php';
                try {
                    $width_in_mm = 216;
                    $height_in_mm = 330;
                    $pdf = new HTML2PDF('L', array($width_in_mm, $height_in_mm), 'es', true, 'UTF-8', array(0, 0, 0, 0) /*márgenes*/); //los márgenes también pueden definirse en <page> ver documentación
                    $pdf->pdf->SetDisplayMode('fullpage');
                    for ($i = 0; $i < count($html); $i++) {

                        $pdf->WriteHTML('<page><html>
                        <head>
                            <style>' . $style . '</style>
                        </head>
                        <body>' . $html[$i] . '</table></body></html></page>');
                    }

                    if (preg_match("/MSIE/i", $_SERVER["HTTP_USER_AGENT"])) {
                        header("Content-type: application/PDF");
                    } else {
                        header("Content-type: application/PDF");
                        header("Content-Type: application/pdf");
                    }

                    $pdf->Output('Planificacion.pdf', I);
                } catch (HTML2PDF_exception $e) {
                    //echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, intente nuevamente\");</script>";
                    //echo "<script>parent.$.fancybox.close();</script>";
                    echo $e;
                }
            }
        } else {


            $filename = "Informe Promedios " . strftime("%A %d de %B del %Y") . "";
            $tmpfile = tempnam(sys_get_temp_dir(), 'html');
            file_put_contents($tmpfile, $html);

            $reader = new \PhpOffice\PhpSpreadsheet\Reader\Html();
            $spreadsheet = $reader->load($tmpfile);
            $writer = new \PhpOffice\PhpSpreadsheet\Writer\Xlsx($spreadsheet);
            $writer->save('export.xlsx');
            header('Content-Type: application/vnd.ms-excel');
            header('Content-Disposition: attachment; filename="' . $filename . '.xlsx"');
            $writer->save("php://output");
            unlink($tmpfile); // delete temporary file because it isn't needed anymore
            exit;


        }
    }


    public function generaralumnocursoanualAction()
    {
        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();


        //debe venir un parametro, por GET o POST, llamado idasignatura, con el id del Asignatura a borrar
        $id = $this->_getParam('id', 0);
        $segmento = 1;
        $tipo = $this->_getParam('t', 0);
        $agregadecimas = false;


        $style = "body{
font:11px Arial, Tahoma, Verdana, Helvetica, sans-serif;

color:#000;
}

#infoizq{

position:absolute;
left:0px;
}

#infoder{

position:absolute;
right:0px;
}

a h1{
font-size:35px;
color:#FFF;
}
img{
width:90px;
height:100px;
}

h2{
color:#FC0;
font-size:15px;
}


table{
width:100%;
height:auto;
margin:5px 0 10px 0;
border-collapse:collapse;
text-align:center;
text-justify:inter-word;
color:#000000;
}

table td,th{
border:1px solid black;
}
 .mes{
text-align:center;
}

table th{
padding:5px;
background-color: #ccc;
}


text-align:center;
font-weight:bold;
color:#000000;
}

.menu{
background-color:#69C;
color:#FFF;
}
.celda{
height: auto;
width: 170px;
text-align:left;
padding:1px;
}

.menu a{
color:#FFF;
}";

        if ($segmento == '1') {

            $nombresegmento = 'I Semestre';
        }
        if ($segmento == '2') {

            $nombresegmento = 'II Semestre';
        }


        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $monitoreos = new Zend_Session_Namespace('monitoreo');
        $monitoreo = $monitoreos->monitoreo;
        //creo objeto tabla Notas
        $tabla = new Application_Model_DbTable_Notas();
        $modeloalumnoactual = new Application_Model_DbTable_Alumnosactual();
        if ($tipo == 1) {
            $listadealumnos = $modeloalumnoactual->get($id);
            $idcursoactual = $listadealumnos[0]['idCursosActual'];
        } else {
            $listadealumnos = $modeloalumnoactual->listaralumnoscursoactual($id, $idperiodo);
            $idcursoactual = $id;
        }


        //creo objeto tabla curso
        $modelCurso = new Application_Model_DbTable_Cursos();
        $detalleest = $modelCurso->listarcursoid($idcursoactual, $idperiodo);


        if ($detalleest[0]['monitoreo'] == 1 && $detalleest[0]['idEstablecimiento'] == 12) {
            //creo objeto tabla Notas
            $tabla = new Application_Model_DbTable_Notas();
            $modelasignatura = new Application_Model_DbTable_Asignaturascursos();
            $modeloalumnodetalle = new Application_Model_DbTable_AlumnosDetalle();

            $listaasignatura = $modelasignatura->listarporcursoprioritaria($idcursoactual, 1, array('1', '3'), $idperiodo);
            $listaasignaturaconcepto = $modelasignatura->listarporcurso($idcursoactual, 0, array('5'), $idperiodo);
            //$listaasignaturanoinciden = $modelasignatura->gettaller($idcursoactual, $idperiodo);
            $datosasignaturascombinada = $modelasignatura->getcombinada($idcursoactual, $idperiodo);
            $largocombinada = count($datosasignaturascombinada);
            $largoconcepto = count($listaasignaturaconcepto);
        } else {
            //creo objeto tabla Notas
            $tabla = new Application_Model_DbTable_Notas();
            $modelasignatura = new Application_Model_DbTable_Asignaturascursos();
            $modeloalumnodetalle = new Application_Model_DbTable_AlumnosDetalle();

            $listaasignatura = $modelasignatura->listarporcurso($idcursoactual, 1, array('1', '3'), $idperiodo);
            $listaasignaturaconcepto = $modelasignatura->listarporcurso($idcursoactual, 0, array('5'), $idperiodo);
            //$listaasignaturanoinciden = $modelasignatura->gettaller($idcursoactual, $idperiodo);
            $datosasignaturascombinada = $modelasignatura->getcombinada($idcursoactual, $idperiodo);
            $largocombinada = count($datosasignaturascombinada);
            $largoconcepto = count($listaasignaturaconcepto);
        }

        //Configuracion de agregar 2 decimas a curso desde 5 a 4to medio cuando el promedio final es mayor o igual a 6
        if (($detalleest[0]['rbd'] == 1863) && (($detalleest[0]['idCodigo'] == 110 && $detalleest[0]['idGrado'] > 4) || $detalleest[0]['idCodigo'] == 310 || $detalleest[0]['idCodigo'] == 363 || $detalleest[0]['idCodigo'] == 410 || $detalleest[0]['idCodigo'] == 510 || $detalleest[0]['idCodigo'] == 610)) {
            $agregadecimas = true;
        }

        //Monitoreo 27-09-2020

        if ($detalleest[0]['monitoreo'] == 1) {

            if ($detalleest[0]['idEstablecimiento'] == 12 || $detalleest[0]['idEstablecimiento'] == 8) {
                $modeloequivalencia = new Application_Model_DbTable_Equivalencia();
                $lista_equivalencia = $modeloequivalencia->listarperiodo($detalleest[0]['idEstablecimiento'], $idperiodo, 1);
                $lista_niveles = $modeloequivalencia->listarniveleslogro($detalleest[0]['idEstablecimiento'], $idperiodo, 1);

            }


        }


        //creo objeto tabla cuentas
        $modelCuenta = new Application_Model_DbTable_Cuentas();
        $Profesorjefe = $modelCuenta->getusuario($detalleest[0]['idCuentaJefe'], $idperiodo);
        $director = $modelCuenta->get($detalleest[0]['idDirector']);
        $largoalumnos = count($listadealumnos);
        $largoasignatura = count($listaasignatura);


        //Si la configuracion indica que se utiliza examen
        if ($detalleest[0]['examen'] == 1) {
            $modeloprueba = new Application_Model_DbTable_Pruebas();
            //Veficiamos que las asignaturas posean examen
            for ($i = 0; $i < $largoasignatura; $i++) {
                $datosexamenes = $modeloprueba->getexamen($detalleest[0]['idCursos'], $idperiodo, $listaasignatura[$i]['idAsignatura'], 6);
                if (count($datosexamenes) > 0) {

                    $datosalumnosexamen = $tabla->getnotasexamenalumno($datosexamenes[0]['idEvaluacion'], $detalleest[0]['idCursos'], $listaasignatura[$i]['idAsignatura'], $idperiodo, 6, $listadealumnos[0]['idAlumnos']);
                    if (count($datosalumnosexamen) > 0) {
                        if ($datosalumnosexamen[0]['nota'] > 0) {
                            $datosexamenalumno[] = $datosalumnosexamen;
                        }
                    }
                }
            }

        }


        if (count($Profesorjefe) == 0 || $Profesorjefe == null) {
            echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta Profesor Jefe\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            exit;
        }

        if (count($director) == 0 || $director == null) {
            echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta Director\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            exit;
        }


        $date = new DateTime;
        $fechain = $date->format('Y-m-d');
        $cortado = explode("-", $fechain);
        $dias = array("Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado");
        $meses = array("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre");

        $fecha_final = $dias[date('w', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]))] . " " . $cortado[2] . " de " . $meses[date('n', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0])) - 1] . " del " . date('Y', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]));

        $niveleducacion = $detalleest[0]['idCodigoTipo'];
        $grado = $detalleest[0]['idGrado'];

        if ($niveleducacion == '110') {
            $nombreedu = 'Enseñanza Básica';

        }

        if ($niveleducacion == '310') {
            $nombreedu = 'Enseñanza Media';

        }
        if ($niveleducacion == '410') {
            $nombreedu = 'Enseñanza Media Técnico-Profesional Comercial';
            if ($detalleest[0]['rbd'] == '1864') {//Cesa
                $nombredecreto = 'Nº 954 del año 2015';
                $nombreexento = 'Decreto Supremo Evaluación,Calificación Escolar Nº 67 de 2018';


            }

        }

        if ($niveleducacion == '463') {
            $nombreedu = 'Enseñanza Media Técnico-Profesional Adultos Comercial';

        }

        if ($niveleducacion == '510') {
            $nombreedu = 'Enseñanza Media Técnico-Profesional Industrial';
            if ($detalleest[0]['rbd'] == '1864') {//Cesa
                $nombredecreto = 'Nº 954 del año 2015';
                $nombreexento = 'Decreto Supremo Evaluación,Calificación Escolar Nº 67 de 2018';


            }

        }

        if ($niveleducacion == '563') {
            $nombreedu = 'Enseñanza Media Técnico-Profesional Adultos Industrial';

        }
        if ($niveleducacion == '610') {
            $nombreedu = 'Enseñanza Media Técnico-Profesional ';
            //General Velasquez
            if ($detalleest[0]['rbd'] == '1863') {
                $nombredecreto = 'Nº 954 del año 2015';
                $nombreexento = 'Decreto Exento Nº 83 de 2001.';
                if ($detalleest[0]['letra'] == 'A') {
                    $nombreedu = "Enseñanza Media Técnico-Profesional Atención de Párvulos";

                }
                if ($detalleest[0]['letra'] == 'B') {
                    $nombreedu = "Enseñanza Media Técnico-Profesional Servicio de Hotelería";

                }
                if ($detalleest[0]['letra'] == 'C') {
                    $nombreedu = "Enseñanza Media Técnico-Profesional Gastronomía Mención Cocina ";

                }

            }

            if ($detalleest[0]['rbd'] == '1864') {//Cesa
                $nombredecreto = 'Nº 954 del año 2015';
                $nombreexento = 'Decreto Supremo Evaluación,Calificación Escolar Nº 67 de 2018';


            }

        }

        if ($niveleducacion == '663') {
            $nombreedu = 'Enseñanza Media Técnico-Profesional Adultos';

        }


        if ($niveleducacion == 110 && $grado < 7) {
            $nombredecreto = 'Nº 2960 del año 2012';
            $nombreexento = 'Decreto Exento Nº 511 de 1997.';

            if ($detalleest[0]['rbd'] == '1864') {//Cesa
                $nombredecreto = 'Nº 954 del año 2015';
                $nombreexento = 'Decreto Supremo Evaluación,Calificación Escolar Nº 67 de 2018';


            }

            if ($detalleest[0]['rbd'] == '1874') {//Cesa
                $nombredecreto = 'Nº 1363 del año 2011 ';
                $nombreexento = 'Decreto Nº 67 de 2018';


            }

            if ($detalleest[0]['rbd'] == '1873') {//Horcon
                $nombreexento = 'Decreto Nº 67 de 2018';


            }

        }
        if ($niveleducacion == 110 && ($grado > 6 && $grado < 9)) {
            $nombredecreto = 'Nº 1363 del año 2011 ';
            $nombreexento = 'Decreto Exento Nº 511 de 1997.';

            if ($detalleest[0]['rbd'] == '1864') {//Cesa
                $nombredecreto = 'Nº 954 del año 2015';
                $nombreexento = 'Decreto Exento Nº 67 de 2018.';


            }

            if ($detalleest[0]['rbd'] == '1874') {//Cesa
                $nombredecreto = 'Nº 1363 del año 2011 ';
                $nombreexento = 'Decreto Nº 67 de 2018';


            }
            if ($detalleest[0]['rbd'] == '1873') {//Horcon
                $nombredecreto = 'Nº 1363 del año 2011 ';
                $nombreexento = 'Decreto Nº 67 de 2018';


            }

        }
        if ($niveleducacion == 310 && $grado > 0) {
            $nombredecreto = 'Nº 1358  del año 2011';
            $nombreexento = 'Decreto Exento Nº 112 de 1999.';

            if ($detalleest[0]['rbd'] == '1864') {//Cesa
                $nombredecreto = 'Nº 954 del año 2015';
                $nombreexento = 'Decreto Supremo Evaluación,Calificación Escolar Nº 67 de 2018.';


            }

        }

        if ($niveleducacion == '363') {
            $nombreedu = 'Enseñanza Media Adultos ';

            if ($detalleest[0]['rbd'] == '1864') {//Cesa
                $nombredecreto = 'Nº 954 del año 2015';
                $nombreexento = 'Decreto Exento Nº 2169 de 2007.';


            }

        }
        if ($niveleducacion == '165') {
            $nombreedu = 'Enseñanza Básica Adultos ';

            if ($detalleest[0]['rbd'] == '1864') {//Cesa
                $nombredecreto = 'Nº 954 del año 2015';
                $nombreexento = 'Decreto Exento Nº 2169 de 2007.';


            }

        }
        $taller = array();
        $combinada = array();
        for ($y = 0; $y < $largoalumnos; $y++) {
            $tablanotas = array();
            $tablanotas2 = array();
            $tablanotas2segundo = array();
            $alumnoactual = array();
            $verifica = array();
            $cuenta = 0;
            $promedio = 0;
            $cuenta1 = array();
            $cuentan = 0;
            $promedion = 0;
            $promediof = 0;
            $promediofn = 0;
            $cuenta2 = array();
            $promedioparcial = 0;
            $contadorparcial = 0;


            $idalumnoactual = $listadealumnos[$y]['idAlumnos'];


            if ($detalleest[0]['monitoreo'] == 1 && $detalleest[0]['idEstablecimiento'] == 7 && $idperiodo == 5) {//Greda 2020

                $tablanotas = $tabla->generasolonotasperiodo($idalumnoactual, 2, 1, $idperiodo, $idcursoactual);
                $tablanotas2 = $tabla->generasolonotasperiodo($idalumnoactual, 1, 0, $idperiodo, $idcursoactual);
                $tablanotas2segundo = $tabla->generasolonotasperiodo($idalumnoactual, 2, 0, $idperiodo, $idcursoactual);

                $verifica = $modeloalumnodetalle->get($listadealumnos[$y]['idAlumnosActual'], 10, $idperiodo);
                $observacion = $verifica[0]["observaciones"];
                $largotablanota2 = count($tablanotas2);
                $largotablaaux = count($tablanotas);
                $largotablanota2segundo = count($tablanotas2segundo);


                $datostallersem = $modelasignatura->gettaller($idcursoactual, $idperiodo, array(1, 2), 1, array(1, 2));
                $datostalleranual = $modelasignatura->gettalleranual($idcursoactual, $idperiodo, array(1), 1);
                $datostallersin = $modelasignatura->gettallersin($idcursoactual, $idperiodo);
                $listastalleres = array_merge($datostalleranual, $datostallersem);
                $listaasignaturanoinciden = array_merge($listastalleres, $datostallersin);

            } else {
                $tablanotas = $tabla->generasolonotas($idalumnoactual, $idcursoactual, $idperiodo);

                $tablanotas2 = $tabla->generasolonotasperiodo($idalumnoactual, 1, 0, $idperiodo, $idcursoactual);
                $tablanotas2segundo = $tabla->generasolonotasperiodo($idalumnoactual, 2, 0, $idperiodo, $idcursoactual);

                $verifica = $modeloalumnodetalle->get($listadealumnos[$y]['idAlumnosActual'], 10, $idperiodo);
                $observacion = $verifica[0]["observaciones"];
                $largotablanota2 = count($tablanotas2);
                $largotablaaux = count($tablanotas);
                $largotablanota2segundo = count($tablanotas2segundo);


                $datostallersem = $modelasignatura->gettaller($idcursoactual, $idperiodo, array(1, 2), 1, array(1, 2));
                $datostalleranual = $modelasignatura->gettalleranual($idcursoactual, $idperiodo, array(1), 1);
                $datostallersin = $modelasignatura->gettallersin($idcursoactual, $idperiodo);
                $listastalleres = array_merge($datostalleranual, $datostallersem);
                $listaasignaturanoinciden = array_merge($listastalleres, $datostallersin);
            }


            //Notas de talleres

            //Configuraciones de Taller

            //Configuracion de Taller Buscamos si existen configuraciones por alumnos


            //Obtiene los Talleres que son Semestrales Tiempo=2.
            $datostalleres = $modelasignatura->gettaller($idcursoactual, $idperiodo, array(1, 2), 1, array(1, 2));

            if (count($datostalleres) > 0) {
                for ($i = 0; $i < count($datostalleres); $i++) {
                    $detalletaller = $modelasignatura->gettallersegmento($datostalleres[$i]['idConfiguracionTaller'], array(1, 2), $idalumnoactual);


                    if ($detalletaller) {

                        $listaasignaturanoinciden[] = $detalletaller[0];
                    }

                }


            }


            $largoasignaturanoincide = count($listaasignaturanoinciden);


            //Notas de talleres

            if ($largoasignaturanoincide != 0) {

                $taller[$y] .= "<tr><td colspan='3'><b>TALLERES Y ASIGNATURAS</b></td></tr>";
                //for ($i = 0; $i < $largoasignaturanoincide; $i++) {
                for ($i = 0; $i < 1; $i++) {
                    $auxtexto = '';

                    //Configuracion de Taller
                    if ($listaasignaturanoinciden[$i]["tipoAjuste"] == 2) {

                        $promediotaller['idAsignatura'] = $detalletaller[0]['idAsignaturaDestino'];


                    } else {
                        $promediotaller['idAsignatura'] = $listaasignaturanoinciden[$i]["idAsignaturaTaller"];
                    }

                    $promedion = 0;
                    $cuentan = 0;
                    $promedionsegundo = 0;
                    $cuentansegundo = 0;
                    $auxtexto .= "<tr><td class='celda'>" . $listaasignaturanoinciden[$i]["nombreAsignatura"] . "</td>";


                    //Primer Semestre
                    if ($listaasignaturanoinciden[$i]["tiempoOpcion"] == 1) {
                        for ($j = 0; $j < $largotablanota2; $j++) {
                            if ($listaasignaturanoinciden[$i]["idAsignatura"] == $tablanotas2[$j]["idAsignatura"]) {
                                if ($tablanotas2[$j]['coef'] == 2) {
                                    if ($tablanotas2[$j]['nota'] != '0') {

                                        $promedion = $promedion + ($tablanotas2[$j]['nota'] + $tablanotas2[$j]['nota']);
                                        $cuentan = $cuentan + 2;

                                    }


                                } else {

                                    if ($tablanotas2[$j]['nota'] != '0') {
                                        $promedion = $promedion + $tablanotas2[$j]['nota'];
                                        $cuentan = $cuentan + 1;

                                    }


                                }

                            }

                        }
                    }


                    //Segundo Semestre
                    if ($listaasignaturanoinciden[$i]["tiempoOpcion"] == 2) {
                        for ($j = 0; $j < $largotablanota2segundo; $j++) {
                            if ($listaasignaturanoinciden[$i]["idAsignatura"] == $tablanotas2segundo[$j]["idAsignatura"]) {
                                if ($tablanotas2segundo[$j]['coef'] == 2) {
                                    if ($tablanotas2segundo[$j]['nota'] != '0') {
                                        $promedionsegundo += ($tablanotas2segundo[$j]['nota'] + $tablanotas2segundo[$j]['nota']);
                                        $cuentansegundo += 2;

                                    }


                                } else {

                                    if ($tablanotas2segundo[$j]['nota'] != '0') {

                                        $promedionsegundo += $tablanotas2segundo[$j]['nota'];
                                        $cuentansegundo += 1;

                                    }


                                }

                            }

                        }
                    }


                    //sacamos el promedio de la asignatura


                    if ($promedion > 0 || $cuentan > 0) {


                        if ($detalleest[0]['aproxAsignatura'] == 1) {
                            $promediofn = round($promedion / $cuentan);
                            $promediotaller['nota'] = $promediofn;
                            $promediotaller['coef'] = 1;
                            $promediotaller['tiempo'] = 1;
                            $promediotaller['idAsignatura'] = $listaasignaturanoinciden[$i]["idAsignaturaTaller"];
                            $promediotaller['forma'] = $listaasignaturanoinciden[$i]["forma"];
                            $promediotaller['porcentaje'] = $listaasignaturanoinciden[$i]["porcentaje"];
                            $promediotaller['tipoAjuste'] = $listaasignaturanoinciden[$i]["tipoAjuste"];
                            $promediotaller['idConfiguracionTaller'] = $listaasignaturanoinciden[$i]["idConfiguracionTaller"];
                            $promediotaller['tipoAsignatura'] = $listaasignaturanoinciden[$i]["tipoAsignatura"];

                        } else {
                            $promediofn = intval($promedion / $cuentan);
                            $promediotaller['nota'] = $promediofn;
                            $promediotaller['coef'] = 1;
                            $promediotaller['tiempo'] = 1;
                            $promediotaller['forma'] = $listaasignaturanoinciden[$i]["forma"];
                            $promediotaller['porcentaje'] = $listaasignaturanoinciden[$i]["porcentaje"];
                            $promediotaller['tipoAjuste'] = $listaasignaturanoinciden[$i]["tipoAjuste"];
                            $promediotaller['idConfiguracionTaller'] = $listaasignaturanoinciden[$i]["idConfiguracionTaller"];
                            $promediotaller['tipoAsignatura'] = $listaasignaturanoinciden[$i]["tipoAsignatura"];

                        }
                        $auxtexto .= "<td class='prom'>" . $promediofn . "</td></tr>";
                        $taller[$y] .= $auxtexto;

                    } else {
                        $promediotaller['nota'] = 0;
                        $promediotaller['coef'] = 1;
                        $promediotaller['tiempo'] = 1;
                        $promediotaller['forma'] = $listaasignaturanoinciden[$i]["forma"];
                        $promediotaller['porcentaje'] = $listaasignaturanoinciden[$i]["porcentaje"];
                        $promediotaller['tipoAjuste'] = $listaasignaturanoinciden[$i]["tipoAjuste"];
                        $promediotaller['idConfiguracionTaller'] = $listaasignaturanoinciden[$i]["idConfiguracionTaller"];
                        $promediotaller['idAsignatura'] = $listaasignaturanoinciden[$i]["idAsignaturaTaller"];
                        $promediotaller['tipoAsignatura'] = $listaasignaturanoinciden[$i]["tipoAsignatura"];

                    }

                    //Segundo Semestre

                    if ($promedionsegundo > 0 || $cuentansegundo > 0) {

                        if ($detalleest[0]['aproxAsignatura'] == 1) {
                            $promediofns = round($promedionsegundo / $cuentansegundo);
                            $promediotallers['nota'] = $promediofns;
                            $promediotallers['coef'] = 1;
                            $promediotallers['tiempo'] = 2;
                            $promediotallers['idAsignatura'] = $listaasignaturanoinciden[$i]["idAsignaturaTaller"];
                            $promediotallers['forma'] = $listaasignaturanoinciden[$i]["forma"];
                            $promediotallers['porcentaje'] = $listaasignaturanoinciden[$i]["porcentaje"];

                        } else {
                            $promediofns = intval($promedionsegundo / $cuentansegundo);
                            $promediotallers['nota'] = $promediofns;
                            $promediotallers['coef'] = 1;
                            $promediotallers['tiempo'] = 2;
                            $promediotallers['idAsignatura'] = $listaasignaturanoinciden[$i]["idAsignaturaTaller"];
                            $promediotallers['forma'] = $listaasignaturanoinciden[$i]["forma"];
                            $promediotallers['porcentaje'] = $listaasignaturanoinciden[$i]["porcentaje"];

                        }
                        $promediocortado = str_split($promediofns);
                        $taller[$y] .= "<td>" . $promediocortado[0] . ',' . $promediocortado[1] . "</td>";


                    } else {
                        $promediotallers['nota'] = 0;
                        $promediotallers['coef'] = 1;
                        $promediotallers['tiempo'] = 2;
                        $promediotallers['idAsignatura'] = $listaasignaturanoinciden[$i]["idAsignaturaTaller"];
                        $promediotallers['forma'] = $listaasignaturanoinciden[$i]["forma"];
                        $promediotallers['porcentaje'] = $listaasignaturanoinciden[$i]["porcentaje"];
                        $taller[$y] .= "<td class='prom'>-</td>";
                        $promediofns = 0;
                    }

                    //Promedio Final Taller
                    if ($promediofn != 0 && $promediofns != 0) {
                        if ($detalleest[0]['aproxAnual'] == 1) {
                            $promediofnfinal = round(($promediofn + $promediofns) / 2);
                        } else {
                            $promediofnfinal = intval(($promediofn + $promediofns) / 2);
                        }

                    }
                    if ($promediofn == 0 && $promediofns != 0) {
                        $promediofnfinal = $promediofns;
                    }
                    if ($promediofn != 0 && $promediofns == 0) {
                        $promediofnfinal = $promediofn;
                    }
                    if ($promediofn == 0 && $promediofns == 0) {
                        $promediofnfinal = 0;
                    }
                    if ($promediofnfinal != 0) {
                        $promediocortado = str_split($promediofnfinal);
                        $taller[$y] .= "<td>" . $promediocortado[0] . ',' . $promediocortado[1] . "</td>";
                    } else {
                        $taller[$y] .= "<td>-</td>";
                    }

                    $taller[$y] .= "</tr>";

                    //Cechekeamos a que tipo pertenece la asignatura de destino del taller
                    if (!empty($listaasignaturanoinciden[$i]["idAsignaturaTaller"])) {
                        $datosdestino = $modelasignatura->getdestino($listaasignaturanoinciden[$i]["idAsignaturaTaller"]);

                        if ($datosdestino[0]['tipoAsignatura'] == 4) {

                            $tablanotas2[] = $promediotaller;
                            $tablanotas2segundo[] = $promediotallers;
                        } else {

                            $tablanotas[] = $promediotaller;
                            $tablanotas[] = $promediotallers;
                        }
                    }
                }

            }

            //Notas de Asignaturas que pertenecen a una combinada

            if ($largocombinada != 0) {
                $largotablanota2 = count($tablanotas2);
                $largotablanota2segundo = count($tablanotas2segundo);


                for ($i = 0; $i < $largocombinada; $i++) {

                    $setasignatura = unserialize($datosasignaturascombinada[$i]['asignaturas']);

                    for ($k = 0; $k < count($setasignatura); $k++) {
                        $cuentan = 0;
                        $promedion = 0;
                        $cuentansegundo = 0;
                        $promedionsegundo = 0;
                        $notatallercom = 0;
                        $porcentajetallercom = 0;
                        $notatallercomsegundo = 0;
                        $porcentajetallercomsegundo = 0;
                        $cuenta2 = array();
                        $datocombinada = $modelasignatura->getnombre($setasignatura[$k]);


                        $combinada[$y] .= "<tr><td class='celda'>" . $datocombinada[0]["nombreAsignatura"] . "</td>";

                        //Primer Semestre
                        for ($j = 0; $j < $largotablanota2; $j++) {
                            if ($datocombinada[0]["idAsignatura"] == $tablanotas2[$j]["idAsignatura"]) {


                                if ($tablanotas2[$j]['coef'] == 2) {
                                    if ($tablanotas2[$j]['nota'] != '0') {
                                        $promedion = $promedion + ($tablanotas2[$j]['nota'] + $tablanotas2[$j]['nota']);
                                        $cuentan = $cuentan + 2;


                                    }

                                } else {


                                    if ($tablanotas2[$j]['nota'] != '0') {


                                        if (empty($tablanotas2[$j]['forma'])) {
                                            $promedion += $tablanotas2[$j]['nota'];
                                            $cuentan += 1;

                                        } else {

                                            if ($tablanotas2[$j]['forma'] == 1) {
                                                $promedion += $tablanotas2[$j]['nota'];
                                                $cuentan += 1;
                                            }
                                            if ($tablanotas2[$j]['forma'] == 2) {
                                                $porcentajetallercom = $tablanotas2[$j]['porcentaje'];
                                                $notatallercom = $tablanotas2[$j]['nota'];
                                            }
                                        }


                                    } else {
                                        if (empty($tablanotas2[$j]['forma'])) {

                                        } else {
                                            if ($tablanotas2[$j]['forma'] == 2) {
                                                $porcentajetallercom = $tablanotas2[$j]['porcentaje'];
                                                $notatallercom = 0;
                                            }


                                        }
                                    }


                                }

                            }

                        }


                        //Segundo Semestre
                        for ($j = 0; $j < $largotablanota2segundo; $j++) {
                            if ($datocombinada[0]["idAsignatura"] == $tablanotas2segundo[$j]["idAsignatura"]) {
                                if ($tablanotas2segundo[$j]['coef'] == 2) {
                                    if ($tablanotas2segundo[$j]['nota'] != '0') {
                                        $promedionsegundo += ($tablanotas2segundo[$j]['nota'] + $tablanotas2segundo[$j]['nota']);
                                        $cuentansegundo += 2;

                                    }


                                } else {


                                    if ($tablanotas2segundo[$j]['nota'] != '0') {

                                        if (empty($tablanotas2segundo[$j]['forma'])) {
                                            $promedionsegundo += $tablanotas2segundo[$j]['nota'];
                                            $cuentansegundo += 1;
                                        } else {

                                            if ($tablanotas2segundo[$j]['forma'] == 1) {
                                                $promedionsegundo += $tablanotas2segundo[$j]['nota'];
                                                $cuentansegundo += 1;
                                            }
                                            if ($tablanotas2segundo[$j]['forma'] == 2) {
                                                $porcentajetallercomsegundo = $tablanotas2segundo[$j]['porcentaje'];
                                                $notatallercomsegundo = $tablanotas2segundo[$j]['nota'];
                                            }
                                        }


                                    } else {
                                        if (empty($tablanotas2segundo[$j]['forma'])) {

                                        } else {
                                            if ($tablanotas2segundo[$j]['forma'] == 2) {
                                                $porcentajetallercomsegundo = $tablanotas2segundo[$j]['porcentaje'];
                                                $notatallercomsegundo = 0;
                                            }


                                        }
                                    }


                                }

                            }

                        }


                        //sacamos el promedio de la asignatura Primer Semestre


                        if ($promedion > 0 || $cuentan > 0) {

                            if ($detalleest[0]['aproxAsignatura'] == 1) {

                                //nuevo Promedio con taller
                                if (empty($notatallercom)) {
                                    $promediofn = round($promedion / $cuentan);


                                } else {
                                    $porcentajecom = 100 - $porcentajetallercom;
                                    $promediofn = (round($promedion / $cuentan)) * ($porcentajecom / 100) + ($notatallercom * ($porcentajetallercom / 100));
                                    $promediofn = round($promediofn);

                                }


                                //Fin Taller
                                $promediocombinada['nota'] = $promediofn;
                                $promediocombinada['coef'] = 1;
                                $promediocombinada['tiempo'] = 1;
                                $datoasignatura = $modelasignatura->getnombre($datosasignaturascombinada[$i]["idAsignaturaCurso"]);
                                $promediocombinada['idAsignatura'] = $datoasignatura[0]["idAsignatura"];


                            } else {

                                //Nuevo Promedio con Taller
                                if (empty($notatallercom)) {
                                    $promediofn = intval($promedion / $cuentan);
                                } else {
                                    $porcentajecom = 100 - $porcentajetallercom;
                                    $promediofn = (round($promedion / $cuentan)) * ($porcentajecom / 100) + ($notatallercom * ($porcentajetallercom / 100));
                                    $promediofn = intval($promediofn);
                                }
                                //Fin Taller
                                $promediocombinada['nota'] = $promediofn;
                                $promediocombinada['coef'] = 1;
                                $promediocombinada['tiempo'] = 1;
                                $datoasignatura = $modelasignatura->getnombre($datosasignaturascombinada[$i]["idAsignaturaCurso"]);
                                $promediocombinada['idAsignatura'] = $datoasignatura[0]["idAsignatura"];


                            }
                            $combinada[$y] .= "<td class='prom'>" . $promediofn . "</td></tr>";


                        } else {
                            $promediocombinada['nota'] = 0;
                            $promediocombinada['coef'] = 1;
                            $promediocombinada['tiempo'] = 1;
                            $datoasignatura = $modelasignatura->getnombre($datosasignaturascombinada[$i]["idAsignaturaCurso"]);
                            $promediocombinada['idAsignatura'] = $datoasignatura[0]["idAsignatura"];

                        }

                        //sacamos el promedio de la asignatura Segundo Semestre


                        if ($promedionsegundo > 0 || $cuentansegundo > 0) {


                            if ($detalleest[0]['aproxAsignatura'] == 1) {
                                //nuevo Promedio con taller
                                if (empty($notatallercomsegundo)) {
                                    $promediofnsegundo = round($promedionsegundo / $cuentansegundo);

                                } else {
                                    $porcentajecomsegundo = 100 - $porcentajetallercomsegundo;
                                    $promediofnsegundo = (round($promedionsegundo / $cuentansegundo)) * ($porcentajecomsegundo / 100) + ($notatallercomsegundo * ($porcentajetallercomsegundo / 100));
                                    $promediofnsegundo = round($promediofnsegundo);

                                }


                                //Fin Taller
                                $promediocombinadasegundo['nota'] = $promediofnsegundo;
                                $promediocombinadasegundo['coef'] = 1;
                                $promediocombinadasegundo['tiempo'] = 2;
                                $datoasignatura = $modelasignatura->getnombre($datosasignaturascombinada[$i]["idAsignaturaCurso"]);
                                $promediocombinadasegundo['idAsignatura'] = $datoasignatura[0]["idAsignatura"];


                            } else {

                                //Nuevo Promedio con Taller
                                if (empty($notatallercomsegundo)) {
                                    $promediofnsegundo = intval($promedionsegundo / $cuentansegundo);
                                } else {
                                    $porcentajecomsegundo = 100 - $porcentajetallercomsegundo;
                                    $promediofnsegundo = (round($promedionsegundo / $cuentansegundo)) * ($porcentajecomsegundo / 100) + ($notatallercomsegundo * ($porcentajetallercomsegundo / 100));
                                    $promediofnsegundo = intval($promediofnsegundo);
                                }
                                //Fin Taller
                                $promediocombinadasegundo['nota'] = $promediofnsegundo;
                                $promediocombinadasegundo['coef'] = 1;
                                $promediocombinadasegundo['tiempo'] = 2;
                                $datoasignatura = $modelasignatura->getnombre($datosasignaturascombinada[$i]["idAsignaturaCurso"]);
                                $promediocombinadasegundo['idAsignatura'] = $datoasignatura[0]["idAsignatura"];


                            }
                            $combinada[$y] .= "<td class='prom'>" . $promediofn . "</td></tr>";


                        } else {
                            $promediocombinadasegundo['nota'] = 0;
                            $promediocombinadasegundo['coef'] = 1;
                            $promediocombinadasegundo['tiempo'] = 1;
                            $datoasignatura = $modelasignatura->getnombre($datosasignaturascombinada[$i]["idAsignaturaCurso"]);
                            $promediocombinadasegundo['idAsignatura'] = $datoasignatura[0]["idAsignatura"];

                        }
                        //Promedio Final Asignatura Combinada
                        if ($promediofn != 0 && $promediofnsegundo != 0) {
                            if ($detalleest[0]['aproxAnual'] == 1) {
                                $promediofnfinal = round(($promediofn + $promediofnsegundo) / 2);
                            } else {
                                $promediofnfinal = intval(($promediofn + $promediofnsegundo) / 2);
                            }

                        }
                        if ($promediofn == 0 && $promediofnsegundo != 0) {
                            $promediofnfinal = $promediofnsegundo;
                        }
                        if ($promediofn != 0 && $promediofnsegundo == 0) {
                            $promediofnfinal = $promediofn;
                        }
                        if ($promediofn == 0 && $promediofnsegundo == 0) {
                            $promediofnfinal = 0;
                        }
                        if ($promediofnfinal != 0) {
                            $promediocortado = str_split($promediofnfinal);
                            $combinada[$y] .= "<td>" . $promediocortado[0] . ',' . $promediocortado[1] . "</td>";
                        } else {

                            $combinada[$y] .= "<td>-</td>";
                        }

                        $combinada[$y] .= "</tr>";

                        $tablanotas[] = $promediocombinada;
                        $tablanotas[] = $promediocombinadasegundo;

                    }
                }


            }


            $largotablanota = count($tablanotas);

            //Asignaturas Conceptos


            if ($largoconcepto != 0) {
                for ($i = 0; $i < $largoconcepto; $i++) {
                    $resultado[$i] = $modelasignatura->getasignaturaconcepto($listaasignaturaconcepto[$i]["idAsignatura"], $idcursoactual, $idperiodo);

                    $cuentan = 0;
                    $promedion = 0;
                    $promediof = 0;
                    $cuenta2 = array();
                    $concepto[$y] .= "<tr><td class='celda'>" . $listaasignaturaconcepto[$i]["nombreAsignatura"] . "</td>";
                    $cuenta2[$i] = 0;
                    for ($l = 0; $l < count($resultado[$i]); $l++) {
                        $listaconceptos[$i][$resultado[$i][$l]['notaconcepto']] = $resultado[$i][$l]['concepto'];
                        $listaconceptospromedio[$i][$l] = array($resultado[$i][$l]['desde'], $resultado[$i][$l]['hasta'], $resultado[$i][$l]['concepto']);

                    }


                    for ($j = 0; $j < $largotablanota2segundo; $j++) {
                        if ($listaasignaturaconcepto[$i]["idAsignatura"] == $tablanotas2segundo[$j]["idAsignatura"]) {


                            if ($tablanotas2segundo[$j]['coef'] == 2) {
                                if ($tablanotas2segundo[$j]['nota'] != '0') {

                                    for ($l = 0; $l < count($listaconceptospromedio[$i]); $l++) {
                                        if ($tablanotas2segundo[$j]['nota'] >= $listaconceptospromedio[$i][$l][0] && $tablanotas2segundo[$j]['nota'] <= $listaconceptospromedio[$i][$l][1]) {
                                            $promediofnconcepto = $listaconceptospromedio[$i][$l][2];


                                        }

                                    }


                                    $promedion = $promedion + ($tablanotas2segundo[$j]['nota'] + $tablanotas2segundo[$j]['nota']);
                                    $cuentan = $cuentan + 2;

                                } else {

                                }


                            } else {

                                if ($tablanotas2segundo[$j]['nota'] != '0') {
                                    for ($l = 0; $l < count($listaconceptospromedio[$i]); $l++) {
                                        if ($tablanotas2segundo[$j]['nota'] >= $listaconceptospromedio[$i][$l][0] && $tablanotas2segundo[$j]['nota'] <= $listaconceptospromedio[$i][$l][1]) {
                                            $promediofnconcepto = $listaconceptospromedio[$i][$l][2];
                                            // $concepto[$y] .= "<td>" . $listaconceptospromedio[$i][$l][2] . "</td>";

                                        }

                                    }


                                    $promedion = $promedion + $tablanotas2segundo[$j]['nota'];
                                    $cuentan = $cuentan + 1;

                                } else {
                                    //$concepto[$y] .= "<td>-</td>";

                                }


                            }

                        }

                    }


                    //sacamos el promedio de la asignatura


                    if ($promedion > 0 || $cuentan > 0) {

                        if ($detalleest[0]['aproxAsignatura'] == 1) {
                            $promediofn = round($promedion / $cuentan);


                        } else {
                            $promediofn = intval($promedion / $cuentan);


                        }
                        for ($l = 0; $l < count($listaconceptospromedio[$i]); $l++) {
                            if ($promediofn >= $listaconceptospromedio[$i][$l][0] && $promediofn <= $listaconceptospromedio[$i][$l][1]) {
                                $promediofnconcepto = $listaconceptospromedio[$i][$l][2];

                            }

                        }
                        $concepto[$y] .= "<td class='prom'>-</td>";
                        $concepto[$y] .= "<td class='prom'>" . $promediofnconcepto . "</td>";
                        $concepto[$y] .= "<td class='prom'>" . $promediofnconcepto . "</td>";

                        $concepto[$y] .= "</tr>";

                    } else {
                        $concepto[$y] .= "<td class='prom'>-</td>";
                        $concepto[$y] .= "<td class='prom'>-</td>";
                        $concepto[$y] .= "<td class='prom'>-</td>";

                        $concepto[$y] .= "</tr>";
                    }


                }

            }


            //Formato del rut

            $rutset = $listadealumnos[$y]['rutAlumno'];
            if (!empty($rutset)) {

                $rest = substr($rutset, 0, -1);
                $ultimo = substr($rutset, -1);
                $formatomiles = number_format($rest, 0, "", ".");
                $formatofinal = $formatomiles . '-' . $ultimo;

            }


            $nombrecompleto = $listadealumnos[$y]['nombres'] . ' ' . $listadealumnos[$y]['apaterno'] . ' ' . $listadealumnos[$y]['amaterno'];
            $nombrecompleto = strtoupper($nombrecompleto);

            $recuperando2 = new Zend_Session_Namespace('nombreperiodo');

            // variables para encabezado
            $titulo = "CERTIFICADO ANUAL DE ESTUDIOS " . $recuperando2->nombreperiodo;
            $tituloest = "<b>" . $detalleest[0]['nombreEstablecimiento'] . "</b>";
            $descripcion = "Reconocido Oficialmente por el Ministerio de Educación de la República de Chile, según Resolución Exenta de Educación Nº " . $detalleest[0]['numeroDecreto'] . " del año " . $detalleest[0]['yeardecreto'] . ". Rol Base de Datos Nº " . $detalleest[0]['rbd'] . ", otorga el presente Informe Educacional a:";
            $alumno = 'Don(a): <span style=" text-decoration: underline;">' . $nombrecompleto . '</span> RUN: <span style=" text-decoration: underline;">' . $formatofinal . '</span> Alumno(a) de <b>' . $detalleest[0]['nombreGrado'] . ' ' . $detalleest[0]['letra'] . ' de ' . $nombreedu . '</b>, de Acuerdo a Decreto Plan de Estudio ' . $nombredecreto . ' y del Reglamento de Evaluación y Promoción Escolar ' . $nombreexento . '';
            $logo = getcwd();
            $logo .= "/application/documentos/logos/" . $detalleest[0]['extension'];
            if (file_exists($logo)) {
                $encabezado = '<p style="position:absolute;top:3px;text-align:center"><img  src="' . $logo . '" /></p><h5 style="position:absolute;top:110px;text-align:center">' . $titulo . '</h5><h4 style="position:absolute;top:130px;text-align:center">' . $tituloest . '</h4>'
                    . '<p style="margin-top:20px; text-align:left;">' . $descripcion . '</p>'

                    . '<p style="margin-top:1px; text-align:left;">' . $alumno . '</p>';
            } else {
                $encabezado = '<p style="position:absolute;top:3px;text-align:center"></p><h5 style="position:absolute;top:110px;text-align:center">' . $titulo . '</h5><h4 style="position:absolute;top:130px;text-align:center">' . $tituloest . '</h4>'
                    . '<p style="margin-top:20px; text-align:left;">' . $descripcion . '</p>'

                    . '<p style="margin-top:1px; text-align:left;">' . $alumno . '</p>';
            }

            $html[$y] = '';
            $html[$y] .= $encabezado;


            if ($largotablaaux < 1) {
                $html[$y] .= "<table  align='center' border='1'><tr><th style='width:25%'>Asignaturas</th><th style='width:65%'>" . $nombresegmento . "</th><th style='width:10%'>Promedio</th></tr>";
                $html[$y] .= "<tr><td colspan='3'>Sin Notas en éste periodo</td></tr>";
            } else {


                if ($detalleest[0]['monitoreo'] == 1) {

                    if ($detalleest[0]['idEstablecimiento'] == 12) {
                        $html[$y] .= "<table align='center' border='1'><tr><th style='width:65%' rowspan='2'>Asignaturas</th><th style='width:6%'>SEM I</th><th style='width:6%'>SEM II</th><th style='width:6%'>PROM</th><th style='width:6%'>%</th><th style='width:6%'>NIVEL</th></tr><tr><th>I</th><th>II</th><th>ANUAL</th><th>LOGRO</th><th>LOGRO</th></tr>";;

                    } elseif ($detalleest[0]['idEstablecimiento'] == 8) {
                        $html[$y] .= "<table align='center' border='1'><tr><th style='width:57%' rowspan='2'>Asignaturas</th><th style='width:6%' colspan='2'>SEM I</th><th style='width:6%' colspan='2'>SEM II</th><th style='width:6%'>PROM</th><th style='width:6%'>%</th><th style='width:6%'>NIVEL</th></tr><tr><th>PROM</th><th>%</th><th>PROM</th><th>%</th><th>ANUAL</th><th>LOGRO</th><th>APREN</th></tr>";;

                    } else {
                        $html[$y] .= "<table align='center' border='1'><tr><th style='width:70%' rowspan='2'>Asignaturas</th><th style='width:10%'>SEM I</th><th style='width:10%'>SEM II</th><th style='width:10%'>PROM</th></tr><tr><th>I</th><th>II</th><th>ANUAL</th></tr>";;

                    }


                } else {

                    $html[$y] .= "<table align='center' border='1'><tr><th style='width:70%' rowspan='2'>Asignaturas</th><th style='width:10%'>SEM I</th><th style='width:10%'>SEM II</th><th style='width:10%'>PROM</th></tr><tr><th>I</th><th>II</th><th>ANUAL</th></tr>";;


                }

                $contadorparcial = 0;
                for ($i = 0; $i < $largoasignatura; $i++) {


                    $cuenta1[$i] = 0;
                    $promedio = 0;
                    $cuenta = 0;
                    $promedios = 0;
                    $cuentas = 0;
                    $auxtexto = "<tr><td class='celda'>" . $listaasignatura[$i]["nombreAsignatura"] . "</td>";

                    //Primer Semestre
                    for ($j = 0; $j < $largotablanota; $j++) {
                        if ($listaasignatura[$i]["idAsignatura"] == $tablanotas[$j]["idAsignatura"]) {


                            if ($tablanotas[$j]['coef'] == 2 && $tablanotas[$j]['tiempo'] == 1) {
                                if ($tablanotas[$j]['nota'] != '0') {
                                    $promedio += ($tablanotas[$j]['nota'] + $tablanotas[$j]['nota']);
                                    $cuenta += 2;

                                }
                                $cuenta1[$i] += 2;

                            }
                            if ($tablanotas[$j]['coef'] < 2 && $tablanotas[$j]['tiempo'] == 1) {

                                if ($tablanotas[$j]['nota'] != '0') {

                                    if (empty($tablanotas[$j]['forma']) && $tablanotas[$j]['tiempo'] == 1) {
                                        $promedio += $tablanotas[$j]['nota'];
                                        $cuenta += 1;
                                        $porcentajetaller = array();
                                        $notataller = array();
                                    } else {

                                        if ($tablanotas[$j]['forma'] == 1 && $tablanotas[$j]['tiempo'] == 1) {
                                            $promedio += $tablanotas[$j]['nota'];
                                            $cuenta += 1;
                                            $porcentajetaller = array();
                                            $notataller = array();
                                        }
                                        if ($tablanotas[$j]['forma'] == 2 && $tablanotas[$j]['tiempo'] == 1) {
                                            $porcentajetaller[] = $tablanotas[$j]['porcentaje'];
                                            $notataller[] = $tablanotas[$j]['nota'];
                                        }
                                    }


                                }

                                $cuenta1[$i] += 1;

                            }

                            //Segundo Semestre
                            if ($tablanotas[$j]['coef'] == 2 && $tablanotas[$j]['tiempo'] == 2) {

                                if ($tablanotas[$j]['nota'] != '0') {
                                    $promedios += ($tablanotas[$j]['nota'] + $tablanotas[$j]['nota']);
                                    $cuentas += 2;

                                }
                                $cuenta1[$i] += 2;

                            }
                            if ($tablanotas[$j]['coef'] < 2 && $tablanotas[$j]['tiempo'] == 2) {

                                if ($tablanotas[$j]['nota'] != '0') {

                                    if (empty($tablanotas[$j]['forma']) && $tablanotas[$j]['tiempo'] == 2) {
                                        $promedios += $tablanotas[$j]['nota'];
                                        $cuentas += 1;
                                        $porcentajetallers = array();
                                        $notatallers = array();
                                    } else {

                                        if ($tablanotas[$j]['forma'] == 1 && $tablanotas[$j]['tiempo'] == 2) {
                                            $promedios += $tablanotas[$j]['nota'];
                                            $cuentas += 1;
                                            $porcentajetallers = array();
                                            $notatallers = array();
                                        }
                                        if ($tablanotas[$j]['forma'] == 2 && $tablanotas[$j]['tiempo'] == 2) {
                                            $porcentajetallers[] = $tablanotas[$j]['porcentaje'];
                                            $notatallers[] = $tablanotas[$j]['nota'];
                                        }
                                    }


                                }

                                $cuenta1[$i] += 1;

                            }


                        }

                    }


                    //Primer Semestre
                    //sacamos el promedio de la asignatura

                    if ($promedio > 0 || $cuenta > 0) {


                        // si es 1 Aproxima, si es 2 no Aproxima
                        if ($detalleest[0]['aproxAsignatura'] == 1) {
                            if (empty($notataller)) {
                                $promediof = round($promedio / $cuenta);
                            } else {
                                $porcentaje = 100;
                                $resultadoauxtaller = 0;
                                if (count($notataller) > 1) {
                                    for ($t = 0; $t < count($notataller); $t++) {
                                        $porcentaje = $porcentaje - $porcentajetaller[$t];
                                        $resultadoauxtaller += ($notataller[$t] * ($porcentajetaller[$t] / 100));

                                    }
                                    $promediof = (round($promedio / $cuenta)) * ($porcentaje / 100) + $resultadoauxtaller;

                                } else {
                                    $porcentaje = $porcentaje - $porcentajetaller[0];
                                    $promediof = (round($promedio / $cuenta)) * ($porcentaje / 100) + ($notataller[0] * ($porcentajetaller[0] / 100));
                                    $promediof = round($promediof);
                                }


                            }

                        } else {
                            if (empty($notataller)) {
                                $promediof = intval($promedio / $cuenta);
                            } else {
                                $porcentaje = 100;
                                $resultadoauxtaller = 0;
                                if (count($notataller) > 1) {
                                    for ($t = 0; $t < count($notataller); $t++) {
                                        $porcentaje = $porcentaje - $porcentajetaller[$t];
                                        $resultadoauxtaller += ($notataller[$t] * ($porcentajetaller[$t] / 100));

                                    }
                                    $promediof = (round($promedio / $cuenta)) * ($porcentaje / 100) + $resultadoauxtaller;
                                    $promediof = intval($promediof);
                                } else {
                                    $porcentaje = $porcentaje - $porcentajetaller[0];
                                    $promediof = (round($promedio / $cuenta)) * ($porcentaje / 100) + ($notataller[0] * ($porcentajetaller[0] / 100));
                                    $promediof = intval($promediof);
                                }
                            }


                        }

                        if ($promediof == 0) {
                            $auxtexto .= "<td>-</td>";
                            if ($detalleest[0]['idEstablecimiento'] == 8) {

                                $auxtexto .= "<td>0%</td>";

                            }
                        } else {
                            $promediocortado = str_split($promediof);
                            $auxtexto .= "<td>" . $promediocortado[0] . ',' . $promediocortado[1] . "</td>";
                            if ($detalleest[0]['idEstablecimiento'] == 8) {

                                $devuelve = $this->equivalencias($lista_equivalencia, $promediof);
                                $auxtexto .= "<td>" . $devuelve[0] . "%</td>";

                            }
                        }


                    } else {

                        $promediof = 0;
                        if ($detalleest[0]['idEstablecimiento'] == 8) {
                            $auxtexto .= "<td>-</td>";

                        }
                        $auxtexto .= "<td>-</td>";
                    }

                    //Segundo Semestre

                    if ($promedios > 0 || $cuentas > 0) {


                        // si es 1 Aproxima, si es 2 no Aproxima
                        if ($detalleest[0]['aproxAsignatura'] == 1) {
                            if (empty($notatallers)) {
                                $promediofs = round($promedios / $cuentas);
                            } else {
                                $porcentajes = 100;
                                $resultadoauxtallers = 0;
                                if (count($notatallers) > 1) {
                                    for ($t = 0; $t < count($notatallers); $t++) {
                                        $porcentajes = $porcentajes - $porcentajetallers[$t];
                                        $resultadoauxtallers += ($notatallers[$t] * ($porcentajetallers[$t] / 100));

                                    }
                                    $promediofs = (round($promedios / $cuentas)) * ($porcentajes / 100) + $resultadoauxtallers;

                                } else {
                                    $porcentajes = $porcentajes - $porcentajetallers[0];
                                    $promediofs = (round($promedios / $cuentas)) * ($porcentajes / 100) + ($notatallers[0] * ($porcentajetallers[0] / 100));
                                    $promediofs = round($promediofs);
                                }


                            }

                        } else {
                            if (empty($notatallers)) {
                                $promediofs = intval($promedios / $cuentas);
                            } else {
                                $porcentajes = 100;
                                $resultadoauxtallers = 0;
                                if (count($notatallers) > 1) {
                                    for ($t = 0; $t < count($notatallers); $t++) {
                                        $porcentajes = $porcentajes - $porcentajetallers[$t];
                                        $resultadoauxtallers += ($notatallers[$t] * ($porcentajetallers[$t] / 100));

                                    }
                                    $promediofs = (round($promedios / $cuentas)) * ($porcentajes / 100) + $resultadoauxtallers;
                                    $promediofs = intval($promediofs);
                                } else {
                                    $porcentajes = $porcentajes - $porcentajetallers[0];
                                    $promediofs = (round($promedios / $cuentas)) * ($porcentajes / 100) + ($notatallers[0] * ($porcentajetallers[0] / 100));
                                    $promediofs = intval($promediofs);
                                }
                            }


                        }

                        $promediocortados = str_split($promediofs);

                        $auxtexto .= "<td>" . $promediocortados[0] . ',' . $promediocortados[1] . "</td>";
                        if ($detalleest[0]['idEstablecimiento'] == 8) {

                            $devuelve = $this->equivalencias($lista_equivalencia, $promediofs);
                            $auxtexto .= "<td>" . $devuelve[0] . "%</td>";

                        }

                    } else {
                        $promediofs = 0;
                        if ($detalleest[0]['idEstablecimiento'] == 8) {
                            $auxtexto .= "<td>-</td>";

                        }
                        $auxtexto .= "<td>-</td>";
                    }


                    //Promedio Final
                    if ($promediof != 0 && $promediofs != 0) {

                        if ($detalleest[0]['aproxAnual'] == 1) {
                            $promedioffinal = round(($promediof + $promediofs) / 2);
                            $contadorparcial += 1;
                            if ($promedioffinal == 39 && $detalleest[0]['rbd'] == '1864') {
                                $promedioffinal = 40;
                            }
                        } else {
                            $promedioffinal = intval(($promediof + $promediofs) / 2);
                            $contadorparcial += 1;
                            if ($promedioffinal == 39 && $detalleest[0]['rbd'] == '1864') {
                                $promedioffinal = 40;
                            }
                        }

                    }
                    if ($promediof == 0 && $promediofs != 0) {
                        $promedioffinal = $promediofs;
                        $contadorparcial += 1;
                    }
                    if ($promediof != 0 && $promediofs == 0) {
                        $promedioffinal = $promediof;
                        $contadorparcial += 1;
                    }
                    if ($promediof == 0 && $promediofs == 0) {
                        $promedioffinal = 0;
                    }
                    if ($promedioffinal == 0) {
                        //$html[$y] .= "<td class='prom'>-</td>";
                    } else {

                        if ($agregadecimas) {
                            if ($promedioffinal >= 60) {
                                $promedioffinal += 2;
                                if ($promedioffinal > 70) {
                                    $promedioffinal = 70;

                                }

                            }
                        }

                        //Asignamos el examen si es que pertenece

                        $promediocortadosf = str_split($promedioffinal);

                        $auxtexto .= "<td>" . $promediocortadosf[0] . ',' . $promediocortadosf[1] . "</td>";
                        if ($detalleest[0]['monitoreo'] == 1) {

                            if ($detalleest[0]['idEstablecimiento'] == 12 || $detalleest[0]['idEstablecimiento'] == 8) {

                                $devuelve = $this->equivalencias($lista_equivalencia, $promedioffinal);
                                $auxtexto .= "<td>" . $devuelve[0] . "%</td>";
                                $auxtexto .= "<td>" . $devuelve[1] . "</td>";
                            }


                        }
                        $html[$y] .= $auxtexto;
                        $html[$y] .= "</tr>";
                    }


                    $promedioparcial += $promedioffinal;


                }//Fin asignaturas

                $promedioparcialfinal = 0;

                if ($promedioparcial > 0 && $contadorparcial > 0) {

                    // si es 1 Aproxima,si es 2 no Aproxima
                    if ($detalleest[0]['aproxFinal'] == 1) {
                        $promedioparcialfinal = round($promedioparcial / $contadorparcial);
                    } else {
                        $promedioparcialfinal = intval($promedioparcial / $contadorparcial);
                    }


                    $promediocortadoparcial = str_split($promedioparcialfinal);


                    if ($detalleest[0]['monitoreo'] == 1) {

                        if ($detalleest[0]['idEstablecimiento'] == 12) {

                            $devuelvef = $this->equivalencias($lista_equivalencia, $promedioparcialfinal);

                            $html[$y] .= "<tr><td style='text-align:left' colspan='3'><b>PROMEDIO GENERAL</b></td><td>" . $promediocortadoparcial[0] . ',' . $promediocortadoparcial[1] . "</td><td>" . $devuelvef[0] . "%</td><td>" . $devuelvef[1] . "</td></tr>";
                        } elseif ($detalleest[0]['idEstablecimiento'] == 8) {

                            $devuelvef = $this->equivalencias($lista_equivalencia, $promedioparcialfinal);

                            $html[$y] .= "<tr><td style='text-align:left' colspan='5'><b>PROMEDIO GENERAL</b></td><td>" . $promediocortadoparcial[0] . ',' . $promediocortadoparcial[1] . "</td><td>" . $devuelvef[0] . "%</td><td>" . $devuelvef[1] . "</td></tr>";

                        } elseif ($detalleest[0]['idEstablecimiento'] == 7) {//GREDA
                            $html[$y] .= "<tr><td style='text-align:left' colspan='3'><b>PROMEDIO GENERAL</b></td><td>" . $promediocortadoparcial[0] . ',' . $promediocortadoparcial[1] . "</td></tr>";

                            $html[$y] .= $concepto[$y];

                        } else {
                            $html[$y] .= "<tr><td style='text-align:left' colspan='3'><b>PROMEDIO GENERAL</b></td><td>" . $promediocortadoparcial[0] . ',' . $promediocortadoparcial[1] . "</td></tr>";


                        }


                    } else {
                        $html[$y] .= "<tr><td style='text-align:left' colspan='3'><b>PROMEDIO GENERAL</b></td><td>" . $promediocortadoparcial[0] . ',' . $promediocortadoparcial[1] . "</td></tr>";
                    }
                } else {
                    //$html[$y] .= "<tr><td style='text-align:left' colspan='3'>PROMEDIO GENERAL</td><td>-</td></tr>";
                }

                if ($detalleest[0]['idCodigo'] == 110 && ($detalleest[0]['idGrado'] >= 1 && $detalleest[0]['idGrado'] < 5)) {
                    // $html[$y] .= $taller[$y];
                }

            }


            $detallealumno = $modeloalumnodetalle->listardetalleperiodo($listadealumnos[$y]['idAlumnosActual'], 1, $idperiodo);
            $detallealumnos = $modeloalumnodetalle->listardetalleperiodo($listadealumnos[$y]['idAlumnosActual'], 2, $idperiodo);
            $diasin = $detallealumno[0]['diasInasistencia'] + $detallealumnos[0]['diasInasistencia'];
            $diastrabajados = $detallealumno[0]['diasTrabajado'] + $detallealumnos[0]['diasTrabajado'];
            $atraso = $detallealumno[0]['numeroatrasos'] + $detallealumnos[0]['numeroatrasos'];
            $apoderadoprimer = $detallealumno[0]['nombreApoderado'];
            $apoderadosegundo = $detallealumnos[0]['nombreApoderado'];
            $apoderado = '';
            if (empty($apoderadoprimer) && !empty($apoderadosegundo)) {
                $apoderado = $apoderadosegundo;
            } else {
                $apoderado = $apoderadoprimer;
            }


            if ($diasin != 0 && $diastrabajados > 0) {
                $valor = $diasin / $diastrabajados;
                $aux = 1 - $valor;
                $total = $aux * 100;
            } elseif (($diasin == 0 || $diasin == '') && $diastrabajados > 0) {
                $valor = $diasin / $diastrabajados;
                $aux = 1 - $valor;
                $total = $aux * 100;
            } else {
                $total = 0;
            }

            $periodo = new Zend_Session_Namespace('nombreperiodo');
            $nombreperiodo = $periodo->nombreperiodo;


            $html[$y] .= "</table>


 <table align='center' style='margin-top:10px;'>
            <tr>
            <td style='width: 20%; text-align: center;'>Periodo/Asistencia</td>
            <td style='width: 20%; text-align: right;'>Nº de Días Trabajados</td>
            <td style='width: 20%; text-align: center;'>Nº Días de Inasistencia</td>
            <td style='width: 20%; text-align: center;'> % de Asistencia</td>
            <td style='width: 20%; text-align: center;'>Nº de Atrasos</td>
            </tr>

            <tr>
            <td style='width: 20%; height:2%; text-align: center;'>" . $nombreperiodo . "</td>
            <td style='width: 20%; text-align: center;'>" . $diastrabajados . "</td>
            <td style='width: 20%; text-align: center;'>" . $diasin . "</td>
            <td style='width: 20%; text-align: center;'>" . intval($total) . "&#37;</td>
            <td style='width: 20%; text-align: center;'>" . $atraso . "</td>
            </tr>



            </table>

            <table>
            <tr>
            <td style='width:100%;text-align: left;'>Observaciones:</td>
            </tr>
            <tr>
            <td style='width:100%;height:7%;text-align:left;'>" . $observacion . "</td>
            </tr>
            </table>";

            if ($monitoreo == 1 && $detalleest[0]['idEstablecimiento'] == 8) {

                //Simbologia
                $html[$y] .= "<table><tr><td style='width:30%;text-align: center;'>Nivel de Aprendizaje</td><td style='width:70%;text-align: center;'>Descripción</td></tr>";

                for ($n = 0; $n < count($lista_niveles); $n++) {
                    $html[$y] .= "<tr><td style='width:30%;text-align:left;'><b>" . $lista_niveles[$n]['nivelLogro'] . "</b></td><td style='width:70%;text-align:left;'>" . $lista_niveles[$n]['descripcionLogro'] . "</td></tr>";
                }
                $html[$y] .= "</table>";

            }

            $cadenaobservacion = trim($observacion);

//            if (!empty($observacion) && strlen($cadenaobservacion) > 0) {
//                $html[$y] .= "<table><tr><td style='width:100%;text-align: left;'>Observaciones:</td></tr><tr><td style='width:100%;height:4%;text-align:left;'>" . $observacion . "</td></tr></table>";
//            }

            $valoresprofesor = unserialize($detalleest[0]['profesor']);
            if ($valoresprofesor[2] == 1) {
                $tdnombreprofesor = "<p style='text-decoration:underline;margin-left:30px;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</p>";
                $tdprofesor = "Profesor(a) Jefe.";
            } else {
                $tdnombreprofesor = "";
                $tdprofesor = "";
            }

            $valoresdirector = unserialize($detalleest[0]['director']);
            if ($valoresdirector[2] == 1) {
                $tdnombredirector = "<p style='text-decoration:underline;'>" . $director['nombrescuenta'] . " " . $director['paternocuenta'] . " " . $director['maternocuenta'] . "</p>";
                $tddirector = "Director(a).";
            } else {
                $tdnombredirector = "";
                $tddirector = "";
            }


            $valoresapoderado = unserialize($detalleest[0]['apoderado']);
            if ($valoresapoderado[2] == 1) {
                $tdnombreapoderado = "<p style='text-decoration:underline;'> " . $apoderado . "</p>";
                $tdapoderado = "Nombre y Firma de Apoderado.";
            } else {
                $tdnombreapoderado = "";
                $tdapoderado = "";
            }


            $html[$y] .= "<table align='center' style='margin-top:25px;' class='page_firmas'>
            <tr>
                <td style='width: 33%; text-align: center;border:none;'>" . $tdnombreprofesor . "</td>
                <td style='width: 33%; text-align: center;border:none;'>" . $tdnombreapoderado . "</td>
                <td style='width: 33%; text-align: center;border:none;'>" . $tdnombredirector . "</td>
            </tr>
            <tr>
                <td style='width: 33%; text-align:center;border:none;padding-top:35px'>" . $tdprofesor . "</td>
                <td style='width: 33%; text-align: center;border:none;padding-top:35px'>" . $tdapoderado . "</td>
                <td style='width: 33%; text-align:center;border:none;padding-top:35px'>" . $tddirector . "</td>
            </tr>
            <tr>
                <td colspan='3' style='text-align:center;border:none;padding-top:15px'>" . $fecha_final . ".</td>
            </tr>
            </table>";

        } //fin largo alumnos


        if ($html != '') {

            require('fpdf/html2pdf.class.php');
            try {
                //Orientación / formato del pdf y el idioma.
                $pdf = new HTML2PDF('P', 'LETTER', 'es', array(10, 10, 10, 10) /*márgenes*/); //los márgenes también pueden definirse en <page> ver documentación
                for ($j = 0; $j < count($html); $j++) {
                    $pdf->WriteHTML('<page><html>
        <head>
            <style>' . $style . '</style>
        </head>
        <body> <page_footer>
        <table class="page_footer">
            <tr>
            <td style="width: 40%; text-align: left;border:none;"></td>
                <td style="width: 60%; text-align: right;border:none;font-size:8px">

                </td>
            </tr>
        </table>
    </page_footer>' . $html[$j] . '</body></html></page>');
                }

                if (preg_match("/MSIE/i", $_SERVER["HTTP_USER_AGENT"])) {
                    header("Content-type: application/PDF");
                } else {
                    header("Content-type: application/PDF");
                    header("Content-Type: application/pdf");
                }

                $pdf->Output('Planificacion.pdf', I);
            } catch (HTML2PDF_exception $e) {
                //echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, intente nuevamente\");</script>";
                //echo "<script>parent.$.fancybox.close();</script>";
                echo $e;
            }
        }


    }

    function equivalencias($lista_equivalencia, $nota)
    {


        $valor_nota = 0;
        $numeros = array();
        $escala = array();
        $largo = count($lista_equivalencia);
        if ($largo > 0) {

            for ($i = 0; $i < $largo; $i++) {

                $numeros[$i] = range($lista_equivalencia[$i]['porcentaje_final'], $lista_equivalencia[$i]['porcentaje_inicio']);
                $step = (count(range($lista_equivalencia[$i]['equivalencia_nota'], $lista_equivalencia[$i + 1]['equivalencia_nota'] + 1)) / count($numeros[$i]));
                for ($j = 0; $j < count($numeros[$i]); $j++) {
                    if ($j == 0) {
                        if ($lista_equivalencia[$i]['equivalencia_nota'] == $nota) {
                            $valor_nota = array($numeros[$i][$j], $lista_equivalencia[$i]['nivelLogro']);
                            break;
                        }
                        $escala[$i][$j] = $lista_equivalencia[$i]['equivalencia_nota'];
                    } else {
                        $aux_nota = $escala[$i][$j - 1];

                        if (($aux_nota - $step) == $nota) {
                            $valor_nota = array($numeros[$i][$j], $lista_equivalencia[$i]['nivelLogro']);
                            break;
                        } elseif (round($aux_nota - $step) == $nota) {
                            $valor_nota = array($numeros[$i][$j], $lista_equivalencia[$i]['nivelLogro']);
                            break;
                        }
                        $escala[$i][$j] = $aux_nota - $step;
                    }

                }

            }

        }

        return $valor_nota;


    }

    function equivalencias_notas($lista_equivalencia, $porcentaje)
    {


        $valor_nota = 0;
        $largo = count($lista_equivalencia);
        if ($largo > 0) {

            foreach ($lista_equivalencia as $h => $valor) {
                if (($porcentaje >= $valor['porcentaje_inicio']) && ($porcentaje <= $valor['porcentaje_final'])) {
                    $valor_nota = $valor['equivalencia_nota'];
                    break;

                }
            }

        }

        return $valor_nota;


    }


    public function generaralumnocursoanualprecAction()
    {

        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();

        $paso = true;
        //debe venir un parametro, por GET o POST, llamado idasignatura, con el id del Asignatura a borrar
        $id = $this->_getParam('id', 0);
        $tipo = $this->_getParam('t', 0);
        $segmento = $this->_getParam('s', 0);

        if ($paso) {

            $style = "body{
            
font-size:10px;font: Arial, Tahoma, Verdana, Helvetica, sans-serif;
color:#000;
}

#infoizq{

position:absolute;
top: 2%;
left: 40%;
width:30%;
}
h5{
  padding:0;
}

#infoder{

position:absolute;
right:0px;
}

img{
width:90px;
height:100px;

}";

            $periodo = new Zend_Session_Namespace('periodo');
            $idperiodo = $periodo->periodo;

            $idtipoev = new Zend_Session_Namespace('tipoevaluacion');
            $idtevalucacion = $idtipoev->tipoevaluacion;


            $modeloalumnoactual = new Application_Model_DbTable_Alumnosactual();
            $modelcurso = new Application_Model_DbTable_Cursos();
            $modelasignatura = new Application_Model_DbTable_Asignaturascursos();
            $tabla = new Application_Model_DbTable_Notas();
            $modeldetalle = new Application_Model_DbTable_AlumnosDetalle();
            $modelcomuna = new Application_Model_DbTable_Comuna();
            $modelCuenta = new Application_Model_DbTable_Cuentas();
            if ($tipo == 1) {
                $listadealumnos = $modeloalumnoactual->listaralumnoscursoactual($id, $idperiodo);

            } else {
                $listadealumnos = $modeloalumnoactual->get($id);
                $id = $listadealumnos[0]['idCursosActual'];
            }

            $largoalumnos = count($listadealumnos);

            $detalleest = $modelcurso->listarcursoid($id, $idperiodo);
            $niveleducacion = $detalleest[0]['idCodigoGrado'];

            if ($detalleest[0]['idDirector'] == null) {
                echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta director\");</script>";
                echo "<script>parent.$.fancybox.close();</script>";
                exit;
            } else {
                $director = $modelCuenta->get($detalleest[0]['idDirector']);
            }


            if ($detalleest[0]['idCuentaJefe'] == null) {
                echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta Profesor Jefe\");</script>";
                echo "<script>parent.$.fancybox.close();</script>";
                exit;
            } else {
                $Profesorjefe = $modelCuenta->getusuario($detalleest[0]['idCuentaJefe'], $idperiodo);
            }


            if (count($director) == 0) {
                echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta director\");</script>";
                echo "<script>parent.$.fancybox.close();</script>";
                exit;

            }

            if (count($Profesorjefe) == 0 || $Profesorjefe == null) {
                echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta Profesor Jefe\");</script>";
                echo "<script>parent.$.fancybox.close();</script>";
                exit;
            }

            $infoizq = '<div id="infoizq"><h5></h5></div>';
            $logo = getcwd();
            $logo .= "/application/documentos/logos/" . $detalleest[0]['extension'];
            $imagen = getcwd();
            $imagen .= "/application/documentos/logos/imagen.jpg";
            if (file_exists($logo)) {
                $encabezado = '<p style="position:absolute;top:3%;text-align:left"></p><p style="position:absolute;top:3%;text-align:center"><img  src="' . $logo . '" /></p>' . $infoizq . '<h3 style="position:absolute;top:170px;text-align:center">' . $detalleest[0]['nombreEstablecimiento'] . '</h3>';

            } else {
                $encabezado = '<p style="position:absolute;top:3%;text-align:left"></p><p style="position:absolute;top:3%;text-align:center"></p>' . $infoizq . '<h3 style="position:absolute;top:170px;text-align:center">' . $detalleest[0]['nombreEstablecimiento'] . '</h3>';

            }

            $meses = array("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre");
            if ($detalleest[0]['idEstablecimiento'] == 7) {
                $datosasignaturas = $modelasignatura->listarporcursopregreda($id, $idperiodo);
                $modeloequivalencia = new Application_Model_DbTable_Equivalencia();
                $segmentos=$segmento;
                if($idtevalucacion==1 && $segmento==0){
                    $segmentos=2;
                }elseif ($idtevalucacion==2 && $segmento==0){
                    $segmentos=5;
                }
                $lista_equivalencia = $modeloequivalencia->listarperiodo($detalleest[0]['idEstablecimiento'], $idperiodo, $segmentos);
            } else {
                $datosasignaturas = $modelasignatura->listarporcursopre($id, $idperiodo);
            }
            $listambitos = $modelasignatura->listaragrupar($id, $idperiodo, 1);

            if (count($listambitos) == 3) {
                $nucleosuno = $modelasignatura->listarnucleoporambito($listambitos[0]['idAmbito']);
                $nucleosdos = $modelasignatura->listarnucleoporambito($listambitos[1]['idAmbito']);
                $nucleostres = $modelasignatura->listarnucleoporambito($listambitos[2]['idAmbito']);
            }


            $largoasignatura = count($datosasignaturas);
            $largonucleouno = count($nucleosuno);
            $largonucleodos = count($nucleosdos);
            $largonucleotres = count($nucleostres);


            for ($y = 0; $y < $largoalumnos; $y++) {

                $alumnoactual = array();
                $tabla2 = array();
                $detallecurso = array();
                $tablanotasprimer = array();
                $tablanotassegundo = array();
                $tablanotastercero = array();
                $detallecomuna = array();
                $detallealumnoprimer = array();
                $detallealumnosegundo = array();
                $detallealumnotercero = array();
                $detallealumno = array();
                $promedioprimer = array();
                $promediosegundo = array();
                $promediotercero = array();
                $promediofinal = array();
                $primers = array();
                $segundos = array();
                $finals = array();
                $observacionprimer = '';
                $observacionsegundo = '';
                $observacion = '';


                $alumnoactual = $modeloalumnoactual->get($listadealumnos[$y]['idAlumnosActual']);
                $idalumnoactual = $alumnoactual[0]['idAlumnos'];
                $idalumnoactual2 = $alumnoactual[0]['idAlumnosActual'];
                $idcursoactual = $alumnoactual[0]['idCursosActual'];
                $tabla2 = $tabla->generanotasalumnobasicapre($idalumnoactual, $idperiodo, $idcursoactual);


                //lista Asignaturas del alumno


                if (!empty($alumnoactual[0]['comuna'])) {
                    $detallecomuna = $modelcomuna->getcomuna($alumnoactual[0]['comuna']);
                } else {
                    $detallecomuna = 0;
                }

                if ($niveleducacion == '4') {
                    $nombreedu = 'Primer Nivel de Transición';

                }

                if ($niveleducacion == '5') {
                    $nombreedu = 'Segundo Nivel de Transición';

                }


                //Conceptos
                $asignaturamodelo = new Application_Model_DbTable_Asignaturascursos();
                $resultado = $asignaturamodelo->getconceptosparvularia($idcursoactual);

                //RQM 42
                if ($detalleest[0]['idEstablecimiento'] == 7) {

                    $resultado[0] = array('concepto' => 'IT', 'descripcionConcepto' => 'Instalado');
                    $resultado[1] = array('concepto' => 'AV', 'descripcionConcepto' => 'Avanzado');
                    $resultado[2] = array('concepto' => 'IN', 'descripcionConcepto' => 'Incipienteo');
                }
                $largoresultado = count($resultado);

                //Fecha nacimiento
                $fechana = $alumnoactual[0]['fechanacimiento'];
                $cortado2 = explode("-", $fechana);
                if (count($cortado2) > 0) {
                    if (checkdate($cortado2[1], $cortado2[2], $cortado2[0])) {
                        $fecha_final_nac = $cortado2[2] . " de " . $meses[date('n', mktime(0, 0, 0, $cortado2[1], $cortado2[2], $cortado2[0])) - 1] . " del " . date('Y', mktime(0, 0, 0, $cortado2[1], $cortado2[2], $cortado2[0]));
                    } else {
                        $fecha_final_nac = 'Sin Datos';
                    }
                } else {
                    $fecha_final_nac = 'Sin Datos';
                }

                $html_notas[$y][0] = $encabezado;

                switch ($segmento){
                    case '1':
                        $detallealumnoprimer = $modeldetalle->listardetalleperiodo($idalumnoactual2, 1, $idperiodo);
                        $detallealumnosegundo = array();
                        $detallealumno = array();
                        break;

                    case '2':
                        $detallealumnoprimer = $modeldetalle->listardetalleperiodo($idalumnoactual2, 1, $idperiodo);
                        $detallealumnosegundo = $modeldetalle->listardetalleperiodo($idalumnoactual2, 2, $idperiodo);
                        $detallealumno = $modeldetalle->listardetalleperiodo($idalumnoactual2, 10, $idperiodo);
                        break;


                    case '3':
                        $detallealumnoprimer = $modeldetalle->listardetalleperiodo($idalumnoactual2, 3, $idperiodo);
                        $detallealumnosegundo = array();
                        $detallealumnotercero = array();
                        $detallealumno = array();
                        break;

                    case '4':
                        $detallealumnoprimer = $modeldetalle->listardetalleperiodo($idalumnoactual2, 3, $idperiodo);
                        $detallealumnosegundo = $modeldetalle->listardetalleperiodo($idalumnoactual2, 4, $idperiodo);
                        $detallealumnotercero = array();
                        $detallealumno = array();
                        break;

                    case '5':
                        $detallealumnoprimer = $modeldetalle->listardetalleperiodo($idalumnoactual2, 3, $idperiodo);
                        $detallealumnosegundo = $modeldetalle->listardetalleperiodo($idalumnoactual2, 4, $idperiodo);
                        $detallealumnotercero = $modeldetalle->listardetalleperiodo($idalumnoactual2, 5, $idperiodo);
                        $detallealumno = $modeldetalle->listardetalleperiodo($idalumnoactual2, 10, $idperiodo);
                        break;



                }




                if (count($detallealumnoprimer) > 0) {
                    $diasinprimer = $detallealumnoprimer[0]['diasInasistencia'];
                    $diastrabajadosprimer = $detallealumnoprimer[0]['diasTrabajado'];
                    $atrasoprimer = $detallealumnoprimer[0]['numeroatrasos'];
                    $observacionprimer = $detallealumnoprimer[0]['observaciones'];
                    if ($diasinprimer != 0 && $diastrabajadosprimer > 0) {
                        $valor = $diasinprimer / $diastrabajadosprimer;
                        $aux = 1 - $valor;
                        $total = $aux * 100;
                    } elseif (($diasinprimer == 0 || $diasinprimer == '') && $diastrabajadosprimer > 0) {
                        $valor = $diasinprimer / $diastrabajadosprimer;
                        $aux = 1 - $valor;
                        $total = $aux * 100;
                    } else {
                        $diasinprimer = 0;
                        $diastrabajadosprimer = 0;
                        $atrasoprimer = 0;
                        $total = 0;
                    }
                } else {
                    $observacionprimer = 'Sin Observaciones';
                    $diasinprimer = 0;
                    $diastrabajadosprimer = 0;
                    $atrasoprimer = 0;
                    $total = 0;
                }


                if (count($detallealumnosegundo) > 0) {
                    $diasinsegundo = $detallealumnosegundo[0]['diasInasistencia'];
                    $diastrabajadossegundo = $detallealumnosegundo[0]['diasTrabajado'];
                    $atrasosegundo = $detallealumnosegundo[0]['numeroatrasos'];
                    $observacionsegundo = $detallealumnosegundo[0]['observaciones'];
                    if ($diasinsegundo != 0 && $diastrabajadossegundo > 0) {
                        $valorsegundo = $diasinsegundo / $diastrabajadossegundo;
                        $auxs = 1 - $valorsegundo;
                        $totals = $auxs * 100;
                    } elseif (($diasinsegundo == 0 || $diasinsegundo == '') && $diastrabajadossegundo > 0) {
                        $valorsegundo = $diasinsegundo / $diastrabajadossegundo;
                        $auxs = 1 - $valorsegundo;
                        $totals = $auxs * 100;
                    } else {
                        $diasinsegundo = 0;
                        $diastrabajadossegundo = 0;
                        $atrasosegundo = 0;
                        $totals = 0;
                    }
                } else {
                    $observacionsegundo = 'Sin Observaciones';
                    $diasinsegundo = 0;
                    $diastrabajadossegundo = 0;
                    $atrasosegundo = 0;
                    $totals = 0;
                }

                if (count($detallealumnotercero) > 0) {
                    $diasintercero = $detallealumnotercero[0]['diasInasistencia'];
                    $diastrabajadostercero = $detallealumnotercero[0]['diasTrabajado'];
                    $atrasotercero = $detallealumnotercero[0]['numeroatrasos'];
                    $observaciontercero = $detallealumnotercero[0]['observaciones'];
                    if ($diasintercero != 0 && $diastrabajadostercero > 0) {
                        $valortercero = $diasintercero / $diastrabajadostercero;
                        $auxs = 1 - $valortercero;
                        $totalt = $auxs * 100;
                    } elseif (($diasintercero == 0 || $diasintercero == '') && $diastrabajadostercero > 0) {
                        $valortercero = $diasintercero / $diastrabajadostercero;
                        $auxs = 1 - $valortercero;
                        $totalt = $auxs * 100;
                    } else {
                        $diasintercero = 0;
                        $diastrabajadostercero = 0;
                        $atrasotercero = 0;
                        $totalt = 0;
                    }
                } else {
                    $observaciontercero = 'Sin Observaciones';
                    $diasintercero = 0;
                    $diastrabajadostercero = 0;
                    $atrasotercero = 0;
                    $totalt = 0;
                }

                $largodetallealumno = count($detallealumno);
                if (count($detallealumno) > 0) {
                    $diasin = $diasinprimer + $diasinsegundo;
                    $diastrabajados = $diastrabajadosprimer + $diastrabajadossegundo;
                    $atraso = $detallealumno[0]['numeroatrasos'];
                    $observacion = $detallealumno[0]['observaciones'];
                    if ($diasin != 0 && $diastrabajados > 0) {
                        $valorf = $diasin / $diastrabajados;
                        $auxf = 1 - $valorf;
                        $totalf = $auxf * 100;
                    } elseif (($diasin == 0 || $diasin == '') && $diastrabajados > 0) {
                        $valorf = $diasin / $diastrabajados;
                        $auxf = 1 - $valorf;
                        $totalf = $auxf * 100;
                    } else {
                        $totalf = 0;
                    }
                } else {
                    $observacion = 'Sin Observaciones';
                    $totalf = 0;
                }


                $periodo = new Zend_Session_Namespace('nombreperiodo');
                $nombreperiodo = $periodo->nombreperiodo;

                $html_notas[$y][0] .= "<div style='width:100%;border: 1px double #000;outline: 2px solid #699;outline-offset: -9px;text-align:center; margin:35px 0 0px 0; height:730px;'>
  <h3 style='text-align:center'>INFORME</h3>
  <h3 style='text-align:center'>Evaluación de Aprendizajes</h3>
  <h4 style='text-align:center'>¿Qué ha aprendido mi hijo o hija?</h4>
  <p style='text-align:center'>Año: " . $nombreperiodo . "</p>
      <table style='width:98%;border:none;margin:25px 5px 5px 5px;padding:5px;'>
        <tr>
          <td style='width:19%; text-align:left;border:none;'>Nombre de Alumno(a)</td>
          <td colspan='3' style='width:69%; text-align:left;border:none;'>" . $listadealumnos[$y]['nombres'] . " " . $listadealumnos[$y]['apaterno'] . " " . $listadealumnos[$y]['amaterno'] . "</td>
        </tr>

        <tr>
          <td  style='width:18%; text-align:left;border:none;'>Fecha Nacimiento:</td>
          <td colspan='3' style='width:70%; text-align:left;border:none;'>" . $fecha_final_nac . "</td>
        </tr>

         <tr>
          <td style='width:18%; text-align:left;border:none;'>Educadora:</td>
          <td colspan='3' style='width:70%; text-align:left;border:none;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</td>
        </tr>

        <tr>
          <td style='width:15%; text-align:left;border:none;'>Comuna:</td>
          <td style='width:34%; text-align:left;border:none;;
         '>" . $detallecomuna[0]['nombreComuna'] . "</td>
          <td style='width:7%; text-align:left;border:none;'>Región:</td>
          <td style='width:42%; text-align:left;border:none;'>" . $detallecomuna[0]['nombreRegion'] . "</td>
        </tr>
      </table>";



       if($idtevalucacion==1){

           $html_notas[$y][0] .="<table border='1' cellspacing='0' cellpadding='0' style='width:98%;margin:35px 5px 25px 5px;padding:5px;border-collapse:collapse;'>
        <tr>
          <th style='width:30%;' rowspan=2>ASISTENCIA</th>
          <th style='width:38%;' colspan=2>SEMESTRES</th>
          <th style='width:30%;' rowspan=2>TOTAL</th>
        </tr>
        <tr>

          <th>1º</th>
          <th>2º</th>

        </tr>

        <tr>
        <td style='text-align:left;'>Días de Clases</td>
        <td>" . $diastrabajadosprimer . "</td>
        <td>" . $diastrabajadossegundo . "</td>
        <td>" . ($diastrabajadosprimer + $diastrabajadossegundo) . "</td>
        </tr>

        <tr>
        <td style='text-align:left;'>Días de Inasistencia</td>
        <td>" . $diasinprimer . "</td>
        <td>" . $diasinsegundo . "</td>
        <td>" . ($diasinprimer + $diasinsegundo) . "</td>
        </tr>

        <tr>
        <td style='text-align:left;'>Porcentaje de Asistencia</td>
        <td>" . intval($total) . "%</td>
        <td>" . intval($totals) . "%</td>
        <td>" . intval($totalf) . "%</td>
        </tr>
      </table>";

       }elseif($idtevalucacion==2){

           $html_notas[$y][0] .="<table border='1' cellspacing='0' cellpadding='0' style='width:98%;margin:35px 5px 25px 5px;padding:5px;border-collapse:collapse;'>
        <tr>
          <th style='width:30%;' rowspan=2>ASISTENCIA</th>
          <th style='width:38%;' colspan=3>Trimestres</th>
          <th style='width:30%;' rowspan=2>TOTAL</th>
        </tr>
        <tr>

          <th>1º</th>
          <th>2º</th>
          <th>3º</th>

        </tr>

        <tr>
        <td style='text-align:left;'>Días de Clases</td>
        <td>" . $diastrabajadosprimer . "</td>
        <td>" . $diastrabajadossegundo . "</td>
        <td>" . $diastrabajadostercero . "</td>
        <td>" . ($diastrabajadosprimer + $diastrabajadossegundo+ $diastrabajadostercero) . "</td>
        </tr>

        <tr>
        <td style='text-align:left;'>Días de Inasistencia</td>
        <td>" . $diasinprimer . "</td>
        <td>" . $diasinsegundo . "</td>
        <td>" . $diasintercero . "</td>
        <td>" . ($diasinprimer + $diasinsegundo+ $diasintercero) . "</td>
        </tr>

        <tr>
        <td style='text-align:left;'>Porcentaje de Asistencia</td>
        <td>" . intval($total) . "%</td>
        <td>" . intval($totals) . "%</td>
        <td>" . intval($totalt) . "%</td>
        <td>" . intval($totalf) . "%</td>
        </tr>
      </table>";

       }

      $html_notas[$y][0] .="<h3 style='align-content: center'>" . $nombreedu . "</h3>
      <img  width='400' height='200' src='" . $imagen . "' /></div>";

                $html_notas[$y][1] = "<h3 style='text-align:center;margin-top:20px'>" . $listambitos[0]['nombreAmbito'] . "</h3>";
                if ($listambitos[0]['idAmbito'] > 3) {
                    $html_notas[$y][1] .= "<table align=center style='width:100%; margin-top:20px;'><tr><td style='width: 95%;'>" . $listambitos[0]['descripcionAmbito'] . "</td></tr></table>";

                }
                for ($k = 0; $k < $largonucleouno; $k++) {

                    if ($listambitos[0]['idAmbito'] > 3) {
                        $html_notas[$y][1] .= "<table align=center style='width:100%; margin-top:5px;'><tr><td><h5>" . $nucleosuno[$k]['nombreNucleo'] . "</h5></td></tr><tr><td style='width: 95%;'>" . $nucleosuno[$k]['descripcionNucleo'] . "</td></tr></table>";
                    }

                    if($idtevalucacion==1){
                        $html_notas[$y][1] .= "<table border=1 align=center style='width:95%; margin-top:25px;border-collapse:collapse;'><tr><td><h5>" . $nucleosuno[$k]['nombreNucleo'] . "</h5></td><td style='text-align:center;'>1er Semestre</td><td style='text-align:center;'>2do Semestre</td><td style='text-align:center;'>Informe Final</td></tr>";

                    }else{
                        $html_notas[$y][1] .= "<table border=1 align=center style='width:95%; margin-top:25px;border-collapse:collapse;'><tr><td><h5>" . $nucleosuno[$k]['nombreNucleo'] . "</h5></td><td style='text-align:center;'>I TRIM</td><td style='text-align:center;'>II TRIM</td><td style='text-align:center;'>III TRIM</td><td style='text-align:center;'>Final</td></tr>";

                    }

                    // RQM 42

                    if ($detalleest[0]['idEstablecimiento'] == 7) {

                        for ($j = 0; $j < $largoasignatura; $j++) {

                            if ($datosasignaturas[$j]['idNucleo'] == $nucleosuno[$k]['idNucleo']) {

                                if ($segmento == 1) {

                                    $promedioprimer[$j] = $tabla->getnotaspresegmentogreda($idalumnoactual, $idperiodo, 1, $datosasignaturas[$j]['idNucleo'], $idcursoactual);
                                    $promediosegundo[$j] = array();

                                } elseif($segmento==2) {

                                    $promedioprimer[$j] = $tabla->getnotaspresegmentogreda($idalumnoactual, $idperiodo, 1, $datosasignaturas[$j]['idNucleo'], $idcursoactual);
                                    $promediosegundo[$j] = $tabla->getnotaspresegmentogreda($idalumnoactual, $idperiodo, 2, $datosasignaturas[$j]['idNucleo'], $idcursoactual);

                                }elseif($segmento==3){
                                    $promedioprimer[$j] = $tabla->getnotaspresegmentogreda($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idNucleo'], $idcursoactual);
                                    $promediosegundo[$j] = array();
                                    $promediotercero[$j] = array();

                                }elseif($segmento==4){
                                    $promedioprimer[$j] = $tabla->getnotaspresegmentogreda($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idNucleo'], $idcursoactual);
                                    $promediosegundo[$j] = $tabla->getnotaspresegmentogreda($idalumnoactual, $idperiodo, 4, $datosasignaturas[$j]['idNucleo'], $idcursoactual);
                                    $promediotercero[$j] = array();
                                }elseif($segmento==5 || $segmento==0){
                                    $promedioprimer[$j] = $tabla->getnotaspresegmentogreda($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idNucleo'], $idcursoactual);
                                    $promediosegundo[$j] = $tabla->getnotaspresegmentogreda($idalumnoactual, $idperiodo, 4, $datosasignaturas[$j]['idNucleo'], $idcursoactual);
                                    $promediotercero[$j] = $tabla->getnotaspresegmentogreda($idalumnoactual, $idperiodo, 5, $datosasignaturas[$j]['idNucleo'], $idcursoactual);
                                }



                                $primers[$j]=$this->getpromediopre($promedioprimer[$j],$lista_equivalencia);
                                $segundos[$j]=$this->getpromediopre($promediosegundo[$j],$lista_equivalencia);

                                if($idtevalucacion==2){
                                        $terceros[$j]=$this->getpromediopre($promediotercero[$j],$lista_equivalencia);

                                }else{
                                    $terceros[$j]=0;
                                }


                                if($segmento==0){
                                    $resultado_auxiliar=array();
                                    $promedio_aux=array();
                                    $promedio_aux = array($primers[$j], $segundos[$j], $terceros[$j]);
                                    $resultado_auxiliar = array_values(array_diff($promedio_aux, array('0','')));

                                    if (!empty($resultado_auxiliar)) {

                                        $finals[$j]= round((array_sum($resultado_auxiliar)) / count($resultado_auxiliar));

                                    } else {
                                        $finals[$j]= 0;
                                    }
                                }else{
                                    $finals[$j]=0;
                                }



                                //Convertimos a Concepto
                                $primers[$j]=$this->promedioaconcepto($primers[$j]);
                                $segundos[$j]=$this->promedioaconcepto($segundos[$j]);

                                if($idtevalucacion==2){
                                    $terceros[$j]=$this->promedioaconcepto($terceros[$j]);
                                }
                                $finals[$j]=$this->promedioaconcepto($finals[$j]);

                                $html_notas[$y][1] .= "<tr><td style='width:65%'>Promedios del núcleo: " . $datosasignaturas[$j]['nombreNucleo'] . "</td>";
                                if($idtevalucacion==1){
                                    $html_notas[$y][1] .= "<td style='width:10%;text-align:center;'>" . $primers[$j] . "</td><td style='width:10%;text-align:center;'>" . $segundos[$j] . "</td><td style='width:10%;text-align:center;'>" . $finals[$j] . "</td></tr>";

                                }else{
                                    $html_notas[$y][1] .= "<td style='width:10%;text-align:center;'>" . $primers[$j] . "</td><td style='width:10%;text-align:center;'>" . $segundos[$j] . "</td><td style='width:10%;text-align:center;'>" . $terceros[$j] . "</td><td style='width:10%;text-align:center;'>" . $finals[$j] . "</td></tr>";

                                }

                            }
                        }

                    } else {

                        for ($j = 0; $j < $largoasignatura; $j++) {
                            if ($datosasignaturas[$j]['idNucleo'] == $nucleosuno[$k]['idNucleo']) {
                                $html_notas[$y][1] .= "<tr><td style='width:65%'>" . $datosasignaturas[$j]['nombreAsignatura'] . "</td>";

                                if ($segmento == 1) {
                                    $promedioprimer[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 1, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                    $promediosegundo[$j] = array();
                                } elseif($segmento==2) {
                                    $promedioprimer[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 1, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                    $promediosegundo[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 2, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);

                                }elseif($segmento==3) {
                                    $promedioprimer[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                    $promediosegundo[$j] = array();
                                    $promediotercero[$j] = array();

                                }elseif($segmento==4) {
                                    $promedioprimer[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                    $promediosegundo[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 4, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                    $promediotercero[$j] = array();

                                }elseif($segmento==5) {
                                    $promedioprimer[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                    $promediosegundo[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 4, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                    $promediotercero[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 5, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);

                                }

                                if ($largodetallealumno > 0) {

                                    if($idtevalucacion==1){
                                        $promedioprimer[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 1, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                        $promediosegundo[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 2, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                        $promediofinal[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 2, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                    }else{
                                        $promedioprimer[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                        $promediosegundo[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 4, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                        $promediotercero[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 5, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                        $promediofinal[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 5, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                    }

                                } else {
                                    $promediofinal[$j][0]['nota'] = '';
                                }


                                if ($promedioprimer[$j][0]['nota'] == null) {
                                    $primers[$j] = '';
                                }

                                if ($promediosegundo[$j][0]['nota'] == null) {
                                    $segundos[$j] = '';

                                }

                                if ($promediotercero[$j][0]['nota'] == null) {
                                    $terceros[$j] = '';

                                }

                                if ($promediofinal[$j][0]['nota'] == null) {
                                    $finals[$j] = '';

                                }


                                for ($l = 0; $l < $largoresultado; $l++) {
                                    //Primer
                                    if ($resultado[$l]['notaConcepto'] == $promedioprimer[$j][0]['nota']) {
                                        $primers[$j] = $resultado[$l]['concepto'];

                                    }
                                    //Segundo
                                    if ($resultado[$l]['notaConcepto'] == $promediosegundo[$j][0]['nota']) {
                                        $segundos[$j] = $resultado[$l]['concepto'];

                                    }

                                    //Tercero
                                    if ($resultado[$l]['notaConcepto'] == $promediotercero[$j][0]['nota']) {
                                        $terceros[$j] = $resultado[$l]['concepto'];

                                    }
                                    //Final
                                    if ($resultado[$l]['notaConcepto'] == $promediofinal[$j][0]['nota']) {
                                        $finals[$j] = $resultado[$l]['concepto'];

                                    }

                                }


                                if($idtevalucacion==1){
                                    $html_notas[$y][1] .= "<td style='width:10%;text-align:center;'>" . $primers[$j] . "</td><td style='width:10%;text-align:center;'>" . $segundos[$j] . "</td><td style='width:10%;text-align:center;'>" . $finals[$j] . "</td></tr>";


                                }elseif($idtevalucacion==2){
                                    $html_notas[$y][1] .= "<td style='width:8%;text-align:center;'>" . $primers[$j] . "</td><td style='width:8%;text-align:center;'>" . $segundos[$j] . "</td><td style='width:8%;text-align:center;'>" . $terceros[$j] . "</td><td style='width:8%;text-align:center;'>" . $finals[$j] . "</td></tr>";

                                }

                            }

                        } //fin for datosasignaturas
                    }


                    $html_notas[$y][1] .= "</table>";

                }//Fin Nucleos




                $html_notas[$y][2] = "<h3 style='text-align:center;margin-top:20px'>" . $listambitos[1]['nombreAmbito'] . "</h3>";
                if ($listambitos[1]['idAmbito'] > 3) {
                    $html_notas[$y][2] .= "<table align=center style='width:100%; margin-top:20px;'><tr><td style='width: 95%;'>" . $listambitos[1]['descripcionAmbito'] . "</td></tr></table>";
                }
                for ($k = 0; $k < $largonucleodos; $k++) {
                    if ($listambitos[1]['idAmbito'] > 3) {
                        $html_notas[$y][2] .= "<table align=center style='width:100%; margin-top:5px;'><tr><td><h5>" . $nucleosdos[$k]['nombreNucleo'] . "</h5></td></tr><tr><td style='width: 95%;'>" . $nucleosdos[$k]['descripcionNucleo'] . "</td></tr></table>";
                    }
                    if($idtevalucacion==1){
                        $html_notas[$y][2] .= "<table border=1 align=center style='width:95%; margin-top:25px;border-collapse:collapse;'><tr><td><h5>" . $nucleosdos[$k]['nombreNucleo'] . "</h5></td><td style='text-align:center;'>1er Semestre</td><td style='text-align:center;'>2do Semestre</td><td style='text-align:center;'>Informe Final</td></tr>";

                    }else{
                        $html_notas[$y][2] .= "<table border=1 align=center style='width:95%; margin-top:25px;border-collapse:collapse;'><tr><td><h5>" . $nucleosdos[$k]['nombreNucleo'] . "</h5></td><td style='text-align:center;'>I TRIM</td><td style='text-align:center;'>II TRIM</td><td style='text-align:center;'>III TRIM</td><td style='text-align:center;'>Final</td></tr>";

                    }

                    // RQM 42
                    if ($detalleest[0]['idEstablecimiento'] == 7) {

                        for ($j = 0; $j < $largoasignatura; $j++) {

                            if ($datosasignaturas[$j]['idNucleo'] == $nucleosdos[$k]['idNucleo']) {

                                if ($segmento == 1) {

                                    $promedioprimer[$j] = $tabla->getnotaspresegmentogreda($idalumnoactual, $idperiodo, 1, $datosasignaturas[$j]['idNucleo'], $idcursoactual);
                                    $promediosegundo[$j] = array();

                                } elseif($segmento==2) {

                                    $promedioprimer[$j] = $tabla->getnotaspresegmentogreda($idalumnoactual, $idperiodo, 1, $datosasignaturas[$j]['idNucleo'], $idcursoactual);
                                    $promediosegundo[$j] = $tabla->getnotaspresegmentogreda($idalumnoactual, $idperiodo, 2, $datosasignaturas[$j]['idNucleo'], $idcursoactual);

                                }elseif($segmento==3){
                                    $promedioprimer[$j] = $tabla->getnotaspresegmentogreda($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idNucleo'], $idcursoactual);
                                    $promediosegundo[$j] = array();
                                    $promediotercero[$j] = array();

                                }elseif($segmento==4){
                                    $promedioprimer[$j] = $tabla->getnotaspresegmentogreda($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idNucleo'], $idcursoactual);
                                    $promediosegundo[$j] = $tabla->getnotaspresegmentogreda($idalumnoactual, $idperiodo, 4, $datosasignaturas[$j]['idNucleo'], $idcursoactual);
                                    $promediotercero[$j] = array();

                                }elseif($segmento==5 || $segmento==0){
                                    $promedioprimer[$j] = $tabla->getnotaspresegmentogreda($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idNucleo'], $idcursoactual);
                                    $promediosegundo[$j] = $tabla->getnotaspresegmentogreda($idalumnoactual, $idperiodo, 4, $datosasignaturas[$j]['idNucleo'], $idcursoactual);
                                    $promediotercero[$j] = $tabla->getnotaspresegmentogreda($idalumnoactual, $idperiodo, 5, $datosasignaturas[$j]['idNucleo'], $idcursoactual);
                                }


                                    $primers[$j]=$this->getpromediopre($promedioprimer[$j],$lista_equivalencia);
                                    $segundos[$j]=$this->getpromediopre($promediosegundo[$j],$lista_equivalencia);


                                if($idtevalucacion==2){

                                        $terceros[$j]=$this->getpromediopre($promediotercero[$j],$lista_equivalencia);

                                }else{
                                    $terceros[$j]=0;
                                }

                                if($segmento==0){
                                    $resultado_auxiliar=array();
                                    $promedio_aux=array();
                                    $promedio_aux = array($primers[$j], $segundos[$j], $terceros[$j]);
                                    $resultado_auxiliar = array_values(array_diff($promedio_aux, array('0')));

                                    if (!empty($resultado_auxiliar)) {

                                        $finals[$j]= round((array_sum($resultado_auxiliar)) / count($resultado_auxiliar));

                                    } else {
                                        $finals[$j]= 0;
                                    }
                                }


                                //Convertimos a Concepto
                                $primers[$j]=$this->promedioaconcepto($primers[$j]);
                                $segundos[$j]=$this->promedioaconcepto($segundos[$j]);

                                if($idtevalucacion==2){

                                    $terceros[$j]=$this->promedioaconcepto($terceros[$j]);
                                }

                                $finals[$j]=$this->promedioaconcepto($finals[$j]);


                                $html_notas[$y][2] .= "<tr><td style='width:65%'>Promedios del núcleo: " . $datosasignaturas[$j]['nombreNucleo'] . "</td>";
                                if($idtevalucacion==1){
                                    $html_notas[$y][2] .= "<td style='width:10%;text-align:center;'>" . $primers[$j] . "</td><td style='width:10%;text-align:center;'>" . $segundos[$j] . "</td><td style='width:10%;text-align:center;'>" . $finals[$j] . "</td></tr>";

                                }else{
                                    $html_notas[$y][2] .= "<td style='width:10%;text-align:center;'>" . $primers[$j] . "</td><td style='width:10%;text-align:center;'>" . $segundos[$j] . "</td><td style='width:10%;text-align:center;'>" . $terceros[$j] . "</td><td style='width:10%;text-align:center;'>" . $finals[$j] . "</td></tr>";

                                }

                            }
                        }

                    } else {
                        for ($j = 0; $j < $largoasignatura; $j++) {
                            if ($datosasignaturas[$j]['idNucleo'] == $nucleosdos[$k]['idNucleo']) {
                                $html_notas[$y][2] .= "<tr><td style='width:65%'>" . $datosasignaturas[$j]['nombreAsignatura'] . "</td>";

                                if ($segmento == 1) {
                                    $promedioprimer[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 1, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                    $promediosegundo[$j] = array();
                                } elseif($segmento==2) {
                                    $promedioprimer[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 1, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                    $promediosegundo[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 2, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);

                                }elseif($segmento==3) {
                                    $promedioprimer[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                    $promediosegundo[$j] = array();
                                    $promediotercero[$j] = array();

                                }elseif($segmento==4) {
                                    $promedioprimer[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                    $promediosegundo[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 4, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                    $promediotercero[$j] = array();

                                }elseif($segmento==5) {
                                    $promedioprimer[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                    $promediosegundo[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 4, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                    $promediotercero[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 5, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);

                                }

                                if ($largodetallealumno > 0) {

                                    if($idtevalucacion==1){
                                        $promedioprimer[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 1, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                        $promediosegundo[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 2, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                        $promediofinal[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 2, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                    }else{
                                        $promedioprimer[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                        $promediosegundo[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 4, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                        $promediotercero[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 5, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                        $promediofinal[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 5, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                    }

                                } else {
                                    $promediofinal[$j][0]['nota'] = '';
                                }


                                if ($promedioprimer[$j][0]['nota'] == null) {
                                    $primers[$j] = '';
                                }

                                if ($promediosegundo[$j][0]['nota'] == null) {
                                    $segundos[$j] = '';

                                }

                                if ($promediotercero[$j][0]['nota'] == null) {
                                    $terceros[$j] = '';

                                }

                                if ($promediofinal[$j][0]['nota'] == null) {
                                    $finals[$j] = '';

                                }


                                for ($l = 0; $l < $largoresultado; $l++) {
                                    //Primer
                                    if ($resultado[$l]['notaConcepto'] == $promedioprimer[$j][0]['nota']) {
                                        $primers[$j] = $resultado[$l]['concepto'];

                                    }
                                    //Segundo
                                    if ($resultado[$l]['notaConcepto'] == $promediosegundo[$j][0]['nota']) {
                                        $segundos[$j] = $resultado[$l]['concepto'];

                                    }

                                    //Tercero
                                    if ($resultado[$l]['notaConcepto'] == $promediotercero[$j][0]['nota']) {
                                        $terceros[$j] = $resultado[$l]['concepto'];

                                    }
                                    //Final
                                    if ($resultado[$l]['notaConcepto'] == $promediofinal[$j][0]['nota']) {
                                        $finals[$j] = $resultado[$l]['concepto'];

                                    }

                                }


                                if($idtevalucacion==1){
                                    $html_notas[$y][2] .= "<td style='width:10%;text-align:center;'>" . $primers[$j] . "</td><td style='width:10%;text-align:center;'>" . $segundos[$j] . "</td><td style='width:10%;text-align:center;'>" . $finals[$j] . "</td></tr>";


                                }elseif($idtevalucacion==2){
                                    $html_notas[$y][2] .= "<td style='width:8%;text-align:center;'>" . $primers[$j] . "</td><td style='width:8%;text-align:center;'>" . $segundos[$j] . "</td><td style='width:8%;text-align:center;'>" . $terceros[$j] . "</td><td style='width:8%;text-align:center;'>" . $finals[$j] . "</td></tr>";

                                }

                            }

                        } //fin for datosasignaturas
                    }
                    $html_notas[$y][2] .= "</table>";
                }


                $html_notas[$y][3] = "<h3 style='text-align:center;margin-top:15px'>" . $listambitos[2]['nombreAmbito'] . "</h3>";
                if ($listambitos[2]['idAmbito'] > 3) {
                    $html_notas[$y][3] .= "<table align=center style='width:100%; margin-top:10px;'><tr><td style='width: 95%;'>" . $listambitos[2]['descripcionAmbito'] . "</td></tr></table>";
                }
                for ($k = 0; $k < $largonucleotres; $k++) {
                    if ($listambitos[2]['idAmbito'] > 3) {
                        $html_notas[$y][3] .= "<table align=center style='width:100%; margin-top:5px;'><tr><td><h5>" . $nucleostres[$k]['nombreNucleo'] . "</h5></td></tr><tr><td style='width: 95%;'>" . $nucleostres[$k]['descripcionNucleo'] . "</td></tr></table>";
                    }
                    if($idtevalucacion==1){
                        $html_notas[$y][3] .= "<table border=1 align=center style='width:95%; margin-top:25px;border-collapse:collapse;'><tr><td><h5>" . $nucleostres[$k]['nombreNucleo'] . "</h5></td><td style='text-align:center;'>1er Semestre</td><td style='text-align:center;'>2do Semestre</td><td style='text-align:center;'>Informe Final</td></tr>";

                    }else{
                        $html_notas[$y][3] .= "<table border=1 align=center style='width:95%; margin-top:25px;border-collapse:collapse;'><tr><td><h5>" . $nucleostres[$k]['nombreNucleo'] . "</h5></td><td style='text-align:center;'>I TRIM</td><td style='text-align:center;'>II TRIM</td><td style='text-align:center;'>III TRIM</td><td style='text-align:center;'>Final</td></tr>";

                    }

                    // RQM 42
                    if ($detalleest[0]['idEstablecimiento'] == 7) {

                        for ($j = 0; $j < $largoasignatura; $j++) {

                            if ($datosasignaturas[$j]['idNucleo'] == $nucleostres[$k]['idNucleo']) {


                                if ($segmento == 1) {

                                    $promedioprimer[$j] = $tabla->getnotaspresegmentogreda($idalumnoactual, $idperiodo, 1, $datosasignaturas[$j]['idNucleo'], $idcursoactual);
                                    $promediosegundo[$j] = array();

                                } elseif($segmento==2) {

                                    $promedioprimer[$j] = $tabla->getnotaspresegmentogreda($idalumnoactual, $idperiodo, 1, $datosasignaturas[$j]['idNucleo'], $idcursoactual);
                                    $promediosegundo[$j] = $tabla->getnotaspresegmentogreda($idalumnoactual, $idperiodo, 2, $datosasignaturas[$j]['idNucleo'], $idcursoactual);

                                }elseif($segmento==3){
                                    $promedioprimer[$j] = $tabla->getnotaspresegmentogreda($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idNucleo'], $idcursoactual);
                                    $promediosegundo[$j] = array();
                                    $promediotercero[$j] = array();

                                }elseif($segmento==4){
                                    $promedioprimer[$j] = $tabla->getnotaspresegmentogreda($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idNucleo'], $idcursoactual);
                                    $promediosegundo[$j] = $tabla->getnotaspresegmentogreda($idalumnoactual, $idperiodo, 4, $datosasignaturas[$j]['idNucleo'], $idcursoactual);
                                    $promediotercero[$j] = array();
                                }elseif($segmento==5 || $segmento==0){
                                    $promedioprimer[$j] = $tabla->getnotaspresegmentogreda($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idNucleo'], $idcursoactual);
                                    $promediosegundo[$j] = $tabla->getnotaspresegmentogreda($idalumnoactual, $idperiodo, 4, $datosasignaturas[$j]['idNucleo'], $idcursoactual);
                                    $promediotercero[$j] = $tabla->getnotaspresegmentogreda($idalumnoactual, $idperiodo, 5, $datosasignaturas[$j]['idNucleo'], $idcursoactual);
                                }


                                $primers[$j]=$this->getpromediopre($promedioprimer[$j],$lista_equivalencia);
                                $segundos[$j]=$this->getpromediopre($promediosegundo[$j],$lista_equivalencia);

                                if($idtevalucacion==2){
                                    $terceros[$j]=$this->getpromediopre($promediotercero[$j],$lista_equivalencia);

                                }else{
                                    $terceros[$j]=0;
                                }


                                if($segmento==0){
                                    $resultado_auxiliar=array();
                                    $promedio_aux=array();
                                    $promedio_aux = array($primers[$j], $segundos[$j], $terceros[$j]);
                                    $resultado_auxiliar = array_values(array_diff($promedio_aux, array('0')));

                                    if (!empty($resultado_auxiliar)) {

                                        $finals[$j]= round((array_sum($resultado_auxiliar)) / count($resultado_auxiliar));

                                    } else {
                                        $finals[$j]= 0;
                                    }
                                }


                                //Convertimos a Concepto
                                $primers[$j]=$this->promedioaconcepto($primers[$j]);
                                $segundos[$j]=$this->promedioaconcepto($segundos[$j]);


                                if($idtevalucacion==2){

                                    $terceros[$j]=$this->promedioaconcepto($terceros[$j]);

                                }

                                $finals[$j]=$this->promedioaconcepto($finals[$j]);


                                $html_notas[$y][3] .= "<tr><td style='width:65%'>Promedios del núcleo: " . $datosasignaturas[$j]['nombreNucleo'] . "</td>";
                                if($idtevalucacion==1){
                                    $html_notas[$y][3] .= "<td style='width:10%;text-align:center;'>" . $primers[$j] . "</td><td style='width:10%;text-align:center;'>" . $segundos[$j] . "</td><td style='width:10%;text-align:center;'>" . $finals[$j] . "</td></tr>";

                                }else{
                                    $html_notas[$y][3] .= "<td style='width:10%;text-align:center;'>" . $primers[$j] . "</td><td style='width:10%;text-align:center;'>" . $segundos[$j] . "</td><td style='width:10%;text-align:center;'>" . $terceros[$j] . "</td><td style='width:10%;text-align:center;'>" . $finals[$j] . "</td></tr>";

                                }

                            }
                        }

                    } else {
                        for ($j = 0; $j < $largoasignatura; $j++) {
                            if ($datosasignaturas[$j]['idNucleo'] == $nucleostres[$k]['idNucleo']) {
                                $html_notas[$y][3] .= "<tr><td style='width:65%'>" . $datosasignaturas[$j]['nombreAsignatura'] . "</td>";

                                if ($segmento == 1) {
                                    $promedioprimer[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 1, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                    $promediosegundo[$j] = array();
                                } elseif($segmento==2) {
                                    $promedioprimer[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 1, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                    $promediosegundo[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 2, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);

                                }elseif($segmento==3) {
                                    $promedioprimer[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                    $promediosegundo[$j] = array();
                                    $promediotercero[$j] = array();

                                }elseif($segmento==4) {
                                    $promedioprimer[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                    $promediosegundo[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 4, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                    $promediotercero[$j] = array();

                                }elseif($segmento==5) {
                                    $promedioprimer[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                    $promediosegundo[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 4, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                    $promediotercero[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 5, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);

                                }

                                if ($largodetallealumno > 0) {

                                    if($idtevalucacion==1){
                                        $promedioprimer[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 1, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                        $promediosegundo[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 2, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);


                                        $promediofinal[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 2, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                    }else{
                                        $promedioprimer[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                        $promediosegundo[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 4, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                        $promediotercero[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 5, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                        $promediofinal[$j] = $tabla->getnotaspresegmento($idalumnoactual, $idperiodo, 5, $datosasignaturas[$j]['idAsignatura'], $idcursoactual);
                                    }

                                } else {
                                    $promediofinal[$j][0]['nota'] = '';
                                }


                                if ($promedioprimer[$j][0]['nota'] == null) {
                                    $primers[$j] = '';
                                }

                                if ($promediosegundo[$j][0]['nota'] == null) {
                                    $segundos[$j] = '';

                                }

                                if ($promediotercero[$j][0]['nota'] == null) {
                                    $terceros[$j] = '';

                                }

                                if ($promediofinal[$j][0]['nota'] == null) {
                                    $finals[$j] = '';

                                }


                                for ($l = 0; $l < $largoresultado; $l++) {
                                    //Primer
                                    if ($resultado[$l]['notaConcepto'] == $promedioprimer[$j][0]['nota']) {
                                        $primers[$j] = $resultado[$l]['concepto'];

                                    }
                                    //Segundo
                                    if ($resultado[$l]['notaConcepto'] == $promediosegundo[$j][0]['nota']) {
                                        $segundos[$j] = $resultado[$l]['concepto'];

                                    }

                                    //Tercero
                                    if ($resultado[$l]['notaConcepto'] == $promediotercero[$j][0]['nota']) {
                                        $terceros[$j] = $resultado[$l]['concepto'];

                                    }
                                    //Final
                                    if ($resultado[$l]['notaConcepto'] == $promediofinal[$j][0]['nota']) {
                                        $finals[$j] = $resultado[$l]['concepto'];

                                    }

                                }


                                if($idtevalucacion==1){
                                    $html_notas[$y][3] .= "<td style='width:10%;text-align:center;'>" . $primers[$j] . "</td><td style='width:10%;text-align:center;'>" . $segundos[$j] . "</td><td style='width:10%;text-align:center;'>" . $finals[$j] . "</td></tr>";


                                }elseif($idtevalucacion==2){
                                    $html_notas[$y][3] .= "<td style='width:8%;text-align:center;'>" . $primers[$j] . "</td><td style='width:8%;text-align:center;'>" . $segundos[$j] . "</td><td style='width:8%;text-align:center;'>" . $terceros[$j] . "</td><td style='width:8%;text-align:center;'>" . $finals[$j] . "</td></tr>";

                                }

                            }

                        }
                    }
                    $html_notas[$y][3] .= "</table>";

                } //fin Bucleo


                //Nuevo Hoja al Apoderado

                if (file_exists($logo)) {
                    $html_notas[$y][4] = '<p style="position:absolute;top:3%;text-align:left"></p><p style="position:absolute;top:1%;text-align:center"><img  src="' . $logo . '" /></p>';

                } else {
                    $html_notas[$y][4] = '';

                }


                $html_notas[$y][4] .= "<div style='width:100%;outline: 2px solid #699;outline-offset: -9px;text-align:center; margin:5px 0 0px 0; height:730px;'>
  
      <table style='width:98%;border:none;margin:5px 5px 5px 5px;padding:5px;'>
        <tr>
          <td style='width:19%; text-align:left;border:none;'>Nombre de Alumno(a)</td>
          <td colspan='3' style='width:69%; text-align:left;border:none;'>" . $listadealumnos[$y]['nombres'] . " " . $listadealumnos[$y]['apaterno'] . " " . $listadealumnos[$y]['amaterno'] . "</td>
        </tr>

      </table>
      <p style='text-align: justify;padding: 5px'>La Educación Parvularia acoge a un niño o niña arraigado en su familia y le corresponde compartir con ella la labor educativa, complementándola y ampliando las experiencias de aprendizajes y desarrollo integral que se le ofrecen. Por ello, es fundamental que se establezcan perspectivas y líneas de trabajo en común y se potencie el esfuerzo educativo que unas y otras realizan en favor de las niñas y los niños.</p>
      <h5 style='text-align: left;'>Que espero que aprenda mi hijo o hija durante este año:</h5>
      <table style='width:100%;border: 1px double #000;outline: 2px solid #699;outline-offset: -9px;text-align:center; margin:5px 0 0px 0; height:100px;'>
        <tr><td style='width: 100%;height: 100px;'></td></tr>
      </table>";

                if($idtevalucacion==1){
                    $html_notas[$y][4] .="<h5 style='text-align: left;'>Que aprendió mi hijo o hija durante el primer semestre:</h5>
        <table style='width:100%;border: 1px double #000;outline: 2px solid #699;outline-offset: -9px;text-align:center; margin:10px 0 0px 0; height:100px;'>
            <tr><td style='width: 100%;height: 100px;'></td></tr>
        </table>

        <h5 style='text-align: left;'>Que aprendió mi hijo o hija durante el segundo semestre:</h5>
        <table style='width:100%;border: 1px double #000;outline: 2px solid #699;outline-offset: -9px;text-align:center; margin:10px 0 0px 0; height:100px;'>
            <tr><td style='width: 100%;height: 100px;'></td></tr>
        </table>
      
        <table align=center style='width:95%;margin-top:85px;'>
          <tr>
            <td style='width:50%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          </tr> 
          <tr>
            <td style='width:50%;text-align:center;border:none;'>Nombre y Firma del Apoderado</td>
          </tr>
        </table>
        </div>";
                }else{
                    $html_notas[$y][4] .="<h5 style='text-align: left;'>Que aprendió mi hijo o hija durante el primer trimestre:</h5>
        <table style='width:100%;border: 1px double #000;outline: 2px solid #699;outline-offset: -9px;text-align:center; margin:5px 0 0px 0; height:100px;'>
            <tr><td style='width: 100%;height: 100px;'></td></tr>
        </table>

        <h5 style='text-align: left;'>Que aprendió mi hijo o hija durante el segundo trimestre:</h5>
        <table style='width:100%;border: 1px double #000;outline: 2px solid #699;outline-offset: -9px;text-align:center; margin:5px 0 0px 0; height:100px;'>
            <tr><td style='width: 100%;height: 100px;'></td></tr>
        </table>
        
        
        <h5 style='text-align: left;'>Que aprendió mi hijo o hija durante el tercer trimestre:</h5>
        <table style='width:100%;border: 1px double #000;outline: 2px solid #699;outline-offset: -9px;text-align:center; margin:5px 0 0px 0; height:100px;'>
            <tr><td style='width: 100%;height: 100px;'></td></tr>
        </table>
      
        <table align=center style='width:95%;margin-top:65px;'>
          <tr>
            <td style='width:50%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          </tr> 
          <tr>
            <td style='width:50%;text-align:center;border:none;'>Nombre y Firma del Apoderado</td>
          </tr>
        </table>
        </div>";
                }


                $html_notas[$y][5] = "<h3 style='text-align:center;margin-top:2px'>INFORME:Evaluación de Aprendizajes</h3>
  <h5 style='text-align:center;margin-top:2px'>¿Cómo Interpretar y Apoyar a sus hijos con ésta información?</h5>
  <table style='width:95%;border-collapse:collapse;' border=1 align=center >";

                for ($l = 0; $l < $largoresultado; $l++) {

                    $html_notas[$y][5] .= "<tr><td style='text-align:center; width:5%;'>" . $resultado[$l]['concepto'] . "</td><td style='text-align:left; width:85%;'>Si su hijo/a tiene una " . $resultado[$l]['concepto'] . ", " . $resultado[$l]['descripcionConcepto'] . "</td></tr>";
                }

                if($idtevalucacion==1){
                    $html_notas[$y][5] .= "</table><h3 style='text-align:center;margin-top:20px'>PRIMER SEMESTRE</h3>
        <table border=1 align=center style='width:95%; border-collapse:collapse;'>
          <tr>
            <td style='width:95%;text-align: left;'>Observaciones y Sugerencia de la Educadora:</td>
          </tr>
          <tr>
            <td style='width:95%;height:5%;text-align:left;'>" . $observacionprimer . "</td>
          </tr>
        </table>
         <table align='center' style='width:95%;margin-top:45px;' class='page_firmas'>
         <tr>
          <td style='width:33%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          <td style='width:33%;text-align:center;'></td>
          <td style='width:33%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          </tr>
            <tr>
                <td style='width: 33%; text-align: center;border:none;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</td>
                <td style='width: 33%; text-align: center;border:none;'></td>
                <td style='width: 33%; text-align: center;border:none;'>" . $director['nombrescuenta'] . " " . $director['paternocuenta'] . " " . $director['maternocuenta'] . "</td>
            </tr>
            <tr>
                <td style='width: 33%; text-align:center;border:none;padding-top:5px'>Educadora de Párvulo</td>
                <td style='width: 33%; text-align: center;border:none;padding-top:5px'></td>
                <td style='width: 33%; text-align:center;border:none;padding-top:5px'>Director</td>
            </tr>
            
            </table>

        <hr style='width:100%'>

        <h3 style='text-align:center;margin-top:20px'>SEGUNDO SEMESTRE</h3>
        <table border=1 align=center style='width:95%;border-collapse:collapse;'>
          <tr>
            <td style='width:95%;text-align: left;'>Observaciones y Sugerencias de la Educadora:</td>
          </tr>
          <tr>
            <td style='width:95%;height:5%;text-align:left;'>" . $observacionsegundo . "</td>
          </tr>
        </table>

         <table align='center' style='width:95%;margin-top:45px;' class='page_firmas'>
         <tr>
          <td style='width:33%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          <td style='width:33%;text-align:center;'></td>
          <td style='width:33%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          </tr>
            <tr>
                <td style='width: 33%; text-align: center;border:none;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</td>
                <td style='width: 33%; text-align: center;border:none;'></td>
                <td style='width: 33%; text-align: center;border:none;'>" . $director['nombrescuenta'] . " " . $director['paternocuenta'] . " " . $director['maternocuenta'] . "</td>
            </tr>
            <tr>
                <td style='width: 33%; text-align:center;border:none;padding-top:5px'>Educadora de Párvulo</td>
                <td style='width: 33%; text-align: center;border:none;padding-top:5px'></td>
                <td style='width: 33%; text-align:center;border:none;padding-top:5px'>Director</td>
            </tr>
            
            </table>


         <hr style='width:100%'>

          <h3 style='text-align:center;margin-top:20px'>INFORME FINAL</h3>
        <table border=1 align=center style='width:95%;border-collapse:collapse;'>
          <tr>
            <td style='width:95%;text-align: left;'>Observaciones y Sugerencias de la Educadora:</td>
          </tr>
          <tr>
            <td style='width:95%;height:5%;text-align:left;'>" . $observacion . "</td>
          </tr>
        </table>

        <table align='center' style='width:95%;margin-top:45px;' class='page_firmas'>
         <tr>
          <td style='width:33%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          <td style='width:33%;text-align:center;'></td>
          <td style='width:33%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          </tr>
            <tr>
                <td style='width: 33%; text-align: center;border:none;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</td>
                <td style='width: 33%; text-align: center;border:none;'></td>
                <td style='width: 33%; text-align: center;border:none;'>" . $director['nombrescuenta'] . " " . $director['paternocuenta'] . " " . $director['maternocuenta'] . "</td>
            </tr>
            <tr>
                <td style='width: 33%; text-align:center;border:none;padding-top:5px'>Educadora de Párvulo</td>
                <td style='width: 33%; text-align: center;border:none;padding-top:5px'></td>
                <td style='width: 33%; text-align:center;border:none;padding-top:5px'>Director</td>
            </tr>
            
            </table>";

                }else{
                    $html_notas[$y][5] .= "</table><h3 style='text-align:center;margin-top:5px'>PRIMER TRIMESTRE</h3>
        <table border=1 align=center style='width:95%; border-collapse:collapse;'>
          <tr>
            <td style='width:95%;text-align: left;'>Observaciones y Sugerencia de la Educadora:</td>
          </tr>
          <tr>
            <td style='width:95%;height:5%;text-align:left;'>" . $observacionprimer . "</td>
          </tr>
        </table>
         <table align='center' style='width:95%;margin-top:30px;' class='page_firmas'>
         <tr>
          <td style='width:33%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          <td style='width:33%;text-align:center;'></td>
          <td style='width:33%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          </tr>
            <tr>
                <td style='width: 33%; text-align: center;border:none;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</td>
                <td style='width: 33%; text-align: center;border:none;'></td>
                <td style='width: 33%; text-align: center;border:none;'>" . $director['nombrescuenta'] . " " . $director['paternocuenta'] . " " . $director['maternocuenta'] . "</td>
            </tr>
            <tr>
                <td style='width: 33%; text-align:center;border:none;padding-top:5px'>Educadora de Párvulo</td>
                <td style='width: 33%; text-align: center;border:none;padding-top:5px'></td>
                <td style='width: 33%; text-align:center;border:none;padding-top:5px'>Director</td>
            </tr>
            
            </table>

        <hr style='width:100%'>

        <h3 style='text-align:center;margin-top:5px'>SEGUNDO TRIMESTRE</h3>
        <table border=1 align=center style='width:95%;border-collapse:collapse;'>
          <tr>
            <td style='width:95%;text-align: left;'>Observaciones y Sugerencias de la Educadora:</td>
          </tr>
          <tr>
            <td style='width:95%;height:5%;text-align:left;'>" . $observacionsegundo . "</td>
          </tr>
        </table>

         <table align='center' style='width:95%;margin-top:30px;' class='page_firmas'>
         <tr>
          <td style='width:33%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          <td style='width:33%;text-align:center;'></td>
          <td style='width:33%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          </tr>
            <tr>
                <td style='width: 33%; text-align: center;border:none;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</td>
                <td style='width: 33%; text-align: center;border:none;'></td>
                <td style='width: 33%; text-align: center;border:none;'>" . $director['nombrescuenta'] . " " . $director['paternocuenta'] . " " . $director['maternocuenta'] . "</td>
            </tr>
            <tr>
                <td style='width: 33%; text-align:center;border:none;padding-top:5px'>Educadora de Párvulo</td>
                <td style='width: 33%; text-align: center;border:none;padding-top:5px'></td>
                <td style='width: 33%; text-align:center;border:none;padding-top:5px'>Director</td>
            </tr>
            
            </table>
            
            <hr style='width:100%'>
            
            <h3 style='text-align:center;margin-top:5px'>TERCER TRIMESTRE</h3>
        <table border=1 align=center style='width:95%;border-collapse:collapse;'>
          <tr>
            <td style='width:95%;text-align: left;'>Observaciones y Sugerencias de la Educadora:</td>
          </tr>
          <tr>
            <td style='width:95%;height:5%;text-align:left;'>" . $observaciontercero . "</td>
          </tr>
        </table>

         <table align='center' style='width:95%;margin-top:30px;' class='page_firmas'>
         <tr>
          <td style='width:33%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          <td style='width:33%;text-align:center;'></td>
          <td style='width:33%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          </tr>
            <tr>
                <td style='width: 33%; text-align: center;border:none;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</td>
                <td style='width: 33%; text-align: center;border:none;'></td>
                <td style='width: 33%; text-align: center;border:none;'>" . $director['nombrescuenta'] . " " . $director['paternocuenta'] . " " . $director['maternocuenta'] . "</td>
            </tr>
            <tr>
                <td style='width: 33%; text-align:center;border:none;padding-top:5px'>Educadora de Párvulo</td>
                <td style='width: 33%; text-align: center;border:none;padding-top:5px'></td>
                <td style='width: 33%; text-align:center;border:none;padding-top:5px'>Director</td>
            </tr>
            
            </table>


         <hr style='width:100%'>

          <h3 style='text-align:center;margin-top:5px'>INFORME FINAL</h3>
        <table border=1 align=center style='width:95%;border-collapse:collapse;'>
          <tr>
            <td style='width:95%;text-align: left;'>Observaciones y Sugerencias de la Educadora:</td>
          </tr>
          <tr>
            <td style='width:95%;height:5%;text-align:left;'>" . $observacion . "</td>
          </tr>
        </table>

        <table align='center' style='width:95%;margin-top:35px;' class='page_firmas'>
         <tr>
          <td style='width:33%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          <td style='width:33%;text-align:center;'></td>
          <td style='width:33%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          </tr>
            <tr>
                <td style='width: 33%; text-align: center;border:none;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</td>
                <td style='width: 33%; text-align: center;border:none;'></td>
                <td style='width: 33%; text-align: center;border:none;'>" . $director['nombrescuenta'] . " " . $director['paternocuenta'] . " " . $director['maternocuenta'] . "</td>
            </tr>
            <tr>
                <td style='width: 33%; text-align:center;border:none;padding-top:5px'>Educadora de Párvulo</td>
                <td style='width: 33%; text-align: center;border:none;padding-top:5px'></td>
                <td style='width: 33%; text-align:center;border:none;padding-top:5px'>Director</td>
            </tr>
            
            </table>";
                }



            }



            if ($html_notas != '') {

                require 'fpdf/html2pdf.class.php';
                try {
                    //Orientación / formato del pdf y el idioma.
                    $pdf = new HTML2PDF('P', 'LETTER', 'es', array(10, 10, 10, 10) /*márgenes*/); //los márgenes también pueden definirse en <page> ver documentación

                    //inicio ciclo

                    for ($j = 0; $j < count($html_notas); $j++) {
                        for ($k = 0; $k < count($html_notas[$j]); $k++) {
                            $pdf->WriteHTML('<page><html>
        <head>
            <style>' . $style . '</style>
        </head>
        <body> <page_footer>
        <table class="page_footer">
            <tr>
            <td style="width: 40%; text-align: left;border:none;"></td>
                <td style="width: 60%; text-align: right;border:none;font-size:8px">

                </td>
            </tr>
        </table>
    </page_footer>' . $html_notas[$j][$k] . '</body></html></page>');
                        }
                    }

                    //fin ciclo

                    if (preg_match("/MSIE/i", $_SERVER["HTTP_USER_AGENT"])) {
                        header("Content-type: application/PDF");
                    } else {
                        header("Content-type: application/PDF");
                        header("Content-Type: application/pdf");
                    }

                    $pdf->Output('Planificacion.pdf', I);
                } catch (HTML2PDF_exception $e) {
                    //echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, intente nuevamente\");</script>";
                    //echo "<script>parent.$.fancybox.close();</script>";
                    echo $e;
                }
            }


        }
    }

    public
    function generamatriculaAction()
    {

        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();

        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        //debe venir un parametro, por GET o POST, llamado idasignatura, con el id del Asignatura a borrar
        $id = $this->_getParam('id', 0);
        //creo objeto tabla Asignaturas
        $tabla = new Application_Model_DbTable_Alumnos();
        $modeloalumno = new Application_Model_DbTable_Alumnosactual();
        $tablaapoderado = new Application_Model_DbTable_Apoderados();
        $modelcurso = new Application_Model_DbTable_Cursos();
        $tabla2 = $modeloalumno->get($id);
        $detalleest = $modelcurso->listarcursoid($tabla2[0]['idCursosActual'], $idperiodo);

        $tabla3 = $tabla->getcertificado($id);
        $tabla4 = array();
        if (!empty($tabla3[0]['idApoderado'])) {
            $tabla4 = $tablaapoderado->get($tabla2[0]['idApoderado']);
        }

        //Apoderado Suplente
        $datosuplente = array();
        if (!empty($tabla2[0]['idApoderadoSuplente'])) {
            $datosuplente = $tablaapoderado->get($tabla2[0]['idApoderadoSuplente']);
        }


        $comuna = new Application_Model_DbTable_Comuna();
        $nombrecomuna = 'Sin Datos';
        if (!empty($tabla2[0]['comunaActual'])) {
            $datoscomuna = $comuna->getcomunasolo($tabla2[0]['comunaActual']);
            $nombrecomuna = $datoscomuna[0]['nombreComuna'];

        }


        if ($tabla2[0]['sexo'] == 1) {
            $nombresexo = 'Femenino';
        }
        if ($tabla2[0]['sexo'] == 2) {
            $nombresexo = 'Masculino';
        }
        if ($tabla2[0]['sexo'] == 0) {
            $nombresexo = 'Sin Datos';
        }

        //Eatado Alumno
        if ($tabla2[0]['idEstadoActual'] == 1) {
            $estado = 'Activo';
        }
        if ($tabla2[0]['idEstadoActual'] == 4) {
            $estado = 'Retirado';
        }
        $nombrespadre = strtr(strtoupper($tabla3['nombrepadre'] . ' ' . $tabla3['apellidopadre']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ");
        $nombresmadre = strtr(strtoupper($tabla3['nombremadre'] . ' ' . $tabla3['apellidomadre']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ");
        $nombrecompletoapoderado = strtr(strtoupper($tabla4['nombreApoderado'] . ' ' . $tabla4['paternoApoderado'] . ' ' . $tabla4['maternoApoderado']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ");
        $nombrecompletoapoderadosuplente = strtr(strtoupper($datosuplente['nombreApoderado'] . ' ' . $datosuplente['paternoApoderado'] . ' ' . $datosuplente['maternoApoderado']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ");


        $caracteres = array(",", ".", "-");
        $rutset = str_replace($caracteres, "", $tabla3[0]['rutAlumno']);
        $rutsetapoderado = str_replace($caracteres, "", $tabla4['rutApoderado']);
        $rutpadre = str_replace($caracteres, "", $tabla3[0]['rutPadre']);
        $rutmadre = str_replace($caracteres, "", $tabla3[0]['rutMadre']);
        $rutapoderadosuplente = str_replace($caracteres, "", $datosuplente['rutApoderado']);

        if (!empty($rutset)) {

            $rest = substr($rutset, 0, -1);
            $ultimo = substr($rutset, -1);
            $formatomiles = number_format($rest, 0, "", ".");
            $formatofinal = $formatomiles . '-' . $ultimo;

        }

        if (!empty($rutsetapoderado)) {
            $rest = substr($rutsetapoderado, 0, -1);
            $ultimo = substr($rutsetapoderado, -1);
            $formatomiles = number_format($rest, 0, "", ".");
            $formatofinalapoderado = $formatomiles . '-' . $ultimo;

        }

        if (!empty($rutapoderadosuplente)) {
            $rest = substr($rutapoderadosuplente, 0, -1);
            $ultimo = substr($rutapoderadosuplente, -1);
            $formatomiles = number_format($rest, 0, "", ".");
            $formatofinalapoderadosuplente = $formatomiles . '-' . $ultimo;

        }
        if (!empty($rutpadre)) {
            $rest = substr($rutpadre, 0, -1);
            $ultimo = substr($rutpadre, -1);
            $formatomiles = number_format($rest, 0, "", ".");
            $formatofinalpadre = $formatomiles . '-' . $ultimo;

        }
        if (!empty($rutmadre)) {
            $rest = substr($rutmadre, 0, -1);
            $ultimo = substr($rutmadre, -1);
            $formatomiles = number_format($rest, 0, "", ".");
            $formatofinalmadre = $formatomiles . '-' . $ultimo;

        }
        $date = new DateTime;
        $fechain = $date->format('Y-m-d');
        $cortado = explode("-", $fechain);
        $dias = array("Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado");
        $meses = array("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre");

        $fecha_final = $dias[date('w', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]))] . " " . $cortado[2] . " de " . $meses[date('n', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0])) - 1] . " del " . date('Y', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]));

        $fechana = $tabla3[0]['fechanacimiento'];
        $cortado2 = explode("-", $fechana);
        $fecha_final_nac = $cortado2[2] . " de " . $meses[date('n', mktime(0, 0, 0, $cortado2[1], $cortado2[2], $cortado2[0])) - 1] . " del " . date('Y', mktime(0, 0, 0, $cortado2[1], $cortado2[2], $cortado2[0]));


        // variables para encabezado
        $periodo = new Zend_Session_Namespace('nombreperiodo');
        $nombreperiodo = $periodo->nombreperiodo;
        $titulo = "FICHA DE MATRÍCULA " . $nombreperiodo;
        $logo = getcwd();
        $logo .= "/application/documentos/logos/" . $tabla3[0]['extension'];
        $logo2 = getcwd();
        $logo2 .= "/application/documentos/fotografia/" . $tabla3[0]['foto'];
        $infoizq = '<div id="infoizq"><p style="position:absolute;top:5px;text-align:center"><img width="150px" heigth="170px" src="' . $logo2 . '" /></p></div>';
        if (file_exists($logo)) {
            $encabezado = '<p style="position:absolute;top:5px;text-align:center"><img  src="' . $logo . '" /></p><p style="position:absolute;top:5px;text-align:center"></p>' . $infoder . '<h5 style="position:absolute;top:120px;text-align:center"> ' . strtr(strtoupper($tabla3[0]['nombreEstablecimiento']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . ' </h5><h5 style="position:absolute;top:170px;text-align:center">' . $titulo . '</h5>';

        } else {
            $encabezado = '<p style="position:absolute;top:5px;text-align:center"></p><p style="position:absolute;top:5px;text-align:center"></p>' . $infoder . '<h5 style="position:absolute;top:120px;text-align:center"> ' . strtr(strtoupper($tabla3[0]['nombreEstablecimiento']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . ' </h5><h5 style="position:absolute;top:170px;text-align:center">' . $titulo . '</h5>';

        }


        $style = "body{
font:14px Arial, Tahoma, Verdana, Helvetica, sans-serif;

color:#000;
}

#infoizq{

position:absolute;
left:0px;
font-size:10px;
text-justify:inter-word;
}

#infoder{

position:absolute;
right:50px;
font-size:10px;
text-justify:inter-word;
}

#infoder p{

margin-top:5px;
}
 
a h1{
font-size:35px; 
color:#FFF;
}
img{
width:100px;
height:100px;


}
 
h2{
color:#FC0;
font-size:15px; 
}

 
table{
width:765px;
height:auto;
margin:20px 0 10px 0;
border-collapse:collapse;
text-align:center;
text-justify:inter-word;
color:#000000;

}

table .uno{

border-width: thick;
	border-spacing: 2px;
	border-style: groove;
	border-color: gray;
	border-collapse: separate;
	background-color: white;
}



table td{
border:1px solid black;
padding:2px;
}
 .mes{
text-align:center;
}
 
table th {
padding:10px;

text-align:center;
font-weight:bold;
color:#000000;
}
 
.menu{
background-color:#69C;
color:#FFF;
}
 
.menu a{
color:#FFF; 
}
table .dos{
width:765px;
min-width:765px;
border-collapse:collapse;
text-align:center;
text-justify:inter-word;
color:#000000;
}

table .dos td{
border:1px solid black;
padding:15px;
}
 .antecedentes{
font-size:12px; 


}
.antecedentes td{
padding:5px;
text-align:left
}
 

";

        $html = $encabezado;


        $html .= '
<table width=100% align="center" class="antecedentes" style="width:100%">
<tr >
<td colspan="8" style="text-align:center;border: 0px;border-bottom: 1px solid; border-collapse: collapse;font-weight:bold;">ANTECEDENTES DEL ALUMNO(A)</td>
</tr>

  
  
  <tr>
    <td  colspan="2">Rut Alumno(a): ' . $formatofinal . '</td>
    <td  colspan="1">Sexo: ' . strtoupper($nombresexo) . '</td>
  </tr>
  <tr>
    <td>Apellido Paterno : ' . strtr(strtoupper($tabla3[0]['apaterno']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . '</td>
    <td>Apellido Materno: ' . strtr(strtoupper($tabla3[0]['amaterno']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . '</td>
    <td>Nombres: ' . strtr(strtoupper($tabla3[0]['nombres']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . '</td>
  </tr>
  <tr>
    <td colspan="2">Fecha Nacimiento: ' . strtoupper($fecha_final_nac) . '</td>
    <td  colspan="1">Estado: ' . strtoupper($estado) . '</td>
    
  </tr>
  <tr>
    <td style="width:100%;text-align:center;font-weight:bold;"colspan="3">DOMICILIO</td>
  </tr>
  <tr>
    <td colspan="2">Domicilio: ' . strtr(strtoupper($tabla2[0]['direccion']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . ' </td>
    <td colspan="1">Comuna: ' . strtr(strtoupper($nombrecomuna), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . '</td>
  </tr>
 
  

  
  <tr>
    <td colspan="3">Curso: ' . strtr(strtoupper($detalleest[0]['nombreGrado'] . ' ' . $detalleest[0]['letra']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . '</td>
    
  </tr>
</table>

<table width=100% align="center" class="antecedentes" style="width:100%;margin-top:100px">
<tr>
<td style="text-align:center;border: 0px;border-bottom: 1px solid; border-collapse: collapse;font-weight:bold;" colspan="2" >ANTECEDENTES FAMILIARES</td>
</tr>

<tr>
<td style="width:100%;text-align:center;font-weight:bold;" colspan="2" >ANTECEDENTES DEL PADRE</td>
</tr>';


        $html .= '<tr>
    <td style="width:50%" >Nombre : ' . strtr(strtoupper($tabla3[0]['nombrepadre']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . ' ' . strtr(strtoupper($tabla3[0]['apellidopadre']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . '</td>
    <td style="width:40%">Rut : ' . $formatofinalpadre . '</td>

  </tr>
  <tr>
    <td style="width:100%" colspan="2" >Ocupación: ' . strtr(strtoupper($tabla3[0]['ocupacionPadre']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . '</td>
    
  </tr>
  <tr>
    <td style="width:100%" colspan="2">Teléfono: ' . $tabla3[0]['telefonopadre'] . '</td>
    
  </tr>

  

  <tr>
    <td style="width:100%" colspan="2" >Escolaridad: ' . strtr(strtoupper($tabla3[0]['nivelpadre']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . '</td>
    
  </tr>

  <tr>
<td style="width:100%;text-align:center;font-weight:bold;" colspan="2" >ANTECEDENTES DE LA MADRE</td>
</tr>


  <tr>
    <td style="width:50%" >Nombre: ' . strtr(strtoupper($tabla3[0]['nombremadre']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . ' ' . strtr(strtoupper($tabla3[0]['apellidomadre']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . '</td>
    <td style="width:40%">Rut: ' . $formatofinalmadre . '</td>

  </tr>
  <tr>
    <td style="width:100%" colspan="2" >Ocupación: ' . strtr(strtoupper($tabla3[0]['ocupacionMadre']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . '</td>
    
  </tr>
  <tr>
    <td style="width:100%" colspan="2">Teléfono: ' . $tabla3[0]['telefonomadre'] . '</td>
    
  </tr>

 
  <tr>
    <td style="width:100%" colspan="2" >Escolaridad: ' . strtr(strtoupper($tabla3[0]['nivelmadre']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . '</td>
    
  </tr>

  <tr>
<td style="width:100%;text-align:center;font-weight:bold;" colspan="2" >ANTECEDENTES DEL APODERADO</td>
</tr>




  <tr>
    <td style="width:50%" >Nombre: ' . $nombrecompletoapoderado . '</td>
    <td style="width:40%">Rut: ' . $formatofinalapoderado . '</td>

  </tr>
  
  <tr>
    <td style="width:100%" colspan="2" >Domicilio: ' . strtr(strtoupper($tabla4['direccionApoderado']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . '</td>
    
  </tr>
  <tr>
    <td style="width:100%" colspan="2">Teléfono: ' . $tabla4['telefonoApoderado'] . '</td>
    
    
  </tr>
  
  <tr>
<td style="width:100%;text-align:center;font-weight:bold;" colspan="2" >ANTECEDENTES DEL APODERADO SUPLENTE</td>
</tr>




  <tr>
    <td style="width:50%" >Nombre: ' . $nombrecompletoapoderadosuplente . '</td>
    <td style="width:40%">Rut: ' . $formatofinalapoderadosuplente . '</td>

  </tr>
  
  <tr>
    <td style="width:100%" colspan="2" >Domicilio: ' . strtr(strtoupper($datosuplente['direccionApoderado']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . '</td>
    
  </tr>
  <tr>
    <td style="width:100%" colspan="2">Teléfono: ' . $datosuplente['telefonoApoderado'] . '</td>
    
    
  </tr>
  


</table>';
        $html .= '<table width=100% align="center" class="antecedentes" style="width:100%;">
  <tr>
<td style="text-align:center;border: 0px;border-bottom: 1px solid; border-collapse: collapse;font-weight:bold;" colspan="2" >AUTORIZACIÓN PARA REALIZAR ACTIVIDADES DE EDUCACIÓN FÍSICA O DEPORTE</td>
</tr>';


        if ($tabla3[0]['actividad'] == 1) {

            $html .= ' <tr>
<td style="width:100%;text-align:justify" colspan="2" >Declaro que mi pupilo tiene las condiciones de salud para realizar actividad física o deporte</td>
</tr>';

        }

        if ($tabla3[0]['actividad'] < 0 || empty($tabla3[0]['actividad']) || $tabla3[0]['actividad'] == 2) {

            $html .= ' <tr>
<td style="width:100%;text-align:justify" colspan="2" >Declaro que mi alumno(a) no tiene las condiciones de salud para realizar actividad Física o Deporte y me comprometo a traer un certificado </td>
</tr>';

        }

        $html .= '<tr>
<td style="width:50%;height:25px;">Nombre y Rut del Apoderado: ' . $nombrecompletoapoderado . ' ' . $formatofinalapoderado . '</td>
<td style="width:50%;height:25px;">Firma Apoderado:</td>
</tr>
    ';


        $html .= '</table>';


        $html .= '
  
<table width=100% align="center" class="antecedentes" style="width:100%;margin-top:100px">
  <tr>
<td style="text-align:center;border: 0px;border-bottom: 1px solid; border-collapse: collapse;font-weight:bold;" colspan="2" >DECLARACIÓN</td>
</tr> <tr>
<td style="width:100%;text-align:justify" colspan="2" >DECLARO CONOCER Y ACEPTAR EL MANUAL DE CONVIVENCIA, DISCIPLINA ESCOLAR Y SOCIAL DEL ESTABLECIMIENTO Y ME ADHIERO AL PROYECTO EDUCATIVO INSTITUCIONAL DEL ' . strtr(strtoupper($tabla3[0]['nombreEstablecimiento']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . ' </td>
</tr>

<tr>
<td style="width:50%;height:25px;">Nombre y Rut del Apoderado: ' . $nombrecompletoapoderado . ' ' . $formatofinalapoderado . '</td>
<td style="width:50%;height:25px;">Firma Apoderado:</td>
</tr>
';


        $html .= '</table>';
        $html .= "<table align='center' style='margin-top:45px;' class='page_firmas'>
<tr>
<td style='width: 33%; text-align: center;border:none;'>
<p>___________________________</p><br>  FIRMA PROFESOR
</td>
<td style='width: 33%; text-align: right;border:none;'></td>
<td style='width: 33%; text-align: center;border:none;'>
<p>_________________________</p><br>FIRMA APODERADO
</td>
</tr>
</table>";

        $content = '
        <!doctype html>
        <html>
        <head>
            <style>' . $style . '</style>
        </head>
        <body>  <page_footer>
        <table class="page_footer">

        </table>
    </page_footer>'
            . $html .
            '</body>
        </html>';


        if ($content != '') {

            echo '<page>' . $content . '</page>';

            $content = ob_get_clean();
            require 'fpdf/html2pdf.class.php';
            try {
                //Orientación / formato del pdf y el idioma.
                $pdf = new HTML2PDF('P', 'Legal', 'es', array(10, 10, 10, 10) /*márgenes*/); //los márgenes también pueden definirse en <page> ver documentación

                $pdf->WriteHTML($content);
                if (preg_match("/MSIE/i", $_SERVER["HTTP_USER_AGENT"])) {
                    header("Content-type: application/PDF");
                } else {
                    header("Content-type: application/PDF");
                    header("Content-Type: application/pdf");
                }

                $pdf->Output('Planificacion.pdf', I);
            } catch (HTML2PDF_exception $e) {
                echo $e;
            }
        }

    }


    public function rankingAction()
    {

        $table = new Application_Model_DbTable_Cursos();

        $est = new Zend_Session_Namespace('establecimiento');
        $establecimiento = $est->establecimiento;

        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        //recuperamos el nombre del usuario que esta en sesion
        $usuario = new Zend_Session_Namespace('id');
        $user = $usuario->id;

        $cargo = new Zend_Session_Namespace('cargo');
        $rol = $cargo->cargo;

        if ($rol == '3' || $rol == '4' || $rol == '6') {
            $this->view->datos = $table->listartodasactual($establecimiento, $idperiodo);

        }
        if ($rol == '1') {
            $this->view->datos = $table->listaractual($idperiodo);

        }

        if ($rol == '2') {

            $this->view->datos = $table->listarcursoiddocenteactual($user, $establecimiento, $idperiodo, 1);

        }

    }


    public function generarrankingAction()
    {
        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();

        $ingreson = new Zend_Session_Namespace('ingresonota');
        $ingresonota = $ingreson->ingresonota;

        $cargo = new Zend_Session_Namespace('cargo');
        $rol = $cargo->cargo;


        $agregadecimas = false;


        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $modelcurso = new Application_Model_DbTable_Cursos();
        $modelnotas = new Application_Model_DbTable_Notas();
        $modelasignatura = new Application_Model_DbTable_Asignaturascursos();
        $modeldetalle = new Application_Model_DbTable_AlumnosDetalle();


        //fecha actual

        $date = new DateTime;
        $fechain = $date->format('Y-m-d');
        $cortado = explode("-", $fechain);
        $dias = array("Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado");
        $meses = array("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre");

        $fecha_final = $dias[date('w', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]))] . " " . $cortado[2] . " de " . $meses[date('n', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0])) - 1] . " del " . date('Y', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]));


        if ($ingresonota == 1) {
            $id = $this->_getParam('id', 0);
            $listaalumnos = $modelnotas->listaralumnoscurso($id, $idperiodo);
            $listanotas = $modelnotas->listarnotascursoperiodo($id, $idperiodo, array('1'));
            $datosasignaturas = $modelasignatura->listarporcurso($id, 1, array('1', '3'), $idperiodo);

            //Datos Asignatura Combinadas
            $datosasignaturascombinada = $modelasignatura->getcombinada($id, $idperiodo);
            $largoalumnos = count($listaalumnos);
            $largocombinada = count($datosasignaturascombinada);
            $m = 0;


            //Talleres para Alumnos Separados Primer Semestre
            $datostallersem = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(1));
            $datostallersemseg = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(2));
            $datostalleranual = $modelasignatura->gettalleranual($id, $idperiodo, array(1), 1);
            $datostaller = array_merge($datostallersem, $datostallersemseg, $datostalleranual);
            $largotaller = count($datostaller);

            $modelotallerdetalle = new Application_Model_DbTable_Asignaturascursos();
            //Obtiene los Talleres que son Semestrales Tiempo=2.
            $datostalleres = $modelasignatura->gettaller($id, $idperiodo, array(2), 2, array(1, 2));

            $datoscurso = $modelcurso->listarcursoid($id, $idperiodo);
            //Configuracion de agregar 2 decimas a curso desde 5 a 4to medio cuando el promedio final de asignatura es mayor o igual a 6
            if (($datoscurso[0]['rbd'] == 1863) && (($datoscurso[0]['idCodigo'] == 110 && $datoscurso[0]['idGrado'] > 4) || $datoscurso[0]['idCodigo'] == 310 || $datoscurso[0]['idCodigo'] == 363 || $datoscurso[0]['idCodigo'] == 410 || $datoscurso[0]['idCodigo'] == 510 || $datoscurso[0]['idCodigo'] == 610 || $datoscurso[0]['idCodigo'] == 165)) {
                $agregadecimas = true;
            }

        } else { // se ingresan por asigntaura
            $usuario = new Zend_Session_Namespace('id');
            $user = $usuario->id;
            $idcursoaux = $this->_getParam('id', 0);

            //Validamos si el curso pertece a la jefatura del usuario
            $auxiliar = $modelcurso->listarcursoiddocenteactuals($user, $idperiodo, 1, $idcursoaux);

            if ($auxiliar && ($auxiliar[0]['idCursos'] == $idcursoaux) || $rol != 2) {
                //Asignaturas que pertencen a un curso de jefatura del usuario
                $id = $this->_getParam('id', 0);
                $listaalumnos = $modelnotas->listaralumnoscurso($id, $idperiodo);
                $listanotas = $modelnotas->listarnotascursoperiodo($id, $idperiodo, array('1'));
                $datosasignaturas = $modelasignatura->listarporcurso($id, 1, array('1', '3'), $idperiodo);

                //Datos Asignatura Combinadas
                $datosasignaturascombinada = $modelasignatura->getcombinada($id, $idperiodo);
                $largoalumnos = count($listaalumnos);
                $largocombinada = count($datosasignaturascombinada);
                $m = 0;


                //Talleres para Alumnos Separados Primer Semestre
                $datostallersem = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(1));
                $datostallersemseg = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(2));
                $datostalleranual = $modelasignatura->gettalleranual($id, $idperiodo, array(1), 1);
                $datostaller = array_merge($datostallersem, $datostallersemseg, $datostalleranual);
                $largotaller = count($datostaller);

                $modelotallerdetalle = new Application_Model_DbTable_Asignaturascursos();
                //Obtiene los Talleres que son Semestrales Tiempo=2.
                $datostalleres = $modelasignatura->gettaller($id, $idperiodo, array(2), 2, array(1, 2));

                $datoscurso = $modelcurso->listarcursoid($id, $idperiodo);
                //Configuracion de agregar 2 decimas a curso desde 5 a 4to medio cuando el promedio final de asignatura es mayor o igual a 6
                if (($datoscurso[0]['rbd'] == 1863) && (($datoscurso[0]['idCodigo'] == 110 && $datoscurso[0]['idGrado'] > 4) || $datoscurso[0]['idCodigo'] == 310 || $datoscurso[0]['idCodigo'] == 363 || $datoscurso[0]['idCodigo'] == 410 || $datoscurso[0]['idCodigo'] == 510 || $datoscurso[0]['idCodigo'] == 610 || $datoscurso[0]['idCodigo'] == 165)) {
                    $agregadecimas = true;
                }
            } else {
                //Asignaturas que pertencen a un curso que no es jefatura
                $cursomodel = new Application_Model_DbTable_Detallecursocuenta();
                $id = $this->_getParam('ids', 0);
                $ids = $this->_getParam('id', 0);

                $rowcurso = $cursomodel->listarcursoasignatura($ids);
                $listaasigatura = unserialize($rowcurso[0]['asignaturasLista']);
                $datosasignaturas = $modelasignatura->getasignaturasarray($listaasigatura);

                $listaalumnos = $modelnotas->listaralumnoscurso($id, $idperiodo);
                $listanotas = $modelnotas->listarnotascursoperiodo($id, $idperiodo, array('1'));
                //$datosasignaturas = $modelasignatura->listarporcurso($id, 1, array('1', '3'), $idperiodo);

                //Datos Asignatura Combinadas
                $datosasignaturascombinada = $modelasignatura->getcombinada($id, $idperiodo);
                $largoalumnos = count($listaalumnos);
                $largocombinada = count($datosasignaturascombinada);
                $m = 0;


                //Talleres para Alumnos Separados Primer Semestre
                $datostallersem = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(1));
                $datostallersemseg = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(2));
                $datostalleranual = $modelasignatura->gettalleranual($id, $idperiodo, array(1), 1);
                $datostaller = array_merge($datostallersem, $datostallersemseg, $datostalleranual);
                $largotaller = count($datostaller);

                $modelotallerdetalle = new Application_Model_DbTable_Asignaturascursos();
                //Obtiene los Talleres que son Semestrales Tiempo=2.
                $datostalleres = $modelasignatura->gettaller($id, $idperiodo, array(2), 2, array(1, 2));

                $datoscurso = $modelcurso->listarcursoid($id, $idperiodo);
                //Configuracion de agregar 2 decimas a curso desde 5 a 4to medio cuando el promedio final de asignatura es mayor o igual a 6
                if (($datoscurso[0]['rbd'] == 1863) && (($datoscurso[0]['idCodigo'] == 110 && $datoscurso[0]['idGrado'] > 4) || $datoscurso[0]['idCodigo'] == 310 || $datoscurso[0]['idCodigo'] == 363 || $datoscurso[0]['idCodigo'] == 410 || $datoscurso[0]['idCodigo'] == 510 || $datoscurso[0]['idCodigo'] == 610 || $datoscurso[0]['idCodigo'] == 165)) {
                    $agregadecimas = true;
                }
            }

        }

        $modelCuenta = new Application_Model_DbTable_Cuentas();
        if ($datoscurso[0]['idCuentaJefe'] != 0 || empty($datoscurso[0]['idCuentaJefe'])) {
            $Profesorjefe = $modelCuenta->getusuario($datoscurso[0]['idCuentaJefe'], $idperiodo);
        }
        if ($datoscurso[0]['idDirector'] != 0 || empty($datoscurso[0]['idDirector'])) {
            $director = $modelCuenta->get($datoscurso[0]['idDirector']);
        }

        if (count($Profesorjefe) == 0 || $Profesorjefe == null) {
            echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta Profesor Jefe\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            exit;
        }

        if (count($director) == 0 || $director == null) {
            echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta Director\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            exit;
        }


        if ($largoalumnos == 0 || count($listanotas) == 0) {
            echo "<script type=\"text/javascript\">alert(\"Sin Notas\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            exit;

        }


        //Configuracion de Taller Buscamos si existen configuraciones por alumnos


        $promediotalleralumnos = array();
        $promediotalleralumnoss = array();
        if ($datostalleres) {
            for ($j = 0; $j < $largoalumnos; $j++) {
                for ($i = 0; $i < count($datostalleres); $i++) {
                    $detalletaller = $modelotallerdetalle->gettallersegmento($datostalleres[$i]['idConfiguracionTaller'], 1, $listaalumnos[$j]['idAlumnos']);
                    $detalletallers = $modelotallerdetalle->gettallersegmento($datostalleres[$i]['idConfiguracionTaller'], 2, $listaalumnos[$j]['idAlumnos']);


                    //Primer Semestre
                    if ($datostalleres[$i]['tiempoOpcion'] == 1) {
                        if ($detalletaller) {
                            $datosalumnostaller = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 1, $id, $detalletaller[0]['idAsignatura']);

                            if ($datosalumnostaller) {
                                for ($k = 0; $k < count($datosalumnostaller); $k++) {

                                    if ($datostalleres[$i]['idAsignatura'] == $datosalumnostaller[$k]['idAsignatura']) {
                                        if ($datosalumnostaller[$k]['coef'] == 2) {
                                            if ($datosalumnostaller[$k]['nota'] > 0) {
                                                $promediotalleralumnos[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                                $promediotalleralumnos[$j][$i][] = $datosalumnostaller[$k]['nota'];

                                            } else {
                                                $promediotalleralumnos[$j][$i][] = 0;
                                                $promediotalleralumnos[$j][$i][] = 0;
                                            }

                                        } else {
                                            if ($datosalumnostaller[$k]['nota'] > 0) {
                                                $promediotalleralumnos[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                            } else {
                                                $promediotalleralumnos[$j][$i][] = 0;
                                            }

                                        }


                                    }


                                }
                            }
                            if (!empty($promediotalleralumnos[$j][$i])) {
                                $promsetalumnos = array_diff($promediotalleralumnos[$j][$i], array('0'));
                            } else {
                                $promsetalumnos = 0;
                            }

                            if (is_array($promsetalumnos)) {
                                if (count($promsetalumnos) > 0) {

                                    if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                        $promtalleralumnos[$j][$i]['nota'] = round(array_sum($promsetalumnos) / count($promsetalumnos));

                                    } else {
                                        $promtalleralumnos[$j][$i]['nota'] = intval(array_sum($promsetalumnos) / count($promsetalumnos));
                                    }
                                } else {
                                    $promtalleralumnos[$j][$i]['nota'] = 0;
                                }
                            } else {
                                $promtalleralumnos[$j][$i]['nota'] = 0;
                            }


                            $promtalleralumnos[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                            $promtalleralumnos[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                            $promtalleralumnos[$j][$i]['coef'] = 1;
                            $promtalleralumnos[$j][$i]['tiempo'] = 1;
                            $promtalleralumnos[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                            $promtalleralumnos[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];

                        } else {
                            $promtalleralumnoss[$j][$i]['nota'] = 0;
                            $promtalleralumnos[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                            $promtalleralumnos[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                            $promtalleralumnos[$j][$i]['coef'] = 1;
                            $promtalleralumnos[$j][$i]['tiempo'] = 1;
                            $promtalleralumnos[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                            $promtalleralumnos[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];
                        }
                    } else {
                        $promtalleralumnos[$j][$i] = array();
                    }

                    //Segundo Semestre
                    if ($datostalleres[$i]['tiempoOpcion'] == 2) {
                        if ($detalletallers) {
                            $datosalumnostallers = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 2, $id, $detalletallers[0]['idAsignatura']);

                            if ($datosalumnostallers) {
                                for ($k = 0; $k < count($datosalumnostallers); $k++) {

                                    if ($datostalleres[$i]['idAsignatura'] == $datosalumnostallers[$k]['idAsignatura']) {

                                        if ($datosalumnostallers[$k]['coef'] == 2) {
                                            if ($datosalumnostallers[$k]['nota'] > 0) {
                                                $promediotalleralumnoss[$j][$i][] = $datosalumnostallers[$k]['nota'];
                                                $promediotalleralumnoss[$j][$i][] = $datosalumnostallers[$k]['nota'];

                                            } else {
                                                $promediotalleralumnoss[$j][$i][] = 0;
                                                $promediotalleralumnoss[$j][$i][] = 0;
                                            }

                                        } else {
                                            if ($datosalumnostallers[$k]['nota'] > 0) {
                                                $promediotalleralumnoss[$j][$i][] = $datosalumnostallers[$k]['nota'];
                                            } else {
                                                $promediotalleralumnoss[$j][$i][] = 0;
                                            }

                                        }


                                    }


                                }
                            }
                            if (!empty($promediotalleralumnoss[$j][$i])) {
                                $promsetalumnoss = array_diff($promediotalleralumnoss[$j][$i], array('0'));
                            } else {
                                $promsetalumnoss = 0;
                            }

                            if (is_array($promsetalumnoss)) {
                                if (count($promsetalumnoss) > 0) {

                                    if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                        $promtalleralumnoss[$j][$i]['nota'] = round(array_sum($promsetalumnoss) / count($promsetalumnoss));
                                        $promtalleralumnoss[$j][$i]['nota'] = intval($promtalleralumnoss[$j][$i]['nota']);

                                    } else {
                                        $promtalleralumnoss[$j][$i]['nota'] = intval(array_sum($promsetalumnoss) / count($promsetalumnoss));
                                    }
                                } else {
                                    $promtalleralumnoss[$j][$i]['nota'] = 0;
                                }
                            } else {
                                $promtalleralumnoss[$j][$i]['nota'] = 0;
                            }


                            $promtalleralumnoss[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                            $promtalleralumnoss[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                            $promtalleralumnoss[$j][$i]['coef'] = 1;
                            $promtalleralumnoss[$j][$i]['tiempo'] = 2;
                            $promtalleralumnoss[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                            $promtalleralumnoss[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];

                        } else {
                            $promtalleralumnoss[$j][$i]['nota'] = 0;
                            $promtalleralumnoss[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                            $promtalleralumnoss[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                            $promtalleralumnoss[$j][$i]['coef'] = 1;
                            $promtalleralumnoss[$j][$i]['tiempo'] = 2;
                            $promtalleralumnoss[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                            $promtalleralumnoss[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];
                        }
                    } else {
                        $promtalleralumnoss[$j][$i] = array();
                    }


                }//Fin if talleres


                for ($l = 0; $l < count($promtalleralumnos[$j]); $l++) {
                    if (!empty($promtalleralumnos[$j][$l]["idAsignatura"])) {
                        $datosdestino = $modelotallerdetalle->getdestino($promtalleralumnos[$j][$l]["idAsignatura"]);
                        if ($datosdestino[0]['tipoAsignatura'] != 4) {
                            $listapromediostaller[$j][] = $promtalleralumnos[$j][$l];
                        } else {
                            $listapromediostallercom[$j][$promtalleralumnos[$j][$l]['idAsignatura']] = $promtalleralumnos[$j][$l];

                        }
                    }

                }


                for ($l = 0; $l < count($promtalleralumnoss[$j]); $l++) {
                    if (!empty($promtalleralumnoss[$j][$l]["idAsignatura"])) {
                        $datosdestino = $modelotallerdetalle->getdestino($promtalleralumnoss[$j][$l]["idAsignatura"]);
                        if ($datosdestino[0]['tipoAsignatura'] != 4) {
                            $listapromediostallers[$j][] = $promtalleralumnoss[$j][$l];
                        } else {
                            $listapromediostallercoms[$j][$promtalleralumnoss[$j][$l]['idAsignatura']] = $promtalleralumnoss[$j][$l];

                        }
                    }

                }


            }//Fin for Alumnos


        }


        //Fin Talleres

        //Asignaturas Combinadas


        $datosasignaturascombinada = $modelasignatura->getcombinada($id, $idperiodo);

        $largoalumnos = count($listaalumnos);
        $largotaller = count($datostaller);
        $largocombinada = count($datosasignaturascombinada);
        $m = 0;

        if ($largocombinada > 0) {
            for ($i = 0; $i < $largocombinada; $i++) {
                $listaasignatura[$i] = unserialize($datosasignaturascombinada[$i]['asignaturas']);
                $m = 0;
                for ($h = 0; $h < count($listaasignatura[$i]); $h++) {
                    $datocombinada = $modelasignatura->getnombre($listaasignatura[$i][$h]);

                    $validacom[$i][$m] = $datosasignaturascombinada[$i]['idAsignatura'];
                    $m++;
                    $validacom[$i][$m] = $datosasignaturascombinada[$i]['idAsignatura'];
                    //$m++;
                    for ($j = 0; $j < $largoalumnos; $j++) {
                        $datosalumnoscom = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 1, $id, $datocombinada[0]['idAsignatura']);
                        $datosalumnoscoms = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 2, $id, $datocombinada[0]['idAsignatura']);
                        //Primer Semestre
                        if ($listapromediostallercom) {
                            if ($datocombinada[0]['idAsignatura'] == $listapromediostallercom[$j][$datocombinada[0]['idAsignatura']]['idAsignatura']) {
                                $datosalumnoscom[] = $listapromediostallercom[$j][$datocombinada[0]['idAsignatura']];
                            }

                        }
                        //Segundo Semestre
                        if ($listapromediostallercoms) {
                            if ($datocombinada[0]['idAsignatura'] == $listapromediostallercoms[$j][$datocombinada[0]['idAsignatura']]['idAsignatura']) {
                                $datosalumnoscoms[] = $listapromediostallercoms[$j][$datocombinada[0]['idAsignatura']];
                            }

                        }


                        for ($k = 0; $k < count($datosalumnoscom); $k++) {
                            if ($datocombinada[0]['idAsignatura'] == $datosalumnoscom[$k]['idAsignatura']) {
                                if ($datosalumnoscom[$k]['coef'] == 2) {
                                    if ($datosalumnoscom[$k]['nota'] > 0) {
                                        $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];
                                        $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];

                                    } else {
                                        $promediocom[$j][$m][] = 0;
                                        $promediocom[$j][$m][] = 0;
                                    }

                                } else {

                                    if ($datosalumnoscom[$k]['nota'] == 0 || empty($datosalumnoscom[$k]['nota']) || $datosalumnoscom[$k]['nota'] == NULL || $datosalumnoscom[$k]['nota'] == '') {
                                        if (!empty($datosalumnoscom[$k]["forma"])) {
                                            if ($datosalumnoscom[$k]['nota'] == 0) {
                                                $promediocom[$j][$m][] = 0;
                                            }

                                        } else {
                                            $promediocom[$j][$m][] = 0;
                                        }


                                    } else {
                                        if (!empty($datosalumnoscom[$k]["forma"]) && $datosalumnoscom[$k]["forma"] == 2) {
                                            $promtalleraux = $datosalumnoscom[$k]['nota'];
                                            $porcentajetaller = $datosalumnoscom[$k]["porcentaje"];


                                        } elseif (!empty($datosalumnoscom[$k]["forma"]) && $datosalumnoscom[$k]["forma"] == 1) {
                                            $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];
                                            $promtalleraux = array();
                                            $porcentajetaller = array();
                                        } else {
                                            $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];
                                            $promtalleraux = array();
                                            $porcentajetaller = array();
                                        }


                                    }

                                }//fin else


                            }

                        }


                        for ($k = 0; $k < count($datosalumnoscoms); $k++) {
                            if ($datocombinada[0]['idAsignatura'] == $datosalumnoscoms[$k]['idAsignatura']) {
                                if ($datosalumnoscoms[$k]['coef'] == 2) {
                                    if ($datosalumnoscoms[$k]['nota'] > 0) {
                                        $promediocoms[$j][$m][] = $datosalumnoscoms[$k]['nota'];
                                        $promediocoms[$j][$m][] = $datosalumnoscoms[$k]['nota'];

                                    } else {
                                        $promediocoms[$j][$m][] = 0;
                                        $promediocoms[$j][$m][] = 0;
                                    }

                                } else {

                                    if ($datosalumnoscoms[$k]['nota'] == 0 || empty($datosalumnoscoms[$k]['nota']) || $datosalumnoscoms[$k]['nota'] == NULL || $datosalumnoscoms[$k]['nota'] == '') {
                                        if (!empty($datosalumnoscoms[$k]["forma"])) {
                                            if ($datosalumnoscoms[$k]['nota'] == 0) {
                                                $promediocoms[$j][$m][] = 0;
                                            }

                                        } else {
                                            $promediocoms[$j][$m][] = 0;
                                        }


                                    } else {
                                        if (!empty($datosalumnoscoms[$k]["forma"]) && $datosalumnoscoms[$k]["forma"] == 2) {
                                            $promtallerauxs = $datosalumnoscoms[$k]['nota'];
                                            $porcentajetallers = $datosalumnoscoms[$k]["porcentaje"];


                                        } elseif (!empty($datosalumnoscoms[$k]["forma"]) && $datosalumnoscoms[$k]["forma"] == 1) {
                                            $promediocoms[$j][$m][] = $datosalumnoscoms[$k]['nota'];
                                            $promtallerauxs = array();
                                            $porcentajetallers = array();
                                        } else {
                                            $promediocoms[$j][$m][] = $datosalumnoscoms[$k]['nota'];
                                            $promtallerauxs = array();
                                            $porcentajetallers = array();
                                        }


                                    }

                                }//fin else


                            }

                        }
                        //Primer Semestre Promedio
                        if (!empty($promediocom[$j][$m])) {
                            $promset = array_diff($promediocom[$j][$m], array('0'));
                        } else {
                            $promset = 0;
                        }

                        if (is_array($promset)) {
                            if (count($promset) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    if ($porcentajetaller) {
                                        $totalporcentaje = 100;
                                        $porcentajeasig = $totalporcentaje - $porcentajetaller;
                                        $promedioauxalum = array_sum($promset) / count($promset);
                                        //$promcom[$j][$m]['nota'] = round(array_sum($promset) / count($promset));
                                        $promcom[$j][$m]['nota'] = round(($promedioauxalum * ($porcentajeasig / 100)) + ($promtalleraux * ($porcentajetaller / 100)));

                                    } else {
                                        $promcom[$j][$m]['nota'] = round(array_sum($promset) / count($promset));
                                    }

                                } else {
                                    if ($porcentajetaller) {
                                        $totalporcentaje = 100;
                                        $porcentajeasig = $totalporcentaje - $porcentajetaller;
                                        $promedioauxalum = array_sum($promset) / count($promset);
                                        //$promcom[$j][$m]['nota'] = round(array_sum($promset) / count($promset));
                                        $promcom[$j][$m]['nota'] = round(($promedioauxalum * ($porcentajeasig / 100)) + ($promtalleraux * ($porcentajetaller / 100)));
                                        // $promcom[$j][$m]['nota'] = intval(($promedioauxalum * ($porcentajeasig / 100)) + ($promtalleraux * ($porcentajetaller / 100)));

                                    } else {
                                        $promcom[$j][$m]['nota'] = intval(array_sum($promset) / count($promset));
                                    }
                                }
                            } else {
                                $promcom[$j][$m]['nota'] = 0;
                            }

                        } else {

                            $promcom[$j] = array();
                        }
                        $promcom[$j][$m]['idAsignatura'] = $datosasignaturascombinada[$i]['idAsignatura'];
                        $promcom[$j][$m]['coef'] = 1;
                        $promcom[$j][$m]['tiempo'] = 1;

                        //Segundo Semestre
                        if (!empty($promediocoms[$j][$m])) {
                            $promsets = array_diff($promediocoms[$j][$m], array('0'));
                        } else {
                            $promsets = 0;
                        }


                        if (is_array($promsets)) {
                            if (count($promsets) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    if ($porcentajetallers) {
                                        $totalporcentajes = 100;
                                        $porcentajeasigs = $totalporcentajes - $porcentajetallers;
                                        $promedioauxalums = array_sum($promsets) / count($promsets);
                                        $promcoms[$j][$m]['nota'] = round(($promedioauxalums * ($porcentajeasigs / 100)) + ($promtallerauxs * ($porcentajetallers / 100)));


                                    } else {
                                        $promcoms[$j][$m]['nota'] = round(array_sum($promsets) / count($promsets));

                                    }

                                } else {
                                    if ($porcentajetallers) {
                                        $totalporcentajes = 100;
                                        $porcentajeasigs = $totalporcentajes - $porcentajetallers;
                                        $promedioauxalums = array_sum($promsets) / count($promsets);
                                        $promcoms[$j][$m]['nota'] = round(($promedioauxalums * ($porcentajeasigs / 100)) + ($promtallerauxs * ($porcentajetallers / 100)));


                                    } else {
                                        $promcoms[$j][$m]['nota'] = intval(array_sum($promsets) / count($promsets));

                                    }
                                }
                            } else {
                                $promcoms[$j][$m]['nota'] = 0;
                            }

                        } else {


                            $promcoms[$j][$m]['nota'] = 0;
                        }
                        $promcoms[$j][$m]['idAsignatura'] = $datosasignaturascombinada[$i]['idAsignatura'];
                        $promcoms[$j][$m]['coef'] = 1;
                        $promcoms[$j][$m]['tiempo'] = 2;


                    }
                    $m++;
                }

            }
        }


        //Taller Por Segmento Curso Completo
        $datostallersem = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(1));
        $datostallersemseg = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(2));
        $largotallerprimero = count($datostallersem);
        $largotallersegundo = count($datostallersemseg);


        $promediotaller = array();
        if ($largotallerprimero > 0) {

            for ($i = 0; $i < $largotallerprimero; $i++) {
                if (!empty($datostallersem[$i]['idConfiguracionTaller'])) {
                    $validataller[$i] = $datostallersem[$i]['idAsignaturaTaller'];
                    for ($j = 0; $j < $largoalumnos; $j++) {
                        $promediofinal = 0;
                        $datosalumnostaller = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 1, $id, $datostallersem[$i]['idAsignatura']);


                        for ($k = 0; $k < count($datosalumnostaller); $k++) {
                            if ($datostaller[$i]['idAsignatura'] == $datosalumnostaller[$k]['idAsignatura']) {
                                if ($datosalumnostaller[$k]['coef'] == 2) {
                                    if ($datosalumnostaller[$k]['nota'] > 0) {
                                        $promediotaller[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                        $promediotaller[$j][$i][] = $datosalumnostaller[$k]['nota'];

                                    } else {
                                        $promediotaller[$j][$i][] = 0;
                                        $promediotaller[$j][$i][] = 0;
                                    }

                                } else {
                                    if ($datosalumnostaller[$k]['nota'] > 0) {
                                        $promediotaller[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                    } else {
                                        $promediotaller[$j][$i][] = 0;
                                    }

                                }


                            }

                        }


                        //Primer Semestre
                        if (!empty($promediotaller[$j][$i])) {
                            $promset = array_diff($promediotaller[$j][$i], array('0'));
                        } else {
                            $promset = 0;
                        }

                        if (is_array($promset)) {
                            if (count($promset) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    $promtaller[$j][$i]['nota'] = round(array_sum($promset) / count($promset));

                                } else {
                                    $promtaller[$j][$i]['nota'] = intval(array_sum($promset) / count($promset));
                                }
                            } else {
                                $promtaller[$j][$i]['nota'] = 0;
                            }

                        } else {
                            $promtaller[$j][$i]['nota'] = 0;
                        }


                        $promtaller[$j][$i]['idAsignatura'] = $datostallersem[$i]['idAsignaturaTaller'];
                        $promtaller[$j][$i]['coef'] = 1;
                        $promtaller[$j][$i]['tiempo'] = 1;
                        $promtaller[$j][$i]['forma'] = $datostallersem[$i]['forma'];
                        $promtaller[$j][$i]['porcentaje'] = $datostallersem[$i]['porcentaje'];


                    }

                }


            }
        }

        //Segundo Semestre
        if ($largotallersegundo > 0) {

            for ($i = 0; $i < $largotallersegundo; $i++) {
                if (!empty($datostallersemseg[$i]['idConfiguracionTaller'])) {
                    $validatallers[$i] = $datostallersemseg[$i]['idAsignaturaTaller'];
                    for ($j = 0; $j < $largoalumnos; $j++) {
                        $promediofinal = 0;
                        $datosalumnostallers = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 2, $id, $datostallersemseg[$i]['idAsignatura']);

                        for ($k = 0; $k < count($datosalumnostallers); $k++) {
                            if ($datostallersemseg[$i]['idAsignatura'] == $datosalumnostallers[$k]['idAsignatura']) {
                                if ($datosalumnostallers[$k]['coef'] == 2) {
                                    if ($datosalumnostallers[$k]['nota'] > 0) {
                                        $promediotallers[$j][$i][] = $datosalumnostallers[$k]['nota'];
                                        $promediotallers[$j][$i][] = $datosalumnostallers[$k]['nota'];

                                    } else {
                                        $promediotallers[$j][$i][] = 0;
                                        $promediotallers[$j][$i][] = 0;
                                    }

                                } else {
                                    if ($datosalumnostallers[$k]['nota'] > 0) {
                                        $promediotallers[$j][$i][] = $datosalumnostallers[$k]['nota'];
                                    } else {
                                        $promediotallers[$j][$i][] = 0;
                                    }

                                }


                            }


                        }
                        if (!empty($promediotallers[$j][$i])) {
                            $promsets = array_diff($promediotallers[$j][$i], array('0'));
                        } else {
                            $promsets = 0;
                        }

                        if (is_array($promsets)) {
                            if (count($promsets) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    $auxtallers = round(array_sum($promsets) / count($promsets));
                                    $promtallers[$j][$i]['nota'] = intval($auxtallers);

                                } else {
                                    $promtallers[$j][$i]['nota'] = intval(array_sum($promsets) / count($promsets));
                                }
                            } else {
                                $promtallers[$j][$i]['nota'] = 0;
                            }

                        } else {
                            $promtallers[$j][$i]['nota'] = 0;
                        }


                        $promtallers[$j][$i]['idAsignatura'] = $datostallersemseg[$i]['idAsignaturaTaller'];
                        $promtallers[$j][$i]['coef'] = 1;
                        $promtallers[$j][$i]['tiempo'] = 2;
                        $promtallers[$j][$i]['forma'] = $datostallersemseg[$i]['forma'];
                        $promtallers[$j][$i]['porcentaje'] = $datostallersemseg[$i]['porcentaje'];


                    }

                }


            }
        }


        if ($largoalumnos == 0 || count($listanotas) == 0) {
            echo "<script type=\"text/javascript\">alert(\"Sin Notas\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            exit;

        }

        for ($i = 0; $i < $largoalumnos; $i++) {

            $valores = $modelnotas->listarnotasporalumno($listaalumnos[$i]['idAlumnos'], $idperiodo, $id);
            if ($valores != '' || !empty($valores)) {
                $listaalumnos[$i]['listanotas'] = $valores;
            } else {
                $listaalumnos[$i]['listanotas'] = 0;

            }
            for ($j = 0; $j < count($promtaller[$i]); $j++) {
                $listaalumnos[$i]['listanotas'][] = $promtaller[$i][$j];
                //array_unshift($listaalumnos[$i]['listanotas'], $promtaller[$i][$j]);
            }


            foreach ($promcom[$i] as $a => $j) {
                $listaalumnos[$i]['listanotas'][] = $promcom[$i][$a];
            }
            //Segundo Semestre
            for ($j = 0; $j < count($promtallers[$i]); $j++) {
                $listaalumnos[$i]['listanotas'][] = $promtallers[$i][$j];
            }

            foreach ($promcoms[$i] as $a => $j) {
                $listaalumnos[$i]['listanotas'][] = $promcoms[$i][$a];
            }

            if ($listapromediostaller[$i]) {
                for ($j = 0; $j < count($listapromediostaller[$i]); $j++) {
                    $listaalumnos[$i]['listanotas'][] = $listapromediostaller[$i][$j];
                }
            }

            if ($listapromediostallers[$i]) {
                for ($j = 0; $j < count($listapromediostallers[$i]); $j++) {
                    $listaalumnos[$i]['listanotas'][] = $listapromediostallers[$i][$j];
                }
            }


        }

        $titulo = "Informe De Ranking Final";
        $tituloest = "<b>" . $datoscurso[0]['nombreEstablecimiento'] . "</b>";
        $logo = getcwd();
        $logo .= "/application/documentos/logos/" . $datoscurso[0]['extension'];
        if (file_exists($logo)) {
            $plogo = '<p style="position:absolute;top:2px;text-align:center"><img  src="' . $logo . '" /></p>';
        } else {
            $plogo = '';
        }
        $encabezado = $plogo . '<h4 style="position:absolute;top:100px;text-align:center">' . $tituloest . '</h4><h4 style="position:absolute;top:120px;text-align:center">' . $titulo . '</h4><h4 style="position:absolute;top:140px;text-align:center">' . $datoscurso[0]['nombreGrado'] . ' ' . $datoscurso[0]['letra'] . '</h4>';
        $html = $encabezado;


        //Agregamos cantidad de notas por alumno y la asignamos a cada aisgnatura


        if (!empty($datosasignaturas)) {
            $largoasignatura = count($datosasignaturas);
            for ($i = 0; $i < $largoasignatura; $i++) {

                $datoscuenta[$i] = $modelnotas->listarcantidadnotasanual($id, $idperiodo, $datosasignaturas[$i]['idAsignatura']);
                if (empty($datoscuenta[$i]) && $datosasignaturas[$i]['tipoAsignatura'] == 1) {
                    $datosasig[$i] = 0;
                } else {
                    $largonotas = count($datoscuenta[$i]);
                    $datosasig[$i] = 0;
                    //Primer Semestre
                    for ($j = 0; $j < count($validataller); $j++) {
                        if ($datosasignaturas[$i]['idAsignatura'] == $validataller[$j]) {
                            $datosasig[$i] += 1;
                        }
                    }
                    //Segundo Semestre

                    for ($j = 0; $j < count($validatallers); $j++) {
                        if ($datosasignaturas[$i]['idAsignatura'] == $validatallers[$j]) {
                            $datosasig[$i] += 1;
                        }
                    }
                    for ($j = 0; $j < count($validacom); $j++) {
                        for ($k = 0; $k < count($validacom[$j]); $k++) {
                            if ($datosasignaturas[$i]['idAsignatura'] == $validacom[$j][$k]) {

                                $datosasig[$i] += 1;
                            }
                        }

                    }

                    for ($j = 0; $j < count($datostalleres); $j++) {
                        if ($datosasignaturas[$i]['idAsignatura'] == $datostalleres[$j]['idAsignaturaTaller']) {
                            $datosasig[$i] += 1;
                        }
                    }

                    for ($j = 0; $j < $largonotas; $j++) {

                        if ($datoscuenta[$i][$j]['coef'] == 2) {
                            $datosasig[$i] += 2;
                        } else {
                            $datosasig[$i] += 1;
                        }

                    }


                }

                //Si la configuracion indica que se utiliza examen
                if ($datoscurso[0]['examen'] == 1) {
                    $modeloprueba = new Application_Model_DbTable_Pruebas();
                    //Veficiamos que las asignaturas posean examen
                    $datosexamenes[$i] = $modeloprueba->getexamen($id, $idperiodo, $datosasignaturas[$i]['idAsignatura'], 6);

                }


            }
        } else {
            echo "<script type=\"text/javascript\">alert(\"El Curso no Posee Asignaturas en el periodo\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            exit;

        }


        $cuentapag2 = array();
        $contadorpag = 0;


        if (!empty($listaalumnos)) {
            $r = 0;

            for ($i = 0; $i < $largoalumnos; $i++) {


                $pag = 0;
                $cuentapag = 0;

                $r = 0;


                for ($j = 0; $j < $largoasignatura; $j++) {

                    $promtalleraux = array();
                    $porcentajetaller = array();
                    $sumataller = 0;
                    $promtallerauxs = array();
                    $porcentajetallers = array();
                    $sumatallers = 0;
                    $row = $datosasig[$j];
                    $cuentapag += 1;


                    $promedio = 0;
                    $contador = 0;
                    $contadorpromedio = 0;
                    $promedios = 0;
                    $contadorpromedios = 0;
                    if ($row != 0) {
                        $largolistanota = count($listaalumnos[$i]['listanotas']);
                        for ($z = 0; $z < $largolistanota; $z++) {
                            $contadoraux = 0;

                            //if ($datosasignaturas[$j]['idAsignatura'] == $listaalumnos[$i]['listanotas'][$z]['idAsignatura']) {
                            if ($datosasignaturas[$j]['idAsignatura'] == $listaalumnos[$i]['listanotas'][$z]['idAsignatura']) {


                                //Primer Semesre
                                if ($listaalumnos[$i]['listanotas'][$z]['tiempo'] == 1) {

                                    if ($listaalumnos[$i]['listanotas'][$z]['coef'] == 2) {
                                        $contador += 2;
                                        if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == NULL || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {
                                            $promedio += 0;
                                            $contadorpromedio += 0;


                                        } else {
                                            $promedio += ($listaalumnos[$i]['listanotas'][$z]['nota'] + $listaalumnos[$i]['listanotas'][$z]['nota']);
                                            $contadorpromedio += 2;

                                        }

                                    } else {
                                        $contador += 1;

                                        if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == NULL || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {
                                            if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"])) {
                                                if ($listaalumnos[$i]["listanotas"][$z]["nota"] == 0) {

                                                    $promedio += 0;
                                                    $contadorpromedio += 0;

                                                }

                                            } else {
                                                $promedio += 0;
                                                $contadorpromedio += 0;


                                            }


                                        } else {
                                            if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"]) && $listaalumnos[$i]["listanotas"][$z]["forma"] == 2) {

                                                $contadorauxtaller = true;
                                                $promtalleraux[] = $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $porcentajetaller[] = $listaalumnos[$i]["listanotas"][$z]["porcentaje"];


                                            } else {

                                                $promedio += $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $contadorpromedio += 1;


                                            }


                                        }


                                    }
                                }
                                if ($listaalumnos[$i]['listanotas'][$z]['tiempo'] == 2) {


                                    if ($listaalumnos[$i]['listanotas'][$z]['coef'] == 2) {
                                        $contador += 2;
                                        if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == NULL || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {
                                            $promedios += 0;
                                            $contadorpromedios += 0;


                                        } else {
                                            $promedios += ($listaalumnos[$i]['listanotas'][$z]['nota'] + $listaalumnos[$i]['listanotas'][$z]['nota']);
                                            $contadorpromedios += 2;

                                        }

                                    } else {


                                        $contador += 1;

                                        if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == NULL || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {
                                            if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"])) {
                                                if ($listaalumnos[$i]["listanotas"][$z]["nota"] == 0) {

                                                    $promedios += 0;
                                                    $contadorpromedios += 0;

                                                }

                                            } else {
                                                $promedios += 0;
                                                $contadorpromedios += 0;


                                            }


                                        } else {
                                            if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"]) && $listaalumnos[$i]["listanotas"][$z]["forma"] == 2) {

                                                $contadorauxtallers = true;
                                                $promtallerauxs[] = $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $porcentajetallers[] = $listaalumnos[$i]["listanotas"][$z]["porcentaje"];


                                            } else {

                                                $promedios += $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $contadorpromedios += 1;


                                            }


                                        }


                                    }
                                }


                                //Promedios por notas

                                if ($contador == $row) {


                                    if ($contadorpromedio != 0 && $promedio != 0) {
                                        $promedioaux = 0;
                                        //SI el Taller es por porcentaje
                                        if ($contadorauxtaller) {
                                            $totalporcentaje = 100;
                                            if (count($promtalleraux) > 1) {
                                                for ($t = 0; $t < count($promtalleraux); $t++) {
                                                    $totalporcentaje = $totalporcentaje - $porcentajetaller[$t];
                                                    $sumataller += $promtalleraux[$t] * ($porcentajetaller[$t] / 100);
                                                }

                                            } else {
                                                $totalporcentaje = 100 - $porcentajetaller[0];
                                                $sumataller = $promtalleraux[0] * ($porcentajetaller[0] / 100);

                                            }


                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioaux = round($promedio / $contadorpromedio);
                                                $promedioaux = ($promedioaux * ($totalporcentaje / 100)) + $sumataller;
                                                $promedioaux = round($promedioaux);
                                                $notamatriz[$r][] = $promedioaux;

                                            } else {
                                                $promedioaux = round($promedio / $contadorpromedio);
                                                $promedioaux = ($promedioaux * ($totalporcentaje / 100)) + $sumataller;
                                                $promedioaux = intval($promedioaux);
                                                $notamatriz[$r][] = $promedioaux;
                                            }

                                        } else {

                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioaux = round($promedio / $contadorpromedio);
                                                $promfinal[$i][] = $promedioaux;
                                                $notamatriz[$r][] = $promedioaux;

                                            } else {
                                                $promedioaux = intval($promedio / $contadorpromedio);
                                                $promfinal[$i][] = $promedioaux;
                                                $notamatriz[$r][] = $promedioaux;
                                            }

                                        }
                                        $r++;


                                    } else {
                                        $promedioaux = 0;
                                        $promfinal[$i][] = 0;
                                        $notamatriz[$r][] = 0;

                                        $r++;


                                    }


                                    //Segundo Semestre
                                    if ($contadorpromedios != 0 && $promedios != 0) {
                                        $promedioauxs = 0;
                                        //SI el Taller es por porcentaje
                                        if ($contadorauxtallers) {
                                            $totalporcentajes = 100;
                                            if (count($promtallerauxs) > 1) {
                                                for ($t = 0; $t < count($promtallerauxs); $t++) {
                                                    $totalporcentajes = $totalporcentajes - $porcentajetallers[$t];
                                                    $sumatallers += $promtallerauxs[$t] * ($porcentajetallers[$t] / 100);
                                                }

                                            } else {
                                                $totalporcentajes = 100 - $porcentajetallers[0];
                                                $sumatallers = $promtallerauxs[0] * ($porcentajetallers[0] / 100);

                                            }


                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioauxs = round($promedios / $contadorpromedios);
                                                $promedioauxs = ($promedioauxs * ($totalporcentajes / 100)) + $sumatallers;
                                                $promedioauxs = round($promedioauxs);
                                                $notamatriz[$r][] = $promedioauxs;

                                            } else {
                                                $promedioauxs = round($promedios / $contadorpromedios);
                                                $promedioauxs = ($promedioauxs * ($totalporcentajes / 100)) + $sumatallers;
                                                $promedioauxs = intval($promedioauxs);
                                                $notamatriz[$r][] = $promedioauxs;
                                            }

                                        } else {

                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioauxs = round($promedios / $contadorpromedios);
                                                $promfinal[$i][] = $promedioauxs;
                                                $notamatriz[$r][] = $promedioauxs;

                                            } else {
                                                $promedioauxs = intval($promedios / $contadorpromedios);
                                                $promfinal[$i][] = $promedioauxs;
                                                $notamatriz[$r][] = $promedioauxs;
                                            }
                                        }
                                        $r++;


                                    } else {
                                        $promedioauxs = 0;
                                        $promfinal[$i][] = 0;
                                        $notamatriz[$r][] = 0;
                                        $r++;


                                    }


                                    //Promedio Final De Asignatura
                                    $finalasignatura = 0;

                                    if ($promedioaux != 0 && $promedioauxs != 0) {

                                        if ($datoscurso[0]['aproxAnual'] == 1) {
                                            $finalasignatura = round(($promedioaux + $promedioauxs) / 2);
                                        } else {
                                            $finalasignatura = intval(($promedioaux + $promedioauxs) / 2);

                                        }
                                        if ($agregadecimas) {
                                            if ($finalasignatura >= 60) {
                                                $finalasignatura += 2;
                                                if ($finalasignatura > 70) {
                                                    $finalasignatura = 70;

                                                }

                                            }
                                        }


                                    }

                                    if ($promedioaux == 0 && $promedioauxs == 0) {
                                        $finalasignatura = 0;


                                    }

                                    if ($promedioaux == 0 && $promedioauxs != 0) {

                                        $finalasignatura = $promedioauxs;

                                        if ($agregadecimas) {
                                            if ($finalasignatura >= 60) {
                                                $finalasignatura += 2;
                                                if ($finalasignatura > 70) {
                                                    $finalasignatura = 70;

                                                }

                                            }
                                        }


                                    }
                                    if ($promedioaux != 0 && $promedioauxs == 0) {
                                        $finalasignatura = $promedioaux;
                                        if ($agregadecimas) {
                                            if ($finalasignatura >= 60) {
                                                $finalasignatura += 2;
                                                if ($finalasignatura > 70) {
                                                    $finalasignatura = 70;

                                                }

                                            }
                                        }


                                    }


                                    //Inicio Examen

                                    if (count($datosexamenes[$j]) > 0) {
                                        //$promediototal[$i][] = $finalasignatura;
                                        $notamatriz[$r][] = $finalasignatura;
                                        $r++;

                                        $datosalumnosexamen = $modelnotas->getnotasexamenalumno($datosexamenes[$j][0]['idEvaluacion'], $id, $datosasignaturas[$j]['idAsignatura'], $idperiodo, 6, $listaalumnos[$i]['idAlumnos']);


                                        if (count($datosalumnosexamen) > 0) {


                                            if ($datosalumnosexamen[0]['nota'] > 0) {
                                                $notamatriz[$r][] = $datosalumnosexamen[0]['nota'];
                                                $r++;

                                                $totalex = 100 - $datosexamenes[$j][0]['porcentajeExamen'];

                                                //nota d examen

                                                $sumaex = $datosalumnosexamen[0]['nota'] * ($datosexamenes[$i][0]['porcentajeExamen'] / 100);

                                                if ($datoscurso[0]['aproxExamen'] == 1) {
                                                    $finalasignatura = round(($finalasignatura * ($totalex / 100)) + $sumaex);
                                                } else {
                                                    $finalasignatura = intval(($finalasignatura * ($totalex / 100)) + $sumaex);
                                                }


                                            } else {
                                                $notamatriz[$r][] = $datosalumnosexamen[0]['nota'];
                                                $r++;
                                                $finalasignatura = $finalasignatura;
                                            }

                                        } else {
                                            $notamatriz[$r][] = 0;
                                            $r++;
                                        }
                                        //Promedio FInal
                                        $promediototal[$i][] = $finalasignatura;
                                        $notamatriz[$r][] = $finalasignatura;
                                        $r++;
                                    } else {
                                        $promediototal[$i][] = $finalasignatura;
                                        $notamatriz[$r][] = $finalasignatura;
                                        $r++;
                                    }

                                }// fin promedio por notas

                            }

                        }// fin for


                    } else {

                        $notamatriz[$r][] = 0;
                        $r++;
                        $notamatriz[$r][] = 0;
                        $r++;
                        $notamatriz[$r][] = 0;
                        $r++;


                    } //fin if row


                } //fin for Asignaturas


                if ($promediototal[$i] != '' || $promediototal[$i] != null) {

                    if ($datoscurso[0]['aproxFinal'] == 1) {//Aproxima
                        $promsetfinal = array_diff($promediototal[$i], array('0'));
                        $promediofinal = round(array_sum($promsetfinal) / count($promsetfinal), intval($datoscurso[0]['decimas']));

                    } else {
                        $promsetfinal = array_diff($promediototal[$i], array('0'));
                        $promediofinal = array_sum($promsetfinal) / count($promsetfinal);
                        $promediofinal = number_format((float)$promediofinal, intval($datoscurso[0]['decimas']), '.', '');


                    }


                    $alumnoslista[] = array('Alumnos' => strtr(strtoupper($listaalumnos[$i]["apaterno"]), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . ' ' . strtr(strtoupper($listaalumnos[$i]["amaterno"]), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . ' ' . strtr(strtoupper($listaalumnos[$i]["nombres"]), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ"), 'Promedio' => $promediofinal);


                } else {
                    $alumnoslista[] = array('Alumnos' => strtr(strtoupper($listaalumnos[$i]["apaterno"]), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . ' ' . strtr(strtoupper($listaalumnos[$i]["amaterno"]), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . ' ' . strtr(strtoupper($listaalumnos[$i]["nombres"]), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ"), 'Promedio' => 0);

                }


            }


        }

        //Estilo pdf
        $style = "body{
        font:12px ,Arial, Tahoma, Verdana, Helvetica, sans-serif;
        
        color:#000;
        }
        img{
          width:60px;
          height:70px;
        }
        
        
        table{
        font-size:10px;
        width:100%;
        height:auto;
        margin:10px 0 10px 0;
        border-collapse:collapse;
        text-align:center;
        text-justify:inter-word;
        color:#000000;
        }
        
        table td,th{
        border:1px solid black;
        }
        
        table th{
        padding:1px;
        background-color: #ccc;
        }
        ";


        usort($alumnoslista, function ($a, $b) {
            return $b['Promedio'] > $a['Promedio'] ? 1 : -1;

        });
        $html .= '<table align="center"><tr><th>Ranking</th><th>Nombre Alumno</th><th>Promedio</th></tr>';
        $auxpromedio = 0;
        $cont = 0;
        for ($i = 0; $i < count($alumnoslista); $i++) {
            if ($auxpromedio != $alumnoslista[$i]['Promedio']) {
                $cont = $cont + 1;
            }
            $auxpromedio = $alumnoslista[$i]['Promedio'];
            $html .= '<tr><td>' . $cont . '</td><td style="text-align: left;padding-right: 3px;">' . $alumnoslista[$i]['Alumnos'] . '</td><td>' . $alumnoslista[$i]['Promedio'] . '</td></tr>';
        }
        $html .= '</table>';

        $valoresprofesor = unserialize($datoscurso[0]['profesor']);
        if ($valoresprofesor[3] == 1) {
            $tdnombreprofesor = "<p style='text-decoration:underline;margin-left:30px;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</p>";
            $tdprofesor = "Profesor(a) Jefe.";
        } else {
            $tdnombreprofesor = "";
            $tdprofesor = "";
        }

        $valoresdirector = unserialize($datoscurso[0]['director']);
        if ($valoresdirector[3] == 1) {
            $tdnombredirector = "<p style='text-decoration:underline;'>" . $director['nombrescuenta'] . " " . $director['paternocuenta'] . " " . $director['maternocuenta'] . "</p>";
            $tddirector = "Director(a).";
        } else {
            $tdnombredirector = "";
            $tddirector = "";
        }


        $html .= "<table align='center' style='margin-top:25px;' class='page_firmas'>
            <tr>
                <td style='width: 33%; text-align: center;border:none;'>" . $tdnombreprofesor . "</td>
                <td style='width: 33%; text-align: center;border:none;'></td>
                <td style='width: 33%; text-align: center;border:none;'>" . $tdnombredirector . "</td>
            </tr>
            <tr>
                <td style='width: 33%; text-align:center;border:none;padding-top:35px'>" . $tdprofesor . "</td>
                <td style='width: 33%; text-align: center;border:none;padding-top:35px'></td>
                <td style='width: 33%; text-align:center;border:none;padding-top:35px'>" . $tddirector . "</td>
            </tr>
            <tr>
                <td colspan='3' style='text-align:center;border:none;padding-top:15px'>" . $fecha_final . ".</td>
            </tr>
            </table>";

        if ($html != '') {

            require('fpdf/html2pdf.class.php');
            try {
                //Orientación / formato del pdf y el idioma.
                $pdf = new HTML2PDF('P', 'LETTER', 'es', array(10, 10, 10, 10) /*márgenes*/); //los márgenes también pueden definirse en <page> ver documentación

                $pdf->WriteHTML('<page><html>
        <head>
            <style>' . $style . '</style>
        </head>
        <body> <page_footer>
        <table class="page_footer">
            <tr>
            <td style="width: 40%; text-align: left;border:none;"></td>
                <td style="width: 60%; text-align: right;border:none;font-size:8px">

                </td>
            </tr>
        </table>
    </page_footer>' . $html . '</body></html></page>');


                if (preg_match("/MSIE/i", $_SERVER["HTTP_USER_AGENT"])) {
                    header("Content-type: application/PDF");
                } else {
                    header("Content-type: application/PDF");
                    header("Content-Type: application/pdf");
                }

                $pdf->Output('Planificacion.pdf', I);
            } catch (HTML2PDF_exception $e) {
                //echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, intente nuevamente\");</script>";
                //echo "<script>parent.$.fancybox.close();</script>";
                echo $e;
            }
        }


    }

    public function generarrankingsegAction()
    {
        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();

        $id = $this->_getParam('id', 0);
        $seg = $this->_getParam('s', 0);


        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $modelcurso = new Application_Model_DbTable_Cursos();
        $modelnotas = new Application_Model_DbTable_Notas();
        $modelasignatura = new Application_Model_DbTable_Asignaturascursos();
        $modeldetalle = new Application_Model_DbTable_AlumnosDetalle();


        $datoscurso = $modelcurso->listarcursoid($id, $idperiodo);

        //fecha actual

        $date = new DateTime;
        $fechain = $date->format('Y-m-d');
        $cortado = explode("-", $fechain);
        $dias = array("Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado");
        $meses = array("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre");

        $fecha_final = $dias[date('w', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]))] . " " . $cortado[2] . " de " . $meses[date('n', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0])) - 1] . " del " . date('Y', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]));


        $listaalumnos = $modelnotas->listaralumnoscurso($id, $idperiodo);
        $listanotas = $modelnotas->listarnotascursoperiodo($id, $idperiodo, array($seg));
        $tipos = array('1', '3');
        $datosasignaturas = $modelasignatura->listarporcurso($id, 1, $tipos, $idperiodo);
        $datostallersem = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array($seg));

        $datostalleranual = $modelasignatura->gettalleranual($id, $idperiodo, array(1), 1);
        $datosasignaturascombinada = $modelasignatura->getcombinada($id, $idperiodo);
        $largoalumnos = count($listaalumnos);

        $largocombinada = count($datosasignaturascombinada);
        $m = 0;

        $datostaller = array_merge($datostallersem, $datostalleranual);
        $largotaller = count($datostaller);


        //Talleres para Alumnos Separados

        //Notas de talleres

        //Configuraciones de Taller

        //Configuracion de Taller Buscamos si existen configuraciones por alumnos

        $modelotallerdetalle = new Application_Model_DbTable_Asignaturascursos();
        //Obtiene los Talleres que son Semestrales Tiempo=2.
        $datostalleres = $modelasignatura->gettaller($id, $idperiodo, array(2), 2, array($seg));
        $promediotalleralumnos = array();


        if ($datostalleres) {

            for ($j = 0; $j < $largoalumnos; $j++) {

                for ($i = 0; $i < count($datostalleres); $i++) {
                    $detalletaller = $modelotallerdetalle->gettallersegmento($datostalleres[$i]['idConfiguracionTaller'], $seg, $listaalumnos[$j]['idAlumnos']);

                    if ($detalletaller) {
                        $datosalumnostaller = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, $seg, $id, $detalletaller[0]['idAsignatura']);

                        if ($datosalumnostaller) {
                            for ($k = 0; $k < count($datosalumnostaller); $k++) {


                                if ($datostalleres[$i]['idAsignatura'] == $datosalumnostaller[$k]['idAsignatura']) {
                                    if ($datosalumnostaller[$k]['coef'] == 2) {
                                        if ($datosalumnostaller[$k]['nota'] > 0) {
                                            $promediotalleralumnos[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                            $promediotalleralumnos[$j][$i][] = $datosalumnostaller[$k]['nota'];

                                        } else {
                                            $promediotalleralumnos[$j][$i][] = 0;
                                            $promediotalleralumnos[$j][$i][] = 0;
                                        }

                                    } else {
                                        if ($datosalumnostaller[$k]['nota'] > 0) {
                                            $promediotalleralumnos[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                        } else {
                                            $promediotalleralumnos[$j][$i][] = 0;
                                        }

                                    }


                                }


                            }
                        }
                        if (!empty($promediotalleralumnos[$j][$i])) {
                            $promsetalumnos = array_diff($promediotalleralumnos[$j][$i], array('0'));
                        } else {
                            $promsetalumnos = 0;
                        }

                        if (is_array($promsetalumnos)) {
                            if (count($promsetalumnos) > 0) {

                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    $promtalleralumnos[$j][$i]['nota'] = round(array_sum($promsetalumnos) / count($promsetalumnos));

                                } else {
                                    $promtalleralumnos[$j][$i]['nota'] = intval(array_sum($promsetalumnos) / count($promsetalumnos));
                                }
                            } else {
                                $promtalleralumnos[$j][$i]['nota'] = 0;
                            }
                        } else {
                            $promtalleralumnos[$j][$i]['nota'] = 0;
                        }


                        $promtalleralumnos[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                        $promtalleralumnos[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                        $promtalleralumnos[$j][$i]['coef'] = 1;
                        $promtalleralumnos[$j][$i]['tiempo'] = intval($seg);
                        $promtalleralumnos[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                        $promtalleralumnos[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];

                    } else {
                        $promtalleralumnos[$j][$i]['nota'] = 0;
                        $promtalleralumnos[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                        $promtalleralumnos[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                        $promtalleralumnos[$j][$i]['coef'] = 1;
                        $promtalleralumnos[$j][$i]['tiempo'] = intval($seg);
                        $promtalleralumnos[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                        $promtalleralumnos[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];
                    }

                }


                for ($l = 0; $l < count($promtalleralumnos[$j]); $l++) {

                    $datosdestino = $modelotallerdetalle->getdestino($promtalleralumnos[$j][$l]["idAsignatura"]);
                    if ($datosdestino[0]['tipoAsignatura'] != 4) {
                        $listapromediostaller[$j][] = $promtalleralumnos[$j][$l];
                    } else {
                        $listapromediostallercom[] = $promtalleralumnos[$j][$l];
                    }


                }

            }
        }

        //Determinamos el tipo de Asignatura de destino si es normal o compuesta

        /* if(!empty($datostalleres[$i]["idAsignaturaTaller"])){
            $datosdestino=$modelotallerdetalle->getdestino($datostalleres[$i]["idAsignaturaTaller"]);

            if($datosdestino[0]['tipoAsignatura']==4){
                $destinoalumnos[$i]=true;
            }else{
                $destinoalumnos[$i]=false;
            }



}*/


        if ($largocombinada > 0) {
            for ($i = 0; $i < $largocombinada; $i++) {
                $listaasignatura[$i] = unserialize($datosasignaturascombinada[$i]['asignaturas']);
                for ($h = 0; $h < count($listaasignatura[$i]); $h++) {
                    $datocombinada = $modelasignatura->getnombre($listaasignatura[$i][$h]);
                    $validacom[$i][$h] = $datosasignaturascombinada[$i]['idAsignatura'];
                    for ($j = 0; $j < $largoalumnos; $j++) {
                        $datosalumnoscom = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, $seg, $id, $datocombinada[0]['idAsignatura']);
                        if ($listapromediostallercom) {
                            $datosalumnoscom[] = $listapromediostallercom[$j];
                        }


                        for ($k = 0; $k < count($datosalumnoscom); $k++) {
                            if ($datocombinada[0]['idAsignatura'] == $datosalumnoscom[$k]['idAsignatura']) {
                                if ($datosalumnoscom[$k]['coef'] == 2) {
                                    if ($datosalumnoscom[$k]['nota'] > 0) {
                                        $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];
                                        $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];

                                    } else {
                                        $promediocom[$j][$m][] = 0;
                                        $promediocom[$j][$m][] = 0;
                                    }

                                } else {
                                    /*if ($datosalumnoscom[$k]['nota'] > 0) {
                                        $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];
                                    } else {
                                        $promediocom[$j][$m][] = 0;
                                    }*/


                                    if ($datosalumnoscom[$k]['nota'] == 0 || empty($datosalumnoscom[$k]['nota']) || $datosalumnoscom[$k]['nota'] == NULL || $datosalumnoscom[$k]['nota'] == '') {
                                        if (!empty($datosalumnoscom[$k]["forma"])) {
                                            if ($datosalumnoscom[$k]['nota'] == 0) {
                                                $promediocom[$j][$m][] = 0;
                                            }

                                        } else {
                                            $promediocom[$j][$m][] = 0;
                                        }


                                    } else {
                                        if (!empty($datosalumnoscom[$k]["forma"]) && $datosalumnoscom[$k]["forma"] == 2) {

                                            //$promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];
                                            $promtalleraux = $datosalumnoscom[$k]['nota'];
                                            $porcentajetaller = $datosalumnoscom[$k]["porcentaje"];


                                        } elseif (!empty($datosalumnoscom[$k]["forma"]) && $datosalumnoscom[$k]["forma"] == 1) {
                                            $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];
                                            $promtalleraux = array();
                                            $porcentajetaller = array();
                                        } else {
                                            $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];
                                            $promtalleraux = array();
                                            $porcentajetaller = array();
                                        }


                                    }

                                }//fin else


                            }

                        }


                        if (!empty($promediocom[$j][$m])) {
                            $promset = array_diff($promediocom[$j][$m], array('0'));
                        } else {
                            $promset = 0;
                        }

                        if (is_array($promset)) {
                            if (count($promset) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    if ($porcentajetaller) {
                                        $totalporcentaje = 100;
                                        $porcentajeasig = $totalporcentaje - $porcentajetaller;
                                        $promedioauxalum = array_sum($promset) / count($promset);
                                        //$promcom[$j][$m]['nota'] = round(array_sum($promset) / count($promset));
                                        $promcom[$j][$m]['nota'] = round(($promedioauxalum * ($porcentajeasig / 100)) + ($promtalleraux * ($porcentajetaller / 100)));

                                    } else {
                                        $promcom[$j][$m]['nota'] = round(array_sum($promset) / count($promset));
                                    }

                                } else {
                                    if ($porcentajetaller) {
                                        $totalporcentaje = 100;
                                        $porcentajeasig = $totalporcentaje - $porcentajetaller;
                                        $promedioauxalum = array_sum($promset) / count($promset);
                                        //$promcom[$j][$m]['nota'] = round(array_sum($promset) / count($promset));
                                        $promcom[$j][$m]['nota'] = intval(($promedioauxalum * ($porcentajeasig / 100)) + ($promtalleraux * ($porcentajetaller / 100)));

                                    } else {
                                        $promcom[$j][$m]['nota'] = intval(array_sum($promset) / count($promset));
                                    }
                                }
                            } else {
                                $promcom[$j][$m]['nota'] = 0;
                            }

                        } else {

                            $promcom[$j][$m]['nota'] = 0;
                        }
                        $promcom[$j][$m]['idAsignatura'] = $datosasignaturascombinada[$i]['idAsignatura'];
                        $promcom[$j][$m]['coef'] = 1;


                    }
                    $m++;
                }

            }
        }


//Talleres para curso Completp

        $promediotaller = array();
        if ($largotaller > 0) {

            for ($i = 0; $i < $largotaller; $i++) {
                if (!empty($datostaller[$i]['idConfiguracionTaller'])) {
                    $validataller[$i] = $datostaller[$i]['idAsignaturaTaller'];
                    for ($j = 0; $j < $largoalumnos; $j++) {
                        $datosalumnostaller = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, $seg, $id, $datostaller[$i]['idAsignatura']);


                        for ($k = 0; $k < count($datosalumnostaller); $k++) {
                            if ($datostaller[$i]['idAsignatura'] == $datosalumnostaller[$k]['idAsignatura']) {
                                if ($datosalumnostaller[$k]['coef'] == 2) {
                                    if ($datosalumnostaller[$k]['nota'] > 0) {
                                        $promediotaller[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                        $promediotaller[$j][$i][] = $datosalumnostaller[$k]['nota'];

                                    } else {
                                        $promediotaller[$j][$i][] = 0;
                                        $promediotaller[$j][$i][] = 0;
                                    }

                                } else {
                                    if ($datosalumnostaller[$k]['nota'] > 0) {
                                        $promediotaller[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                    } else {
                                        $promediotaller[$j][$i][] = 0;
                                    }

                                }


                            }

                        }
                        if (!empty($promediotaller[$j][$i])) {
                            $promset = array_diff($promediotaller[$j][$i], array('0'));
                        } else {
                            $promset = 0;
                        }

                        if (is_array($promset)) {
                            if (count($promset) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    $promtaller[$j][$i]['nota'] = round(array_sum($promset) / count($promset));

                                } else {
                                    $promtaller[$j][$i]['nota'] = intval(array_sum($promset) / count($promset));
                                }
                            } else {
                                $promtaller[$j][$i]['nota'] = 0;
                            }

                        } else {
                            $promtaller[$j][$i]['nota'] = 0;
                        }


                        $promtaller[$j][$i]['idAsignatura'] = $datostaller[$i]['idAsignaturaTaller'];
                        $promtaller[$j][$i]['coef'] = 1;
                        $promtaller[$j][$i]['tiempo'] = intval($seg);
                        $promtaller[$j][$i]['forma'] = $datostaller[$i]['forma'];
                        $promtaller[$j][$i]['porcentaje'] = $datostaller[$i]['porcentaje'];


                    }

                }


            }
        }


        $modelCuenta = new Application_Model_DbTable_Cuentas();
        if ($datoscurso[0]['idCuentaJefe'] != 0 || empty($datoscurso[0]['idCuentaJefe'])) {
            $Profesorjefe = $modelCuenta->getusuario($datoscurso[0]['idCuentaJefe'], $idperiodo);
        }
        if ($datoscurso[0]['idDirector'] != 0 || empty($datoscurso[0]['idDirector'])) {
            $director = $modelCuenta->get($datoscurso[0]['idDirector']);
        }

        if (count($Profesorjefe) == 0 || $Profesorjefe == null) {
            echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta Profesor Jefe\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            exit;
        }

        if (count($director) == 0 || $director == null) {
            echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta Director\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            exit;
        }


        if ($largoalumnos == 0 || count($listanotas) == 0) {
            echo "<script type=\"text/javascript\">alert(\"Sin Notas\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            exit;

        }

        for ($i = 0; $i < $largoalumnos; $i++) {

            $valores = $modelnotas->listarnotasporalumnoperiodo($listaalumnos[$i]['idAlumnos'], $idperiodo, $seg, $id);
            if ($valores != '' || !empty($valores)) {
                $listaalumnos[$i]['listanotas'] = $valores;
            } else {
                $listaalumnos[$i]['listanotas'] = 0;

            }
            for ($j = 0; $j < count($promtaller[$i]); $j++) {
                $listaalumnos[$i]['listanotas'][] = $promtaller[$i][$j];
            }


            for ($j = 0; $j < count($promcom[$i]); $j++) {
                $listaalumnos[$i]['listanotas'][] = $promcom[$i][$j];
            }

            if ($listapromediostaller[$i]) {
                for ($j = 0; $j < count($listapromediostaller[$i]); $j++) {
                    $listaalumnos[$i]['listanotas'][] = $listapromediostaller[$i][$j];
                }
            }


        }


        if ($seg == 1) {
            $nombreseg = 'I Semestre';
        }
        if ($seg == 2) {
            $nombreseg = 'II Semestre';
        }

        $titulo = "Informe De Ranking " . $nombreseg;
        $tituloest = "<b>" . $datoscurso[0]['nombreEstablecimiento'] . "</b>";
        $logo = getcwd();
        $logo .= "/application/documentos/logos/" . $datoscurso[0]['extension'];
        if (file_exists($logo)) {
            $plogo = '<p style="position:absolute;top:2px;text-align:center"><img  src="' . $logo . '" /></p>';
        } else {
            $plogo = '';
        }
        $encabezado = $plogo . '<h4 style="position:absolute;top:100px;text-align:center">' . $tituloest . '</h4><h4 style="position:absolute;top:120px;text-align:center">' . $titulo . '</h4><h4 style="position:absolute;top:140px;text-align:center">' . $datoscurso[0]['nombreGrado'] . ' ' . $datoscurso[0]['letra'] . '</h4>';
        $html = $encabezado;

        if (!empty($datosasignaturas)) {
            $largoasignatura = count($datosasignaturas);
            for ($i = 0; $i < $largoasignatura; $i++) {

                $datoscuenta[$i] = $modelnotas->listarcantidadnotasasignatura($id, $idperiodo, $seg, $datosasignaturas[$i]['idAsignatura']);


                if (empty($datoscuenta[$i]) && $datosasignaturas[$i]['tipoAsignatura'] == 1) {
                    $datosasig[$i] = 0;
                } else {
                    $largonotas = count($datoscuenta[$i]);
                    $datosasig[$i] = 0;
                    for ($j = 0; $j < count($validataller); $j++) {
                        if ($datosasignaturas[$i]['idAsignatura'] == $validataller[$j]) {
                            $datosasig[$i] += 1;
                        }
                    }
                    for ($j = 0; $j < count($validacom); $j++) {
                        for ($k = 0; $k < count($validacom[$j]); $k++) {
                            if ($datosasignaturas[$i]['idAsignatura'] == $validacom[$j][$k]) {

                                $datosasig[$i] += 1;
                            }
                        }

                    }

                    for ($j = 0; $j < count($datostalleres); $j++) {
                        if ($datosasignaturas[$i]['idAsignatura'] == $datostalleres[$j]['idAsignaturaTaller']) {
                            $datosasig[$i] += 1;
                        }
                    }

                    for ($j = 0; $j < $largonotas; $j++) {

                        if ($datoscuenta[$i][$j]['coef'] == 2) {
                            $datosasig[$i] += 2;
                        } else {
                            $datosasig[$i] += 1;
                        }

                    }


                }


            }
        } else {
            echo "<script type=\"text/javascript\">alert(\"El Curso no Posee Asignaturas en el periodo\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            exit;

        }


        //Estilo pdf
        $style = "body{
        font:12px ,Arial, Tahoma, Verdana, Helvetica, sans-serif;
        
        color:#000;
        }
        img{
          width:60px;
          height:70px;
        }
        
        
        table{
        font-size:10px;
        width:100%;
        height:auto;
        margin:10px 0 10px 0;
        border-collapse:collapse;
        text-align:center;
        text-justify:inter-word;
        color:#000000;
        }
        
        table td,th{
        border:1px solid black;
        }
        
        table th{
        padding:1px;
        background-color: #ccc;
        }
        ";
        $pag = 0;
        $cuentapag = 0;
        $max = 23;


        for ($i = 0; $i < $largoasignatura; $i++) {


            //obtenemos cuantas notas existen en cada asignatura
            $row = $datosasig[$i];
            $cuentapag = $cuentapag + $row;

            // si la cantidad de notas supera las 28 sumamos al contador de pag
            if ($cuentapag > $max) {
                $pag++;
                if ($pag == 1) {
                    $max = 68;
                }
                if ($pag == 2) {
                    $max = 128;
                }
                if ($pag == 3) {
                    $max = 188;
                }


            }


            //si row es distinto de cero suma uno a row para crear el promedio
            if ($row != 0) {
                $row = $row + 1;
            } else {


            }
        }


        $pag = 0;
        $cuentapag = 0;
        $max = 23;
        $cuentapag2 = array();
        $contadorpag = 0;


        for ($i = 0; $i < $largoasignatura; $i++) {
            $row = $datosasig[$i];
            $cuentapag = $cuentapag + $row;

            // si la cantidad de notas supera las notas que ingresan en una hoja
            if ($cuentapag > $max) {

                $pag++;
                if ($pag == 1) {
                    $max = 68;
                }
                if ($pag == 2) {
                    $max = 128;
                }
                if ($pag == 3) {
                    $max = 188;
                }


            }

            if ($row != 0) {

                for ($j = 1; $j <= $row; $j++) {


                    $contadorpag++;
                    $cuentapag2[$pag] = $contadorpag;
                }

                $contadorpag++;
                $cuentapag2[$pag] = $contadorpag;
            } else {

                $contadorpag++;
                $cuentapag2[$pag] = $contadorpag;

            }
        }


        if (!empty($listaalumnos)) {
            $r = 0;

            for ($i = 0; $i < count($listaalumnos); $i++) {
                $pag = 0;
                $cuentapag = 0;
                $max = 23;
                $r = 0;
                for ($j = 0; $j < $largoasignatura; $j++) {

                    $row = $datosasig[$j];
                    $cuentapag = $cuentapag + $row;

                    if ($cuentapag > $max) {

                        $pag++;
                        if ($pag == 1) {
                            $max = 68;
                        }
                        if ($pag == 2) {
                            $max = 128;
                        }
                        if ($pag == 3) {
                            $max = 188;
                        }


                    }

                    $promedio = 0;
                    $contador = 0;
                    $contadorpromedio = 0;
                    if ($row != 0) {
                        $largolistanota = count($listaalumnos[$i]['listanotas']);
                        for ($z = 0; $z < $largolistanota; $z++) {
                            $contadoraux = 0;

                            if ($datosasignaturas[$j]['idAsignatura'] == $listaalumnos[$i]['listanotas'][$z]['idAsignatura']) {
                                $contador = $contador + 1;

                                //si la nota es coeficiente 2
                                if ($listaalumnos[$i]['listanotas'][$z]['coef'] == '2') {
                                    $contador = $contador + 1;
                                    if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == NULL || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {


                                    } else {
                                        $promedio = $promedio + ($listaalumnos[$i]['listanotas'][$z]['nota'] + $listaalumnos[$i]['listanotas'][$z]['nota']);
                                        $contadorpromedio = $contadorpromedio + 2;


                                    }


                                } else {


                                    if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == NULL || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {
                                        if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"])) {
                                            if ($listaalumnos[$i]["listanotas"][$z]["nota"] == 0) {

                                                $notamatriz[$r][] = 0;
                                            }

                                        } else {

                                            $notamatriz[$r][] = 0;
                                        }


                                    } else {
                                        if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"]) && $listaalumnos[$i]["listanotas"][$z]["forma"] == 2) {


                                            $contadoraux = $contador;
                                            $promtalleraux = $listaalumnos[$i]['listanotas'][$z]['nota'];
                                            $porcentajetaller = $listaalumnos[$i]["listanotas"][$z]["porcentaje"];


                                        } elseif (!empty($listaalumnos[$i]["listanotas"][$z]["forma"]) && $listaalumnos[$i]["listanotas"][$z]["forma"] == 1) {
                                            $promedio = $promedio + $listaalumnos[$i]['listanotas'][$z]['nota'];
                                            $contadorpromedio = $contadorpromedio + 1;

                                        } else {
                                            $promedio = $promedio + $listaalumnos[$i]['listanotas'][$z]['nota'];
                                            $contadorpromedio = $contadorpromedio + 1;

                                        }


                                    }
                                    $r++;

                                }
                                //Aumentamos el contador para notas matriz


                                //Promedios por notas
                                if ($contador == $row) {
                                    if ($contadorpromedio != 0) {
                                        $promedioaux = 0;
                                        //SI el Taller es por porcentaje
                                        if ($contador == $contadoraux) {

                                            $totalporcentaje = 100;
                                            $porcentajeasig = $totalporcentaje - $porcentajetaller;

                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioaux = round($promedio / $contadorpromedio);
                                                $promedioaux = ($promedioaux * ($porcentajeasig / 100)) + ($promtalleraux * ($porcentajetaller / 100));
                                                $promedioaux = round($promedioaux);
                                                $promfinal[$i][] = $promedioaux;


                                            } else {
                                                $promedioaux = round($promedio / $contadorpromedio);
                                                $promedioaux = ($promedioaux * ($porcentajeasig / 100)) + ($promtalleraux * ($porcentajetaller / 100));
                                                $promedioaux = intval($promedioaux);
                                                $promfinal[$i][] = $promedioaux;

                                            }

                                        } else {

                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioaux = round($promedio / $contadorpromedio);
                                                $promfinal[$i][] = $promedioaux;


                                            } else {
                                                $promedioaux = intval($promedio / $contadorpromedio);
                                                $promfinal[$i][] = $promedioaux;

                                            }
                                        }


                                    } else {
                                        if ($contador == $contadoraux) {

                                            $totalporcentaje = 100;
                                            $porcentajeasig = $totalporcentaje - $porcentajetaller;

                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima

                                                $promedioaux = $promtalleraux * ($porcentajetaller / 100);
                                                $promedioaux = round($promedioaux);
                                                $promfinal[$i][] = $promedioaux;


                                            } else {
                                                $promedioaux = $promtalleraux * ($porcentajetaller / 100);
                                                $promedioaux = intval($promedioaux);
                                                $promfinal[$i][] = $promedioaux;

                                            }


                                        } else {

                                            $promfinal[$i][] = 0;

                                        }


                                    }
                                    $r++;


                                }// fin promedio por notas

                            }


                        }// fin for


                    } else {

                        $r++;


                    } //fin if row


                } //fin for

                if ($promfinal[$i] != '' || $promfinal[$i] != null) {

                    if ($datoscurso[0]['aproxPeriodo'] == 1) {//Aproxima
                        $promsetfinal = array_diff($promfinal[$i], array('0'));
                        $promediofinal = round(array_sum($promsetfinal) / count($promsetfinal), intval($datoscurso[0]['decimas']));


                    } else {
                        $promsetfinal = array_diff($promfinal[$i], array('0'));
                        $promediofinal = array_sum($promsetfinal) / count($promsetfinal);
                        $promediofinal = number_format((float)$promediofinal, intval($datoscurso[0]['decimas']), '.', '');


                    }
                    $alumnoslista[] = array('Alumnos' => strtr(strtoupper($listaalumnos[$i]["apaterno"]), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . ' ' . strtr(strtoupper($listaalumnos[$i]["amaterno"]), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . ' ' . strtr(strtoupper($listaalumnos[$i]["nombres"]), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ"), 'Promedio' => $promediofinal);


                } else {
                    $alumnoslista[] = array('Alumnos' => strtr(strtoupper($listaalumnos[$i]["apaterno"]), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . ' ' . strtr(strtoupper($listaalumnos[$i]["amaterno"]), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . ' ' . strtr(strtoupper($listaalumnos[$i]["nombres"]), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ"), 'Promedio' => 0);
                }


            }


        }


        //Ordenamos la lista de alumnos segun el promedio ASC
        usort($alumnoslista, function ($a, $b) {
            return $b['Promedio'] > $a['Promedio'] ? 1 : -1;

        });
        $html .= '<table align="center"><tr><th>Ranking</th><th>Nombre Alumno</th><th>Promedio</th></tr>';
        $auxpromedio = 0;
        $cont = 0;
        for ($i = 0; $i < count($alumnoslista); $i++) {
            if ($auxpromedio != $alumnoslista[$i]['Promedio']) {
                $cont = $cont + 1;
            }
            $auxpromedio = $alumnoslista[$i]['Promedio'];
            $html .= '<tr><td>' . $cont . '</td><td style="text-align: left;padding-right: 3px;">' . $alumnoslista[$i]['Alumnos'] . '</td><td>' . $alumnoslista[$i]['Promedio'] . '</td></tr>';
        }
        $html .= '</table>';

        $valoresprofesor = unserialize($datoscurso[0]['profesor']);
        if ($valoresprofesor[3] == 1) {
            $tdnombreprofesor = "<p style='text-decoration:underline;margin-left:30px;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</p>";
            $tdprofesor = "Profesor(a) Jefe.";
        } else {
            $tdnombreprofesor = "";
            $tdprofesor = "";
        }

        $valoresdirector = unserialize($datoscurso[0]['director']);
        if ($valoresdirector[3] == 1) {
            $tdnombredirector = "<p style='text-decoration:underline;'>" . $director['nombrescuenta'] . " " . $director['paternocuenta'] . " " . $director['maternocuenta'] . "</p>";
            $tddirector = "Director(a).";
        } else {
            $tdnombredirector = "";
            $tddirector = "";
        }


        $html .= "<table align='center' style='margin-top:25px;' class='page_firmas'>
            <tr>
                <td style='width: 33%; text-align: center;border:none;'>" . $tdnombreprofesor . "</td>
                <td style='width: 33%; text-align: center;border:none;'></td>
                <td style='width: 33%; text-align: center;border:none;'>" . $tdnombredirector . "</td>
            </tr>
            <tr>
                <td style='width: 33%; text-align:center;border:none;padding-top:35px'>" . $tdprofesor . "</td>
                <td style='width: 33%; text-align: center;border:none;padding-top:35px'></td>
                <td style='width: 33%; text-align:center;border:none;padding-top:35px'>" . $tddirector . "</td>
            </tr>
            <tr>
                <td colspan='3' style='text-align:center;border:none;padding-top:15px'>" . $fecha_final . ".</td>
            </tr>
            </table>";

        if ($html != '') {

            require('fpdf/html2pdf.class.php');
            try {
                //Orientación / formato del pdf y el idioma.
                $pdf = new HTML2PDF('P', 'LETTER', 'es', array(10, 10, 10, 10) /*márgenes*/); //los márgenes también pueden definirse en <page> ver documentación

                $pdf->WriteHTML('<page><html>
        <head>
            <style>' . $style . '</style>
        </head>
        <body> <page_footer>
        <table class="page_footer">
            <tr>
            <td style="width: 40%; text-align: left;border:none;"></td>
                <td style="width: 60%; text-align: right;border:none;font-size:8px">

                </td>
            </tr>
        </table>
    </page_footer>' . $html . '</body></html></page>');


                if (preg_match("/MSIE/i", $_SERVER["HTTP_USER_AGENT"])) {
                    header("Content-type: application/PDF");
                } else {
                    header("Content-type: application/PDF");
                    header("Content-Type: application/pdf");
                }

                $pdf->Output('Planificacion.pdf', I);
            } catch (HTML2PDF_exception $e) {
                //echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, intente nuevamente\");</script>";
                //echo "<script>parent.$.fancybox.close();</script>";
                echo $e;
            }
        }

    }

    //Nuevo Informes De notas
    public function generarparcialAction()
    {

        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();

        $paso = true;
        //debe venir un parametro, por GET o POST, llamado idasignatura, con el id del Asignatura a borrar
        $id = $this->_getParam('id', 0);
        $segmento = $this->_getParam('p', 0);
        $tipo = $this->_getParam('t', 0);


        if ($paso) {

            $style = "body{
font:11px Arial, Tahoma, Verdana, Helvetica, sans-serif;

color:#000;
}

#infoizq{

position:absolute;
left:0px;
}

#infoder{

position:absolute;
right:0px;
}
 
a h1{
font-size:35px; 
color:#FFF;
}
img{
width:90px;
height:100px;
}
 
h2{
color:#FC0;
font-size:15px; 
}

 
table{
width:100%;
height:auto;
margin:5px 0 10px 0;
border-collapse:collapse;
text-align:center;
text-justify:inter-word;
color:#000000;
}

table td,th{
border:1px solid black;
}
 .mes{
text-align:center;
}
 
table th{
padding:5px;
background-color: #ccc;
}


text-align:center;
font-weight:bold;
color:#000000;
}
 
.menu{
background-color:#69C;
color:#FFF;
}
.celda{
height: auto;
width: 170px;
text-align:left;
padding:1px;
}
 
.menu a{
color:#FFF; 
}";

            switch ($segmento) {
                case '1':
                    $nombresegmento = 'I Semestre';
                    break;

                case '2':
                    $nombresegmento = 'II Semestre';
                    break;

                case '3':
                    $nombresegmento = 'I Trimestre';
                    break;

                case '4':
                    $nombresegmento = 'II Trimestre';
                    break;

                case '5':
                    $nombresegmento = 'III Trimestre';
                    break;


            }


            //fecha actual

            $date = new DateTime;
            $fechain = $date->format('Y-m-d');
            $cortado = explode("-", $fechain);
            $dias = array("Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado");
            $meses = array("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre");

            $fecha_final = $dias[date('w', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]))] . " " . $cortado[2] . " de " . $meses[date('n', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0])) - 1] . " del " . date('Y', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]));


            $periodo = new Zend_Session_Namespace('periodo');
            $idperiodo = $periodo->periodo;
            //creo objeto tabla Notas
            $tabla = new Application_Model_DbTable_Notas();
            $modeloalumnoactual = new Application_Model_DbTable_Alumnosactual();
            if ($tipo == 1) {
                $listadealumnos = $modeloalumnoactual->get($id);
                $idcursoactual = $listadealumnos[0]['idCursosActual'];
            } else {
                $listadealumnos = $modeloalumnoactual->listaralumnoscursoactual($id, $idperiodo);
                $idcursoactual = $id;
            }


            //creo objeto tabla Notas
            $tabla = new Application_Model_DbTable_Notas();
            $modelasignatura = new Application_Model_DbTable_Asignaturascursos();
            $modeloalumnodetalle = new Application_Model_DbTable_AlumnosDetalle();

            $listaasignatura = $modelasignatura->listarporcurso($idcursoactual, 1, array('1', '3'), $idperiodo);
            //Obtiene los taller de forma Anual


            //creo objeto tabla curso
            $modelCurso = new Application_Model_DbTable_Cursos();
            $detalleest = $modelCurso->listarcursoid($idcursoactual, $idperiodo);
            $recuperando2 = new Zend_Session_Namespace('nombreperiodo');


            //Variables encabezado

            $titulo = "INFORME DE NOTAS PARCIALES  " . strtoupper($nombresegmento) . " " . $recuperando2->nombreperiodo;
            $tituloest = "<b>" . $detalleest[0]['nombreEstablecimiento'] . "</b>";
            $descripcion = "Reconocido Oficialmente por el Ministerio de Educación de la República de Chile, según Resolución Exenta de Educación Nº " . $detalleest[0]['numeroDecreto'] . " del año " . $detalleest[0]['yeardecreto'] . ". Rol Base de Datos Nº " . $detalleest[0]['rbd'] . ", otorga el presente Informe Educacional a:";
            $logo = getcwd();
            $logo .= "/application/documentos/logos/" . $detalleest[0]['extension'];
            if (file_exists($logo)) {

                $plogo = '<p style="position:absolute;top:3px;text-align:center"><img  src="' . $logo . '" /></p>';
            } else {
                $plogo = '';
            }


            //creo objeto tabla cuentas
            $modelCuenta = new Application_Model_DbTable_Cuentas();
            if ($detalleest[0]['idDirector'] > 0) {
                $director = $modelCuenta->get($detalleest[0]['idDirector']);
            } else {
                $director = 0;
            }

            $Profesorjefe = $modelCuenta->getusuario($detalleest[0]['idCuentaJefe'], $idperiodo);
            $largoalumnos = count($listadealumnos);
            $largoasignatura = count($listaasignatura);
            //$largoasignaturanoincide = count($listaasignaturanoinciden);


            if (count($Profesorjefe) == 0 || $Profesorjefe == null) {
                echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta Profesor Jefe\");</script>";
                echo "<script>parent.$.fancybox.close();</script>";
                exit;
            }


            if (count($director) == 0) {
                echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta director\");</script>";
                echo "<script>parent.$.fancybox.close();</script>";
                exit;

            }


            $date = new DateTime;
            $fechain = $date->format('Y-m-d');
            $cortado = explode("-", $fechain);
            $dias = array("Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado");
            $meses = array("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre");

            $fecha_final = $dias[date('w', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]))] . " " . $cortado[2] . " de " . $meses[date('n', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0])) - 1] . " del " . date('Y', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]));

            $niveleducacion = $detalleest[0]['idCodigoTipo'];
            $grado = $detalleest[0]['idGrado'];

            if ($niveleducacion == '110') {
                $nombreedu = 'Enseñanza Básica';

            }

            if ($niveleducacion == '310') {
                $nombreedu = 'Enseñanza Media';

            }
            if ($niveleducacion == '410') {
                $nombreedu = 'Enseñanza Media Técnico-Profesional Comercial';
                if ($detalleest[0]['rbd'] == '1864') {//Cesa
                    $nombredecreto = 'Nº 954 del año 2015';
                    $nombreexento = 'Decreto Supremo Evaluación,Calificación Escolar Nº 67 de 2018';


                }

            }

            if ($niveleducacion == '463') {
                $nombreedu = 'Enseñanza Media Técnico-Profesional Adultos Comercial';

            }

            if ($niveleducacion == '510') {
                $nombreedu = 'Enseñanza Media Técnico-Profesional Industrial';
                if ($detalleest[0]['rbd'] == '1864') {//Cesa
                    $nombredecreto = 'Nº 954 del año 2015';
                    $nombreexento = 'Decreto Supremo Evaluación,Calificación Escolar Nº 67 de 2018';


                }

            }

            if ($niveleducacion == '563') {
                $nombreedu = 'Enseñanza Media Técnico-Profesional Adultos Industrial';

            }
            if ($niveleducacion == '610') {
                $nombreedu = 'Enseñanza Media Técnico-Profesional ';
                //General Velasquez
                if ($detalleest[0]['rbd'] == '1863') {
                    $nombredecreto = 'Nº 954 del año 2015';
                    $nombreexento = 'Decreto Exento Nº 83 de 2001.';
                    if ($detalleest[0]['letra'] == 'A') {
                        $nombreedu = "Enseñanza Media Técnico-Profesional Atención de Párvulos";

                    }
                    if ($detalleest[0]['letra'] == 'B') {
                        $nombreedu = "Enseñanza Media Técnico-Profesional Servicio de Hotelería";

                    }
                    if ($detalleest[0]['letra'] == 'C') {
                        $nombreedu = "Enseñanza Media Técnico-Profesional Gastronomía Mención Cocina ";

                    }

                }

            }

            if ($niveleducacion == '663') {
                $nombreedu = 'Enseñanza Media Técnico-Profesional Adultos';

            }


            if ($niveleducacion == 110 && $grado < 7) {
                $nombredecreto = 'Nº 2960 del año 2012';
                $nombreexento = 'Decreto Exento Nº 511 de 1997.';

            }
            if ($niveleducacion == 110 && ($grado > 6 && $grado < 9)) {
                $nombredecreto = 'Nº 1363 del año 2011 ';
                $nombreexento = 'Decreto Exento Nº 511 de 1997.';

            }
            if ($niveleducacion == 310 && $grado > 0) {
                $nombredecreto = 'Nº 1358  del año 2011';
                $nombreexento = 'Decreto Exento Nº 112 de 1999.';

            }
            $taller = array();
            $combinada = array();
            for ($y = 0; $y < $largoalumnos; $y++) {
                $tablanotas = array();
                $alumnoactual = array();
                $verifica = array();
                $cuenta = 0;
                $promedio = 0;
                $cuenta1 = array();
                $cuentan = 0;
                $promedion = 0;
                $promediof = 0;
                $promediofn = 0;
                $cuenta2 = array();
                $promedioparcial = 0;
                $contadorparcial = 0;
                $listaasignaturanoinciden = array();
                $listaasignaturacompuesta = array();
                $listaasignaturaconcepto = array();

                $datostallersem = $modelasignatura->gettaller($idcursoactual, $idperiodo, array(1, 2), 1, array($segmento));
                $datostalleranual = $modelasignatura->gettalleranual($idcursoactual, $idperiodo, array(1), 1);
                $datostallersin = $modelasignatura->gettallersin($idcursoactual, $idperiodo);
                $datosasignaturascombinada = $modelasignatura->getcombinada($idcursoactual, $idperiodo);
                $listaasignaturacompuesta = $modelasignatura->listarporcurso($idcursoactual, 0, array('4'), $idperiodo);
                $listaasignaturaconcepto = $modelasignatura->listarporcurso($idcursoactual, 0, array('5'), $idperiodo);
                $largocombinada = count($datosasignaturascombinada);
                $largocompuesta = count($listaasignaturacompuesta);
                $largoconcepto = count($listaasignaturaconcepto);
                $listastalleres = array_merge($datostalleranual, $datostallersem);
                $listaasignaturanoinciden = array_merge($listastalleres, $datostallersin);

                $idalumnoactual = $listadealumnos[$y]['idAlumnos'];

                $tablanotas = $tabla->generasolonotasperiodo($idalumnoactual, $segmento, 1, $idperiodo, $idcursoactual);
                $tablanotas2 = $tabla->generasolonotasperiodo($idalumnoactual, $segmento, 0, $idperiodo, $idcursoactual);
                $verifica = $modeloalumnodetalle->get($listadealumnos[$y]['idAlumnosActual'], $segmento, $idperiodo);
                $observacion = $verifica[0]["observaciones"];
                $largotablanota2 = count($tablanotas2);
                $largotablaaux = count($tablanotas);


                //Notas de talleres

                //Configuraciones de Taller

                //Configuracion de Taller Buscamos si existen configuraciones por alumnos

                $modelotallerdetalle = new Application_Model_DbTable_Asignaturascursos();
                //Obtiene los Talleres que son Semestrales Tiempo=2.
                $datostalleres = $modelasignatura->gettaller($idcursoactual, $idperiodo, array(2), 2, array($segmento));


                if (count($datostalleres) > 0) {
                    for ($i = 0; $i < count($datostalleres); $i++) {
                        $detalletaller = $modelotallerdetalle->gettallersegmento($datostalleres[$i]['idConfiguracionTaller'], $segmento, $idalumnoactual);

                        if ($detalletaller) {

                            $listaasignaturanoinciden[] = $detalletaller[0];
                        }

                    }


                }

                $largoasignaturanoincide = count($listaasignaturanoinciden);


                //Espacios
                $totalnotascurso = $tabla->listarnotascursoperiodo($idcursoactual, $idperiodo, array($segmento));
                $largonota = count($totalnotascurso);
                $contador1 = array();
                $contador12 = array();
                $contador13 = array();
                $contador14 = array();


                for ($i = 0; $i < $largoasignatura; $i++) {
                    $contador1[$i] = 0;
                    for ($j = 0; $j < $largonota; $j++) {
                        if ($listaasignatura[$i]["idAsignatura"] == $totalnotascurso[$j]["idAsignatura"]) {
                            if ($totalnotascurso[$j]["coef"] == 2) {
                                $contador1[$i] += 2;
                            } else {
                                $contador1[$i] += 1;
                            }
                        }

                    }
                    for ($k = 0; $k < $largoasignaturanoincide; $k++) {
                        if ($listaasignatura[$i]["idAsignatura"] == $listaasignaturanoinciden[$k]["idAsignaturaTaller"] && !empty($listaasignaturanoinciden[$k]["forma"])) {
                            $contador1[$i] += 1;
                        }
                    }

                    for ($k = 0; $k < $largocombinada; $k++) {
                        $asignaturascom = unserialize($datosasignaturascombinada[$k]['asignaturas']);
                        for ($l = 0; $l < count($asignaturascom); $l++) {
                            if ($listaasignatura[$i]["idAsignatura"] == $datosasignaturascombinada[$k]['idAsignatura']) {
                                $contador1[$i] += 1;
                            }
                        }

                    }

                }

                if ($contador1 === 'NULL' || $contador1 == null || empty($contador1)) {
                    $rowspan = 1;
                } else {
                    $rowspan = max($contador1);
                }

                for ($i = 0; $i < $largoasignaturanoincide; $i++) {
                    $contador12[$i] = 0;
                    for ($j = 0; $j < $largonota; $j++) {
                        if ($listaasignaturanoinciden[$i]["idAsignatura"] == $totalnotascurso[$j]["idAsignatura"]) {
                            if ($totalnotascurso[$j]["coef"] == 2) {
                                $contador12[$i] += 2;
                            } else {
                                $contador12[$i] += 1;
                            }
                        }

                    }

                }

                for ($i = 0; $i < $largocompuesta; $i++) {
                    $contador12[$i] = 0;
                    for ($j = 0; $j < $largonota; $j++) {
                        if ($listaasignaturacompuesta[$i]["idAsignatura"] == $totalnotascurso[$j]["idAsignatura"]) {
                            if ($totalnotascurso[$j]["coef"] == 2) {
                                $contador13[$i] += 2;
                            } else {
                                $contador13[$i] += 1;
                            }
                        }

                    }

                }

                for ($i = 0; $i < $largoconcepto; $i++) {
                    $contador14[$i] = 0;
                    for ($j = 0; $j < $largonota; $j++) {
                        if ($listaasignaturaconcepto[$i]["idAsignatura"] == $totalnotascurso[$j]["idAsignatura"]) {
                            if ($totalnotascurso[$j]["coef"] == 2) {
                                $contador14[$i] += 2;
                            } else {
                                $contador14[$i] += 1;
                            }
                        }

                    }

                }
                if ($contador12 === 'NULL' || $contador12 == NULL || empty($contador12)) {
                    $rowspan12 = 1;
                } else {
                    $rowspan12 = max($contador12);
                }

                if ($contador13 === 'NULL' || $contador13 == NULL || empty($contador13)) {
                    $rowspan13 = 1;
                } else {
                    $rowspan13 = max($contador13);
                }
                if ($contador14 === 'NULL' || $contador14 == NULL || empty($contador14)) {
                    $rowspan14 = 1;
                } else {
                    $rowspan14 = max($contador14);
                }
                $rowspan1 = max(array($rowspan, $rowspan12, $rowspan13, $rowspan14));


                $espacio = $rowspan1 + 2;

                if ($largoasignaturanoincide != 0) {

                    $taller[$y] .= "<tr><td colspan=" . $espacio . "><b>TALLERES Y ASIGNATURAS</b></td></tr>";
                    for ($i = 0; $i < $largoasignaturanoincide; $i++) {

                        //Configuracion de Taller
                        if ($listaasignaturanoinciden[$i]["tipoAjuste"] == 2) {

                            $promediotaller['idAsignatura'] = $detalletaller[0]['idAsignaturaDestino'];


                        } else {
                            $promediotaller['idAsignatura'] = $listaasignaturanoinciden[$i]["idAsignaturaTaller"];
                        }

                        $cuenta2[$i] = 0;
                        $promedion = 0;
                        $cuentan = 0;
                        $auxtext = "<tr><td class='celda'>" . $listaasignaturanoinciden[$i]["nombreAsignatura"] . "</td>";

                        for ($j = 0; $j < $largotablanota2; $j++) {
                            if ($listaasignaturanoinciden[$i]["idAsignatura"] == $tablanotas2[$j]["idAsignatura"]) {
                                if ($tablanotas2[$j]['coef'] == 2) {
                                    if ($tablanotas2[$j]['nota'] != '0') {

                                        $arr1 = str_split($tablanotas2[$j]['nota']);
                                        $auxtext .= "<td>" . $arr1[0] . ',' . $arr1[1] . "</td>";
                                        $auxtext .= "<td>" . $arr1[0] . ',' . $arr1[1] . "</td>";

                                        $promedion = $promedion + ($tablanotas2[$j]['nota'] + $tablanotas2[$j]['nota']);
                                        $cuentan = $cuentan + 2;

                                    } else {
                                        $auxtext .= "<td>-</td>";
                                        $auxtext .= "<td>-</td>";
                                    }
                                    $cuenta2[$i] = $cuenta2[$i] + 2;

                                } else {

                                    if ($tablanotas2[$j]['nota'] != '0') {

                                        $arr1 = str_split($tablanotas2[$j]['nota']);
                                        $auxtext .= "<td>" . $arr1[0] . ',' . $arr1[1] . "</td>";

                                        $promedion = $promedion + $tablanotas2[$j]['nota'];
                                        $cuentan = $cuentan + 1;

                                    } else {
                                        $auxtext .= "<td>-</td>";
                                    }
                                    $cuenta2[$i] = $cuenta2[$i] + 1;

                                }

                            }

                        }
                        if ($cuenta2[$i] < $rowspan1) {
                            $largo2 = $rowspan1 - $cuenta2[$i];

                            for ($u = 0; $u < $largo2; $u++) {
                                $auxtext .= "<td>-</td>";
                            }

                        }

                        //sacamos el promedio de la asignatura


                        if ($promedion > 0 || $cuentan > 0) {


                            if ($detalleest[0]['aproxAsignatura'] == 1) {
                                $promediofn = round($promedion / $cuentan);
                                $promediotaller['nota'] = $promediofn;
                                $promediotaller['coef'] = 1;
                                $promediotaller['idAsignatura'] = $listaasignaturanoinciden[$i]["idAsignaturaTaller"];
                                $promediotaller['forma'] = $listaasignaturanoinciden[$i]["forma"];
                                $promediotaller['porcentaje'] = $listaasignaturanoinciden[$i]["porcentaje"];
                                $promediotaller['tipoAjuste'] = $listaasignaturanoinciden[$i]["tipoAjuste"];
                                $promediotaller['idConfiguracionTaller'] = $listaasignaturanoinciden[$i]["idConfiguracionTaller"];
                                $promediotaller['tipoAsignatura'] = $listaasignaturanoinciden[$i]["tipoAsignatura"];

                            } else {
                                $promediofn = intval($promedion / $cuentan);
                                $promediotaller['nota'] = $promediofn;
                                $promediotaller['coef'] = 1;

                                $promediotaller['forma'] = $listaasignaturanoinciden[$i]["forma"];
                                $promediotaller['porcentaje'] = $listaasignaturanoinciden[$i]["porcentaje"];
                                $promediotaller['tipoAjuste'] = $listaasignaturanoinciden[$i]["tipoAjuste"];
                                $promediotaller['idConfiguracionTaller'] = $listaasignaturanoinciden[$i]["idConfiguracionTaller"];
                                $promediotaller['tipoAsignatura'] = $listaasignaturanoinciden[$i]["tipoAsignatura"];

                            }
                            $auxtext .= "<td class='prom'>" . $promediofn . "</td></tr>";
                            $taller[$y] .= $auxtext;
                        } else {
                            $promediotaller['nota'] = 0;
                            $promediotaller['coef'] = 1;
                            $promediotaller['forma'] = $listaasignaturanoinciden[$i]["forma"];
                            $promediotaller['porcentaje'] = $listaasignaturanoinciden[$i]["porcentaje"];
                            $promediotaller['tipoAjuste'] = $listaasignaturanoinciden[$i]["tipoAjuste"];
                            $promediotaller['idConfiguracionTaller'] = $listaasignaturanoinciden[$i]["idConfiguracionTaller"];
                            $promediotaller['idAsignatura'] = $listaasignaturanoinciden[$i]["idAsignaturaTaller"];
                            $promediotaller['tipoAsignatura'] = $listaasignaturanoinciden[$i]["tipoAsignatura"];

                        }

                        //Cechekeamos a que tipo pertenece la asignatura de destino del taller
                        if (!empty($listaasignaturanoinciden[$i]["idAsignaturaTaller"])) {
                            $datosdestino = $modelasignatura->getdestino($listaasignaturanoinciden[$i]["idAsignaturaTaller"]);

                            if ($datosdestino[0]['tipoAsignatura'] == 4) {
                                $tablanotas2[] = $promediotaller;
                            } else {
                                $tablanotas[] = $promediotaller;
                            }
                        }


                    }

                }


                //Notas de Asignaturas que pertenecen a una combinada

                if ($largocombinada != 0) {
                    $largotablanota2 = count($tablanotas2);


                    for ($i = 0; $i < $largocombinada; $i++) {

                        $setasignatura = unserialize($datosasignaturascombinada[$i]['asignaturas']);
                        for ($k = 0; $k < count($setasignatura); $k++) {
                            $cuentan = 0;
                            $promedion = 0;
                            $promediof = 0;
                            $porcentajetallercom = 0;
                            $notatallercom = 0;
                            $cuenta2 = array();
                            $datocombinada = $modelasignatura->getnombre($setasignatura[$k]);


                            $cuenta2[$i] = 0;
                            $combinada[$y] .= "<tr><td class='celda'>" . $datocombinada[0]["nombreAsignatura"] . "</td>";

                            for ($j = 0; $j < $largotablanota2; $j++) {
                                if ($datocombinada[0]["idAsignatura"] == $tablanotas2[$j]["idAsignatura"]) {
                                    if ($tablanotas2[$j]['coef'] == 2) {
                                        if ($tablanotas2[$j]['nota'] != '0') {

                                            $arr1 = str_split($tablanotas2[$j]['nota']);
                                            $combinada[$y] .= "<td>" . $arr1[0] . ',' . $arr1[1] . "</td>";
                                            $combinada[$y] .= "<td>" . $arr1[0] . ',' . $arr1[1] . "</td>";

                                            $promedion = $promedion + ($tablanotas2[$j]['nota'] + $tablanotas2[$j]['nota']);
                                            $cuentan = $cuentan + 2;

                                        } else {
                                            $combinada[$y] .= "<td>-</td>";
                                            $combinada[$y] .= "<td>-</td>";
                                        }
                                        $cuenta2[$i] = $cuenta2[$i] + 2;

                                    } else {

//                                        if ($tablanotas2[$j]['nota'] != '0') {
//
//                                            $arr1 = str_split($tablanotas2[$j]['nota']);
//                                            $combinada[$y] .= "<td>" . $arr1[0] . ',' . $arr1[1] . "</td>";
//
//                                            $promedion = $promedion + $tablanotas2[$j]['nota'];
//                                            $cuentan = $cuentan + 1;
//
//                                        } else {
//                                            $combinada[$y] .= "<td>-</td>";
//                                        }
//                                        $cuenta2[$i] = $cuenta2[$i] + 1;

                                        if ($tablanotas2[$j]['nota'] != '0') {

                                            if (empty($tablanotas2[$j]['forma'])) {
                                                $arr1 = str_split($tablanotas2[$j]['nota']);
                                                $combinada[$y] .= "<td>" . $arr1[0] . ',' . $arr1[1] . "</td>";
                                                $promedion += $tablanotas2[$j]['nota'];
                                                $cuentan += 1;
                                            } else {

                                                if ($tablanotas2[$j]['forma'] == 1) {
                                                    $arr1 = str_split($tablanotas2[$j]['nota']);
                                                    $combinada[$y] .= "<td bgcolor='#B2B0AF'>" . $arr1[0] . ',' . $arr1[1] . "</td>";
                                                    $promedion += $tablanotas2[$j]['nota'];
                                                    $cuentan += 1;
                                                }
                                                if ($tablanotas2[$j]['forma'] == 2) {
                                                    $arr1 = str_split($tablanotas2[$j]['nota']);
                                                    $combinada[$y] .= "<td bgcolor='#B2B0AF'>" . $arr1[0] . ',' . $arr1[1] . "</td>";
                                                    $porcentajetallercom = $tablanotas2[$j]['porcentaje'];
                                                    $notatallercom = $tablanotas2[$j]['nota'];
                                                }
                                            }


                                        } else {
                                            if (empty($tablanotas2[$j]['forma'])) {
                                                $combinada[$y] .= "<td>-</td>";
                                            } else {
                                                $combinada[$y] .= "<td bgcolor='#B2B0AF'>-</td>";
                                            }
                                        }

                                        $cuenta2[$i] += 1;

                                    }

                                }

                            }
                            if ($cuenta2[$i] < $rowspan1) {
                                $largo2 = $rowspan1 - $cuenta2[$i];

                                for ($u = 0; $u < $largo2; $u++) {
                                    $combinada[$y] .= "<td>-</td>";
                                }

                            }

                            //sacamos el promedio de la asignatura


                            if ($promedion > 0 || $cuentan > 0) {
                                if ($detalleest[0]['aproxAsignatura'] == 1) {
                                    //$promediofn = round($promedion / $cuentan);
                                    //nuevo Promedio con taller
                                    if (empty($notatallercom)) {
                                        $promediofn = round($promedion / $cuentan);
                                    } else {
                                        $porcentajecom = 100 - $porcentajetallercom;
                                        $promediofn = (round($promedion / $cuentan)) * ($porcentajecom / 100) + ($notatallercom * ($porcentajetallercom / 100));
                                        $promediofn = round($promediofn);
                                    }


                                    //Fin Taller
                                    $promediocombinada['nota'] = $promediofn;
                                    $promediocombinada['coef'] = 1;
                                    $datoasignatura = $modelasignatura->getnombre($datosasignaturascombinada[$i]["idAsignaturaCurso"]);
                                    $promediocombinada['idAsignatura'] = $datoasignatura[0]["idAsignatura"];


                                } else {
                                    //$promediofn = intval($promedion / $cuentan);
                                    //Nuevo Promedio con Taller

                                    if (empty($notatallercom)) {
                                        $promediofn = intval($promedion / $cuentan);
                                    } else {
                                        $porcentajecom = 100 - $porcentajetallercom;
                                        $promediofn = (round($promedion / $cuentan)) * ($porcentajecom / 100) + ($notatallercom * ($porcentajetallercom / 100));
                                        $promediofn = intval($promediofn);
                                    }
                                    //Fin Taller
                                    $promediocombinada['nota'] = $promediofn;
                                    $promediocombinada['coef'] = 1;
                                    $datoasignatura = $modelasignatura->getnombre($datosasignaturascombinada[$i]["idAsignaturaCurso"]);
                                    $promediocombinada['idAsignatura'] = $datoasignatura[0]["idAsignatura"];


                                }
                                $combinada[$y] .= "<td class='prom'>" . $promediofn . "</td></tr>";

                            } else {
                                $promediocombinada['nota'] = 0;
                                $promediocombinada['coef'] = 1;
                                $datoasignatura = $modelasignatura->getnombre($datosasignaturascombinada[$i]["idAsignaturaCurso"]);
                                $promediocombinada['idAsignatura'] = $datoasignatura[0]["idAsignatura"];


                                $combinada[$y] .= "<td class='prom'>-</td></tr>";
                            }

                            $tablanotas[] = $promediocombinada;

                        }
                    }


                }


                $largotablanota = count($tablanotas);


                //Asignaturas Conceptos
                if ($largoconcepto != 0) {
                    for ($i = 0; $i < $largoconcepto; $i++) {
                        $resultado[$i] = $modelasignatura->getasignaturaconcepto($listaasignaturaconcepto[$i]["idAsignatura"], $idcursoactual, $idperiodo);

                        $cuentan = 0;
                        $promedion = 0;
                        $promediof = 0;
                        $cuenta2 = array();
                        $concepto[$y] .= "<tr><td class='celda'>" . $listaasignaturaconcepto[$i]["nombreAsignatura"] . "</td>";
                        $cuenta2[$i] = 0;
                        for ($l = 0; $l < count($resultado[$i]); $l++) {
                            $listaconceptos[$i][$resultado[$i][$l]['notaconcepto']] = $resultado[$i][$l]['concepto'];


                            $listaconceptospromedio[$i][$l] = array($resultado[$i][$l]['desde'], $resultado[$i][$l]['hasta'], $resultado[$i][$l]['concepto']);

                        }


                        for ($j = 0; $j < $largotablanota2; $j++) {
                            if ($listaasignaturaconcepto[$i]["idAsignatura"] == $tablanotas2[$j]["idAsignatura"]) {


                                if ($tablanotas2[$j]['coef'] == 2) {
                                    if ($tablanotas2[$j]['nota'] != '0') {

                                        for ($l = 0; $l < count($listaconceptospromedio[$i]); $l++) {
                                            if ($tablanotas2[$j]['nota'] >= $listaconceptospromedio[$i][$l][0] && $tablanotas2[$j]['nota'] <= $listaconceptospromedio[$i][$l][1]) {
                                                $promediofnconcepto = $listaconceptospromedio[$i][$l][2];

                                                $concepto[$y] .= "<td>" . $listaconceptospromedio[$i][$l][2] . "</td>";
                                                $concepto[$y] .= "<td>" . $listaconceptospromedio[$i][$l][2] . "</td>";

                                            }

                                        }


                                        $promedion = $promedion + ($tablanotas2[$j]['nota'] + $tablanotas2[$j]['nota']);
                                        $cuentan = $cuentan + 2;

                                    } else {
                                        $concepto[$y] .= "<td>-</td>";
                                        $concepto[$y] .= "<td>-</td>";
                                    }
                                    $cuenta2[$i] = $cuenta2[$i] + 2;

                                } else {

                                    if ($tablanotas2[$j]['nota'] != '0') {
                                        for ($l = 0; $l < count($listaconceptospromedio[$i]); $l++) {
                                            if ($tablanotas2[$j]['nota'] >= $listaconceptospromedio[$i][$l][0] && $tablanotas2[$j]['nota'] <= $listaconceptospromedio[$i][$l][1]) {
                                                $promediofnconcepto = $listaconceptospromedio[$i][$l][2];

                                                $concepto[$y] .= "<td>" . $listaconceptospromedio[$i][$l][2] . "</td>";

                                            }

                                        }


                                        $promedion = $promedion + $tablanotas2[$j]['nota'];
                                        $cuentan = $cuentan + 1;

                                    } else {
                                        $concepto[$y] .= "<td>-</td>";
                                    }
                                    $cuenta2[$i] = $cuenta2[$i] + 1;

                                }

                            }

                        }
                        if ($cuenta2[$i] < $rowspan1) {
                            $largo2 = $rowspan1 - $cuenta2[$i];

                            for ($u = 0; $u < $largo2; $u++) {
                                $concepto[$y] .= "<td>-</td>";
                            }

                        }

                        //sacamos el promedio de la asignatura


                        if ($promedion > 0 || $cuentan > 0) {

                            if ($detalleest[0]['aproxAsignatura'] == 1) {
                                $promediofn = round($promedion / $cuentan);


                            } else {
                                $promediofn = intval($promedion / $cuentan);


                            }
                            for ($l = 0; $l < count($listaconceptospromedio[$i]); $l++) {
                                if ($promediofn >= $listaconceptospromedio[$i][$l][0] && $promediofn <= $listaconceptospromedio[$i][$l][1]) {
                                    $promediofnconcepto = $listaconceptospromedio[$i][$l][2];

                                }

                            }
                            $concepto[$y] .= "<td class='prom'>" . $promediofnconcepto . "</td></tr>";

                        } else {


                            $concepto[$y] .= "<td class='prom'>-</td></tr>";
                        }


                    }

                }


                //Formato del rut

                $rutset = $listadealumnos[$y]['rutAlumno'];
                if (!empty($rutset)) {

                    $rest = substr($rutset, 0, -1);
                    $ultimo = substr($rutset, -1);
                    $formatomiles = number_format($rest, 0, "", ".");
                    $formatofinal = $formatomiles . '-' . $ultimo;

                }


                $nombrecompleto = $listadealumnos[$y]['nombres'] . ' ' . $listadealumnos[$y]['apaterno'] . ' ' . $listadealumnos[$y]['amaterno'];
                $nombrecompleto = strtoupper($nombrecompleto);


                // variables para encabezado

                $alumno = 'Don(a): <span style=" text-decoration: underline;">' . $nombrecompleto . '</span> RUN: <span style=" text-decoration: underline;">' . $formatofinal . '</span> Alumno(a) de <b>' . $detalleest[0]['nombreGrado'] . ' ' . $detalleest[0]['letra'] . ' de ' . $nombreedu . '</b>, de Acuerdo a Decreto Plan de Estudio ' . $nombredecreto . ' y del Reglamento de Evaluación y Promoción Escolar ' . $nombreexento . '';
                $encabezado = $plogo . '<h5 style="position:absolute;top:110px;text-align:center">' . $titulo . '</h5><h4 style="position:absolute;top:130px;text-align:center">' . $tituloest . '</h4>'
                    . '<p style="margin-top:20px; text-align:left;">' . $descripcion . '</p>'

                    . '<p style="margin-top:1px; text-align:left;">' . $alumno . '</p>';
                $html[$y] = '';
                $html[$y] .= $encabezado;


                if ($largotablaaux < 1) {
                    $html[$y] .= "<table  align='center' border='1'><tr><th style='width:25%'>Asignaturas</th><th style='width:65%'>" . $nombresegmento . "</th><th style='width:10%'>Promedio</th></tr>";
                    $html[$y] .= "<tr><td colspan='3'>Sin Notas en éste periodo</td></tr>";
                } else {

                    //if($detalleest[0]['idEstablecimiento']==14){
                    //  $html[$y] .= "<table  align='center' border='1'><tr><th style='width:25%'>Asignaturas</th><th style='width:55%' colspan=" . $rowspan1 . ">" . $nombresegmento . "</th><th style='width:10%'>Promedio</th><th style='width:10%'>Porcentaje</th></tr>";

                    //}else{
                    $html[$y] .= "<table  align='center' border='1'><tr><th style='width:25%'>Asignaturas</th><th style='width:65%' colspan=" . $rowspan1 . ">" . $nombresegmento . "</th><th style='width:10%'>Promedio</th></tr>";

                    //}


                    $contadorparcial = 0;
                    for ($i = 0; $i < $largoasignatura; $i++) {
                        $cuenta1[$i] = 0;
                        $promedio = 0;
                        $cuenta = 0;
                        //$auxtext = "<tr><td class='celda'>" . $listaasignatura[$i]["nombreAsignatura"] . "</td>";
                        $html[$y] .= "<tr><td class='celda'>" . $listaasignatura[$i]["nombreAsignatura"] . "</td>";

                        for ($j = 0; $j < $largotablanota; $j++) {
                            if ($listaasignatura[$i]["idAsignatura"] == $tablanotas[$j]["idAsignatura"]) {
                                if ($tablanotas[$j]['coef'] == 2) {
                                    if ($tablanotas[$j]['nota'] != '0') {
                                        $arr1 = str_split($tablanotas[$j]['nota']);
                                        $html[$y] .= "<td>" . $arr1[0] . ',' . $arr1[1] . "</td>";
                                        $html[$y] .= "<td>" . $arr1[0] . ',' . $arr1[1] . "</td>";
                                        $promedio += ($tablanotas[$j]['nota'] + $tablanotas[$j]['nota']);
                                        $cuenta += 2;

                                    } else {
                                        $html[$y] .= "<td>-</td>";
                                        $html[$y] .= "<td>-</td>";
                                    }
                                    $cuenta1[$i] += 2;

                                } else {

                                    if ($tablanotas[$j]['nota'] != '0') {

                                        if (empty($tablanotas[$j]['forma'])) {
                                            $arr1 = str_split($tablanotas[$j]['nota']);
                                            $html[$y] .= "<td>" . $arr1[0] . ',' . $arr1[1] . "</td>";
                                            $promedio += $tablanotas[$j]['nota'];
                                            $cuenta += 1;
                                            $notataller = array();
                                            $porcentajetaller = array();
                                        } else {

                                            if ($tablanotas[$j]['forma'] == 1) {
                                                $arr1 = str_split($tablanotas[$j]['nota']);
                                                $html[$y] .= "<td bgcolor='#B2B0AF'>" . $arr1[0] . ',' . $arr1[1] . "</td>";
                                                $promedio += $tablanotas[$j]['nota'];
                                                $cuenta += 1;
                                                $notataller = array();
                                                $porcentajetaller = array();

                                            }
                                            if ($tablanotas[$j]['forma'] == 2) {
                                                $arr1 = str_split($tablanotas[$j]['nota']);
                                                $html[$y] .= "<td bgcolor='#B2B0AF'>" . $arr1[0] . ',' . $arr1[1] . "</td>";
                                                $notataller = $tablanotas[$j]['nota'];
                                                $porcentajetaller = $tablanotas[$j]['porcentaje'];

                                            }
                                        }


                                    } else {
                                        if (empty($tablanotas[$j]['forma'])) {
                                            $html[$y] .= "<td>-</td>";
                                        } else {
                                            $html[$y] .= "<td bgcolor='#B2B0AF'>-</td>";
                                        }
                                    }

                                    $cuenta1[$i] += 1;

                                }

                            }

                        }
                        if ($cuenta1[$i] < $rowspan1) {
                            $largo = $rowspan1 - $cuenta1[$i];

                            for ($u = 0; $u < $largo; $u++) {
                                $html[$y] .= "<td>-</td>";
                            }

                        }
                        if ($cuenta1[$i] == $contador1[$i]) {

                            //sacamos el promedio de la asignatura
                            if ($promedio > 0 || $cuenta > 0) {


                                // si es 1 Aproxima, si es 2 no Aproxima
                                if ($detalleest[0]['aproxAsignatura'] == 1) {
                                    if (empty($notataller)) {
                                        $promediof = round($promedio / $cuenta);
                                    } else {
                                        $porcentaje = 100 - $porcentajetaller;
                                        $promediof = (round($promedio / $cuenta)) * ($porcentaje / 100) + ($notataller * ($porcentajetaller / 100));
                                        $promediof = round($promediof);
                                    }


                                } else {
                                    if (empty($notataller)) {
                                        $promediof = intval($promedio / $cuenta);
                                    } else {
                                        $porcentaje = 100 - $porcentajetaller;
                                        $promediof = (round($promedio / $cuenta)) * ($porcentaje / 100) + ($notataller * ($porcentajetaller / 100));
                                        $promediof = intval($promediof);
                                    }


                                }
                                $promedioparcial += $promediof;
                                $contadorparcial += 1;
                                $promediocortado = str_split($promediof);


                                //if($detalleest[0]['idEstablecimiento']==14){

                                //  $resultadoporcentaje=getPorcentaje($detalleest[0]['idEstablecimiento'],$promediof);
                                //$html[$y] .= "<td>" . $promediocortado[0] . ',' . $promediocortado[1] . "</td><td></td></tr>";
                                //}else{
                                $html[$y] .= "<td>" . $promediocortado[0] . ',' . $promediocortado[1] . "</td></tr>";
                                //}


                                //$html[$y] .= $auxtext;

                            } else {
                                $promediof = 0;

                                //if($detalleest[0]['idEstablecimiento']==14) {
                                //  $html[$y] .= "<td>-</td><td>-</td></tr>";
                                //}else{
                                $html[$y] .= "<td>-</td></tr>";
                                //}

                            }

                        } else {
                            //if($detalleest[0]['idEstablecimiento']==14) {
                            //  $html[$y] .= "<td>-</td><td>-</td></tr>";
                            //}else{
                            $html[$y] .= "<td>-</td></tr>";
                            //}
                        }


                    }

                    $promedioparcialfinal = 0;


                    if ($promedioparcial > 0 && $contadorparcial > 0) {
                        // si es 1 Aproxima,si es 2 no Aproxima
                        if ($detalleest[0]['aproxPeriodo'] == 1) {
                            $promedioparcialfinal = round($promedioparcial / $contadorparcial);
                        } else {
                            $promedioparcialfinal = intval($promedioparcial / $contadorparcial);
                        }
                        $promediocortadoparcial = str_split($promedioparcialfinal);
                        //if($detalleest[0]['idEstablecimiento']==14) {
                        //   $html[$y] .= "<tr><td style='text-align:left' colspan=" . ($rowspan1 + 1) . ">PROMEDIO GENERAL</td><td>" . $promediocortadoparcial[0] . ',' . $promediocortadoparcial[1] . "</td><td></td></tr>";


                        //}else{
                        $html[$y] .= "<tr><td style='text-align:left' colspan=" . ($rowspan1 + 1) . ">PROMEDIO GENERAL</td><td>" . $promediocortadoparcial[0] . ',' . $promediocortadoparcial[1] . "</td></tr>";

                        //}

                    } else {
                        //if($detalleest[0]['idEstablecimiento']==14) {
                        //  $html[$y] .= "<tr><td style='text-align:left' colspan=" . ($rowspan1 + 1) . ">PROMEDIO GENERAL</td><td>-</td><td></td></tr>";
                        //}else{
                        $html[$y] .= "<tr><td style='text-align:left' colspan=" . ($rowspan1 + 1) . ">PROMEDIO GENERAL</td><td>-</td></tr>";
                        //}

                    }


                    $html[$y] .= $taller[$y];
                    if (empty($taller[$y]) && (!empty($combinada[$y]) || !empty($concepto[$y]))) {
                        $html[$y] .= "<tr><td colspan=" . ($rowspan1 + 2) . "><b>TALLERES Y ASIGNATURAS</b></td></tr>";
                    }
                    $html[$y] .= $combinada[$y];
                    $html[$y] .= $concepto[$y];
                }


                $html[$y] .= "</table>";

                $cadenaobservacion = trim($observacion);

                if (!empty($observacion) && strlen($cadenaobservacion) > 0) {
                    $html[$y] .= "<table><tr><td style='width:100%;text-align: left;'>Observaciones:</td></tr><tr><td style='width:100%;height:4%;text-align:left;'>" . $observacion . "</td></tr></table>";
                }

                $valoresprofesor = unserialize($detalleest[0]['profesor']);
                if ($valoresprofesor[0] == 1) {
                    $tdnombreprofesor = "<p style='text-decoration:underline;margin-left:30px;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</p>";
                    $tdprofesor = "Profesor(a) Jefe.";
                } else {
                    $tdnombreprofesor = "";
                    $tdprofesor = "";
                }

                $valoresdirector = unserialize($detalleest[0]['director']);
                if ($valoresdirector[0] == 1) {
                    $tdnombredirector = "<p style='text-decoration:underline;'>" . $director['nombrescuenta'] . " " . $director['paternocuenta'] . " " . $director['maternocuenta'] . "</p>";
                    $tddirector = "Director(a).";
                } else {
                    $tdnombredirector = "";
                    $tddirector = "";
                }


                $valoresapoderado = unserialize($detalleest[0]['apoderado']);
                if ($valoresapoderado[0] == 1) {
                    $tdnombreapoderado = "<p style='text-decoration:underline;'> " . $apoderado . "</p>";
                    $tdapoderado = "Nombre y Firma de Apoderado.";
                } else {
                    $tdnombreapoderado = "";
                    $tdapoderado = "";
                }


                $html[$y] .= "<table align='center' style='margin-top:25px;' class='page_firmas'>
            <tr>
                <td style='width: 33%; text-align: center;border:none;'>" . $tdnombreprofesor . "</td>
                <td style='width: 33%; text-align: center;border:none;'>" . $tdnombreapoderado . "</td>
                <td style='width: 33%; text-align: center;border:none;'>" . $tdnombredirector . "</td>
            </tr>
            <tr>
                <td style='width: 33%; text-align:center;border:none;padding-top:35px'>" . $tdprofesor . "</td>
                <td style='width: 33%; text-align: center;border:none;padding-top:35px'>" . $tdapoderado . "</td>
                <td style='width: 33%; text-align:center;border:none;padding-top:35px'>" . $tddirector . "</td>
            </tr>
            <tr>
                <td colspan='3' style='text-align:center;border:none;padding-top:15px'>" . $fecha_final . ".</td>
            </tr>
            </table>";

            }


            if ($html != '') {

                require('fpdf/html2pdf.class.php');
                try {
                    //Orientación / formato del pdf y el idioma.
                    $pdf = new HTML2PDF('P', 'LETTER', 'es', array(10, 10, 10, 10) /*márgenes*/); //los márgenes también pueden definirse en <page> ver documentación

                    //inicio ciclo

                    for ($j = 0; $j < count($html); $j++) {
                        $pdf->WriteHTML('<page><html>
                            <head>
                                <style>' . $style . '</style>
                            </head>
                            <body> <page_footer>
                            <table class="page_footer">
                                <tr>
                                <td style="width: 40%; text-align: left;border:none;"></td>
                                    <td style="width: 60%; text-align: right;border:none;font-size:8px">

                                    </td>
                                </tr>
                            </table>
                        </page_footer>' . $html[$j] . '</body></html></page>');
                    }

                    //fin ciclo


                    if (preg_match("/MSIE/i", $_SERVER["HTTP_USER_AGENT"])) {
                        header("Content-type: application/PDF");
                    } else {
                        header("Content-type: application/PDF");
                        header("Content-Type: application/pdf");
                    }

                    $pdf->Output('Planificacion.pdf', I);
                } catch (HTML2PDF_exception $e) {
                    //echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, intente nuevamente\");</script>";
                    //echo "<script>parent.$.fancybox.close();</script>";
                    echo $e;
                }
            }


        }//fin Paso


    }

    public function generaralumnocursoAction()
    {
        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();

        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $mostrar = false;

        $paso = true;
        //debe venir un parametro, por GET o POST, llamado idasignatura, con el id del Asignatura a borrar
        $id = $this->_getParam('id', 0);
        $segmento = $this->_getParam('p', 0);
        $tipo = $this->_getParam('t', 0);


        if ($paso) {

            $style = "body{
font:11px Arial, Tahoma, Verdana, Helvetica, sans-serif;

color:#000;
}

#infoizq{

position:absolute;
left:0px;
}

#infoder{

position:absolute;
right:0px;
}
 
a h1{
font-size:35px; 
color:#FFF;
}
img{
width:90px;
height:100px;
}
 
h2{
color:#FC0;
font-size:15px; 
}

 
table{
width:100%;
height:auto;
margin:5px 0 10px 0;
border-collapse:collapse;
text-align:center;
text-justify:inter-word;
color:#000000;
}

table td,th{
border:1px solid black;
}
 .mes{
text-align:center;
}
 
table th{
padding:5px;
background-color: #ccc;
}


text-align:center;
font-weight:bold;
color:#000000;
}
 
.menu{
background-color:#69C;
color:#FFF;
}
.celda{
height: auto;
width: 170px;
text-align:left;
padding:1px;
}
 
.menu a{
color:#FFF; 
}";

            switch ($segmento) {
                case '1':
                    $nombresegmento = 'I Semestre';
                    break;

                case '2':
                    $nombresegmento = 'II Semestre';
                    break;

                case '3':
                    $nombresegmento = 'I Trimestre';
                    break;

                case '4':
                    $nombresegmento = 'II Trimestre';
                    break;

                case '5':
                    $nombresegmento = 'III Trimestre';
                    break;


            }


            $periodo = new Zend_Session_Namespace('periodo');
            $idperiodo = $periodo->periodo;

            $modeloalumnoactual = new Application_Model_DbTable_Alumnosactual();
            if ($tipo == 1) {
                $listadealumnos = $modeloalumnoactual->get($id);
                $idcursoactual = $listadealumnos[0]['idCursosActual'];
            } else {
                $listadealumnos = $modeloalumnoactual->listaralumnoscursoactual($id, $idperiodo);
                $idcursoactual = $id;
            }


            //creo objeto tabla Notas
            $tabla = new Application_Model_DbTable_Notas();
            $modelasignatura = new Application_Model_DbTable_Asignaturascursos();
            $modeloalumnodetalle = new Application_Model_DbTable_AlumnosDetalle();

            //creo objeto tabla curso
            $modelCurso = new Application_Model_DbTable_Cursos();
            $detalleest = $modelCurso->listarcursoid($idcursoactual, $idperiodo);

            if ($detalleest[0]['monitoreo'] == 1 && $detalleest[0]['idEstablecimiento'] == 12 && $segmento == 2) {
                $listaasignatura = $modelasignatura->listarporcursoprioritaria($idcursoactual, 1, array('1', '3'), $idperiodo);
                $datosasignaturascombinada = $modelasignatura->getcombinada($idcursoactual, $idperiodo);
                $listaasignaturacompuesta = $modelasignatura->listarporcurso($idcursoactual, 0, array('4'), $idperiodo);
                $listaasignaturaconcepto = $modelasignatura->listarporcurso($idcursoactual, 0, array('5'), $idperiodo);
                $largocombinada = count($datosasignaturascombinada);
                $largocompuesta = count($listaasignaturacompuesta);
                $largoconcepto = count($listaasignaturaconcepto);

            } else {
                $listaasignatura = $modelasignatura->listarporcurso($idcursoactual, 1, array('1', '3'), $idperiodo);
                $datosasignaturascombinada = $modelasignatura->getcombinada($idcursoactual, $idperiodo);
                $listaasignaturacompuesta = $modelasignatura->listarporcurso($idcursoactual, 0, array('4'), $idperiodo);
                $listaasignaturaconcepto = $modelasignatura->listarporcurso($idcursoactual, 0, array('5'), $idperiodo);
                $largocombinada = count($datosasignaturascombinada);
                $largocompuesta = count($listaasignaturacompuesta);
                $largoconcepto = count($listaasignaturaconcepto);
            }


            //Monitoreo 27-09-2020

            if ($detalleest[0]['monitoreo'] == 1) {

                if ($detalleest[0]['idEstablecimiento'] == 12) {
                    $modeloequivalencia = new Application_Model_DbTable_Equivalencia();
                    $lista_equivalencia = $modeloequivalencia->listarperiodo($detalleest[0]['idEstablecimiento'], $idperiodo, $segmento);
                    $mostrar = true;
                }

                if ($detalleest[0]['idEstablecimiento'] == 11) {
                    $mostrar = true;
                }


            } else {
                if ($detalleest[0]['idEstablecimiento'] == 11) {
                    $mostrar = true;
                }
            }

            $recuperando2 = new Zend_Session_Namespace('nombreperiodo');

            // variables para encabezado
            $titulo = "INFORME DE NOTAS " . strtoupper($nombresegmento) . " " . $recuperando2->nombreperiodo;
            $descripcion = "Reconocido Oficialmente por el Ministerio de Educación de la República de Chile, según Resolución Exenta de Educación Nº " . $detalleest[0]['numeroDecreto'] . " del año " . $detalleest[0]['yeardecreto'] . ". Rol Base de Datos Nº " . $detalleest[0]['rbd'] . ", otorga el presente Informe Educacional a:";
            $tituloest = "<b>" . $detalleest[0]['nombreEstablecimiento'] . "</b>";
            $logo = getcwd();
            $logo .= "/application/documentos/logos/" . $detalleest[0]['extension'];

            $plogo = '';
            if (file_exists($logo)) {

                $plogo = '<p style="position:absolute;top:3px;text-align:center"><img  src="' . $logo . '" /></p>';
            }


            //creo objeto tabla cuentas
            $modelCuenta = new Application_Model_DbTable_Cuentas();

            if ($detalleest[0]['idDirector']==0) {
                echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No está asignado el director\");</script>";
                echo "<script>parent.$.fancybox.close();</script>";
                exit;

            }
            $director = $modelCuenta->get($detalleest[0]['idDirector']);
            $Profesorjefe = $modelCuenta->getusuario($detalleest[0]['idCuentaJefe'], $idperiodo);
            $largoalumnos = count($listadealumnos);
            $largoasignatura = count($listaasignatura);


            if (count($director) == 0) {
                echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta director\");</script>";
                echo "<script>parent.$.fancybox.close();</script>";
                exit;

            }

            if (count($Profesorjefe) == 0 || $Profesorjefe == null) {
                echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta Profesor Jefe\");</script>";
                echo "<script>parent.$.fancybox.close();</script>";
                exit;
            }


            $date = new DateTime;
            $fechain = $date->format('Y-m-d');
            $cortado = explode("-", $fechain);
            $dias = array("Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado");
            $meses = array("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre");

            $fecha_final = $dias[date('w', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]))] . " " . $cortado[2] . " de " . $meses[date('n', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0])) - 1] . " del " . date('Y', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]));

            $niveleducacion = $detalleest[0]['idCodigoTipo'];
            $grado = $detalleest[0]['idGrado'];

            if ($niveleducacion == '110') {
                $nombreedu = 'Enseñanza Básica';

            }

            if ($niveleducacion == '310') {
                $nombreedu = 'Enseñanza Media';

            }
            if ($niveleducacion == '410') {
                $nombreedu = 'Enseñanza Media Técnico-Profesional Comercial';
                if ($detalleest[0]['rbd'] == '1864') {//Cesa
                    $nombredecreto = 'Nº 954 del año 2015';
                    $nombreexento = 'Decreto Supremo Evaluación,Calificación Escolar Nº 67 de 2018';


                }

            }

            if ($niveleducacion == '463') {
                $nombreedu = 'Enseñanza Media Técnico-Profesional Adultos Comercial';

            }

            if ($niveleducacion == '510') {
                $nombreedu = 'Enseñanza Media Técnico-Profesional Industrial';
                if ($detalleest[0]['rbd'] == '1864') {//Cesa
                    $nombredecreto = 'Nº 954 del año 2015';
                    $nombreexento = 'Decreto Supremo Evaluación,Calificación Escolar Nº 67 de 2018';


                }

            }

            if ($niveleducacion == '563') {
                $nombreedu = 'Enseñanza Media Técnico-Profesional Adultos Industrial';

            }
            if ($niveleducacion == '610') {
                $nombreedu = 'Enseñanza Media Técnico-Profesional ';
                //General Velasquez
                if ($detalleest[0]['rbd'] == '1863') {
                    $nombredecreto = 'Nº 954 del año 2015';
                    $nombreexento = 'Decreto Exento Nº 83 de 2001.';
                    if ($detalleest[0]['letra'] == 'A') {
                        $nombreedu = "Enseñanza Media Técnico-Profesional Atención de Párvulos";

                    }
                    if ($detalleest[0]['letra'] == 'B') {
                        $nombreedu = "Enseñanza Media Técnico-Profesional Servicio de Hotelería";

                    }
                    if ($detalleest[0]['letra'] == 'C') {
                        $nombreedu = "Enseñanza Media Técnico-Profesional Gastronomía Mención Cocina ";

                    }

                }

                if ($detalleest[0]['rbd'] == '1864') {//Cesa
                    $nombredecreto = 'Nº 954 del año 2015';
                    $nombreexento = 'Decreto Supremo Evaluación,Calificación Escolar Nº 67 de 2018';


                }

            }

            if ($niveleducacion == '663') {
                $nombreedu = 'Enseñanza Media Técnico-Profesional Adultos';

            }


            if ($niveleducacion == 110 && $grado < 7) {
                $nombredecreto = 'Nº 2960 del año 2012';
                $nombreexento = 'Decreto Exento Nº 511 de 1997.';

                if ($detalleest[0]['rbd'] == '1864') {//Cesa
                    $nombredecreto = 'Nº 954 del año 2015';
                    $nombreexento = 'Decreto Supremo Evaluación,Calificación Escolar Nº 67 de 2018';


                }
                if ($detalleest[0]['rbd'] == '1873') {//Horcon
                    $nombreexento = 'Decreto Nº 67 de 2018';


                }

            }
            if ($niveleducacion == 110 && ($grado > 6 && $grado < 9)) {
                $nombredecreto = 'Nº 1363 del año 2011 ';
                $nombreexento = 'Decreto Exento Nº 511 de 1997.';

                if ($detalleest[0]['rbd'] == '1864') {//Cesa
                    $nombredecreto = 'Nº 954 del año 2015';
                    $nombreexento = 'Decreto Exento Nº 67 de 2018.';


                }

                if ($detalleest[0]['rbd'] == '1873') {//Horcon
                    $nombredecreto = 'Nº 1363 del año 2011 ';
                    $nombreexento = 'Decreto Nº 67 de 2018';


                }

            }
            if ($niveleducacion == 310 && $grado > 0) {
                $nombredecreto = 'Nº 1358  del año 2011';
                $nombreexento = 'Decreto Exento Nº 112 de 1999.';

                if ($detalleest[0]['rbd'] == '1864') {//Cesa
                    $nombredecreto = 'Nº 954 del año 2015';
                    $nombreexento = 'Decreto Supremo Evaluación,Calificación Escolar Nº 67 de 2018.';


                }

            }

            if ($niveleducacion == '363') {
                $nombreedu = 'Enseñanza Media Adultos ';

                if ($detalleest[0]['rbd'] == '1864') {//Cesa
                    $nombredecreto = 'Nº 954 del año 2015';
                    $nombreexento = 'Decreto Exento Nº 2169 de 2007.';


                }

            }

            if ($niveleducacion == '165') {
                $nombreedu = 'Enseñanza Básica Adultos ';

                if ($detalleest[0]['rbd'] == '1864') {//Cesa
                    $nombredecreto = 'Nº 954 del año 2015';
                    $nombreexento = 'Decreto Exento Nº 2169 de 2007.';


                }

            }
            $taller = array();
            $combinada = array();
            for ($y = 0; $y < $largoalumnos; $y++) {
                $tablanotas = array();
                $alumnoactual = array();
                $verifica = array();
                $cuenta = 0;
                $promedio = 0;
                $cuenta1 = array();
                $cuentan = 0;
                $promedion = 0;
                $promediof = 0;
                $promediofn = 0;
                $cuenta2 = array();
                $promedioparcial = 0;
                $contadorparcial = 0;
                $tablanotas = array();
                $tablanotas2 = array();
                $datostalleres = array();
                $promediotaller = array();
                $largoasignaturanoincide = 0;
                $listaasignaturanoinciden = array();

                $datostallersem = $modelasignatura->gettaller($idcursoactual, $idperiodo, array(1, 2), 1, array($segmento));
                $datostalleranual = $modelasignatura->gettalleranual($idcursoactual, $idperiodo, array(1), 1);
                $datostallersin = $modelasignatura->gettallersin($idcursoactual, $idperiodo);
                $listastalleres = array_merge($datostalleranual, $datostallersem);
                $listaasignaturanoinciden = array_merge($listastalleres, $datostallersin);


                $idalumnoactual = $listadealumnos[$y]['idAlumnos'];

                $tablanotas = $tabla->generasolonotasperiodo($idalumnoactual, $segmento, 1, $idperiodo, $idcursoactual);
                $tablanotas2 = $tabla->generasolonotasperiodo($idalumnoactual, $segmento, 0, $idperiodo, $idcursoactual);
                $verifica = $modeloalumnodetalle->get($listadealumnos[$y]['idAlumnosActual'], $segmento, $idperiodo);
                $observacion = $verifica[0]["observaciones"];
                $largotablanota2 = count($tablanotas2);
                $largotablaaux = count($tablanotas);

                //Notas de talleres

                //Configuraciones de Taller

                //Configuracion de Taller Buscamos si existen configuraciones por alumnos

                $modelotallerdetalle = new Application_Model_DbTable_Asignaturascursos();
                //Obtiene los Talleres que son Semestrales Tiempo=2.
                $datostalleres = $modelasignatura->gettaller($idcursoactual, $idperiodo, array(2), 2, array($segmento));


                if (count($datostalleres) > 0) {
                    for ($i = 0; $i < count($datostalleres); $i++) {
                        $detalletaller = $modelotallerdetalle->gettallersegmento($datostalleres[$i]['idConfiguracionTaller'], $segmento, $idalumnoactual);
                        if ($detalletaller) {

                            $listaasignaturanoinciden[] = $detalletaller[0];
                        }

                    }


                }
                $largoasignaturanoincide = count($listaasignaturanoinciden);

                $totalnotascurso = $tabla->listarnotascursoperiodo($idcursoactual, $idperiodo, array($segmento));
                $largonota = count($totalnotascurso);
                $contador1 = array();
                $contador12 = array();
                $contador13 = array();
                $contador14 = array();


                for ($i = 0; $i < $largoasignatura; $i++) {
                    $contador1[$i] = 0;
                    for ($j = 0; $j < $largonota; $j++) {
                        if ($listaasignatura[$i]["idAsignatura"] == $totalnotascurso[$j]["idAsignatura"]) {
                            if ($totalnotascurso[$j]["coef"] == 2) {
                                $contador1[$i] += 2;
                            } else {
                                $contador1[$i] += 1;
                            }
                        }

                    }
                    for ($k = 0; $k < $largoasignaturanoincide; $k++) {
                        if ($listaasignatura[$i]["idAsignatura"] == $listaasignaturanoinciden[$k]["idAsignaturaTaller"] && !empty($listaasignaturanoinciden[$k]["forma"])) {
                            $contador1[$i] += 1;
                        }
                    }

                    for ($k = 0; $k < $largocombinada; $k++) {
                        $asignaturascom = unserialize($datosasignaturascombinada[$k]['asignaturas']);
                        for ($l = 0; $l < count($asignaturascom); $l++) {
                            if ($listaasignatura[$i]["idAsignatura"] == $datosasignaturascombinada[$k]['idAsignatura']) {
                                $contador1[$i] += 1;
                            }
                        }

                    }
                }

                if ($contador1 === 'NULL' || $contador1 == null || empty($contador1)) {
                    $rowspan = 1;
                } else {
                    $rowspan = max($contador1);
                }

                for ($i = 0; $i < $largoasignaturanoincide; $i++) {
                    $contador12[$i] = 0;
                    for ($j = 0; $j < $largonota; $j++) {
                        if ($listaasignaturanoinciden[$i]["idAsignatura"] == $totalnotascurso[$j]["idAsignatura"]) {
                            if ($totalnotascurso[$j]["coef"] == 2) {
                                $contador12[$i] += 2;
                            } else {
                                $contador12[$i] += 1;
                            }
                        }

                    }

                }

                for ($i = 0; $i < $largocompuesta; $i++) {
                    $contador12[$i] = 0;
                    for ($j = 0; $j < $largonota; $j++) {
                        if ($listaasignaturacompuesta[$i]["idAsignatura"] == $totalnotascurso[$j]["idAsignatura"]) {
                            if ($totalnotascurso[$j]["coef"] == 2) {
                                $contador13[$i] += 2;
                            } else {
                                $contador13[$i] += 1;
                            }
                        }

                    }

                }

                for ($i = 0; $i < $largoconcepto; $i++) {
                    $contador14[$i] = 0;
                    for ($j = 0; $j < $largonota; $j++) {
                        if ($listaasignaturaconcepto[$i]["idAsignatura"] == $totalnotascurso[$j]["idAsignatura"]) {
                            if ($totalnotascurso[$j]["coef"] == 2) {
                                $contador14[$i] += 2;
                            } else {
                                $contador14[$i] += 1;
                            }
                        }

                    }

                }

                if ($contador12 === 'NULL' || $contador12 == NULL || empty($contador12)) {
                    $rowspan12 = 1;
                } else {
                    $rowspan12 = max($contador12);
                }

                if ($contador13 === 'NULL' || $contador13 == NULL || empty($contador13)) {
                    $rowspan13 = 1;
                } else {
                    $rowspan13 = max($contador13);
                }
                if ($contador14 === 'NULL' || $contador14 == NULL || empty($contador14)) {
                    $rowspan14 = 1;
                } else {
                    $rowspan14 = max($contador14);
                }
                $rowspan1 = max(array($rowspan, $rowspan12, $rowspan13, $rowspan14));


                $verifica = $modeloalumnodetalle->get($listadealumnos[$y]['idAlumnosActual'], $segmento, $idperiodo);

                if ($verifica == null || $verifica == 0) {
                    $diastrabajados = 0;
                    $diasin = 0;
                    $asistencia = 0;
                    $atraso = 0;
                    $observacion = '';
                    $apoderado = '';
                } else {
                    $diastrabajados = $verifica[0]["diasTrabajado"];
                    $diasin = $verifica[0]["diasInasistencia"];
                    $asistencia = $verifica[0]["asistencia"];
                    $atraso = $verifica[0]["numeroatrasos"];
                    $observacion = $verifica[0]["observaciones"];
                    $apoderado = $verifica[0]["nombreApoderado"];
                }


                //Notas de talleres

                $espacio = $rowspan1 + 2;
                if ($largoasignaturanoincide != 0) {


                    if ($detalleest[0]['monitoreo'] == 1) {

                        if ($detalleest[0]['idEstablecimiento'] == 12) {

                            $taller[$y] .= "<tr><td colspan='4'><b>TALLERES Y ASIGNATURAS</b></td></tr>";

                        } else {
                            $taller[$y] .= "<tr><td colspan=" . $espacio . "><b>TALLERES Y ASIGNATURAS</b></td></tr>";
                        }


                    } else {
                        $taller[$y] .= "<tr><td colspan=" . $espacio . "><b>TALLERES Y ASIGNATURAS</b></td></tr>";
                    }
                    for ($i = 0; $i < $largoasignaturanoincide; $i++) {

                        $auxtexto = '';

                        //Configuracion de Taller
                        if ($listaasignaturanoinciden[$i]["tipoAjuste"] == 2) {

                            $promediotaller['idAsignatura'] = $detalletaller[0]['idAsignaturaDestino'];


                        } else {
                            $promediotaller['idAsignatura'] = $listaasignaturanoinciden[$i]["idAsignaturaTaller"];
                        }

                        $cuenta2[$i] = 0;
                        $promedion = 0;
                        $cuentan = 0;
                        $auxtexto .= "<tr><td class='celda'>" . $listaasignaturanoinciden[$i]["nombreAsignatura"] . "</td>";

                        for ($j = 0; $j < $largotablanota2; $j++) {
                            if ($listaasignaturanoinciden[$i]["idAsignatura"] == $tablanotas2[$j]["idAsignatura"]) {
                                if ($tablanotas2[$j]['coef'] == 2) {
                                    if ($tablanotas2[$j]['nota'] != '0') {

                                        $arr1 = str_split($tablanotas2[$j]['nota']);
                                        if (!$mostrar) {
                                            $auxtexto .= "<td>" . $arr1[0] . ',' . $arr1[1] . "</td>";
                                            $auxtexto .= "<td>" . $arr1[0] . ',' . $arr1[1] . "</td>";
                                        }

                                        $promedion = $promedion + ($tablanotas2[$j]['nota'] + $tablanotas2[$j]['nota']);
                                        $cuentan = $cuentan + 2;

                                    } else {

                                        if (!$mostrar) {
                                            $auxtexto .= "<td>-</td>";
                                            $auxtexto .= "<td>-</td>";
                                        }

                                    }
                                    $cuenta2[$i] = $cuenta2[$i] + 2;

                                } else {

                                    if ($tablanotas2[$j]['nota'] != '0') {

                                        $arr1 = str_split($tablanotas2[$j]['nota']);
                                        if (!$mostrar) {
                                            $auxtexto .= "<td>" . $arr1[0] . ',' . $arr1[1] . "</td>";
                                        }


                                        $promedion = $promedion + $tablanotas2[$j]['nota'];
                                        $cuentan = $cuentan + 1;

                                    } else {

                                        if (!$mostrar) {
                                            $auxtexto .= "<td>-</td>";
                                        }
                                    }
                                    $cuenta2[$i] = $cuenta2[$i] + 1;

                                }

                            }

                        }
                        if ($cuenta2[$i] < $rowspan1) {
                            if (!$mostrar) {
                                $largo2 = $rowspan1 - $cuenta2[$i];

                                for ($u = 0; $u < $largo2; $u++) {
                                    $auxtexto .= "<td>-</td>";
                                }
                            }


                        }

                        //sacamos el promedio de la asignatura


                        if ($promedion > 0 || $cuentan > 0) {


                            if ($detalleest[0]['aproxAsignatura'] == 1) {
                                $promediofn = round($promedion / $cuentan);
                                $promediotaller['nota'] = $promediofn;
                                $promediotaller['coef'] = 1;
                                $promediotaller['idAsignatura'] = $listaasignaturanoinciden[$i]["idAsignaturaTaller"];
                                $promediotaller['forma'] = $listaasignaturanoinciden[$i]["forma"];
                                $promediotaller['porcentaje'] = $listaasignaturanoinciden[$i]["porcentaje"];
                                $promediotaller['tipoAjuste'] = $listaasignaturanoinciden[$i]["tipoAjuste"];
                                $promediotaller['idConfiguracionTaller'] = $listaasignaturanoinciden[$i]["idConfiguracionTaller"];
                                $promediotaller['tipoAsignatura'] = $listaasignaturanoinciden[$i]["tipoAsignatura"];

                            } else {
                                $promediofn = intval($promedion / $cuentan);
                                $promediotaller['nota'] = $promediofn;
                                $promediotaller['coef'] = 1;

                                $promediotaller['forma'] = $listaasignaturanoinciden[$i]["forma"];
                                $promediotaller['porcentaje'] = $listaasignaturanoinciden[$i]["porcentaje"];
                                $promediotaller['tipoAjuste'] = $listaasignaturanoinciden[$i]["tipoAjuste"];
                                $promediotaller['idConfiguracionTaller'] = $listaasignaturanoinciden[$i]["idConfiguracionTaller"];
                                $promediotaller['tipoAsignatura'] = $listaasignaturanoinciden[$i]["tipoAsignatura"];

                            }


                            if ($detalleest[0]['monitoreo'] == 1) {

                                if ($detalleest[0]['idEstablecimiento'] == 12) {

                                    $devuelve = $this->equivalencias($lista_equivalencia, $promediofn);
                                    $auxtexto .= "<td>" . $devuelve[0] . "%</td>";
                                    $auxtexto .= "<td>" . $devuelve[1] . "</td>";

                                }


                            }

                            $auxtexto .= "<td class='prom'>" . $promediofn . "</td>";

                            $auxtexto .= "</tr>";
                            $taller[$y] .= $auxtexto;

                        } else {
                            $promediotaller['nota'] = 0;
                            $promediotaller['coef'] = 1;
                            $promediotaller['forma'] = $listaasignaturanoinciden[$i]["forma"];
                            $promediotaller['porcentaje'] = $listaasignaturanoinciden[$i]["porcentaje"];
                            $promediotaller['tipoAjuste'] = $listaasignaturanoinciden[$i]["tipoAjuste"];
                            $promediotaller['idConfiguracionTaller'] = $listaasignaturanoinciden[$i]["idConfiguracionTaller"];
                            $promediotaller['idAsignatura'] = $listaasignaturanoinciden[$i]["idAsignaturaTaller"];
                            $promediotaller['tipoAsignatura'] = $listaasignaturanoinciden[$i]["tipoAsignatura"];
                            //$taller[$y] .= "<td class='prom'>-</td></tr>";
                        }

                        //Cechekeamos a que tipo pertenece la asignatura de destino del taller
                        if (!empty($listaasignaturanoinciden[$i]["idAsignaturaTaller"])) {
                            $datosdestino = $modelasignatura->getdestino($listaasignaturanoinciden[$i]["idAsignaturaTaller"]);

                            if ($datosdestino[0]['tipoAsignatura'] == 4) {
                                $tablanotas2[] = $promediotaller;
                            } else {
                                $tablanotas[] = $promediotaller;
                            }
                        }


                    }


                }

                //Notas de Asignaturas que pertenecen a una combinada

                if ($largocombinada != 0) {
                    $largotablanota2 = count($tablanotas2);


                    for ($i = 0; $i < $largocombinada; $i++) {

                        $setasignatura = unserialize($datosasignaturascombinada[$i]['asignaturas']);
                        for ($k = 0; $k < count($setasignatura); $k++) {
                            $cuentan = 0;
                            $promedion = 0;
                            $promediof = 0;
                            $notatallercom = 0;
                            $porcentajetallercom = 0;
                            $cuenta2 = array();
                            $datocombinada = $modelasignatura->getnombre($setasignatura[$k]);

                            $cuenta2[$i] = 0;
                            $combinada[$y] .= "<tr><td class='celda'>" . $datocombinada[0]["nombreAsignatura"] . "</td>";

                            for ($j = 0; $j < $largotablanota2; $j++) {
                                if ($datocombinada[0]["idAsignatura"] == $tablanotas2[$j]["idAsignatura"]) {
                                    if ($tablanotas2[$j]['coef'] == 2) {
                                        if ($tablanotas2[$j]['nota'] != '0') {

                                            $arr1 = str_split($tablanotas2[$j]['nota']);

                                            if (!$mostrar) {
                                                $combinada[$y] .= "<td>" . $arr1[0] . ',' . $arr1[1] . "</td>";
                                                $combinada[$y] .= "<td>" . $arr1[0] . ',' . $arr1[1] . "</td>";
                                            }


                                            $promedion = $promedion + ($tablanotas2[$j]['nota'] + $tablanotas2[$j]['nota']);
                                            $cuentan = $cuentan + 2;

                                        } else {

                                            if (!$mostrar) {
                                                $combinada[$y] .= "<td>-</td>";
                                                $combinada[$y] .= "<td>-</td>";
                                            }
                                        }
                                        $cuenta2[$i] = $cuenta2[$i] + 2;

                                    } else {


                                        if ($tablanotas2[$j]['nota'] != '0') {

                                            if (empty($tablanotas2[$j]['forma'])) {
                                                $arr1 = str_split($tablanotas2[$j]['nota']);

                                                if (!$mostrar) {
                                                    $combinada[$y] .= "<td>" . $arr1[0] . ',' . $arr1[1] . "</td>";
                                                }
                                                $promedion += $tablanotas2[$j]['nota'];
                                                $cuentan += 1;
                                            } else {

                                                if ($tablanotas2[$j]['forma'] == 1) {
                                                    $arr1 = str_split($tablanotas2[$j]['nota']);
                                                    if (!$mostrar) {
                                                        $combinada[$y] .= "<td bgcolor='#B2B0AF'>" . $arr1[0] . ',' . $arr1[1] . "</td>";
                                                    }

                                                    $promedion += $tablanotas2[$j]['nota'];
                                                    $cuentan += 1;
                                                }
                                                if ($tablanotas2[$j]['forma'] == 2) {
                                                    $arr1 = str_split($tablanotas2[$j]['nota']);

                                                    if (!$mostrar) {
                                                        $combinada[$y] .= "<td bgcolor='#B2B0AF'>" . $arr1[0] . ',' . $arr1[1] . "</td>";
                                                    }
                                                    $porcentajetallercom = $tablanotas2[$j]['porcentaje'];
                                                    $notatallercom = $tablanotas2[$j]['nota'];
                                                }
                                            }


                                        } else {
                                            if (empty($tablanotas2[$j]['forma'])) {

                                                if (!$mostrar) {
                                                    $combinada[$y] .= "<td>-</td>";
                                                }
                                            } else {
                                                if ($tablanotas2[$j]['forma'] == 1) {

                                                    if (!$mostrar) {
                                                        $combinada[$y] .= "<td bgcolor='#B2B0AF'>-</td>";
                                                    }
                                                }
                                                if ($tablanotas2[$j]['forma'] == 2) {

                                                    if (!$mostrar) {
                                                        $combinada[$y] .= "<td bgcolor='#B2B0AF'>-</td>";
                                                    }
                                                    $porcentajetallercom = $tablanotas2[$j]['porcentaje'];
                                                    $notatallercom = 0;
                                                }


                                            }
                                        }

                                        $cuenta2[$i] += 1;

                                    }

                                }

                            }
                            if ($cuenta2[$i] < $rowspan1) {

                                if (!$mostrar) {
                                    $largo2 = $rowspan1 - $cuenta2[$i];

                                    for ($u = 0; $u < $largo2; $u++) {
                                        $combinada[$y] .= "<td>-</td>";
                                    }
                                }


                            }

                            //sacamos el promedio de la asignatura


                            if ($promedion > 0 || $cuentan > 0) {
                                if ($detalleest[0]['aproxAsignatura'] == 1) {
                                    //$promediofn = round($promedion / $cuentan);
                                    //nuevo Promedio con taller
                                    if (empty($notatallercom)) {

                                        $promediofn = round($promedion / $cuentan);

                                    } else {
                                        $porcentajecom = 100 - $porcentajetallercom;
                                        $promediofn = (round($promedion / $cuentan)) * ($porcentajecom / 100) + ($notatallercom * ($porcentajetallercom / 100));
                                        $promediofn = round($promediofn);

                                    }


                                    //Fin Taller
                                    $promediocombinada['nota'] = $promediofn;
                                    $promediocombinada['coef'] = 1;
                                    $datoasignatura = $modelasignatura->getnombre($datosasignaturascombinada[$i]["idAsignaturaCurso"]);
                                    $promediocombinada['idAsignatura'] = $datoasignatura[0]["idAsignatura"];


                                } else {
                                    //$promediofn = intval($promedion / $cuentan);
                                    //Nuevo Promedio con Taller

                                    if (empty($notatallercom)) {
                                        $promediofn = intval($promedion / $cuentan);
                                    } else {
                                        $porcentajecom = 100 - $porcentajetallercom;
                                        $promediofn = (round($promedion / $cuentan)) * ($porcentajecom / 100) + ($notatallercom * ($porcentajetallercom / 100));
                                        $promediofn = intval($promediofn);
                                    }
                                    //Fin Taller
                                    $promediocombinada['nota'] = $promediofn;
                                    $promediocombinada['coef'] = 1;
                                    $datoasignatura = $modelasignatura->getnombre($datosasignaturascombinada[$i]["idAsignaturaCurso"]);
                                    $promediocombinada['idAsignatura'] = $datoasignatura[0]["idAsignatura"];


                                }


                                if ($detalleest[0]['monitoreo'] == 1) {

                                    if ($detalleest[0]['idEstablecimiento'] == 12) {

                                        $devuelve = $this->equivalencias($lista_equivalencia, $promediofn);
                                        $combinada[$y] .= "<td>" . $devuelve[0] . "%</td>";
                                        $combinada[$y] .= "<td>" . $devuelve[1] . "</td>";

                                    }


                                }
                                $combinada[$y] .= "<td class='prom'>" . $promediofn . "</td>";

                                $combinada[$y] .= "</tr>";


                            } else {
                                $promediocombinada['nota'] = 0;
                                $promediocombinada['coef'] = 1;
                                $datoasignatura = $modelasignatura->getnombre($datosasignaturascombinada[$i]["idAsignaturaCurso"]);
                                $promediocombinada['idAsignatura'] = $datoasignatura[0]["idAsignatura"];


                                if ($detalleest[0]['monitoreo'] == 1) {

                                    if ($detalleest[0]['idEstablecimiento'] == 12) {
                                        $combinada[$y] .= "<td>-</td>";
                                        $combinada[$y] .= "<td>-</td>";

                                    }


                                }
                                $combinada[$y] .= "<td class='prom'>-</td>";

                                $combinada[$y] .= "</tr>";
                            }

                            $tablanotas[] = $promediocombinada;

                        }
                    }


                }


                $largotablanota = count($tablanotas);


                //Asignaturas Conceptos


                if ($largoconcepto != 0) {
                    for ($i = 0; $i < $largoconcepto; $i++) {
                        $resultado[$i] = $modelasignatura->getasignaturaconcepto($listaasignaturaconcepto[$i]["idAsignatura"], $idcursoactual, $idperiodo);

                        $cuentan = 0;
                        $promedion = 0;
                        $promediof = 0;
                        $cuenta2 = array();
                        $concepto[$y] .= "<tr><td class='celda'>" . $listaasignaturaconcepto[$i]["nombreAsignatura"] . "</td>";
                        $cuenta2[$i] = 0;
                        for ($l = 0; $l < count($resultado[$i]); $l++) {
                            $listaconceptos[$i][$resultado[$i][$l]['notaconcepto']] = $resultado[$i][$l]['concepto'];


                            $listaconceptospromedio[$i][$l] = array($resultado[$i][$l]['desde'], $resultado[$i][$l]['hasta'], $resultado[$i][$l]['concepto']);

                        }


                        for ($j = 0; $j < $largotablanota2; $j++) {
                            if ($listaasignaturaconcepto[$i]["idAsignatura"] == $tablanotas2[$j]["idAsignatura"]) {


                                if ($tablanotas2[$j]['coef'] == 2) {
                                    if ($tablanotas2[$j]['nota'] != '0') {

                                        for ($l = 0; $l < count($listaconceptospromedio[$i]); $l++) {
                                            if ($tablanotas2[$j]['nota'] >= $listaconceptospromedio[$i][$l][0] && $tablanotas2[$j]['nota'] <= $listaconceptospromedio[$i][$l][1]) {
                                                $promediofnconcepto = $listaconceptospromedio[$i][$l][2];


                                                if (!$mostrar) {
                                                    $concepto[$y] .= "<td>" . $listaconceptospromedio[$i][$l][2] . "</td>";
                                                    $concepto[$y] .= "<td>" . $listaconceptospromedio[$i][$l][2] . "</td>";
                                                }

                                            }

                                        }


                                        $promedion = $promedion + ($tablanotas2[$j]['nota'] + $tablanotas2[$j]['nota']);
                                        $cuentan = $cuentan + 2;

                                    } else {

                                        if (!$mostrar) {
                                            $concepto[$y] .= "<td>-</td>";
                                            $concepto[$y] .= "<td>-</td>";
                                        }
                                    }
                                    $cuenta2[$i] = $cuenta2[$i] + 2;

                                } else {

                                    if ($tablanotas2[$j]['nota'] != '0') {
                                        for ($l = 0; $l < count($listaconceptospromedio[$i]); $l++) {
                                            if ($tablanotas2[$j]['nota'] >= $listaconceptospromedio[$i][$l][0] && $tablanotas2[$j]['nota'] <= $listaconceptospromedio[$i][$l][1]) {
                                                $promediofnconcepto = $listaconceptospromedio[$i][$l][2];


                                                if (!$mostrar) {
                                                    $concepto[$y] .= "<td>" . $listaconceptospromedio[$i][$l][2] . "</td>";
                                                }

                                            }

                                        }


                                        $promedion = $promedion + $tablanotas2[$j]['nota'];
                                        $cuentan = $cuentan + 1;

                                    } else {

                                        if (!$mostrar) {
                                            $concepto[$y] .= "<td>-</td>";
                                        }
                                    }
                                    $cuenta2[$i] = $cuenta2[$i] + 1;

                                }

                            }

                        }
                        if ($cuenta2[$i] < $rowspan1) {

                            if (!$mostrar) {
                                $largo2 = $rowspan1 - $cuenta2[$i];

                                for ($u = 0; $u < $largo2; $u++) {
                                    $concepto[$y] .= "<td>-</td>";
                                }
                            }


                        }

                        //sacamos el promedio de la asignatura


                        if ($promedion > 0 || $cuentan > 0) {

                            if ($detalleest[0]['aproxAsignatura'] == 1) {
                                $promediofn = round($promedion / $cuentan);


                            } else {
                                $promediofn = intval($promedion / $cuentan);


                            }
                            for ($l = 0; $l < count($listaconceptospromedio[$i]); $l++) {
                                if ($promediofn >= $listaconceptospromedio[$i][$l][0] && $promediofn <= $listaconceptospromedio[$i][$l][1]) {
                                    $promediofnconcepto = $listaconceptospromedio[$i][$l][2];

                                }

                            }


                            if ($detalleest[0]['monitoreo'] == 1) {

                                if ($detalleest[0]['idEstablecimiento'] == 12) {

                                    $devuelve = $this->equivalencias($lista_equivalencia, $promediofn);
                                    $concepto[$y] .= "<td>" . $devuelve[0] . "%</td>";
                                    $concepto[$y] .= "<td>" . $devuelve[1] . "</td>";

                                }


                            }
                            $concepto[$y] .= "<td class='prom'>" . $promediofnconcepto . "</td>";

                            $concepto[$y] .= "</tr>";

                        } else {


                            if ($detalleest[0]['monitoreo'] == 1) {

                                if ($detalleest[0]['idEstablecimiento'] == 12) {
                                    $concepto[$y] .= "<td>-</td>";
                                    $concepto[$y] .= "<td>-</td>";

                                }


                            }
                            $concepto[$y] .= "<td class='prom'>-</td>";

                            $concepto[$y] .= "</tr>";
                        }


                    }

                }

                //Formato del rut

                $rutset = $listadealumnos[$y]['rutAlumno'];
                if (!empty($rutset)) {

                    $rest = substr($rutset, 0, -1);
                    $ultimo = substr($rutset, -1);
                    $formatomiles = number_format($rest, 0, "", ".");
                    $formatofinal = $formatomiles . '-' . $ultimo;

                }


                $nombrecompleto = $listadealumnos[$y]['nombres'] . ' ' . $listadealumnos[$y]['apaterno'] . ' ' . $listadealumnos[$y]['amaterno'];
                $nombrecompleto = strtoupper($nombrecompleto);

                $alumno = 'Don(a): <span style=" text-decoration: underline;">' . $nombrecompleto . '</span> RUN: <span style=" text-decoration: underline;">' . $formatofinal . '</span> Alumno(a) de <b>' . $detalleest[0]['nombreGrado'] . ' ' . $detalleest[0]['letra'] . ' de ' . $nombreedu . '</b>, de Acuerdo a Decreto Plan de Estudio ' . $nombredecreto . ' y del Reglamento de Evaluación y Promoción Escolar ' . $nombreexento . '';

                $encabezado = $plogo . '<h5 style="position:absolute;top:110px;text-align:center">' . $titulo . '</h5><h4 style="position:absolute;top:130px;text-align:center">' . $tituloest . '</h4>'
                    . '<p style="margin-top:20px; text-align:left;">' . $descripcion . '</p>'

                    . '<p style="margin-top:1px; text-align:left;">' . $alumno . '</p>';
                $html[$y] = '';
                $html[$y] .= $encabezado;


                if ($largotablaaux < 1) {
                    $html[$y] .= "<table  align='center' border='1'><tr><th style='width:25%'>Asignaturas</th><th style='width:65%'>" . $nombresegmento . "</th><th style='width:10%'>Promedio</th></tr>";
                    $html[$y] .= "<tr><td colspan='3'>Sin Notas en éste periodo</td></tr>";
                } else {

                    if ($detalleest[0]['monitoreo'] == 1) {

                        if ($detalleest[0]['idEstablecimiento'] == 12) {

                            $html[$y] .= "<table  align='center' border='1'><tr><th style='width:74%'>Asignaturas</th><th style='width:8%'>% Logro</th><th style='width:8%'>Nivel Logro</th><th style='width:10%'>Promedio</th></tr>";


                        } else {

                            if ($detalleest[0]['idEstablecimiento'] == 11) {

                                $html[$y] .= "<table  align='center' border='1'><tr><th style='width:90%'>Asignaturas</th><th style='width:10%'>Promedio</th></tr>";


                            } else {
                                $html[$y] .= "<table  align='center' border='1'><tr><th style='width:25%'>Asignaturas</th><th style='width:65%' colspan=" . $rowspan1 . ">" . $nombresegmento . "</th><th style='width:10%'>Promedio</th></tr>";

                            }


                        }


                    } else {
                        if ($detalleest[0]['idEstablecimiento'] == 11) {

                            $html[$y] .= "<table  align='center' border='1'><tr><th style='width:90%'>Asignaturas</th><th style='width:10%'>Promedio</th></tr>";


                        } else {
                            $html[$y] .= "<table  align='center' border='1'><tr><th style='width:25%'>Asignaturas</th><th style='width:65%' colspan=" . $rowspan1 . ">" . $nombresegmento . "</th><th style='width:10%'>Promedio</th></tr>";

                        }

                    }


                    $contadorparcial = 0;
                    for ($i = 0; $i < $largoasignatura; $i++) {
                        $cuenta1[$i] = 0;
                        $promedio = 0;
                        $cuenta = 0;
                        $auxtexto = "<tr><td class='celda'>" . $listaasignatura[$i]["nombreAsignatura"] . "</td>";

                        for ($j = 0; $j < $largotablanota; $j++) {
                            if ($listaasignatura[$i]["idAsignatura"] == $tablanotas[$j]["idAsignatura"]) {
                                if ($tablanotas[$j]['coef'] == 2) {
                                    if ($tablanotas[$j]['nota'] != '0' && $tablanotas[$j]['nota'] != null) {
                                        $arr1 = str_split($tablanotas[$j]['nota']);

                                        if (!$mostrar) {
                                            $auxtexto .= "<td>" . $arr1[0] . ',' . $arr1[1] . "</td>";
                                            $auxtexto .= "<td>" . $arr1[0] . ',' . $arr1[1] . "</td>";
                                        }

                                        $promedio += ($tablanotas[$j]['nota'] + $tablanotas[$j]['nota']);
                                        $cuenta += 2;

                                    } else {


                                        if (!$mostrar) {
                                            $auxtexto .= "<td>-</td>";
                                            $auxtexto .= "<td>-</td>";
                                        }
                                    }
                                    $cuenta1[$i] += 2;

                                } else {

                                    if ($tablanotas[$j]['nota'] != '0' && $tablanotas[$j]['nota'] != null) {

                                        if (empty($tablanotas[$j]['forma'])) {
                                            $arr1 = str_split($tablanotas[$j]['nota']);

                                            if (!$mostrar) {
                                                $auxtexto .= "<td>" . $arr1[0] . ',' . $arr1[1] . "</td>";
                                            }
                                            $promedio += $tablanotas[$j]['nota'];
                                            $cuenta += 1;
                                            $notataller = array();
                                            $porcentajetaller = array();
                                        } else {

                                            if ($tablanotas[$j]['forma'] == 1) {
                                                $arr1 = str_split($tablanotas[$j]['nota']);

                                                if (!$mostrar) {
                                                    $auxtexto .= "<td bgcolor='#B2B0AF'>" . $arr1[0] . ',' . $arr1[1] . "</td>";
                                                }
                                                $promedio += $tablanotas[$j]['nota'];
                                                $cuenta += 1;
                                                $notataller = array();
                                                $porcentajetaller = array();
                                            }
                                            if ($tablanotas[$j]['forma'] == 2) {
                                                $arr1 = str_split($tablanotas[$j]['nota']);
                                                if (!$mostrar) {
                                                    $auxtexto .= "<td bgcolor='#B2B0AF'>" . $arr1[0] . ',' . $arr1[1] . "</td>";
                                                }

                                                $porcentajetaller[] = $tablanotas[$j]['porcentaje'];
                                                $notataller[] = $tablanotas[$j]['nota'];
                                            }
                                        }


                                    } else {
                                        if (empty($tablanotas[$j]['forma'])) {

                                            if (!$mostrar) {
                                                $auxtexto .= "<td>-</td>";
                                            }
                                        } else {

                                            if (!$mostrar) {
                                                $auxtexto .= "<td bgcolor='#B2B0AF'>-</td>";
                                            }
                                        }
                                    }

                                    $cuenta1[$i] += 1;

                                }

                            }

                        }
                        if ($cuenta1[$i] < $rowspan1) {

                            if (!$mostrar) {
                                $largo = $rowspan1 - $cuenta1[$i];

                                for ($u = 0; $u < $largo; $u++) {
                                    $auxtexto .= "<td>-</td>";
                                }
                            }


                        }
                        if ($cuenta1[$i] == $contador1[$i]) {
                            //sacamos el promedio de la asignatura
                            if ($promedio > 0 || $cuenta > 0) {

                                // si es 1 Aproxima, si es 2 no Aproxima
                                if ($detalleest[0]['aproxAsignatura'] == 1) {
                                    if (empty($notataller)) {
                                        $promediof = round($promedio / $cuenta);
                                    } else {
                                        $porcentaje = 100;
                                        $resultadoauxtaller = 0;
                                        if (count($notataller) > 1) {
                                            for ($t = 0; $t < count($notataller); $t++) {
                                                $porcentaje = $porcentaje - $porcentajetaller[$t];
                                                $resultadoauxtaller += ($notataller[$t] * ($porcentajetaller[$t] / 100));

                                            }
                                            $promediof = (round($promedio / $cuenta)) * ($porcentaje / 100) + $resultadoauxtaller;

                                        } else {
                                            $porcentaje = $porcentaje - $porcentajetaller[0];
                                            $promediof = (round($promedio / $cuenta)) * ($porcentaje / 100) + ($notataller[0] * ($porcentajetaller[0] / 100));
                                            $promediof = round($promediof);
                                        }


                                    }

                                } else {
                                    if (empty($notataller)) {
                                        $promediof = intval($promedio / $cuenta);
                                    } else {
                                        $porcentaje = 100;
                                        $resultadoauxtaller = 0;
                                        if (count($notataller) > 1) {
                                            for ($t = 0; $t < count($notataller); $t++) {
                                                $porcentaje = $porcentaje - $porcentajetaller[$t];
                                                $resultadoauxtaller += ($notataller[$t] * ($porcentajetaller[$t] / 100));

                                            }
                                            $promediof = (round($promedio / $cuenta)) * ($porcentaje / 100) + $resultadoauxtaller;
                                            $promediof = intval($promediof);
                                        } else {
                                            $porcentaje = $porcentaje - $porcentajetaller[0];
                                            $promediof = (round($promedio / $cuenta)) * ($porcentaje / 100) + ($notataller[0] * ($porcentajetaller[0] / 100));
                                            $promediof = intval($promediof);
                                        }
                                    }


                                }
                                $promedioparcial += $promediof;
                                $contadorparcial += 1;
                                $promediocortado = str_split($promediof);


                                if ($detalleest[0]['monitoreo'] == 1) {

                                    if ($detalleest[0]['idEstablecimiento'] == 12) {

                                        $devuelve = $this->equivalencias($lista_equivalencia, $promediof);
                                        $auxtexto .= "<td>" . $devuelve[0] . "%</td>";
                                        $auxtexto .= "<td>" . $devuelve[1] . "</td>";

                                    }


                                }
                                $auxtexto .= "<td>" . $promediocortado[0] . ',' . $promediocortado[1] . "</td>";

                                $auxtexto .= "</tr>";

                                $html[$y] .= $auxtexto;

                            } else {
                                $promediof = 0;
                                //$html[$y] .= "<td>-</td></tr>";
                            }

                        }


                    }

                    $promedioparcialfinal = 0;

                    $mostrarpromedio = true;

                    $valoresmostrar = unserialize($detalleest[0]['mostrarPromedio']);

                    if ($valoresmostrar[0] == "2" && $segmento == "1") {
                        $mostrarpromedio = false;


                    } elseif ($valoresmostrar[1] == "2" && $segmento == "2") {
                        $mostrarpromedio = false;
                    }


                    if ($promedioparcial > 0 && $contadorparcial > 0) {
                        // si es 1 Aproxima,si es 2 no Aproxima
                        if ($detalleest[0]['aproxPeriodo'] == 1) {
                            $promedioparcialfinal = round($promedioparcial / $contadorparcial);
                        } else {
                            $promedioparcialfinal = intval($promedioparcial / $contadorparcial);
                        }
                        $promediocortadoparcial = str_split($promedioparcialfinal);

                        if ($detalleest[0]['monitoreo'] == 1) {

                            if ($detalleest[0]['idEstablecimiento'] == 12) {

                                if ($mostrarpromedio) {
                                    $devuelve = $this->equivalencias($lista_equivalencia, $promedioparcialfinal);
                                    $html[$y] .= "<tr><td style='text-align:left'><b>PROMEDIO GENERAL</b></td><td>" . $devuelve[0] . "%</td><td>" . $devuelve[1] . "</td><td>" . $promediocortadoparcial[0] . ',' . $promediocortadoparcial[1] . "</td></tr>";

                                }


                            } else {
                                if ($mostrarpromedio) {
                                    $html[$y] .= "<tr><td style='text-align:left' colspan=" . ($rowspan1 + 1) . "><b>PROMEDIO GENERAL</b></td><td>" . $promediocortadoparcial[0] . ',' . $promediocortadoparcial[1] . "</td></tr>";
                                }

                            }


                        } else {
                            if ($mostrarpromedio) {
                                $html[$y] .= "<tr><td style='text-align:left' colspan=" . ($rowspan1 + 1) . "><b>PROMEDIO GENERAL</b></td><td>" . $promediocortadoparcial[0] . ',' . $promediocortadoparcial[1] . "</td></tr>";

                            }

                        }

                    } else {

                        if ($detalleest[0]['monitoreo'] == 1) {

                            if ($detalleest[0]['idEstablecimiento'] == 12) {

                                if ($mostrarpromedio) {
                                    $html[$y] .= "<tr><td style='text-align:left' colspan=" . ($rowspan1 + 1) . "><b>PROMEDIO GENERAL</b></td><td>-</td><td>-</td><td>-</td></tr>";

                                }


                            } else {
                                if ($mostrarpromedio) {
                                    $html[$y] .= "<tr><td style='text-align:left' colspan=" . ($rowspan1 + 1) . "><b>PROMEDIO GENERAL</b></td><td>-</td></tr>";
                                }

                            }


                        } else {
                            if ($mostrarpromedio) {
                                $html[$y] .= "<tr><td style='text-align:left' colspan=" . ($rowspan1 + 1) . "><b>PROMEDIO GENERAL</b></td><td>-</td></tr>";

                            }
                        }

                    }


                    if ($detalleest[0]['monitoreo'] == 1 && $detalleest[0]['idEstablecimiento'] == 12 && $segmento == 1) {
                        $html[$y] .= $taller[$y];
                    } elseif ($detalleest[0]['monitoreo'] == 1 && $detalleest[0]['idEstablecimiento'] == 12 && $segmento == 2) {

                    } else {
                        $html[$y] .= $taller[$y];
                    }
                    if (empty($taller[$y]) && (!empty($combinada[$y]) || !empty($concepto[$y]))) {

                        if ($detalleest[0]['monitoreo'] == 1) {

                            if ($detalleest[0]['idEstablecimiento'] == 12 && $segmento == 1) {

                                $html[$y] .= "<tr><td colspan=" . ($rowspan1 + 4) . "><b>TALLERES Y ASIGNATURAS</b></td></tr>";

                            } elseif ($detalleest[0]['idEstablecimiento'] == 12 && $segmento == 2) {

                            } else {
                                $html[$y] .= "<tr><td colspan=" . ($rowspan1 + 2) . "><b>TALLERES Y ASIGNATURAS</b></td></tr>";
                            }


                        } else {
                            $html[$y] .= "<tr><td colspan=" . ($rowspan1 + 2) . "><b>TALLERES Y ASIGNATURAS</b></td></tr>";
                        }

                    }

                    if ($detalleest[0]['monitoreo'] == 1 && $detalleest[0]['idEstablecimiento'] == 12 && $segmento == 1) {
                        $html[$y] .= $combinada[$y];
                        $html[$y] .= $concepto[$y];
                    } elseif ($detalleest[0]['monitoreo'] == 1 && $detalleest[0]['idEstablecimiento'] == 12 && $segmento == 2) {

                    } else {
                        $html[$y] .= $combinada[$y];
                        $html[$y] .= $concepto[$y];
                    }

                }


                $html[$y] .= "</table>";


                $aux = 0;
                $total = 0;
                if ($diasin != 0 && $diastrabajados > 0) {
                    $valor = $diasin / $diastrabajados;
                    $aux = 1 - $valor;
                    $total = $aux * 100;
                }
                if (($diasin == 0 || $diasin == '') && $diastrabajados > 0) {
                    $valor = $diasin / $diastrabajados;
                    $aux = 1 - $valor;
                    $total = $aux * 100;
                }
                $html[$y] .= "<table align='center' style='margin-top:10px;'>
            <tr>
            <td style='width: 20%; text-align: center;'>Periodo/Asistencia</td>
            <td style='width: 20%; text-align: right;'>Nº de Días Trabajados</td>
            <td style='width: 20%; text-align: center;'>Nº Días de Inasistencia</td>
            <td style='width: 20%; text-align: center;'> % de Asistencia</td>
            <td style='width: 20%; text-align: center;'>Nº de Atrasos</td>
            </tr>

            <tr>
            <td style='width: 20%; height:2%; text-align: center;'>" . $nombresegmento . "</td>
            <td style='width: 20%; text-align: center;'>" . $diastrabajados . "</td>
            <td style='width: 20%; text-align: center;'>" . $diasin . "</td>
            <td style='width: 20%; text-align: center;'>" . intval($total) . "&#37;</td>
            <td style='width: 20%; text-align: center;'>" . $atraso . "</td>
            </tr>
            </table>

           <table>
            <tr>
            <td style='width:100%;text-align: left;'>Observaciones:</td>
            </tr>
            <tr>
            <td style='width:100%;height:4%;text-align:left;'>" . trim($observacion) . "</td>
            </tr>
            </table>";

                $valoresprofesor = unserialize($detalleest[0]['profesor']);
                if ($valoresprofesor[1] == 1) {
                    $tdnombreprofesor = "<p style='text-decoration:underline;margin-left:30px;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</p>";
                    $tdprofesor = "Profesor(a) Jefe.";
                } else {
                    $tdnombreprofesor = "";
                    $tdprofesor = "";
                }

                $valoresdirector = unserialize($detalleest[0]['director']);
                if ($valoresdirector[1] == 1) {
                    $tdnombredirector = "<p style='text-decoration:underline;'>" . $director['nombrescuenta'] . " " . $director['paternocuenta'] . " " . $director['maternocuenta'] . "</p>";
                    $tddirector = "Director(a).";
                } else {
                    $tdnombredirector = "";
                    $tddirector = "";
                }


                $valoresapoderado = unserialize($detalleest[0]['apoderado']);
                if ($valoresapoderado[1] == 1) {
                    $tdnombreapoderado = "<p style='text-decoration:underline;'> " . $apoderado . "</p>";
                    $tdapoderado = "Nombre y Firma de Apoderado.";
                } else {
                    $tdnombreapoderado = "";
                    $tdapoderado = "";
                }


                $html[$y] .= "<table align='center' style='margin-top:25px;' class='page_firmas'>
            <tr>
                <td style='width: 33%; text-align: center;border:none;'>" . $tdnombreprofesor . "</td>
                <td style='width: 33%; text-align: center;border:none;'>" . $tdnombreapoderado . "</td>
                <td style='width: 33%; text-align: center;border:none;'>" . $tdnombredirector . "</td>
            </tr>
            <tr>
                <td style='width: 33%; text-align:center;border:none;padding-top:35px'>" . $tdprofesor . "</td>
                <td style='width: 33%; text-align: center;border:none;padding-top:35px'>" . $tdapoderado . "</td>
                <td style='width: 33%; text-align:center;border:none;padding-top:35px'>" . $tddirector . "</td>
            </tr>
            <tr>
                <td colspan='3' style='text-align:center;border:none;padding-top:15px'>" . $fecha_final . ".</td>
            </tr>
            </table>";

            }


            if ($html != '') {

                require('fpdf/html2pdf.class.php');
                try {
                    //Orientación / formato del pdf y el idioma.
                    $pdf = new HTML2PDF('P', 'LETTER', 'es', array(10, 10, 10, 10) /*márgenes*/); //los márgenes también pueden definirse en <page> ver documentación

                    //inicio ciclo

                    for ($j = 0; $j < count($html); $j++) {
                        $pdf->WriteHTML('<page><html>
        <head>
            <style>' . $style . '</style>
        </head>
        <body> <page_footer>
        <table class="page_footer">
            <tr>
            <td style="width: 40%; text-align: left;border:none;"></td>
                <td style="width: 60%; text-align: right;border:none;font-size:8px">

                </td>
            </tr>
        </table>
    </page_footer>' . $html[$j] . '</body></html></page>');
                    }

                    //fin ciclo


                    if (preg_match("/MSIE/i", $_SERVER["HTTP_USER_AGENT"])) {
                        header("Content-type: application/PDF");
                    } else {
                        header("Content-type: application/PDF");
                        header("Content-Type: application/pdf");
                    }

                    $pdf->Output('Planificacion.pdf', I);
                } catch (HTML2PDF_exception $e) {
                    //echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, intente nuevamente\");</script>";
                    //echo "<script>parent.$.fancybox.close();</script>";
                    echo $e;
                }
            }


        }//fin Paso

    }

    public function informenotascursoperiodoAction()
    {
        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();


        $cargo = new Zend_Session_Namespace('cargo');
        $rol = $cargo->cargo;


        $seg = $this->_getParam('s', 0);


        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $modelcurso = new Application_Model_DbTable_Cursos();
        $modelnotas = new Application_Model_DbTable_Notas();
        $modelasignatura = new Application_Model_DbTable_Asignaturascursos();

        //fecha actual

        $date = new DateTime;
        $fechain = $date->format('Y-m-d');
        $cortado = explode("-", $fechain);
        $dias = array("Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado");
        $meses = array("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre");

        $fecha_final = $dias[date('w', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]))] . " " . $cortado[2] . " de " . $meses[date('n', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0])) - 1] . " del " . date('Y', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]));


        // se ingresan por asigntaura
        $usuario = new Zend_Session_Namespace('id');
        $user = $usuario->id;

        $idcursoaux = $this->_getParam('id', 0);

        //Validamos si el curso pertece a la jefatura del usuario
        $auxiliar = $modelcurso->listarcursoiddocenteactuals($user, $idperiodo, 1, $idcursoaux);

        if ($auxiliar && ($auxiliar[0]['idCursos'] == $idcursoaux) || $rol != 2) {
            //Asignaturas que pertencen a un curso de jefatura del usuario
            $id = $this->_getParam('id', 0);
            $tipos = array('1', '3');
            $datoscurso = $modelcurso->listarcursoid($id, $idperiodo);
            //Obtenemos las Asignaturas de Acuerdo al Horario que posee el Docente en el curso
            //$datosasignaturas = $modelcurso->getasignaturashorario($id_curso, $idperiodo, $user);
            $datosasignaturas = $modelasignatura->listarporcurso($id, 1, $tipos, $idperiodo);
            $listaalumnos = $modelnotas->listaralumnoscurso($id, $idperiodo);
            $listanotas = $modelnotas->listarnotascursoperiodo($id, $idperiodo, array($seg));

            $datostallersem = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array($seg));

            $datostalleranual = $modelasignatura->gettalleranual($id, $idperiodo, array(1), 1);
            $datosasignaturascombinada = $modelasignatura->getcombinada($id, $idperiodo);
            $largoalumnos = count($listaalumnos);

            $largocombinada = count($datosasignaturascombinada);
            $m = 0;

            $datostaller = array_merge($datostallersem, $datostalleranual);
            $largotaller = count($datostaller);
        } else {
            //Asignaturas que pertencen a un curso que no es jefatura
            $cursomodel = new Application_Model_DbTable_Detallecursocuenta();
            $id = $this->_getParam('ids', 0);
            $ids = $this->_getParam('id', 0);

            $datosasignaturas = $modelcurso->getasignaturashorario($id, $idperiodo, $user);

            $datoscurso = $modelcurso->listarcursoid($id, $idperiodo);
            $listaalumnos = $modelnotas->listaralumnoscurso($id, $idperiodo);
            $listanotas = $modelnotas->listarnotascursoperiodo($id, $idperiodo, array($seg));
            $datostallersem = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array($seg));

            $datostalleranual = $modelasignatura->gettalleranual($id, $idperiodo, array(1), 1);
            $datosasignaturascombinada = $modelasignatura->getcombinada($id, $idperiodo);
            $largoalumnos = count($listaalumnos);

            $largocombinada = count($datosasignaturascombinada);
            $m = 0;

            $datostaller = array_merge($datostallersem, $datostalleranual);
            $largotaller = count($datostaller);
        }


        //Configuracion de Taller Buscamos si existen configuraciones por alumnos

        $modelotallerdetalle = new Application_Model_DbTable_Asignaturascursos();
        //Obtiene los Talleres que son Semestrales Tiempo=2.
        $datostalleres = $modelasignatura->gettaller($id, $idperiodo, array(2), 2, array($seg));
        $promediotalleralumnos = array();


        if ($datostalleres) {

            for ($j = 0; $j < $largoalumnos; $j++) {

                for ($i = 0; $i < count($datostalleres); $i++) {
                    $detalletaller = $modelotallerdetalle->gettallersegmento($datostalleres[$i]['idConfiguracionTaller'], $seg, $listaalumnos[$j]['idAlumnos']);

                    if ($detalletaller) {
                        $datosalumnostaller = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, $seg, $id, $detalletaller[0]['idAsignatura']);

                        if ($datosalumnostaller) {
                            for ($k = 0; $k < count($datosalumnostaller); $k++) {


                                if ($datostalleres[$i]['idAsignatura'] == $datosalumnostaller[$k]['idAsignatura']) {
                                    if ($datosalumnostaller[$k]['coef'] == 2) {
                                        if ($datosalumnostaller[$k]['nota'] > 0) {
                                            $promediotalleralumnos[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                            $promediotalleralumnos[$j][$i][] = $datosalumnostaller[$k]['nota'];

                                        } else {
                                            $promediotalleralumnos[$j][$i][] = 0;
                                            $promediotalleralumnos[$j][$i][] = 0;
                                        }

                                    } else {
                                        if ($datosalumnostaller[$k]['nota'] > 0) {
                                            $promediotalleralumnos[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                        } else {
                                            $promediotalleralumnos[$j][$i][] = 0;
                                        }

                                    }


                                }


                            }
                        }
                        if (!empty($promediotalleralumnos[$j][$i])) {
                            $promsetalumnos = array_diff($promediotalleralumnos[$j][$i], array('0'));
                        } else {
                            $promsetalumnos = 0;
                        }

                        if (is_array($promsetalumnos)) {
                            if (count($promsetalumnos) > 0) {

                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    $promtalleralumnos[$j][$i]['nota'] = round(array_sum($promsetalumnos) / count($promsetalumnos));

                                } else {
                                    $promtalleralumnos[$j][$i]['nota'] = intval(array_sum($promsetalumnos) / count($promsetalumnos));
                                }
                            } else {
                                $promtalleralumnos[$j][$i]['nota'] = 0;
                            }
                        } else {
                            $promtalleralumnos[$j][$i]['nota'] = 0;
                        }


                        $promtalleralumnos[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                        $promtalleralumnos[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                        $promtalleralumnos[$j][$i]['coef'] = 1;
                        $promtalleralumnos[$j][$i]['tiempo'] = intval($seg);
                        $promtalleralumnos[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                        $promtalleralumnos[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];

                    } else {
                        $promtalleralumnos[$j][$i]['nota'] = 0;
                        $promtalleralumnos[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                        $promtalleralumnos[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                        $promtalleralumnos[$j][$i]['coef'] = 1;
                        $promtalleralumnos[$j][$i]['tiempo'] = intval($seg);
                        $promtalleralumnos[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                        $promtalleralumnos[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];
                    }

                }


                for ($l = 0; $l < count($promtalleralumnos[$j]); $l++) {

                    $datosdestino = $modelotallerdetalle->getdestino($promtalleralumnos[$j][$l]["idAsignatura"]);
                    if ($datosdestino[0]['tipoAsignatura'] != 4) {
                        $listapromediostaller[$j][] = $promtalleralumnos[$j][$l];
                    } else {
                        $listapromediostallercom[$j][] = $promtalleralumnos[$j][$l];
                    }


                }

            }
        }


        if ($largocombinada > 0) {
            for ($i = 0; $i < $largocombinada; $i++) {
                $listaasignatura[$i] = unserialize($datosasignaturascombinada[$i]['asignaturas']);
                for ($h = 0; $h < count($listaasignatura[$i]); $h++) {
                    $datocombinada = $modelasignatura->getnombre($listaasignatura[$i][$h]);
                    $validacom[$i][$h] = $datosasignaturascombinada[$i]['idAsignatura'];
                    for ($j = 0; $j < $largoalumnos; $j++) {
                        $datosalumnoscom = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, $seg, $id, $datocombinada[0]['idAsignatura']);
                        if ($listapromediostallercom) {
                            if ($datocombinada[0]['idAsignatura'] == $listapromediostallercom[$j][$h]['idAsignatura']) {
                                $datosalumnoscom[] = $listapromediostallercom[$j][$h];
                            }

                        }


                        for ($k = 0; $k < count($datosalumnoscom); $k++) {
                            if ($datocombinada[0]['idAsignatura'] == $datosalumnoscom[$k]['idAsignatura']) {
                                if ($datosalumnoscom[$k]['coef'] == 2) {
                                    if ($datosalumnoscom[$k]['nota'] > 0) {
                                        $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];
                                        $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];

                                    } else {
                                        $promediocom[$j][$m][] = 0;
                                        $promediocom[$j][$m][] = 0;
                                    }

                                } else {


                                    if ($datosalumnoscom[$k]['nota'] == 0 || empty($datosalumnoscom[$k]['nota']) || $datosalumnoscom[$k]['nota'] == NULL || $datosalumnoscom[$k]['nota'] == '') {
                                        if (!empty($datosalumnoscom[$k]["forma"])) {
                                            if ($datosalumnoscom[$k]['nota'] == 0) {
                                                $promediocom[$j][$m][] = 0;
                                            }

                                        } else {
                                            $promediocom[$j][$m][] = 0;
                                        }


                                    } else {
                                        if (!empty($datosalumnoscom[$k]["forma"]) && $datosalumnoscom[$k]["forma"] == 2) {

                                            $promtalleraux = $datosalumnoscom[$k]['nota'];
                                            $porcentajetaller = $datosalumnoscom[$k]["porcentaje"];


                                        } elseif (!empty($datosalumnoscom[$k]["forma"]) && $datosalumnoscom[$k]["forma"] == 1) {
                                            $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];
                                            $promtalleraux = array();
                                            $porcentajetaller = array();
                                        } else {
                                            $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];
                                            $promtalleraux = array();
                                            $porcentajetaller = array();
                                        }


                                    }

                                }//fin else


                            }

                        }


                        if (!empty($promediocom[$j][$m])) {
                            $promset = array_diff($promediocom[$j][$m], array('0'));
                        } else {
                            $promset = 0;
                        }

                        if (is_array($promset)) {
                            if (count($promset) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    if ($porcentajetaller) {
                                        $totalporcentaje = 100;
                                        $porcentajeasig = $totalporcentaje - $porcentajetaller;
                                        $promedioauxalum = array_sum($promset) / count($promset);
                                        $promcom[$j][$m]['nota'] = round(($promedioauxalum * ($porcentajeasig / 100)) + ($promtalleraux * ($porcentajetaller / 100)));

                                    } else {
                                        $promcom[$j][$m]['nota'] = round(array_sum($promset) / count($promset));
                                    }

                                } else {
                                    if ($porcentajetaller) {
                                        $totalporcentaje = 100;
                                        $porcentajeasig = $totalporcentaje - $porcentajetaller;
                                        $promedioauxalum = array_sum($promset) / count($promset);
                                        $promcom[$j][$m]['nota'] = round(($promedioauxalum * ($porcentajeasig / 100)) + ($promtalleraux * ($porcentajetaller / 100)));


                                    } else {
                                        $promcom[$j][$m]['nota'] = intval(array_sum($promset) / count($promset));
                                    }
                                }
                            } else {
                                $promcom[$j][$m]['nota'] = 0;
                            }

                        } else {

                            $promcom[$j][$m]['nota'] = 0;
                        }
                        $promcom[$j][$m]['idAsignatura'] = $datosasignaturascombinada[$i]['idAsignatura'];
                        $promcom[$j][$m]['coef'] = 1;


                    }
                    $m++;
                }

            }
        }


//Talleres para curso Completp

        $promediotaller = array();
        if ($largotaller > 0) {

            for ($i = 0; $i < $largotaller; $i++) {
                if (!empty($datostaller[$i]['idConfiguracionTaller'])) {
                    $validataller[$i] = $datostaller[$i]['idAsignaturaTaller'];
                    for ($j = 0; $j < $largoalumnos; $j++) {
                        $datosalumnostaller = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, $seg, $id, $datostaller[$i]['idAsignatura']);


                        for ($k = 0; $k < count($datosalumnostaller); $k++) {
                            if ($datostaller[$i]['idAsignatura'] == $datosalumnostaller[$k]['idAsignatura']) {
                                if ($datosalumnostaller[$k]['coef'] == 2) {
                                    if ($datosalumnostaller[$k]['nota'] > 0) {
                                        $promediotaller[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                        $promediotaller[$j][$i][] = $datosalumnostaller[$k]['nota'];

                                    } else {
                                        $promediotaller[$j][$i][] = 0;
                                        $promediotaller[$j][$i][] = 0;
                                    }

                                } else {
                                    if ($datosalumnostaller[$k]['nota'] > 0) {
                                        $promediotaller[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                    } else {
                                        $promediotaller[$j][$i][] = 0;
                                    }

                                }


                            }

                        }
                        if (!empty($promediotaller[$j][$i])) {
                            $promset = array_diff($promediotaller[$j][$i], array('0'));
                        } else {
                            $promset = 0;
                        }

                        if (is_array($promset)) {
                            if (count($promset) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    $promtaller[$j][$i]['nota'] = round(array_sum($promset) / count($promset));

                                } else {
                                    $promtaller[$j][$i]['nota'] = intval(array_sum($promset) / count($promset));
                                }
                            } else {
                                $promtaller[$j][$i]['nota'] = 0;
                            }

                        } else {
                            $promtaller[$j][$i]['nota'] = 0;
                        }


                        $promtaller[$j][$i]['idAsignatura'] = $datostaller[$i]['idAsignaturaTaller'];
                        $promtaller[$j][$i]['coef'] = 1;
                        $promtaller[$j][$i]['tiempo'] = intval($seg);
                        $promtaller[$j][$i]['forma'] = $datostaller[$i]['forma'];
                        $promtaller[$j][$i]['porcentaje'] = $datostaller[$i]['porcentaje'];


                    }

                }


            }
        }


        if ($largoalumnos == 0 || count($listanotas) == 0) {
            echo "<script type=\"text/javascript\">alert(\"Sin Notas\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            exit;

        }

        for ($i = 0; $i < $largoalumnos; $i++) {

            $valores = $modelnotas->listarnotasporalumnoperiodo($listaalumnos[$i]['idAlumnos'], $idperiodo, $seg, $id);
            if ($valores != '' || !empty($valores)) {
                $listaalumnos[$i]['listanotas'] = $valores;
            } else {
                $listaalumnos[$i]['listanotas'] = 0;

            }
            for ($j = 0; $j < count($promtaller[$i]); $j++) {
                $listaalumnos[$i]['listanotas'][] = $promtaller[$i][$j];
            }


            for ($j = 0; $j < count($promcom[$i]); $j++) {
                $listaalumnos[$i]['listanotas'][] = $promcom[$i][$j];
            }

            if ($listapromediostaller[$i]) {
                for ($j = 0; $j < count($listapromediostaller[$i]); $j++) {
                    $listaalumnos[$i]['listanotas'][] = $listapromediostaller[$i][$j];
                }
            }


        }


        switch ($seg) {
            case '1':
                $nombreseg = 'I Semestre';
                break;

            case '2':
                $nombreseg = 'II Semestre';
                break;

            case '3':
                $nombreseg = 'I Trimestre';
                break;

            case '4':
                $nombreseg = 'II Trimestre';
                break;

            case '5':
                $nombreseg = 'III Trimestre';
                break;


        }

        $logo = getcwd();
        $logo .= "/application/documentos/logos/" . $datoscurso[0]['extension'];

        // variables para encabezado
        $titulo = strtoupper($datoscurso[0]['nombreEstablecimiento']) . '<br>' . strtoupper($nombreseg);


        if (file_exists($logo)) {
            $encabezado = '<img style="position:absolute;top:10px;left:30px" src="' . $logo . '" /><h4 style="position:absolute;top:50px;text-align:center">' . $titulo . '</h4>';

        } else {
            $encabezado = '<h4 style="position:absolute;top:50px;text-align:center">' . $titulo . '</h4>';

        }


        if (!empty($datosasignaturas)) {
            $largoasignatura = count($datosasignaturas);
            for ($i = 0; $i < $largoasignatura; $i++) {

                $datoscuenta[$i] = $modelnotas->listarcantidadnotasasignatura($id, $idperiodo, $seg, $datosasignaturas[$i]['idAsignatura']);


                if (empty($datoscuenta[$i]) && $datosasignaturas[$i]['tipoAsignatura'] == 1) {
                    $datosasig[$i] = 0;
                } else {
                    $largonotas = count($datoscuenta[$i]);
                    $datosasig[$i] = 0;
                    for ($j = 0; $j < count($validataller); $j++) {
                        if ($datosasignaturas[$i]['idAsignatura'] == $validataller[$j]) {
                            $datosasig[$i] += 1;
                        }
                    }
                    for ($j = 0; $j < count($validacom); $j++) {
                        for ($k = 0; $k < count($validacom[$j]); $k++) {
                            if ($datosasignaturas[$i]['idAsignatura'] == $validacom[$j][$k]) {

                                $datosasig[$i] += 1;
                            }
                        }

                    }

                    for ($j = 0; $j < count($datostalleres); $j++) {
                        if ($datosasignaturas[$i]['idAsignatura'] == $datostalleres[$j]['idAsignaturaTaller']) {
                            $datosasig[$i] += 1;
                        }
                    }

                    for ($j = 0; $j < $largonotas; $j++) {

                        if ($datoscuenta[$i][$j]['coef'] == 2) {
                            $datosasig[$i] += 2;
                        } else {
                            $datosasig[$i] += 1;
                        }

                    }


                }


            }
        } else {
            echo "<script type=\"text/javascript\">alert(\"El Curso no Posee Asignaturas en el periodo\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            exit;

        }


        //Estilo pdf
        $style = "body{
font:12px ,Arial, Tahoma, Verdana, Helvetica, sans-serif;

color:#000;
}
img{
  width:60px;
  height:70px;
}


table{
font-size:10px;
width:100%;
height:auto;
margin:10px 0 10px 0;
border-collapse:collapse;
text-align:center;
text-justify:inter-word;
color:#000000;
}

table td,th{
border:1px solid black;
}

table th{
padding:1px;
background-color: #ccc;
}
";
        $pag = 0;
        $cuentapag = 0;
        $max = 23;


        $html[$pag] = $encabezado;
        $html[$pag] .= "<div style='position:absolute;top:75px;left:25px;'><br> Curso: <b>" . $datoscurso[0]['nombreGrado'] . " " . $datoscurso[0]['letra'] . "</b><br> Fecha : <b>" . $fecha_final . "</b></div>";

        $html[$pag] .= '<table align="left" style="margin-left:20px"><tr><th>Nº</th><th>Alumno</th>';


        for ($i = 0; $i < $largoasignatura; $i++) {


            //obtenemos cuantas notas existen en cada asignatura
            $row = $datosasig[$i];
            $cuentapag = $cuentapag + $row;

            // si la cantidad de notas supera las 28 sumamos al contador de pag
            if ($cuentapag > $max) {
                $pag++;
                if ($pag == 1) {
                    $max = 43;
                }
                if ($pag == 2) {
                    $max = 63;
                }
                if ($pag == 3) {
                    $max = 83;
                }
                if ($pag == 4) {
                    $max = 103;
                }
                if ($pag == 5) {
                    $max = 123;
                }
                $html[$pag] = '<table align="left" style="margin-left:20px"><tr><th>Nº</th><th>Alumno</th>';

            }


            //si row es distinto de cero suma uno a row para crear el promedio
            if ($row != 0) {
                $row = $row + 1;
                $html[$pag] .= '<th style="width:25px;text-align:left;word-break: break-all;" colspan=' . $row . '>' . $datosasignaturas[$i]["nombreAsignatura"] . '</th>';
            } else {


                $html[$pag] .= '<th style="width:25px;text-align:left;word-break: break-all;">' . $datosasignaturas[$i]["nombreAsignatura"] . '</th>';

            }
        }

        //$html .= "<th>PROM</th><th>Dias</th><th>Dias</th><th>%</th>";
        $html[$pag] .= '<th>PROM</th>';

        $pag = 0;
        $cuentapag = 0;
        $max = 23;
        $cuentapag2 = array();
        $contadorpag = 0;


        $html[$pag] .= '</tr><tr><th colspan="2">Nº Notas/Prom</th>';
        for ($i = 0; $i < $largoasignatura; $i++) {
            $row = $datosasig[$i];
            $cuentapag = $cuentapag + $row;

            // si la cantidad de notas supera las notas que ingresan en una hoja
            if ($cuentapag > $max) {
                $html[$pag] .= '</tr>';
                $pag++;
                if ($pag == 1) {
                    $max = 43;
                }
                if ($pag == 2) {
                    $max = 63;
                }
                if ($pag == 3) {
                    $max = 83;
                }
                if ($pag == 4) {
                    $max = 103;
                }
                if ($pag == 5) {
                    $max = 123;
                }
                $html[$pag] .= '</tr><tr><th></th><th></th>';

            }

            if ($row != 0) {

                for ($j = 1; $j <= $row; $j++) {

                    $html[$pag] .= '<th>N' . $j . '</th>';
                    $contadorpag++;
                    $cuentapag2[$pag] = $contadorpag;
                }
                $html[$pag] .= '<th>Prom</th>';
                $contadorpag++;
                $cuentapag2[$pag] = $contadorpag;
            } else {
                $html[$pag] .= '<th>Sin Notas</th>';
                $contadorpag++;
                $cuentapag2[$pag] = $contadorpag;

            }
        }

        switch ($seg) {
            case '1':
                $html[$pag] .= '<th>I SEM</th>';
                $cuentapag2[$pag] += 1;
                break;

            case '2':
                $html[$pag] .= '<th>I SEM</th>';
                $cuentapag2[$pag] += 1;
                break;

            case '3':
                $html[$pag] .= '<th>I TRIM</th>';
                $cuentapag2[$pag] += 1;
                break;

            case '4':
                $html[$pag] .= '<th>II TRIM</th>';
                $cuentapag2[$pag] += 1;
                break;

            case '5':
                $html[$pag] .= '<th>III TRIM</th>';
                $cuentapag2[$pag] += 1;
                break;


        }


        $html[$pag] .= '</tr>';


        if (!empty($listaalumnos)) {
            $r = 0;


            for ($i = 0; $i < count($listaalumnos); $i++) {
                $pag = 0;
                $cuentapag = 0;
                $max = 23;
                $html[$pag] .= '<tr><td>' . ($i + 1) . '</td><td>' . $listaalumnos[$i]["apaterno"] . ' ' . $listaalumnos[$i]["amaterno"] . ' ' . $listaalumnos[$i]["nombres"] . '</td>';
                $r = 0;
                for ($j = 0; $j < $largoasignatura; $j++) {

                    $promtalleraux = array();
                    $porcentajetaller = array();
                    $sumataller = 0;
                    //for ($j = 0; $j < 1; $j++) {
                    $row = $datosasig[$j];
                    $cuentapag = $cuentapag + $row;

                    if ($cuentapag > $max) {
                        $html[$pag] .= '</tr>';
                        $pag++;
                        if ($pag == 1) {
                            $max = 43;
                        }
                        if ($pag == 2) {
                            $max = 63;
                        }
                        if ($pag == 3) {
                            $max = 83;
                        }
                        if ($pag == 4) {
                            $max = 103;
                        }
                        if ($pag == 5) {
                            $max = 123;
                        }

                        $html[$pag] .= '<tr><td>' . ($i + 1) . '</td><td style="text-align: left">' . $listaalumnos[$i]["apaterno"] . ' ' . $listaalumnos[$i]["amaterno"] . ' ' . $listaalumnos[$i]["nombres"] . '</td>';

                    }

                    $promedio = 0;
                    $contador = 0;
                    $contadorpromedio = 0;
                    if ($row != 0) {
                        $largolistanota = count($listaalumnos[$i]['listanotas']);
                        for ($z = 0; $z < $largolistanota; $z++) {
                            //$contadorauxtaller = false;
                            $contadoraux = 0;

                            if ($datosasignaturas[$j]['idAsignatura'] == $listaalumnos[$i]['listanotas'][$z]['idAsignatura']) {
                                $contador = $contador + 1;

                                //si la nota es coeficiente 2
                                if ($listaalumnos[$i]['listanotas'][$z]['coef'] == '2') {
                                    $contador = $contador + 1;
                                    if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == NULL || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {

                                        $html[$pag] .= '<td> - </td>';
                                        $html[$pag] .= '<td> - </td>';
                                        $notamatriz[$r][] = 0;
                                        $r++;
                                        $notamatriz[$r][] = 0;
                                        $r++;

                                    } else {
                                        $html[$pag] .= '<td>' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                        $html[$pag] .= '<td>' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                        $promedio = $promedio + ($listaalumnos[$i]['listanotas'][$z]['nota'] + $listaalumnos[$i]['listanotas'][$z]['nota']);
                                        $contadorpromedio = $contadorpromedio + 2;
                                        $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                        $r++;
                                        $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                        $r++;


                                    }


                                } else {


                                    if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == NULL || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {
                                        if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"])) {
                                            if ($listaalumnos[$i]["listanotas"][$z]["nota"] == 0) {
                                                $html[$pag] .= '<td bgcolor="#B2B0AF">-</td>';
                                                $notamatriz[$r][] = 0;
                                            }

                                        } else {
                                            $html[$pag] .= '<td> - </td>';
                                            $notamatriz[$r][] = 0;
                                        }


                                    } else {
                                        if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"]) && $listaalumnos[$i]["listanotas"][$z]["forma"] == 2) {


                                            $contadorauxtaller = true;
                                            $promtalleraux[] = $listaalumnos[$i]['listanotas'][$z]['nota'];
                                            $porcentajetaller[] = $listaalumnos[$i]["listanotas"][$z]["porcentaje"];
                                            $html[$pag] .= '<td bgcolor="#B2B0AF">' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                            $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);


                                        } elseif (!empty($listaalumnos[$i]["listanotas"][$z]["forma"]) && $listaalumnos[$i]["listanotas"][$z]["forma"] == 1) {
                                            $html[$pag] .= '<td bgcolor="#B2B0AF">' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                            $promedio = $promedio + $listaalumnos[$i]['listanotas'][$z]['nota'];
                                            $contadorpromedio = $contadorpromedio + 1;
                                            $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                        } else {
                                            $html[$pag] .= '<td>' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                            $promedio = $promedio + $listaalumnos[$i]['listanotas'][$z]['nota'];
                                            $contadorpromedio = $contadorpromedio + 1;
                                            $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                        }


                                    }
                                    $r++;

                                }
                                //Aumentamos el contador para notas matriz


                                //Promedios por notas
                                if ($contador == $row) {


                                    if ($contadorpromedio != 0) {

                                        $promedioaux = 0;
                                        //SI el Taller es por porcentaje
                                        if ($contadorauxtaller) {
                                            $totalporcentaje = 100;
                                            if (count($promtalleraux) > 1) {
                                                for ($t = 0; $t < count($promtalleraux); $t++) {
                                                    $totalporcentaje = $totalporcentaje - $porcentajetaller[$t];
                                                    $sumataller += $promtalleraux[$t] * ($porcentajetaller[$t] / 100);
                                                }

                                            } else {
                                                $totalporcentaje = 100 - $porcentajetaller[0];
                                                $sumataller = $promtalleraux[0] * ($porcentajetaller[0] / 100);

                                            }


                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioaux = round($promedio / $contadorpromedio);
                                                $promedioaux = ($promedioaux * ($totalporcentaje / 100)) + $sumataller;
                                                $promedioaux = round($promedioaux);
                                                $promfinal[$i][] = $promedioaux;
                                                $notamatriz[$r][] = $promedioaux;

                                            } else {
                                                $promedioaux = round($promedio / $contadorpromedio);
                                                $promedioaux = ($promedioaux * ($totalporcentaje / 100)) + $sumataller;
                                                $promedioaux = intval($promedioaux);
                                                $promfinal[$i][] = $promedioaux;
                                                $notamatriz[$r][] = $promedioaux;
                                            }

                                        } else {

                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioaux = round($promedio / $contadorpromedio);
                                                $promfinal[$i][] = $promedioaux;
                                                $notamatriz[$r][] = $promedioaux;

                                            } else {
                                                $promedioaux = intval($promedio / $contadorpromedio);
                                                $promfinal[$i][] = $promedioaux;
                                                $notamatriz[$r][] = $promedioaux;
                                            }
                                        }


                                        $html[$pag] .= '<td>' . $promedioaux . '</td>';


                                    } else {
                                        if ($contador == $contadoraux) {


                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima

                                                $promedioaux = $promtalleraux * ($porcentajetaller / 100);
                                                $promedioaux = round($promedioaux);
                                                $promfinal[$i][] = $promedioaux;
                                                $notamatriz[$r][] = $promedioaux;

                                            } else {
                                                $promedioaux = $promtalleraux * ($porcentajetaller / 100);
                                                $promedioaux = intval($promedioaux);
                                                $promfinal[$i][] = $promedioaux;
                                                $notamatriz[$r][] = $promedioaux;
                                            }
                                            $html[$pag] .= '<td>' . $promedioaux . '</td>';

                                        } else {

                                            $promfinal[$i][] = 0;
                                            $notamatriz[$r][] = 0;
                                            $html[$pag] .= '<td>-</td>';
                                        }


                                    }
                                    $r++;


                                }// fin promedio por notas

                            }


                        }// fin for


                    } else {
                        $html[$pag] .= '<td></td>';
                        $notamatriz[$r][] = 0;
                        $r++;


                    } //fin if row


                } //fin for


                if ($promfinal[$i] != '' || $promfinal[$i] != null) {

                    if ($datoscurso[0]['aproxPeriodo'] == 1) {//Aproxima
                        $promsetfinal = array_diff($promfinal[$i], array('0'));
                        $html[$pag] .= '<td>' . round(array_sum($promsetfinal) / count($promsetfinal)) . '</td>';
                        $notamatriz[$r][] = round(array_sum($promsetfinal) / count($promsetfinal));

                    } else {
                        $promsetfinal = array_diff($promfinal[$i], array('0'));
                        $html[$pag] .= '<td>' . intval(array_sum($promsetfinal) / count($promsetfinal)) . '</td>';
                        //$html[$pag] .= '<td>' . intval(array_sum($promfinal[$i]) / count($promfinal[$i])) . '</td>';
                        $notamatriz[$r][] = intval(array_sum($promsetfinal) / count($promsetfinal));

                    }


                } else {
                    $html[$pag] .= '<td>-</td>';
                    $notamatriz[$r][] = 0;
                }


                $html[$pag] .= '</tr>';


            }


            //Estadistica de notas
            for ($i = 0; $i < count($cuentapag2); $i++) {
                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Promedio Generales</td>';
                } else {
                    $aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Promedio Generales</td>';
                }


                for ($y = $aux; $y < $cuentapag2[$i]; $y++) {
                    $notamatrizset = array_diff($notamatriz[$y], array('0'));
                    if (array_sum($notamatrizset) != 0) {
                        $html[$i] .= '<td>' . round(array_sum($notamatrizset) / count($notamatrizset)) . '</td>';
                    } else {
                        $html[$i] .= '<td>-</td>';
                    }


                }


                $html[$i] .= '</tr>';


                //Minimos
                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Mínimo</td>';
                } else {
                    $aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Mínimo</td>';
                }

                for ($y = $aux; $y < $cuentapag2[$i]; $y++) {

                    $valormin = array_sum($notamatriz[$y]);
                    if ($valormin != 0) {
                        $html[$i] .= '<td>' . min(array_diff($notamatriz[$y], array(0))) . '</td>';
                    } else {
                        $html[$i] .= '<td>-</td>';
                    }


                }

                $html[$i] .= '</tr>';

                //Maximos
                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Máximo</td>';
                } else {
                    $aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Máximo</td>';
                }


                for ($y = $aux; $y < $cuentapag2[$i]; $y++) {
                    $valormax = array_sum($notamatriz[$y]);
                    if ($valormax != 0) {
                        $html[$i] .= '<td>' . max(array_diff($notamatriz[$y], array(0))) . '</td>';
                    } else {
                        $html[$i] .= '<td>-</td>';
                    }
                }

                $html[$i] .= '</tr>';

                //Adecuado

                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Adecuado</td>';
                } else {
                    $aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Adecuado</td>';
                }


                for ($y = $aux; $y < $cuentapag2[$i]; $y++) {
                    $contadorinicial = 0;
                    $largomatriz = count($notamatriz[$y]);
                    for ($v = 0; $v < $largomatriz; $v++) {
                        if ($notamatriz[$y][$v] > 59 && $notamatriz[$y][$v] <= 70) {
                            $contadorinicial = $contadorinicial + 1;

                        }
                    }
                    $totaladecuado[$y] = $contadorinicial;

                    $html[$i] .= '<td>' . $contadorinicial . '</td>';

                }
                $html[$i] .= '</tr>';

                //Elemntal
                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Elemental</td>';
                } else {
                    $aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Elemental</td>';
                }

                for ($y = $aux; $y < $cuentapag2[$i]; $y++) {
                    $contadorinicial = 0;
                    $largomatriz = count($notamatriz[$y]);
                    for ($v = 0; $v < $largomatriz; $v++) {
                        if ($notamatriz[$y][$v] > 39 && $notamatriz[$y][$v] < 60) {
                            $contadorinicial = $contadorinicial + 1;

                        }
                    }

                    $totalelemental[$y] = $contadorinicial;
                    $html[$i] .= '<td>' . $contadorinicial . '</td>';

                }

                $html[$i] .= "</tr>";


                //Insuficiente
                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Insuficiente</td>';
                } else {
                    $aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Insuficiente</td>';
                }


                for ($y = $aux; $y < $cuentapag2[$i]; $y++) {
                    $contadorinicial = 0;
                    $largomatriz = count($notamatriz[$y]);
                    for ($v = 0; $v < $largomatriz; $v++) {
                        if ($notamatriz[$y][$v] > 10 && $notamatriz[$y][$v] < 40) {
                            $contadorinicial = $contadorinicial + 1;

                        }
                    }

                    $totalinsuficiente[$y] = $contadorinicial;

                    $html[$i] .= '<td>' . $contadorinicial . '</td>';

                }

                $html[$i] .= "</tr>";


                //Totales
                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Total</td>';
                } else {
                    $aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Total</td>';
                }

                for ($y = $aux; $y < $cuentapag2[$i]; $y++) {
                    $total[$y] = ($totaladecuado[$y] + $totalelemental[$y] + $totalinsuficiente[$y]);

                    $html[$i] .= '<td>' . $total[$y] . '</td>';

                }

                $html[$i] .= "</tr>";


                //Porcentaje Adecuado

                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Adecuado</td>';
                } else {
                    $aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Adecuado</td>';
                }

                for ($y = $aux; $y < $cuentapag2[$i]; $y++) {

                    if ($total[$y] > 0) {
                        $porcentaje = ($totaladecuado[$y] / $total[$y]) * 100;
                    } else {
                        $porcentaje = 0;
                    }

                    $html[$i] .= '<td>' . round($porcentaje) . '%</td>';

                }

                $html[$i] .= "</tr>";

                //Porcentaje Elemental
                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Elemental</td>';
                } else {
                    $aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Elemental</td>';
                }

                for ($y = $aux; $y < $cuentapag2[$i]; $y++) {

                    if ($total[$y] > 0) {
                        $porcentaje = ($totalelemental[$y] / $total[$y]) * 100;
                    } else {
                        $porcentaje = 0;
                    }

                    $html[$i] .= '<td>' . round($porcentaje) . '%</td>';

                }

                $html[$i] .= "</tr>";

                //Porcentaje Suficiente

                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Insuficiente</td>';
                } else {
                    $aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Insuficiente</td>';
                }

                for ($y = $aux; $y < $cuentapag2[$i]; $y++) {

                    if ($total[$y] > 0) {
                        $porcentaje = ($totalinsuficiente[$y] / $total[$y]) * 100;
                    } else {
                        $porcentaje = 0;
                    }

                    $html[$i] .= '<td>' . round($porcentaje) . '%</td>';

                }

                $html[$i] .= "</tr>";


            }//Fin ciclo Paginas


        }


        if ($html != '') {

            require 'fpdf/html2pdf.class.php';
            try {
                $width_in_mm = 216;
                $height_in_mm = 330;
                //Orientación / formato del pdf y el idioma.
                $pdf = new HTML2PDF('L', array($width_in_mm, $height_in_mm), 'es', true, 'UTF-8', array(0, 0, 0, 0) /*márgenes*/); //los márgenes también pueden definirse en <page> ver documentación
                $pdf->pdf->SetDisplayMode('fullpage');
                for ($i = 0; $i < count($html); $i++) {

                    $pdf->WriteHTML('<page><html>
                        <head>
                            <style>' . $style . '</style>
                        </head>
                        <body>' . $html[$i] . '</table></body></html></page>');
                }

                if (preg_match("/MSIE/i", $_SERVER["HTTP_USER_AGENT"])) {
                    header("Content-type: application/PDF");
                } else {
                    header("Content-type: application/PDF");
                    header("Content-Type: application/pdf");
                }

                $pdf->Output('Planificacion.pdf', I);
            } catch (HTML2PDF_exception $e) {
                //echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, intente nuevamente\");</script>";
                //echo "<script>parent.$.fancybox.close();</script>";
                echo $e;
            }
        }


    }

    public function informenotascursoperiodopromedioAction()
    {
        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();

        $ingreson = new Zend_Session_Namespace('ingresonota');
        $ingresonota = $ingreson->ingresonota;

        $cargo = new Zend_Session_Namespace('cargo');
        $rol = $cargo->cargo;


        $seg = $this->_getParam('s', 0);


        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $modelcurso = new Application_Model_DbTable_Cursos();
        $modelnotas = new Application_Model_DbTable_Notas();
        $modelasignatura = new Application_Model_DbTable_Asignaturascursos();
        $modeldetalle = new Application_Model_DbTable_AlumnosDetalle();


        //fecha actual

        $date = new DateTime;
        $fechain = $date->format('Y-m-d');
        $cortado = explode("-", $fechain);
        $dias = array("Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado");
        $meses = array("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre");

        $fecha_final = $dias[date('w', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]))] . " " . $cortado[2] . " de " . $meses[date('n', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0])) - 1] . " del " . date('Y', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]));


        // se ingresan por asigntaura
        $usuario = new Zend_Session_Namespace('id');
        $user = $usuario->id;
        $idcursoaux = $this->_getParam('id', 0);

        //Validamos si el curso pertece a la jefatura del usuario
        $auxiliar = $modelcurso->listarcursoiddocenteactuals($user, $idperiodo, 1, $idcursoaux);

        if ($auxiliar && ($auxiliar[0]['idCursos'] == $idcursoaux) || $rol != 2) {
            //Asignaturas que pertencen a un curso de jefatura del usuario
            $id = $this->_getParam('id', 0);
            $tipos = array('1', '3');
            $datoscurso = $modelcurso->listarcursoid($id, $idperiodo);
            $datosasignaturas = $modelasignatura->listarporcurso($id, 1, $tipos, $idperiodo);
            $listaalumnos = $modelnotas->listaralumnoscurso($id, $idperiodo);
            $listanotas = $modelnotas->listarnotascursoperiodo($id, $idperiodo, array($seg));

            $datostallersem = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array($seg));

            $datostalleranual = $modelasignatura->gettalleranual($id, $idperiodo, array(1), 1);
            $datosasignaturascombinada = $modelasignatura->getcombinada($id, $idperiodo);
            $largoalumnos = count($listaalumnos);

            $largocombinada = count($datosasignaturascombinada);
            $m = 0;

            $datostaller = array_merge($datostallersem, $datostalleranual);
            $largotaller = count($datostaller);
        } else {
            //Asignaturas que pertencen a un curso que no es jefatura
            $cursomodel = new Application_Model_DbTable_Detallecursocuenta();
            $id = $this->_getParam('ids', 0);
            $ids = $this->_getParam('id', 0);

            $datosasignaturas = $modelcurso->getasignaturashorario($id, $idperiodo, $user);

            $datoscurso = $modelcurso->listarcursoid($id, $idperiodo);
            $listaalumnos = $modelnotas->listaralumnoscurso($id, $idperiodo);
            $listanotas = $modelnotas->listarnotascursoperiodo($id, $idperiodo, array($seg));
            $datostallersem = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array($seg));

            $datostalleranual = $modelasignatura->gettalleranual($id, $idperiodo, array(1), 1);
            $datosasignaturascombinada = $modelasignatura->getcombinada($id, $idperiodo);
            $largoalumnos = count($listaalumnos);

            $largocombinada = count($datosasignaturascombinada);
            $m = 0;

            $datostaller = array_merge($datostallersem, $datostalleranual);
            $largotaller = count($datostaller);
        }


        if ($datoscurso[0]['monitoreo'] == 1) {

            if ($datoscurso[0]['idEstablecimiento'] == 12) {
                $modeloequivalencia = new Application_Model_DbTable_Equivalencia();
                $lista_equivalencia = $modeloequivalencia->listarperiodo($datoscurso[0]['idEstablecimiento'], $idperiodo, $seg);
            }


        }


        //Configuracion de Taller Buscamos si existen configuraciones por alumnos

        $modelotallerdetalle = new Application_Model_DbTable_Asignaturascursos();
        //Obtiene los Talleres que son Semestrales Tiempo=2.
        $datostalleres = $modelasignatura->gettaller($id, $idperiodo, array(2), 2, array($seg));
        $promediotalleralumnos = array();


        if ($datostalleres) {

            for ($j = 0; $j < $largoalumnos; $j++) {

                for ($i = 0; $i < count($datostalleres); $i++) {
                    $detalletaller = $modelotallerdetalle->gettallersegmento($datostalleres[$i]['idConfiguracionTaller'], $seg, $listaalumnos[$j]['idAlumnos']);

                    if ($detalletaller) {
                        $datosalumnostaller = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, $seg, $id, $detalletaller[0]['idAsignatura']);

                        if ($datosalumnostaller) {
                            for ($k = 0; $k < count($datosalumnostaller); $k++) {


                                if ($datostalleres[$i]['idAsignatura'] == $datosalumnostaller[$k]['idAsignatura']) {
                                    if ($datosalumnostaller[$k]['coef'] == 2) {
                                        if ($datosalumnostaller[$k]['nota'] > 0) {
                                            $promediotalleralumnos[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                            $promediotalleralumnos[$j][$i][] = $datosalumnostaller[$k]['nota'];

                                        } else {
                                            $promediotalleralumnos[$j][$i][] = 0;
                                            $promediotalleralumnos[$j][$i][] = 0;
                                        }

                                    } else {
                                        if ($datosalumnostaller[$k]['nota'] > 0) {
                                            $promediotalleralumnos[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                        } else {
                                            $promediotalleralumnos[$j][$i][] = 0;
                                        }

                                    }


                                }


                            }
                        }
                        if (!empty($promediotalleralumnos[$j][$i])) {
                            $promsetalumnos = array_diff($promediotalleralumnos[$j][$i], array('0'));
                        } else {
                            $promsetalumnos = 0;
                        }

                        if (is_array($promsetalumnos)) {
                            if (count($promsetalumnos) > 0) {

                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    $promtalleralumnos[$j][$i]['nota'] = round(array_sum($promsetalumnos) / count($promsetalumnos));

                                } else {
                                    $promtalleralumnos[$j][$i]['nota'] = intval(array_sum($promsetalumnos) / count($promsetalumnos));
                                }
                            } else {
                                $promtalleralumnos[$j][$i]['nota'] = 0;
                            }
                        } else {
                            $promtalleralumnos[$j][$i]['nota'] = 0;
                        }


                        $promtalleralumnos[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                        $promtalleralumnos[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                        $promtalleralumnos[$j][$i]['coef'] = 1;
                        $promtalleralumnos[$j][$i]['tiempo'] = intval($seg);
                        $promtalleralumnos[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                        $promtalleralumnos[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];

                    } else {
                        $promtalleralumnos[$j][$i]['nota'] = 0;
                        $promtalleralumnos[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                        $promtalleralumnos[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                        $promtalleralumnos[$j][$i]['coef'] = 1;
                        $promtalleralumnos[$j][$i]['tiempo'] = intval($seg);
                        $promtalleralumnos[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                        $promtalleralumnos[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];
                    }

                }


                for ($l = 0; $l < count($promtalleralumnos[$j]); $l++) {

                    $datosdestino = $modelotallerdetalle->getdestino($promtalleralumnos[$j][$l]["idAsignatura"]);
                    if ($datosdestino[0]['tipoAsignatura'] != 4) {
                        $listapromediostaller[$j][] = $promtalleralumnos[$j][$l];
                    } else {
                        $listapromediostallercom[$j][] = $promtalleralumnos[$j][$l];
                    }


                }

            }
        }


        if ($largocombinada > 0) {
            for ($i = 0; $i < $largocombinada; $i++) {
                $listaasignatura[$i] = unserialize($datosasignaturascombinada[$i]['asignaturas']);
                for ($h = 0; $h < count($listaasignatura[$i]); $h++) {
                    $datocombinada = $modelasignatura->getnombre($listaasignatura[$i][$h]);
                    $validacom[$i][$h] = $datosasignaturascombinada[$i]['idAsignatura'];
                    for ($j = 0; $j < $largoalumnos; $j++) {
                        $datosalumnoscom = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, $seg, $id, $datocombinada[0]['idAsignatura']);
                        if ($listapromediostallercom) {
                            if ($datocombinada[0]['idAsignatura'] == $listapromediostallercom[$j][$h]['idAsignatura']) {
                                $datosalumnoscom[] = $listapromediostallercom[$j][$h];
                            }

                        }


                        for ($k = 0; $k < count($datosalumnoscom); $k++) {
                            if ($datocombinada[0]['idAsignatura'] == $datosalumnoscom[$k]['idAsignatura']) {
                                if ($datosalumnoscom[$k]['coef'] == 2) {
                                    if ($datosalumnoscom[$k]['nota'] > 0) {
                                        $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];
                                        $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];

                                    } else {
                                        $promediocom[$j][$m][] = 0;
                                        $promediocom[$j][$m][] = 0;
                                    }

                                } else {

                                    if ($datosalumnoscom[$k]['nota'] == 0 || empty($datosalumnoscom[$k]['nota']) || $datosalumnoscom[$k]['nota'] == NULL || $datosalumnoscom[$k]['nota'] == '') {
                                        if (!empty($datosalumnoscom[$k]["forma"])) {
                                            if ($datosalumnoscom[$k]['nota'] == 0) {
                                                $promediocom[$j][$m][] = 0;
                                            }

                                        } else {
                                            $promediocom[$j][$m][] = 0;
                                        }


                                    } else {
                                        if (!empty($datosalumnoscom[$k]["forma"]) && $datosalumnoscom[$k]["forma"] == 2) {

                                            //$promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];
                                            $promtalleraux = $datosalumnoscom[$k]['nota'];
                                            $porcentajetaller = $datosalumnoscom[$k]["porcentaje"];


                                        } elseif (!empty($datosalumnoscom[$k]["forma"]) && $datosalumnoscom[$k]["forma"] == 1) {
                                            $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];
                                            $promtalleraux = array();
                                            $porcentajetaller = array();
                                        } else {
                                            $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];
                                            $promtalleraux = array();
                                            $porcentajetaller = array();
                                        }


                                    }

                                }//fin else


                            }

                        }


                        if (!empty($promediocom[$j][$m])) {
                            $promset = array_diff($promediocom[$j][$m], array('0'));
                        } else {
                            $promset = 0;
                        }

                        if (is_array($promset)) {
                            if (count($promset) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    if ($porcentajetaller) {
                                        $totalporcentaje = 100;
                                        $porcentajeasig = $totalporcentaje - $porcentajetaller;
                                        $promedioauxalum = array_sum($promset) / count($promset);
                                        //$promcom[$j][$m]['nota'] = round(array_sum($promset) / count($promset));
                                        $promcom[$j][$m]['nota'] = round(($promedioauxalum * ($porcentajeasig / 100)) + ($promtalleraux * ($porcentajetaller / 100)));

                                    } else {
                                        $promcom[$j][$m]['nota'] = round(array_sum($promset) / count($promset));
                                    }

                                } else {
                                    if ($porcentajetaller) {
                                        $totalporcentaje = 100;
                                        $porcentajeasig = $totalporcentaje - $porcentajetaller;
                                        $promedioauxalum = array_sum($promset) / count($promset);
                                        //$promcom[$j][$m]['nota'] = round(array_sum($promset) / count($promset));
                                        $promcom[$j][$m]['nota'] = round(($promedioauxalum * ($porcentajeasig / 100)) + ($promtalleraux * ($porcentajetaller / 100)));

                                        // $promcom[$j][$m]['nota'] = intval(($promedioauxalum * ($porcentajeasig / 100)) + ($promtalleraux * ($porcentajetaller / 100)));

                                    } else {
                                        $promcom[$j][$m]['nota'] = intval(array_sum($promset) / count($promset));
                                    }
                                }
                            } else {
                                $promcom[$j][$m]['nota'] = 0;
                            }

                        } else {

                            $promcom[$j][$m]['nota'] = 0;
                        }
                        $promcom[$j][$m]['idAsignatura'] = $datosasignaturascombinada[$i]['idAsignatura'];
                        $promcom[$j][$m]['coef'] = 1;


                    }
                    $m++;
                }

            }
        }


//Talleres para curso Completp

        $promediotaller = array();
        if ($largotaller > 0) {

            for ($i = 0; $i < $largotaller; $i++) {
                if (!empty($datostaller[$i]['idConfiguracionTaller'])) {
                    $validataller[$i] = $datostaller[$i]['idAsignaturaTaller'];
                    for ($j = 0; $j < $largoalumnos; $j++) {
                        $datosalumnostaller = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, $seg, $id, $datostaller[$i]['idAsignatura']);


                        for ($k = 0; $k < count($datosalumnostaller); $k++) {
                            if ($datostaller[$i]['idAsignatura'] == $datosalumnostaller[$k]['idAsignatura']) {
                                if ($datosalumnostaller[$k]['coef'] == 2) {
                                    if ($datosalumnostaller[$k]['nota'] > 0) {
                                        $promediotaller[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                        $promediotaller[$j][$i][] = $datosalumnostaller[$k]['nota'];

                                    } else {
                                        $promediotaller[$j][$i][] = 0;
                                        $promediotaller[$j][$i][] = 0;
                                    }

                                } else {
                                    if ($datosalumnostaller[$k]['nota'] > 0) {
                                        $promediotaller[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                    } else {
                                        $promediotaller[$j][$i][] = 0;
                                    }

                                }


                            }

                        }
                        if (!empty($promediotaller[$j][$i])) {
                            $promset = array_diff($promediotaller[$j][$i], array('0'));
                        } else {
                            $promset = 0;
                        }

                        if (is_array($promset)) {
                            if (count($promset) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    $promtaller[$j][$i]['nota'] = round(array_sum($promset) / count($promset));

                                } else {
                                    $promtaller[$j][$i]['nota'] = intval(array_sum($promset) / count($promset));
                                }
                            } else {
                                $promtaller[$j][$i]['nota'] = 0;
                            }

                        } else {
                            $promtaller[$j][$i]['nota'] = 0;
                        }


                        $promtaller[$j][$i]['idAsignatura'] = $datostaller[$i]['idAsignaturaTaller'];
                        $promtaller[$j][$i]['coef'] = 1;
                        $promtaller[$j][$i]['tiempo'] = intval($seg);
                        $promtaller[$j][$i]['forma'] = $datostaller[$i]['forma'];
                        $promtaller[$j][$i]['porcentaje'] = $datostaller[$i]['porcentaje'];


                    }

                }


            }
        }


        if ($largoalumnos == 0 || count($listanotas) == 0) {
            echo "<script type=\"text/javascript\">alert(\"Sin Notas\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            exit;

        }

        for ($i = 0; $i < $largoalumnos; $i++) {

            $valores = $modelnotas->listarnotasporalumnoperiodo($listaalumnos[$i]['idAlumnos'], $idperiodo, $seg, $id);
            if ($valores != '' || !empty($valores)) {
                $listaalumnos[$i]['listanotas'] = $valores;
            } else {
                $listaalumnos[$i]['listanotas'] = 0;

            }
            for ($j = 0; $j < count($promtaller[$i]); $j++) {
                $listaalumnos[$i]['listanotas'][] = $promtaller[$i][$j];
            }


            for ($j = 0; $j < count($promcom[$i]); $j++) {
                $listaalumnos[$i]['listanotas'][] = $promcom[$i][$j];
            }

            if ($listapromediostaller[$i]) {
                for ($j = 0; $j < count($listapromediostaller[$i]); $j++) {
                    $listaalumnos[$i]['listanotas'][] = $listapromediostaller[$i][$j];
                }
            }


        }


        switch ($seg) {
            case '1':
                $nombreseg = 'I Semestre';
                break;

            case '2':
                $nombreseg = 'II Semestre';
                break;

            case '3':
                $nombreseg = 'I Trimestre';
                break;

            case '4':
                $nombreseg = 'II Trimestre';
                break;

            case '5':
                $nombreseg = 'III Trimestre';
                break;


        }

        $logo = getcwd();
        $logo .= "/application/documentos/logos/" . $datoscurso[0]['extension'];

        // variables para encabezado
        $titulo = strtoupper($datoscurso[0]['nombreEstablecimiento']) . '<br>' . strtoupper($nombreseg);

        $encabezado = '<img style="position:absolute;top:10px;left:30px" src="' . $logo . '" /><h4 style="position:absolute;top:50px;text-align:center">' . $titulo . '</h4>';


        if (!empty($datosasignaturas)) {
            $largoasignatura = count($datosasignaturas);
            for ($i = 0; $i < $largoasignatura; $i++) {

                $datoscuenta[$i] = $modelnotas->listarcantidadnotasasignatura($id, $idperiodo, $seg, $datosasignaturas[$i]['idAsignatura']);


                if (empty($datoscuenta[$i]) && $datosasignaturas[$i]['tipoAsignatura'] == 1) {
                    $datosasig[$i] = 0;
                } else {
                    $largonotas = count($datoscuenta[$i]);
                    $datosasig[$i] = 0;
                    for ($j = 0; $j < count($validataller); $j++) {
                        if ($datosasignaturas[$i]['idAsignatura'] == $validataller[$j]) {
                            $datosasig[$i] += 1;
                        }
                    }
                    for ($j = 0; $j < count($validacom); $j++) {
                        for ($k = 0; $k < count($validacom[$j]); $k++) {
                            if ($datosasignaturas[$i]['idAsignatura'] == $validacom[$j][$k]) {

                                $datosasig[$i] += 1;
                            }
                        }

                    }

                    for ($j = 0; $j < count($datostalleres); $j++) {
                        if ($datosasignaturas[$i]['idAsignatura'] == $datostalleres[$j]['idAsignaturaTaller']) {
                            $datosasig[$i] += 1;
                        }
                    }

                    for ($j = 0; $j < $largonotas; $j++) {

                        if ($datoscuenta[$i][$j]['coef'] == 2) {
                            $datosasig[$i] += 2;
                        } else {
                            $datosasig[$i] += 1;
                        }

                    }


                }


            }
        } else {
            echo "<script type=\"text/javascript\">alert(\"El Curso no Posee Asignaturas en el periodo\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            exit;

        }


        //Estilo pdf
        $style = "body{
font:12px ,Arial, Tahoma, Verdana, Helvetica, sans-serif;

color:#000;
}
img{
  width:60px;
  height:70px;
}


table{
font-size:10px;
width:100%;
height:auto;
margin:10px 0 10px 0;
border-collapse:collapse;
text-align:center;
text-justify:inter-word;
color:#000000;
}

table td,th{
border:1px solid black;
}

table th{
padding:1px;
background-color: #ccc;
}
";
        $pag = 0;
        $mostrar = false;
        $cuentapag = 0;

        if ($datoscurso[0]['monitoreo'] == 1) {

            if ($datoscurso[0]['idEstablecimiento'] == 12) {
                $max = 7;
                $mostrar = true;
            } else {
                $max = 9;
            }


        } else {
            $max = 9;
        }


        $html[$pag] = $encabezado;
        $html[$pag] .= "<div style='position:absolute;top:75px;left:25px;'><br> Curso: <b>" . $datoscurso[0]['nombreGrado'] . " " . $datoscurso[0]['letra'] . "</b><br> Fecha : <b>" . $fecha_final . "</b></div>";

        $html[$pag] .= '<table align="left" style="margin-left:20px"><tr><th>Nº</th><th>Alumnos</th>';


        for ($i = 0; $i < $largoasignatura; $i++) {


            //obtenemos cuantas notas existen en cada asignatura
            $cuentapag += 1;

            // si la cantidad de notas supera las 28 sumamos al contador de pag
            if ($cuentapag > $max) {
                $pag++;
                if ($pag == 1) {
                    ($mostrar) ? $max = 14 : $max = 18;
                }
                if ($pag == 2) {
                    ($mostrar) ? $max = 21 : $max = 28;
                }

                $html[$pag] = '<table align="left" style="margin-left:20px"><tr><th>Nº</th><th>Alumnos</th>';

            }

            if ($datoscurso[0]['monitoreo'] == 1) {

                if ($datoscurso[0]['idEstablecimiento'] == 12) {
                    $html[$pag] .= '<th style="width:80px;text-align:justify;" colspan="3">' . $datosasignaturas[$i]["nombreAsignatura"] . '</th>';

                } else {

                    $html[$pag] .= '<th style="width:80px;text-align:justify;">' . $datosasignaturas[$i]["nombreAsignatura"] . '</th>';
                }


            } else {
                $html[$pag] .= '<th style="width:80px;text-align:justify;">' . $datosasignaturas[$i]["nombreAsignatura"] . '</th>';

            }


        }


        if ($datoscurso[0]['monitoreo'] == 1) {

            if ($datoscurso[0]['idEstablecimiento'] == 12) {
                $html[$pag] .= "<th colspan='3'>PROM</th><th>Dias</th><th>Dias</th><th>%</th>";
            } else {
                $html[$pag] .= "<th>PROM</th><th>Dias</th><th>Dias</th><th>%</th>";
            }


        } else {
            $html[$pag] .= "<th>PROM</th><th>Dias</th><th>Dias</th><th>%</th>";
        }


        //$html[$pag] .= '<th>PROM</th>';

        $pag = 0;
        $cuentapag = 0;
        ($mostrar) ? $max = 7 : $max = 9;
        $cuentapag2 = array();
        $contadorpag = 0;


        $html[$pag] .= '</tr><tr><th colspan="2">Promedios</th>';
        for ($i = 0; $i < $largoasignatura; $i++) {
            $cuentapag += 1;

            // si la cantidad de notas supera las notas que ingresan en una hoja
            if ($cuentapag > $max) {
                $html[$pag] .= '</tr>';
                $pag++;
                if ($pag == 1) {
                    ($mostrar) ? $max = 14 : $max = 18;
                }
                if ($pag == 2) {
                    ($mostrar) ? $max = 21 : $max = 28;
                }

                $html[$pag] .= '</tr><tr><th colspan="2">Promedios</th>';

            }

            if ($datoscurso[0]['monitoreo'] == 1) {

                if ($datoscurso[0]['idEstablecimiento'] == 12) {
                    $html[$pag] .= '<th>% Nivel</th>';
                    $html[$pag] .= '<th>Nivel Logro</th>';
                }


            }

            $html[$pag] .= '<th>Prom</th>';
            $contadorpag++;
            $cuentapag2[$pag] = $contadorpag;

        }

//        if ($seg == 1) {
//            if ($datoscurso[0]['monitoreo'] == 1) {
//
//                if ($datoscurso[0]['idEstablecimiento'] == 12) {
//                    $html[$pag] .= '<th>% Nivel</th>';
//                    $html[$pag] .= '<th>Nivel Logro</th>';
//                }
//
//
//            }
//            $html[$pag] .= '<th>I SEM</th>';
//            $cuentapag2[$pag] += 1;
//        }
//        if ($seg == 2) {
//            if ($datoscurso[0]['monitoreo'] == 1) {
//
//                if ($datoscurso[0]['idEstablecimiento'] == 12) {
//                    $html[$pag] .= '<th>% Nivel</th>';
//                    $html[$pag] .= '<th>Nivel Logro</th>';
//                }
//
//
//            }
//            $html[$pag] .= '<th>II SEM</th>';
//            $cuentapag2[$pag] += 1;
//        }

        if ($datoscurso[0]['monitoreo'] == 1) {

            $aux_html = '';
            if ($datoscurso[0]['idEstablecimiento'] == 12) {
                $aux_html .= '<th>% Nivel</th>';
                $aux_html .= '<th>Nivel Logro</th>';
            }


        }

        switch ($seg) {
            case '1':
                $html[$pag] .= $aux_html;
                $html[$pag] .= '<th>I SEM</th>';
                $cuentapag2[$pag] += 1;
                break;

            case '2':
                $html[$pag] .= $aux_html;
                $html[$pag] .= '<th>II SEM</th>';
                $cuentapag2[$pag] += 1;
                break;

            case '3':
                $html[$pag] .= $aux_html;
                $html[$pag] .= '<th>I TRIM</th>';
                $cuentapag2[$pag] += 1;
                break;

            case '4':
                $html[$pag] .= $aux_html;
                $html[$pag] .= '<th>II TRIM</th>';
                $cuentapag2[$pag] += 1;
                break;

            case '5':
                $html[$pag] .= $aux_html;
                $html[$pag] .= '<th>III TRIM</th>';
                $cuentapag2[$pag] += 1;
                break;


        }


        $html[$pag] .= "<th>Trab</th><th>Inas</th><th>Asis</th>";

        $html[$pag] .= '</tr>';


        if (!empty($listaalumnos)) {
            $largoalumnos = count($listaalumnos);
            $r = 0;
            //Nuevo
            for ($i = 0; $i < $largoalumnos; $i++) {
                $pag = 0;
                $cuentapag = 0;
                ($mostrar) ? $max = 7 : $max = 9;
                $html[$pag] .= '<tr><td>' . ($i + 1) . '</td><td style="text-align: left">' . $listaalumnos[$i]["apaterno"] . ' ' . $listaalumnos[$i]["amaterno"] . ' ' . $listaalumnos[$i]["nombres"] . '</td>';
                $r = 0;
                for ($j = 0; $j < $largoasignatura; $j++) {

                    $promtalleraux = array();
                    $porcentajetaller = array();
                    $row = $datosasig[$j];
                    $cuentapag += 1;

                    if ($cuentapag > $max) {
                        $html[$pag] .= '</tr>';
                        $pag++;
                        if ($pag == 1) {
                            ($mostrar) ? $max = 14 : $max = 18;
                        }
                        if ($pag == 2) {
                            ($mostrar) ? $max = 21 : $max = 28;
                        }


                        $html[$pag] .= '<tr><td>' . ($i + 1) . '</td><td style="text-align: left">' . $listaalumnos[$i]["apaterno"] . ' ' . $listaalumnos[$i]["amaterno"] . ' ' . $listaalumnos[$i]["nombres"] . '</td>';


                    }
                    //fin nuevo

                    $promedio = 0;
                    $contador = 0;
                    $contadorpromedio = 0;
                    if ($row != 0) {
                        $largolistanota = count($listaalumnos[$i]['listanotas']);
                        for ($z = 0; $z < $largolistanota; $z++) {
                            $contadoraux = 0;

                            if ($datosasignaturas[$j]['idAsignatura'] == $listaalumnos[$i]['listanotas'][$z]['idAsignatura']) {
                                $contador = $contador + 1;

                                //si la nota es coeficiente 2
                                if ($listaalumnos[$i]['listanotas'][$z]['coef'] == '2') {
                                    $contador = $contador + 1;
                                    if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == null || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {

                                        $promedio += 0;
                                        $contadorpromedio += 0;

                                    } else {
                                        $promedio = $promedio + ($listaalumnos[$i]['listanotas'][$z]['nota'] + $listaalumnos[$i]['listanotas'][$z]['nota']);
                                        $contadorpromedio = $contadorpromedio + 2;


                                    }


                                } else {


                                    if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == null || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {
                                        if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"])) {
                                            if ($listaalumnos[$i]["listanotas"][$z]["nota"] == 0 || $listaalumnos[$i]["listanotas"][$z]["nota"] == null) {

                                                $promedio += 0;
                                                $contadorpromedio += 0;
                                            }

                                        } else {

                                            $promedio += 0;
                                            $contadorpromedio += 0;
                                        }


                                    } else {
                                        if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"]) && $listaalumnos[$i]["listanotas"][$z]["forma"] == 2) {


                                            $contadorauxtaller = true;
                                            $promtalleraux[] = $listaalumnos[$i]['listanotas'][$z]['nota'];
                                            $porcentajetaller[] = $listaalumnos[$i]["listanotas"][$z]["porcentaje"];


                                        } elseif (!empty($listaalumnos[$i]["listanotas"][$z]["forma"]) && $listaalumnos[$i]["listanotas"][$z]["forma"] == 1) {
                                            $promedio = $promedio + $listaalumnos[$i]['listanotas'][$z]['nota'];
                                            $contadorpromedio = $contadorpromedio + 1;

                                        } else {
                                            $promedio = $promedio + $listaalumnos[$i]['listanotas'][$z]['nota'];
                                            $contadorpromedio = $contadorpromedio + 1;

                                        }


                                    }

                                }
                                //Aumentamos el contador para notas matriz

                                //Promedios por notas
                                if ($contador == $row) {


                                    if ($contadorpromedio != 0) {

                                        $promedioaux = 0;
                                        //SI el Taller es por porcentaje
                                        if ($contadorauxtaller) {
                                            $sumataller = 0;
                                            $totalporcentaje = 100;
                                            if (count($promtalleraux) > 1) {
                                                for ($t = 0; $t < count($promtalleraux); $t++) {
                                                    $totalporcentaje = $totalporcentaje - $porcentajetaller[$t];
                                                    $sumataller += $promtalleraux[$t] * ($porcentajetaller[$t] / 100);
                                                }

                                            } else {
                                                $totalporcentaje = 100 - $porcentajetaller[0];
                                                $sumataller = $promtalleraux[0] * ($porcentajetaller[0] / 100);

                                            }


                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioaux = round($promedio / $contadorpromedio);
                                                $promedioaux = ($promedioaux * ($totalporcentaje / 100)) + $sumataller;
                                                $promedioaux = round($promedioaux);
                                                $promfinal[$i][] = $promedioaux;
                                                $notamatriz[$r][] = $promedioaux;

                                            } else {
                                                $promedioaux = round($promedio / $contadorpromedio);
                                                $promedioaux = ($promedioaux * ($totalporcentaje / 100)) + $sumataller;
                                                $promedioaux = intval($promedioaux);
                                                $promfinal[$i][] = $promedioaux;
                                                $notamatriz[$r][] = $promedioaux;
                                            }

                                        } else {

                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioaux = round($promedio / $contadorpromedio);
                                                $promfinal[$i][] = $promedioaux;
                                                $notamatriz[$r][] = $promedioaux;

                                            } else {
                                                $promedioaux = intval($promedio / $contadorpromedio);
                                                $promfinal[$i][] = $promedioaux;
                                                $notamatriz[$r][] = $promedioaux;
                                            }
                                        }

                                        if ($datoscurso[0]['monitoreo'] == 1) {

                                            if ($datoscurso[0]['idEstablecimiento'] == 12) {
                                                $devuelve = $this->equivalencias($lista_equivalencia, $promedioaux);
                                                $html[$pag] .= "<td>" . $devuelve[0] . "%</td>";
                                                $html[$pag] .= "<td>" . $devuelve[1] . "</td>";
                                            }


                                        }

                                        $html[$pag] .= '<td>' . $promedioaux . '</td>';


                                    } else {
                                        if ($contador == $contadoraux) {


                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima

                                                $promedioaux = $promtalleraux * ($porcentajetaller / 100);
                                                $promedioaux = round($promedioaux);
                                                $promfinal[$i][] = $promedioaux;
                                                $notamatriz[$r][] = $promedioaux;

                                            } else {
                                                $promedioaux = $promtalleraux * ($porcentajetaller / 100);
                                                $promedioaux = intval($promedioaux);
                                                $promfinal[$i][] = $promedioaux;
                                                $notamatriz[$r][] = $promedioaux;
                                            }

                                            if ($datoscurso[0]['monitoreo'] == 1) {

                                                if ($datoscurso[0]['idEstablecimiento'] == 12) {
                                                    $devuelve = $this->equivalencias($lista_equivalencia, $promedioaux);
                                                    $html[$pag] .= "<td>" . $devuelve[0] . "%</td>";
                                                    $html[$pag] .= "<td>" . $devuelve[1] . "</td>";
                                                }


                                            }
                                            $html[$pag] .= '<td>' . $promedioaux . '</td>';

                                        } else {

                                            $promfinal[$i][] = 0;
                                            $notamatriz[$r][] = 0;

                                            if ($datoscurso[0]['monitoreo'] == 1) {

                                                if ($datoscurso[0]['idEstablecimiento'] == 12) {
                                                    $html[$pag] .= '<td>-</td>';
                                                    $html[$pag] .= '<td>-</td>';
                                                }


                                            }
                                            $html[$pag] .= '<td>-</td>';
                                        }


                                    }
                                    $r++;


                                }// fin promedio por notas


                            }


                        }// fin for


                    } else {
                        if ($datoscurso[0]['monitoreo'] == 1) {

                            if ($datoscurso[0]['idEstablecimiento'] == 12) {
                                $html[$pag] .= '<td>-</td>';
                                $html[$pag] .= '<td>-</td>';
                            }


                        }
                        $html[$pag] .= '<td></td>';
                        $notamatriz[$r][] = 0;
                        $r++;


                    } //fin if row


                } //fin for


                if ($promfinal[$i] != '' || $promfinal[$i] != null) {

                    if ($datoscurso[0]['aproxPeriodo'] == 1) {//Aproxima
                        $promsetfinal = array_diff($promfinal[$i], array('0'));

                        $promediofinal = round(array_sum($promsetfinal) / count($promsetfinal));


                        if ($datoscurso[0]['monitoreo'] == 1) {

                            if ($datoscurso[0]['idEstablecimiento'] == 12) {
                                if ($promediofinal == 0) {

                                    $html[$pag] .= "<td>-</td>";
                                    $html[$pag] .= "<td>-</td>";
                                } else {
                                    $devuelve = $this->equivalencias($lista_equivalencia, $promediofinal);
                                    $html[$pag] .= "<td>" . $devuelve[0] . "%</td>";
                                    $html[$pag] .= "<td>" . $devuelve[1] . "</td>";
                                }

                            }


                        }

                        $html[$pag] .= '<td>' . $promediofinal . '</td>';
                        $notamatriz[$r][] = $promediofinal;

                    } else {
                        $promsetfinal = array_diff($promfinal[$i], array('0'));

                        $promediofinal = intval(array_sum($promsetfinal) / count($promsetfinal));


                        if ($datoscurso[0]['monitoreo'] == 1) {

                            if ($datoscurso[0]['idEstablecimiento'] == 12) {
                                if ($promediofinal == 0) {

                                    $html[$pag] .= "<td>-</td>";
                                    $html[$pag] .= "<td>-</td>";
                                } else {
                                    $devuelve = $this->equivalencias($lista_equivalencia, $promediofinal);
                                    $html[$pag] .= "<td>" . $devuelve[0] . "%</td>";
                                    $html[$pag] .= "<td>" . $devuelve[1] . "</td>";
                                }

                            }


                        }
                        $html[$pag] .= '<td>' . $promediofinal . '</td>';
                        //$html[$pag] .= '<td>' . intval(array_sum($promfinal[$i]) / count($promfinal[$i])) . '</td>';
                        $notamatriz[$r][] = $promediofinal;

                    }


                } else {

                    if ($datoscurso[0]['monitoreo'] == 1) {

                        if ($datoscurso[0]['idEstablecimiento'] == 12) {
                            $html[$pag] .= '<td>-</td>';
                            $html[$pag] .= '<td>-</td>';
                        }


                    }
                    $html[$pag] .= '<td>-</td>';
                    $notamatriz[$r][] = 0;
                }

                //Datos Asistencia Alummo
                $detallealumno = $modeldetalle->listardetalleperiodo($listaalumnos[$i]['idAlumnosActual'], $seg, $idperiodo);
                $diasin = $detallealumno[0]['diasInasistencia'];
                $diastrabajados = $detallealumno[0]['diasTrabajado'];
                if ($diasin != 0 && $diastrabajados > 0) {
                    $valord = $diasin / $diastrabajados;
                    $auxd = 1 - $valord;
                    $totald = $auxd * 100;
                } elseif (($diasin == 0 || $diasin == '') && $diastrabajados > 0) {
                    $valord = $diasin / $diastrabajados;
                    $auxd = 1 - $valord;
                    $totald = $auxd * 100;
                } else {
                    $totald = 0;
                    $diastrabajados = "-";
                    $diasin = "-";
                }


                $html[$pag] .= '<td>' . $diastrabajados . '</td><td>' . $diasin . '</td><td>' . intval($totald) . '%</td>';


                $html[$pag] .= '</tr>';


            }


            $largoes = count($cuentapag2);
            //Estadistica de notas
            for ($i = 0; $i < count($cuentapag2); $i++) {
                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $largocuenta = $cuentapag2[$i];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Promedio Generales</td>';
                } else {
                    $aux = 0;
                    $largocuenta = $cuentapag2[$i];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Promedio Generales</td>';
                }


                for ($y = $aux; $y < $largocuenta; $y++) {

                    if ($datoscurso[0]['monitoreo'] == 1) {

                        if ($datoscurso[0]['idEstablecimiento'] == 12) {
                            $html[$i] .= '<td>-</td>';
                            $html[$i] .= '<td>-</td>';
                        }


                    }
                    $notamatrizset = array_diff($notamatriz[$y], array('0'));
                    if (array_sum($notamatrizset) != 0) {
                        $html[$i] .= '<td>' . round(array_sum($notamatrizset) / count($notamatrizset)) . '</td>';
                    } else {
                        $html[$i] .= '<td>-</td>';
                    }


                }
                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';


                //Minimos
                if ($i > 0) {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Mínimo</td>';
                } else {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Mínimo</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {

                    if ($datoscurso[0]['monitoreo'] == 1) {

                        if ($datoscurso[0]['idEstablecimiento'] == 12) {
                            $html[$i] .= '<td>-</td>';
                            $html[$i] .= '<td>-</td>';
                        }


                    }

                    $valormin = array_sum($notamatriz[$y]);
                    if ($valormin != 0) {
                        $html[$i] .= '<td>' . min(array_diff($notamatriz[$y], array(0))) . '</td>';
                    } else {
                        $html[$i] .= '<td>-</td>';
                    }
                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';

                //Maximos
                if ($i > 0) {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Máximo</td>';
                } else {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Máximo</td>';
                }


                for ($y = $aux; $y < $largocuenta; $y++) {

                    if ($datoscurso[0]['monitoreo'] == 1) {

                        if ($datoscurso[0]['idEstablecimiento'] == 12) {
                            $html[$i] .= '<td>-</td>';
                            $html[$i] .= '<td>-</td>';
                        }


                    }
                    $valormax = array_sum($notamatriz[$y]);
                    if ($valormax != 0) {
                        $html[$i] .= '<td>' . max(array_diff($notamatriz[$y], array(0))) . '</td>';
                    } else {
                        $html[$i] .= '<td>-</td>';
                    }
                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';

                //Adecuado

                if ($i > 0) {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Adecuado</td>';
                } else {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Adecuado</td>';
                }


                for ($y = $aux; $y < $largocuenta; $y++) {

                    if ($datoscurso[0]['monitoreo'] == 1) {

                        if ($datoscurso[0]['idEstablecimiento'] == 12) {
                            $html[$i] .= '<td>-</td>';
                            $html[$i] .= '<td>-</td>';
                        }


                    }
                    $contadorinicial = 0;
                    $largomatriz = count($notamatriz[$y]);
                    for ($v = 0; $v < $largomatriz; $v++) {
                        if ($notamatriz[$y][$v] > 59 && $notamatriz[$y][$v] <= 70) {
                            $contadorinicial = $contadorinicial + 1;

                        }
                    }
                    $totaladecuado[$y] = $contadorinicial;

                    $html[$i] .= '<td>' . $contadorinicial . '</td>';

                }
                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';

                //Elemntal
                if ($i > 0) {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Elemental</td>';
                } else {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Elemental</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {

                    if ($datoscurso[0]['monitoreo'] == 1) {

                        if ($datoscurso[0]['idEstablecimiento'] == 12) {
                            $html[$i] .= '<td>-</td>';
                            $html[$i] .= '<td>-</td>';
                        }


                    }
                    $contadorinicial = 0;
                    $largomatriz = count($notamatriz[$y]);
                    for ($v = 0; $v < $largomatriz; $v++) {
                        if ($notamatriz[$y][$v] > 39 && $notamatriz[$y][$v] < 60) {
                            $contadorinicial = $contadorinicial + 1;

                        }
                    }

                    $totalelemental[$y] = $contadorinicial;
                    $html[$i] .= '<td>' . $contadorinicial . '</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';


                //Insuficiente
                if ($i > 0) {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Insuficiente</td>';
                } else {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Insuficiente</td>';
                }


                for ($y = $aux; $y < $largocuenta; $y++) {

                    if ($datoscurso[0]['monitoreo'] == 1) {

                        if ($datoscurso[0]['idEstablecimiento'] == 12) {
                            $html[$i] .= '<td>-</td>';
                            $html[$i] .= '<td>-</td>';
                        }


                    }
                    $contadorinicial = 0;
                    $largomatriz = count($notamatriz[$y]);
                    for ($v = 0; $v < $largomatriz; $v++) {
                        if ($notamatriz[$y][$v] > 10 && $notamatriz[$y][$v] < 40) {
                            $contadorinicial = $contadorinicial + 1;

                        }
                    }

                    $totalinsuficiente[$y] = $contadorinicial;
                    $html[$i] .= '<td>' . $contadorinicial . '</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }
                $html[$i] .= '</tr>';


                //Totales
                if ($i > 0) {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Total</td>';
                } else {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Total</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {

                    if ($datoscurso[0]['monitoreo'] == 1) {

                        if ($datoscurso[0]['idEstablecimiento'] == 12) {
                            $html[$i] .= '<td>-</td>';
                            $html[$i] .= '<td>-</td>';
                        }


                    }
                    $total[$y] = ($totaladecuado[$y] + $totalelemental[$y] + $totalinsuficiente[$y]);
                    $html[$i] .= '<td>' . $total[$y] . '</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';


                //Porcentaje Adecuado

                if ($i > 0) {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Adecuado</td>';
                } else {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Adecuado</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {

                    if ($datoscurso[0]['monitoreo'] == 1) {

                        if ($datoscurso[0]['idEstablecimiento'] == 12) {
                            $html[$i] .= '<td>-</td>';
                            $html[$i] .= '<td>-</td>';
                        }


                    }

                    if ($total[$y] > 0) {
                        $porcentaje = ($totaladecuado[$y] / $total[$y]) * 100;
                    } else {
                        $porcentaje = 0;
                    }
                    $html[$i] .= '<td>' . round($porcentaje) . '%</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';

                //Porcentaje Elemental
                if ($i > 0) {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Elemental</td>';
                } else {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Elemental</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {

                    if ($datoscurso[0]['monitoreo'] == 1) {

                        if ($datoscurso[0]['idEstablecimiento'] == 12) {
                            $html[$i] .= '<td>-</td>';
                            $html[$i] .= '<td>-</td>';
                        }


                    }

                    if ($total[$y] > 0) {
                        $porcentaje = ($totalelemental[$y] / $total[$y]) * 100;
                    } else {
                        $porcentaje = 0;
                    }

                    $html[$i] .= '<td>' . round($porcentaje) . '%</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';

                //Porcentaje Suficiente

                if ($i > 0) {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Insuficiente</td>';
                } else {

                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Insuficiente</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {

                    if ($datoscurso[0]['monitoreo'] == 1) {

                        if ($datoscurso[0]['idEstablecimiento'] == 12) {
                            $html[$i] .= '<td>-</td>';
                            $html[$i] .= '<td>-</td>';
                        }


                    }

                    if ($total[$y] > 0) {
                        $porcentaje = ($totalinsuficiente[$y] / $total[$y]) * 100;
                    } else {
                        $porcentaje = 0;
                    }
                    $html[$i] .= '<td>' . round($porcentaje) . '%</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';


            }//Fin ciclo Paginas


        }
        //Fin nuevo

        if ($html != '') {

            require 'fpdf/html2pdf.class.php';
            try {
                $width_in_mm = 216;
                $height_in_mm = 330;
                //Orientación / formato del pdf y el idioma.
                $pdf = new HTML2PDF('L', array($width_in_mm, $height_in_mm), 'es', true, 'UTF-8', array(0, 0, 0, 0) /*márgenes*/); //los márgenes también pueden definirse en <page> ver documentación
                $pdf->pdf->SetDisplayMode('fullpage');
                for ($i = 0; $i < count($html); $i++) {

                    $pdf->WriteHTML('<page><html>
                        <head>
                            <style>' . $style . '</style>
                        </head>
                        <body>' . $html[$i] . '</table></body></html></page>');
                }

                if (preg_match("/MSIE/i", $_SERVER["HTTP_USER_AGENT"])) {
                    header("Content-type: application/PDF");
                } else {
                    header("Content-type: application/PDF");
                    header("Content-Type: application/pdf");
                }

                $pdf->Output('Planificacion.pdf', I);
            } catch (HTML2PDF_exception $e) {
                //echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, intente nuevamente\");</script>";
                //echo "<script>parent.$.fancybox.close();</script>";
                echo $e;
            }
        }

    }


    public function planillaAction()
    {

        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();
        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $usuario = new Zend_Session_Namespace('id');
        $user = $usuario->id;
        $id = $this->_getParam('id', 0);
        $paso = false;


        //mostramos el formulario

        echo "<link href='" . $this->_request->getBaseUrl() . "/css/formpdf.css' type='text/css' rel='stylesheet' /><div class='col_12 column'><form class='basic-grey' method='post' action='planilla'><h1>Planilla Curso</h1><label  for='pl'><span> Título:</span> <input type='text' id='pl' name='pl' /></label><label  for='pl'><span> Fecha:</span> <input style='width:23%;' placeholder='Ej: 01-06 (Día/Mes)' maxlength='5' type='text' id='fechap' name='fechap' /></label><label><span>&nbsp;</span><input type='submit' name='submit' value='Enviar'></label><input type='hidden' id='idp' name='idp' value='" . $id . "' /></input></form></div>";

        //si Vienen datos por post

        if ($this->getRequest()->isPost()) {

            $titulo = $_POST["pl"];
            $fecha = $_POST["fechap"];
            $id = $_POST["idp"];
            $tempDate = explode('-', $fecha);

            $periodos = new Zend_Session_Namespace('nombreperiodo');
            $nombreperiodo = $periodos->nombreperiodo;

            //Validamos que el título no sea vacío y la fecha posea el formato correcto
            if (!empty($titulo) && checkdate($tempDate[1], $tempDate[0], $nombreperiodo && $id > 0)) {

                //Estilo pdf
                $style = "body{
                font:12px ,Arial, Tahoma, Verdana, Helvetica, sans-serif;
                
                color:#000;
                }
                img{
                width:90px;
                height:100px;
                }
                
                table{
                font-size:12px;
                width:100%;
                height:auto;
                margin:10px 0 10px 0;
                border-collapse:collapse;
                text-align:center;
                text-justify:inter-word;
                color:#000000;
                }
                
                table td,th{
                border:1px solid black;
                }
                
                table th{
                padding:1px;
                background-color: #ccc;
                }
                ";

                // Modelos a utilizar
                $modelcurso = new Application_Model_DbTable_Cursos();
                $modelalumno = new Application_Model_DbTable_Alumnosactual();
                $modelCuenta = new Application_Model_DbTable_Cuentas();


                $cargo = new Zend_Session_Namespace('cargo');
                $rol = $cargo->cargo;
                //Si es Administrador o Director
                if ($rol == 1 || $rol == 3 || $rol == 2) {

                    $datoscurso = $modelcurso->listarcursoid($id, $idperiodo);
                    $listaalumnos = $modelalumno->listaralumnoscursoactual($id, $idperiodo);

                    if (!empty($datoscurso[0]['idCuentaJefe']) || $datoscurso[0]['idCuentaJefe'] > 0) {
                        $Profesorjefe = $modelCuenta->getusuario($datoscurso[0]['idCuentaJefe'], $idperiodo);
                    } else {
                        $Profesorjefe = 0;
                    }


                    if (count($Profesorjefe) == 0 || $Profesorjefe == null) {
                        echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta Profesor Jefe\");</script>";
                        echo "<script>parent.$.fancybox.close();</script>";
                        exit;
                    }

                    if (count($listaalumnos) == 0 || $listaalumnos == null) {
                        echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No Existen Alumnos en éste curso\");</script>";
                        echo "<script>parent.$.fancybox.close();</script>";
                        exit;
                    }

                    $tituloest = "<b>" . $datoscurso[0]['nombreEstablecimiento'] . "</b>";
                    $logo = getcwd();
                    $logo .= "/application/documentos/logos/" . $datoscurso[0]['extension'];
                    if (file_exists($logo)) {
                        $plogo = '<p style="position:absolute;top:2px;text-align:center"><img  src="' . $logo . '" /></p>';
                    } else {
                        $plogo = '';
                    }
                    $encabezado = $plogo . '<h4 style="position:absolute;top:100px;text-align:center">' . $tituloest . '</h4><h4 style="position:absolute;top:120px;text-align:center">' . $titulo . '</h4><h4 style="position:absolute;top:140px;text-align:center">' . $datoscurso[0]['nombreGrado'] . ' ' . $datoscurso[0]['letra'] . '</h4>';
                    $html = $encabezado;


                }

                $dias = array("Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado");
                $meses = array("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre");
                $fecha_final = $dias[date('w', mktime(0, 0, 0, $tempDate[1], $tempDate[0], $nombreperiodo))] . " " . $tempDate[0] . " de " . $meses[date('n', mktime(0, 0, 0, $tempDate[1], $tempDate[0], $nombreperiodo)) - 1] . " del " . date('Y', mktime(0, 0, 0, $tempDate[1], $cortado[2], $nombreperiodo));


                $html .= '<div style="margin-left: 60px;"><h5>Fecha: ' . $fecha_final . '</h5></div>';

                $html .= '<table align="center"><tr><th style="width: 5%;">Nº Lista</th><th style="width: 50%;">Nombre Alumno</th><th style="width: 30%;">Firma Alumno</th></tr>';

                for ($i = 0; $i < count($listaalumnos); $i++) {

                    $html .= '<tr><td>' . ($i + 1) . '</td><td style="text-align: left;padding-right: 3px;">' . $listaalumnos[$i]["apaterno"] . ' ' . $listaalumnos[$i]["amaterno"] . ' ' . $listaalumnos[$i]["nombres"] . '</td><td></td></tr>';

                }
                $html .= '</table>';


                $tdnombreprofesor = "<p style='text-decoration:underline;margin-left:30px;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</p>";
                $tdprofesor = "Profesor(a) Jefe.";


                $html .= "<table align='center' style='margin-top:25px;' class='page_firmas'>
                        <tr>
                            <td style='width: 33%; text-align: center;border:none;'>" . $tdnombreprofesor . "</td>
                            <td style='width: 33%; text-align: center;border:none;'></td>
                            <td style='width: 33%; text-align: center;border:none;'></td>
                        </tr>
                        <tr>
                            <td style='width: 33%; text-align:center;border:none;padding-top:35px'>" . $tdprofesor . "</td>
                            <td style='width: 33%; text-align: center;border:none;padding-top:35px'></td>
                            <td style='width: 33%; text-align:center;border:none;padding-top:35px'></td>
                        </tr>
                        </table>";


                $content = '
                        <!doctype html>
                        <html>
                        <head>
                            <style>' . $style . '</style>
                        </head>
                        <body>  <page_footer>
                        <table class="page_footer">
                
                        </table>
                    </page_footer>'
                    . $encabezado
                    . $html .
                    '</body>
                    </html>';

                if ($content != '') {
                    // ob_start();

                    echo '<page>' . $content . '</page>';

                    //Añadimos la extensión del archivo. Si está vacío el nombre lo creamos
                    //$path!='' ? $path .='.pdf' : $path = crearNombre(10);

                    $content = ob_get_clean();
                    require 'fpdf/html2pdf.class.php';
                    try {
                        //Orientación / formato del pdf y el idioma.
                        $pdf = new HTML2PDF('P', 'LETTER', 'es', array(10, 10, 10, 10) /*márgenes*/); //los márgenes también pueden definirse en <page> ver documentación

                        $pdf->WriteHTML($content);
                        if (preg_match("/MSIE/i", $_SERVER["HTTP_USER_AGENT"])) {
                            header("Content-type: application/PDF");
                        } else {
                            header("Content-type: application/PDF");
                            header("Content-Type: application/pdf");
                        }

                        $pdf->Output('Planilla ' . $datoscurso[0]['nombreGrado'] . ' ' . $datoscurso[0]['letra'] . '.pdf', I);
                    } catch (HTML2PDF_exception $e) {
                        echo $e;
                    }
                }


            } else {

                echo "<div style='padding: 25px 15px 25px 10px;border:1px solid #E4E4E4;margin-left:auto;margin-right:auto;max-width:500px;text-align:center;color: #D8000C;background-color: #FFBABA;'>Datos no Válidos</div>";

            }

        }


    }

    public function indexplanillaAction()
    {

        //creo objeto que maneja la tabla Establecimiento
        $table = new Application_Model_DbTable_Cursos();
        $tabladetalle = new Application_Model_DbTable_Detallecursocuenta();
        $tabladetallerol = new Application_Model_DbTable_Detallerolcuenta();

        $est = new Zend_Session_Namespace('establecimiento');
        $establecimiento = $est->establecimiento;

        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $usuario = new Zend_Session_Namespace('id');
        $user = $usuario->id;

        $cargo = new Zend_Session_Namespace('cargo');
        $rol = $cargo->cargo;


        if ($rol == '3' || $rol == '4' || $rol == '6') {
            $this->view->datos = $table->listartodasactual($establecimiento, $idperiodo);

        }
        if ($rol == '1') {
            $this->view->datos = $table->listaractual($idperiodo);

        }

        if ($rol == '2') {


            $detallecurso[0] = $table->listarcursodocente($user, $idperiodo, $establecimiento)->toArray();

            for ($i = 0; $i < count($detallecurso[0]); $i++) {
                if ($user === $detallecurso[0][$i]['idCuentaJefe']) {
                    $detallecurso[0][$i]['authjefe'] = true;
                    $verifica[] = 1;

                }
            }
            //Si no existen jefaturas busca si posee y las asigna
            if (empty($verifica)) {
                $cursosjefatura = $table->listarcursoiddocenteactual($user, $establecimiento, $idperiodo, 1);
                for ($i = 0; $i < count($cursosjefatura); $i++) {
                    $cursosjefatura[$i]['authjefe'] = true;
                    $detallecurso[0][] = $cursosjefatura[$i];

                }

            }
            $this->view->datos = $detallecurso;


//            if ($ingresonota == 1) {
//
//                $this->view->datos = $table->listarcursoiddocenteactual($user, $establecimiento, $idperiodo, 1);
//
//            } else {
//                $datos = $tabladetallerol->listar($user, $idperiodo, $establecimiento);
//                for ($i = 0; $i < count($datos); $i++) {
//                    $detallecurso = $tabladetalle->listarcursousuario($datos[$i]['id']);
//                    for ($j = 0; $j < count($detallecurso); $j++) {
//
//                        if ($detallecurso[$j]['idCuentaJefe'] == $user) {
//                            $lista[$i] = $detallecurso[$j];
//
//                        }
//
//                    }
//
//
//                }
//
//                $this->view->datos = $lista;
//
//            }

        }

    }


    public function generaobservacionAction()
    {

        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();
        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $usuario = new Zend_Session_Namespace('id');
        $user = $usuario->id;

        $idcursos = new Zend_Session_Namespace('id_curso');
        $idcurso = $idcursos->id_curso;

        $cryptor = new \Chirp\Cryptor();

        $id = $this->_getParam('id', 0);
        $paso = false;
        $id = $cryptor->decrypt($id);


        //Validamos que el título no sea vacío y la fecha posea el formato correcto
        if ($id) {

            //Estilo pdf
            $style = "body{
                font:11px ,Arial, Tahoma, Verdana, Helvetica, sans-serif;
                color:#000;
                }
                img{
                width:90px;
                height:100px;
                }
                
                table{
                font-size:11px;
                width:100%;
                height:auto;
                margin:10px 0 10px 0;
                border-collapse:collapse;
                text-align:center;
                text-justify:inter-word;
                color:#000000;
                }
                
                table td,th{
                border:1px solid black;
               
                }
                
                table th{
                padding:1px;
                background-color: #ccc;
                }
                
                table td{
                text-align:left;
                padding:5px;
                }
                ";

            // Modelos a utilizar
            $modelcurso = new Application_Model_DbTable_Cursos();
            $modelalumno = new Application_Model_DbTable_Alumnosactual();
            $modelCuenta = new Application_Model_DbTable_Cuentas();
            $modelobservacion = new Application_Model_DbTable_Observacion();
            $modeloasignatura = new Application_Model_DbTable_Asignaturascursos();


            $cargo = new Zend_Session_Namespace('cargo');
            $rol = $cargo->cargo;
            //Si es Administrador o Director
            if ($rol == 1 || $rol == 2 || $rol == 3 || $rol == 6) {

                $lista = $modelobservacion->listar($id, $idperiodo);

                if (count($lista) == 0 || $lista == null) {
                    echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No Existen Observaciones para el alumno\");</script>";
                    echo "<script>parent.$.fancybox.close();</script>";
                    exit;
                }

                $datoscurso = $modelcurso->listarcursoid($lista[0]['idCursos'], $idperiodo);


                $comuna = new Application_Model_DbTable_Comuna();
                $datoscomuna = $comuna->getcomunasolo($lista[0]['comunaActual']);
                $nombrecomuna = $datoscomuna[0]['nombreComuna'];

                if ($lista[0]['sexo'] == 1) {
                    $nombresexo = 'Femenino';
                }
                if ($lista[0]['sexo'] == 2) {
                    $nombresexo = 'Masculino';
                }
                if ($lista[0]['sexo'] == 0) {
                    $nombresexo = 'Sin Datos';
                }


                $caracteres = array(",", ".", "-");
                $rutset = str_replace($caracteres, "", $lista[0]['rutAlumno']);


                if (!empty($rutset)) {

                    $rest = substr($rutset, 0, -1);
                    $ultimo = substr($rutset, -1);
                    $formatomiles = number_format($rest, 0, "", ".");
                    $formatofinal = $formatomiles . '-' . $ultimo;

                }

                setlocale(LC_TIME, "es_ES");

                $date = date_create($lista[0]['fechanacimiento']);

                $fechanacimiento = strftime("%d de %B del %Y", $date->getTimestamp());


                for ($i = 0; $i < count($lista); $i++) {
                    if ($lista[$i]['idAsignatura'] == "D") {

                        $lista[$i]['Asignatura'][0]['nombreAsignatura'] = "Dirección";

                    } elseif ($lista[$i]['idAsignatura'] == "I") {
                        $lista[$i]['Asignatura'][0]['nombreAsignatura'] = "Inspectoria";
                    } elseif ($lista[$i]['idAsignatura'] == "R") {
                        $lista[$i]['Asignatura'][0]['nombreAsignatura'] = "Recreo";
                    } else {

                        $lista[$i]['Asignatura'] = $modeloasignatura->get($lista[$i]['idAsignatura'], $lista[$i]['idCursos'], $idperiodo);

                    }


                }

                if (!empty($datoscurso[0]['idCuentaJefe']) || $datoscurso[0]['idCuentaJefe'] > 0) {
                    $Profesorjefe = $modelCuenta->getusuario($datoscurso[0]['idCuentaJefe'], $idperiodo);
                } else {
                    $Profesorjefe = 0;
                }


                if (count($Profesorjefe) == 0 || $Profesorjefe == null) {
                    echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta Profesor Jefe\");</script>";
                    echo "<script>parent.$.fancybox.close();</script>";
                    exit;
                }


                $tituloest = "<b>" . $datoscurso[0]['nombreEstablecimiento'] . "</b>";
                $titulo = "Informe de Conducta ";
                $logo = getcwd();
                $logo .= "/application/documentos/logos/" . $datoscurso[0]['extension'];
                if (file_exists($logo)) {
                    $plogo = '<p style="position:absolute;top:2px;text-align:center"><img  src="' . $logo . '" /></p>';
                } else {
                    $plogo = '';
                }
                $encabezado = $plogo . '<h4 style="position:absolute;top:120px;text-align:center">' . $tituloest . '</h4><h4 style="position:absolute;top:140px;text-align:center">' . $titulo . '</h4>';
                $html = $encabezado;


                $html .= '
            <table width=100% align="center" class="antecedentes" style="width:100%">
            <tr >
            <td colspan="8" style="width:100%;text-align:center;border: 0px;border-bottom: 1px solid; border-collapse: collapse;font-weight:bold;">ANTECEDENTES DEL ALUMNO</td>
            </tr>
              <tr>
                <td><b>Nombre Alumno: </b>' . strtr(strtoupper($lista[0]['nombres']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . ' ' . strtr(strtoupper($lista[0]['apaterno']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . ' ' . strtr(strtoupper($lista[0]['amaterno']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . '</td>
                <td><b>Rut:</b> ' . $formatofinal . '</td>   
              </tr>
              <tr>
                <td><b>Fecha Nacimiento:</b> ' . $fechanacimiento . '</td>
                <td><b>Curso:</b> ' . $datoscurso[0]['nombreGrado'] . ' ' . $datoscurso[0]['letra'] . '</td>
              </tr>
              
              <tr>
                <td><b>Domicilio:</b> ' . $lista[0]['calle'] . ' ' . $lista[0]['numeroCasa'] . ' ' . $lista[0]['ciudadActual'] . '  </td>
                <td><b>Comuna:</b> ' . $nombrecomuna . '</td>
              </tr>
              
             
            </table>';


                $html .= '<table><tr><th>Nº</th><th>Profesor</th><th>Asignatura</th><th>Fecha Observación</th><th>Observación</th></tr>';

                for ($i = 0; $i < count($lista); $i++) {


                    $date = date_create($lista[$i]['fechaObservacion']);

                    $lista[$i]['fechaObservacion'] = strftime("%d de %B del %Y", $date->getTimestamp());


                    $html .= '<tr><td style="width:3%;">' . ($i + 1) . '</td><td style="width:25%;">' . $lista[$i]["nombrescuenta"] . ' ' . $lista[$i]["paternocuenta"] . ' ' . $lista[$i]["maternocuenta"] . '</td><td style="width:20%;">' . $lista[$i]['Asignatura'][0]["nombreAsignatura"] . '</td><td style="width:18%;">' . $lista[$i]["fechaObservacion"] . '</td><td style="width:34%;">' . $lista[$i]["observacion"] . '</td></tr>';

                }
                $html .= '</table>';


                $tdnombreprofesor = "<p style='text-decoration:underline;margin-left:30px;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</p>";
                $tdprofesor = "Profesor(a) Jefe.";


                $content = '
                        <!doctype html>
                        <html>
                        <head>
                            <style>' . $style . '</style>
                        </head>
                        <body>'
                    . $encabezado
                    . $html . '<page_footer>
                        <table class="page_footer">
                <table align="center" style="margin-top:25px;" class="page_firmas">
                        <tr>
                            <td style="width: 33%; text-align: center;border:none;">' . $tdnombreprofesor . '</td>
                            <td style="width: 33%; text-align: center;border:none;"></td>
                            <td style="width: 33%; text-align: center;border:none;"></td>
                        </tr>
                        <tr>
                            <td style="width: 33%; text-align:center;border:none;padding-top:35px">' . $tdprofesor . '</td>
                            <td style="width: 33%; text-align: center;border:none;padding-top:35px"></td>
                            <td style="width: 33%; text-align:center;border:none;padding-top:35px"></td>
                        </tr>
                        </table>
                        </table>
                    </page_footer>
                </body>
                    </html>';

                if ($content != '') {
                    // ob_start();

                    echo '<page>' . $content . '</page>';

                    //Añadimos la extensión del archivo. Si está vacío el nombre lo creamos
                    //$path!='' ? $path .='.pdf' : $path = crearNombre(10);

                    $content = ob_get_clean();
                    require 'fpdf/html2pdf.class.php';
                    try {
                        //Orientación / formato del pdf y el idioma.
                        $pdf = new HTML2PDF('P', 'LETTER', 'es', array(10, 10, 10, 10) /*márgenes*/); //los márgenes también pueden definirse en <page> ver documentación

                        $pdf->WriteHTML($content);
                        if (preg_match("/MSIE/i", $_SERVER["HTTP_USER_AGENT"])) {
                            header("Content-type: application/PDF");
                        } else {
                            header("Content-type: application/PDF");
                            header("Content-Type: application/pdf");
                        }

                        $pdf->Output('Planilla ' . $datoscurso[0]['nombreGrado'] . ' ' . $datoscurso[0]['letra'] . '.pdf', I);
                    } catch (HTML2PDF_exception $e) {
                        echo $e;
                    }
                }
            }


        } else {

            echo "<div style='padding: 25px 15px 25px 10px;border:1px solid #E4E4E4;margin-left:auto;margin-right:auto;max-width:500px;text-align:center;color: #D8000C;background-color: #FFBABA;'>Datos no Válidos</div>";

        }


    }


    // Informes de Asistencia

    public function indexasistenciaAction()
    {
        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $periodos = new Zend_Session_Namespace('nombreperiodo');
        $nombreperiodo = $periodos->nombreperiodo;

        //$this->view->title = "Generar Informe Asistencia Curso";
        $this->view->headTitle($this->view->title);
        $form = new Application_Form_AsistenciaGenera();
        $form->setDecorators(
            array(
                'FormElements',
                'Form',
            )
        );


        $form->pdf->setLabel('Generar PDF');
        $form->excel->setLabel('Generar Excel');
        $this->view->form = $form;
        if ($this->getRequest()->isPost()) {
            $formData = $this->getRequest()->getPost();
            if ($form->isValid($formData)) {
                $idcurso = $form->getValue('idCursos');
                $mes = $form->getValue('meses');
                $pdf = $form->getValue('pdf');
                $excel = $form->getValue('excel');


                $modeloasistencia = new Application_Model_DbTable_Asistencia();
                $modeloalumnos = new Application_Model_DbTable_Alumnosactual();
                $modelocurso = new Application_Model_DbTable_Cursos();
                $datoscurso = $modelocurso->listarcursoid($idcurso, $idperiodo);
                $datos = $modeloasistencia->getasistenciacurso($idcurso, $mes, $idperiodo);
                $listadealumnos = $modeloalumnos->listaralumnoscursoactual($idcurso, $idperiodo);
                $largoalumnos = count($listadealumnos);
                $largodatos = count($datos);

                if (count($datos) == 0) {

                    echo "<script type=\"text/javascript\">alert(\"No existen datos registrados para el mes seleccionado\");</script>";
                    echo "<script>parent.$.fancybox.close();</script>";
                    echo "<script>window.close();</script>";
                    exit;

                } else {
                    //Calcular numero de dias del mes

                    $numero = cal_days_in_month(CAL_GREGORIAN, $mes, $nombreperiodo);


                    setlocale(LC_TIME, 'es_CL.UTF-8');

                    //Creamos el Nombre del Mes
                    $dateObj = DateTime::createFromFormat('!m', $mes);
                    $nombremes = strftime("%B", $dateObj->getTimestamp());

                    $tituloest = "<b>" . $datoscurso[0]['nombreEstablecimiento'] . "</b>";
                    $titulo = "Informe de Asistencia " . $datoscurso[0]['nombreGrado'] . " " . $datoscurso[0]['letra'];
                    $titulomes = "Mes: " . ucwords($nombremes) . " del " . $nombreperiodo;
                    $logo = getcwd();
                    $logo .= "/application/documentos/logos/" . $datoscurso[0]['extension'];
                    if (file_exists($logo)) {
                        $plogo = '<p style="position:absolute;top:2px;text-align:center"><img  src="' . $logo . '" /></p>';
                    } else {
                        $plogo = '';
                    }
                    $encabezado = $plogo . '<h4 style="position:absolute;top:120px;text-align:center">' . $tituloest . '</h4><h4 style="position:absolute;top:140px;text-align:center">' . $titulo . '</h4><h4 style="position:absolute;top:160px;text-align:center">' . $titulomes . '</h4>';
                    $html = $encabezado;


                    //$html[$pag] = $encabezado;
                    // $html.= "<div style='position:absolute;top:75px;left:25px;'><br> Curso: <b>" . $datoscurso[0]['nombreGrado'] . " " . $datoscurso[0]['letra'] . "</b><br> Fecha : <b>" . $fecha_final . "</b></div>";

                    $html .= '<table align="left" style="margin-left:2px"><tr><th rowspan="2">Nº</th><th rowspan="2">Alumnos</th>';

                    for ($i = 0; $i < $numero; $i++) {
                        $dateObj = DateTime::createFromFormat('Y-m-d', $nombreperiodo . "-" . $mes . "-" . ($i + 1));
                        $nombredia = strftime("%a", $dateObj->getTimestamp());
                        $html .= '<th style="width: 17px;">' . $nombredia . '</th>';

                    }
                    $html .= '<th rowspan="2">Total</th><th rowspan="2">Asis</th><th rowspan="2">Inas</th><th rowspan="2">% Asis</th></tr><tr>';

                    for ($i = 0; $i < $numero; $i++) {
                        $dateObj = DateTime::createFromFormat('Y-m-d', $nombreperiodo . "-" . $mes . "-" . ($i + 1));
                        $nombredia[$i] = strftime("%a", $dateObj->getTimestamp());
                        $html .= '<th>' . ($i + 1) . '</th>';

                    }


                    if (!empty($listadealumnos)) {
                        $asistenciaporalumno = array();
                        $asistenciaporcurso = array();

                        for ($i = 0; $i < $largoalumnos; $i++) {
                            $asistenciaporalumno[$i] = 0;
                            $html .= '</tr><tr><td>' . ($i + 1) . '</td><td style="text-align: left">' . $listadealumnos[$i]["apaterno"] . ' ' . $listadealumnos[$i]["amaterno"] . ' ' . $listadealumnos[$i]["nombres"] . '</td>';

                            for ($j = 0; $j < $numero; $j++) {


                                $html .= '<td>';

                                if ($largodatos != 0) {
                                    for ($z = 0; $z < $largodatos; $z++) {

                                        $timestamp = strtotime($datos[$z]['fechaAsistencia']);
                                        $valordia = date("j", $timestamp);


                                        if ($j + 1 == intval($valordia)) {
                                            $datosvalores = $modeloasistencia->getvaloresasistencia($datos[$z]['idAsistencia'], $listadealumnos[$i]['idAlumnos']);
                                            if ($datosvalores[0]['valor'] == 2) {//Presente

                                                $html .= '&bull;';
                                                //Guardamos el valor por alumno de los dias presentes en el mes
                                                $asistenciaporalumno[$i] += 1;
                                                $asistenciaporcurso[$j] += 1;

                                            } elseif ($datosvalores[0]['valor'] == 1) {// Asusente

                                                $html .= 'x';

                                            }


                                        }
                                    }
                                }
                                $html .= '</td>';
                            }
                            //Creamos el porcentaje de Asistencia

                            if ($largodatos > 0 && $asistenciaporalumno[$i] > 0) {
                                $diasin = $largodatos - $asistenciaporalumno[$i];

                                if ($diasin != 0 && $largodatos > 0) {
                                    $valorf = $diasin / $largodatos;
                                    $auxf = 1 - $valorf;
                                    $totalf = $auxf * 100;
                                } elseif (($diasin == 0 || $diasin == '') && $largodatos > 0) {
                                    $valorf = $diasin / $largodatos;
                                    $auxf = 1 - $valorf;
                                    $totalf = $auxf * 100;
                                } else {
                                    $totalf = 0;
                                }


                            } else {
                                $totalf = 0;
                            }
                            $html .= '<td>' . $largodatos . '</td><td>' . $asistenciaporalumno[$i] . '</td><td>' . $diasin . '</td><td>' . round($totalf) . '%</td>';

                        }


                        $html .= '</tr>';

                        //Total Alumnos
                        $html .= '<tr><td colspan="2">Total Alumnos</td>';

                        for ($j = 0; $j < $numero; $j++) {
                            if ($asistenciaporcurso[$j]) {
                                $html .= '<td>' . $largoalumnos . '</td>';

                            } else {
                                $html .= '<td></td>';
                            }
                        }


                        $html .= '<td colspan="4" rowspan="5"></td></tr>';

                        //Total Asistencia por dia
                        $html .= '<tr><td colspan="2">Total Asistencia </td>';

                        for ($j = 0; $j < $numero; $j++) {
                            if ($asistenciaporcurso[$j]) {
                                $html .= '<td>' . $asistenciaporcurso[$j] . '</td>';

                            } else {
                                $html .= '<td></td>';
                            }
                        }
                    }

                    $html .= '</tr>';


                    //Total Inasistencia por dia

                    $html .= '<tr><td colspan="2">Total Inasistencia</td>';

                    for ($j = 0; $j < $numero; $j++) {
                        if ($asistenciaporcurso[$j]) {
                            $html .= '<td>' . ($largoalumnos - $asistenciaporcurso[$j]) . '</td>';

                        } else {
                            $html .= '<td></td>';
                        }
                    }


                    $html .= '</tr>';


                    //Total % Asistencia por dia

                    $html .= '<tr><td colspan="2">Total % Asistencia</td>';

                    for ($j = 0; $j < $numero; $j++) {
                        if ($asistenciaporcurso[$j]) {

                            if ($largoalumnos > 0 && $asistenciaporcurso[$j] > 0) {
                                $diasin = $largoalumnos - $asistenciaporcurso[$j];

                                if ($diasin != 0 && $largoalumnos > 0) {
                                    $valorf = $diasin / $largoalumnos;
                                    $auxf = 1 - $valorf;
                                    $totalf = $auxf * 100;
                                } elseif (($diasin == 0 || $diasin == '') && $largoalumnos > 0) {
                                    $valorf = $diasin / $largoalumnos;
                                    $auxf = 1 - $valorf;
                                    $totalf = $auxf * 100;
                                } else {
                                    $totalf = 0;
                                }


                            } else {
                                $totalf = 0;
                            }
                            $html .= '<td>' . round($totalf) . '%</td>';

                        } else {
                            $html .= '<td></td>';
                        }
                    }


                    $html .= '</tr>';


                    //Total % Insistencia por dia

                    $html .= '<tr><td colspan="2">Total % Inasistencia</td>';

                    for ($j = 0; $j < $numero; $j++) {
                        if ($asistenciaporcurso[$j]) {

                            if ($largoalumnos > 0 && $asistenciaporcurso[$j] > 0) {
                                $diasin = $largoalumnos - $asistenciaporcurso[$j];

                                if ($diasin != 0 && $largoalumnos > 0) {
                                    $totalf = ($diasin * 100) / $largoalumnos;
                                } elseif (($diasin == 0 || $diasin == '') && $largoalumnos > 0) {
                                    $totalf = ($diasin * 100) / $largoalumnos;
                                } else {
                                    $totalf = 0;
                                }


                            } else {
                                $totalf = 0;
                            }
                            $html .= '<td>' . round($totalf) . '%</td>';

                        } else {
                            $html .= '<td></td>';
                        }
                    }


                    $html .= '</tr>';
                    $html .= '</table>';
                }


            } else {
                $idcurso = $form->getValue('idCursos');
                $form->idCursos->setValue($idcurso);

                $form->populate($formData);
            }


            //Enviamos a la funcion que genera los archivos
            if (!empty($html)) {
                if (!empty($pdf)) {
                    $this->generardocumentoAction($html, 1);
                } elseif (!empty($excel)) {
                    $this->generardocumentoAction($html, 2);
                }

            }


        }
    }

    public function indexasistenciaalumnoAction()
    {
        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $periodos = new Zend_Session_Namespace('nombreperiodo');
        $nombreperiodo = $periodos->nombreperiodo;

        //$this->view->title = "Generar Informe Asistencia Alumno";
        $this->view->headTitle($this->view->title);
        $form = new Application_Form_AsistenciaGeneraAlumno();

        $form->pdf->setLabel('Generar');
        $this->view->form = $form;
        if ($this->getRequest()->isPost()) {
            $formData = $this->getRequest()->getPost();
            if ($form->isValid($formData)) {
                $idcurso = $form->getValue('idCursos');
                $idalumno = $form->getValue('idAlumnos');
                $fechainicio = $form->getValue('fechai');
                $fechatermino = $form->getValue('fechat');

                //Cambiamos el formato de las fechas

                $fechainicio = date("Y-m-d", strtotime($fechainicio));
                $fechatermino = date("Y-m-d", strtotime($fechatermino));

                //Obtenemos los dias de Asistencia del alumno de acuerdo al rango de dias seleccionados


                $modeloasistencia = new Application_Model_DbTable_Asistencia();
                $modelocurso = new Application_Model_DbTable_Cursos();
                $datoscurso = $modelocurso->listarcursoid($idcurso, $idperiodo);
                $datosasistencia = $modeloasistencia->getasistenciaalumno($idalumno, $idcurso, $fechainicio, $fechatermino, $idperiodo);
                $largoasistencia = count($datosasistencia);
                $diasas = 0;
                $diasinasistencia = 0;

                foreach ($datosasistencia as $a) {


                    if ($a['valor'] == 2) { //Presente

                        $diasas += 1;

                    } else {
                        $diasinasistencia += 1;
                    }


                }


                if (count($datosasistencia) == 0) {

                    echo "<script type=\"text/javascript\">alert(\"No existen datos registrados para el alumno en el rango de fechas seleccionadas\");</script>";
                    echo "<script>parent.$.fancybox.close();</script>";
                    echo "<script>window.close();</script>";
                    exit;

                } else {


                    //Estilo pdf
                    $style = "body{
                font:11px ,Arial, Tahoma, Verdana, Helvetica, sans-serif;
                color:#000;
                }
                img{
                width:90px;
                height:100px;
                }
                
                table{
                font-size:11px;
                width:100%;
                height:auto;
                margin:10px 0 10px 0;
                border-collapse:collapse;
                text-align:center;
                text-justify:inter-word;
                color:#000000;
                }
                
                table td,th{
                border:1px solid black;
               
                }
                
                table th{
                padding:1px;
                background-color: #ccc;
                }
                
                table td{
                text-align:left;
                padding:5px;
                }
                .centrar{
                width:20%;
                text-align: center;
                }
                ";

                    // Modelos a utilizar
                    $modelcurso = new Application_Model_DbTable_Cursos();
                    $modelalumno = new Application_Model_DbTable_Alumnosactual();
                    $modelCuenta = new Application_Model_DbTable_Cuentas();


                    $cargo = new Zend_Session_Namespace('cargo');
                    $rol = $cargo->cargo;
                    //Si es Administrador o Director
                    if ($rol == 1 || $rol == 2 || $rol == 3 || $rol == 6) {

                        $datoscurso = $modelcurso->listarcursoid($idcurso, $idperiodo);

                        $lista = $modelalumno->getactual($idalumno, $idperiodo);

                        $comuna = new Application_Model_DbTable_Comuna();
                        $datoscomuna = $comuna->getcomunasolo($lista[0]['comuna']);
                        $nombrecomuna = $datoscomuna[0]['nombreComuna'];


                        $caracteres = array(",", ".", "-");
                        $rutset = str_replace($caracteres, "", $lista[0]['rutAlumno']);


                        if (!empty($rutset)) {

                            $rest = substr($rutset, 0, -1);
                            $ultimo = substr($rutset, -1);
                            $formatomiles = number_format($rest, 0, "", ".");
                            $formatofinal = $formatomiles . '-' . $ultimo;

                        }

                        setlocale(LC_TIME, "es_ES");

                        $date = date_create($lista[0]['fechanacimiento']);

                        $fechanacimiento = strftime("%d de %B del %Y", $date->getTimestamp());


                        if (!empty($datoscurso[0]['idCuentaJefe']) || $datoscurso[0]['idCuentaJefe'] > 0) {
                            $Profesorjefe = $modelCuenta->getusuario($datoscurso[0]['idCuentaJefe'], $idperiodo);
                        } else {
                            $Profesorjefe = 0;
                        }


                        if (count($Profesorjefe) == 0 || $Profesorjefe == null) {
                            echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta Profesor Jefe\");</script>";
                            echo "<script>parent.$.fancybox.close();</script>";
                            exit;
                        }


                        $tituloest = "<b>" . $datoscurso[0]['nombreEstablecimiento'] . "</b>";
                        $titulo = "Informe de Asistencia Alumno ";
                        $logo = getcwd();
                        $logo .= "/application/documentos/logos/" . $datoscurso[0]['extension'];
                        if (file_exists($logo)) {
                            $plogo = '<p style="position:absolute;top:2px;text-align:center"><img  src="' . $logo . '" /></p>';
                        } else {
                            $plogo = '';
                        }
                        $encabezado = $plogo . '<h4 style="position:absolute;top:120px;text-align:center">' . $tituloest . '</h4><h4 style="position:absolute;top:140px;text-align:center">' . $titulo . '</h4>';
                        $html = $encabezado;

                        //Transformamos la fecha

                        $fechadesde = date_create($fechainicio);
                        $fechahasta = date_create($fechatermino);

                        $desde = strftime("%d de %B del %Y", $fechadesde->getTimestamp());
                        $hasta = strftime("%d de %B del %Y", $fechahasta->getTimestamp());


                        $html .= '
                                <table width=100% align="center" class="antecedentes" style="width:100%">
                                <tr>
                                <td colspan="8" style="width:100%;text-align:center;border: 0px;border-bottom: 1px solid; border-collapse: collapse;font-weight:bold;">ANTECEDENTES DEL ALUMNO</td>
                                </tr>
                                  <tr>
                                    <td><b>Nombre Alumno:</b> ' . strtr(strtoupper($lista[0]['nombres']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . ' ' . strtr(strtoupper($lista[0]['apaterno']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . ' ' . strtr(strtoupper($lista[0]['amaterno']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . '</td>
                                    <td><b>Rut:</b> ' . $formatofinal . '</td>   
                                  </tr>
                                  <tr>
                                    <td><b>Fecha Nacimiento:</b> ' . $fechanacimiento . '</td>
                                    <td><b>Curso:</b> ' . $datoscurso[0]['nombreGrado'] . ' ' . $datoscurso[0]['letra'] . '</td>
                                  </tr>
                                  
                                  <tr>
                                    <td><b>Domicilio:</b> ' . $lista[0]['direccion'] . ' </td>
                                    <td><b>Comuna:</b> ' . $nombrecomuna . '</td>
                                  </tr>
                                    
                                </table>';


                        $html .= '<table><tr>
                                <td colspan="8" style="width:100%;text-align:center;border: 0px;border-bottom: 1px solid; border-collapse: collapse;font-weight:bold;">ASISTENCIA</td>
                                </tr>
                                <tr>
                                    <td colspan="5" style="text-align: center;"><b>Rango de Fechas</b></td>
                                    
                                  </tr> 
                                  <tr>
                                    <td colspan="2"><b>Fecha Desde:</b> ' . $desde . ' </td>
                                    <td colspan="3"><b>Fecha Hasta:</b> ' . $hasta . '</td>
                                  </tr>
                                <tr>
                                <th>Dias Trabajados Rango</th>
                                <th>Días Asistencia</th>
                                <th>Días Inasistencia</th>
                                <th>% Asistencia</th>
                                <th>% Inasistencia</th>
                                </tr>';


                        //$date = date_create($lista[$i]['fechaObservacion']);

                        //$lista[$i]['fechaObservacion'] = strftime("%d de %B del %Y", $date->getTimestamp());

                        //$diasinasistencia=$largoasistencia-$diasas;

                        $pocentajeasistencia = ($diasas * 100) / $largoasistencia;
                        $pocentajeinasistencia = ($diasinasistencia * 100) / $largoasistencia;


                        $html .= '<tr><td class="centrar">' . $largoasistencia . '</td><td class="centrar">' . $diasas . '</td><td class="centrar">' . $diasinasistencia . '</td><td class="centrar">' . $pocentajeasistencia . '%</td><td class="centrar">' . $pocentajeinasistencia . '%</td></tr>';


                        $html .= '</table>';
                        //$html .= '<div class="center col-lg-12"><div class="col-lg-4">Total Dias Trabajos : ' . (int)$largoasistencia . '</div><div class="col-lg-4">Total Días Asistencia : ' . (int)$diasas . '</div><div class="col-lg-4">Total Días Inasistencia :' . ($largoasistencia - $diasas) . '</div></div>';


                        $tdnombreprofesor = "<p style='text-decoration:underline;margin-left:30px;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</p>";
                        $tdprofesor = "Profesor(a) Jefe.";


                        $content = '
                        <!doctype html>
                        <html>
                        <head>
                            <style>' . $style . '</style>
                        </head>
                        <body>'
                            . $encabezado
                            . $html . '<page_footer>
                        <table class="page_footer">
                <table align="center" style="margin-top:25px;" class="page_firmas">
                        <tr>
                            <td style="width: 33%; text-align: center;border:none;">' . $tdnombreprofesor . '</td>
                            <td style="width: 33%; text-align: center;border:none;"></td>
                            <td style="width: 33%; text-align: center;border:none;"></td>
                        </tr>
                        <tr>
                            <td style="width: 33%; text-align:center;border:none;padding-top:35px">' . $tdprofesor . '</td>
                            <td style="width: 33%; text-align: center;border:none;padding-top:35px"></td>
                            <td style="width: 33%; text-align:center;border:none;padding-top:35px"></td>
                        </tr>
                        </table>
                        </table>
                    </page_footer>
                </body>
                    </html>';

                        // var_dump($content);


                        if ($content != '') {
                            // ob_start();

                            echo '<page>' . $content . '</page>';

                            //Añadimos la extensión del archivo. Si está vacío el nombre lo creamos
                            //$path!='' ? $path .='.pdf' : $path = crearNombre(10);

                            $content = ob_get_clean();
                            require 'fpdf/html2pdf.class.php';
                            try {
                                //Orientación / formato del pdf y el idioma.
                                $pdf = new HTML2PDF('P', 'LETTER', 'es', array(10, 10, 10, 10) /*márgenes*/); //los márgenes también pueden definirse en <page> ver documentación

                                $pdf->WriteHTML($content);
                                if (preg_match("/MSIE/i", $_SERVER["HTTP_USER_AGENT"])) {
                                    header("Content-type: application/PDF");
                                } else {
                                    header("Content-type: application/PDF");
                                    header("Content-Type: application/pdf");
                                }

                                $pdf->Output('Planilla ' . $datoscurso[0]['nombreGrado'] . ' ' . $datoscurso[0]['letra'] . '.pdf', I);
                            } catch (HTML2PDF_exception $e) {
                                echo $e;
                            }
                        }
                    }


                }//fin else


            } else {
                $idcurso = $form->getValue('idCursos');
                $form->idCursos->setValue($idcurso);

                $form->populate($formData);
            }


            //Enviamos a la funcion que genera los archivos
//            if (!empty($html)) {
//                if (!empty($pdf)) {
//                    $this->generardocumentoAction($html, 1);
//                } elseif (!empty($excel)) {
//                    $this->generardocumentoAction($html, 2);
//                }
//
//            }


        }


    }


    public function generardocumentoAction($html, $tipo)
    {
        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();

        $style = "body{
font:12px ,Arial, Tahoma, Verdana, Helvetica, sans-serif;

color:#000;
}
img{
  width:60px;
  height:70px;
}


table{
font-size:10px;
width:100%;
height:auto;
margin:10px 0 10px 0;
border-collapse:collapse;
text-align:center;
text-justify:inter-word;
color:#000000;
}

table td,th{
border:1px solid black;
}

table th{
padding:1px;
background-color: #ccc;
}
";

        if ($tipo == 1) {
            if ($html != '') {


                $content = '
                        <!doctype html>
                        <html>
                        <head>
                            <style>' . $style . '</style>
                        </head>
                        <body>'
                    . $html . '<page_footer>
                        <table class="page_footer">
              
                        </table>
                    </page_footer>
                </body>
                    </html>';

                if ($content != '') {
                    // ob_start();

                    echo '<page>' . $content . '</page>';

                    //Añadimos la extensión del archivo. Si está vacío el nombre lo creamos
                    //$path!='' ? $path .='.pdf' : $path = crearNombre(10);

                    $content = ob_get_clean();
                    require 'fpdf/html2pdf.class.php';
                    try {
                        //Orientación / formato del pdf y el idioma.
                        $pdf = new HTML2PDF('L', 'A4', 'es', array(10, 10, 10, 10), 'UTF-8' /*márgenes*/); //los márgenes también pueden definirse en <page> ver documentación

                        $pdf->WriteHTML($content);
                        if (preg_match("/MSIE/i", $_SERVER["HTTP_USER_AGENT"])) {
                            header("Content-type: application/PDF");
                        } else {
                            header("Content-type: application/PDF");
                            header("Content-Type: application/pdf");
                        }

                        $pdf->Output('Planilla.pdf', I);
                    } catch (HTML2PDF_exception $e) {
                        echo $e;
                    }
                }
            }
        } else {


            $filename = "Informe Asistencia Curso " . strftime("%A %d de %B del %Y") . "";
            $tmpfile = tempnam(sys_get_temp_dir(), 'html');
            file_put_contents($tmpfile, $html);

            $reader = new \PhpOffice\PhpSpreadsheet\Reader\Html();
            $spreadsheet = $reader->load($tmpfile);
            $writer = new \PhpOffice\PhpSpreadsheet\Writer\Xlsx($spreadsheet);
            $writer->save('export.xlsx');
            header('Content-Type: application/vnd.ms-excel');
            header('Content-Disposition: attachment; filename="' . $filename . '.xlsx"');
            $writer->save("php://output");
            unlink($tmpfile); // delete temporary file because it isn't needed anymore
            exit;


        }
    }

    public function getalumnosAction()
    {

        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $idcurso = $this->_getParam('id');

        if ($idcurso > 0) {
            $modelModelo = new Application_Model_DbTable_Alumnosactual();
            $results = $modelModelo->listaralumnoscursoselect($idcurso, $idperiodo);
        }
        $this->_helper->json($results);


    }

    public function getalumnoAction()
    {
        $modeloalumnoactual = new Application_Model_DbTable_Alumnosactual();
        $id = $this->_getParam('id');
        if ($id > 0) {
            $periodo = new Zend_Session_Namespace('periodo');
            $idperiodo = $periodo->periodo;

            $results = $modeloalumnoactual->getactualdatos($id, $idperiodo);
            $this->_helper->json($results);
        } else {
            $this->_helper->json(array());
        }

    }


    public function indexobservacionalumnoAction()
    {

        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $est = new Zend_Session_Namespace('establecimiento');
        $idestablecimiento = $est->establecimiento;

        $usuario = new Zend_Session_Namespace('id');
        $user = $usuario->id;

        $cargo = new Zend_Session_Namespace('cargo');
        $rol = $cargo->cargo;

        $cryptor = new \Chirp\Cryptor();

        $modelalumnos = new Application_Model_DbTable_Alumnos();
        $modelcurso = new Application_Model_DbTable_Cursos();

        if ($rol == '2') {
            $detallecurso = $modelcurso->getcursocuentaestablecimiento($user, $idestablecimiento, $idperiodo);
            if (count($detallecurso) > 1) {
                for ($i = 0; $i < count($detallecurso); $i++) {
                    $lista[$i] = $modelalumnos->listarusuario($idperiodo, $detallecurso[$i]['idCursos']);
                    //$lista[$i]['idAlumnos'] = $cryptor->encrypt($lista[$i]['idAlumnos']);

                    for ($j = 0; $j < count($lista[$i]); $j++) {
                        $lista[$i][$j]['idAlumnos'] = $cryptor->encrypt($lista[$i][$j]['idAlumnos']);

                    }

                }


                $this->view->variable = 1;
                $this->view->datos = $lista;

            } else {

                if (!empty($detallecurso[0]['idCursos'])) {

                    $lista = $modelalumnos->listarusuario($idperiodo, $detallecurso[0]['idCursos']);
                    $lista[0]['idAlumnos'] = $cryptor->encrypt($lista[0]['idAlumnos']);
                    $this->view->variable = 0;
                    $this->view->datos = $lista;
                }

            }

        }
        if ($rol == '1') {

            $lista = $modelalumnos->listar($idperiodo);
            for ($i = 0; $i < count($lista); $i++) {
                $lista[$i]['idAlumnos'] = $cryptor->encrypt($lista[$i]['idAlumnos']);

            }
            $this->view->datos = $lista;

        }

        if ($rol == '3' || $rol == '6') {

            $lista = $modelalumnos->listarestablecimiento($idestablecimiento, $idperiodo);
            for ($i = 0; $i < count($lista); $i++) {
                $lista[$i]['idAlumnos'] = $cryptor->encrypt($lista[$i]['idAlumnos']);

            }
            $this->view->datos = $lista;

        }

    }


    public function indexaccidenteAction()
    {

        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $est = new Zend_Session_Namespace('establecimiento');
        $idestablecimiento = $est->establecimiento;

        $usuario = new Zend_Session_Namespace('id');
        $user = $usuario->id;

        $cargo = new Zend_Session_Namespace('cargo');
        $rol = $cargo->cargo;

        $modeloaccidente = new Application_Model_DbTable_Accidente();
        if ($rol == 2) {

            $datos = $modeloaccidente->listardocente($user, $idestablecimiento, $idperiodo);
            $this->view->datos = $datos;


        }

        if ($rol == 3 || $rol == 4 || $rol == 6) {

            $datos = $modeloaccidente->listarestablecimiento($idestablecimiento, $idperiodo);
            $this->view->datos = $datos;


        }
        if ($rol == 1) {

            $datos = $modeloaccidente->listar($idperiodo);
            $this->view->datos = $datos;


        }


    }

    public function nuevoaccidenteAction()
    {
        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $periodos = new Zend_Session_Namespace('nombreperiodo');
        $nombreperiodo = $periodos->nombreperiodo;

        $usuario = new Zend_Session_Namespace('id');
        $user = $usuario->id;

        $this->view->headTitle($this->view->title);
        $form = new Application_Form_Accidente();
        $this->view->form = $form;


    }

    public function guardaraccidenteAction()
    {
        if ($this->getRequest()->isXmlHttpRequest()) {
            //Detectamos si es una llamada AJAX
            $this->_helper->viewRenderer->setNoRender();
            $this->_helper->layout->disableLayout();
            $json = file_get_contents('php://input');
            $data = json_decode($json, true);

            $periodo = new Zend_Session_Namespace('periodo');
            $idperiodo = $periodo->periodo;

            $usuario = new Zend_Session_Namespace('id');
            $user = $usuario->id;

            $rutusuario = new Zend_Session_Namespace('id');
            $usuario = $rutusuario->id;
            if (empty($usuario)) {
                die(json_encode(["response" => 0, "status" => "1"]));
            } else {

                //Modelos a utilizar
                $modeloaccidente = new Application_Model_DbTable_Accidente();


                $idcurso = $data['idCursos'];
                $idalumno = $data['idAlumnos'];
                $fechaaccidente = $data['fechaAccidente'];
                $horario = $data['horarioAccidente'];
                $ubicacion = $data['ubicacionAccidente'];
                $testigouno = $data['nombreTestigo'];
                //$ruttestigouno = $data['rutTestigo'];

                $caracteres = array(",", ".", "-");

                $ruttestigouno = trim($data['rutTestigo']);
                $ruttestigouno = str_replace($caracteres, "", $ruttestigouno);
                $testigodos = $data['nombreTestigodos'];

                $ruttestigodos = trim($data['rutTestigodos']);
                $ruttestigodos = str_replace($caracteres, "", $ruttestigodos);
                $descripcion = $data['descripcionAccidente'];

                //Datos Alumnos

                $calle = $data['calle'];
                $numerocasa = $data['numeroCasa'];
                $villa = $data['villa'];
                $ciudadactual = $data['ciudadActual'];


                if (empty($idcurso) || empty($idalumno) || empty($fechaaccidente) || empty($horario) || empty($ubicacion) || empty($descripcion) || empty($calle) || empty($numerocasa) || empty($villa) || empty($ciudadactual)) {
                    die(json_encode(["response" => 0, "status" => "3"]));
                }
                $db = Zend_Db_Table_Abstract::getDefaultAdapter();
                $db->beginTransaction();
                $format = 'Y-m-d H:i';
                $date = DateTime::createFromFormat($format, date("Y-m-d", strtotime($fechaaccidente)) . ' ' . $horario);
                $fechaaccidente = $date->format('Y-m-d H:i:s');

                //Fecha Registro

                //Guardamos cuando es nuevo
                $dates = new DateTime;
                $fecharegistro = $dates->format('Y-m-d H:i:s');


                $modeloaccidente = new Application_Model_DbTable_Accidente();
                $modeloalumnoactual = new Application_Model_DbTable_Alumnosactual();
                //Obtenemos los Datos del Alumno


                try {
                    $datosalumno = $modeloalumnoactual->getactual($idalumno, $idperiodo);

                    if (!empty($datosalumno)) {


                        $idestablecimiento = $datosalumno[0]['idEstablecimiento'];
                        $datosaccidente = $modeloaccidente->ultimo($idestablecimiento, $idperiodo);
                        $numero = $datosaccidente[0]['max'] + 1;
                        $modeloaccidente->agregar($fechaaccidente, $fecharegistro, $ubicacion, $numero, $descripcion, $idalumno, $idperiodo, $idestablecimiento, $user);
                        $idaccidente = $modeloaccidente->getAdapter()->lastInsertId();
                        if ($ubicacion == 1) {
                            //Agregamos los Datos de Testigos
                            if (!empty($testigouno) && !empty($ruttestigouno)) {
                                $modeloaccidente->agregartestigo($testigouno, $ruttestigouno, $idaccidente);

                            } elseif ((!empty($testigouno) && empty($ruttestigouno)) || (empty($testigouno) && !empty($ruttestigouno))) {
                                die(json_encode(["response" => 0, "status" => "4"]));
                            }
                            if (!empty($testigodos) && !empty($ruttestigodos)) {
                                $modeloaccidente->agregartestigo($testigodos, $ruttestigodos, $idaccidente);


                            } elseif ((!empty($testigodos) && empty($ruttestigodos)) || (empty($testigodos) && !empty($ruttestigodos))) {
                                die(json_encode(["response" => 0, "status" => "4"]));
                            }

                        }
                        //Actualizamos la Direccion del alumno
                        $modeloalumnoactual->actualizardireccion($idalumno, $idperiodo, $idcurso, $calle, $numerocasa, $villa, $ciudadactual);
                        $db->commit();
                        $pag = $this->_request->getBaseUrl() . ('/Informes/certificadoaccidente/id/' . $idaccidente);
                        die(json_encode(["response" => 1, "url" => $pag]));


                    } else {
                        $db->rollBack();
                        die(json_encode(["response" => 0, "status" => "2"]));
                    }


                } catch (Exception $e) {

                    // Si hubo problemas. Enviamos todo marcha atras
                    $db->rollBack();
                    echo $e;
                    die(json_encode(["response" => 0, "status" => "2"]));
                }

            }


        }
    }

    public function certificadoaccidenteAction()
    {
        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $periodos = new Zend_Session_Namespace('nombreperiodo');
        $nombreperiodo = $periodos->nombreperiodo;

        $idaccidente = $this->_request->getParam('id');
        if ($idaccidente > 0) {


            $modeloaccidente = new Application_Model_DbTable_Accidente();
            $modeloestablecimiento = new Application_Model_DbTable_Establecimiento();

            $datosaccidente = $modeloaccidente->getaccidente($idaccidente, $idperiodo);
            $datosestablecimiento = $modeloestablecimiento->get($datosaccidente[0]['idEstablecimiento']);


            if (count($datosaccidente) == 0) {

                echo "<script type=\"text/javascript\">alert(\"No existen datos\");</script>";
                echo "<script>parent.$.fancybox.close();</script>";
                echo "<script>window.close();</script>";
                exit;

            } else {


                //Estilo pdf
                $style = "body{
                font:11px ,Arial, Tahoma, Verdana, Helvetica, sans-serif;
                color:#000;
                }
                img{
                width:90px;
                height:95px;
                }
                
                table{
                font-size:11px;
                width:100%;
                height:auto;
                margin:5px 0 10px 0;
                border-collapse:collapse;
                text-align:center;
                text-justify:inter-word;
                color:#000000;
                }
                
                table td,th{
                border:1px solid black;
               
                }
                
                table th{
                padding:1px;
                background-color: #ccc;
                }
                
                table td{
                text-align:left;
                padding:5px;
                }
                .centrar{
                width:20%;
                text-align: center;
                }
                #div_top {
                display:inline;      
                }
                #ul_top li{
                    display: inline;
                }
                ";

                // Modelos a utilizar
                $modelcurso = new Application_Model_DbTable_Cursos();
                $modelalumno = new Application_Model_DbTable_Alumnosactual();
                $modelCuenta = new Application_Model_DbTable_Cuentas();


                $cargo = new Zend_Session_Namespace('cargo');
                $rol = $cargo->cargo;
                //Si es Administrador o Director
                if ($rol == 1 || $rol == 2 || $rol == 3 || $rol == 6) {

                    $datoscurso = $modelcurso->listarcursoid($datosaccidente[0]['idCursos'], $idperiodo);

                    $lista = $modelalumno->getactual($datosaccidente[0]['idAlumnos'], $idperiodo);

                    $comuna = new Application_Model_DbTable_Comuna();

                    //Comuna Alumno
                    $datoscomuna = $comuna->getcomunasolo($lista[0]['comuna']);
                    $nombrecomuna = $datoscomuna[0]['nombreComuna'];

                    //Comuna Establecimiento

                    $datoscomunaest = $comuna->getcomunasolo($datosestablecimiento[0]['comuna']);
                    $nombrecomunaest = $datoscomunaest[0]['nombreComuna'];


                    $caracteres = array(",", ".", "-");
                    $rutset = str_replace($caracteres, "", $lista[0]['rutAlumno']);


                    if (!empty($rutset)) {

                        $rest = substr($rutset, 0, -1);
                        $ultimo = substr($rutset, -1);
                        $formatomiles = number_format($rest, 0, "", ".");
                        $formatofinal = $formatomiles . '-' . $ultimo;

                    }

                    setlocale(LC_TIME, "es_ES");

                    $date = date_create($lista[0]['fechanacimiento']);
                    $fechanacimiento = strftime("%d de %B del %Y", $date->getTimestamp());


                    $nombretestigouno = "";
                    $ruttestigouno = "";
                    $nombretestigodos = "";
                    $ruttestigodos = "";

                    if ($datosaccidente[0]['tipoAccidente'] == 1) {
                        $datostestigo = $modeloaccidente->gettestigos($idaccidente);
                        //Testigo 1
                        $nombretestigouno = $datostestigo[0]['nombreTestigo'];
                        $ruttestigouno = $datostestigo[0]['rutTestigo'];
                        $nombretestigodos = $datostestigo[1]['nombreTestigo'];
                        $ruttestigodos = $datostestigo[1]['rutTestigo'];
                        if (!empty($ruttestigouno)) {

                            $rest = substr($ruttestigouno, 0, -1);
                            $ultimo = substr($ruttestigouno, -1);
                            $formatomiles = number_format($rest, 0, "", ".");
                            $ruttestigouno = $formatomiles . '-' . $ultimo;

                        }

                        if (!empty($ruttestigodos)) {

                            $rest = substr($ruttestigodos, 0, -1);
                            $ultimo = substr($ruttestigodos, -1);
                            $formatomiles = number_format($rest, 0, "", ".");
                            $ruttestigodos = $formatomiles . '-' . $ultimo;

                        }


                    }


                    $tituloest = "<b>" . $datoscurso[0]['nombreEstablecimiento'] . "</b>";
                    $titulo = "DECLARACION INDIVIDUAL DE ACCIDENTE ESCOLAR ";
                    $logo = getcwd();
                    $logo .= "/application/documentos/logos/" . $datoscurso[0]['extension'];
                    if (file_exists($logo)) {
                        $plogo = '<p style="position:absolute;top:2px;text-align:left"><img  src="' . $logo . '" /></p>';
                    } else {
                        $plogo = '';
                    }
                    $encabezado = $plogo . '<h4 style="position:absolute;top:50px;text-align:center">' . $tituloest . '</h4><h5 style="position:absolute;top:80px;text-align:center">' . $titulo . '</h5><h5 style="position:absolute;top:110px; text-align: right; padding-right: 100px">Nº ' . $datosaccidente[0]['numeroAccidente'] . '</h5>';
                    $html = $encabezado;

                    //Calcular Años del Alumno

                    $edad = date_diff(date_create($lista[0]['fechanacimiento']), date_create('today'))->y;

                    //Datos Alumno

                    $calle = strtr(strtoupper($lista[0]['calle']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ");
                    $villa = strtr(strtoupper($lista[0]['villa']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ");
                    $ciudadactual = strtr(strtoupper($lista[0]['ciudadActual']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ");
                    $numerocasa = $lista[0]['numeroCasa'];

                    $sexo = $lista[0]['sexo'];
                    if ($sexo == 1) {
                        $nombresexo = 2;


                    } else {
                        $nombresexo = 1;
                    }

                    $year = date("Y", strtotime($datosaccidente[0]['fechaAccidente']));
                    $month = date("m", strtotime($datosaccidente[0]['fechaAccidente']));
                    $day = date("d", strtotime($datosaccidente[0]['fechaAccidente']));
                    $horario = date("H:i", strtotime($datosaccidente[0]['fechaAccidente']));
                    //$fecha=date("Y-m-d", strtotime($datosaccidente[0]['fechaAccidente']));

                    $diasemana = date('N', strtotime($datosaccidente[0]['fechaAccidente']));
                    $tipoaccidente = $datosaccidente[0]['tipoAccidente'];
                    $html .= '<h5 style="position:absolute;top:110px;text-align:left">A. INDIVIDUALIZACION DEL ESTABLECIMIENTO</h5>';

                    $html .= '<table width=100% align="center" style="width:100%">
                                  <tr>
                                    <td style="width: 45%;"><b>Nombre Establecimiento:</b> ' . strtr(strtoupper($lista[0]['nombreEstablecimiento'])) . '</td>
                                    <td style="width: 20%;"><b>Ciudad:</b> ' . $nombrecomunaest . '</td> 
                                    <td style="width: 35%;"><b>Comuna:</b> ' . $nombrecomunaest . '</td>   
                                  </tr>
                                  <tr>
                                    <td><b>Curso:</b> ' . $datoscurso[0]['nombreGrado'] . ' ' . $datoscurso[0]['letra'] . '</td>
                                    <td><b>Horario:</b> Diurna</td>
                                    <td><b>Fecha de Registro:</b> ' . $fechanacimiento . '</td>
                                  </tr>  
                                </table>';


                    $html .= '<h5 style="position:absolute;top:200px;text-align:left">B. INDIVIDUALIZACION DEL ACCIDENTADO</h5>';

                    $html .= '<table width=100% align="center" class="antecedentes" style="width:100%">
                                  <tr>
                                    <td style="width: 30%;"><b>Apellido Paterno:</b> ' . strtr(strtoupper($lista[0]['apaterno']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . '</td>
                                    <td style="width: 30%;"><b>Apellido Materno:</b> ' . strtr(strtoupper($lista[0]['amaterno']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . '</td> 
                                    <td style="width: 40%;"><b>Nombres:</b> ' . strtr(strtoupper($lista[0]['nombres']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . '</td>   
                                  </tr>
                                  <tr>
                                    <td><b>Sexo M=1 F=2:</b> ' . $nombresexo . '</td>
                                    <td><b>Año Nacimiento:</b> ' . $fechanacimiento . '</td>
                                    <td><b>Edad:</b> ' . $edad . ' años</td>
                                  </tr> 
                                  <tr>
                                  <td colspan="3" style="width:100%;text-align:center;border: 0px;border-bottom: 1px solid; border-collapse: collapse;font-weight:bold;">RESIDENCIA HABITUAL</td>
                                  </tr> 
                                  <tr>
                                    
                                    <td><b>Calle:</b> ' . $calle . '</td>
                                    <td><b>Número:</b> ' . $numerocasa . '</td>
                                    <td><b>Poblacion/Villa:</b> ' . $villa . '</td>
                                  </tr>  
                                  <tr>
                                    <td><b>Comuna:</b> ' . $nombrecomuna . '</td>
                                    <td><b>Ciudad:</b> ' . $ciudadactual . '</td>
                                    <td><b>Codificación Comuna:</b></td>
                                  </tr> 
                                </table>';

                    $html .= '<h5 style="position:absolute;top:360px;text-align:left">C. INFORME SOBRE EL ACCIDENTE</h5>';

                    $html .= '<table width=100% align="center" class="antecedentes" style="width:100%">
                                  <tr>
                                    <td style="width: 40%;"><b>Hora del Accidente:</b> ' . $horario . '</td>
                                    <td style="width: 20%;"><b>Año:</b> ' . $year . '</td> 
                                    <td style="width: 20%;"><b>Mes:</b> ' . $month . '</td> 
                                    <td style="width: 20%;"><b>Día:</b> ' . $day . '</td>   
                                  </tr>
                                  <tr>
                                    <td colspan="2" style="width: 60%"><b>Día del Accidente: ' . $diasemana . '</b><br><br>Lunes=1&nbsp;Martes=2&nbsp;Miércoles=3&nbsp;Jueves=4&nbsp;Viernes=5&nbsp;Sábado=6&nbsp;Domingo=7</td>
                                    <td colspan="2" style="width: 40%;vertical-align: top" ><b>Accidente: ' . $tipoaccidente . '</b><br><br>De Trayecto=1&nbsp;&nbsp;En la Escuela=2</td> 
                                  </tr> 
                                  <tr>
                                    <td colspan="2" style="width: 60%;"><b>Nombre Testigo 1: </b> ' . strtr(strtoupper($nombretestigouno), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . '</td>
                                    <td colspan="2" style="width: 40%;"><b>RUT Testigo 1: </b>' . $ruttestigouno . ' </td> 
                                     
                                  </tr>
                                  
                                  <tr>
                                    <td colspan="2" style="width: 60%;"><b>Nombre Testigo 2: </b>' . strtr(strtoupper($nombretestigodos), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . '</td>
                                    <td colspan="2" style="width: 40%;"><b>RUT Testigo 2: </b>' . $ruttestigodos . ' </td> 
                                     
                                  </tr>
                                  
                                  <tr>
                                    <td colspan="2" style="vertical-align:top;width:60%;height: 160px; text-align:border:none; center;"><p><b>CIRCUNSTANCIA DEL ACCIDENTE</b>(DESCRIBA COMO OCURRIO-CAUSAL)</p><br><p style="text-align: left"><u>' . $datosaccidente[0]['descripcionAccidente'] . '</u></p></td>
                                    <td colspan="2" style=" vertical-align: bottom;width: 40%; text-align: center;border:none;"><p style="margin-left:30px;">FIRMA Y TIMBRE</p><hr><p>RECTOR O REPRESENTANTE</p></td>
                                </tr>
                                </table>';


//                    $html .= '<table width=100% align="center" style="width:100%">
//                        <tr>
//                            <td style="vertical-align:top;width: 65%;height: 120px; text-align:border:none; center;"><p><b>CIRCUNSTANCIA DEL ACCIDENTE</b>(DESCRIBA COMO OCURRIO-CAUSAL)</p><br><p style="text-align: left"><u>'.$datosaccidente[0]['descripcionAccidente'].'</u></p></td>
//                            <td style=" vertical-align: bottom;width: 35%; text-align: center;border:none;"><p style="margin-left:30px;">FIRMA Y TIMBRE</p><hr><p>RECTOR O REPRESENTANTE</p></td>
//                        </tr>
//
//                        </table>';


                    $imagen = getcwd();
                    $imagen .= "/application/documentos/resources/accidente.png";
                    if (file_exists($imagen)) {
                        $html .= '<p style="position:absolute;top:735px;text-align:left"><img style="width: 761px; height: 300px;" src="' . $imagen . '" /></p>';
                    } else {
                        echo "<script type=\"text/javascript\">alert(\"Error Imagen\");</script>";
                        echo "<script>parent.$.fancybox.close();</script>";
                        exit;
                    }


                    //$html .= '<tr><td class="centrar">' . $largoasistencia . '</td><td class="centrar">' . $diasas . '</td><td class="centrar">' . $diasinasistencia . '</td><td class="centrar">' . $pocentajeasistencia . '%</td><td class="centrar">' . $pocentajeinasistencia . '%</td></tr>';


                    //$html .= '</table>';


                    $content = '
                        <!doctype html>
                        <html>
                        <head>
                            <style>' . $style . '</style>
                        </head>
                        <body>'
                        . $encabezado
                        . $html . '
                </body>
                    </html>';


                    if ($content != '') {
                        // ob_start();

                        echo '<page>' . $content . '</page>';

                        //Añadimos la extensión del archivo. Si está vacío el nombre lo creamos
                        //$path!='' ? $path .='.pdf' : $path = crearNombre(10);

                        $content = ob_get_clean();
                        require 'fpdf/html2pdf.class.php';
                        try {
                            //Orientación / formato del pdf y el idioma.
                            $pdf = new HTML2PDF('P', 'A4', 'es', array(1, 1, 1, 1) /*márgenes*/); //los márgenes también pueden definirse en <page> ver documentación

                            $pdf->WriteHTML($content);
                            if (preg_match("/MSIE/i", $_SERVER["HTTP_USER_AGENT"])) {
                                header("Content-type: application/PDF");
                            } else {
                                header("Content-type: application/PDF");
                                header("Content-Type: application/pdf");
                            }

                            $pdf->Output('Planilla ' . $datoscurso[0]['nombreGrado'] . ' ' . $datoscurso[0]['letra'] . '.pdf', I);
                        } catch (HTML2PDF_exception $e) {
                            echo $e;
                        }
                    }
                }


            }//fin else

        } else {

            echo "<script type=\"text/javascript\">alert(\"No existen datos\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            echo "<script>window.close();</script>";
            exit;

        }


    }

    public function certificadomatriculasAction()
    {

        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $nivelcurso = new Zend_Session_Namespace('nivel_curso');
        $nivel_curso = $nivelcurso->nivel_curso;

        $est = new Zend_Session_Namespace('establecimiento');
        $idestablecimiento = $est->establecimiento;

        $usuario = new Zend_Session_Namespace('id');
        $user = $usuario->id;

        $cargo = new Zend_Session_Namespace('cargo');
        $rol = $cargo->cargo;

        $modelcurso = new Application_Model_DbTable_Cursos();

        $cuenta = $modelcurso->getcursocuentaestablecimiento($user, $idestablecimiento, $idperiodo);

        $modelalumnos = new Application_Model_DbTable_Alumnosactual();

        if ($rol == '2') {
            if (count($cuenta) > 1) {
                for ($i = 0; $i < count($cuenta); $i++) {
                    $lista[$i] = $modelalumnos->listaralumnoscurso($cuenta[$i]['idCursos'], $idperiodo);

                }
                $this->view->variable = 1;
                $this->view->datos = $lista;

            } else {

                if (!empty($cuenta[0]['idCursos'])) {

                    $lista = $modelalumnos->listaralumnoscurso($cuenta[0]['idCursos'], $idperiodo);
                }
                $this->view->variable = 0;
                $this->view->datos = $lista;
            }

        }
        if ($rol == '1') {

            $lista = $modelalumnos->listar($idperiodo);

            $this->view->datos = $lista;

        }
        if ($rol == '3' || $rol == '6') {

            $lista = $modelalumnos->listarestablecimiento($idestablecimiento, $idperiodo);

            $this->view->datos = $lista;

        }

    }

    public function generacertificadomatriculaAction()
    {

        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();

        $id = $this->_getParam('id', 0);

        $tabla = new Application_Model_DbTable_Alumnos();
        $modelCurso = new Application_Model_DbTable_Cursos();
        $tabla2 = $tabla->getcertificadoalumno($id);


        $comuna = new Application_Model_DbTable_Comuna();
        $rowset = $comuna->getcomunasolo($tabla2[0]['comuna']);

        $periodo = new Zend_Session_Namespace('nombreperiodo');
        $nombreperiodo = $periodo->nombreperiodo;

        $periodos = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodos->periodo;

        $rutset = $tabla2[0]['rutAlumno'];
        if (!empty($rutset)) {
            //echo strlen($rutset);
            $rest = substr($rutset, 0, -1);
            $ultimo = substr($rutset, -1);
            $formatomiles = number_format($rest, 0, "", ".");
            $formatofinal = $formatomiles . '-' . $ultimo;

        }

        if ($tabla2[0]['sexo'] == 1) {
            $nombresexo = "la alumna";

        } else {
            $nombresexo = "el alumno";
        }
        $date = new DateTime;
        $fechain = $date->format('Y-m-d');
        $cortado = explode("-", $fechain);
        $dias = array("Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado");
        $meses = array("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre");

        $fecha_final = $dias[date('w', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]))] . " " . $cortado[2] . " de " . $meses[date('n', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0])) - 1] . " del " . date('Y', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]));

        //Datos del Director

        $modelCuenta = new Application_Model_DbTable_Cuentas();
        $detalleest = $modelCurso->listarcursoid($tabla2[0]['idCursos'], $idperiodo);
        if (!empty($detalleest[0]['idDirector'])) {
            $director = $modelCuenta->get($detalleest[0]['idDirector']);
        } else {
            $director = array();
        }


        if (count($director) == 0) {
            echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta director\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            exit;

        }

        $logo = getcwd();
        $logo .= "/application/documentos/logos/" . $tabla2[0]['extension'];


        // variables para encabezado
        $titulo = "CERTIFICADO DE MATRICULA";
        $nombrecomuna = strtr(strtoupper($rowset[0]['nombreComuna']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ");
        $nombreestablecimiento = strtr(strtoupper($tabla2[0]['nombreEstablecimiento']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ");
        $nombreestablecimientom = strtr(strtolower($nombreestablecimiento), "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ", "àèìòùáéíóúçñäëïöü");

        $infoder = '<div id="infoizq"><p style="text-align:center;"><b>' . $nombreestablecimiento . '</b><br><span style="text-decoration:underline;"><b>' . $nombrecomuna . '</b></span></p></div>';

        if (file_exists($logo)) {
            $encabezado = '<img  src="' . $logo . '" />' . $infoder . '<h4 style="position:absolute;top:200px;text-align:center;text-decoration:underline;">' . $titulo . '</h4>';

        } else {
            $encabezado = '' . $infoder . '<h4 style="position:absolute;top:200px;text-align:center;text-decoration:underline;">' . $titulo . '</h4>';

        }
        $style = "body{
font:14px Arial, Tahoma, Verdana, Helvetica, sans-serif;

color:#000;
}

#infoizq{
position:absolute;
left:0px;
top:115px;
}

#infoder{
position:absolute;
right:0px;
top:60px;
font-size:10px;
text-justify:inter-word;
}

#infoder p{
margin-top:5px;
}
a h1{
font-size:35px;
color:#FFF;
}
img{
width:90px;
height:100px;
position:absolute;
top:20px;
left:60px;
}

table{
width:100%;
height:auto;
margin:25px 0 10px 0;
text-align:left;
color:#000000;

}

table td,th{
padding:6px;
}
 ";

        $nombredirector = strtr(strtoupper($director['nombrescuenta']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ");
        $apdirector = strtr(strtoupper($director['paternocuenta']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ");
        $amdirector = strtr(strtoupper($director['maternocuenta']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ");
        $nombrealumno = strtr(strtoupper($tabla2[0]['nombres']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ");
        $apalumno = strtr(strtoupper($tabla2[0]['apaterno']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ");
        $amalumno = strtr(strtoupper($tabla2[0]['amaterno']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ");
        $nombreniveles = strtr(strtoupper($detalleest[0]['nombreGrado'] . ' ' . $detalleest[0]['letra']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ");

        $html = "<table align='center'>
<tr>
    <td style='width:80%;'><p align=justify style='text-indent:1.5em;'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;El Director  que suscribe certifica que, " . $nombresexo . "<b> " . $nombrealumno . " " . $apalumno . " " . $amalumno . ", RUT: " . $formatofinal . "</b>,se encuentra matriculado(a) en <b>" . $nombreniveles . "</b> de " . $detalleest[0]['nombreTipoEnsenanza'] . " para el año escolar " . $nombreperiodo . ".</p></td>
</tr>
</table>
<div style='text-align:center; margin-top:190px;'><p><i><span style='text-decoration:underline;'>" . $nombredirector . " " . $apdirector . " " . $amdirector . "</span></i><br>Director " . ucwords($nombreestablecimientom) . "</p></div>

<div style='text-align:left; margin-top:90px;'><p>" . strtr(strtoupper($detalleest[0]['nombreComuna']), "àèìòùáéíóúçñäëïöü", "ÀÈÌÒÙÁÉÍÓÚÇÑÄËÏÖÜ") . ", " . $fecha_final . ".</p></div>";

        $content = '
        <!doctype html>
        <html>
        <head>
            <style>' . $style . '</style>
        </head>
        <body>  <page_footer>
        <table class="page_footer">

        </table>
    </page_footer>'
            . $encabezado
            . $html .
            '</body>
        </html>';

        //var_dump($content);


        if ($content != '') {

            echo '<page>' . $content . '</page>';

            $content = ob_get_clean();
            require 'fpdf/html2pdf.class.php';
            try {
                //Orientación / formato del pdf y el idioma.
                $pdf = new HTML2PDF('P', 'LETTER', 'es', array(10, 10, 10, 10) /*márgenes*/); //los márgenes también pueden definirse en <page> ver documentación

                $pdf->WriteHTML($content);
                if (preg_match("/MSIE/i", $_SERVER["HTTP_USER_AGENT"])) {
                    header("Content-type: application/PDF");
                } else {
                    header("Content-type: application/PDF");
                    header("Content-Type: application/pdf");
                }

                $pdf->Output('Certificado_Matricula.pdf', I);
            } catch (HTML2PDF_exception $e) {
                echo $e;
            }
        }

    }

    public function adjuntarcertificadoAction()
    {
        $this->_helper->Layout->disableLayout();
        $cargo = new Zend_Session_Namespace('cargo');
        $rol = $cargo->cargo;
        if ($rol == '1' || $rol == '3' || $rol == '4' || $rol == '6') {

            $this->view->title = "Adjuntar Certificado";
            $this->view->headTitle($this->view->title);

            $idaccidente = $this->_getParam('id', 0);

            $form = new Application_Form_AdjuntarArchivo();
            $form->idAccidente->setValue($idaccidente);
            $this->view->form = $form;

            if ($this->getRequest()->isPost()) {

                $formData = $this->getRequest()->getPost();
                if ($form->isValid($formData)) {
                    $idAccidente = $form->getValue('idAccidente');

                    $originalFilename = pathinfo($form->certificado->getFileName());
                    if ($originalFilename == null) {
                        $messages = $this->_helper->getHelper('FlashMessenger')->addMessage('Ha ocurido un error, al adjuntar el Archivo' . $upload);
                        $this->view->assign('messages', $messages);

                    } else {
                        $nombrearchivo = 'certificado-' . uniqid() . '.' . $originalFilename['extension'];
                        $db = Zend_Db_Table_Abstract::getDefaultAdapter();
                        $db->beginTransaction();
                        try {
                            $modeloaccidente = new Application_Model_DbTable_Accidente();
                            //Verificamos si ya posee archivo adjunto
                            $datosaccidente = $modeloaccidente->get($idAccidente);
                            if ($datosaccidente) {
                                //eliminamos el archivo
                                $imagen = getcwd();
                                $imagen .= "/application/documentos/certificados/" . $datosaccidente['archivo'];
                                if (file_exists($imagen)) {
                                    unlink($imagen);
                                }
                            }


                            $upload = $form->certificado->getTransferAdapter();
                            $form->certificado->addFilter('Rename', $nombrearchivo);
                            $upload = $form->certificado->receive();
                            if ($upload) {
                                //si el archivo se subio correctamente actualizamos el nombre en la tabla

                                $modeloaccidente->actualizararchivo($idAccidente, $nombrearchivo);
                                $db->commit();
                                echo "<script>parent.location.reload(true);;</script>";
                                //$this->_helper->redirector('indexaccidente');
                                exit;
                            } else {
                                $db->rollBack();
                                $messages = $this->_helper->getHelper('FlashMessenger')->addMessage('Ha ocurido un error, al adjuntar el Archivo' . $upload);
                                $this->view->assign('messages', $messages);
                            }

                        } catch (Exception $e) {
                            // Si hubo problemas. Enviamos todo marcha atras
                            $db->rollBack();
                            $messages = $this->_helper->getHelper('FlashMessenger')->addMessage('Ha ocurido un error' . $e);
                            $this->view->assign('messages', $messages);
                        }
                    }


                } else {
                    $form->populate($formData);

                }
            }
        }
    }

    public function eliminararchivoAction()
    {
        $this->_helper->Layout->disableLayout();
        $cargo = new Zend_Session_Namespace('cargo');
        $rol = $cargo->cargo;
        if ($rol == '1' || $rol == '3' || $rol == '4' || $rol == '6') {

            $idaccidente = $this->_getParam('id', 0);

            $db = Zend_Db_Table_Abstract::getDefaultAdapter();
            $db->beginTransaction();
            try {
                $modeloaccidente = new Application_Model_DbTable_Accidente();
                //Verificamos si ya posee archivo adjunto
                $datosaccidente = $modeloaccidente->get($idaccidente);
                if ($datosaccidente) {
                    //eliminamos el archivo
                    $imagen = getcwd();
                    $imagen .= "/application/documentos/certificados/" . $datosaccidente['archivo'];
                    if (file_exists($imagen)) {
                        unlink($imagen);
                        $modeloaccidente->actualizararchivo($idaccidente, "");
                        $db->commit();
                        $this->_helper->redirector('indexaccidente');
                    } else {
                        $db->rollBack();
                        echo "<script type=\"text/javascript\">alert(\"La Imagen no Existe\");</script>";
                        //echo "<script>parent.$.fancybox.close();</script>";
                        exit;

                    }
                } else {
                    $db->rollBack();
                    echo "<script type=\"text/javascript\">alert(\"Error\");</script>";
                    //echo "<script>parent.$.fancybox.close();</script>";
                    exit;
                }


            } catch (Exception $e) {
                // Si hubo problemas. Enviamos todo marcha atras
                $db->rollBack();
                $messages = $this->_helper->getHelper('FlashMessenger')->addMessage('Ha ocurido un error' . $e);
                $this->view->assign('messages', $messages);
            }


        }
    }

    public function verarchivoAction()
    {
        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $idaccidente = $this->_request->getParam('id');
        if ($idaccidente > 0) {

            $modeloaccidente = new Application_Model_DbTable_Accidente();
            $datosaccidente = $modeloaccidente->getaccidente($idaccidente, $idperiodo);


            if (count($datosaccidente) == 0) {

                echo "<script type=\"text/javascript\">alert(\"No existen datos\");</script>";
                echo "<script>parent.$.fancybox.close();</script>";
                echo "<script>window.close();</script>";
                exit;

            } else {

                $cargo = new Zend_Session_Namespace('cargo');
                $rol = $cargo->cargo;

                if ($rol == 1 || $rol == 3 || $rol == 4 || $rol == 6) {


                    $imagen = getcwd();
                    $imagen .= "/application/documentos/certificados/" . $datosaccidente[0]['archivo'];
                    if (file_exists($imagen)) {
                        $html = '<p style="position:absolute;top:10px;text-align:left"><img style="width: 100%; height: 1000px" src="' . $imagen . '" /></p>';
                    } else {
                        echo "<script type=\"text/javascript\">alert(\"Error Imagen\");</script>";
                        echo "<script>parent.$.fancybox.close();</script>";
                        exit;
                    }


                    $content = '
                        <!doctype html>
                        <html>
                        <body>'
                        . $html . '
                </body>
                    </html>';


                    if ($content != '') {
                        // ob_start();

                        echo '<page>' . $content . '</page>';

                        //Añadimos la extensión del archivo. Si está vacío el nombre lo creamos
                        //$path!='' ? $path .='.pdf' : $path = crearNombre(10);

                        $content = ob_get_clean();
                        require 'fpdf/html2pdf.class.php';
                        try {
                            //Orientación / formato del pdf y el idioma.
                            $pdf = new HTML2PDF('P', 'A4', 'es', array(1, 1, 1, 1) /*márgenes*/); //los márgenes también pueden definirse en <page> ver documentación

                            $pdf->WriteHTML($content);
                            if (preg_match("/MSIE/i", $_SERVER["HTTP_USER_AGENT"])) {
                                header("Content-type: application/PDF");
                            } else {
                                header("Content-type: application/PDF");
                                header("Content-Type: application/pdf");
                            }

                            $pdf->Output('Archivo.pdf', I);
                        } catch (HTML2PDF_exception $e) {
                            echo $e;
                        }
                    }
                }


            }//fin else

        } else {

            echo "<script type=\"text/javascript\">alert(\"No existen datos\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            echo "<script>window.close();</script>";
            exit;

        }


    }


    function getPorcentaje($idestablecimiento, $nota)
    {

        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $modelo = new Application_Model_DbTable_Equivalencia();
        $result = $modelo->listarperiodo($idestablecimiento, $idperiodo, 1);
        $devuelve = 0;


        switch ($nota) {
            case ($nota > $result[1]['equivalencia_nota'] && $nota <= $result[0]['equivalencia_nota']):
                $resta = $result[0]['equivalencia_nota'] - $result[1]['equivalencia_nota'];
                $restaporcentaje = $result[0]['porcentaje_final'] - $result[0]['porcentaje_inicio'];
                $resultado_resta = $restaporcentaje / $resta;

                break;
            case 1:
                echo "i es igual a 1";
                break;
            case 2:
                echo "i es igual a 2";
                break;
        }
    }

    public function generaralumnoparcialavanceAction()
    {

        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();
        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;


        $paso = false;
        //debe venir un parametro, por GET o POST, llamado idasignatura, con el id del Asignatura a borrar
        $id = $this->_getParam('id', 0);
        $segmento = $this->_getParam('p', 0);
        $modeloalumnodetalle = new Application_Model_DbTable_AlumnosDetalle();

        //verificamos si existen datos del detalle del alumno
        $verifica = $modeloalumnodetalle->get($id, $segmento, $idperiodo);

        if ($verifica) {
            //si existen datos mostramos un formulario para que el usuario seleccione si desea modificar los datos o continuar con el documento

            $verifica = $modeloalumnodetalle->get($id, $segmento, $idperiodo);
            $idp = $segmento;

            $observacion = $verifica[0]["observaciones"];

            $idd = $verifica[0]["idDetalle"];
            echo "<link href='../../../../../css/formpdf.css' type='text/css' rel='stylesheet' /><div class='col_12 column'><form class='basic-grey' method='post' action='generaralumnoparcial'><label  for='obs'><span> Observaciones:</span> <textarea id='obs' name='obs' rows='5' cols='40'>" . $observacion . "</textarea></label><label><span>&nbsp;</span><button name='mod'value='1'>Modificar</button><button name='cont'value='1'>Continuar</button> <input type='hidden' name='id' value='" . $id . "' /><input type='hidden' name='idp' value='" . $segmento . "' /><input type='hidden' name='idd' value='" . $idd . "' /></label></form></div>";

            //si el usuario desea modificar

        } else {
            echo "<link href='../../../../../css/formpdf.css' type='text/css' rel='stylesheet' /><div class='col_12 column'><form class='basic-grey' method='post' action='generaralumnoparcial'><label  for='obs'><span> Observaciones:</span> <textarea id='obs' name='obs' rows='5' cols='40'></textarea></label><label><span>&nbsp;</span><input type='submit' name='submit' value='Enviar'> <input type='hidden' name='id' value='" . $id . "' /><input type='hidden' name='idp' value='" . $segmento . "' /></label></form></div>";

        }

        //si Vienen datos por post

        if ($this->getRequest()->isPost()) {

            $id = $_POST["id"];
            $idp = $_POST["idp"];
            $idd = $_POST["idd"];

            if (empty($_POST['cont']) && empty($_POST['mod'])) {
                $modeloalumnodetalle->agregar($_POST["trab"], $_POST["ina"], $_POST["asi"], $_POST["atr"], $_POST["obs"], $_POST["apod"], $idp, $_POST["id"], $idperiodo);

            }
            if (empty($_POST['cont']) && $_POST['mod'] == 1) {
                $modeloalumnodetalle->cambiar($_POST["trab"], $_POST["ina"], $_POST["asi"], $_POST["atr"], $_POST["obs"], $_POST["apod"], $idp, $_POST["idd"]);
            }
            if ($_POST['cont'] == 1) {
                $paso = true;
            }

            $verifica = $modeloalumnodetalle->get($id, $idp, $idperiodo);

            $observacion = $verifica[0]["observaciones"];

            $paso = true;
        }

        if ($paso) {

            $modeloalumnoactual = new Application_Model_DbTable_Alumnosactual();
            $alumnoactual = $modeloalumnoactual->get($id);
            $idalumnoactual = $alumnoactual[0]['idAlumnosActual'];

            $this->redirect('/Informes/generarparcialavance/id/' . $idalumnoactual . '/p/' . $idp . '/t/1');


        } //fin Paso

    }

    public function generarparcialavanceAction()
    {

        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();

        $paso = true;
        //debe venir un parametro, por GET o POST, llamado idasignatura, con el id del Asignatura a borrar
        $id = $this->_getParam('id', 0);
        $segmento = $this->_getParam('p', 0);
        $tipo = $this->_getParam('t', 0);


        if ($paso) {

            $style = "body{
font:11px Arial, Tahoma, Verdana, Helvetica, sans-serif;

color:#000;
}

#infoizq{

position:absolute;
left:0px;
}

#infoder{

position:absolute;
right:0px;
}
 
a h1{
font-size:35px; 
color:#FFF;
}
img{
width:90px;
height:100px;
}
 
h2{
color:#FC0;
font-size:15px; 
}

 
table{
width:100%;
height:auto;
margin:5px 0 10px 0;
border-collapse:collapse;
text-align:center;
text-justify:inter-word;
color:#000000;
}

table td,th{
border:1px solid black;
}
 .mes{
text-align:center;
}
 
table th{
padding:5px;
background-color: #ccc;
}


text-align:center;
font-weight:bold;
color:#000000;
}
 
.menu{
background-color:#69C;
color:#FFF;
}
.celda{
height: auto;
width: 170px;
text-align:left;
padding:1px;
}
 
.menu a{
color:#FFF; 
}";

            if ($segmento == '1') {

                $nombresegmento = 'I Semestre';
            }
            if ($segmento == '2') {

                $nombresegmento = 'II Semestre';
            }

            $nombredecreto = 'Nº 1363 del año 2011 ';
            $nombreexento = 'Decreto Nº 67 de 2018';


            //fecha actual

            $date = new DateTime;
            $fechain = $date->format('Y-m-d');
            $cortado = explode("-", $fechain);
            $dias = array("Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado");
            $meses = array("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre");

            $fecha_final = $dias[date('w', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]))] . " " . $cortado[2] . " de " . $meses[date('n', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0])) - 1] . " del " . date('Y', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]));


            $periodo = new Zend_Session_Namespace('periodo');
            $idperiodo = $periodo->periodo;

            $modeloalumnoactual = new Application_Model_DbTable_Alumnosactual();
            if ($tipo == 1) {
                $listadealumnos = $modeloalumnoactual->get($id);
                $idcursoactual = $listadealumnos[0]['idCursosActual'];
            } else {
                $listadealumnos = $modeloalumnoactual->listaralumnoscursoactual($id, $idperiodo);
                $idcursoactual = $id;
            }


            //creo objeto tabla Notas
            $tabla = new Application_Model_DbTable_Notas();
            $modelasignatura = new Application_Model_DbTable_Asignaturascursos();
            $modeloalumnodetalle = new Application_Model_DbTable_AlumnosDetalle();
            $modeloequivalencia = new Application_Model_DbTable_Equivalencia();

            $listaasignatura = $modelasignatura->listarporcurso($idcursoactual, 1, array('1', '3'), $idperiodo);
            //Obtiene los taller de forma Anual


            //creo objeto tabla curso
            $modelCurso = new Application_Model_DbTable_Cursos();
            $detalleest = $modelCurso->listarcursoid($idcursoactual, $idperiodo);
            $recuperando2 = new Zend_Session_Namespace('nombreperiodo');

            $lista_equivalencia = $modeloequivalencia->listarperiodo($detalleest[0]['idEstablecimiento'], $idperiodo, 1);

            $lista_niveles = $modeloequivalencia->listarniveleslogro($detalleest[0]['idEstablecimiento'], $idperiodo, 1);


            //Variables encabezado

            $titulo = "INFORME ESTADO DE AVANCE  " . strtoupper($nombresegmento) . " " . $recuperando2->nombreperiodo;
            $tituloest = "<b>" . $detalleest[0]['nombreEstablecimiento'] . "</b>";
            //$descripcion = "Reconocido Oficialmente por el Ministerio de Educación de la República de Chile, según Resolución Exenta de Educación Nº " . $detalleest[0]['numeroDecreto'] . " del año " . $detalleest[0]['yeardecreto'] . ". Rol Base de Datos Nº " . $detalleest[0]['rbd'] . ", otorga el presente Informe Educacional a:";

            $descripcion = "Reconocido Oficialmente por el Ministerio de Educación de la República de Chile, según Resolución Exenta de Educación Nº " . $detalleest[0]['numeroDecreto'] . " del año " . $detalleest[0]['yeardecreto'] . ". Rol Base de Datos Nº " . $detalleest[0]['rbd'] . ", otorga el presente Informe Educacional a:";
            $alumno = 'Don(a): <span style=" text-decoration: underline;">' . $nombrecompleto . '</span> RUN: <span style=" text-decoration: underline;">' . $formatofinal . '</span> Alumno(a) de <b>' . $detalleest[0]['nombreGrado'] . ' ' . $detalleest[0]['letra'] . ' de ' . $nombreedu . '</b>, de Acuerdo a Decreto Plan de Estudio ' . $nombredecreto . ' y del Reglamento de Evaluación y Promoción Escolar ' . $nombreexento . '';

            $logo = getcwd();
            $logo .= "/application/documentos/logos/" . $detalleest[0]['extension'];
            if (file_exists($logo)) {

                $plogo = '<p style="position:absolute;top:3px;text-align:center"><img  src="' . $logo . '" /></p>';
            } else {
                $plogo = '';
            }


            //creo objeto tabla cuentas
            $modelCuenta = new Application_Model_DbTable_Cuentas();
            if ($detalleest[0]['idDirector'] > 0) {
                $director = $modelCuenta->get($detalleest[0]['idDirector']);
            } else {
                $director = 0;
            }

            $Profesorjefe = $modelCuenta->getusuario($detalleest[0]['idCuentaJefe'], $idperiodo);
            $largoalumnos = count($listadealumnos);
            $largoasignatura = count($listaasignatura);
            //$largoasignaturanoincide = count($listaasignaturanoinciden);


            if (count($Profesorjefe) == 0 || $Profesorjefe == null) {
                echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta Profesor Jefe\");</script>";
                echo "<script>parent.$.fancybox.close();</script>";
                exit;
            }


            if (count($director) == 0) {
                echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta director\");</script>";
                echo "<script>parent.$.fancybox.close();</script>";
                exit;

            }


            $date = new DateTime;
            $fechain = $date->format('Y-m-d');
            $cortado = explode("-", $fechain);
            $dias = array("Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado");
            $meses = array("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre");

            $fecha_final = $dias[date('w', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]))] . " " . $cortado[2] . " de " . $meses[date('n', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0])) - 1] . " del " . date('Y', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]));

            $niveleducacion = $detalleest[0]['idCodigoTipo'];
            $grado = $detalleest[0]['idGrado'];


            $taller = array();
            $combinada = array();
            for ($y = 0; $y < $largoalumnos; $y++) {
                $tablanotas = array();
                $alumnoactual = array();
                $verifica = array();
                $cuenta = 0;
                $promedio = 0;
                $cuenta1 = array();
                $cuentan = 0;
                $promedion = 0;
                $promediof = 0;
                $promediofn = 0;
                $cuenta2 = array();
                $promedioparcial = 0;
                $contadorparcial = 0;


                $idalumnoactual = $listadealumnos[$y]['idAlumnos'];

                $tablanotas = $tabla->generasolonotasperiodo($idalumnoactual, $segmento, 1, $idperiodo, $idcursoactual);
                $tablanotas2 = $tabla->generasolonotasperiodo($idalumnoactual, $segmento, 0, $idperiodo, $idcursoactual);
                $verifica = $modeloalumnodetalle->get($listadealumnos[$y]['idAlumnosActual'], $segmento, $idperiodo);
                $observacion = $verifica[0]["observaciones"];
                $largotablanota2 = count($tablanotas2);
                $largotablaaux = count($tablanotas);


                //Espacios
                $totalnotascurso = $tabla->listarnotascursoperiodo($idcursoactual, $idperiodo, array($segmento));
                $largonota = count($totalnotascurso);
                $contador1 = array();


                for ($i = 0; $i < $largoasignatura; $i++) {
                    $contador1[$i] = 0;
                    for ($j = 0; $j < $largonota; $j++) {
                        if ($listaasignatura[$i]["idAsignatura"] == $totalnotascurso[$j]["idAsignatura"]) {
                            if ($totalnotascurso[$j]["coef"] == 2) {
                                $contador1[$i] += 2;
                            } else {
                                $contador1[$i] += 1;
                            }
                        }

                    }


                }

                if ($contador1 === 'NULL' || $contador1 == null || empty($contador1)) {
                    $rowspan = 1;
                } else {
                    $rowspan = max($contador1);
                }


                $rowspan1 = max(array($rowspan));


                $espacio = $rowspan1 + 2;


                $largotablanota = count($tablanotas);


                //Formato del rut

                $rutset = $listadealumnos[$y]['rutAlumno'];
                if (!empty($rutset)) {

                    $rest = substr($rutset, 0, -1);
                    $ultimo = substr($rutset, -1);
                    $formatomiles = number_format($rest, 0, "", ".");
                    $formatofinal = $formatomiles . '-' . $ultimo;

                }


                $nombrecompleto = $listadealumnos[$y]['nombres'] . ' ' . $listadealumnos[$y]['apaterno'] . ' ' . $listadealumnos[$y]['amaterno'];
                $nombrecompleto = strtoupper($nombrecompleto);


                // variables para encabezado

                //$alumno = 'Don(a): <span style=" text-decoration: underline;">' . $nombrecompleto . '</span> RUN: <span style=" text-decoration: underline;">' . $formatofinal . '</span> Alumno(a) de <b>' . $detalleest[0]['nombreGrado'] . ' ' . $detalleest[0]['letra'] . ' de ' . $nombreedu . '</b>, de Acuerdo a ' . $nombreexento . '';
                $descripcion = "Reconocido Oficialmente por el Ministerio de Educación de la República de Chile, según Resolución Exenta de Educación Nº " . $detalleest[0]['numeroDecreto'] . " del año " . $detalleest[0]['yeardecreto'] . ". Rol Base de Datos Nº " . $detalleest[0]['rbd'] . ", otorga el presente Informe Educacional a:";
                $alumno = 'Don(a): <span style=" text-decoration: underline;">' . $nombrecompleto . '</span> RUN: <span style=" text-decoration: underline;">' . $formatofinal . '</span> Alumno(a) de <b>' . $detalleest[0]['nombreGrado'] . ' ' . $detalleest[0]['letra'] . ' de ' . $nombreedu . '</b>, de Acuerdo a Decreto Plan de Estudio ' . $nombredecreto . ' y del Reglamento de Evaluación y Promoción Escolar ' . $nombreexento . '';

                $encabezado = $plogo . '<h5 style="position:absolute;top:110px;text-align:center">' . $titulo . '</h5><h4 style="position:absolute;top:130px;text-align:center">' . $tituloest . '</h4>'
                    . '<p style="margin-top:20px; text-align:left;">' . $descripcion . '</p>'

                    . '<p style="margin-top:1px; text-align:left;">' . $alumno . '</p>';
                $html[$y] = '';
                $html[$y] .= $encabezado;


                if ($largotablaaux < 1) {
                    $html[$y] .= "<table  align='center' border='1'><tr><th style='width:25%'>Asignaturas</th><th style='width:65%'>" . $nombresegmento . "</th><th style='width:9%'>Promedio</th><th style='width:8%'>%</th><th style='width:8%'>Nivel</th></tr>";
                    $html[$y] .= "<tr><td colspan='3'>Sin Notas en éste periodo</td></tr>";
                } else {


                    $html[$y] .= "<table  align='center' border='1'><tr><th style='width:25%'>Asignaturas</th><th style='width:50%' colspan=" . $rowspan1 . ">" . $nombresegmento . "</th><th style='width:9%'>Promedio</th><th style='width:8%'>%</th><th style='width:8%'>Nivel</th></tr>";


                    $contadorparcial = 0;
                    for ($i = 0; $i < $largoasignatura; $i++) {
                        $cuenta1[$i] = 0;
                        $promedio = 0;
                        $cuenta = 0;
                        $html[$y] .= "<tr><td class='celda'>" . $listaasignatura[$i]["nombreAsignatura"] . "</td>";

                        for ($j = 0; $j < $largotablanota; $j++) {
                            if ($listaasignatura[$i]["idAsignatura"] == $tablanotas[$j]["idAsignatura"]) {
                                if ($tablanotas[$j]['coef'] == 2) {
                                    $datos_aux = $this->equivalencias($lista_equivalencia, $tablanotas[$j]['nota']);
                                    if ($tablanotas[$j]['nota'] != '0') {
                                        $arr1 = str_split($tablanotas[$j]['nota']);
                                        $html[$y] .= "<td>" . $arr1[0] . ',' . $arr1[1] . " - " . $datos_aux[0] . "% </td>";
                                        $html[$y] .= "<td>" . $arr1[0] . ',' . $arr1[1] . " - " . $datos_aux[0] . "% </td>";

                                        $promedio += ($tablanotas[$j]['nota'] + $tablanotas[$j]['nota']);
                                        $cuenta += 2;

                                    } else {
                                        $html[$y] .= "<td>-</td>";
                                        $html[$y] .= "<td>-</td>";

                                    }
                                    $cuenta1[$i] += 2;

                                } else {

                                    if ($tablanotas[$j]['nota'] != '0') {
                                        $datos_aux = $this->equivalencias($lista_equivalencia, $tablanotas[$j]['nota']);
                                        $arr1 = str_split($tablanotas[$j]['nota']);
                                        $html[$y] .= "<td>" . $arr1[0] . ',' . $arr1[1] . " - " . $datos_aux[0] . "% </td>";
                                        $promedio += $tablanotas[$j]['nota'];
                                        $cuenta += 1;


                                    } else {

                                        $html[$y] .= "<td>-</td>";


                                    }

                                    $cuenta1[$i] += 1;

                                }

                            }

                        }
                        if ($cuenta1[$i] < $rowspan1) {
                            $largo = $rowspan1 - $cuenta1[$i];

                            for ($u = 0; $u < $largo; $u++) {
                                $html[$y] .= "<td>-</td>";
                            }

                        }
                        if ($cuenta1[$i] == $contador1[$i]) {

                            //sacamos el promedio de la asignatura
                            if ($promedio > 0 || $cuenta > 0) {


                                // si es 1 Aproxima, si es 2 no Aproxima
                                if ($detalleest[0]['aproxAsignatura'] == 1) {

                                    $promediof = round($promedio / $cuenta);

                                } else {

                                    $promediof = intval($promedio / $cuenta);


                                }
                                $promedioparcial += $promediof;
                                $contadorparcial += 1;
                                $promediocortado = str_split($promediof);
                                $datos_aux_prom = $this->equivalencias($lista_equivalencia, $promediof);
                                $html[$y] .= "<td>" . $promediocortado[0] . ',' . $promediocortado[1] . "</td>";
                                $html[$y] .= "<td>" . $datos_aux_prom[0] . "%</td>";
                                $html[$y] .= "<td>" . $datos_aux_prom[1] . "</td></tr>";


                            } else {
                                $promediof = 0;
                                $html[$y] .= "<td>-</td><td>-</td><td>-</td></tr>";


                            }

                        } else {

                            $html[$y] .= "<td>-</td><td>-</td><td>-</td></tr>";

                        }


                    }

                    $promedioparcialfinal = 0;


                    if ($promedioparcial > 0 && $contadorparcial > 0) {
                        // si es 1 Aproxima,si es 2 no Aproxima
                        if ($detalleest[0]['aproxPeriodo'] == 1) {
                            $promedioparcialfinal = round($promedioparcial / $contadorparcial);
                        } else {
                            $promedioparcialfinal = intval($promedioparcial / $contadorparcial);
                        }
                        $promediocortadoparcial = str_split($promedioparcialfinal);

                        $datos_aux_prom_final = $this->equivalencias($lista_equivalencia, $promedioparcialfinal);

                        $html[$y] .= "<tr><td style='text-align:left' colspan=" . ($rowspan1 + 1) . ">PROMEDIO GENERAL</td><td>" . $promediocortadoparcial[0] . ',' . $promediocortadoparcial[1] . "</td><td>" . $datos_aux_prom_final[0] . "%</td><td>" . $datos_aux_prom_final[1] . "</td></tr>";


                    } else {

                        $html[$y] .= "<tr><td style='text-align:left' colspan=" . ($rowspan1 + 1) . ">PROMEDIO GENERAL</td><td>-</td><td>-</td><td>-</td></tr>";


                    }


                    $html[$y] .= $taller[$y];
                    if (empty($taller[$y]) && (!empty($combinada[$y]) || !empty($concepto[$y]))) {
                        $html[$y] .= "<tr><td colspan=" . ($rowspan1 + 2) . "><b>TALLERES Y ASIGNATURAS</b></td></tr>";
                    }
                    $html[$y] .= $combinada[$y];
                    $html[$y] .= $concepto[$y];
                }


                $html[$y] .= "</table>";

                $cadenaobservacion = trim($observacion);

                if (!empty($observacion) && strlen($cadenaobservacion) > 0) {
                    $html[$y] .= "<table><tr><td style='width:100%;text-align: left;'>Observaciones:</td></tr><tr><td style='width:100%;height:4%;text-align:left;'>" . $observacion . "</td></tr></table>";
                }

                //Simbologia
                $html[$y] .= "<table><tr><td style='width:30%;text-align: center;'>Nivel de Aprendizaje</td><td style='width:70%;text-align: center;'>Descripción</td></tr>";

                for ($n = 0; $n < count($lista_niveles); $n++) {
                    $html[$y] .= "<tr><td style='width:30%;text-align:left;'><b>" . $lista_niveles[$n]['nivelLogro'] . "</b></td><td style='width:70%;text-align:left;'>" . $lista_niveles[$n]['descripcionLogro'] . "</td></tr>";
                }
                $html[$y] .= "</table>";

                $valoresprofesor = unserialize($detalleest[0]['profesor']);
                if ($valoresprofesor[0] == 1) {
                    $tdnombreprofesor = "<p style='text-decoration:underline;margin-left:30px;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</p>";
                    $tdprofesor = "Profesor(a) Jefe.";
                } else {
                    $tdnombreprofesor = "";
                    $tdprofesor = "";
                }

                $valoresdirector = unserialize($detalleest[0]['director']);
                if ($valoresdirector[0] == 1) {
                    $tdnombredirector = "<p style='text-decoration:underline;'>" . $director['nombrescuenta'] . " " . $director['paternocuenta'] . " " . $director['maternocuenta'] . "</p>";
                    $tddirector = "Director(a).";
                } else {
                    $tdnombredirector = "";
                    $tddirector = "";
                }


                $valoresapoderado = unserialize($detalleest[0]['apoderado']);
                if ($valoresapoderado[0] == 1) {
                    $tdnombreapoderado = "<p style='text-decoration:underline;'> " . $apoderado . "</p>";
                    $tdapoderado = "Nombre y Firma de Apoderado.";
                } else {
                    $tdnombreapoderado = "";
                    $tdapoderado = "";
                }


                $html[$y] .= "<table align='center' style='margin-top:25px;' class='page_firmas'>
            <tr>
                <td style='width: 33%; text-align: center;border:none;'>" . $tdnombreprofesor . "</td>
                <td style='width: 33%; text-align: center;border:none;'>" . $tdnombreapoderado . "</td>
                <td style='width: 33%; text-align: center;border:none;'>" . $tdnombredirector . "</td>
            </tr>
            <tr>
                <td style='width: 33%; text-align:center;border:none;padding-top:35px'>" . $tdprofesor . "</td>
                <td style='width: 33%; text-align: center;border:none;padding-top:35px'>" . $tdapoderado . "</td>
                <td style='width: 33%; text-align:center;border:none;padding-top:35px'>" . $tddirector . "</td>
            </tr>
            <tr>
                <td colspan='3' style='text-align:center;border:none;padding-top:15px'>" . $fecha_final . ".</td>
            </tr>
            </table>";

            }

            //var_dump($html);


            if ($html != '') {

                require('fpdf/html2pdf.class.php');
                try {
                    //Orientación / formato del pdf y el idioma.
                    $pdf = new HTML2PDF('P', 'LETTER', 'es', array(10, 10, 10, 10) /*márgenes*/); //los márgenes también pueden definirse en <page> ver documentación

                    //inicio ciclo

                    for ($j = 0; $j < count($html); $j++) {
                        $pdf->WriteHTML('<page><html>
                            <head>
                                <style>' . $style . '</style>
                            </head>
                            <body> <page_footer>
                            <table class="page_footer">
                                <tr>
                                <td style="width: 40%; text-align: left;border:none;"></td>
                                    <td style="width: 60%; text-align: right;border:none;font-size:8px">

                                    </td>
                                </tr>
                            </table>
                        </page_footer>' . $html[$j] . '</body></html></page>');
                    }

                    //fin ciclo


                    if (preg_match("/MSIE/i", $_SERVER["HTTP_USER_AGENT"])) {
                        header("Content-type: application/PDF");
                    } else {
                        header("Content-type: application/PDF");
                        header("Content-Type: application/pdf");
                    }

                    $pdf->Output('Planificacion.pdf', I);
                } catch (HTML2PDF_exception $e) {
                    //echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, intente nuevamente\");</script>";
                    //echo "<script>parent.$.fancybox.close();</script>";
                    echo $e;
                }
            }


        }//fin Paso


    }

    public function generaralumnocursoanualpremonitorAction()
    {

        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();

        $paso = true;
        $id = $this->_getParam('id', 0);
        $tipo = $this->_getParam('t', 0);
        $segmento = $this->_getParam('s', 0);

        if ($paso) {

            $style = "body{
            
                font-size:10px;font: Arial, Tahoma, Verdana, Helvetica, sans-serif;
                color:#000;
                }
                
                #infoizq{
                
                position:absolute;
                top: 2%;
                left: 40%;
                width:30%;
                }
                h5{
                  padding:0;
                }
                
                #infoder{
                
                position:absolute;
                right:0px;
                }
                
                img{
                width:90px;
                height:100px;
                
                }";

            $periodo = new Zend_Session_Namespace('periodo');
            $idperiodo = $periodo->periodo;

            $idtipoev = new Zend_Session_Namespace('tipoevaluacion');
            $idtevalucacion = $idtipoev->tipoevaluacion;

            $modeloalumnoactual = new Application_Model_DbTable_Alumnosactual();
            $modelcurso = new Application_Model_DbTable_Cursos();
            $modelasignatura = new Application_Model_DbTable_Asignaturascursos();
            $tabla = new Application_Model_DbTable_Notas();
            $modeldetalle = new Application_Model_DbTable_AlumnosDetalle();
            $modelcomuna = new Application_Model_DbTable_Comuna();
            $modelCuenta = new Application_Model_DbTable_Cuentas();
            if ($tipo == 1) {
                $listadealumnos = $modeloalumnoactual->listaralumnoscursoactual($id, $idperiodo);

            } else {
                $listadealumnos = $modeloalumnoactual->get($id);
                $id = $listadealumnos[0]['idCursosActual'];
            }

            $largoalumnos = count($listadealumnos);

            $detalleest = $modelcurso->listarcursoid($id, $idperiodo);
            $niveleducacion = $detalleest[0]['idCodigoGrado'];

            if ($detalleest[0]['idDirector'] == null) {
                echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta director\");</script>";
                echo "<script>parent.$.fancybox.close();</script>";
                exit;
            } else {
                $director = $modelCuenta->get($detalleest[0]['idDirector']);
            }


            if ($detalleest[0]['idCuentaJefe'] == null) {
                echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta Profesor Jefe\");</script>";
                echo "<script>parent.$.fancybox.close();</script>";
                exit;
            } else {
                $Profesorjefe = $modelCuenta->getusuario($detalleest[0]['idCuentaJefe'], $idperiodo);
            }


            if (count($director) == 0) {
                echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta director\");</script>";
                echo "<script>parent.$.fancybox.close();</script>";
                exit;

            }

            if (count($Profesorjefe) == 0 || $Profesorjefe == null) {
                echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta Profesor Jefe\");</script>";
                echo "<script>parent.$.fancybox.close();</script>";
                exit;
            }

            $infoizq = '<div id="infoizq"><h5></h5></div>';
            $logo = getcwd();
            $logo .= "/application/documentos/logos/" . $detalleest[0]['extension'];
            $imagen = getcwd();
            $imagen .= "/application/documentos/logos/imagen.jpg";
            if (file_exists($logo)) {
                $encabezado = '<p style="position:absolute;top:3%;text-align:left"></p><p style="position:absolute;top:3%;text-align:center"><img  src="' . $logo . '" /></p>' . $infoizq . '<h3 style="position:absolute;top:170px;text-align:center">' . $detalleest[0]['nombreEstablecimiento'] . '</h3>';

            } else {
                $encabezado = '<p style="position:absolute;top:3%;text-align:left"></p><p style="position:absolute;top:3%;text-align:center"></p>' . $infoizq . '<h3 style="position:absolute;top:170px;text-align:center">' . $detalleest[0]['nombreEstablecimiento'] . '</h3>';

            }

            $meses = array("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre");
            $datosasignaturas = $modelasignatura->listarporcursopremonitoreolag($detalleest[0]['idCursos'], $idperiodo);


            $listambitos = $modelasignatura->listaragrupar($detalleest[0]['idCursos'], $idperiodo, 1);
            if (count($listambitos) == 3) {
                $nucleosuno = $modelasignatura->listarnucleoporambito($listambitos[0]['idAmbito']);
                $nucleosdos = $modelasignatura->listarnucleoporambito($listambitos[1]['idAmbito']);
                $nucleostres = $modelasignatura->listarnucleoporambito($listambitos[2]['idAmbito']);
            }


            $largoasignatura = count($datosasignaturas);
            $largonucleouno = count($nucleosuno);
            $largonucleodos = count($nucleosdos);
            $largonucleotres = count($nucleostres);

            //Conceptos
            $asignaturamodelo = new Application_Model_DbTable_Asignaturascursos();
            $modeloequivalencia = new Application_Model_DbTable_Equivalencia();
            $resultado = $modeloequivalencia->listarperiodo($detalleest[0]['idEstablecimiento'], $idperiodo, $segmento);
            $resultadomostrar = $modeloequivalencia->listarperiodos($detalleest[0]['idEstablecimiento'], $idperiodo, $segmento);

            $largoresultado = count($resultado);
            $largoresultadomostrar = count($resultadomostrar);


            for ($y = 0; $y < $largoalumnos; $y++) {

                $alumnoactual = array();
                $tabla2 = array();
                $detallecurso = array();
                $tablanotasprimer = array();
                $tablanotassegundo = array();
                $tablanotastercero = array();
                $detallecomuna = array();
                $detallealumnoprimer = array();
                $detallealumnosegundo = array();
                $detallealumnotercero = array();
                $detallealumno = array();
                $promedioprimer = array();
                $promediosegundo = array();
                $promediotercero = array();
                $promediofinal = array();
                $primers = array();
                $segundos = array();
                $terceros = array();
                $finals = array();
                $observacionprimer = '';
                $observacionsegundo = '';
                $observacionterceros = '';
                $observacion = '';


                $alumnoactual = $modeloalumnoactual->get($listadealumnos[$y]['idAlumnosActual']);
                $idalumnoactual = $alumnoactual[0]['idAlumnos'];
                $idalumnoactual2 = $alumnoactual[0]['idAlumnosActual'];
                $idcursoactual = $alumnoactual[0]['idCursosActual'];
                $idcursos = $alumnoactual[0]['idCursos'];


                if (!empty($alumnoactual[0]['comuna'])) {
                    $detallecomuna = $modelcomuna->getcomuna($alumnoactual[0]['comuna']);
                } else {
                    $detallecomuna = 0;
                }

                if ($niveleducacion == '4') {
                    $nombreedu = 'Primer Nivel de Transición';

                }

                if ($niveleducacion == '5') {
                    $nombreedu = 'Segundo Nivel de Transición';

                }


                //Fecha nacimiento
                $fechana = $alumnoactual[0]['fechanacimiento'];
                $cortado2 = explode("-", $fechana);
                if (count($cortado2) > 0) {
                    if (checkdate($cortado2[1], $cortado2[2], $cortado2[0])) {
                        $fecha_final_nac = $cortado2[2] . " de " . $meses[date('n', mktime(0, 0, 0, $cortado2[1], $cortado2[2], $cortado2[0])) - 1] . " del " . date('Y', mktime(0, 0, 0, $cortado2[1], $cortado2[2], $cortado2[0]));
                    } else {
                        $fecha_final_nac = 'Sin Datos';
                    }
                } else {
                    $fecha_final_nac = 'Sin Datos';
                }

                $html_notas[$y][0] = $encabezado;

                if ($segmento == 1) {
                    $detallealumnoprimer = $modeldetalle->listardetalleperiodo($idalumnoactual2, 1, $idperiodo);
                    $detallealumnosegundo = array();
                    $detallealumno = array();
                } elseif ($segmento == 2) {
                    $detallealumnoprimer = $modeldetalle->listardetalleperiodo($idalumnoactual2, 1, $idperiodo);
                    $detallealumnosegundo = $modeldetalle->listardetalleperiodo($idalumnoactual2, 2, $idperiodo);
                    $detallealumno = array();
                }elseif ($segmento == 3) {
                    $detallealumnoprimer = $modeldetalle->listardetalleperiodo($idalumnoactual2, 3, $idperiodo);
                    $detallealumnosegundo = array();
                    $detallealumnotercero = array();
                }elseif ($segmento == 4) {
                    $detallealumnoprimer = $modeldetalle->listardetalleperiodo($idalumnoactual2, 3, $idperiodo);
                    $detallealumnosegundo = $modeldetalle->listardetalleperiodo($idalumnoactual2, 4, $idperiodo);
                    $detallealumnotercero = array();
                } elseif ($segmento == 5) {
                    $detallealumnoprimer = $modeldetalle->listardetalleperiodo($idalumnoactual2, 3, $idperiodo);
                    $detallealumnosegundo = $modeldetalle->listardetalleperiodo($idalumnoactual2, 4, $idperiodo);
                    $detallealumnotercero = $modeldetalle->listardetalleperiodo($idalumnoactual2, 5, $idperiodo);
                }
                $detallealumno = $modeldetalle->listardetalleperiodo($idalumnoactual2, 10, $idperiodo);

                if (count($detallealumnoprimer) > 0) {
                    $diasinprimer = $detallealumnoprimer[0]['diasInasistencia'];
                    $diastrabajadosprimer = $detallealumnoprimer[0]['diasTrabajado'];
                    $atrasoprimer = $detallealumnoprimer[0]['numeroatrasos'];
                    $observacionprimer = $detallealumnoprimer[0]['observaciones'];
                    if ($diasinprimer != 0 && $diastrabajadosprimer > 0) {
                        $valor = $diasinprimer / $diastrabajadosprimer;
                        $aux = 1 - $valor;
                        $total = $aux * 100;
                    } elseif (($diasinprimer == 0 || $diasinprimer == '') && $diastrabajadosprimer > 0) {
                        $valor = $diasinprimer / $diastrabajadosprimer;
                        $aux = 1 - $valor;
                        $total = $aux * 100;
                    } else {
                        $diasinprimer = 0;
                        $diastrabajadosprimer = 0;
                        $atrasoprimer = 0;
                        $total = 0;
                    }
                } else {
                    $observacionprimer = 'Sin Observaciones';
                    $diasinprimer = 0;
                    $diastrabajadosprimer = 0;
                    $atrasoprimer = 0;
                    $total = 0;
                }


                if (count($detallealumnosegundo) > 0) {
                    $diasinsegundo = $detallealumnosegundo[0]['diasInasistencia'];
                    $diastrabajadossegundo = $detallealumnosegundo[0]['diasTrabajado'];
                    $atrasosegundo = $detallealumnosegundo[0]['numeroatrasos'];
                    $observacionsegundo = $detallealumnosegundo[0]['observaciones'];
                    if ($diasinsegundo != 0 && $diastrabajadossegundo > 0) {
                        $valorsegundo = $diasinsegundo / $diastrabajadossegundo;
                        $auxs = 1 - $valorsegundo;
                        $totals = $auxs * 100;
                    } elseif (($diasinsegundo == 0 || $diasinsegundo == '') && $diastrabajadossegundo > 0) {
                        $valorsegundo = $diasinsegundo / $diastrabajadossegundo;
                        $auxs = 1 - $valorsegundo;
                        $totals = $auxs * 100;
                    } else {
                        $diasinsegundo = 0;
                        $diastrabajadossegundo = 0;
                        $atrasosegundo = 0;
                        $totals = 0;
                    }
                } else {
                    $observacionsegundo = 'Sin Observaciones';
                    $diasinsegundo = 0;
                    $diastrabajadossegundo = 0;
                    $atrasosegundo = 0;
                    $totals = 0;
                }

                if (count($detallealumnotercero) > 0) {
                    $diasintercero = $detallealumnotercero[0]['diasInasistencia'];
                    $diastrabajadostercero = $detallealumnotercero[0]['diasTrabajado'];
                    $atrasotercero = $detallealumnotercero[0]['numeroatrasos'];
                    $observaciontercero = $detallealumnotercero[0]['observaciones'];
                    if ($diasintercero != 0 && $diastrabajadostercero > 0) {
                        $valort = $diasintercero / $diastrabajadostercero;
                        $auxt = 1 - $valort;
                        $totalt = $auxt * 100;
                    } elseif (($diasintercero == 0 || $diasintercero == '') && $diastrabajadostercero > 0) {
                        $valort = $diasintercero / $diastrabajadostercero;
                        $auxt = 1 - $valor;
                        $totalt = $aux * 100;
                    } else {
                        $diasintercero = 0;
                        $diastrabajadostercero = 0;
                        $atrasotercero = 0;
                        $totalt = 0;
                    }
                } else {
                    $observaciontercero = 'Sin Observaciones';
                    $diasintercero = 0;
                    $diastrabajadostercero = 0;
                    $atrasotercero = 0;
                    $totalt = 0;
                }

                $largodetallealumno = count($detallealumno);
                if (count($detallealumno) > 0) {
                    $diasin = $diasinprimer + $diasinsegundo;
                    $diastrabajados = $diastrabajadosprimer + $diastrabajadossegundo;
                    $atraso = $detallealumno[0]['numeroatrasos'];
                    $observacion = $detallealumno[0]['observaciones'];
                    if ($diasin != 0 && $diastrabajados > 0) {
                        $valorf = $diasin / $diastrabajados;
                        $auxf = 1 - $valorf;
                        $totalf = $auxf * 100;
                    } elseif (($diasin == 0 || $diasin == '') && $diastrabajados > 0) {
                        $valorf = $diasin / $diastrabajados;
                        $auxf = 1 - $valorf;
                        $totalf = $auxf * 100;
                    } else {
                        $totalf = 0;
                    }
                } else {
                    $observacion = 'Sin Observaciones';
                    $totalf = 0;
                }


                $periodo = new Zend_Session_Namespace('nombreperiodo');
                $nombreperiodo = $periodo->nombreperiodo;

                $html_notas[$y][0] .= "<div style='width:100%;border: 1px double #000;outline: 2px solid #699;outline-offset: -9px;text-align:center; margin:35px 0 0px 0; height:730px;'>
  <h3 style='text-align:center'>INFORME</h3>
  <h3 style='text-align:center'>Evaluación de Aprendizajes</h3>
  <h4 style='text-align:center'>¿Qué ha aprendido mi hijo o hija?</h4>
  <p style='text-align:center'>Año: " . $nombreperiodo . "</p>
      <table style='width:98%;border:none;margin:25px 5px 5px 5px;padding:5px;'>
        <tr>
          <td style='width:19%; text-align:left;border:none;'>Nombre de Alumno(a)</td>
          <td colspan='3' style='width:69%; text-align:left;border:none;'>" . $listadealumnos[$y]['nombres'] . " " . $listadealumnos[$y]['apaterno'] . " " . $listadealumnos[$y]['amaterno'] . "</td>
        </tr>

        <tr>
          <td  style='width:18%; text-align:left;border:none;'>Fecha Nacimiento:</td>
          <td colspan='3' style='width:70%; text-align:left;border:none;'>" . $fecha_final_nac . "</td>
        </tr>

         <tr>
          <td style='width:18%; text-align:left;border:none;'>Educadora:</td>
          <td colspan='3' style='width:70%; text-align:left;border:none;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</td>
        </tr>

        <tr>
          <td style='width:15%; text-align:left;border:none;'>Comuna:</td>
          <td style='width:34%; text-align:left;border:none;;
         '>" . $detallecomuna[0]['nombreComuna'] . "</td>
          <td style='width:7%; text-align:left;border:none;'>Región:</td>
          <td style='width:42%; text-align:left;border:none;'>" . $detallecomuna[0]['nombreRegion'] . "</td>
        </tr>
      </table>";

      if($idtevalucacion==1){
          $html_notas[$y][0] .="<table border='1' cellspacing='0' cellpadding='0' style='width:98%;margin:35px 5px 25px 5px;padding:5px;border-collapse:collapse;'>
        <tr>
          <th style='width:30%;' rowspan=2>ASISTENCIA</th>
          <th style='width:38%;' colspan=2>SEMESTRES</th>
          <th style='width:30%;' rowspan=2>TOTAL</th>
        </tr>
        <tr>

          <th>1º</th>
          <th>2º</th>

        </tr>

        <tr>
        <td style='text-align:left;'>Días de Clases</td>
        <td>" . $diastrabajadosprimer . "</td>
        <td>" . $diastrabajadossegundo . "</td>
        <td>" . ($diastrabajadosprimer + $diastrabajadossegundo) . "</td>
        </tr>

        <tr>
        <td style='text-align:left;'>Días de Inasistencia</td>
        <td>" . $diasinprimer . "</td>
        <td>" . $diasinsegundo . "</td>
        <td>" . ($diasinprimer + $diasinsegundo) . "</td>
        </tr>

        <tr>
        <td style='text-align:left;'>Porcentaje de Asistencia</td>
        <td>" . intval($total) . "%</td>
        <td>" . intval($totals) . "%</td>
        <td>" . intval($totalf) . "%</td>
        </tr>
      </table>";
      }else{
          $html_notas[$y][0] .="<table border='1' cellspacing='0' cellpadding='0' style='width:98%;margin:35px 5px 25px 5px;padding:5px;border-collapse:collapse;'>
        <tr>
          <th style='width:30%;' rowspan=2>ASISTENCIA</th>
          <th style='width:38%;' colspan=3>TRIMESTRES</th>
          <th style='width:30%;' rowspan=2>TOTAL</th>
        </tr>
        <tr>

          <th>1º</th>
          <th>2º</th>
          <th>3º</th>

        </tr>

        <tr>
        <td style='text-align:left;'>Días de Clases</td>
        <td>" . $diastrabajadosprimer . "</td>
        <td>" . $diastrabajadossegundo . "</td>
        <td>" . $diastrabajadostercero . "</td>
        <td>" . ($diastrabajadosprimer + $diastrabajadossegundo+$diastrabajadostercero) . "</td>
        </tr>

        <tr>
        <td style='text-align:left;'>Días de Inasistencia</td>
        <td>" . $diasinprimer . "</td>
        <td>" . $diasinsegundo . "</td>
        <td>" . $diasintercero . "</td>
        <td>" . ($diasinprimer + $diasinsegundo+$diasintercero) . "</td>
        </tr>

        <tr>
        <td style='text-align:left;'>Porcentaje de Asistencia</td>
        <td>" . intval($total) . "%</td>
        <td>" . intval($totals) . "%</td>
        <td>" . intval($totalt) . "%</td>
        <td>" . intval($totalf) . "%</td>
        </tr>
      </table>";
      }


      $html_notas[$y][0] .="<h3 style='align-content: center'>" . $nombreedu . "</h3></div>";

                $html_notas[$y][1] = "<h3 style='text-align:center;margin-top:20px'>" . $listambitos[0]['nombreAmbito'] . "</h3>";
                if ($listambitos[0]['idAmbito'] > 3) {
                    $html_notas[$y][1] .= "<table align=center style='width:100%; margin-top:20px;'><tr><td style='width: 95%;'>" . $listambitos[0]['descripcionAmbito'] . "</td></tr></table>";

                }
                for ($k = 0; $k < $largonucleouno; $k++) {

                    if ($listambitos[0]['idAmbito'] > 3) {
                        $html_notas[$y][1] .= "<table align=center style='width:100%; margin-top:25px;'><tr><td><h5>" . $nucleosuno[$k]['nombreNucleo'] . "</h5></td></tr><tr><td style='width: 95%;'>" . $nucleosuno[$k]['descripcionNucleo'] . "</td></tr></table>";
                    }
                    if($idtevalucacion==1){
                        $html_notas[$y][1] .= "<table border=1 align=center style='width:95%; margin-top:25px;border-collapse:collapse;'><tr><td><h5>" . $nucleosuno[$k]['nombreNucleo'] . "</h5></td><td style='text-align:center;'>1er Semestre</td><td style='text-align:center;'>2do Semestre</td><td style='text-align:center;'>Informe Final</td></tr>";

                    }else{
                        $html_notas[$y][1] .= "<table border=1 align=center style='width:95%; margin-top:25px;border-collapse:collapse;'><tr><td><h5>" . $nucleosuno[$k]['nombreNucleo'] . "</h5></td><td style='text-align:center;'>I TRIM</td><td style='text-align:center;'>II TRIM</td><td style='text-align:center;'>III TRIM</td><td style='text-align:center;'>Final</td></tr>";

                    }

                    for ($j = 0; $j < $largoasignatura; $j++) {
                        if ($datosasignaturas[$j]['idNucleo'] == $nucleosuno[$k]['idNucleo']) {
                            $html_notas[$y][1] .= "<tr><td style='width:65%'>" . $datosasignaturas[$j]['nombreAsignatura'] . "</td>";


                            if ($segmento == 1) {
                                $promedioprimer[$j] = $tabla->getnotaspresegmentomonitorlag($idalumnoactual, $idperiodo, 1, $datosasignaturas[$j]['idAsignatura'], $detalleest[0]['idCursos']);
                                $promediosegundo[$j] = array();


                            } elseif($segmento==2) {
                                $promedioprimer[$j] = $tabla->getnotaspresegmentomonitorlag($idalumnoactual, $idperiodo, 1, $datosasignaturas[$j]['idAsignatura'], $detalleest[0]['idCursos']);
                                $promediosegundo[$j] = $tabla->getnotaspresegmentomonitorlag($idalumnoactual, $idperiodo, 2, $datosasignaturas[$j]['idAsignatura'], $detalleest[0]['idCursos']);

                            }elseif($segmento==3) {
                                $promedioprimer[$j] = $tabla->getnotaspresegmentomonitorlag($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idAsignatura'], $detalleest[0]['idCursos']);
                                $promediosegundo[$j] = array();
                                $promediotercero[$j] = array();

                            }elseif($segmento==4) {
                                $promedioprimer[$j] = $tabla->getnotaspresegmentomonitorlag($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idAsignatura'], $detalleest[0]['idCursos']);
                                $promediosegundo[$j] = $tabla->getnotaspresegmentomonitorlag($idalumnoactual, $idperiodo, 4, $datosasignaturas[$j]['idAsignatura'], $detalleest[0]['idCursos']);
                                $promediotercero[$j] = array();

                            }elseif($segmento==5) {
                                $promedioprimer[$j] = $tabla->getnotaspresegmentomonitorlag($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idAsignatura'], $detalleest[0]['idCursos']);
                                $promediosegundo[$j] = $tabla->getnotaspresegmentomonitorlag($idalumnoactual, $idperiodo, 4, $datosasignaturas[$j]['idAsignatura'], $detalleest[0]['idCursos']);
                                $promediotercero[$j] = $tabla->getnotaspresegmentomonitorlag($idalumnoactual, $idperiodo, 5, $datosasignaturas[$j]['idAsignatura'], $detalleest[0]['idCursos']);

                            }



                            $primers[$j] = $promedioprimer[$j][0]['nota'];
                            $segundos[$j] = $promediosegundo[$j][0]['nota'];
                            $terceros[$j] = $promediotercero[$j][0]['nota'];



                            if ($promedioprimer[$j][0]['nota'] == null) {
                                $primers[$j] = 0;
                            }

                            if ($promediosegundo[$j][0]['nota'] == null) {
                                $segundos[$j] = 0;

                            }
                            if ($promediotercero[$j][0]['nota'] == null) {
                                $terceros[$j] = 0;

                            }


                             if (!empty($largodetallealumno) || $tipo == 1) {
                                 $promedio_aux = array($primers[$j], $segundos[$j], $terceros[$j]);
                                 $resultado_aux = array_values(array_diff($promedio_aux, array('0')));

                                 if (!empty($resultado_aux)) {

                                     $finals[$j] = intval((array_sum($resultado_aux)) / count($resultado_aux));


                                 } else {
                                     $finals[$j] = 0;
                                 }
                            }


                            $primers[$j] = $this->equivalenciaslagpre($resultado, $primers[$j]);
                            $segundos[$j] = $this->equivalenciaslagpre($resultado, $segundos[$j]);
                            $finals[$j] = $this->equivalenciaslagpre($resultado, $finals[$j]);




                            if($idtevalucacion==1){
                                $html_notas[$y][1] .= "<td style='width:10%;text-align:center;'>" . $primers[$j][1] . "</td><td style='width:10%;text-align:center;'>" . $segundos[$j][1] . "</td><td style='width:10%;text-align:center;'>" . $finals[$j][1] . "</td></tr>";
                            }elseif($idtevalucacion==2){
                                $html_notas[$y][1] .= "<td style='width:10%;text-align:center;'>" . $primers[$j][1] . "</td><td style='width:10%;text-align:center;'>" . $segundos[$j][1] . "</td><td style='width:10%;text-align:center;'>" . $terceros[$j][1] . "</td><td style='width:10%;text-align:center;'>" . $finals[$j][1] . "</td></tr>";

                            }

                        }

                    } //fin for datosasignaturas


                    $html_notas[$y][1] .= "</table>";

                }//Fin Nucleos



                $html_notas[$y][2] = "<h3 style='text-align:center;margin-top:20px'>" . $listambitos[1]['nombreAmbito'] . "</h3>";
                if ($listambitos[1]['idAmbito'] > 3) {
                    $html_notas[$y][2] .= "<table align=center style='width:100%; margin-top:20px;'><tr><td style='width: 95%;'>" . $listambitos[1]['descripcionAmbito'] . "</td></tr></table>";
                }
                for ($k = 0; $k < $largonucleodos; $k++) {

                    if ($listambitos[0]['idAmbito'] > 3) {
                        $html_notas[$y][2] .= "<table align=center style='width:100%; margin-top:25px;'><tr><td><h5>" . $nucleosdos[$k]['nombreNucleo'] . "</h5></td></tr><tr><td style='width: 95%;'>" . $nucleosdos[$k]['descripcionNucleo'] . "</td></tr></table>";
                    }
                    if($idtevalucacion==1){
                        $html_notas[$y][2] .= "<table border=1 align=center style='width:95%; margin-top:25px;border-collapse:collapse;'><tr><td><h5>" . $nucleosdos[$k]['nombreNucleo'] . "</h5></td><td style='text-align:center;'>1er Semestre</td><td style='text-align:center;'>2do Semestre</td><td style='text-align:center;'>Informe Final</td></tr>";

                    }else{
                        $html_notas[$y][2] .= "<table border=1 align=center style='width:95%; margin-top:25px;border-collapse:collapse;'><tr><td><h5>" . $nucleosdos[$k]['nombreNucleo'] . "</h5></td><td style='text-align:center;'>I TRIM</td><td style='text-align:center;'>II TRIM</td><td style='text-align:center;'>III TRIM</td><td style='text-align:center;'>Final</td></tr>";

                    }

                    for ($j = 0; $j < $largoasignatura; $j++) {
                        if ($datosasignaturas[$j]['idNucleo'] == $nucleosdos[$k]['idNucleo']) {
                            $html_notas[$y][2] .= "<tr><td style='width:65%'>" . $datosasignaturas[$j]['nombreAsignatura'] . "</td>";


                            if ($segmento == 1) {
                                $promedioprimer[$j] = $tabla->getnotaspresegmentomonitorlag($idalumnoactual, $idperiodo, 1, $datosasignaturas[$j]['idAsignatura'], $detalleest[0]['idCursos']);
                                $promediosegundo[$j] = array();


                            } elseif($segmento==2) {
                                $promedioprimer[$j] = $tabla->getnotaspresegmentomonitorlag($idalumnoactual, $idperiodo, 1, $datosasignaturas[$j]['idAsignatura'], $detalleest[0]['idCursos']);
                                $promediosegundo[$j] = $tabla->getnotaspresegmentomonitorlag($idalumnoactual, $idperiodo, 2, $datosasignaturas[$j]['idAsignatura'], $detalleest[0]['idCursos']);

                            }elseif($segmento==3) {
                                $promedioprimer[$j] = $tabla->getnotaspresegmentomonitorlag($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idAsignatura'], $detalleest[0]['idCursos']);
                                $promediosegundo[$j] = array();
                                $promediotercero[$j] = array();

                            }elseif($segmento==4) {
                                $promedioprimer[$j] = $tabla->getnotaspresegmentomonitorlag($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idAsignatura'], $detalleest[0]['idCursos']);
                                $promediosegundo[$j] = $tabla->getnotaspresegmentomonitorlag($idalumnoactual, $idperiodo, 4, $datosasignaturas[$j]['idAsignatura'], $detalleest[0]['idCursos']);
                                $promediotercero[$j] = array();

                            }elseif($segmento==5) {
                                $promedioprimer[$j] = $tabla->getnotaspresegmentomonitorlag($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idAsignatura'], $detalleest[0]['idCursos']);
                                $promediosegundo[$j] = $tabla->getnotaspresegmentomonitorlag($idalumnoactual, $idperiodo, 4, $datosasignaturas[$j]['idAsignatura'], $detalleest[0]['idCursos']);
                                $promediotercero[$j] = $tabla->getnotaspresegmentomonitorlag($idalumnoactual, $idperiodo, 5, $datosasignaturas[$j]['idAsignatura'], $detalleest[0]['idCursos']);

                            }

                            $primers[$j] = $promedioprimer[$j][0]['nota'];
                            $segundos[$j] = $promediosegundo[$j][0]['nota'];
                            $terceros[$j] = $promediotercero[$j][0]['nota'];



                            if ($promedioprimer[$j][0]['nota'] == null) {
                                $primers[$j] = 0;
                            }

                            if ($promediosegundo[$j][0]['nota'] == null) {
                                $segundos[$j] = 0;

                            }
                            if ($promediotercero[$j][0]['nota'] == null) {
                                $terceros[$j] = 0;

                            }


                            if (!empty($largodetallealumno) || $tipo == 1) {
                                $promedio_aux = array($primers[$j], $segundos[$j], $terceros[$j]);
                                $resultado_aux = array_values(array_diff($promedio_aux, array('0')));

                                if (!empty($resultado_aux)) {

                                    $finals[$j] = intval((array_sum($resultado_aux)) / count($resultado_aux));


                                } else {
                                    $finals[$j] = 0;
                                }
                            }


                            $primers[$j] = $this->equivalenciaslagpre($resultado, $primers[$j]);
                            $segundos[$j] = $this->equivalenciaslagpre($resultado, $segundos[$j]);
                            $finals[$j] = $this->equivalenciaslagpre($resultado, $finals[$j]);




                            if($idtevalucacion==1){
                                $html_notas[$y][2] .= "<td style='width:10%;text-align:center;'>" . $primers[$j][1] . "</td><td style='width:10%;text-align:center;'>" . $segundos[$j][1] . "</td><td style='width:10%;text-align:center;'>" . $finals[$j][1] . "</td></tr>";
                            }elseif($idtevalucacion==2){
                                $html_notas[$y][2] .= "<td style='width:10%;text-align:center;'>" . $primers[$j][1] . "</td><td style='width:10%;text-align:center;'>" . $segundos[$j][1] . "</td><td style='width:10%;text-align:center;'>" . $terceros[$j][1] . "</td><td style='width:10%;text-align:center;'>" . $finals[$j][1] . "</td></tr>";

                            }

                        }

                    } //fin for datosasignaturas


                    $html_notas[$y][2] .= "</table>";

                }//Fin Nucleos


                $html_notas[$y][3] = "<h3 style='text-align:center;margin-top:15px'>" . $listambitos[2]['nombreAmbito'] . "</h3>";
                if ($listambitos[2]['idAmbito'] > 3) {
                    $html_notas[$y][3] .= "<table align=center style='width:100%; margin-top:15px;'><tr><td style='width: 95%;'>" . $listambitos[2]['descripcionAmbito'] . "</td></tr></table>";
                }
                for ($k = 0; $k < $largonucleotres; $k++) {

                    if ($listambitos[0]['idAmbito'] > 3) {
                        $html_notas[$y][3] .= "<table align=center style='width:100%; margin-top:32px;'><tr><td><h5>" . $nucleostres[$k]['nombreNucleo'] . "</h5></td></tr><tr><td style='width: 95%;'>" . $nucleostres[$k]['descripcionNucleo'] . "</td></tr></table>";
                    }
                    if($idtevalucacion==1){
                        $html_notas[$y][3] .= "<table border=1 align=center style='width:95%; margin-top:28px;border-collapse:collapse;'><tr><td><h5>" . $nucleostres[$k]['nombreNucleo'] . "</h5></td><td style='text-align:center;'>1er Semestre</td><td style='text-align:center;'>2do Semestre</td><td style='text-align:center;'>Informe Final</td></tr>";

                    }else{
                        $html_notas[$y][3] .= "<table border=1 align=center style='width:95%; margin-top:28px;border-collapse:collapse;'><tr><td><h5>" . $nucleostres[$k]['nombreNucleo'] . "</h5></td><td style='text-align:center;'>I TRIM</td><td style='text-align:center;'>II TRIM</td><td style='text-align:center;'>III TRIM</td><td style='text-align:center;'>Final</td></tr>";

                    }

                    for ($j = 0; $j < $largoasignatura; $j++) {
                        if ($datosasignaturas[$j]['idNucleo'] == $nucleostres[$k]['idNucleo']) {
                            $html_notas[$y][3] .= "<tr><td style='width:65%'>" . $datosasignaturas[$j]['nombreAsignatura'] . "</td>";


                            if ($segmento == 1) {
                                $promedioprimer[$j] = $tabla->getnotaspresegmentomonitorlag($idalumnoactual, $idperiodo, 1, $datosasignaturas[$j]['idAsignatura'], $detalleest[0]['idCursos']);
                                $promediosegundo[$j] = array();


                            } elseif($segmento==2) {
                                $promedioprimer[$j] = $tabla->getnotaspresegmentomonitorlag($idalumnoactual, $idperiodo, 1, $datosasignaturas[$j]['idAsignatura'], $detalleest[0]['idCursos']);
                                $promediosegundo[$j] = $tabla->getnotaspresegmentomonitorlag($idalumnoactual, $idperiodo, 2, $datosasignaturas[$j]['idAsignatura'], $detalleest[0]['idCursos']);

                            }elseif($segmento==3) {
                                $promedioprimer[$j] = $tabla->getnotaspresegmentomonitorlag($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idAsignatura'], $detalleest[0]['idCursos']);
                                $promediosegundo[$j] = array();
                                $promediotercero[$j] = array();

                            }elseif($segmento==4) {
                                $promedioprimer[$j] = $tabla->getnotaspresegmentomonitorlag($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idAsignatura'], $detalleest[0]['idCursos']);
                                $promediosegundo[$j] = $tabla->getnotaspresegmentomonitorlag($idalumnoactual, $idperiodo, 4, $datosasignaturas[$j]['idAsignatura'], $detalleest[0]['idCursos']);
                                $promediotercero[$j] = array();

                            }elseif($segmento==5) {
                                $promedioprimer[$j] = $tabla->getnotaspresegmentomonitorlag($idalumnoactual, $idperiodo, 3, $datosasignaturas[$j]['idAsignatura'], $detalleest[0]['idCursos']);
                                $promediosegundo[$j] = $tabla->getnotaspresegmentomonitorlag($idalumnoactual, $idperiodo, 4, $datosasignaturas[$j]['idAsignatura'], $detalleest[0]['idCursos']);
                                $promediotercero[$j] = $tabla->getnotaspresegmentomonitorlag($idalumnoactual, $idperiodo, 5, $datosasignaturas[$j]['idAsignatura'], $detalleest[0]['idCursos']);

                            }

                            $primers[$j] = $promedioprimer[$j][0]['nota'];
                            $segundos[$j] = $promediosegundo[$j][0]['nota'];
                            $terceros[$j] = $promediotercero[$j][0]['nota'];



                            if ($promedioprimer[$j][0]['nota'] == null) {
                                $primers[$j] = 0;
                            }

                            if ($promediosegundo[$j][0]['nota'] == null) {
                                $segundos[$j] = 0;

                            }
                            if ($promediotercero[$j][0]['nota'] == null) {
                                $terceros[$j] = 0;

                            }


                            if (!empty($largodetallealumno) || $tipo == 1) {
                                $promedio_aux = array($primers[$j], $segundos[$j], $terceros[$j]);
                                $resultado_aux = array_values(array_diff($promedio_aux, array('0')));

                                if (!empty($resultado_aux)) {

                                    $finals[$j] = intval((array_sum($resultado_aux)) / count($resultado_aux));


                                } else {
                                    $finals[$j] = 0;
                                }
                            }


                            $primers[$j] = $this->equivalenciaslagpre($resultado, $primers[$j]);
                            $segundos[$j] = $this->equivalenciaslagpre($resultado, $segundos[$j]);
                            $finals[$j] = $this->equivalenciaslagpre($resultado, $finals[$j]);




                            if($idtevalucacion==1){
                                $html_notas[$y][3] .= "<td style='width:10%;text-align:center;'>" . $primers[$j][1] . "</td><td style='width:10%;text-align:center;'>" . $segundos[$j][1] . "</td><td style='width:10%;text-align:center;'>" . $finals[$j][1] . "</td></tr>";
                            }elseif($idtevalucacion==2){
                                $html_notas[$y][3] .= "<td style='width:10%;text-align:center;'>" . $primers[$j][1] . "</td><td style='width:10%;text-align:center;'>" . $segundos[$j][1] . "</td><td style='width:10%;text-align:center;'>" . $terceros[$j][1] . "</td><td style='width:10%;text-align:center;'>" . $finals[$j][1] . "</td></tr>";

                            }

                        }

                    } //fin for datosasignaturas


                    $html_notas[$y][3] .= "</table>";

                }//Fin Nucleos


                //Nuevo Hoja al Apoderado

                if (file_exists($logo)) {
                    $html_notas[$y][4] = '<p style="position:absolute;top:3%;text-align:left"></p><p style="position:absolute;top:1%;text-align:center"><img  src="' . $logo . '" /></p>';

                } else {
                    $html_notas[$y][4] = '';

                }


                $html_notas[$y][4] .= "<div style='width:100%;outline: 2px solid #699;outline-offset: -9px;text-align:center; margin:5px 0 0px 0; height:730px;'>
  
      <table style='width:98%;border:none;margin:5px 5px 5px 5px;padding:5px;'>
        <tr>
          <td style='width:19%; text-align:left;border:none;'>Nombre de Alumno(a)</td>
          <td colspan='3' style='width:69%; text-align:left;border:none;'>" . $listadealumnos[$y]['nombres'] . " " . $listadealumnos[$y]['apaterno'] . " " . $listadealumnos[$y]['amaterno'] . "</td>
        </tr>

      </table>
      <p style='text-align: justify;padding: 5px'>La Educación Parvularia acoge a un niño o niña arraigado en su familia y le corresponde compartir con ella la labor educativa, complementándola y ampliando las experiencias de aprendizajes y desarrollo integral que se le ofrecen. Por ello, es fundamental que se establezcan perspectivas y líneas de trabajo en común y se potencie el esfuerzo educativo que unas y otras realizan en favor de las niñas y los niños.</p>
      <h5 style='text-align: left;'>Que espero que aprenda mi hijo o hija durante este año:</h5>
      <table style='width:100%;border: 1px double #000;outline: 2px solid #699;outline-offset: -9px;text-align:center; margin:5px 0 0px 0; height:100px;'>
        <tr><td style='width: 100%;height: 100px;'></td></tr>
      </table>";

                if($idtevalucacion==1){
                    $html_notas[$y][4] .="<h5 style='text-align: left;'>Que aprendió mi hijo o hija durante el primer semestre:</h5>
        <table style='width:100%;border: 1px double #000;outline: 2px solid #699;outline-offset: -9px;text-align:center; margin:10px 0 0px 0; height:100px;'>
            <tr><td style='width: 100%;height: 100px;'></td></tr>
        </table>

        <h5 style='text-align: left;'>Que aprendió mi hijo o hija durante el segundo semestre:</h5>
        <table style='width:100%;border: 1px double #000;outline: 2px solid #699;outline-offset: -9px;text-align:center; margin:10px 0 0px 0; height:100px;'>
            <tr><td style='width: 100%;height: 100px;'></td></tr>
        </table>
      
        <table align=center style='width:95%;margin-top:85px;'>
          <tr>
            <td style='width:50%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          </tr> 
          <tr>
            <td style='width:50%;text-align:center;border:none;'>Nombre y Firma del Apoderado</td>
          </tr>
        </table>
        </div>";
                }else{
                    $html_notas[$y][4] .="<h5 style='text-align: left;'>Que aprendió mi hijo o hija durante el primer trimestre:</h5>
        <table style='width:100%;border: 1px double #000;outline: 2px solid #699;outline-offset: -9px;text-align:center; margin:5px 0 0px 0; height:100px;'>
            <tr><td style='width: 100%;height: 100px;'></td></tr>
        </table>

        <h5 style='text-align: left;'>Que aprendió mi hijo o hija durante el segundo trimestre:</h5>
        <table style='width:100%;border: 1px double #000;outline: 2px solid #699;outline-offset: -9px;text-align:center; margin:5px 0 0px 0; height:100px;'>
            <tr><td style='width: 100%;height: 100px;'></td></tr>
        </table>
        
        
        <h5 style='text-align: left;'>Que aprendió mi hijo o hija durante el tercer trimestre:</h5>
        <table style='width:100%;border: 1px double #000;outline: 2px solid #699;outline-offset: -9px;text-align:center; margin:5px 0 0px 0; height:100px;'>
            <tr><td style='width: 100%;height: 100px;'></td></tr>
        </table>
      
        <table align=center style='width:95%;margin-top:65px;'>
          <tr>
            <td style='width:50%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          </tr> 
          <tr>
            <td style='width:50%;text-align:center;border:none;'>Nombre y Firma del Apoderado</td>
          </tr>
        </table>
        </div>";
                }

                $html_notas[$y][5] = "<h3 style='text-align:center;margin-top:5px'>INFORME:Evaluación de Aprendizajes</h3>
  <h5 style='text-align:center;margin-top:5px'>¿Cómo Interpretar y Apoyar a sus hijos con ésta información?</h5>
  <table style='width:95%;border-collapse:collapse;' border=1 align=center >";


                for ($l = 0; $l < $largoresultadomostrar; $l++) {

                    $html_notas[$y][5] .= "<tr><td style='text-align:center; width:10%;'>" . $resultadomostrar[$l]['nivelLogro'] . "</td><td style='text-align:left; width:85%;'>Si su hijo/a tiene una " . $resultadomostrar[$l]['nivelLogro'] . ", " . $resultadomostrar[$l]['descripcionLogro'] . "</td></tr>";
                }

                if($idtevalucacion==1){
                    $html_notas[$y][5] .= "</table><h3 style='text-align:center;margin-top:20px'>PRIMER SEMESTRE</h3>
        <table border=1 align=center style='width:95%; border-collapse:collapse;'>
          <tr>
            <td style='width:95%;text-align: left;'>Observaciones y Sugerencia de la Educadora:</td>
          </tr>
          <tr>
            <td style='width:95%;height:5%;text-align:left;'>" . $observacionprimer . "</td>
          </tr>
        </table>
         <table align='center' style='width:95%;margin-top:45px;' class='page_firmas'>
         <tr>
          <td style='width:33%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          <td style='width:33%;text-align:center;'></td>
          <td style='width:33%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          </tr>
            <tr>
                <td style='width: 33%; text-align: center;border:none;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</td>
                <td style='width: 33%; text-align: center;border:none;'></td>
                <td style='width: 33%; text-align: center;border:none;'>" . $director['nombrescuenta'] . " " . $director['paternocuenta'] . " " . $director['maternocuenta'] . "</td>
            </tr>
            <tr>
                <td style='width: 33%; text-align:center;border:none;padding-top:5px'>Educadora de Párvulo</td>
                <td style='width: 33%; text-align: center;border:none;padding-top:5px'></td>
                <td style='width: 33%; text-align:center;border:none;padding-top:5px'>Director</td>
            </tr>
            
            </table>

        <hr style='width:100%'>

        <h3 style='text-align:center;margin-top:20px'>SEGUNDO SEMESTRE</h3>
        <table border=1 align=center style='width:95%;border-collapse:collapse;'>
          <tr>
            <td style='width:95%;text-align: left;'>Observaciones y Sugerencias de la Educadora:</td>
          </tr>
          <tr>
            <td style='width:95%;height:5%;text-align:left;'>" . $observacionsegundo . "</td>
          </tr>
        </table>

         <table align='center' style='width:95%;margin-top:45px;' class='page_firmas'>
         <tr>
          <td style='width:33%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          <td style='width:33%;text-align:center;'></td>
          <td style='width:33%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          </tr>
            <tr>
                <td style='width: 33%; text-align: center;border:none;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</td>
                <td style='width: 33%; text-align: center;border:none;'></td>
                <td style='width: 33%; text-align: center;border:none;'>" . $director['nombrescuenta'] . " " . $director['paternocuenta'] . " " . $director['maternocuenta'] . "</td>
            </tr>
            <tr>
                <td style='width: 33%; text-align:center;border:none;padding-top:5px'>Educadora de Párvulo</td>
                <td style='width: 33%; text-align: center;border:none;padding-top:5px'></td>
                <td style='width: 33%; text-align:center;border:none;padding-top:5px'>Director</td>
            </tr>
            
            </table>


         <hr style='width:100%'>

          <h3 style='text-align:center;margin-top:20px'>INFORME FINAL</h3>
        <table border=1 align=center style='width:95%;border-collapse:collapse;'>
          <tr>
            <td style='width:95%;text-align: left;'>Observaciones y Sugerencias de la Educadora:</td>
          </tr>
          <tr>
            <td style='width:95%;height:5%;text-align:left;'>" . $observacion . "</td>
          </tr>
        </table>

        <table align='center' style='width:95%;margin-top:45px;' class='page_firmas'>
         <tr>
          <td style='width:33%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          <td style='width:33%;text-align:center;'></td>
          <td style='width:33%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          </tr>
            <tr>
                <td style='width: 33%; text-align: center;border:none;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</td>
                <td style='width: 33%; text-align: center;border:none;'></td>
                <td style='width: 33%; text-align: center;border:none;'>" . $director['nombrescuenta'] . " " . $director['paternocuenta'] . " " . $director['maternocuenta'] . "</td>
            </tr>
            <tr>
                <td style='width: 33%; text-align:center;border:none;padding-top:5px'>Educadora de Párvulo</td>
                <td style='width: 33%; text-align: center;border:none;padding-top:5px'></td>
                <td style='width: 33%; text-align:center;border:none;padding-top:5px'>Director</td>
            </tr>
            
            </table>";

                }else{
                    $html_notas[$y][5] .= "</table><h3 style='text-align:center;margin-top:5px'>PRIMER TRIMESTRE</h3>
        <table border=1 align=center style='width:95%; border-collapse:collapse;'>
          <tr>
            <td style='width:95%;text-align: left;'>Observaciones y Sugerencia de la Educadora:</td>
          </tr>
          <tr>
            <td style='width:95%;height:5%;text-align:left;'>" . $observacionprimer . "</td>
          </tr>
        </table>
         <table align='center' style='width:95%;margin-top:35px;' class='page_firmas'>
         <tr>
          <td style='width:33%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          <td style='width:33%;text-align:center;'></td>
          <td style='width:33%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          </tr>
            <tr>
                <td style='width: 33%; text-align: center;border:none;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</td>
                <td style='width: 33%; text-align: center;border:none;'></td>
                <td style='width: 33%; text-align: center;border:none;'>" . $director['nombrescuenta'] . " " . $director['paternocuenta'] . " " . $director['maternocuenta'] . "</td>
            </tr>
            <tr>
                <td style='width: 33%; text-align:center;border:none;padding-top:5px'>Educadora de Párvulo</td>
                <td style='width: 33%; text-align: center;border:none;padding-top:5px'></td>
                <td style='width: 33%; text-align:center;border:none;padding-top:5px'>Director</td>
            </tr>
            
            </table>

        <hr style='width:100%'>

        <h3 style='text-align:center;margin-top:5px'>SEGUNDO TRIMESTRE</h3>
        <table border=1 align=center style='width:95%;border-collapse:collapse;'>
          <tr>
            <td style='width:95%;text-align: left;'>Observaciones y Sugerencias de la Educadora:</td>
          </tr>
          <tr>
            <td style='width:95%;height:5%;text-align:left;'>" . $observacionsegundo . "</td>
          </tr>
        </table>

         <table align='center' style='width:95%;margin-top:30px;' class='page_firmas'>
         <tr>
          <td style='width:33%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          <td style='width:33%;text-align:center;'></td>
          <td style='width:33%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          </tr>
            <tr>
                <td style='width: 33%; text-align: center;border:none;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</td>
                <td style='width: 33%; text-align: center;border:none;'></td>
                <td style='width: 33%; text-align: center;border:none;'>" . $director['nombrescuenta'] . " " . $director['paternocuenta'] . " " . $director['maternocuenta'] . "</td>
            </tr>
            <tr>
                <td style='width: 33%; text-align:center;border:none;padding-top:5px'>Educadora de Párvulo</td>
                <td style='width: 33%; text-align: center;border:none;padding-top:5px'></td>
                <td style='width: 33%; text-align:center;border:none;padding-top:5px'>Director</td>
            </tr>
            
            </table>
            
            <hr style='width:100%'>
            
            <h3 style='text-align:center;margin-top:5px'>TERCER TRIMESTRE</h3>
        <table border=1 align=center style='width:95%;border-collapse:collapse;'>
          <tr>
            <td style='width:95%;text-align: left;'>Observaciones y Sugerencias de la Educadora:</td>
          </tr>
          <tr>
            <td style='width:95%;height:5%;text-align:left;'>" . $observaciontercero . "</td>
          </tr>
        </table>

         <table align='center' style='width:95%;margin-top:30px;' class='page_firmas'>
         <tr>
          <td style='width:33%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          <td style='width:33%;text-align:center;'></td>
          <td style='width:33%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          </tr>
            <tr>
                <td style='width: 33%; text-align: center;border:none;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</td>
                <td style='width: 33%; text-align: center;border:none;'></td>
                <td style='width: 33%; text-align: center;border:none;'>" . $director['nombrescuenta'] . " " . $director['paternocuenta'] . " " . $director['maternocuenta'] . "</td>
            </tr>
            <tr>
                <td style='width: 33%; text-align:center;border:none;padding-top:5px'>Educadora de Párvulo</td>
                <td style='width: 33%; text-align: center;border:none;padding-top:5px'></td>
                <td style='width: 33%; text-align:center;border:none;padding-top:5px'>Director</td>
            </tr>
            
            </table>


         <hr style='width:100%'>

          <h3 style='text-align:center;margin-top:5px'>INFORME FINAL</h3>
        <table border=1 align=center style='width:95%;border-collapse:collapse;'>
          <tr>
            <td style='width:95%;text-align: left;'>Observaciones y Sugerencias de la Educadora:</td>
          </tr>
          <tr>
            <td style='width:95%;height:5%;text-align:left;'>" . $observacion . "</td>
          </tr>
        </table>

        <table align='center' style='width:95%;margin-top:30px;' class='page_firmas'>
         <tr>
          <td style='width:33%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          <td style='width:33%;text-align:center;'></td>
          <td style='width:33%;text-align:center;border:none;border-bottom: 1px solid black;'></td>
          </tr>
            <tr>
                <td style='width: 33%; text-align: center;border:none;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</td>
                <td style='width: 33%; text-align: center;border:none;'></td>
                <td style='width: 33%; text-align: center;border:none;'>" . $director['nombrescuenta'] . " " . $director['paternocuenta'] . " " . $director['maternocuenta'] . "</td>
            </tr>
            <tr>
                <td style='width: 33%; text-align:center;border:none;padding-top:5px'>Educadora de Párvulo</td>
                <td style='width: 33%; text-align: center;border:none;padding-top:5px'></td>
                <td style='width: 33%; text-align:center;border:none;padding-top:5px'>Director</td>
            </tr>
            
            </table>";
                }

            }


            if ($html_notas != '') {

                require 'fpdf/html2pdf.class.php';
                try {
                    //Orientación / formato del pdf y el idioma.
                    $pdf = new HTML2PDF('P', 'LETTER', 'es', array(10, 10, 10, 10) /*márgenes*/); //los márgenes también pueden definirse en <page> ver documentación

                    //inicio ciclo

                    for ($j = 0; $j < count($html_notas); $j++) {
                        for ($k = 0; $k < count($html_notas[$j]); $k++) {
                            $pdf->WriteHTML('<page><html>
        <head>
            <style>' . $style . '</style>
        </head>
        <body> <page_footer>
        <table class="page_footer">
            <tr>
            <td style="width: 40%; text-align: left;border:none;"></td>
                <td style="width: 60%; text-align: right;border:none;font-size:8px">

                </td>
            </tr>
        </table>
    </page_footer>' . $html_notas[$j][$k] . '</body></html></page>');
                        }
                    }

                    //fin ciclo

                    if (preg_match("/MSIE/i", $_SERVER["HTTP_USER_AGENT"])) {
                        header("Content-type: application/PDF");
                    } else {
                        header("Content-type: application/PDF");
                        header("Content-Type: application/pdf");
                    }

                    $pdf->Output('Planificacion.pdf', I);
                } catch (HTML2PDF_exception $e) {
                    //echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, intente nuevamente\");</script>";
                    //echo "<script>parent.$.fancybox.close();</script>";
                    echo $e;
                }
            }


        }
    }

    public function generaralumnoperiodopremonitorAction()
    {
//        $this->_helper->viewRenderer->setNeverRender(true);
//        $this->_helper->ViewRenderer->setNoRender(true);
//        $this->_helper->Layout->disableLayout();
//
//        $id = $this->_getParam('id', 0);
//        $segmento = $this->_getParam('s', 0);
//        if ($id > 0 && $segmento > 0) {
//            $this->redirect('/Informes/generaralumnocursoanualpremonitor/id/' . $id . '/t/2/s/' . $segmento);
//        }

        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();

        $paso = false;
        //debe venir un parametro, por GET o POST, llamado idasignatura, con el id del Asignatura a borrar
        $id = $this->_getParam('id', 0);
        $segmento = $this->_getParam('s', 0);
        $modeloalumnodetalle = new Application_Model_DbTable_AlumnosDetalle();

        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        //verificamos si existen datos del detalle del alumno
        $verifica = $modeloalumnodetalle->get($id, $segmento, $idperiodo);

        if ($verifica) {
            //si existen datos mostramos un formulario para que el usuario seleccione si desea modificar los datos o continuar con el documento

            $verifica = $modeloalumnodetalle->get($id, $segmento, $idperiodo);
            $idp = $segmento;

            $diastrabajados = $verifica[0]["diasTrabajado"];
            $diasin = $verifica[0]["diasInasistencia"];
            $asistencia = $verifica[0]["asistencia"];

            $observacion = $verifica[0]["observaciones"];

            $idd = $verifica[0]["idDetalle"];
            echo "<link href='../../../../../css/formpdf.css' type='text/css' rel='stylesheet' /><div class='col_12 column'><form class='basic-grey' method='post' action='generaralumnoperiodopremonitor'><label  for='trab'> <span>Nº dias Trabajados:</span>  <input class='col_2' type='text' id='trab' value='" . $diastrabajados . "' name='trab' /> </label> <label class='col_10' for='ina'> <span>Nº dias Inasistencia:</span> <input  type='text' id='ina' value='" . $diasin . "' name='ina' /></label><label  for='obs'><span> Observaciones:</span> <textarea id='obs' name='obs' rows='5' cols='40'>" . $observacion . "</textarea></label><label><span>&nbsp;</span><button name='mod'value='1'>Modificar</button><button name='cont'value='1'>Continuar</button> <input type='hidden' name='id' value='" . $id . "' /><input type='hidden' name='idp' value='" . $segmento . "' /><input type='hidden' name='idd' value='" . $idd . "' /></label></form></div>";

            //si el usuario desea modificar

        } else {
            echo "<link href='../../../../../css/formpdf.css' type='text/css' rel='stylesheet' /><div class='col_12 column'><form class='basic-grey' method='post' action='generaralumnoperiodopremonitor'><label  for='trab'> <span>Nº dias Trabajados:</span>  <input class='col_2' type='text' id='trab' name='trab' /> </label> <label class='col_10' for='ina'> <span>Nº dias Inasistencia:</span> <input  type='text' id='ina' name='ina' /></label><label  for='obs'><span> Observaciones:</span> <textarea id='obs' name='obs' rows='5' cols='40'></textarea></label><label><span>&nbsp;</span><input type='submit' name='submit' value='Enviar'> <input type='hidden' name='id' value='" . $id . "' /><input type='hidden' name='idp' value='" . $segmento . "' /></label></form></div>";

        }

        //si Vienen datos por post

        if ($this->getRequest()->isPost()) {

            $periodo = new Zend_Session_Namespace('periodo');
            $idperiodo = $periodo->periodo;

            $id = $_POST["id"];
            $idp = $_POST["idp"];
            $idd = $_POST["idd"];

            if (empty($_POST['cont']) && empty($_POST['mod'])) {
                $validadetalle = $modeloalumnodetalle->get($_POST["id"], $idp, $idperiodo);
                if ($validadetalle) {
                    $modeloalumnodetalle->cambiar($_POST["trab"], $_POST["ina"], $_POST["asi"], 0, $_POST["obs"], 0, $idp, $validadetalle[0]["idDetalle"]);
                } else {
                    $modeloalumnodetalle->agregar($_POST["trab"], $_POST["ina"], $_POST["asi"], 0, $_POST["obs"], 0, $idp, $_POST["id"], $idperiodo);
                }

            }
            if (empty($_POST['cont']) && $_POST['mod'] == 1) {
                $modeloalumnodetalle->cambiar($_POST["trab"], $_POST["ina"], $_POST["asi"], 0, $_POST["obs"], 0, $idp, $_POST["idd"]);
            }
            if ($_POST['cont'] == 1) {
                $paso = true;
            }

            $paso = true;

        }

        if ($paso) {

            $this->redirect('/Informes/generaralumnocursoanualpremonitor/id/' . $id . '/t/2/s/' . $idp);

        }


    }

    function equivalenciaslagpre($lista_equivalencia, $nota)
    {

        $valor_nota = array();
        $numeros = array();
        $escala = array();
        $largo = count($lista_equivalencia);
        if ($largo > 0) {
            for ($i = 0; $i < $largo; $i++) {
                $numeros[$i] = range($lista_equivalencia[$i]['porcentaje_final'], $lista_equivalencia[$i]['porcentaje_inicio']);

                if (($i + 1) == $largo) {
                    $step = (count(range($lista_equivalencia[$i]['equivalencia_nota'], $lista_equivalencia[$i]['equivalencia_nota'] + 1)) / count($numeros[$i]));
                } else {
                    $step = (count(range($lista_equivalencia[$i]['equivalencia_nota'], $lista_equivalencia[$i + 1]['equivalencia_nota'] + 1)) / count($numeros[$i]));
                }


                for ($j = 0; $j < count($numeros[$i]); $j++) {
                    if ($j == 0) {
                        if ($lista_equivalencia[$i]['equivalencia_nota'] == $nota) {
                            $valor_nota = array($numeros[$i][$j], $lista_equivalencia[$i]['nivelLogro']);
                            break;
                        }
                        $escala[$i][$j] = $lista_equivalencia[$i]['equivalencia_nota'];
                    } else {
                        $aux_nota = $escala[$i][$j - 1];
                        $escala[$i][$j] = $aux_nota - $step;
                        if ($escala[$i][$j] == $nota) {
                            $valor_nota = array($numeros[$i][$j], $lista_equivalencia[$i]['nivelLogro']);
                            break;
                        } elseif (round($aux_nota - $step) == $nota) {
                            $valor_nota = array($numeros[$i][$j], $lista_equivalencia[$i]['nivelLogro']);
                            break;
                        }
                    }

                }

            }

        }

        return $valor_nota;


    }

    public function generaralumnoanualpremonitorAction()
    {

        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();
        $paso = false;

        //debe venir un parametro, por GET o POST, llamado idasignatura, con el id del Asignatura a borrar
        $id = $this->_getParam('id', 0);

        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;
        $modeldetalle = new Application_Model_DbTable_AlumnosDetalle();

        //verificamos si existen datos del detalle del alumno
        $verifica = $modeldetalle->get($id, 10, $idperiodo);

        if ($verifica) {
            //si existen datos mostramos un formulario para que el usuario seleccione si desea modificar los datos o continuar con el documento

            $verifica = $modeldetalle->get($id, 10, $idperiodo);
            $idp = 10;

            $observacion = $verifica[0]["observaciones"];

            $idd = $verifica[0]["idDetalle"];
            echo "<link href='../../../../../css/formpdf.css' type='text/css' rel='stylesheet' /><div class='col_12 column'><form class='basic-grey' method='post' action='generaralumnoanual'><label  for='obs'><span> Observaciones:</span> <textarea id='obs' name='obs' rows='5' cols='40'>" . $observacion . "</textarea></label><label><span>&nbsp;</span><button name='mod' value='1'>Modificar</button><button name='cont' value='1'>Omitir</button> <input type='hidden' name='id' value='" . $id . "' /><input type='hidden' name='idp' value='10' /><input type='hidden' name='idd' value='" . $idd . "' /></label></form></div>";

            //si el usuario desea modificar

        } else {
            echo "<link href='../../../../../css/formpdf.css' type='text/css' rel='stylesheet' /><div class='col_12 column'><form class='basic-grey' method='post' action='generaralumnoanual'><label  for='obs'><span> Observaciones:</span> <textarea id='obs' name='obs' rows='5' cols='40'></textarea></label><label><span>&nbsp;</span><input type='submit' name='submit' value='Enviar'><button name='cont' value='1'>Omitir</button><input type='hidden' name='id' value='" . $id . "' /><input type='hidden' name='idp' value='10' /></label></form></div>";

        }

        //si Vienen datos por post

        if ($this->getRequest()->isPost()) {

            $periodo = new Zend_Session_Namespace('periodo');
            $idperiodo = $periodo->periodo;

            $id = $_POST["id"];
            $idp = $_POST["idp"];
            $idd = $_POST["idd"];

            if (empty($_POST['cont']) && empty($_POST['mod'])) {
                $modeldetalle->agregar(0, 0, 0, 0, $_POST["obs"], 0, $idp, $_POST["id"], $idperiodo);

            }
            if (empty($_POST['cont']) && $_POST['mod'] == 1) {
                $modeldetalle->cambiar(0, 0, 0, 0, $_POST["obs"], 0, $idp, $_POST["idd"]);
            }
            if ($_POST['cont'] == 1) {
                $paso = true;
            }

            $verifica = $modeldetalle->get($id, $idp, $idperiodo);
            $verifica2 = $modeldetalle->get($id, 1, $idperiodo);

            $observacion = $verifica[0]["observaciones"];
            $apoderado = $verifica2[0]["nombreApoderado"];

            $paso = true;

        }

        if ($paso) {


            $this->redirect('/Informes/generaralumnocursoanualpremonitor/id/' . $id . '/t/2/s/3');


        } //fin paso

    }

    public function generaralumnocursoanualtAction()
    {
        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();


        $id = $this->_getParam('id', 0);
        $segmento = 1;
        $tipo = $this->_getParam('t', 0);
        $agregadecimas = false;


        $style = "body{
font:11px Arial, Tahoma, Verdana, Helvetica, sans-serif;

color:#000;
}

#infoizq{

position:absolute;
left:0px;
}

#infoder{

position:absolute;
right:0px;
}

a h1{
font-size:35px;
color:#FFF;
}
img{
width:90px;
height:100px;
}

h2{
color:#FC0;
font-size:15px;
}


table{
width:100%;
height:auto;
margin:5px 0 10px 0;
border-collapse:collapse;
text-align:center;
text-justify:inter-word;
color:#000000;
}

table td,th{
border:1px solid black;
}
 .mes{
text-align:center;
}

table th{
padding:5px;
background-color: #ccc;
}


text-align:center;
font-weight:bold;
color:#000000;
}

.menu{
background-color:#69C;
color:#FFF;
}
.celda{
height: auto;
width: 170px;
text-align:left;
padding:1px;
}

.menu a{
color:#FFF;
}";

        switch ($segmento) {
            case '1':
                $nombresegmento = 'I Semestre';
                break;

            case '2':
                $nombresegmento = 'II Semestre';
                break;

            case '3':
                $nombresegmento = 'I Trimestre';
                break;

            case '4':
                $nombresegmento = 'II Trimestre';
                break;

            case '5':
                $nombresegmento = 'III Trimestre';
                break;


        }


        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $monitoreos = new Zend_Session_Namespace('monitoreo');
        $monitoreo = $monitoreos->monitoreo;
        //creo objeto tabla Notas
        $tabla = new Application_Model_DbTable_Notas();
        $modeloalumnoactual = new Application_Model_DbTable_Alumnosactual();
        if ($tipo == 1) {
            $listadealumnos = $modeloalumnoactual->get($id);
            $idcursoactual = $listadealumnos[0]['idCursosActual'];
        } else {
            $listadealumnos = $modeloalumnoactual->listaralumnoscursoactual($id, $idperiodo);
            $idcursoactual = $id;
        }


        //creo objeto tabla curso
        $modelCurso = new Application_Model_DbTable_Cursos();
        $detalleest = $modelCurso->listarcursoid($idcursoactual, $idperiodo);


        if ($detalleest[0]['monitoreo'] == 1 && $detalleest[0]['idEstablecimiento'] == 12) {
            //creo objeto tabla Notas
            $tabla = new Application_Model_DbTable_Notas();
            $modelasignatura = new Application_Model_DbTable_Asignaturascursos();
            $modeloalumnodetalle = new Application_Model_DbTable_AlumnosDetalle();

            $listaasignatura = $modelasignatura->listarporcursoprioritaria($idcursoactual, 1, array('1', '3'), $idperiodo);
            $listaasignaturaconcepto = $modelasignatura->listarporcurso($idcursoactual, 0, array('5'), $idperiodo);
            //$listaasignaturanoinciden = $modelasignatura->gettaller($idcursoactual, $idperiodo);
            $datosasignaturascombinada = $modelasignatura->getcombinada($idcursoactual, $idperiodo);
            $largocombinada = count($datosasignaturascombinada);
            $largoconcepto = count($listaasignaturaconcepto);
        } else {
            //creo objeto tabla Notas
            $tabla = new Application_Model_DbTable_Notas();
            $modelasignatura = new Application_Model_DbTable_Asignaturascursos();
            $modeloalumnodetalle = new Application_Model_DbTable_AlumnosDetalle();

            $listaasignatura = $modelasignatura->listarporcurso($idcursoactual, 1, array('1', '3'), $idperiodo);
            $listaasignaturaconcepto = $modelasignatura->listarporcurso($idcursoactual, 0, array('5'), $idperiodo);
            $datosasignaturascombinada = $modelasignatura->getcombinada($idcursoactual, $idperiodo);
            $largocombinada = count($datosasignaturascombinada);
            $largoconcepto = count($listaasignaturaconcepto);
        }

        //Configuracion de agregar 2 decimas a curso desde 5 a 4to medio cuando el promedio final es mayor o igual a 6
        if (($detalleest[0]['rbd'] == 1863) && (($detalleest[0]['idCodigo'] == 110 && $detalleest[0]['idGrado'] > 4) || $detalleest[0]['idCodigo'] == 310 || $detalleest[0]['idCodigo'] == 363 || $detalleest[0]['idCodigo'] == 410 || $detalleest[0]['idCodigo'] == 510 || $detalleest[0]['idCodigo'] == 610)) {
            $agregadecimas = true;
        }

        //Monitoreo 27-09-2020

        if ($detalleest[0]['monitoreo'] == 1) {

            if ($detalleest[0]['idEstablecimiento'] == 12 || $detalleest[0]['idEstablecimiento'] == 8) {
                $modeloequivalencia = new Application_Model_DbTable_Equivalencia();
                $lista_equivalencia = $modeloequivalencia->listarperiodo($detalleest[0]['idEstablecimiento'], $idperiodo, 1);
                $lista_niveles = $modeloequivalencia->listarniveleslogro($detalleest[0]['idEstablecimiento'], $idperiodo, 1);

            }


        }


        //creo objeto tabla cuentas
        $modelCuenta = new Application_Model_DbTable_Cuentas();
        $Profesorjefe = $modelCuenta->getusuario($detalleest[0]['idCuentaJefe'], $idperiodo);
        $director = $modelCuenta->get($detalleest[0]['idDirector']);
        $largoalumnos = count($listadealumnos);
        $largoasignatura = count($listaasignatura);


        //Si la configuracion indica que se utiliza examen
        if ($detalleest[0]['examen'] == 1) {
            $modeloprueba = new Application_Model_DbTable_Pruebas();
            //Veficiamos que las asignaturas posean examen
            for ($i = 0; $i < $largoasignatura; $i++) {
                $datosexamenes = $modeloprueba->getexamen($detalleest[0]['idCursos'], $idperiodo, $listaasignatura[$i]['idAsignatura'], 6);
                if (count($datosexamenes) > 0) {

                    $datosalumnosexamen = $tabla->getnotasexamenalumno($datosexamenes[0]['idEvaluacion'], $detalleest[0]['idCursos'], $listaasignatura[$i]['idAsignatura'], $idperiodo, 6, $listadealumnos[0]['idAlumnos']);
                    if (count($datosalumnosexamen) > 0) {
                        if ($datosalumnosexamen[0]['nota'] > 0) {
                            $datosexamenalumno[] = $datosalumnosexamen;
                        }
                    }
                }
            }

        }


        if (count($Profesorjefe) == 0 || $Profesorjefe == null) {
            echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta Profesor Jefe\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            exit;
        }

        if (count($director) == 0 || $director == null) {
            echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, No existe la cuenta Director\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            exit;
        }


        $date = new DateTime;
        $fechain = $date->format('Y-m-d');
        $cortado = explode("-", $fechain);
        $dias = array("Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado");
        $meses = array("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre");

        $fecha_final = $dias[date('w', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]))] . " " . $cortado[2] . " de " . $meses[date('n', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0])) - 1] . " del " . date('Y', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]));

        $niveleducacion = $detalleest[0]['idCodigoTipo'];
        $grado = $detalleest[0]['idGrado'];

        if ($niveleducacion == '110') {
            $nombreedu = 'Enseñanza Básica';

        }

        if ($niveleducacion == '310') {
            $nombreedu = 'Enseñanza Media';

        }
        if ($niveleducacion == '410') {
            $nombreedu = 'Enseñanza Media Técnico-Profesional Comercial';
            if ($detalleest[0]['rbd'] == '1864') {//Cesa
                $nombredecreto = 'Nº 954 del año 2015';
                $nombreexento = 'Decreto Supremo Evaluación,Calificación Escolar Nº 67 de 2018';


            }

        }

        if ($niveleducacion == '463') {
            $nombreedu = 'Enseñanza Media Técnico-Profesional Adultos Comercial';

        }

        if ($niveleducacion == '510') {
            $nombreedu = 'Enseñanza Media Técnico-Profesional Industrial';
            if ($detalleest[0]['rbd'] == '1864') {//Cesa
                $nombredecreto = 'Nº 954 del año 2015';
                $nombreexento = 'Decreto Supremo Evaluación,Calificación Escolar Nº 67 de 2018';


            }

        }

        if ($niveleducacion == '563') {
            $nombreedu = 'Enseñanza Media Técnico-Profesional Adultos Industrial';

        }
        if ($niveleducacion == '610') {
            $nombreedu = 'Enseñanza Media Técnico-Profesional ';
            //General Velasquez
            if ($detalleest[0]['rbd'] == '1863') {
                $nombredecreto = 'Nº 954 del año 2015';
                $nombreexento = 'Decreto Exento Nº 83 de 2001.';
                if ($detalleest[0]['letra'] == 'A') {
                    $nombreedu = "Enseñanza Media Técnico-Profesional Atención de Párvulos";

                }
                if ($detalleest[0]['letra'] == 'B') {
                    $nombreedu = "Enseñanza Media Técnico-Profesional Servicio de Hotelería";

                }
                if ($detalleest[0]['letra'] == 'C') {
                    $nombreedu = "Enseñanza Media Técnico-Profesional Gastronomía Mención Cocina ";

                }

            }

            if ($detalleest[0]['rbd'] == '1864') {//Cesa
                $nombredecreto = 'Nº 954 del año 2015';
                $nombreexento = 'Decreto Supremo Evaluación,Calificación Escolar Nº 67 de 2018';


            }

        }

        if ($niveleducacion == '663') {
            $nombreedu = 'Enseñanza Media Técnico-Profesional Adultos';

        }


        if ($niveleducacion == 110 && $grado < 7) {
            $nombredecreto = 'Nº 2960 del año 2012';
            $nombreexento = 'Decreto Exento Nº 511 de 1997.';

            if ($detalleest[0]['rbd'] == '1864') {//Cesa
                $nombredecreto = 'Nº 954 del año 2015';
                $nombreexento = 'Decreto Supremo Evaluación,Calificación Escolar Nº 67 de 2018';


            }

            if ($detalleest[0]['rbd'] == '1874') {//Cesa
                $nombredecreto = 'Nº 1363 del año 2011 ';
                $nombreexento = 'Decreto Nº 67 de 2018';


            }

            if ($detalleest[0]['rbd'] == '1873') {//Horcon
                $nombreexento = 'Decreto Nº 67 de 2018';


            }

        }
        if ($niveleducacion == 110 && ($grado > 6 && $grado < 9)) {
            $nombredecreto = 'Nº 1363 del año 2011 ';
            $nombreexento = 'Decreto Exento Nº 511 de 1997.';

            if ($detalleest[0]['rbd'] == '1864') {//Cesa
                $nombredecreto = 'Nº 954 del año 2015';
                $nombreexento = 'Decreto Exento Nº 67 de 2018.';


            }

            if ($detalleest[0]['rbd'] == '1874') {//Cesa
                $nombredecreto = 'Nº 1363 del año 2011 ';
                $nombreexento = 'Decreto Nº 67 de 2018';


            }
            if ($detalleest[0]['rbd'] == '1873') {//Horcon
                $nombredecreto = 'Nº 1363 del año 2011 ';
                $nombreexento = 'Decreto Nº 67 de 2018';


            }

        }
        if ($niveleducacion == 310 && $grado > 0) {
            $nombredecreto = 'Nº 1358  del año 2011';
            $nombreexento = 'Decreto Exento Nº 112 de 1999.';

            if ($detalleest[0]['rbd'] == '1864') {//Cesa
                $nombredecreto = 'Nº 954 del año 2015';
                $nombreexento = 'Decreto Supremo Evaluación,Calificación Escolar Nº 67 de 2018.';


            }

        }

        if ($niveleducacion == '363') {
            $nombreedu = 'Enseñanza Media Adultos ';

            if ($detalleest[0]['rbd'] == '1864') {//Cesa
                $nombredecreto = 'Nº 954 del año 2015';
                $nombreexento = 'Decreto Exento Nº 2169 de 2007.';


            }

        }
        if ($niveleducacion == '165') {
            $nombreedu = 'Enseñanza Básica Adultos ';

            if ($detalleest[0]['rbd'] == '1864') {//Cesa
                $nombredecreto = 'Nº 954 del año 2015';
                $nombreexento = 'Decreto Exento Nº 2169 de 2007.';


            }

        }
        $taller = array();
        $combinada = array();
        for ($y = 0; $y < $largoalumnos; $y++) {
            $tablanotas = array();
            $tablanotas2 = array();
            $tablanotas2segundo = array();
            $alumnoactual = array();
            $verifica = array();
            $cuenta = 0;
            $promedio = 0;
            $cuenta1 = array();
            $cuentan = 0;
            $promedion = 0;
            $promediof = 0;
            $promediofn = 0;
            $promediofnsegundo = 0;
            $promediofntercero = 0;
            $cuenta2 = array();
            $promedioparcial = 0;
            $contadorparcial = 0;


            $idalumnoactual = $listadealumnos[$y]['idAlumnos'];


            if ($detalleest[0]['monitoreo'] == 1 && $detalleest[0]['idEstablecimiento'] == 7 && $idperiodo == 5) {//Greda 2020

                $tablanotas = $tabla->generasolonotasperiodo($idalumnoactual, 2, 1, $idperiodo, $idcursoactual);
                $tablanotas2 = $tabla->generasolonotasperiodo($idalumnoactual, 3, 0, $idperiodo, $idcursoactual);
                $tablanotas2segundo = $tabla->generasolonotasperiodo($idalumnoactual, 4, 0, $idperiodo, $idcursoactual);
                $tablanotas2tercero = $tabla->generasolonotasperiodo($idalumnoactual, 5, 0, $idperiodo, $idcursoactual);

                $verifica = $modeloalumnodetalle->get($listadealumnos[$y]['idAlumnosActual'], 10, $idperiodo);
                $observacion = $verifica[0]["observaciones"];
                $largotablanota2 = count($tablanotas2);
                $largotablaaux = count($tablanotas);
                $largotablanota2segundo = count($tablanotas2segundo);
                $largotablanota2tercero = count($tablanotas2tercero);


                $datostallersem = $modelasignatura->gettaller($idcursoactual, $idperiodo, array(1, 2), 1, array(3, 4, 5));
                $datostalleranual = $modelasignatura->gettalleranual($idcursoactual, $idperiodo, array(1), 1);
                $datostallersin = $modelasignatura->gettallersin($idcursoactual, $idperiodo);
                $listastalleres = array_merge($datostalleranual, $datostallersem);
                $listaasignaturanoinciden = array_merge($listastalleres, $datostallersin);

            } else {
                $tablanotas = $tabla->generasolonotas($idalumnoactual, $idcursoactual, $idperiodo);

                $tablanotas2 = $tabla->generasolonotasperiodo($idalumnoactual, 3, 0, $idperiodo, $idcursoactual);
                $tablanotas2segundo = $tabla->generasolonotasperiodo($idalumnoactual, 4, 0, $idperiodo, $idcursoactual);
                $tablanotas2tercero = $tabla->generasolonotasperiodo($idalumnoactual, 5, 0, $idperiodo, $idcursoactual);

                $verifica = $modeloalumnodetalle->get($listadealumnos[$y]['idAlumnosActual'], 10, $idperiodo);
                $observacion = $verifica[0]["observaciones"];
                $largotablanota2 = count($tablanotas2);
                $largotablaaux = count($tablanotas);
                $largotablanota2segundo = count($tablanotas2segundo);
                $largotablanota2tercero = count($tablanotas2tercero);


                $datostallersem = $modelasignatura->gettaller($idcursoactual, $idperiodo, array(1, 2), 1, array(3, 4, 5));
                $datostalleranual = $modelasignatura->gettalleranual($idcursoactual, $idperiodo, array(1), 1);
                $datostallersin = $modelasignatura->gettallersin($idcursoactual, $idperiodo);
                $listastalleres = array_merge($datostalleranual, $datostallersem);
                $listaasignaturanoinciden = array_merge($listastalleres, $datostallersin);
            }


            //Obtiene los Talleres que son Semestrales Tiempo=2.
            $datostalleres = $modelasignatura->gettaller($idcursoactual, $idperiodo, array(1, 2), 1, array(3, 4, 5));

            if (count($datostalleres) > 0) {
                for ($i = 0; $i < count($datostalleres); $i++) {
                    $detalletaller = $modelasignatura->gettallersegmento($datostalleres[$i]['idConfiguracionTaller'], array(3, 4, 5), $idalumnoactual);


                    if ($detalletaller) {

                        $listaasignaturanoinciden[] = $detalletaller[0];
                    }

                }


            }


            $largoasignaturanoincide = count($listaasignaturanoinciden);

            if ($largoasignaturanoincide != 0) {

                $taller[$y] .= "<tr><td colspan='3'><b>TALLERES Y ASIGNATURAS</b></td></tr>";
                for ($i = 0; $i < 1; $i++) {
                    $auxtexto = '';

                    //Configuracion de Taller
                    if ($listaasignaturanoinciden[$i]["tipoAjuste"] == 2) {

                        $promediotaller['idAsignatura'] = $detalletaller[0]['idAsignaturaDestino'];


                    } else {
                        $promediotaller['idAsignatura'] = $listaasignaturanoinciden[$i]["idAsignaturaTaller"];
                    }

                    $promedion = 0;
                    $cuentan = 0;
                    $promedionsegundo = 0;
                    $cuentansegundo = 0;
                    $promediontercero = 0;
                    $cuentantercero = 0;
                    $auxtexto .= "<tr><td class='celda'>" . $listaasignaturanoinciden[$i]["nombreAsignatura"] . "</td>";


                    //Primer Trimestre
                    if ($listaasignaturanoinciden[$i]["tiempoOpcion"] == 3) {
                        for ($j = 0; $j < $largotablanota2; $j++) {
                            if ($listaasignaturanoinciden[$i]["idAsignatura"] == $tablanotas2[$j]["idAsignatura"]) {
                                if ($tablanotas2[$j]['coef'] == 2) {
                                    if ($tablanotas2[$j]['nota'] != '0') {

                                        $promedion = $promedion + ($tablanotas2[$j]['nota'] + $tablanotas2[$j]['nota']);
                                        $cuentan = $cuentan + 2;

                                    }


                                } else {

                                    if ($tablanotas2[$j]['nota'] != '0') {
                                        $promedion = $promedion + $tablanotas2[$j]['nota'];
                                        $cuentan = $cuentan + 1;

                                    }


                                }

                            }

                        }
                    }


                    //Segundo Trimestre
                    if ($listaasignaturanoinciden[$i]["tiempoOpcion"] == 4) {
                        for ($j = 0; $j < $largotablanota2segundo; $j++) {
                            if ($listaasignaturanoinciden[$i]["idAsignatura"] == $tablanotas2segundo[$j]["idAsignatura"]) {
                                if ($tablanotas2segundo[$j]['coef'] == 2) {
                                    if ($tablanotas2segundo[$j]['nota'] != '0') {
                                        $promedionsegundo += ($tablanotas2segundo[$j]['nota'] + $tablanotas2segundo[$j]['nota']);
                                        $cuentansegundo += 2;

                                    }


                                } else {

                                    if ($tablanotas2segundo[$j]['nota'] != '0') {

                                        $promedionsegundo += $tablanotas2segundo[$j]['nota'];
                                        $cuentansegundo += 1;

                                    }


                                }

                            }

                        }
                    }

                    //Tercer Trimestre
                    if ($listaasignaturanoinciden[$i]["tiempoOpcion"] == 4) {
                        for ($j = 0; $j < $largotablanota2tercero; $j++) {
                            if ($listaasignaturanoinciden[$i]["idAsignatura"] == $tablanotas2tercero[$j]["idAsignatura"]) {
                                if ($tablanotas2tercero[$j]['coef'] == 2) {
                                    if ($tablanotas2tercero[$j]['nota'] != '0') {
                                        $promediontercero += ($tablanotas2tercero[$j]['nota'] + $tablanotas2tercero[$j]['nota']);
                                        $cuentantercero += 2;

                                    }


                                } else {

                                    if ($tablanotas2tercero[$j]['nota'] != '0') {

                                        $promediontercero += $tablanotas2tercero[$j]['nota'];
                                        $cuentantercero += 1;

                                    }


                                }

                            }

                        }
                    }


                    //sacamos el promedio de la asignatura


                    //Primer Trimestre
                    if ($promedion > 0 || $cuentan > 0) {


                        if ($detalleest[0]['aproxAsignatura'] == 1) {
                            $promediofn = round($promedion / $cuentan);
                            $promediotaller['nota'] = $promediofn;
                            $promediotaller['coef'] = 1;
                            $promediotaller['tiempo'] = 3;
                            $promediotaller['idAsignatura'] = $listaasignaturanoinciden[$i]["idAsignaturaTaller"];
                            $promediotaller['forma'] = $listaasignaturanoinciden[$i]["forma"];
                            $promediotaller['porcentaje'] = $listaasignaturanoinciden[$i]["porcentaje"];
                            $promediotaller['tipoAjuste'] = $listaasignaturanoinciden[$i]["tipoAjuste"];
                            $promediotaller['idConfiguracionTaller'] = $listaasignaturanoinciden[$i]["idConfiguracionTaller"];
                            $promediotaller['tipoAsignatura'] = $listaasignaturanoinciden[$i]["tipoAsignatura"];

                        } else {
                            $promediofn = intval($promedion / $cuentan);
                            $promediotaller['nota'] = $promediofn;
                            $promediotaller['coef'] = 1;
                            $promediotaller['tiempo'] = 3;
                            $promediotaller['forma'] = $listaasignaturanoinciden[$i]["forma"];
                            $promediotaller['porcentaje'] = $listaasignaturanoinciden[$i]["porcentaje"];
                            $promediotaller['tipoAjuste'] = $listaasignaturanoinciden[$i]["tipoAjuste"];
                            $promediotaller['idConfiguracionTaller'] = $listaasignaturanoinciden[$i]["idConfiguracionTaller"];
                            $promediotaller['tipoAsignatura'] = $listaasignaturanoinciden[$i]["tipoAsignatura"];

                        }
                        $auxtexto .= "<td class='prom'>" . $promediofn . "</td></tr>";
                        $taller[$y] .= $auxtexto;

                    } else {
                        $promediotaller['nota'] = 0;
                        $promediotaller['coef'] = 1;
                        $promediotaller['tiempo'] = 3;
                        $promediotaller['forma'] = $listaasignaturanoinciden[$i]["forma"];
                        $promediotaller['porcentaje'] = $listaasignaturanoinciden[$i]["porcentaje"];
                        $promediotaller['tipoAjuste'] = $listaasignaturanoinciden[$i]["tipoAjuste"];
                        $promediotaller['idConfiguracionTaller'] = $listaasignaturanoinciden[$i]["idConfiguracionTaller"];
                        $promediotaller['idAsignatura'] = $listaasignaturanoinciden[$i]["idAsignaturaTaller"];
                        $promediotaller['tipoAsignatura'] = $listaasignaturanoinciden[$i]["tipoAsignatura"];

                    }

                    //Segundo Trimestre

                    if ($promedionsegundo > 0 || $cuentansegundo > 0) {

                        if ($detalleest[0]['aproxAsignatura'] == 1) {
                            $promediofns = round($promedionsegundo / $cuentansegundo);
                            $promediotallers['nota'] = $promediofns;
                            $promediotallers['coef'] = 1;
                            $promediotallers['tiempo'] = 4;
                            $promediotallers['idAsignatura'] = $listaasignaturanoinciden[$i]["idAsignaturaTaller"];
                            $promediotallers['forma'] = $listaasignaturanoinciden[$i]["forma"];
                            $promediotallers['porcentaje'] = $listaasignaturanoinciden[$i]["porcentaje"];

                        } else {
                            $promediofns = intval($promedionsegundo / $cuentansegundo);
                            $promediotallers['nota'] = $promediofns;
                            $promediotallers['coef'] = 1;
                            $promediotallers['tiempo'] = 4;
                            $promediotallers['idAsignatura'] = $listaasignaturanoinciden[$i]["idAsignaturaTaller"];
                            $promediotallers['forma'] = $listaasignaturanoinciden[$i]["forma"];
                            $promediotallers['porcentaje'] = $listaasignaturanoinciden[$i]["porcentaje"];

                        }
                        $promediocortado = str_split($promediofns);
                        $taller[$y] .= "<td>" . $promediocortado[0] . ',' . $promediocortado[1] . "</td>";


                    } else {
                        $promediotallers['nota'] = 0;
                        $promediotallers['coef'] = 1;
                        $promediotallers['tiempo'] = 4;
                        $promediotallers['idAsignatura'] = $listaasignaturanoinciden[$i]["idAsignaturaTaller"];
                        $promediotallers['forma'] = $listaasignaturanoinciden[$i]["forma"];
                        $promediotallers['porcentaje'] = $listaasignaturanoinciden[$i]["porcentaje"];
                        $taller[$y] .= "<td class='prom'>-</td>";
                        $promediofns = 0;
                    }

                    //Tercer Trimestre

                    if ($promediontercero > 0 || $cuentantercero > 0) {

                        if ($detalleest[0]['aproxAsignatura'] == 1) {
                            $promediofnt = round($promediontercero / $cuentantercero);
                            $promediotallert['nota'] = $promediofnt;
                            $promediotallert['coef'] = 1;
                            $promediotallert['tiempo'] = 5;
                            $promediotallert['idAsignatura'] = $listaasignaturanoinciden[$i]["idAsignaturaTaller"];
                            $promediotallert['forma'] = $listaasignaturanoinciden[$i]["forma"];
                            $promediotallert['porcentaje'] = $listaasignaturanoinciden[$i]["porcentaje"];

                        } else {
                            $promediofnt = intval($promediontercero / $cuentantercero);
                            $promediotallert['nota'] = $promediofnt;
                            $promediotallert['coef'] = 1;
                            $promediotallert['tiempo'] = 5;
                            $promediotallert['idAsignatura'] = $listaasignaturanoinciden[$i]["idAsignaturaTaller"];
                            $promediotallert['forma'] = $listaasignaturanoinciden[$i]["forma"];
                            $promediotallert['porcentaje'] = $listaasignaturanoinciden[$i]["porcentaje"];

                        }
                        $promediocortado = str_split($promediofnt);
                        $taller[$y] .= "<td>" . $promediocortado[0] . ',' . $promediocortado[1] . "</td>";


                    } else {
                        $promediotallert['nota'] = 0;
                        $promediotallert['coef'] = 1;
                        $promediotallert['tiempo'] = 5;
                        $promediotallert['idAsignatura'] = $listaasignaturanoinciden[$i]["idAsignaturaTaller"];
                        $promediotallert['forma'] = $listaasignaturanoinciden[$i]["forma"];
                        $promediotallert['porcentaje'] = $listaasignaturanoinciden[$i]["porcentaje"];
                        $taller[$y] .= "<td class='prom'>-</td>";
                        $promediofnt = 0;
                    }


                    //Promedio Final Taller

                    $promedio_aux_taller = array($promediotaller, $promediotallers, $promediotallert);
                    $resultado_auxiliar_taller = array_values(array_diff($promedio_aux_taller, array('0')));

                    if (!empty($resultado_auxiliar_taller)) {


                        if ($detalleest[0]['aproxAnual'] == 1) {

                            $promediofnfinal = round((array_sum($resultado_auxiliar_taller)) / count($resultado_auxiliar_taller));

                        } else {
                            $promediofnfinal = intval((array_sum($resultado_auxiliar_taller)) / count($resultado_auxiliar_taller));

                        }
                    } else {
                        $promediofnfinal = 0;
                    }

                    if ($promediofnfinal != 0) {
                        $promediocortado = str_split($promediofnfinal);
                        $taller[$y] .= "<td>" . $promediocortado[0] . ',' . $promediocortado[1] . "</td>";
                    } else {
                        $taller[$y] .= "<td>-</td>";
                    }

                    $taller[$y] .= "</tr>";

                    //Cechekeamos a que tipo pertenece la asignatura de destino del taller
                    if (!empty($listaasignaturanoinciden[$i]["idAsignaturaTaller"])) {
                        $datosdestino = $modelasignatura->getdestino($listaasignaturanoinciden[$i]["idAsignaturaTaller"]);

                        if ($datosdestino[0]['tipoAsignatura'] == 4) {

                            $tablanotas2[] = $promediotaller;
                            $tablanotas2segundo[] = $promediotallers;
                            $tablanotas2tercero[] = $promediotallert;
                        } else {

                            $tablanotas[] = $promediotaller;
                            $tablanotas[] = $promediotallers;
                            $tablanotas[] = $promediotallert;
                        }
                    }
                }

            }

            //Notas de Asignaturas que pertenecen a una combinada

            if ($largocombinada != 0) {
                $largotablanota2 = count($tablanotas2);
                $largotablanota2segundo = count($tablanotas2segundo);
                $largotablanota2tercero = count($tablanotas2tercero);


                for ($i = 0; $i < $largocombinada; $i++) {

                    $setasignatura = unserialize($datosasignaturascombinada[$i]['asignaturas']);

                    for ($k = 0; $k < count($setasignatura); $k++) {
                        $cuentan = 0;
                        $promedion = 0;
                        $cuentansegundo = 0;
                        $promedionsegundo = 0;
                        $cuentantercero = 0;
                        $promediontercero = 0;
                        $notatallercom = 0;
                        $porcentajetallercom = 0;
                        $notatallercomsegundo = 0;
                        $porcentajetallercomsegundo = 0;
                        $notatallercomtercero = 0;
                        $porcentajetallercomtercero = 0;
                        $cuenta2 = array();
                        $datocombinada = $modelasignatura->getnombre($setasignatura[$k]);


                        $combinada[$y] .= "<tr><td class='celda'>" . $datocombinada[0]["nombreAsignatura"] . "</td>";

                        //Primer Trimestre
                        for ($j = 0; $j < $largotablanota2; $j++) {
                            if ($datocombinada[0]["idAsignatura"] == $tablanotas2[$j]["idAsignatura"]) {


                                if ($tablanotas2[$j]['coef'] == 2) {
                                    if ($tablanotas2[$j]['nota'] != '0') {
                                        $promedion = $promedion + ($tablanotas2[$j]['nota'] + $tablanotas2[$j]['nota']);
                                        $cuentan = $cuentan + 2;


                                    }

                                } else {


                                    if ($tablanotas2[$j]['nota'] != '0') {


                                        if (empty($tablanotas2[$j]['forma'])) {
                                            $promedion += $tablanotas2[$j]['nota'];
                                            $cuentan += 1;

                                        } else {

                                            if ($tablanotas2[$j]['forma'] == 1) {
                                                $promedion += $tablanotas2[$j]['nota'];
                                                $cuentan += 1;
                                            }
                                            if ($tablanotas2[$j]['forma'] == 2) {
                                                $porcentajetallercom = $tablanotas2[$j]['porcentaje'];
                                                $notatallercom = $tablanotas2[$j]['nota'];
                                            }
                                        }


                                    } else {
                                        if (empty($tablanotas2[$j]['forma'])) {

                                        } else {
                                            if ($tablanotas2[$j]['forma'] == 2) {
                                                $porcentajetallercom = $tablanotas2[$j]['porcentaje'];
                                                $notatallercom = 0;
                                            }


                                        }
                                    }


                                }

                            }

                        }


                        //Segundo Trimestre
                        for ($j = 0; $j < $largotablanota2segundo; $j++) {
                            if ($datocombinada[0]["idAsignatura"] == $tablanotas2segundo[$j]["idAsignatura"]) {
                                if ($tablanotas2segundo[$j]['coef'] == 2) {
                                    if ($tablanotas2segundo[$j]['nota'] != '0') {
                                        $promedionsegundo += ($tablanotas2segundo[$j]['nota'] + $tablanotas2segundo[$j]['nota']);
                                        $cuentansegundo += 2;

                                    }


                                } else {


                                    if ($tablanotas2segundo[$j]['nota'] != '0') {

                                        if (empty($tablanotas2segundo[$j]['forma'])) {
                                            $promedionsegundo += $tablanotas2segundo[$j]['nota'];
                                            $cuentansegundo += 1;
                                        } else {

                                            if ($tablanotas2segundo[$j]['forma'] == 1) {
                                                $promedionsegundo += $tablanotas2segundo[$j]['nota'];
                                                $cuentansegundo += 1;
                                            }
                                            if ($tablanotas2segundo[$j]['forma'] == 2) {
                                                $porcentajetallercomsegundo = $tablanotas2segundo[$j]['porcentaje'];
                                                $notatallercomsegundo = $tablanotas2segundo[$j]['nota'];
                                            }
                                        }


                                    } else {
                                        if (empty($tablanotas2segundo[$j]['forma'])) {

                                        } else {
                                            if ($tablanotas2segundo[$j]['forma'] == 2) {
                                                $porcentajetallercomsegundo = $tablanotas2segundo[$j]['porcentaje'];
                                                $notatallercomsegundo = 0;
                                            }


                                        }
                                    }


                                }

                            }

                        }

                        //Tercer Trimestre
                        for ($j = 0; $j < $largotablanota2tercero; $j++) {
                            if ($datocombinada[0]["idAsignatura"] == $tablanotas2tercero[$j]["idAsignatura"]) {
                                if ($tablanotas2tercero[$j]['coef'] == 2) {
                                    if ($tablanotas2tercero[$j]['nota'] != '0') {
                                        $promediontercero += ($tablanotas2tercero[$j]['nota'] + $tablanotas2tercero[$j]['nota']);
                                        $cuentantercero += 2;

                                    }


                                } else {


                                    if ($tablanotas2tercero[$j]['nota'] != '0') {

                                        if (empty($tablanotas2tercero[$j]['forma'])) {
                                            $promediontercero += $tablanotas2tercero[$j]['nota'];
                                            $cuentantercero += 1;
                                        } else {

                                            if ($tablanotas2tercero[$j]['forma'] == 1) {
                                                $promediontercero += $tablanotas2tercero[$j]['nota'];
                                                $cuentantercero += 1;
                                            }
                                            if ($tablanotas2tercero[$j]['forma'] == 2) {
                                                $porcentajetallercomtercero = $tablanotas2tercero[$j]['porcentaje'];
                                                $notatallercomtercero = $tablanotas2tercero[$j]['nota'];
                                            }
                                        }


                                    } else {
                                        if (empty($tablanotas2tercero[$j]['forma'])) {

                                        } else {
                                            if ($tablanotas2tercero[$j]['forma'] == 2) {
                                                $porcentajetallercomtercero = $tablanotas2tercero[$j]['porcentaje'];
                                                $notatallercomtercero = 0;
                                            }


                                        }
                                    }


                                }

                            }

                        }


                        //sacamos el promedio de la asignatura Primer Trimestre


                        if ($promedion > 0 || $cuentan > 0) {

                            if ($detalleest[0]['aproxAsignatura'] == 1) {

                                //nuevo Promedio con taller
                                if (empty($notatallercom)) {
                                    $promediofn = round($promedion / $cuentan);


                                } else {
                                    $porcentajecom = 100 - $porcentajetallercom;
                                    $promediofn = (round($promedion / $cuentan)) * ($porcentajecom / 100) + ($notatallercom * ($porcentajetallercom / 100));
                                    $promediofn = round($promediofn);

                                }


                                //Fin Taller
                                $promediocombinada['nota'] = $promediofn;
                                $promediocombinada['coef'] = 1;
                                $promediocombinada['tiempo'] = 3;
                                $datoasignatura = $modelasignatura->getnombre($datosasignaturascombinada[$i]["idAsignaturaCurso"]);
                                $promediocombinada['idAsignatura'] = $datoasignatura[0]["idAsignatura"];


                            } else {

                                //Nuevo Promedio con Taller
                                if (empty($notatallercom)) {
                                    $promediofn = intval($promedion / $cuentan);
                                } else {
                                    $porcentajecom = 100 - $porcentajetallercom;
                                    $promediofn = (round($promedion / $cuentan)) * ($porcentajecom / 100) + ($notatallercom * ($porcentajetallercom / 100));
                                    $promediofn = intval($promediofn);
                                }
                                //Fin Taller
                                $promediocombinada['nota'] = $promediofn;
                                $promediocombinada['coef'] = 1;
                                $promediocombinada['tiempo'] = 3;
                                $datoasignatura = $modelasignatura->getnombre($datosasignaturascombinada[$i]["idAsignaturaCurso"]);
                                $promediocombinada['idAsignatura'] = $datoasignatura[0]["idAsignatura"];


                            }
                            $combinada[$y] .= "<td class='prom'>" . $promediofn . "</td></tr>";


                        } else {
                            $promediocombinada['nota'] = 0;
                            $promediocombinada['coef'] = 1;
                            $promediocombinada['tiempo'] = 3;
                            $datoasignatura = $modelasignatura->getnombre($datosasignaturascombinada[$i]["idAsignaturaCurso"]);
                            $promediocombinada['idAsignatura'] = $datoasignatura[0]["idAsignatura"];

                        }

                        //sacamos el promedio de la asignatura Segundo Trimestre


                        if ($promedionsegundo > 0 || $cuentansegundo > 0) {


                            if ($detalleest[0]['aproxAsignatura'] == 1) {
                                //nuevo Promedio con taller
                                if (empty($notatallercomsegundo)) {
                                    $promediofnsegundo = round($promedionsegundo / $cuentansegundo);

                                } else {
                                    $porcentajecomsegundo = 100 - $porcentajetallercomsegundo;
                                    $promediofnsegundo = (round($promedionsegundo / $cuentansegundo)) * ($porcentajecomsegundo / 100) + ($notatallercomsegundo * ($porcentajetallercomsegundo / 100));
                                    $promediofnsegundo = round($promediofnsegundo);

                                }


                                //Fin Taller
                                $promediocombinadasegundo['nota'] = $promediofnsegundo;
                                $promediocombinadasegundo['coef'] = 1;
                                $promediocombinadasegundo['tiempo'] = 4;
                                $datoasignatura = $modelasignatura->getnombre($datosasignaturascombinada[$i]["idAsignaturaCurso"]);
                                $promediocombinadasegundo['idAsignatura'] = $datoasignatura[0]["idAsignatura"];


                            } else {

                                //Nuevo Promedio con Taller
                                if (empty($notatallercomsegundo)) {
                                    $promediofnsegundo = intval($promedionsegundo / $cuentansegundo);
                                } else {
                                    $porcentajecomsegundo = 100 - $porcentajetallercomsegundo;
                                    $promediofnsegundo = (round($promedionsegundo / $cuentansegundo)) * ($porcentajecomsegundo / 100) + ($notatallercomsegundo * ($porcentajetallercomsegundo / 100));
                                    $promediofnsegundo = intval($promediofnsegundo);
                                }
                                //Fin Taller
                                $promediocombinadasegundo['nota'] = $promediofnsegundo;
                                $promediocombinadasegundo['coef'] = 1;
                                $promediocombinadasegundo['tiempo'] = 4;
                                $datoasignatura = $modelasignatura->getnombre($datosasignaturascombinada[$i]["idAsignaturaCurso"]);
                                $promediocombinadasegundo['idAsignatura'] = $datoasignatura[0]["idAsignatura"];


                            }
                            $combinada[$y] .= "<td class='prom'>" . $promediofn . "</td></tr>";


                        } else {
                            $promediocombinadasegundo['nota'] = 0;
                            $promediocombinadasegundo['coef'] = 1;
                            $promediocombinadasegundo['tiempo'] = 4;
                            $datoasignatura = $modelasignatura->getnombre($datosasignaturascombinada[$i]["idAsignaturaCurso"]);
                            $promediocombinadasegundo['idAsignatura'] = $datoasignatura[0]["idAsignatura"];

                        }

                        //sacamos el promedio de la asignatura Tercer Trimestre


                        if ($promediontercero > 0 || $cuentantercero > 0) {


                            if ($detalleest[0]['aproxAsignatura'] == 1) {
                                //nuevo Promedio con taller
                                if (empty($notatallercomtercero)) {
                                    $promediofntercero = round($promediontercero / $cuentantercero);

                                } else {
                                    $porcentajecomtercero = 100 - $porcentajetallercomtercero;
                                    $promediofntercero = (round($promediontercero / $cuentantercero)) * ($porcentajecomtercero / 100) + ($notatallercomtercero * ($porcentajetallercomtercero / 100));
                                    $promediofntercero = round($promediofntercero);

                                }


                                //Fin Taller
                                $promediocombinadatercero['nota'] = $promediofntercero;
                                $promediocombinadatercero['coef'] = 1;
                                $promediocombinadatercero['tiempo'] = 5;
                                $datoasignatura = $modelasignatura->getnombre($datosasignaturascombinada[$i]["idAsignaturaCurso"]);
                                $promediocombinadatercero['idAsignatura'] = $datoasignatura[0]["idAsignatura"];


                            } else {

                                //Nuevo Promedio con Taller
                                if (empty($notatallercomtercero)) {
                                    $promediofntercero = intval($promediontercero / $cuentantercero);
                                } else {
                                    $porcentajecomtercero = 100 - $porcentajetallercomtercero;
                                    $promediofntercero = (round($promediontercero / $cuentantercero)) * ($porcentajecomtercero / 100) + ($notatallercomtercero * ($porcentajetallercomtercero / 100));
                                    $promediofntercero = intval($promediofntercero);
                                }
                                //Fin Taller
                                $promediocombinadatercero['nota'] = $promediofntercero;
                                $promediocombinadatercero['coef'] = 1;
                                $promediocombinadatercero['tiempo'] = 5;
                                $datoasignatura = $modelasignatura->getnombre($datosasignaturascombinada[$i]["idAsignaturaCurso"]);
                                $promediocombinadatercero['idAsignatura'] = $datoasignatura[0]["idAsignatura"];


                            }
                            $combinada[$y] .= "<td class='prom'>" . $promediofn . "</td></tr>";


                        } else {
                            $promediocombinadatercero['nota'] = 0;
                            $promediocombinadatercero['coef'] = 1;
                            $promediocombinadatercero['tiempo'] = 5;
                            $datoasignatura = $modelasignatura->getnombre($datosasignaturascombinada[$i]["idAsignaturaCurso"]);
                            $promediocombinadatercero['idAsignatura'] = $datoasignatura[0]["idAsignatura"];

                        }
                        //Promedio Final Asignatura Combinada

                        $promedio_aux_combinada = array($promediofn, $promediofnsegundo, $promediofntercero);
                        $resultado_aux_combinada = array_values(array_diff($promedio_aux_combinada, array('0')));

                        if (!empty($resultado_aux_combinada)) {
                            if ($datoscurso[0]['aproxAnual'] == 1) {
                                $promediofnfinal = round((array_sum($resultado_aux_combinada)) / count($resultado_aux_combinada));

                            } else {
                                $promediofnfinal = intval((array_sum($resultado_aux_combinada)) / count($resultado_aux_combinada));

                            }
                        } else {
                            $promediofnfinal = 0;
                        }

                        if ($promediofnfinal != 0) {
                            $promediocortado = str_split($promediofnfinal);
                            $combinada[$y] .= "<td>" . $promediocortado[0] . ',' . $promediocortado[1] . "</td>";
                        } else {

                            $combinada[$y] .= "<td>-</td>";
                        }

                        $combinada[$y] .= "</tr>";

                        $tablanotas[] = $promediocombinada;
                        $tablanotas[] = $promediocombinadasegundo;
                        $tablanotas[] = $promediocombinadatercero;

                    }
                }


            }


            $largotablanota = count($tablanotas);

            //Asignaturas Conceptos


            if ($largoconcepto != 0) {
                for ($i = 0; $i < $largoconcepto; $i++) {
                    $resultado[$i] = $modelasignatura->getasignaturaconcepto($listaasignaturaconcepto[$i]["idAsignatura"], $idcursoactual, $idperiodo);

                    $cuentan = 0;
                    $promedion = 0;
                    $promediof = 0;
                    $cuenta2 = array();
                    $concepto[$y] .= "<tr><td class='celda'>" . $listaasignaturaconcepto[$i]["nombreAsignatura"] . "</td>";
                    $cuenta2[$i] = 0;
                    for ($l = 0; $l < count($resultado[$i]); $l++) {
                        $listaconceptos[$i][$resultado[$i][$l]['notaconcepto']] = $resultado[$i][$l]['concepto'];
                        $listaconceptospromedio[$i][$l] = array($resultado[$i][$l]['desde'], $resultado[$i][$l]['hasta'], $resultado[$i][$l]['concepto']);

                    }


                    for ($j = 0; $j < $largotablanota2segundo; $j++) {
                        if ($listaasignaturaconcepto[$i]["idAsignatura"] == $tablanotas2segundo[$j]["idAsignatura"]) {


                            if ($tablanotas2segundo[$j]['coef'] == 2) {
                                if ($tablanotas2segundo[$j]['nota'] != '0') {

                                    for ($l = 0; $l < count($listaconceptospromedio[$i]); $l++) {
                                        if ($tablanotas2segundo[$j]['nota'] >= $listaconceptospromedio[$i][$l][0] && $tablanotas2segundo[$j]['nota'] <= $listaconceptospromedio[$i][$l][1]) {
                                            $promediofnconcepto = $listaconceptospromedio[$i][$l][2];


                                        }

                                    }


                                    $promedion = $promedion + ($tablanotas2segundo[$j]['nota'] + $tablanotas2segundo[$j]['nota']);
                                    $cuentan = $cuentan + 2;

                                } else {

                                }

                            } else {

                                if ($tablanotas2segundo[$j]['nota'] != '0') {
                                    for ($l = 0; $l < count($listaconceptospromedio[$i]); $l++) {
                                        if ($tablanotas2segundo[$j]['nota'] >= $listaconceptospromedio[$i][$l][0] && $tablanotas2segundo[$j]['nota'] <= $listaconceptospromedio[$i][$l][1]) {
                                            $promediofnconcepto = $listaconceptospromedio[$i][$l][2];

                                        }

                                    }


                                    $promedion = $promedion + $tablanotas2segundo[$j]['nota'];
                                    $cuentan = $cuentan + 1;

                                } else {
                                    //$concepto[$y] .= "<td>-</td>";

                                }


                            }

                        }

                    }


                    //sacamos el promedio de la asignatura


                    if ($promedion > 0 || $cuentan > 0) {

                        if ($detalleest[0]['aproxAsignatura'] == 1) {
                            $promediofn = round($promedion / $cuentan);


                        } else {
                            $promediofn = intval($promedion / $cuentan);


                        }
                        for ($l = 0; $l < count($listaconceptospromedio[$i]); $l++) {
                            if ($promediofn >= $listaconceptospromedio[$i][$l][0] && $promediofn <= $listaconceptospromedio[$i][$l][1]) {
                                $promediofnconcepto = $listaconceptospromedio[$i][$l][2];

                            }

                        }
                        $concepto[$y] .= "<td class='prom'>-</td>";
                        $concepto[$y] .= "<td class='prom'>" . $promediofnconcepto . "</td>";
                        $concepto[$y] .= "<td class='prom'>" . $promediofnconcepto . "</td>";

                        $concepto[$y] .= "</tr>";

                    } else {
                        $concepto[$y] .= "<td class='prom'>-</td>";
                        $concepto[$y] .= "<td class='prom'>-</td>";
                        $concepto[$y] .= "<td class='prom'>-</td>";

                        $concepto[$y] .= "</tr>";
                    }


                }

            }


            //Formato del rut

            $rutset = $listadealumnos[$y]['rutAlumno'];
            if (!empty($rutset)) {

                $rest = substr($rutset, 0, -1);
                $ultimo = substr($rutset, -1);
                $formatomiles = number_format($rest, 0, "", ".");
                $formatofinal = $formatomiles . '-' . $ultimo;

            }


            $nombrecompleto = $listadealumnos[$y]['nombres'] . ' ' . $listadealumnos[$y]['apaterno'] . ' ' . $listadealumnos[$y]['amaterno'];
            $nombrecompleto = strtoupper($nombrecompleto);

            $recuperando2 = new Zend_Session_Namespace('nombreperiodo');

            // variables para encabezado
            $titulo = "CERTIFICADO ANUAL DE ESTUDIOS " . $recuperando2->nombreperiodo;
            $tituloest = "<b>" . $detalleest[0]['nombreEstablecimiento'] . "</b>";
            $descripcion = "Reconocido Oficialmente por el Ministerio de Educación de la República de Chile, según Resolución Exenta de Educación Nº " . $detalleest[0]['numeroDecreto'] . " del año " . $detalleest[0]['yeardecreto'] . ". Rol Base de Datos Nº " . $detalleest[0]['rbd'] . ", otorga el presente Informe Educacional a:";
            $alumno = 'Don(a): <span style=" text-decoration: underline;">' . $nombrecompleto . '</span> RUN: <span style=" text-decoration: underline;">' . $formatofinal . '</span> Alumno(a) de <b>' . $detalleest[0]['nombreGrado'] . ' ' . $detalleest[0]['letra'] . ' de ' . $nombreedu . '</b>, de Acuerdo a Decreto Plan de Estudio ' . $nombredecreto . ' y del Reglamento de Evaluación y Promoción Escolar ' . $nombreexento . '';
            $logo = getcwd();
            $logo .= "/application/documentos/logos/" . $detalleest[0]['extension'];
            if (file_exists($logo)) {
                $encabezado = '<p style="position:absolute;top:3px;text-align:center"><img  src="' . $logo . '" /></p><h5 style="position:absolute;top:110px;text-align:center">' . $titulo . '</h5><h4 style="position:absolute;top:130px;text-align:center">' . $tituloest . '</h4>'
                    . '<p style="margin-top:20px; text-align:left;">' . $descripcion . '</p>'

                    . '<p style="margin-top:1px; text-align:left;">' . $alumno . '</p>';
            } else {
                $encabezado = '<p style="position:absolute;top:3px;text-align:center"></p><h5 style="position:absolute;top:110px;text-align:center">' . $titulo . '</h5><h4 style="position:absolute;top:130px;text-align:center">' . $tituloest . '</h4>'
                    . '<p style="margin-top:20px; text-align:left;">' . $descripcion . '</p>'

                    . '<p style="margin-top:1px; text-align:left;">' . $alumno . '</p>';
            }

            $html[$y] = '';
            $html[$y] .= $encabezado;


            if ($largotablaaux < 1) {
                $html[$y] .= "<table  align='center' border='1'><tr><th style='width:25%'>Asignaturas</th><th style='width:65%'>" . $nombresegmento . "</th><th style='width:10%'>Promedio</th></tr>";
                $html[$y] .= "<tr><td colspan='3'>Sin Notas en éste periodo</td></tr>";
            } else {


                if ($detalleest[0]['monitoreo'] == 1) {

                    if ($detalleest[0]['idEstablecimiento'] == 12) {
                        $html[$y] .= "<table align='center' border='1'><tr><th style='width:59%' rowspan='2'>Asignaturas</th><th style='width:6%'>TRIM</th><th style='width:6%'>TRIM</th><th style='width:6%'>TRIM</th><th style='width:6%'>PROM</th><th style='width:6%'>%</th><th style='width:6%'>NIVEL</th></tr><tr><th>I</th><th>II</th><th>III</th><th>ANUAL</th><th>LOGRO</th><th>LOGRO</th></tr>";;

                    } elseif ($detalleest[0]['idEstablecimiento'] == 8) {
                        $html[$y] .= "<table align='center' border='1'><tr><th style='width:57%' rowspan='2'>Asignaturas</th><th style='width:6%' colspan='2'>TRIM I</th><th style='width:6%' colspan='2'>TRIM II</th><th style='width:6%' colspan='2'>TRIM III</th><th style='width:6%'>PROM</th><th style='width:6%'>%</th><th style='width:6%'>NIVEL</th></tr><tr><th>PROM</th><th>%</th><th>PROM</th><th>%</th><th>PROM</th><th>%</th><th>ANUAL</th><th>LOGRO</th><th>APREN</th></tr>";;

                    } else {
                        $html[$y] .= "<table align='center' border='1'><tr><th style='width:60%' rowspan='2'>Asignaturas</th><th style='width:10%'>TRIM</th><th style='width:10%'>TRIM</th><th style='width:10%'>TRIM</th><th style='width:10%'>PROM</th></tr><tr><th>I</th><th>II</th><th>III</th><th>ANUAL</th></tr>";;

                    }


                } else {

                    $html[$y] .= "<table align='center' border='1'><tr><th style='width:60%' rowspan='2'>Asignaturas</th><th style='width:10%'>TRIM</th><th style='width:10%'>TRIM</th><th style='width:10%'>TRIM</th><th style='width:10%'>PROM</th></tr><tr><th>I</th><th>II</th><th>III</th><th>ANUAL</th></tr>";;


                }

                $contadorparcial = 0;
                for ($i = 0; $i < $largoasignatura; $i++) {


                    $cuenta1[$i] = 0;
                    $promedio = 0;
                    $cuenta = 0;
                    $promedios = 0;
                    $cuentas = 0;
                    $promediot = 0;
                    $cuentat = 0;
                    $auxtexto = "<tr><td class='celda'>" . $listaasignatura[$i]["nombreAsignatura"] . "</td>";

                    //Primer Trimestre
                    for ($j = 0; $j < $largotablanota; $j++) {
                        if ($listaasignatura[$i]["idAsignatura"] == $tablanotas[$j]["idAsignatura"]) {


                            if ($tablanotas[$j]['coef'] == 2 && $tablanotas[$j]['tiempo'] == 3) {
                                if ($tablanotas[$j]['nota'] != '0') {
                                    $promedio += ($tablanotas[$j]['nota'] + $tablanotas[$j]['nota']);
                                    $cuenta += 2;

                                }
                                $cuenta1[$i] += 2;

                            }
                            if ($tablanotas[$j]['coef'] < 2 && $tablanotas[$j]['tiempo'] == 3) {

                                if ($tablanotas[$j]['nota'] != '0') {

                                    if (empty($tablanotas[$j]['forma']) && $tablanotas[$j]['tiempo'] == 3) {
                                        $promedio += $tablanotas[$j]['nota'];
                                        $cuenta += 1;
                                        $porcentajetaller = array();
                                        $notataller = array();
                                    } else {

                                        if ($tablanotas[$j]['forma'] == 1 && $tablanotas[$j]['tiempo'] == 3) {
                                            $promedio += $tablanotas[$j]['nota'];
                                            $cuenta += 1;
                                            $porcentajetaller = array();
                                            $notataller = array();
                                        }
                                        if ($tablanotas[$j]['forma'] == 2 && $tablanotas[$j]['tiempo'] == 3) {
                                            $porcentajetaller[] = $tablanotas[$j]['porcentaje'];
                                            $notataller[] = $tablanotas[$j]['nota'];
                                        }
                                    }


                                }

                                $cuenta1[$i] += 1;

                            }

                            //Segundo Trimestre
                            if ($tablanotas[$j]['coef'] == 2 && $tablanotas[$j]['tiempo'] == 4) {

                                if ($tablanotas[$j]['nota'] != '0') {
                                    $promedios += ($tablanotas[$j]['nota'] + $tablanotas[$j]['nota']);
                                    $cuentas += 2;

                                }
                                $cuenta1[$i] += 2;

                            }
                            if ($tablanotas[$j]['coef'] < 2 && $tablanotas[$j]['tiempo'] == 4) {

                                if ($tablanotas[$j]['nota'] != '0') {

                                    if (empty($tablanotas[$j]['forma']) && $tablanotas[$j]['tiempo'] == 4) {
                                        $promedios += $tablanotas[$j]['nota'];
                                        $cuentas += 1;
                                        $porcentajetallers = array();
                                        $notatallers = array();
                                    } else {

                                        if ($tablanotas[$j]['forma'] == 1 && $tablanotas[$j]['tiempo'] == 4) {
                                            $promedios += $tablanotas[$j]['nota'];
                                            $cuentas += 1;
                                            $porcentajetallers = array();
                                            $notatallers = array();
                                        }
                                        if ($tablanotas[$j]['forma'] == 2 && $tablanotas[$j]['tiempo'] == 4) {
                                            $porcentajetallers[] = $tablanotas[$j]['porcentaje'];
                                            $notatallers[] = $tablanotas[$j]['nota'];
                                        }
                                    }


                                }

                                $cuenta1[$i] += 1;

                            }

                            //Tercer Trimestre
                            if ($tablanotas[$j]['coef'] == 2 && $tablanotas[$j]['tiempo'] == 5) {

                                if ($tablanotas[$j]['nota'] != '0') {
                                    $promediot += ($tablanotas[$j]['nota'] + $tablanotas[$j]['nota']);
                                    $cuentat += 2;

                                }
                                $cuenta1[$i] += 2;

                            }
                            if ($tablanotas[$j]['coef'] < 2 && $tablanotas[$j]['tiempo'] == 5) {

                                if ($tablanotas[$j]['nota'] != '0') {

                                    if (empty($tablanotas[$j]['forma']) && $tablanotas[$j]['tiempo'] == 5) {
                                        $promediot += $tablanotas[$j]['nota'];
                                        $cuentat += 1;
                                        $porcentajetallert = array();
                                        $notatallert = array();
                                    } else {

                                        if ($tablanotas[$j]['forma'] == 1 && $tablanotas[$j]['tiempo'] == 5) {
                                            $promediot += $tablanotas[$j]['nota'];
                                            $cuentat += 1;
                                            $porcentajetallert = array();
                                            $notatallert = array();
                                        }
                                        if ($tablanotas[$j]['forma'] == 2 && $tablanotas[$j]['tiempo'] == 5) {
                                            $porcentajetallert[] = $tablanotas[$j]['porcentaje'];
                                            $notatallert[] = $tablanotas[$j]['nota'];
                                        }
                                    }


                                }

                                $cuenta1[$i] += 1;

                            }


                        }

                    }


                    //Primer Trimestre
                    //sacamos el promedio de la asignatura

                    if ($promedio > 0 || $cuenta > 0) {


                        // si es 1 Aproxima, si es 2 no Aproxima
                        if ($detalleest[0]['aproxAsignatura'] == 1) {
                            if (empty($notataller)) {
                                $promediof = round($promedio / $cuenta);
                            } else {
                                $porcentaje = 100;
                                $resultadoauxtaller = 0;
                                if (count($notataller) > 1) {
                                    for ($t = 0; $t < count($notataller); $t++) {
                                        $porcentaje = $porcentaje - $porcentajetaller[$t];
                                        $resultadoauxtaller += ($notataller[$t] * ($porcentajetaller[$t] / 100));

                                    }
                                    $promediof = (round($promedio / $cuenta)) * ($porcentaje / 100) + $resultadoauxtaller;

                                } else {
                                    $porcentaje = $porcentaje - $porcentajetaller[0];
                                    $promediof = (round($promedio / $cuenta)) * ($porcentaje / 100) + ($notataller[0] * ($porcentajetaller[0] / 100));
                                    $promediof = round($promediof);
                                }


                            }

                        } else {
                            if (empty($notataller)) {
                                $promediof = intval($promedio / $cuenta);
                            } else {
                                $porcentaje = 100;
                                $resultadoauxtaller = 0;
                                if (count($notataller) > 1) {
                                    for ($t = 0; $t < count($notataller); $t++) {
                                        $porcentaje = $porcentaje - $porcentajetaller[$t];
                                        $resultadoauxtaller += ($notataller[$t] * ($porcentajetaller[$t] / 100));

                                    }
                                    $promediof = (round($promedio / $cuenta)) * ($porcentaje / 100) + $resultadoauxtaller;
                                    $promediof = intval($promediof);
                                } else {
                                    $porcentaje = $porcentaje - $porcentajetaller[0];
                                    $promediof = (round($promedio / $cuenta)) * ($porcentaje / 100) + ($notataller[0] * ($porcentajetaller[0] / 100));
                                    $promediof = intval($promediof);
                                }
                            }


                        }

                        if ($promediof == 0) {
                            $auxtexto .= "<td>-</td>";
                            if ($detalleest[0]['idEstablecimiento'] == 8) {

                                $auxtexto .= "<td>0%</td>";

                            }
                        } else {
                            $promediocortado = str_split($promediof);
                            $auxtexto .= "<td>" . $promediocortado[0] . ',' . $promediocortado[1] . "</td>";
                            if ($detalleest[0]['idEstablecimiento'] == 8) {

                                $devuelve = $this->equivalencias($lista_equivalencia, $promediof);
                                $auxtexto .= "<td>" . $devuelve[0] . "%</td>";

                            }
                        }


                    } else {

                        $promediof = 0;
                        if ($detalleest[0]['idEstablecimiento'] == 8) {
                            $auxtexto .= "<td>-</td>";

                        }
                        $auxtexto .= "<td>-</td>";
                    }

                    //Segundo Trimestre

                    if ($promedios > 0 || $cuentas > 0) {


                        // si es 1 Aproxima, si es 2 no Aproxima
                        if ($detalleest[0]['aproxAsignatura'] == 1) {
                            if (empty($notatallers)) {
                                $promediofs = round($promedios / $cuentas);
                            } else {
                                $porcentajes = 100;
                                $resultadoauxtallers = 0;
                                if (count($notatallers) > 1) {
                                    for ($t = 0; $t < count($notatallers); $t++) {
                                        $porcentajes = $porcentajes - $porcentajetallers[$t];
                                        $resultadoauxtallers += ($notatallers[$t] * ($porcentajetallers[$t] / 100));

                                    }
                                    $promediofs = (round($promedios / $cuentas)) * ($porcentajes / 100) + $resultadoauxtallers;

                                } else {
                                    $porcentajes = $porcentajes - $porcentajetallers[0];
                                    $promediofs = (round($promedios / $cuentas)) * ($porcentajes / 100) + ($notatallers[0] * ($porcentajetallers[0] / 100));
                                    $promediofs = round($promediofs);
                                }


                            }

                        } else {
                            if (empty($notatallers)) {
                                $promediofs = intval($promedios / $cuentas);
                            } else {
                                $porcentajes = 100;
                                $resultadoauxtallers = 0;
                                if (count($notatallers) > 1) {
                                    for ($t = 0; $t < count($notatallers); $t++) {
                                        $porcentajes = $porcentajes - $porcentajetallers[$t];
                                        $resultadoauxtallers += ($notatallers[$t] * ($porcentajetallers[$t] / 100));

                                    }
                                    $promediofs = (round($promedios / $cuentas)) * ($porcentajes / 100) + $resultadoauxtallers;
                                    $promediofs = intval($promediofs);
                                } else {
                                    $porcentajes = $porcentajes - $porcentajetallers[0];
                                    $promediofs = (round($promedios / $cuentas)) * ($porcentajes / 100) + ($notatallers[0] * ($porcentajetallers[0] / 100));
                                    $promediofs = intval($promediofs);
                                }
                            }


                        }

                        $promediocortados = str_split($promediofs);

                        $auxtexto .= "<td>" . $promediocortados[0] . ',' . $promediocortados[1] . "</td>";
                        if ($detalleest[0]['idEstablecimiento'] == 8) {

                            $devuelve = $this->equivalencias($lista_equivalencia, $promediofs);
                            $auxtexto .= "<td>" . $devuelve[0] . "%</td>";

                        }

                    } else {
                        $promediofs = 0;
                        if ($detalleest[0]['idEstablecimiento'] == 8) {
                            $auxtexto .= "<td>-</td>";

                        }
                        $auxtexto .= "<td>-</td>";
                    }

                    //Tercer Trimestre

                    if ($promediot > 0 || $cuentat > 0) {

                        // si es 1 Aproxima, si es 2 no Aproxima
                        if ($detalleest[0]['aproxAsignatura'] == 1) {
                            if (empty($notatallert)) {
                                $promedioft = round($promediot / $cuentat);
                            } else {
                                $porcentajet = 100;
                                $resultadoauxtallert = 0;
                                if (count($notatallert) > 1) {
                                    for ($t = 0; $t < count($notatallert); $t++) {
                                        $porcentajet = $porcentajet - $porcentajetallert[$t];
                                        $resultadoauxtallert += ($notatallert[$t] * ($porcentajetallert[$t] / 100));

                                    }
                                    $promedioft = (round($promediot / $cuentat)) * ($porcentajet / 100) + $resultadoauxtallert;

                                } else {
                                    $porcentajet = $porcentajet - $porcentajetallert[0];
                                    $promedioft = (round($promediot / $cuentat)) * ($porcentajet / 100) + ($notatallert[0] * ($porcentajetallert[0] / 100));
                                    $promedioft = round($promedioft);
                                }


                            }

                        } else {
                            if (empty($notatallert)) {
                                $promedioft = intval($promediot / $cuentat);
                            } else {
                                $porcentajet = 100;
                                $resultadoauxtallert = 0;
                                if (count($notatallert) > 1) {
                                    for ($t = 0; $t < count($notatallert); $t++) {
                                        $porcentajet = $porcentajet - $porcentajetallert[$t];
                                        $resultadoauxtallert += ($notatallert[$t] * ($porcentajetallert[$t] / 100));

                                    }
                                    $promedioft = (round($promediot / $cuentat)) * ($porcentajet / 100) + $resultadoauxtallert;
                                    $promedioft = intval($promedioft);
                                } else {
                                    $porcentajet = $porcentajet - $porcentajetallert[0];
                                    $promedioft = (round($promediot / $cuentat)) * ($porcentajet / 100) + ($notatallert[0] * ($porcentajetallert[0] / 100));
                                    $promedioft = intval($promedioft);
                                }
                            }


                        }

                        $promediocortados = str_split($promedioft);

                        $auxtexto .= "<td>" . $promediocortados[0] . ',' . $promediocortados[1] . "</td>";
                        if ($detalleest[0]['idEstablecimiento'] == 8) {

                            $devuelve = $this->equivalencias($lista_equivalencia, $promedioft);
                            $auxtexto .= "<td>" . $devuelve[0] . "%</td>";

                        }

                    } else {
                        $promedioft = 0;
                        if ($detalleest[0]['idEstablecimiento'] == 8) {
                            $auxtexto .= "<td>-</td>";

                        }
                        $auxtexto .= "<td>-</td>";
                    }


                    //Promedio Final

                    $promedio_aux_final = array($promediof, $promediofs, $promedioft);
                    $resultado_aux_final = array_values(array_diff($promedio_aux_final, array('0')));


                    if (!empty($resultado_aux_final)) {


                        if ($datoscurso[0]['aproxAnual'] == 1) {
                            $promedioffinal = round((array_sum($resultado_aux_final)) / count($resultado_aux_final));

                        } else {
                            $promedioffinal = intval((array_sum($resultado_aux_final)) / count($resultado_aux_final));
                        }

                        $contadorparcial += 1;
                        if ($promedioffinal == 39 && $detalleest[0]['rbd'] == '1864') {
                            $promedioffinal = 40;
                        }

                    } else {
                        $promedioffinal = 0;
                    }

                    if ($promedioffinal != 0) {
                        //$html[$y] .= "<td class='prom'>-</td>";

                        if ($agregadecimas) {
                            if ($promedioffinal >= 60) {
                                $promedioffinal += 2;
                                if ($promedioffinal > 70) {
                                    $promedioffinal = 70;

                                }

                            }
                        }

                        $promediocortadosf = str_split($promedioffinal);

                        $auxtexto .= "<td>" . $promediocortadosf[0] . ',' . $promediocortadosf[1] . "</td>";
                        if ($detalleest[0]['monitoreo'] == 1) {

                            if ($detalleest[0]['idEstablecimiento'] == 12 || $detalleest[0]['idEstablecimiento'] == 8) {

                                $devuelve = $this->equivalencias($lista_equivalencia, $promedioffinal);
                                $auxtexto .= "<td>" . $devuelve[0] . "%</td>";
                                $auxtexto .= "<td>" . $devuelve[1] . "</td>";
                            }


                        }
                        $html[$y] .= $auxtexto;
                        $html[$y] .= "</tr>";
                    }


                    $promedioparcial += $promedioffinal;


                }//Fin asignaturas

                $promedioparcialfinal = 0;

                if ($promedioparcial > 0 && $contadorparcial > 0) {

                    // si es 1 Aproxima,si es 2 no Aproxima
                    if ($detalleest[0]['aproxFinal'] == 1) {
                        $promedioparcialfinal = round($promedioparcial / $contadorparcial);
                    } else {
                        $promedioparcialfinal = intval($promedioparcial / $contadorparcial);
                    }


                    $promediocortadoparcial = str_split($promedioparcialfinal);


                    if ($detalleest[0]['monitoreo'] == 1) {

                        if ($detalleest[0]['idEstablecimiento'] == 12) {

                            $devuelvef = $this->equivalencias($lista_equivalencia, $promedioparcialfinal);

                            $html[$y] .= "<tr><td style='text-align:left' colspan='4'><b>PROMEDIO GENERAL</b></td><td>" . $promediocortadoparcial[0] . ',' . $promediocortadoparcial[1] . "</td><td>" . $devuelvef[0] . "%</td><td>" . $devuelvef[1] . "</td></tr>";
                        } elseif ($detalleest[0]['idEstablecimiento'] == 8) {

                            $devuelvef = $this->equivalencias($lista_equivalencia, $promedioparcialfinal);

                            $html[$y] .= "<tr><td style='text-align:left' colspan='6'><b>PROMEDIO GENERAL</b></td><td>" . $promediocortadoparcial[0] . ',' . $promediocortadoparcial[1] . "</td><td>" . $devuelvef[0] . "%</td><td>" . $devuelvef[1] . "</td></tr>";

                        } elseif ($detalleest[0]['idEstablecimiento'] == 7) {//GREDA
                            $html[$y] .= "<tr><td style='text-align:left' colspan='4'><b>PROMEDIO GENERAL</b></td><td>" . $promediocortadoparcial[0] . ',' . $promediocortadoparcial[1] . "</td></tr>";

                            $html[$y] .= $concepto[$y];

                        } else {
                            $html[$y] .= "<tr><td style='text-align:left' colspan='4'><b>PROMEDIO GENERAL</b></td><td>" . $promediocortadoparcial[0] . ',' . $promediocortadoparcial[1] . "</td></tr>";


                        }


                    } else {
                        $html[$y] .= "<tr><td style='text-align:left' colspan='4'><b>PROMEDIO GENERAL</b></td><td>" . $promediocortadoparcial[0] . ',' . $promediocortadoparcial[1] . "</td></tr>";
                    }
                } else {
                    //$html[$y] .= "<tr><td style='text-align:left' colspan='3'>PROMEDIO GENERAL</td><td>-</td></tr>";
                }

                if ($detalleest[0]['idCodigo'] == 110 && ($detalleest[0]['idGrado'] >= 1 && $detalleest[0]['idGrado'] < 5)) {
                    // $html[$y] .= $taller[$y];
                }

            }


            $detallealumno = $modeloalumnodetalle->listardetalleperiodo($listadealumnos[$y]['idAlumnosActual'], 3, $idperiodo);
            $detallealumnos = $modeloalumnodetalle->listardetalleperiodo($listadealumnos[$y]['idAlumnosActual'], 4, $idperiodo);
            $detallealumnot = $modeloalumnodetalle->listardetalleperiodo($listadealumnos[$y]['idAlumnosActual'], 5, $idperiodo);
            $diasin = $detallealumno[0]['diasInasistencia'] + $detallealumnos[0]['diasInasistencia'];
            $diastrabajados = $detallealumno[0]['diasTrabajado'] + $detallealumnos[0]['diasTrabajado'];
            $atraso = $detallealumno[0]['numeroatrasos'] + $detallealumnos[0]['numeroatrasos'];
            $apoderadoprimer = $detallealumno[0]['nombreApoderado'];
            $apoderadosegundo = $detallealumnos[0]['nombreApoderado'];
            $apoderado = '';
            if (empty($apoderadoprimer) && !empty($apoderadosegundo)) {
                $apoderado = $apoderadosegundo;
            } else {
                $apoderado = $apoderadoprimer;
            }


            if ($diasin != 0 && $diastrabajados > 0) {
                $valor = $diasin / $diastrabajados;
                $aux = 1 - $valor;
                $total = $aux * 100;
            } elseif (($diasin == 0 || $diasin == '') && $diastrabajados > 0) {
                $valor = $diasin / $diastrabajados;
                $aux = 1 - $valor;
                $total = $aux * 100;
            } else {
                $total = 0;
            }

            $periodo = new Zend_Session_Namespace('nombreperiodo');
            $nombreperiodo = $periodo->nombreperiodo;


            $html[$y] .= "</table>


 <table align='center' style='margin-top:10px;'>
            <tr>
            <td style='width: 20%; text-align: center;'>Periodo/Asistencia</td>
            <td style='width: 20%; text-align: right;'>Nº de Días Trabajados</td>
            <td style='width: 20%; text-align: center;'>Nº Días de Inasistencia</td>
            <td style='width: 20%; text-align: center;'> % de Asistencia</td>
            <td style='width: 20%; text-align: center;'>Nº de Atrasos</td>
            </tr>

            <tr>
            <td style='width: 20%; height:2%; text-align: center;'>" . $nombreperiodo . "</td>
            <td style='width: 20%; text-align: center;'>" . $diastrabajados . "</td>
            <td style='width: 20%; text-align: center;'>" . $diasin . "</td>
            <td style='width: 20%; text-align: center;'>" . intval($total) . "&#37;</td>
            <td style='width: 20%; text-align: center;'>" . $atraso . "</td>
            </tr>



            </table>

            <table>
            <tr>
            <td style='width:100%;text-align: left;'>Observaciones:</td>
            </tr>
            <tr>
            <td style='width:100%;height:7%;text-align:left;'>" . $observacion . "</td>
            </tr>
            </table>";

            if ($monitoreo == 1 && $detalleest[0]['idEstablecimiento'] == 8) {

                //Simbologia
                $html[$y] .= "<table><tr><td style='width:30%;text-align: center;'>Nivel de Aprendizaje</td><td style='width:70%;text-align: center;'>Descripción</td></tr>";

                for ($n = 0; $n < count($lista_niveles); $n++) {
                    $html[$y] .= "<tr><td style='width:30%;text-align:left;'><b>" . $lista_niveles[$n]['nivelLogro'] . "</b></td><td style='width:70%;text-align:left;'>" . $lista_niveles[$n]['descripcionLogro'] . "</td></tr>";
                }
                $html[$y] .= "</table>";

            }

            $cadenaobservacion = trim($observacion);

//            if (!empty($observacion) && strlen($cadenaobservacion) > 0) {
//                $html[$y] .= "<table><tr><td style='width:100%;text-align: left;'>Observaciones:</td></tr><tr><td style='width:100%;height:4%;text-align:left;'>" . $observacion . "</td></tr></table>";
//            }

            $valoresprofesor = unserialize($detalleest[0]['profesor']);
            if ($valoresprofesor[2] == 1) {
                $tdnombreprofesor = "<p style='text-decoration:underline;margin-left:30px;'>" . $Profesorjefe['nombrescuenta'] . " " . $Profesorjefe['paternocuenta'] . " " . $Profesorjefe['maternocuenta'] . "</p>";
                $tdprofesor = "Profesor(a) Jefe.";
            } else {
                $tdnombreprofesor = "";
                $tdprofesor = "";
            }

            $valoresdirector = unserialize($detalleest[0]['director']);
            if ($valoresdirector[2] == 1) {
                $tdnombredirector = "<p style='text-decoration:underline;'>" . $director['nombrescuenta'] . " " . $director['paternocuenta'] . " " . $director['maternocuenta'] . "</p>";
                $tddirector = "Director(a).";
            } else {
                $tdnombredirector = "";
                $tddirector = "";
            }


            $valoresapoderado = unserialize($detalleest[0]['apoderado']);
            if ($valoresapoderado[2] == 1) {
                $tdnombreapoderado = "<p style='text-decoration:underline;'> " . $apoderado . "</p>";
                $tdapoderado = "Nombre y Firma de Apoderado.";
            } else {
                $tdnombreapoderado = "";
                $tdapoderado = "";
            }


            $html[$y] .= "<table align='center' style='margin-top:25px;' class='page_firmas'>
            <tr>
                <td style='width: 33%; text-align: center;border:none;'>" . $tdnombreprofesor . "</td>
                <td style='width: 33%; text-align: center;border:none;'>" . $tdnombreapoderado . "</td>
                <td style='width: 33%; text-align: center;border:none;'>" . $tdnombredirector . "</td>
            </tr>
            <tr>
                <td style='width: 33%; text-align:center;border:none;padding-top:35px'>" . $tdprofesor . "</td>
                <td style='width: 33%; text-align: center;border:none;padding-top:35px'>" . $tdapoderado . "</td>
                <td style='width: 33%; text-align:center;border:none;padding-top:35px'>" . $tddirector . "</td>
            </tr>
            <tr>
                <td colspan='3' style='text-align:center;border:none;padding-top:15px'>" . $fecha_final . ".</td>
            </tr>
            </table>";

        } //fin largo alumnos


        if ($html != '') {

            require('fpdf/html2pdf.class.php');
            try {
                //Orientación / formato del pdf y el idioma.
                $pdf = new HTML2PDF('P', 'LETTER', 'es', array(10, 10, 10, 10) /*márgenes*/); //los márgenes también pueden definirse en <page> ver documentación
                for ($j = 0; $j < count($html); $j++) {
                    $pdf->WriteHTML('<page><html>
        <head>
            <style>' . $style . '</style>
        </head>
        <body> <page_footer>
        <table class="page_footer">
            <tr>
            <td style="width: 40%; text-align: left;border:none;"></td>
                <td style="width: 60%; text-align: right;border:none;font-size:8px">

                </td>
            </tr>
        </table>
    </page_footer>' . $html[$j] . '</body></html></page>');
                }

                if (preg_match("/MSIE/i", $_SERVER["HTTP_USER_AGENT"])) {
                    header("Content-type: application/PDF");
                } else {
                    header("Content-type: application/PDF");
                    header("Content-Type: application/pdf");
                }

                $pdf->Output('Planificacion.pdf', I);
            } catch (HTML2PDF_exception $e) {
                //echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, intente nuevamente\");</script>";
                //echo "<script>parent.$.fancybox.close();</script>";
                echo $e;
            }
        }


    }

    public function informenotascursotAction()
    {
        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();


        $cargo = new Zend_Session_Namespace('cargo');
        $rol = $cargo->cargo;

        $agregadecimas = false;

        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $modelcurso = new Application_Model_DbTable_Cursos();
        $modelnotas = new Application_Model_DbTable_Notas();
        $modelasignatura = new Application_Model_DbTable_Asignaturascursos();
        $modeldetalle = new Application_Model_DbTable_AlumnosDetalle();


        //fecha actual

        $date = new DateTime;
        $fechain = $date->format('Y-m-d');
        $cortado = explode("-", $fechain);
        $dias = array("Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado");
        $meses = array("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre");

        $fecha_final = $dias[date('w', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]))] . " " . $cortado[2] . " de " . $meses[date('n', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0])) - 1] . " del " . date('Y', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]));
        // se ingresan por asigntaura
        $usuario = new Zend_Session_Namespace('id');
        $user = $usuario->id;
        $idcursoaux = $this->_getParam('id', 0);

        //Validamos si el curso pertece a la jefatura del usuario
        $auxiliar = $modelcurso->listarcursoiddocenteactuals($user, $idperiodo, 1, $idcursoaux);

        if ($auxiliar && ($auxiliar[0]['idCursos'] == $idcursoaux) || $rol != 2) {
            //Asignaturas que pertencen a un curso de jefatura del usuario
            $id = $this->_getParam('id', 0);
            $listaalumnos = $modelnotas->listaralumnoscurso($id, $idperiodo);
            $listanotas = $modelnotas->listarnotascursoperiodo($id, $idperiodo, array('3', '4', '5'));
            $datosasignaturas = $modelasignatura->listarporcurso($id, 1, array('1', '3'), $idperiodo);

            //Datos Asignatura Combinadas
            $datosasignaturascombinada = $modelasignatura->getcombinada($id, $idperiodo);
            $largoalumnos = count($listaalumnos);
            $largocombinada = count($datosasignaturascombinada);
            $m = 0;


            //Talleres para Alumnos Separados Primer Semestre
            $datostallersem = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(1));
            $datostallersemseg = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(2));
            $datostalleranual = $modelasignatura->gettalleranual($id, $idperiodo, array(1), 1);
            $datostaller = array_merge($datostallersem, $datostallersemseg, $datostalleranual);
            $largotaller = count($datostaller);

            $modelotallerdetalle = new Application_Model_DbTable_Asignaturascursos();
            //Obtiene los Talleres que son Semestrales Tiempo=2.
            $datostalleres = $modelasignatura->gettaller($id, $idperiodo, array(2), 2, array(1, 2));

            $datoscurso = $modelcurso->listarcursoid($id, $idperiodo);
            //Configuracion de agregar 2 decimas a curso desde 5 a 4to medio cuando el promedio final de asignatura es mayor o igual a 6
            if (($datoscurso[0]['rbd'] == 1863) && (($datoscurso[0]['idCodigo'] == 110 && $datoscurso[0]['idGrado'] > 4) || $datoscurso[0]['idCodigo'] == 310 || $datoscurso[0]['idCodigo'] == 363 || $datoscurso[0]['idCodigo'] == 410 || $datoscurso[0]['idCodigo'] == 510 || $datoscurso[0]['idCodigo'] == 610 || $datoscurso[0]['idCodigo'] == 165)) {
                $agregadecimas = true;
            }
        } else {
            //Asignaturas que pertencen a un curso que no es jefatura
            $cursomodel = new Application_Model_DbTable_Detallecursocuenta();
            $id = $this->_getParam('ids', 0);
            $ids = $this->_getParam('id', 0);

            $datosasignaturas = $modelcurso->getasignaturashorario($id, $idperiodo, $user);

            $listaalumnos = $modelnotas->listaralumnoscurso($id, $idperiodo);
            $listanotas = $modelnotas->listarnotascursoperiodo($id, $idperiodo, array('3', '4', '5'));

            //Datos Asignatura Combinadas
            $datosasignaturascombinada = $modelasignatura->getcombinada($id, $idperiodo);
            $largoalumnos = count($listaalumnos);
            $largocombinada = count($datosasignaturascombinada);
            $m = 0;


            //Talleres para Alumnos Separados Primer Segundo y Tercer Trimestre
            $datostallersem = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(3));
            $datostallersemseg = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(4));
            $datostallersemter = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(5));
            $datostalleranual = $modelasignatura->gettalleranual($id, $idperiodo, array(1), 1);
            $datostaller = array_merge($datostallersem, $datostallersemseg, $datostallersemter, $datostalleranual);
            $largotaller = count($datostaller);

            $modelotallerdetalle = new Application_Model_DbTable_Asignaturascursos();
            //Obtiene los Talleres que son Trimestrales Tiempo=2.
            $datostalleres = $modelasignatura->gettaller($id, $idperiodo, array(2), 2, array(3, 4, 5));

            $datoscurso = $modelcurso->listarcursoid($id, $idperiodo);
            //Configuracion de agregar 2 decimas a curso desde 5 a 4to medio cuando el promedio final de asignatura es mayor o igual a 6
            if (($datoscurso[0]['rbd'] == 1863) && (($datoscurso[0]['idCodigo'] == 110 && $datoscurso[0]['idGrado'] > 4) || $datoscurso[0]['idCodigo'] == 310 || $datoscurso[0]['idCodigo'] == 363 || $datoscurso[0]['idCodigo'] == 410 || $datoscurso[0]['idCodigo'] == 510 || $datoscurso[0]['idCodigo'] == 610 || $datoscurso[0]['idCodigo'] == 165)) {
                $agregadecimas = true;
            }
        }


        ///Fin Definir ingreso de notas


        $promediotalleralumnos = array();
        $promediotalleralumnoss = array();
        $promediotalleralumnost = array();
        if ($datostalleres) {
            for ($j = 0; $j < $largoalumnos; $j++) {
                for ($i = 0; $i < count($datostalleres); $i++) {
                    $detalletaller = $modelotallerdetalle->gettallersegmento($datostalleres[$i]['idConfiguracionTaller'], 3, $listaalumnos[$j]['idAlumnos']);
                    $detalletallers = $modelotallerdetalle->gettallersegmento($datostalleres[$i]['idConfiguracionTaller'], 4, $listaalumnos[$j]['idAlumnos']);
                    $detalletallert = $modelotallerdetalle->gettallersegmento($datostalleres[$i]['idConfiguracionTaller'], 5, $listaalumnos[$j]['idAlumnos']);


                    //Primer Semestre
                    if ($datostalleres[$i]['tiempoOpcion'] == 3) {
                        if ($detalletaller) {
                            $datosalumnostaller = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 3, $id, $detalletaller[0]['idAsignatura']);

                            if ($datosalumnostaller) {
                                for ($k = 0; $k < count($datosalumnostaller); $k++) {

                                    if ($datostalleres[$i]['idAsignatura'] == $datosalumnostaller[$k]['idAsignatura']) {
                                        if ($datosalumnostaller[$k]['coef'] == 2) {
                                            if ($datosalumnostaller[$k]['nota'] > 0) {
                                                $promediotalleralumnos[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                                $promediotalleralumnos[$j][$i][] = $datosalumnostaller[$k]['nota'];

                                            } else {
                                                $promediotalleralumnos[$j][$i][] = 0;
                                                $promediotalleralumnos[$j][$i][] = 0;
                                            }

                                        } else {
                                            if ($datosalumnostaller[$k]['nota'] > 0) {
                                                $promediotalleralumnos[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                            } else {
                                                $promediotalleralumnos[$j][$i][] = 0;
                                            }

                                        }


                                    }


                                }
                            }
                            if (!empty($promediotalleralumnos[$j][$i])) {
                                $promsetalumnos = array_diff($promediotalleralumnos[$j][$i], array('0'));
                            } else {
                                $promsetalumnos = 0;
                            }

                            if (is_array($promsetalumnos)) {
                                if (count($promsetalumnos) > 0) {

                                    if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                        $promtalleralumnos[$j][$i]['nota'] = round(array_sum($promsetalumnos) / count($promsetalumnos));

                                    } else {
                                        $promtalleralumnos[$j][$i]['nota'] = intval(array_sum($promsetalumnos) / count($promsetalumnos));
                                    }
                                } else {
                                    $promtalleralumnos[$j][$i]['nota'] = 0;
                                }
                            } else {
                                $promtalleralumnos[$j][$i]['nota'] = 0;
                            }


                            $promtalleralumnos[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                            $promtalleralumnos[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                            $promtalleralumnos[$j][$i]['coef'] = 1;
                            $promtalleralumnos[$j][$i]['tiempo'] = 3;
                            $promtalleralumnos[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                            $promtalleralumnos[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];

                        } else {
                            $promtalleralumnoss[$j][$i]['nota'] = 0;
                            $promtalleralumnos[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                            $promtalleralumnos[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                            $promtalleralumnos[$j][$i]['coef'] = 1;
                            $promtalleralumnos[$j][$i]['tiempo'] = 3;
                            $promtalleralumnos[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                            $promtalleralumnos[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];
                        }
                    } else {
                        $promtalleralumnos[$j][$i] = array();
                    }

                    //Segundo Trimestre
                    if ($datostalleres[$i]['tiempoOpcion'] == 4) {
                        if ($detalletallers) {
                            $datosalumnostallers = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 4, $id, $detalletallers[0]['idAsignatura']);

                            if ($datosalumnostallers) {
                                for ($k = 0; $k < count($datosalumnostallers); $k++) {

                                    if ($datostalleres[$i]['idAsignatura'] == $datosalumnostallers[$k]['idAsignatura']) {

                                        if ($datosalumnostallers[$k]['coef'] == 2) {
                                            if ($datosalumnostallers[$k]['nota'] > 0) {
                                                $promediotalleralumnoss[$j][$i][] = $datosalumnostallers[$k]['nota'];
                                                $promediotalleralumnoss[$j][$i][] = $datosalumnostallers[$k]['nota'];

                                            } else {
                                                $promediotalleralumnoss[$j][$i][] = 0;
                                                $promediotalleralumnoss[$j][$i][] = 0;
                                            }

                                        } else {
                                            if ($datosalumnostallers[$k]['nota'] > 0) {
                                                $promediotalleralumnoss[$j][$i][] = $datosalumnostallers[$k]['nota'];
                                            } else {
                                                $promediotalleralumnoss[$j][$i][] = 0;
                                            }

                                        }


                                    }


                                }
                            }
                            if (!empty($promediotalleralumnoss[$j][$i])) {
                                $promsetalumnoss = array_diff($promediotalleralumnoss[$j][$i], array('0'));
                            } else {
                                $promsetalumnoss = 0;
                            }

                            if (is_array($promsetalumnoss)) {
                                if (count($promsetalumnoss) > 0) {

                                    if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                        $promtalleralumnoss[$j][$i]['nota'] = round(array_sum($promsetalumnoss) / count($promsetalumnoss));
                                        $promtalleralumnoss[$j][$i]['nota'] = intval($promtalleralumnoss[$j][$i]['nota']);

                                    } else {
                                        $promtalleralumnoss[$j][$i]['nota'] = intval(array_sum($promsetalumnoss) / count($promsetalumnoss));
                                    }
                                } else {
                                    $promtalleralumnoss[$j][$i]['nota'] = 0;
                                }
                            } else {
                                $promtalleralumnoss[$j][$i]['nota'] = 0;
                            }


                            $promtalleralumnoss[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                            $promtalleralumnoss[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                            $promtalleralumnoss[$j][$i]['coef'] = 1;
                            $promtalleralumnoss[$j][$i]['tiempo'] = 4;
                            $promtalleralumnoss[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                            $promtalleralumnoss[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];

                        } else {
                            $promtalleralumnoss[$j][$i]['nota'] = 0;
                            $promtalleralumnoss[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                            $promtalleralumnoss[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                            $promtalleralumnoss[$j][$i]['coef'] = 1;
                            $promtalleralumnoss[$j][$i]['tiempo'] = 4;
                            $promtalleralumnoss[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                            $promtalleralumnoss[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];
                        }
                    } else {
                        $promtalleralumnoss[$j][$i] = array();
                    }

                    //Tercer Trimestre
                    if ($datostalleres[$i]['tiempoOpcion'] == 5) {
                        if ($detalletallert) {
                            $datosalumnostallert = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 5, $id, $detalletallers[0]['idAsignatura']);

                            if ($datosalumnostallert) {
                                for ($k = 0; $k < count($datosalumnostallert); $k++) {

                                    if ($datostalleres[$i]['idAsignatura'] == $datosalumnostallert[$k]['idAsignatura']) {

                                        if ($datosalumnostallert[$k]['coef'] == 2) {
                                            if ($datosalumnostallert[$k]['nota'] > 0) {
                                                $promediotalleralumnost[$j][$i][] = $datosalumnostallert[$k]['nota'];
                                                $promediotalleralumnost[$j][$i][] = $datosalumnostallert[$k]['nota'];

                                            } else {
                                                $promediotalleralumnost[$j][$i][] = 0;
                                                $promediotalleralumnost[$j][$i][] = 0;
                                            }

                                        } else {
                                            if ($datosalumnostallert[$k]['nota'] > 0) {
                                                $promediotalleralumnost[$j][$i][] = $datosalumnostallert[$k]['nota'];
                                            } else {
                                                $promediotalleralumnost[$j][$i][] = 0;
                                            }

                                        }


                                    }


                                }
                            }
                            if (!empty($promediotalleralumnost[$j][$i])) {
                                $promsetalumnost = array_diff($promediotalleralumnost[$j][$i], array('0'));
                            } else {
                                $promsetalumnost = 0;
                            }

                            if (is_array($promsetalumnost)) {
                                if (count($promsetalumnost) > 0) {

                                    if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                        $promtalleralumnost[$j][$i]['nota'] = round(array_sum($promsetalumnost) / count($promsetalumnost));
                                        $promtalleralumnost[$j][$i]['nota'] = intval($promtalleralumnost[$j][$i]['nota']);

                                    } else {
                                        $promtalleralumnost[$j][$i]['nota'] = intval(array_sum($promsetalumnost) / count($promsetalumnost));
                                    }
                                } else {
                                    $promtalleralumnost[$j][$i]['nota'] = 0;
                                }
                            } else {
                                $promtalleralumnost[$j][$i]['nota'] = 0;
                            }


                            $promtalleralumnost[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                            $promtalleralumnost[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                            $promtalleralumnost[$j][$i]['coef'] = 1;
                            $promtalleralumnost[$j][$i]['tiempo'] = 4;
                            $promtalleralumnost[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                            $promtalleralumnost[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];

                        } else {
                            $promtalleralumnost[$j][$i]['nota'] = 0;
                            $promtalleralumnost[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                            $promtalleralumnost[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                            $promtalleralumnost[$j][$i]['coef'] = 1;
                            $promtalleralumnost[$j][$i]['tiempo'] = 4;
                            $promtalleralumnost[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                            $promtalleralumnost[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];
                        }
                    } else {
                        $promtalleralumnost[$j][$i] = array();
                    }


                }//Fin if talleres


                for ($l = 0; $l < count($promtalleralumnos[$j]); $l++) {
                    if (!empty($promtalleralumnos[$j][$l]["idAsignatura"])) {
                        $datosdestino = $modelotallerdetalle->getdestino($promtalleralumnos[$j][$l]["idAsignatura"]);
                        if ($datosdestino[0]['tipoAsignatura'] != 4) {
                            $listapromediostaller[$j][] = $promtalleralumnos[$j][$l];
                        } else {
                            $listapromediostallercom[$j][$promtalleralumnos[$j][$l]['idAsignatura']] = $promtalleralumnos[$j][$l];

                        }
                    }

                }


                for ($l = 0; $l < count($promtalleralumnoss[$j]); $l++) {
                    if (!empty($promtalleralumnoss[$j][$l]["idAsignatura"])) {
                        $datosdestino = $modelotallerdetalle->getdestino($promtalleralumnoss[$j][$l]["idAsignatura"]);
                        if ($datosdestino[0]['tipoAsignatura'] != 4) {
                            $listapromediostallers[$j][] = $promtalleralumnoss[$j][$l];
                        } else {
                            $listapromediostallercoms[$j][$promtalleralumnoss[$j][$l]['idAsignatura']] = $promtalleralumnoss[$j][$l];

                        }
                    }

                }

                for ($l = 0; $l < count($promtalleralumnost[$j]); $l++) {
                    if (!empty($promtalleralumnost[$j][$l]["idAsignatura"])) {
                        $datosdestino = $modelotallerdetalle->getdestino($promtalleralumnost[$j][$l]["idAsignatura"]);
                        if ($datosdestino[0]['tipoAsignatura'] != 4) {
                            $listapromediostallert[$j][] = $promtalleralumnost[$j][$l];
                        } else {
                            $listapromediostallercomt[$j][$promtalleralumnost[$j][$l]['idAsignatura']] = $promtalleralumnost[$j][$l];

                        }
                    }

                }

            }//Fin for Alumnos

        }

        //Asignaturas Combinadas
        $datosasignaturascombinada = $modelasignatura->getcombinada($id, $idperiodo);
        $largoalumnos = count($listaalumnos);
        $largotaller = count($datostaller);
        $largocombinada = count($datosasignaturascombinada);
        $m = 0;

        if ($largocombinada > 0) {
            $m = 0;

            for ($i = 0; $i < $largocombinada; $i++) {
                $listaasignatura[$i] = unserialize($datosasignaturascombinada[$i]['asignaturas']);

                for ($h = 0; $h < count($listaasignatura[$i]); $h++) {
                    $datocombinada = $modelasignatura->getnombre($listaasignatura[$i][$h]);

                    $validacom[$i][$m] = $datosasignaturascombinada[$i]['idAsignatura'];
                    $m++;
                    $validacom[$i][$m] = $datosasignaturascombinada[$i]['idAsignatura'];

                    for ($j = 0; $j < $largoalumnos; $j++) {
                        $datosalumnoscom = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 3, $id, $datocombinada[0]['idAsignatura']);
                        $datosalumnoscoms = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 4, $id, $datocombinada[0]['idAsignatura']);
                        $datosalumnoscomt = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 5, $id, $datocombinada[0]['idAsignatura']);
                        //Primer Semestre
                        if ($listapromediostallercom) {
                            if ($datocombinada[0]['idAsignatura'] == $listapromediostallercom[$j][$datocombinada[0]['idAsignatura']]['idAsignatura']) {
                                $datosalumnoscom[] = $listapromediostallercom[$j][$datocombinada[0]['idAsignatura']];
                            }

                        }
                        //Segundo Semestre
                        if ($listapromediostallercoms) {
                            if ($datocombinada[0]['idAsignatura'] == $listapromediostallercoms[$j][$datocombinada[0]['idAsignatura']]['idAsignatura']) {
                                $datosalumnoscoms[] = $listapromediostallercoms[$j][$datocombinada[0]['idAsignatura']];
                            }

                        }

                        //Tercer Trimestre
                        if ($listapromediostallercomt) {
                            if ($datocombinada[0]['idAsignatura'] == $listapromediostallercomt[$j][$datocombinada[0]['idAsignatura']]['idAsignatura']) {
                                $datosalumnoscoms[] = $listapromediostallercomt[$j][$datocombinada[0]['idAsignatura']];
                            }

                        }

                        //Primer Trimestre
                        for ($k = 0; $k < count($datosalumnoscom); $k++) {
                            if ($datocombinada[0]['idAsignatura'] == $datosalumnoscom[$k]['idAsignatura']) {
                                if ($datosalumnoscom[$k]['coef'] == 2) {
                                    if ($datosalumnoscom[$k]['nota'] > 0) {
                                        $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];
                                        $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];

                                    } else {
                                        $promediocom[$j][$m][] = 0;
                                        $promediocom[$j][$m][] = 0;
                                    }

                                } else {

                                    if ($datosalumnoscom[$k]['nota'] == 0 || empty($datosalumnoscom[$k]['nota']) || $datosalumnoscom[$k]['nota'] == NULL || $datosalumnoscom[$k]['nota'] == '') {
                                        if (!empty($datosalumnoscom[$k]["forma"])) {
                                            if ($datosalumnoscom[$k]['nota'] == 0) {
                                                $promediocom[$j][$m][] = 0;
                                            }

                                        } else {
                                            $promediocom[$j][$m][] = 0;
                                        }


                                    } else {
                                        if (!empty($datosalumnoscom[$k]["forma"]) && $datosalumnoscom[$k]["forma"] == 2) {
                                            $promtalleraux = $datosalumnoscom[$k]['nota'];
                                            $porcentajetaller = $datosalumnoscom[$k]["porcentaje"];


                                        } elseif (!empty($datosalumnoscom[$k]["forma"]) && $datosalumnoscom[$k]["forma"] == 1) {
                                            $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];
                                            $promtalleraux = array();
                                            $porcentajetaller = array();
                                        } else {
                                            $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];
                                            $promtalleraux = array();
                                            $porcentajetaller = array();
                                        }


                                    }

                                }//fin else


                            }

                        }


                        //Segundo Trimestre
                        for ($k = 0; $k < count($datosalumnoscoms); $k++) {
                            if ($datocombinada[0]['idAsignatura'] == $datosalumnoscoms[$k]['idAsignatura']) {
                                if ($datosalumnoscoms[$k]['coef'] == 2) {
                                    if ($datosalumnoscoms[$k]['nota'] > 0) {
                                        $promediocoms[$j][$m][] = $datosalumnoscoms[$k]['nota'];
                                        $promediocoms[$j][$m][] = $datosalumnoscoms[$k]['nota'];

                                    } else {
                                        $promediocoms[$j][$m][] = 0;
                                        $promediocoms[$j][$m][] = 0;
                                    }

                                } else {

                                    if ($datosalumnoscoms[$k]['nota'] == 0 || empty($datosalumnoscoms[$k]['nota']) || $datosalumnoscoms[$k]['nota'] == NULL || $datosalumnoscoms[$k]['nota'] == '') {
                                        if (!empty($datosalumnoscoms[$k]["forma"])) {
                                            if ($datosalumnoscoms[$k]['nota'] == 0) {
                                                $promediocoms[$j][$m][] = 0;
                                            }

                                        } else {
                                            $promediocoms[$j][$m][] = 0;
                                        }


                                    } else {
                                        if (!empty($datosalumnoscoms[$k]["forma"]) && $datosalumnoscoms[$k]["forma"] == 2) {
                                            $promtallerauxs = $datosalumnoscoms[$k]['nota'];
                                            $porcentajetallers = $datosalumnoscoms[$k]["porcentaje"];


                                        } elseif (!empty($datosalumnoscoms[$k]["forma"]) && $datosalumnoscoms[$k]["forma"] == 1) {
                                            $promediocoms[$j][$m][] = $datosalumnoscoms[$k]['nota'];
                                            $promtallerauxs = array();
                                            $porcentajetallers = array();
                                        } else {
                                            $promediocoms[$j][$m][] = $datosalumnoscoms[$k]['nota'];
                                            $promtallerauxs = array();
                                            $porcentajetallers = array();
                                        }


                                    }

                                }//fin else


                            }

                        }

                        //Tercer Trimestre
                        for ($k = 0; $k < count($datosalumnoscomt); $k++) {
                            if ($datocombinada[0]['idAsignatura'] == $datosalumnoscomt[$k]['idAsignatura']) {
                                if ($datosalumnoscomt[$k]['coef'] == 2) {
                                    if ($datosalumnoscomt[$k]['nota'] > 0) {
                                        $promediocomt[$j][$m][] = $datosalumnoscomt[$k]['nota'];
                                        $promediocomt[$j][$m][] = $datosalumnoscomt[$k]['nota'];

                                    } else {
                                        $promediocomt[$j][$m][] = 0;
                                        $promediocomt[$j][$m][] = 0;
                                    }

                                } else {

                                    if ($datosalumnoscomt[$k]['nota'] == 0 || empty($datosalumnoscomt[$k]['nota']) || $datosalumnoscomt[$k]['nota'] == NULL || $datosalumnoscomt[$k]['nota'] == '') {
                                        if (!empty($datosalumnoscomt[$k]["forma"])) {
                                            if ($datosalumnoscomt[$k]['nota'] == 0) {
                                                $promediocomt[$j][$m][] = 0;
                                            }

                                        } else {
                                            $promediocomt[$j][$m][] = 0;
                                        }


                                    } else {
                                        if (!empty($datosalumnoscomt[$k]["forma"]) && $datosalumnoscomt[$k]["forma"] == 2) {
                                            $promtallerauxt = $datosalumnoscomt[$k]['nota'];
                                            $porcentajetallert = $datosalumnoscomt[$k]["porcentaje"];


                                        } elseif (!empty($datosalumnoscomt[$k]["forma"]) && $datosalumnoscomt[$k]["forma"] == 1) {
                                            $promediocomt[$j][$m][] = $datosalumnoscomt[$k]['nota'];
                                            $promtallerauxt = array();
                                            $porcentajetallert = array();
                                        } else {
                                            $promediocomt[$j][$m][] = $datosalumnoscomt[$k]['nota'];
                                            $promtallerauxt = array();
                                            $porcentajetallert = array();
                                        }


                                    }

                                }//fin else


                            }

                        }

                        //Primer Trimestre Promedio
                        if (!empty($promediocom[$j][$m])) {
                            $promset = array_diff($promediocom[$j][$m], array('0'));
                        } else {
                            $promset = 0;
                        }

                        if (is_array($promset)) {
                            if (count($promset) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    if ($porcentajetaller) {
                                        $totalporcentaje = 100;
                                        $porcentajeasig = $totalporcentaje - $porcentajetaller;
                                        $promedioauxalum = array_sum($promset) / count($promset);
                                        $promcom[$j][$m]['nota'] = round(($promedioauxalum * ($porcentajeasig / 100)) + ($promtalleraux * ($porcentajetaller / 100)));

                                    } else {
                                        $promcom[$j][$m]['nota'] = round(array_sum($promset) / count($promset));
                                    }

                                } else {
                                    if ($porcentajetaller) {
                                        $totalporcentaje = 100;
                                        $porcentajeasig = $totalporcentaje - $porcentajetaller;
                                        $promedioauxalum = array_sum($promset) / count($promset);
                                        $promcom[$j][$m]['nota'] = round(($promedioauxalum * ($porcentajeasig / 100)) + ($promtalleraux * ($porcentajetaller / 100)));

                                    } else {
                                        $promcom[$j][$m]['nota'] = intval(array_sum($promset) / count($promset));
                                    }
                                }
                            } else {
                                $promcom[$j][$m]['nota'] = 0;
                            }

                        } else {

                            $promcom[$j][$m]['nota'] = 0;
                        }
                        $promcom[$j][$m]['idAsignatura'] = $datosasignaturascombinada[$i]['idAsignatura'];
                        $promcom[$j][$m]['coef'] = 1;
                        $promcom[$j][$m]['tiempo'] = 3;

                        //Segundo Semestre
                        if (!empty($promediocoms[$j][$m])) {
                            $promsets = array_diff($promediocoms[$j][$m], array('0'));
                        } else {
                            $promsets = 0;
                        }


                        if (is_array($promsets)) {
                            if (count($promsets) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    if ($porcentajetallers) {
                                        $totalporcentajes = 100;
                                        $porcentajeasigs = $totalporcentajes - $porcentajetallers;
                                        $promedioauxalums = array_sum($promsets) / count($promsets);
                                        $promcoms[$j][$m]['nota'] = round(($promedioauxalums * ($porcentajeasigs / 100)) + ($promtallerauxs * ($porcentajetallers / 100)));


                                    } else {
                                        $promcoms[$j][$m]['nota'] = round(array_sum($promsets) / count($promsets));

                                    }

                                } else {
                                    if ($porcentajetallers) {
                                        $totalporcentajes = 100;
                                        $porcentajeasigs = $totalporcentajes - $porcentajetallers;
                                        $promedioauxalums = array_sum($promsets) / count($promsets);
                                        $promcoms[$j][$m]['nota'] = round(($promedioauxalums * ($porcentajeasigs / 100)) + ($promtallerauxs * ($porcentajetallers / 100)));


                                    } else {
                                        $promcoms[$j][$m]['nota'] = intval(array_sum($promsets) / count($promsets));

                                    }
                                }
                            } else {
                                $promcoms[$j][$m]['nota'] = 0;
                            }

                        } else {


                            $promcoms[$j][$m]['nota'] = 0;
                        }
                        $promcoms[$j][$m]['idAsignatura'] = $datosasignaturascombinada[$i]['idAsignatura'];
                        $promcoms[$j][$m]['coef'] = 1;
                        $promcoms[$j][$m]['tiempo'] = 4;


                        //Tercer Semestre
                        if (!empty($promediocomt[$j][$m])) {
                            $promsett = array_diff($promediocomt[$j][$m], array('0'));
                        } else {
                            $promsett = 0;
                        }


                        if (is_array($promsett)) {
                            if (count($promsett) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    if ($porcentajetallert) {
                                        $totalporcentajet = 100;
                                        $porcentajeasigt = $totalporcentajet - $porcentajetallert;
                                        $promedioauxalumt = array_sum($promsett) / count($promsett);
                                        $promcomt[$j][$m]['nota'] = round(($promedioauxalumt * ($porcentajeasigt / 100)) + ($promtallerauxt * ($porcentajetallert / 100)));


                                    } else {
                                        $promcomt[$j][$m]['nota'] = round(array_sum($promsett) / count($promsett));

                                    }

                                } else {
                                    if ($porcentajetallert) {
                                        $totalporcentajet = 100;
                                        $porcentajeasigt = $totalporcentajet - $porcentajetallert;
                                        $promedioauxalumt = array_sum($promsett) / count($promsett);
                                        $promcomt[$j][$m]['nota'] = round(($promedioauxalumt * ($porcentajeasigt / 100)) + ($promtallerauxt * ($porcentajetallert / 100)));


                                    } else {
                                        $promcomt[$j][$m]['nota'] = intval(array_sum($promsett) / count($promsett));

                                    }
                                }
                            } else {
                                $promcomt[$j][$m]['nota'] = 0;
                            }

                        } else {


                            $promcomt[$j][$m]['nota'] = 0;
                        }
                        $promcomt[$j][$m]['idAsignatura'] = $datosasignaturascombinada[$i]['idAsignatura'];
                        $promcomt[$j][$m]['coef'] = 1;
                        $promcomt[$j][$m]['tiempo'] = 5;


                    }
                    $m++;
                }

            }
        }


        //Taller Por Segmento Curso Completo
        $datostallersem = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(3));
        $datostallersemseg = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(4));
        $datostallersemter = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(5));
        $largotallerprimero = count($datostallersem);
        $largotallersegundo = count($datostallersemseg);
        $largotallertercero = count($datostallersemter);


        $promediotaller = array();
        if ($largotallerprimero > 0) {

            for ($i = 0; $i < $largotallerprimero; $i++) {
                if (!empty($datostallersem[$i]['idConfiguracionTaller'])) {
                    $validataller[$i] = $datostallersem[$i]['idAsignaturaTaller'];
                    for ($j = 0; $j < $largoalumnos; $j++) {
                        $promediofinal = 0;
                        $datosalumnostaller = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 3, $id, $datostallersem[$i]['idAsignatura']);


                        for ($k = 0; $k < count($datosalumnostaller); $k++) {
                            if ($datostaller[$i]['idAsignatura'] == $datosalumnostaller[$k]['idAsignatura']) {
                                if ($datosalumnostaller[$k]['coef'] == 2) {
                                    if ($datosalumnostaller[$k]['nota'] > 0) {
                                        $promediotaller[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                        $promediotaller[$j][$i][] = $datosalumnostaller[$k]['nota'];

                                    } else {
                                        $promediotaller[$j][$i][] = 0;
                                        $promediotaller[$j][$i][] = 0;
                                    }

                                } else {
                                    if ($datosalumnostaller[$k]['nota'] > 0) {
                                        $promediotaller[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                    } else {
                                        $promediotaller[$j][$i][] = 0;
                                    }

                                }


                            }

                        }


                        //Primer Semestre
                        if (!empty($promediotaller[$j][$i])) {
                            $promset = array_diff($promediotaller[$j][$i], array('0'));
                        } else {
                            $promset = 0;
                        }

                        if (is_array($promset)) {
                            if (count($promset) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    $promtaller[$j][$i]['nota'] = round(array_sum($promset) / count($promset));

                                } else {
                                    $promtaller[$j][$i]['nota'] = intval(array_sum($promset) / count($promset));
                                }
                            } else {
                                $promtaller[$j][$i]['nota'] = 0;
                            }

                        } else {
                            $promtaller[$j][$i]['nota'] = 0;
                        }


                        $promtaller[$j][$i]['idAsignatura'] = $datostallersem[$i]['idAsignaturaTaller'];
                        $promtaller[$j][$i]['coef'] = 1;
                        $promtaller[$j][$i]['tiempo'] = 3;
                        $promtaller[$j][$i]['forma'] = $datostallersem[$i]['forma'];
                        $promtaller[$j][$i]['porcentaje'] = $datostallersem[$i]['porcentaje'];


                    }

                }


            }
        }

        //Segundo Trimestre
        if ($largotallersegundo > 0) {

            for ($i = 0; $i < $largotallersegundo; $i++) {
                if (!empty($datostallersemseg[$i]['idConfiguracionTaller'])) {
                    $validatallers[$i] = $datostallersemseg[$i]['idAsignaturaTaller'];
                    for ($j = 0; $j < $largoalumnos; $j++) {
                        $promediofinal = 0;
                        $datosalumnostallers = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 4, $id, $datostallersemseg[$i]['idAsignatura']);

                        for ($k = 0; $k < count($datosalumnostallers); $k++) {
                            if ($datostallersemseg[$i]['idAsignatura'] == $datosalumnostallers[$k]['idAsignatura']) {
                                if ($datosalumnostallers[$k]['coef'] == 2) {
                                    if ($datosalumnostallers[$k]['nota'] > 0) {
                                        $promediotallers[$j][$i][] = $datosalumnostallers[$k]['nota'];
                                        $promediotallers[$j][$i][] = $datosalumnostallers[$k]['nota'];

                                    } else {
                                        $promediotallers[$j][$i][] = 0;
                                        $promediotallers[$j][$i][] = 0;
                                    }

                                } else {
                                    if ($datosalumnostallers[$k]['nota'] > 0) {
                                        $promediotallers[$j][$i][] = $datosalumnostallers[$k]['nota'];
                                    } else {
                                        $promediotallers[$j][$i][] = 0;
                                    }

                                }


                            }


                        }
                        if (!empty($promediotallers[$j][$i])) {
                            $promsets = array_diff($promediotallers[$j][$i], array('0'));
                        } else {
                            $promsets = 0;
                        }

                        if (is_array($promsets)) {
                            if (count($promsets) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    $auxtallers = round(array_sum($promsets) / count($promsets));
                                    $promtallers[$j][$i]['nota'] = intval($auxtallers);

                                } else {
                                    $promtallers[$j][$i]['nota'] = intval(array_sum($promsets) / count($promsets));
                                }
                            } else {
                                $promtallers[$j][$i]['nota'] = 0;
                            }

                        } else {
                            $promtallers[$j][$i]['nota'] = 0;
                        }


                        $promtallers[$j][$i]['idAsignatura'] = $datostallersemseg[$i]['idAsignaturaTaller'];
                        $promtallers[$j][$i]['coef'] = 1;
                        $promtallers[$j][$i]['tiempo'] = 4;
                        $promtallers[$j][$i]['forma'] = $datostallersemseg[$i]['forma'];
                        $promtallers[$j][$i]['porcentaje'] = $datostallersemseg[$i]['porcentaje'];


                    }

                }


            }
        }

        //Tercer Trimestre
        if ($largotallertercero > 0) {

            for ($i = 0; $i < $largotallertercero; $i++) {
                if (!empty($datostallersemter[$i]['idConfiguracionTaller'])) {
                    $validatallert[$i] = $datostallersemter[$i]['idAsignaturaTaller'];
                    for ($j = 0; $j < $largoalumnos; $j++) {
                        $promediofinal = 0;
                        $datosalumnostallert = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 5, $id, $datostallersemter[$i]['idAsignatura']);

                        for ($k = 0; $k < count($datosalumnostallert); $k++) {
                            if ($datostallersemter[$i]['idAsignatura'] == $datosalumnostallert[$k]['idAsignatura']) {
                                if ($datosalumnostallert[$k]['coef'] == 2) {
                                    if ($datosalumnostallert[$k]['nota'] > 0) {
                                        $promediotallert[$j][$i][] = $datosalumnostallert[$k]['nota'];
                                        $promediotallert[$j][$i][] = $datosalumnostallert[$k]['nota'];

                                    } else {
                                        $promediotallert[$j][$i][] = 0;
                                        $promediotallert[$j][$i][] = 0;
                                    }

                                } else {
                                    if ($datosalumnostallert[$k]['nota'] > 0) {
                                        $promediotallert[$j][$i][] = $datosalumnostallert[$k]['nota'];
                                    } else {
                                        $promediotallert[$j][$i][] = 0;
                                    }

                                }


                            }


                        }
                        if (!empty($promediotallert[$j][$i])) {
                            $promsett = array_diff($promediotallert[$j][$i], array('0'));
                        } else {
                            $promsett = 0;
                        }

                        if (is_array($promsett)) {
                            if (count($promsett) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    $auxtallert = round(array_sum($promsett) / count($promsett));
                                    $promtallert[$j][$i]['nota'] = intval($auxtallert);

                                } else {
                                    $promtallert[$j][$i]['nota'] = intval(array_sum($promsett) / count($promsett));
                                }
                            } else {
                                $promtallert[$j][$i]['nota'] = 0;
                            }

                        } else {
                            $promtallert[$j][$i]['nota'] = 0;
                        }


                        $promtallert[$j][$i]['idAsignatura'] = $datostallersemter[$i]['idAsignaturaTaller'];
                        $promtallert[$j][$i]['coef'] = 1;
                        $promtallert[$j][$i]['tiempo'] = 5;
                        $promtallert[$j][$i]['forma'] = $datostallersemter[$i]['forma'];
                        $promtallert[$j][$i]['porcentaje'] = $datostallersemter[$i]['porcentaje'];


                    }

                }


            }
        }


        if ($largoalumnos == 0 || empty($listanotas)) {
            echo "<script type=\"text/javascript\">alert(\"Sin Notas\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            exit;

        }

        for ($i = 0; $i < $largoalumnos; $i++) {

            $valores = $modelnotas->listarnotasporalumno($listaalumnos[$i]['idAlumnos'], $idperiodo, $id);
            if ($valores != '' || !empty($valores)) {
                $listaalumnos[$i]['listanotas'] = $valores;
            } else {
                $listaalumnos[$i]['listanotas'] = 0;

            }

            //Primer Trimestre
            for ($j = 0; $j < count($promtaller[$i]); $j++) {
                $listaalumnos[$i]['listanotas'][] = $promtaller[$i][$j];
            }

            //Segundo Trimestre
            for ($j = 0; $j < count($promtallers[$i]); $j++) {
                $listaalumnos[$i]['listanotas'][] = $promtallers[$i][$j];
            }

            //TercerTrimestre
            for ($j = 0; $j < count($promtallert[$i]); $j++) {
                $listaalumnos[$i]['listanotas'][] = $promtallert[$i][$j];
            }
            //Primer Trimestre Combinada
            foreach ($promcom[$i] as $a => $j) {
                $listaalumnos[$i]['listanotas'][] = $promcom[$i][$a];
            }

            //Segundo Trimestre Combinada
            foreach ($promcoms[$i] as $a => $j) {
                $listaalumnos[$i]['listanotas'][] = $promcoms[$i][$a];
            }

            //Tercer Trimestre Combinada
            foreach ($promcomt[$i] as $a => $j) {
                $listaalumnos[$i]['listanotas'][] = $promcomt[$i][$a];
            }

            if ($listapromediostaller[$i]) {
                for ($j = 0; $j < count($listapromediostaller[$i]); $j++) {
                    $listaalumnos[$i]['listanotas'][] = $listapromediostaller[$i][$j];
                }
            }

            if ($listapromediostallers[$i]) {
                for ($j = 0; $j < count($listapromediostallers[$i]); $j++) {
                    $listaalumnos[$i]['listanotas'][] = $listapromediostallers[$i][$j];
                }
            }

            if ($listapromediostallert[$i]) {
                for ($j = 0; $j < count($listapromediostallert[$i]); $j++) {
                    $listaalumnos[$i]['listanotas'][] = $listapromediostallert[$i][$j];
                }
            }


        }


        $nombreseg = 'FINAL';
        $logo = getcwd();
        $logo .= "/application/documentos/logos/" . $datoscurso[0]['extension'];


        // variables para encabezado
        $titulo = strtoupper($datoscurso[0]['nombreEstablecimiento']) . '<br>' . strtoupper($nombreseg);

        if (file_exists($logo)) {
            $encabezado = '<img style="position:absolute;top:10px;left:30px" src="' . $logo . '" /><h4 style="position:absolute;top:50px;text-align:center">' . $titulo . '</h4>';

        } else {
            $encabezado = '<p style="position:absolute;top:5px;text-align:left"></p><h4 style="position:absolute;top:50px;text-align:center">' . $titulo . '</h4>';

        }

        if (!empty($datosasignaturas)) {
            $largoasignatura = count($datosasignaturas);
            for ($i = 0; $i < $largoasignatura; $i++) {

                $datoscuenta[$i] = $modelnotas->listarcantidadnotasanual($id, $idperiodo, $datosasignaturas[$i]['idAsignatura']);
                if (empty($datoscuenta[$i]) && $datosasignaturas[$i]['tipoAsignatura'] == 1) {
                    $datosasig[$i] = 0;
                } else {
                    $largonotas = count($datoscuenta[$i]);
                    $datosasig[$i] = 0;
                    //Primer Trimestre
                    for ($j = 0; $j < count($validataller); $j++) {
                        if ($datosasignaturas[$i]['idAsignatura'] == $validataller[$j]) {
                            $datosasig[$i] += 1;
                        }
                    }
                    //Segundo Trimestre

                    for ($j = 0; $j < count($validatallers); $j++) {
                        if ($datosasignaturas[$i]['idAsignatura'] == $validatallers[$j]) {
                            $datosasig[$i] += 1;
                        }
                    }

                    //Tercer Trimestre
                    for ($j = 0; $j < count($validatallert); $j++) {
                        if ($datosasignaturas[$i]['idAsignatura'] == $validatallert[$j]) {
                            $datosasig[$i] += 1;
                        }
                    }

                    for ($j = 0; $j < count($validacom); $j++) {
                        foreach ($validacom[$j] as $a => $h) {
                            if ($datosasignaturas[$i]['idAsignatura'] == $validacom[$j][$a]) {
                                $datosasig[$i] += 1;
                            }
                        }

                    }

                    for ($j = 0; $j < count($datostalleres); $j++) {
                        if ($datosasignaturas[$i]['idAsignatura'] == $datostalleres[$j]['idAsignaturaTaller']) {
                            $datosasig[$i] += 1;
                        }
                    }

                    for ($j = 0; $j < $largonotas; $j++) {
                        if ($datoscuenta[$i][$j]['tiempo'] == 3 || $datoscuenta[$i][$j]['tiempo'] == 4 || $datoscuenta[$i][$j]['tiempo'] == 5) {
                            if ($datoscuenta[$i][$j]['coef'] == 2) {
                                $datosasig[$i] += 2;
                            } else {
                                $datosasig[$i] += 1;
                            }
                        }


                    }


                }

                //Si la configuracion indica que se utiliza examen
                if ($datoscurso[0]['examen'] == 1) {
                    $modeloprueba = new Application_Model_DbTable_Pruebas();
                    //Verificamos que las asignaturas posean examen
                    $datosexamenes[$i] = $modeloprueba->getexamen($id, $idperiodo, $datosasignaturas[$i]['idAsignatura'], 6);

                }


            }
        } else {
            echo "<script type=\"text/javascript\">alert(\"El Curso no Posee Asignaturas en el periodo\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            exit;

        }


        //Estilo pdf
        $style = "body{
font:12px ,Arial, Tahoma, Verdana, Helvetica, sans-serif;

color:#000;
}
img{
  width:60px;
  height:70px;
}


table{
font-size:10px;
width:100%;
height:auto;
margin:10px 0 10px 0;
border-collapse:collapse;
text-align:center;
text-justify:inter-word;
color:#000000;
}

table td,th{
border:1px solid black;
}

table th{
padding:1px;
background-color: #ccc;
}
";

        $pag = 0;
        $cuentapag = 0;
        $max = 23;


        $html[$pag] = $encabezado;
        $html[$pag] .= "<div style='position:absolute;top:75px;left:25px;'><br> Curso: <b>" . $datoscurso[0]['nombreGrado'] . " " . $datoscurso[0]['letra'] . "</b><br> Fecha : <b>" . $fecha_final . "</b></div>";

        $html[$pag] .= '<table align="left" style="margin-left:20px"><tr><th>Nº</th><th>Alumnos</th>';

        for ($i = 0; $i < $largoasignatura; $i++) {


            //obtenemos cuantas notas existen en cada asignatura
            $row = $datosasig[$i];
            $cuentapag = $cuentapag + $row;

            // si la cantidad de notas supera las 28 sumamos al contador de pag
            if ($cuentapag > $max) {
                $pag++;
                if ($pag == 1) {
                    $max = 40;
                }
                if ($pag == 2) {
                    $max = 60;
                }
                if ($pag == 3) {
                    $max = 80;
                }
                if ($pag == 4) {
                    $max = 100;
                }
                if ($pag == 5) {
                    $max = 120;
                }
                if ($pag == 6) {
                    $max = 140;
                }
                if ($pag == 7) {
                    $max = 160;
                }
                $html[$pag] = '<table align="left" style="margin-left:20px"><tr><th>Nº</th><th>Alumno</th>';

            }


            //si row es distinto de cero suma uno a row para crear el promedio
            if ($row != 0) {
                $row = $row + 4;
                if ($datosexamenes[$i]) {
                    $html[$pag] .= '<th style="width:25px;text-align:left;word-break: break-all;" colspan=' . ($row + 2) . '>' . $datosasignaturas[$i]["nombreAsignatura"] . '</th>';

                } else {
                    $html[$pag] .= '<th style="width:25px;text-align:left;word-break: break-all;" colspan=' . $row . '>' . $datosasignaturas[$i]["nombreAsignatura"] . '</th>';

                }
            } else {

                $html[$pag] .= '<th style="width:25px;text-align:left;word-break: break-all;">' . $datosasignaturas[$i]["nombreAsignatura"] . '</th>';

            }
        }

        $html[$pag] .= "<th>PROM</th><th>Días</th><th>Días</th><th>%</th>";

        $pag = 0;
        $cuentapag = 0;
        $max = 23;
        $cuentapag2 = array();


        $html[$pag] .= '</tr><tr><th colspan="2">Nº Notas/Prom</th>';

        for ($i = 0; $i < $largoasignatura; $i++) {


            $row = $datosasig[$i];
            $cuentapag = $cuentapag + $row;

            // si la cantidad de notas supera las notas que ingresan en una hoja
            if ($cuentapag > $max) {
                $html[$pag] .= '</tr>';
                $pag++;

                if ($pag == 1) {
                    $max = 40;
                }
                if ($pag == 2) {
                    $max = 60;
                }
                if ($pag == 3) {
                    $max = 80;
                }
                if ($pag == 4) {
                    $max = 100;
                }
                if ($pag == 5) {
                    $max = 120;
                }
                if ($pag == 6) {
                    $max = 140;
                }
                if ($pag == 7) {
                    $max = 160;
                }
                $html[$pag] .= '</tr><tr><th colspan="2">Nº Notas/Prom</th>';

            }

            if ($row != 0) {

                for ($j = 1; $j <= $row; $j++) {

                    $html[$pag] .= '<th>N' . $j . '</th>';
                    $cuentapag2[$pag] += 1;
                }
                if ($datosexamenes[$i]) {
                    $html[$pag] .= '<th>I TRIM</th>';
                    $html[$pag] .= '<th>II TRIM</th>';
                    $html[$pag] .= '<th>III TRIM</th>';
                    $html[$pag] .= '<th>FIN</th>';
                    $html[$pag] .= '<th>EX <br>' . $datosexamenes[$i][0]['porcentajeExamen'] . ' %</th>';
                    $html[$pag] .= '<th>FIN + <br>EX ' . $datosexamenes[$i][0]['porcentajeExamen'] . ' %</th>';
                    $cuentapag2[$pag] += 6;
                } else {
                    $html[$pag] .= '<th>I TRIM</th>';
                    $html[$pag] .= '<th>II TRIM</th>';
                    $html[$pag] .= '<th>III TRIM</th>';
                    $html[$pag] .= '<th>FIN</th>';
                    $cuentapag2[$pag] += 4;
                }


            } else {
                $html[$pag] .= '<th>Sin Notas</th>';
                $cuentapag2[$pag] += 1;

            }


        }


        $html[$pag] .= '<th>PROM</th>';
        $cuentapag2[$pag] += 1;
        $html[$pag] .= '<th>Trab</th><th>Inas</th><th>Asis</th>';


        $html[$pag] .= '</tr>';


        if (!empty($listaalumnos)) {
            $r = 0;

            for ($i = 0; $i < $largoalumnos; $i++) {
                //for ($i = 0; $i < 1; $i++) {
                $pag = 0;
                $cuentapag = 0;
                $max = 23;
                $html[$pag] .= '<tr><td>' . ($i + 1) . '</td><td style="text-align: left;">' . $listaalumnos[$i]["apaterno"] . ' ' . $listaalumnos[$i]["amaterno"] . ' ' . $listaalumnos[$i]["nombres"] . '</td>';
                $r = 0;
                for ($j = 0; $j < $largoasignatura; $j++) {

                    $promtalleraux = array();
                    $porcentajetaller = array();
                    $sumataller = 0;
                    $promtallerauxs = array();
                    $porcentajetallers = array();
                    $promtallerauxt = array();
                    $porcentajetallert = array();
                    $sumatallers = 0;
                    $sumatallert = 0;
                    $row = $datosasig[$j];
                    $cuentapag = $cuentapag + $row;

                    if ($cuentapag > $max) {
                        $html[$pag] .= '</tr>';
                        $pag++;
                        if ($pag == 1) {
                            $max = 40;
                        }
                        if ($pag == 2) {
                            $max = 60;
                        }
                        if ($pag == 3) {
                            $max = 80;
                        }
                        if ($pag == 4) {
                            $max = 100;
                        }
                        if ($pag == 5) {
                            $max = 120;
                        }
                        if ($pag == 6) {
                            $max = 140;
                        }
                        if ($pag == 7) {
                            $max = 160;
                        }

                        $html[$pag] .= '<tr><td>' . ($i + 1) . '</td><td style="text-align: left;">' . $listaalumnos[$i]["apaterno"] . ' ' . $listaalumnos[$i]["amaterno"] . ' ' . $listaalumnos[$i]["nombres"] . '</td>';

                    }

                    $promedio = 0;
                    $contador = 0;
                    $contadorpromedio = 0;
                    $promedios = 0;
                    $contadorpromedios = 0;
                    $promediot = 0;
                    $contadorpromediot = 0;
                    if ($row != 0) {
                        $largolistanota = count($listaalumnos[$i]['listanotas']);
                        for ($z = 0; $z < $largolistanota; $z++) {
                            $contadoraux = 0;

                            if ($datosasignaturas[$j]['idAsignatura'] == $listaalumnos[$i]['listanotas'][$z]['idAsignatura']) {


                                $contador += 1;
                                //Primer Trimestre
                                if ($listaalumnos[$i]['listanotas'][$z]['tiempo'] == '3') {
                                    $auxiliar[$i][] = $listaalumnos[$i]['listanotas'][$z];
                                    if ($listaalumnos[$i]['listanotas'][$z]['coef'] == '2') {
                                        $contador += 1;
                                        if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == NULL || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {
                                            $promedio += 0;
                                            $contadorpromedio += 0;
                                            $html[$pag] .= '<td> - </td>';
                                            $html[$pag] .= '<td> - </td>';
                                            $notamatriz[$r][] = 0;
                                            $r++;
                                            $notamatriz[$r][] = 0;
                                            $r++;

                                        } else {
                                            $html[$pag] .= '<td>' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                            $html[$pag] .= '<td>' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                            $promedio = $promedio + ($listaalumnos[$i]['listanotas'][$z]['nota'] + $listaalumnos[$i]['listanotas'][$z]['nota']);
                                            $contadorpromedio = $contadorpromedio + 2;
                                            $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                            $r++;
                                            $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                            $r++;


                                        }

                                    } else {

                                        if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == NULL || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {
                                            if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"])) {
                                                if ($listaalumnos[$i]["listanotas"][$z]["nota"] == 0) {

                                                    $promedio += 0;
                                                    $contadorpromedio += 0;
                                                    $html[$pag] .= '<td> - </td>';
                                                    $notamatriz[$r][] = 0;
                                                    $r++;


                                                }

                                            } else {
                                                $promedio += 0;
                                                $contadorpromedio += 0;
                                                $html[$pag] .= '<td> - </td>';
                                                $notamatriz[$r][] = 0;
                                                $r++;

                                            }


                                        } else {

                                            if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"]) && $listaalumnos[$i]["listanotas"][$z]["forma"] == 2) {


                                                $contadorauxtaller = true;
                                                $promtalleraux[] = $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $porcentajetaller[] = $listaalumnos[$i]["listanotas"][$z]["porcentaje"];
                                                $html[$pag] .= '<td bgcolor="#B2B0AF">' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                                $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                                $r++;


                                            } elseif (!empty($listaalumnos[$i]["listanotas"][$z]["forma"]) && $listaalumnos[$i]["listanotas"][$z]["forma"] == 1) {
                                                $html[$pag] .= '<td bgcolor="#B2B0AF">' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                                $promedio = $promedio + $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $contadorpromedio = $contadorpromedio + 1;
                                                $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                                $r++;
                                            } else {
                                                $html[$pag] .= '<td>' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                                $promedio = $promedio + $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $contadorpromedio = $contadorpromedio + 1;
                                                $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                                $r++;

                                            }


                                        }


                                    }
                                }
                                //Segundo Trimestre
                                if ($listaalumnos[$i]['listanotas'][$z]['tiempo'] == '4') {
                                    $auxiliar[$i][] = $listaalumnos[$i]['listanotas'][$z];

                                    if ($listaalumnos[$i]['listanotas'][$z]['coef'] == '2') {
                                        $contador += 1;
                                        if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == NULL || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {
                                            $promedios += 0;
                                            $contadorpromedios += 0;
                                            $html[$pag] .= '<td> - </td>';
                                            $html[$pag] .= '<td> - </td>';
                                            $notamatriz[$r][] = 0;
                                            $r++;
                                            $notamatriz[$r][] = 0;
                                            $r++;

                                        } else {
                                            $promedios += ($listaalumnos[$i]['listanotas'][$z]['nota'] + $listaalumnos[$i]['listanotas'][$z]['nota']);
                                            $contadorpromedios += 2;
                                            $html[$pag] .= '<td>' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                            $html[$pag] .= '<td>' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                            $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                            $r++;
                                            $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                            $r++;
                                        }

                                    } else {

                                        if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == NULL || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {
                                            if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"])) {
                                                if ($listaalumnos[$i]["listanotas"][$z]["nota"] == 0) {

                                                    $promedios += 0;
                                                    $contadorpromedios += 0;
                                                    $html[$pag] .= '<td> - </td>';
                                                    $notamatriz[$r][] = 0;
                                                    $r++;


                                                }

                                            } else {
                                                $promedios += 0;
                                                $contadorpromedios += 0;
                                                $html[$pag] .= '<td> - </td>';
                                                $notamatriz[$r][] = 0;
                                                $r++;


                                            }


                                        } else {

                                            if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"]) && $listaalumnos[$i]["listanotas"][$z]["forma"] == 2) {


                                                $contadorauxtallers = true;
                                                $promtallerauxs[] = $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $porcentajetallers[] = $listaalumnos[$i]["listanotas"][$z]["porcentaje"];
                                                $html[$pag] .= '<td bgcolor="#B2B0AF">' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                                $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                                $r++;


                                            } elseif (!empty($listaalumnos[$i]["listanotas"][$z]["forma"]) && $listaalumnos[$i]["listanotas"][$z]["forma"] == 1) {
                                                $html[$pag] .= '<td bgcolor="#B2B0AF">' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                                $promedios = $promedios + $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $contadorpromedios = $contadorpromedios + 1;
                                                $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                                $r++;
                                            } else {
                                                $html[$pag] .= '<td>' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                                $promedios = $promedios + $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $contadorpromedios = $contadorpromedios + 1;
                                                $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                                $r++;

                                            }

                                        }


                                    }
                                }

                                //Tercer Trimestre
                                if ($listaalumnos[$i]['listanotas'][$z]['tiempo'] == '5') {
                                    $auxiliar[$i][] = $listaalumnos[$i]['listanotas'][$z];

                                    if ($listaalumnos[$i]['listanotas'][$z]['coef'] == '2') {
                                        $contador += 1;
                                        if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == NULL || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {
                                            $promediot += 0;
                                            $contadorpromediot += 0;
                                            $html[$pag] .= '<td> - </td>';
                                            $html[$pag] .= '<td> - </td>';
                                            $notamatriz[$r][] = 0;
                                            $r++;
                                            $notamatriz[$r][] = 0;
                                            $r++;

                                        } else {
                                            $promediot += ($listaalumnos[$i]['listanotas'][$z]['nota'] + $listaalumnos[$i]['listanotas'][$z]['nota']);
                                            $contadorpromediot += 2;
                                            $html[$pag] .= '<td>' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                            $html[$pag] .= '<td>' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                            $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                            $r++;
                                            $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                            $r++;
                                        }

                                    } else {

                                        if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == NULL || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {
                                            if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"])) {
                                                if ($listaalumnos[$i]["listanotas"][$z]["nota"] == 0) {

                                                    $promediot += 0;
                                                    $contadorpromediot += 0;
                                                    $html[$pag] .= '<td> - </td>';
                                                    $notamatriz[$r][] = 0;
                                                    $r++;


                                                }

                                            } else {
                                                $promediot += 0;
                                                $contadorpromediot += 0;
                                                $html[$pag] .= '<td> - </td>';
                                                $notamatriz[$r][] = 0;
                                                $r++;


                                            }


                                        } else {

                                            if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"]) && $listaalumnos[$i]["listanotas"][$z]["forma"] == 2) {


                                                $contadorauxtallert = true;
                                                $promtallerauxt[] = $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $porcentajetallert[] = $listaalumnos[$i]["listanotas"][$z]["porcentaje"];
                                                $html[$pag] .= '<td bgcolor="#B2B0AF">' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                                $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                                $r++;


                                            } elseif (!empty($listaalumnos[$i]["listanotas"][$z]["forma"]) && $listaalumnos[$i]["listanotas"][$z]["forma"] == 1) {
                                                $html[$pag] .= '<td bgcolor="#B2B0AF">' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                                $promediot = $promediot + $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $contadorpromediot = $contadorpromediot + 1;
                                                $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                                $r++;
                                            } else {
                                                $html[$pag] .= '<td>' . $listaalumnos[$i]["listanotas"][$z]["nota"] . '</td>';
                                                $promediot = $promediot + $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $contadorpromediot = $contadorpromediot + 1;
                                                $notamatriz[$r][] = intval($listaalumnos[$i]['listanotas'][$z]['nota']);
                                                $r++;

                                            }

                                        }


                                    }
                                }


                                //Promedios por notas

                                if ($contador == $row) {


                                    //Primer Trimestre
                                    if ($contadorpromedio != 0 && $promedio != 0) {
                                        $promedioaux = 0;
                                        //SI el Taller es por porcentaje
                                        if ($contadorauxtaller) {
                                            $totalporcentaje = 100;
                                            if (count($promtalleraux) > 1) {
                                                for ($t = 0; $t < count($promtalleraux); $t++) {
                                                    $totalporcentaje = $totalporcentaje - $porcentajetaller[$t];
                                                    $sumataller += $promtalleraux[$t] * ($porcentajetaller[$t] / 100);
                                                }

                                            } else {
                                                $totalporcentaje = 100 - $porcentajetaller[0];
                                                $sumataller = $promtalleraux[0] * ($porcentajetaller[0] / 100);

                                            }


                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioaux = round($promedio / $contadorpromedio);
                                                $promedioaux = ($promedioaux * ($totalporcentaje / 100)) + $sumataller;
                                                $promedioaux = round($promedioaux);
                                                $notamatriz[$r][] = $promedioaux;

                                            } else {
                                                $promedioaux = round($promedio / $contadorpromedio);
                                                $promedioaux = ($promedioaux * ($totalporcentaje / 100)) + $sumataller;
                                                $promedioaux = intval($promedioaux);
                                                $notamatriz[$r][] = $promedioaux;
                                            }

                                        } else {

                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioaux = round($promedio / $contadorpromedio);
                                                $promfinal[$i][] = $promedioaux;
                                                $notamatriz[$r][] = $promedioaux;

                                            } else {
                                                $promedioaux = intval($promedio / $contadorpromedio);
                                                $promfinal[$i][] = $promedioaux;
                                                $notamatriz[$r][] = $promedioaux;
                                            }

                                        }
                                        $r++;


                                        $html[$pag] .= '<td>' . $promedioaux . '</td>';


                                    } else {
                                        $promedioaux = 0;
                                        $promfinal[$i][] = 0;
                                        $notamatriz[$r][] = 0;
                                        $html[$pag] .= '<td>-</td>';
                                        $r++;


                                    }


                                    //Segundo Trimestre
                                    if ($contadorpromedios != 0 && $promedios != 0) {
                                        $promedioauxs = 0;
                                        //SI el Taller es por porcentaje
                                        if ($contadorauxtallers) {
                                            $totalporcentajes = 100;
                                            if (count($promtallerauxs) > 1) {
                                                for ($t = 0; $t < count($promtallerauxs); $t++) {
                                                    $totalporcentajes = $totalporcentajes - $porcentajetallers[$t];
                                                    $sumatallers += $promtallerauxs[$t] * ($porcentajetallers[$t] / 100);
                                                }

                                            } else {
                                                $totalporcentajes = 100 - $porcentajetallers[0];
                                                $sumatallers = $promtallerauxs[0] * ($porcentajetallers[0] / 100);

                                            }


                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioauxs = round($promedios / $contadorpromedios);
                                                $promedioauxs = ($promedioauxs * ($totalporcentajes / 100)) + $sumatallers;
                                                $promedioauxs = round($promedioauxs);
                                                $notamatriz[$r][] = $promedioauxs;

                                            } else {
                                                $promedioauxs = round($promedios / $contadorpromedios);
                                                $promedioauxs = ($promedioauxs * ($totalporcentajes / 100)) + $sumatallers;
                                                $promedioauxs = intval($promedioauxs);
                                                $notamatriz[$r][] = $promedioauxs;
                                            }

                                        } else {

                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioauxs = round($promedios / $contadorpromedios);
                                                $promfinal[$i][] = $promedioauxs;
                                                $notamatriz[$r][] = $promedioauxs;

                                            } else {
                                                $promedioauxs = intval($promedios / $contadorpromedios);
                                                $promfinal[$i][] = $promedioauxs;
                                                $notamatriz[$r][] = $promedioauxs;
                                            }
                                        }
                                        $r++;


                                        $html[$pag] .= '<td>' . $promedioauxs . '</td>';


                                    } else {
                                        $promedioauxs = 0;
                                        $promfinal[$i][] = 0;
                                        $notamatriz[$r][] = 0;
                                        $html[$pag] .= '<td>-</td>';
                                        $r++;


                                    }

                                    //Tercer Trimestre
                                    if ($contadorpromediot != 0 && $promediot != 0) {
                                        $promedioauxt = 0;
                                        //SI el Taller es por porcentaje
                                        if ($contadorauxtallert) {
                                            $totalporcentajet = 100;
                                            if (count($promtallerauxt) > 1) {
                                                for ($t = 0; $t < count($promtallerauxt); $t++) {
                                                    $totalporcentajet = $totalporcentajet - $porcentajetallert[$t];
                                                    $sumatallert += $promtallerauxt[$t] * ($porcentajetallert[$t] / 100);
                                                }

                                            } else {
                                                $totalporcentajet = 100 - $porcentajetallert[0];
                                                $sumatallert = $promtallerauxt[0] * ($porcentajetallert[0] / 100);

                                            }


                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioauxt = round($promediot / $contadorpromediot);
                                                $promedioauxt = ($promedioauxt * ($totalporcentajet / 100)) + $sumatallert;
                                                $promedioauxt = round($promedioauxt);
                                                $notamatriz[$r][] = $promedioauxt;

                                            } else {
                                                $promedioauxt = round($promediot / $contadorpromediot);
                                                $promedioauxt = ($promedioauxt * ($totalporcentajet / 100)) + $sumatallert;
                                                $promedioauxt = intval($promedioauxt);
                                                $notamatriz[$r][] = $promedioauxt;
                                            }

                                        } else {

                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioauxt = round($promediot / $contadorpromediot);
                                                $promfinal[$i][] = $promedioauxt;
                                                $notamatriz[$r][] = $promedioauxt;

                                            } else {
                                                $promedioauxt = intval($promediot / $contadorpromediot);
                                                $promfinal[$i][] = $promedioauxt;
                                                $notamatriz[$r][] = $promedioauxt;
                                            }
                                        }
                                        $r++;


                                        $html[$pag] .= '<td>' . $promedioauxt . '</td>';


                                    } else {
                                        $promedioauxt = 0;
                                        $promfinal[$i][] = 0;
                                        $notamatriz[$r][] = 0;
                                        $html[$pag] .= '<td>-</td>';
                                        $r++;


                                    }


                                    //Promedio Final De Asignatura
                                    $finalasignatura = 0;

                                    $promedio_aux_final = array($promedioaux, $promedioauxs, $promedioauxt);
                                    $resultado_aux_final = array_values(array_diff($promedio_aux_final, array('0')));


                                    if (!empty($resultado_aux_final)) {


                                        if ($datoscurso[0]['aproxAnual'] == 1) {
                                            $finalasignatura = round(array_sum($resultado_aux_final) / count($resultado_aux_final));
                                            if ($finalasignatura == 39 && $datoscurso[0]['rbd'] == '1864') {
                                                $finalasignatura = 40;
                                            }
                                        } else {
                                            $finalasignatura = intval(array_sum($resultado_aux_final) / count($resultado_aux_final));
                                            if ($finalasignatura == 39 && $datoscurso[0]['rbd'] == '1864') {
                                                $finalasignatura = 40;
                                            }

                                        }

                                        if ($agregadecimas) {
                                            if ($finalasignatura >= 60) {
                                                $finalasignatura += 2;
                                                if ($finalasignatura > 70) {
                                                    $finalasignatura = 70;

                                                }

                                            }
                                        }
                                    } else {
                                        $finalasignatura = 0;
                                    }

//                                    if ($promedioaux != 0 && $promedioauxs != 0) {
//
//                                        if ($datoscurso[0]['aproxAnual'] == 1) {
//                                            $finalasignatura = round(($promedioaux + $promedioauxs) / 2);
//                                            if ($finalasignatura == 39 && $datoscurso[0]['rbd'] == '1864') {
//                                                $finalasignatura = 40;
//                                            }
//                                        } else {
//                                            $finalasignatura = intval(($promedioaux + $promedioauxs) / 2);
//                                            if ($finalasignatura == 39 && $datoscurso[0]['rbd'] == '1864') {
//                                                $finalasignatura = 40;
//                                            }
//
//                                        }
//                                        if ($agregadecimas) {
//                                            if ($finalasignatura >= 60) {
//                                                $finalasignatura += 2;
//                                                if ($finalasignatura > 70) {
//                                                    $finalasignatura = 70;
//
//                                                }
//
//                                            }
//                                        }
//
//
//                                    }


                                    //Inicio Examen

                                    if (count($datosexamenes[$j]) > 0) {
                                        //$promediototal[$i][] = $finalasignatura;
                                        $html[$pag] .= '<td>' . $finalasignatura . '</td>';
                                        $notamatriz[$r][] = $finalasignatura;
                                        $r++;

                                        $datosalumnosexamen = $modelnotas->getnotasexamenalumno($datosexamenes[$j][0]['idEvaluacion'], $id, $datosasignaturas[$j]['idAsignatura'], $idperiodo, 6, $listaalumnos[$i]['idAlumnos']);


                                        if (count($datosalumnosexamen) > 0) {


                                            if ($datosalumnosexamen[0]['nota'] > 0) {
                                                $html[$pag] .= '<td>' . $datosalumnosexamen[0]['nota'] . '</td>';
                                                $notamatriz[$r][] = $datosalumnosexamen[0]['nota'];
                                                $r++;

                                                $totalex = 100 - $datosexamenes[$j][0]['porcentajeExamen'];

                                                //nota d examen

                                                $sumaex = $datosalumnosexamen[0]['nota'] * ($datosexamenes[$i][0]['porcentajeExamen'] / 100);

                                                if ($datoscurso[0]['aproxExamen'] == 1) {
                                                    $finalasignatura = round(($finalasignatura * ($totalex / 100)) + $sumaex);
                                                } else {
                                                    $finalasignatura = intval(($finalasignatura * ($totalex / 100)) + $sumaex);
                                                }


                                            } else {
                                                $html[$pag] .= '<td>-</td>';
                                                $notamatriz[$r][] = $datosalumnosexamen[0]['nota'];
                                                $r++;
                                                $finalasignatura = $finalasignatura;
                                            }

                                        } else {
                                            $html[$pag] .= '<td>-</td>';
                                            $notamatriz[$r][] = 0;
                                            $r++;
                                        }
                                        //Promedio FInal
                                        $promediototal[$i][] = $finalasignatura;
                                        $html[$pag] .= '<td>' . $finalasignatura . '</td>';
                                        $notamatriz[$r][] = $finalasignatura;
                                        $r++;
                                    } else {
                                        $promediototal[$i][] = $finalasignatura;
                                        $html[$pag] .= '<td>' . $finalasignatura . '</td>';
                                        $notamatriz[$r][] = $finalasignatura;
                                        $r++;
                                    }


                                }// fin promedio por notas

                            }

                        }// fin for


                    } else {
                        $html[$pag] .= '<td>-</td>';
                        $notamatriz[$r][] = 0;
                        $r++;


                    } //fin if row


                } //fin for Asignaturas


                if ($promediototal[$i] != '' || $promediototal[$i] != null) {

                    if ($datoscurso[0]['aproxFinal'] == 1) {//Aproxima
                        $promediototal[$i] = array_diff($promediototal[$i], array('0'));
                        $promediofinal = round(array_sum($promediototal[$i]) / count($promediototal[$i]));


                    } else {
                        $promediototal[$i] = array_diff($promediototal[$i], array('0'));
                        $promediofinal = intval(array_sum($promediototal[$i]) / count($promediototal[$i]));

                    }


                    $html[$pag] .= '<td>' . $promediofinal . '</td>';
                    $notamatriz[$r][] = $promediofinal;

                } else {
                    $html[$pag] .= '<td>-</td>';
                    $notamatriz[$r][] = 0;
                }

                $detallealumnoprimer = $modeldetalle->listardetalleperiodo($listaalumnos[$i]['idAlumnosActual'], 1, $idperiodo);
                $detallealumnosegundo = $modeldetalle->listardetalleperiodo($listaalumnos[$i]['idAlumnosActual'], 2, $idperiodo);

                $diasin = $detallealumnoprimer[0]['diasInasistencia'] + $detallealumnosegundo[0]['diasInasistencia'];
                $diastrabajados = $detallealumnoprimer[0]['diasTrabajado'] + $detallealumnosegundo[0]['diasTrabajado'];
                if ($diasin != 0 && $diastrabajados > 0) {
                    $valor = $diasin / $diastrabajados;
                    $aux = 1 - $valor;
                    $totald = $aux * 100;
                } elseif (($diasin == 0 || $diasin == '') && $diastrabajados > 0) {
                    $valor = $diasin / $diastrabajados;
                    $aux = 1 - $valor;
                    $totald = $aux * 100;
                } else {
                    $totald = 0;
                    $diastrabajados = "-";
                    $diasin = "-";
                }

                $html[$pag] .= '<td>' . $diastrabajados . '</td><td>' . $diasin . '</td><td>' . intval($totald) . '%</td>';


                $html[$pag] .= '</tr>';


            }

            $largoes = count($cuentapag2);

            //Estadistica de notas
            for ($i = 0; $i < count($cuentapag2); $i++) {
                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $largocuenta = $cuentapag2[$i - 1] + $cuentapag2[$i];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Promedio Generales</td>';
                } else {
                    $aux = 0;
                    $largocuenta = $cuentapag2[$i];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Promedio Generales</td>';
                }


                for ($y = $aux; $y < $largocuenta; $y++) {
                    $notamatrizset = array_diff($notamatriz[$y], array('0'));
                    if (array_sum($notamatrizset) != 0) {
                        $html[$i] .= '<td>' . round(array_sum($notamatrizset) / count($notamatrizset)) . '</td>';
                    } else {
                        $html[$i] .= '<td>-</td>';
                    }


                }
                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';


                //Minimos
                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Mínimo</td>';
                } else {
                    $aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Mínimo</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {

                    $valormin = array_sum($notamatriz[$y]);
                    if ($valormin != 0) {
                        $html[$i] .= '<td>' . min(array_diff($notamatriz[$y], array(0))) . '</td>';
                    } else {
                        $html[$i] .= '<td>-</td>';
                    }


                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';

                //Maximos
                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Máximo</td>';
                } else {
                    $aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Máximo</td>';
                }


                for ($y = $aux; $y < $largocuenta; $y++) {
                    $valormax = array_sum($notamatriz[$y]);
                    if ($valormax != 0) {
                        $html[$i] .= '<td>' . max(array_diff($notamatriz[$y], array(0))) . '</td>';
                    } else {
                        $html[$i] .= '<td>-</td>';
                    }
                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';

                //Adecuado

                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Adecuado</td>';
                } else {
                    $aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Adecuado</td>';
                }


                for ($y = $aux; $y < $largocuenta; $y++) {
                    $contadorinicial = 0;
                    $largomatriz = count($notamatriz[$y]);
                    for ($v = 0; $v < $largomatriz; $v++) {
                        if ($notamatriz[$y][$v] > 59 && $notamatriz[$y][$v] <= 70) {
                            $contadorinicial = $contadorinicial + 1;

                        }
                    }
                    $totaladecuado[$y] = $contadorinicial;

                    $html[$i] .= '<td>' . $contadorinicial . '</td>';

                }
                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';

                //Elemntal
                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Elemental</td>';
                } else {
                    $aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Elemental</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {
                    $contadorinicial = 0;
                    $largomatriz = count($notamatriz[$y]);
                    for ($v = 0; $v < $largomatriz; $v++) {
                        if ($notamatriz[$y][$v] > 39 && $notamatriz[$y][$v] < 60) {
                            $contadorinicial = $contadorinicial + 1;

                        }
                    }

                    $totalelemental[$y] = $contadorinicial;
                    $html[$i] .= '<td>' . $contadorinicial . '</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';


                //Insuficiente
                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Insuficiente</td>';
                } else {
                    $aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Insuficiente</td>';
                }


                for ($y = $aux; $y < $largocuenta; $y++) {
                    $contadorinicial = 0;
                    $largomatriz = count($notamatriz[$y]);
                    for ($v = 0; $v < $largomatriz; $v++) {
                        if ($notamatriz[$y][$v] > 10 && $notamatriz[$y][$v] < 40) {
                            $contadorinicial = $contadorinicial + 1;

                        }
                    }

                    $totalinsuficiente[$y] = $contadorinicial;

                    $html[$i] .= '<td>' . $contadorinicial . '</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';


                //Totales
                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Total</td>';
                } else {
                    $aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Total</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {
                    $total[$y] = ($totaladecuado[$y] + $totalelemental[$y] + $totalinsuficiente[$y]);

                    $html[$i] .= '<td>' . $total[$y] . '</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';


                //Porcentaje Adecuado

                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Adecuado</td>';
                } else {
                    $aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Adecuado</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {

                    if ($total[$y] > 0) {
                        $porcentaje = ($totaladecuado[$y] / $total[$y]) * 100;
                    } else {
                        $porcentaje = 0;
                    }

                    $html[$i] .= '<td>' . round($porcentaje) . '%</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';

                //Porcentaje Elemental
                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Elemental</td>';
                } else {
                    $aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Elemental</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {

                    if ($total[$y] > 0) {
                        $porcentaje = ($totalelemental[$y] / $total[$y]) * 100;
                    } else {
                        $porcentaje = 0;
                    }

                    $html[$i] .= '<td>' . round($porcentaje) . '%</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';

                //Porcentaje Suficiente

                if ($i > 0) {
                    $aux = $cuentapag2[$i - 1];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Insuficiente</td>';
                } else {
                    $aux = 0;
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Insuficiente</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {

                    if ($total[$y] > 0) {
                        $porcentaje = ($totalinsuficiente[$y] / $total[$y]) * 100;
                    } else {
                        $porcentaje = 0;
                    }

                    $html[$i] .= '<td>' . round($porcentaje) . '%</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';


            }//Fin ciclo Paginas


        }


        if ($html != '') {

            require 'fpdf/html2pdf.class.php';
            try {
                $width_in_mm = 216;
                $height_in_mm = 330;
                $pdf = new HTML2PDF('L', array($width_in_mm, $height_in_mm), 'es', true, 'UTF-8', array(0, 0, 0, 0) /*márgenes*/); //los márgenes también pueden definirse en <page> ver documentación
                $pdf->pdf->SetDisplayMode('fullpage');
                for ($i = 0; $i < count($html); $i++) {

                    $pdf->WriteHTML('<page><html>
                        <head>
                            <style>' . $style . '</style>
                        </head>
                        <body>' . $html[$i] . '</table></body></html></page>');
                }

                if (preg_match("/MSIE/i", $_SERVER["HTTP_USER_AGENT"])) {
                    header("Content-type: application/PDF");
                } else {
                    header("Content-type: application/PDF");
                    header("Content-Type: application/pdf");
                }

                $pdf->Output('Planificacion.pdf', I);
            } catch (HTML2PDF_exception $e) {
                //echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, intente nuevamente\");</script>";
                //echo "<script>parent.$.fancybox.close();</script>";
                echo $e;
            }
        }


    }

    public function informenotascursopromediotAction()
    {

        $this->_helper->viewRenderer->setNeverRender(true);
        $this->_helper->ViewRenderer->setNoRender(true);
        $this->_helper->Layout->disableLayout();

        $cargo = new Zend_Session_Namespace('cargo');
        $rol = $cargo->cargo;

        $paso = $this->_getParam('p', 0);
        $agregadecimas = false;


        $seg = $this->_getParam('s', 0);


        $periodo = new Zend_Session_Namespace('periodo');
        $idperiodo = $periodo->periodo;

        $modelcurso = new Application_Model_DbTable_Cursos();
        $modelnotas = new Application_Model_DbTable_Notas();
        $modelasignatura = new Application_Model_DbTable_Asignaturascursos();
        $modeldetalle = new Application_Model_DbTable_AlumnosDetalle();


        //fecha actual

        $date = new DateTime;
        $fechain = $date->format('Y-m-d');
        $cortado = explode("-", $fechain);
        $dias = array("Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado");
        $meses = array("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre");

        $fecha_final = $dias[date('w', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]))] . " " . $cortado[2] . " de " . $meses[date('n', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0])) - 1] . " del " . date('Y', mktime(0, 0, 0, $cortado[1], $cortado[2], $cortado[0]));


        $usuario = new Zend_Session_Namespace('id');
        $user = $usuario->id;
        $idcursoaux = $this->_getParam('id', 0);

        //Validamos si el curso pertece a la jefatura del usuario
        $auxiliar = $modelcurso->listarcursoiddocenteactuals($user, $idperiodo, 1, $idcursoaux);

        if ($auxiliar && ($auxiliar[0]['idCursos'] == $idcursoaux) || $rol != 2) {
            //Asignaturas que pertencen a un curso de jefatura del usuario
            $id = $this->_getParam('id', 0);
            $listaalumnos = $modelnotas->listaralumnoscurso($id, $idperiodo);
            $listanotas = $modelnotas->listarnotascursoperiodo($id, $idperiodo, array('1'));
            $datosasignaturas = $modelasignatura->listarporcurso($id, 1, array('1', '3'), $idperiodo);

            //Datos Asignatura Combinadas
            $datosasignaturascombinada = $modelasignatura->getcombinada($id, $idperiodo);
            $largoalumnos = count($listaalumnos);
            $largocombinada = count($datosasignaturascombinada);
            $m = 0;


            //Talleres para Alumnos Separados Primer Semestre
            $datostallersem = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(3));
            $datostallersemseg = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(4));
            $datostallersemter = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(5));
            $datostalleranual = $modelasignatura->gettalleranual($id, $idperiodo, array(1), 1);
            $datostaller = array_merge($datostallersem, $datostallersemseg, $datostallersemter, $datostalleranual);
            $largotaller = count($datostaller);

            $modelotallerdetalle = new Application_Model_DbTable_Asignaturascursos();
            //Obtiene los Talleres que son Semestrales Tiempo=2.
            $datostalleres = $modelasignatura->gettaller($id, $idperiodo, array(2), 2, array(3, 4, 5));

            $datoscurso = $modelcurso->listarcursoid($id, $idperiodo);
            //Configuracion de agregar 2 decimas a curso desde 5 a 4to medio cuando el promedio final de asignatura es mayor o igual a 6
            if (($datoscurso[0]['rbd'] == 1863) && (($datoscurso[0]['idCodigo'] == 110 && $datoscurso[0]['idGrado'] > 4) || $datoscurso[0]['idCodigo'] == 310 || $datoscurso[0]['idCodigo'] == 363 || $datoscurso[0]['idCodigo'] == 410 || $datoscurso[0]['idCodigo'] == 510 || $datoscurso[0]['idCodigo'] == 610 || $datoscurso[0]['idCodigo'] == 165)) {
                $agregadecimas = true;
            }
        } else {
            //Asignaturas que pertencen a un curso que no es jefatura
            $cursomodel = new Application_Model_DbTable_Detallecursocuenta();
            $id = $this->_getParam('ids', 0);
            $ids = $this->_getParam('id', 0);

            $datosasignaturas = $modelcurso->getasignaturashorario($id, $idperiodo, $user);

            $listaalumnos = $modelnotas->listaralumnoscurso($id, $idperiodo);
            $listanotas = $modelnotas->listarnotascursoperiodo($id, $idperiodo, array('1'));

            //Datos Asignatura Combinadas
            $datosasignaturascombinada = $modelasignatura->getcombinada($id, $idperiodo);
            $largoalumnos = count($listaalumnos);
            $largocombinada = count($datosasignaturascombinada);
            $m = 0;


            //Talleres para Alumnos Separados Primer Semestre
            $datostallersem = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(3));
            $datostallersemseg = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(4));
            $datostallersemter = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(5));
            $datostalleranual = $modelasignatura->gettalleranual($id, $idperiodo, array(1), 1);
            $datostaller = array_merge($datostallersem, $datostallersemseg, $datostallersemter, $datostalleranual);
            $largotaller = count($datostaller);

            $modelotallerdetalle = new Application_Model_DbTable_Asignaturascursos();
            //Obtiene los Talleres que son Semestrales Tiempo=2.
            $datostalleres = $modelasignatura->gettaller($id, $idperiodo, array(2), 2, array(3, 4, 5));

            $datoscurso = $modelcurso->listarcursoid($id, $idperiodo);
            //Configuracion de agregar 2 decimas a curso desde 5 a 4to medio cuando el promedio final de asignatura es mayor o igual a 6
            if (($datoscurso[0]['rbd'] == 1863) && (($datoscurso[0]['idCodigo'] == 110 && $datoscurso[0]['idGrado'] > 4) || $datoscurso[0]['idCodigo'] == 310 || $datoscurso[0]['idCodigo'] == 363 || $datoscurso[0]['idCodigo'] == 410 || $datoscurso[0]['idCodigo'] == 510 || $datoscurso[0]['idCodigo'] == 610 || $datoscurso[0]['idCodigo'] == 165)) {
                $agregadecimas = true;
            }
        }


        //Configuracion de Taller Buscamos si existen configuraciones por alumnos


        $promediotalleralumnos = array();
        $promediotalleralumnoss = array();
        $promediotalleralumnost = array();
        if ($datostalleres) {
            for ($j = 0; $j < $largoalumnos; $j++) {
                for ($i = 0; $i < count($datostalleres); $i++) {
                    $detalletaller = $modelotallerdetalle->gettallersegmento($datostalleres[$i]['idConfiguracionTaller'], 3, $listaalumnos[$j]['idAlumnos']);
                    $detalletallers = $modelotallerdetalle->gettallersegmento($datostalleres[$i]['idConfiguracionTaller'], 4, $listaalumnos[$j]['idAlumnos']);
                    $detalletallert = $modelotallerdetalle->gettallersegmento($datostalleres[$i]['idConfiguracionTaller'], 5, $listaalumnos[$j]['idAlumnos']);


                    //Primer Trimestre
                    if ($datostalleres[$i]['tiempoOpcion'] == 3) {
                        if ($detalletaller) {
                            $datosalumnostaller = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 3, $id, $detalletaller[0]['idAsignatura']);

                            if ($datosalumnostaller) {
                                for ($k = 0; $k < count($datosalumnostaller); $k++) {

                                    if ($datostalleres[$i]['idAsignatura'] == $datosalumnostaller[$k]['idAsignatura']) {
                                        if ($datosalumnostaller[$k]['coef'] == 2) {
                                            if ($datosalumnostaller[$k]['nota'] > 0) {
                                                $promediotalleralumnos[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                                $promediotalleralumnos[$j][$i][] = $datosalumnostaller[$k]['nota'];

                                            } else {
                                                $promediotalleralumnos[$j][$i][] = 0;
                                                $promediotalleralumnos[$j][$i][] = 0;
                                            }

                                        } else {
                                            if ($datosalumnostaller[$k]['nota'] > 0) {
                                                $promediotalleralumnos[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                            } else {
                                                $promediotalleralumnos[$j][$i][] = 0;
                                            }

                                        }


                                    }


                                }
                            }
                            if (!empty($promediotalleralumnos[$j][$i])) {
                                $promsetalumnos = array_diff($promediotalleralumnos[$j][$i], array('0'));
                            } else {
                                $promsetalumnos = 0;
                            }

                            if (is_array($promsetalumnos)) {
                                if (count($promsetalumnos) > 0) {

                                    if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                        $promtalleralumnos[$j][$i]['nota'] = round(array_sum($promsetalumnos) / count($promsetalumnos));

                                    } else {
                                        $promtalleralumnos[$j][$i]['nota'] = intval(array_sum($promsetalumnos) / count($promsetalumnos));
                                    }
                                } else {
                                    $promtalleralumnos[$j][$i]['nota'] = 0;
                                }
                            } else {
                                $promtalleralumnos[$j][$i]['nota'] = 0;
                            }


                            $promtalleralumnos[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                            $promtalleralumnos[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                            $promtalleralumnos[$j][$i]['coef'] = 1;
                            $promtalleralumnos[$j][$i]['tiempo'] = 3;
                            $promtalleralumnos[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                            $promtalleralumnos[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];

                        } else {
                            $promtalleralumnoss[$j][$i]['nota'] = 0;
                            $promtalleralumnos[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                            $promtalleralumnos[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                            $promtalleralumnos[$j][$i]['coef'] = 1;
                            $promtalleralumnos[$j][$i]['tiempo'] = 3;
                            $promtalleralumnos[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                            $promtalleralumnos[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];
                        }
                    } else {
                        $promtalleralumnos[$j][$i] = array();
                    }

                    //Segundo Trimestre
                    if ($datostalleres[$i]['tiempoOpcion'] == 4) {
                        if ($detalletallers) {
                            $datosalumnostallers = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 2, $id, $detalletallers[0]['idAsignatura']);

                            if ($datosalumnostallers) {
                                for ($k = 0; $k < count($datosalumnostallers); $k++) {

                                    if ($datostalleres[$i]['idAsignatura'] == $datosalumnostallers[$k]['idAsignatura']) {

                                        if ($datosalumnostallers[$k]['coef'] == 2) {
                                            if ($datosalumnostallers[$k]['nota'] > 0) {
                                                $promediotalleralumnoss[$j][$i][] = $datosalumnostallers[$k]['nota'];
                                                $promediotalleralumnoss[$j][$i][] = $datosalumnostallers[$k]['nota'];

                                            } else {
                                                $promediotalleralumnoss[$j][$i][] = 0;
                                                $promediotalleralumnoss[$j][$i][] = 0;
                                            }

                                        } else {
                                            if ($datosalumnostallers[$k]['nota'] > 0) {
                                                $promediotalleralumnoss[$j][$i][] = $datosalumnostallers[$k]['nota'];
                                            } else {
                                                $promediotalleralumnoss[$j][$i][] = 0;
                                            }

                                        }


                                    }


                                }
                            }
                            if (!empty($promediotalleralumnoss[$j][$i])) {
                                $promsetalumnoss = array_diff($promediotalleralumnoss[$j][$i], array('0'));
                            } else {
                                $promsetalumnoss = 0;
                            }

                            if (is_array($promsetalumnoss)) {
                                if (count($promsetalumnoss) > 0) {

                                    if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                        $promtalleralumnoss[$j][$i]['nota'] = round(array_sum($promsetalumnoss) / count($promsetalumnoss));
                                        $promtalleralumnoss[$j][$i]['nota'] = intval($promtalleralumnoss[$j][$i]['nota']);

                                    } else {
                                        $promtalleralumnoss[$j][$i]['nota'] = intval(array_sum($promsetalumnoss) / count($promsetalumnoss));
                                    }
                                } else {
                                    $promtalleralumnoss[$j][$i]['nota'] = 0;
                                }
                            } else {
                                $promtalleralumnoss[$j][$i]['nota'] = 0;
                            }


                            $promtalleralumnoss[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                            $promtalleralumnoss[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                            $promtalleralumnoss[$j][$i]['coef'] = 1;
                            $promtalleralumnoss[$j][$i]['tiempo'] = 4;
                            $promtalleralumnoss[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                            $promtalleralumnoss[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];

                        } else {
                            $promtalleralumnoss[$j][$i]['nota'] = 0;
                            $promtalleralumnoss[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                            $promtalleralumnoss[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                            $promtalleralumnoss[$j][$i]['coef'] = 1;
                            $promtalleralumnoss[$j][$i]['tiempo'] = 4;
                            $promtalleralumnoss[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                            $promtalleralumnoss[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];
                        }
                    } else {
                        $promtalleralumnoss[$j][$i] = array();
                    }

                    //Tercer Tremestre
                    if ($datostalleres[$i]['tiempoOpcion'] == 5) {
                        if ($detalletallert) {
                            $datosalumnostallert = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 5, $id, $detalletallert[0]['idAsignatura']);

                            if ($datosalumnostallert) {
                                for ($k = 0; $k < count($datosalumnostallert); $k++) {

                                    if ($datostalleres[$i]['idAsignatura'] == $datosalumnostallert[$k]['idAsignatura']) {

                                        if ($datosalumnostallert[$k]['coef'] == 2) {
                                            if ($datosalumnostallert[$k]['nota'] > 0) {
                                                $promediotalleralumnost[$j][$i][] = $datosalumnostallert[$k]['nota'];
                                                $promediotalleralumnost[$j][$i][] = $datosalumnostallert[$k]['nota'];

                                            } else {
                                                $promediotalleralumnost[$j][$i][] = 0;
                                                $promediotalleralumnost[$j][$i][] = 0;
                                            }

                                        } else {
                                            if ($datosalumnostallert[$k]['nota'] > 0) {
                                                $promediotalleralumnost[$j][$i][] = $datosalumnostallert[$k]['nota'];
                                            } else {
                                                $promediotalleralumnost[$j][$i][] = 0;
                                            }

                                        }


                                    }


                                }
                            }
                            if (!empty($promediotalleralumnost[$j][$i])) {
                                $promsetalumnost = array_diff($promediotalleralumnost[$j][$i], array('0'));
                            } else {
                                $promsetalumnost = 0;
                            }

                            if (is_array($promsetalumnost)) {
                                if (count($promsetalumnost) > 0) {

                                    if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                        $promtalleralumnost[$j][$i]['nota'] = round(array_sum($promsetalumnost) / count($promsetalumnost));
                                        $promtalleralumnost[$j][$i]['nota'] = intval($promtalleralumnost[$j][$i]['nota']);

                                    } else {
                                        $promtalleralumnost[$j][$i]['nota'] = intval(array_sum($promsetalumnost) / count($promsetalumnost));
                                    }
                                } else {
                                    $promtalleralumnost[$j][$i]['nota'] = 0;
                                }
                            } else {
                                $promtalleralumnost[$j][$i]['nota'] = 0;
                            }


                            $promtalleralumnost[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                            $promtalleralumnost[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                            $promtalleralumnost[$j][$i]['coef'] = 1;
                            $promtalleralumnost[$j][$i]['tiempo'] = 5;
                            $promtalleralumnost[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                            $promtalleralumnost[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];

                        } else {
                            $promtalleralumnost[$j][$i]['nota'] = 0;
                            $promtalleralumnost[$j][$i]['idAlumnos'] = $listaalumnos[$j]['idAlumnos'];
                            $promtalleralumnost[$j][$i]['idAsignatura'] = $datostalleres[$i]['idAsignaturaTaller'];
                            $promtalleralumnost[$j][$i]['coef'] = 1;
                            $promtalleralumnost[$j][$i]['tiempo'] = 5;
                            $promtalleralumnost[$j][$i]['forma'] = $datostalleres[$i]['forma'];
                            $promtalleralumnost[$j][$i]['porcentaje'] = $datostalleres[$i]['porcentaje'];
                        }
                    } else {
                        $promtalleralumnost[$j][$i] = array();
                    }


                }//Fin if talleres


                for ($l = 0; $l < count($promtalleralumnos[$j]); $l++) {
                    if (!empty($promtalleralumnos[$j][$l]["idAsignatura"])) {
                        $datosdestino = $modelotallerdetalle->getdestino($promtalleralumnos[$j][$l]["idAsignatura"]);
                        if ($datosdestino[0]['tipoAsignatura'] != 4) {
                            $listapromediostaller[$j][] = $promtalleralumnos[$j][$l];
                        } else {
                            $listapromediostallercom[$j][$promtalleralumnos[$j][$l]['idAsignatura']] = $promtalleralumnos[$j][$l];

                        }
                    }

                }


                for ($l = 0; $l < count($promtalleralumnoss[$j]); $l++) {
                    if (!empty($promtalleralumnoss[$j][$l]["idAsignatura"])) {
                        $datosdestino = $modelotallerdetalle->getdestino($promtalleralumnoss[$j][$l]["idAsignatura"]);
                        if ($datosdestino[0]['tipoAsignatura'] != 4) {
                            $listapromediostallers[$j][] = $promtalleralumnoss[$j][$l];
                        } else {
                            $listapromediostallercoms[$j][$promtalleralumnoss[$j][$l]['idAsignatura']] = $promtalleralumnoss[$j][$l];

                        }
                    }

                }

                for ($l = 0; $l < count($promtalleralumnost[$j]); $l++) {
                    if (!empty($promtalleralumnost[$j][$l]["idAsignatura"])) {
                        $datosdestino = $modelotallerdetalle->getdestino($promtalleralumnost[$j][$l]["idAsignatura"]);
                        if ($datosdestino[0]['tipoAsignatura'] != 4) {
                            $listapromediostallert[$j][] = $promtalleralumnost[$j][$l];
                        } else {
                            $listapromediostallercomt[$j][$promtalleralumnost[$j][$l]['idAsignatura']] = $promtalleralumnost[$j][$l];

                        }
                    }

                }


            }//Fin for Alumnos


        }


        //Fin Talleres

        //Asignaturas Combinadas


        $datosasignaturascombinada = $modelasignatura->getcombinada($id, $idperiodo);


        $largoalumnos = count($listaalumnos);
        $largotaller = count($datostaller);
        $largocombinada = count($datosasignaturascombinada);
        $m = 0;

        if ($largocombinada > 0) {
            $m = 0;
            for ($i = 0; $i < $largocombinada; $i++) {
                $listaasignatura[$i] = unserialize($datosasignaturascombinada[$i]['asignaturas']);

                for ($h = 0; $h < count($listaasignatura[$i]); $h++) {
                    $datocombinada = $modelasignatura->getnombre($listaasignatura[$i][$h]);

                    $validacom[$i][$m] = $datosasignaturascombinada[$i]['idAsignatura'];
                    $m++;
                    $validacom[$i][$m] = $datosasignaturascombinada[$i]['idAsignatura'];
                    for ($j = 0; $j < $largoalumnos; $j++) {
                        $datosalumnoscom = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 3, $id, $datocombinada[0]['idAsignatura']);
                        $datosalumnoscoms = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 4, $id, $datocombinada[0]['idAsignatura']);
                        $datosalumnoscomt = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 5, $id, $datocombinada[0]['idAsignatura']);
                        //Primer Trimestre
                        if ($listapromediostallercom) {
                            if ($datocombinada[0]['idAsignatura'] == $listapromediostallercom[$j][$datocombinada[0]['idAsignatura']]['idAsignatura']) {
                                $datosalumnoscom[] = $listapromediostallercom[$j][$datocombinada[0]['idAsignatura']];
                            }

                        }
                        //Segundo Trimestre
                        if ($listapromediostallercoms) {
                            if ($datocombinada[0]['idAsignatura'] == $listapromediostallercoms[$j][$datocombinada[0]['idAsignatura']]['idAsignatura']) {
                                $datosalumnoscoms[] = $listapromediostallercoms[$j][$datocombinada[0]['idAsignatura']];
                            }

                        }

                        //Tercer Trimestre
                        if ($listapromediostallercomt) {
                            if ($datocombinada[0]['idAsignatura'] == $listapromediostallercomt[$j][$datocombinada[0]['idAsignatura']]['idAsignatura']) {
                                $datosalumnoscomt[] = $listapromediostallercomt[$j][$datocombinada[0]['idAsignatura']];
                            }

                        }


                        for ($k = 0; $k < count($datosalumnoscom); $k++) {
                            if ($datocombinada[0]['idAsignatura'] == $datosalumnoscom[$k]['idAsignatura']) {
                                if ($datosalumnoscom[$k]['coef'] == 2) {
                                    if ($datosalumnoscom[$k]['nota'] > 0) {
                                        $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];
                                        $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];

                                    } else {
                                        $promediocom[$j][$m][] = 0;
                                        $promediocom[$j][$m][] = 0;
                                    }

                                } else {

                                    if ($datosalumnoscom[$k]['nota'] == 0 || empty($datosalumnoscom[$k]['nota']) || $datosalumnoscom[$k]['nota'] == NULL || $datosalumnoscom[$k]['nota'] == '') {
                                        if (!empty($datosalumnoscom[$k]["forma"])) {
                                            if ($datosalumnoscom[$k]['nota'] == 0) {
                                                $promediocom[$j][$m][] = 0;
                                            }

                                        } else {
                                            $promediocom[$j][$m][] = 0;
                                        }


                                    } else {
                                        if (!empty($datosalumnoscom[$k]["forma"]) && $datosalumnoscom[$k]["forma"] == 2) {
                                            $promtalleraux = $datosalumnoscom[$k]['nota'];
                                            $porcentajetaller = $datosalumnoscom[$k]["porcentaje"];


                                        } elseif (!empty($datosalumnoscom[$k]["forma"]) && $datosalumnoscom[$k]["forma"] == 1) {
                                            $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];
                                            $promtalleraux = array();
                                            $porcentajetaller = array();
                                        } else {
                                            $promediocom[$j][$m][] = $datosalumnoscom[$k]['nota'];
                                            $promtalleraux = array();
                                            $porcentajetaller = array();
                                        }


                                    }

                                }//fin else


                            }

                        }


                        for ($k = 0; $k < count($datosalumnoscoms); $k++) {
                            if ($datocombinada[0]['idAsignatura'] == $datosalumnoscoms[$k]['idAsignatura']) {
                                if ($datosalumnoscoms[$k]['coef'] == 2) {
                                    if ($datosalumnoscoms[$k]['nota'] > 0) {
                                        $promediocoms[$j][$m][] = $datosalumnoscoms[$k]['nota'];
                                        $promediocoms[$j][$m][] = $datosalumnoscoms[$k]['nota'];

                                    } else {
                                        $promediocoms[$j][$m][] = 0;
                                        $promediocoms[$j][$m][] = 0;
                                    }

                                } else {

                                    if ($datosalumnoscoms[$k]['nota'] == 0 || empty($datosalumnoscoms[$k]['nota']) || $datosalumnoscoms[$k]['nota'] == NULL || $datosalumnoscoms[$k]['nota'] == '') {
                                        if (!empty($datosalumnoscoms[$k]["forma"])) {
                                            if ($datosalumnoscoms[$k]['nota'] == 0) {
                                                $promediocoms[$j][$m][] = 0;
                                            }

                                        } else {
                                            $promediocoms[$j][$m][] = 0;
                                        }


                                    } else {
                                        if (!empty($datosalumnoscoms[$k]["forma"]) && $datosalumnoscoms[$k]["forma"] == 2) {
                                            $promtallerauxs = $datosalumnoscoms[$k]['nota'];
                                            $porcentajetallers = $datosalumnoscoms[$k]["porcentaje"];


                                        } elseif (!empty($datosalumnoscoms[$k]["forma"]) && $datosalumnoscoms[$k]["forma"] == 1) {
                                            $promediocoms[$j][$m][] = $datosalumnoscoms[$k]['nota'];
                                            $promtallerauxs = array();
                                            $porcentajetallers = array();
                                        } else {
                                            $promediocoms[$j][$m][] = $datosalumnoscoms[$k]['nota'];
                                            $promtallerauxs = array();
                                            $porcentajetallers = array();
                                        }


                                    }

                                }//fin else


                            }

                        }

                        for ($k = 0; $k < count($datosalumnoscomt); $k++) {
                            if ($datocombinada[0]['idAsignatura'] == $datosalumnoscomt[$k]['idAsignatura']) {
                                if ($datosalumnoscomt[$k]['coef'] == 2) {
                                    if ($datosalumnoscomt[$k]['nota'] > 0) {
                                        $promediocomt[$j][$m][] = $datosalumnoscomt[$k]['nota'];
                                        $promediocomt[$j][$m][] = $datosalumnoscomt[$k]['nota'];

                                    } else {
                                        $promediocomt[$j][$m][] = 0;
                                        $promediocomt[$j][$m][] = 0;
                                    }

                                } else {

                                    if ($datosalumnoscomt[$k]['nota'] == 0 || empty($datosalumnoscomt[$k]['nota']) || $datosalumnoscomt[$k]['nota'] == NULL || $datosalumnoscomt[$k]['nota'] == '') {
                                        if (!empty($datosalumnoscomt[$k]["forma"])) {
                                            if ($datosalumnoscomt[$k]['nota'] == 0) {
                                                $promediocomt[$j][$m][] = 0;
                                            }

                                        } else {
                                            $promediocomt[$j][$m][] = 0;
                                        }


                                    } else {
                                        if (!empty($datosalumnoscomt[$k]["forma"]) && $datosalumnoscomt[$k]["forma"] == 2) {
                                            $promtallerauxt = $datosalumnoscomt[$k]['nota'];
                                            $porcentajetallert = $datosalumnoscomt[$k]["porcentaje"];


                                        } elseif (!empty($datosalumnoscomt[$k]["forma"]) && $datosalumnoscomt[$k]["forma"] == 1) {
                                            $promediocomt[$j][$m][] = $datosalumnoscomt[$k]['nota'];
                                            $promtallerauxt = array();
                                            $porcentajetallert = array();
                                        } else {
                                            $promediocomt[$j][$m][] = $datosalumnoscomt[$k]['nota'];
                                            $promtallerauxt = array();
                                            $porcentajetallert = array();
                                        }


                                    }

                                }//fin else


                            }

                        }

                        //Primer Trimestre Promedio
                        if (!empty($promediocom[$j][$m])) {
                            $promset = array_diff($promediocom[$j][$m], array('0'));
                        } else {
                            $promset = 0;
                        }

                        if (is_array($promset)) {
                            if (count($promset) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    if ($porcentajetaller) {
                                        $totalporcentaje = 100;
                                        $porcentajeasig = $totalporcentaje - $porcentajetaller;
                                        $promedioauxalum = array_sum($promset) / count($promset);
                                        $promcom[$j][$m]['nota'] = round(($promedioauxalum * ($porcentajeasig / 100)) + ($promtalleraux * ($porcentajetaller / 100)));

                                    } else {
                                        $promcom[$j][$m]['nota'] = round(array_sum($promset) / count($promset));
                                    }

                                } else {
                                    if ($porcentajetaller) {
                                        $totalporcentaje = 100;
                                        $porcentajeasig = $totalporcentaje - $porcentajetaller;
                                        $promedioauxalum = array_sum($promset) / count($promset);
                                        $promcom[$j][$m]['nota'] = round(($promedioauxalum * ($porcentajeasig / 100)) + ($promtalleraux * ($porcentajetaller / 100)));


                                    } else {
                                        $promcom[$j][$m]['nota'] = intval(array_sum($promset) / count($promset));
                                    }
                                }
                            } else {
                                $promcom[$j][$m]['nota'] = 0;
                            }

                        } else {

                            $promcom[$j][$m]['nota'] = 0;
                        }
                        $promcom[$j][$m]['idAsignatura'] = $datosasignaturascombinada[$i]['idAsignatura'];
                        $promcom[$j][$m]['coef'] = 1;
                        $promcom[$j][$m]['tiempo'] = 3;

                        //Segundo Trimestre
                        if (!empty($promediocoms[$j][$m])) {
                            $promsets = array_diff($promediocoms[$j][$m], array('0'));
                        } else {
                            $promsets = 0;
                        }


                        if (is_array($promsets)) {
                            if (count($promsets) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    if ($porcentajetallers) {
                                        $totalporcentajes = 100;
                                        $porcentajeasigs = $totalporcentajes - $porcentajetallers;
                                        $promedioauxalums = array_sum($promsets) / count($promsets);
                                        $promcoms[$j][$m]['nota'] = round(($promedioauxalums * ($porcentajeasigs / 100)) + ($promtallerauxs * ($porcentajetallers / 100)));


                                    } else {
                                        $promcoms[$j][$m]['nota'] = round(array_sum($promsets) / count($promsets));

                                    }

                                } else {
                                    if ($porcentajetallers) {
                                        $totalporcentajes = 100;
                                        $porcentajeasigs = $totalporcentajes - $porcentajetallers;
                                        $promedioauxalums = array_sum($promsets) / count($promsets);
                                        $promcoms[$j][$m]['nota'] = round(($promedioauxalums * ($porcentajeasigs / 100)) + ($promtallerauxs * ($porcentajetallers / 100)));


                                    } else {
                                        $promcoms[$j][$m]['nota'] = intval(array_sum($promsets) / count($promsets));

                                    }
                                }
                            } else {
                                $promcoms[$j][$m]['nota'] = 0;
                            }

                        } else {


                            $promcoms[$j][$m]['nota'] = 0;
                        }
                        $promcoms[$j][$m]['idAsignatura'] = $datosasignaturascombinada[$i]['idAsignatura'];
                        $promcoms[$j][$m]['coef'] = 1;
                        $promcoms[$j][$m]['tiempo'] = 4;


                        //Tercer Semestre
                        if (!empty($promediocom[$j][$m])) {
                            $promsett = array_diff($promediocomt[$j][$m], array('0'));
                        } else {
                            $promsett = 0;
                        }


                        if (is_array($promsett)) {
                            if (count($promsett) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    if ($porcentajetallert) {
                                        $totalporcentajet = 100;
                                        $porcentajeasigt = $totalporcentajet - $porcentajetallert;
                                        $promedioauxalumt = array_sum($promsett) / count($promsett);
                                        $promcomt[$j][$m]['nota'] = round(($promedioauxalumt * ($porcentajeasigt / 100)) + ($promtallerauxt * ($porcentajetallert / 100)));


                                    } else {
                                        $promcomt[$j][$m]['nota'] = round(array_sum($promsett) / count($promsett));

                                    }

                                } else {
                                    if ($porcentajetallert) {
                                        $totalporcentajet = 100;
                                        $porcentajeasigt = $totalporcentajet - $porcentajetallert;
                                        $promedioauxalumt = array_sum($promsett) / count($promsett);
                                        $promcomt[$j][$m]['nota'] = round(($promedioauxalumt * ($porcentajeasigt / 100)) + ($promtallerauxt * ($porcentajetallert / 100)));


                                    } else {
                                        $promcomt[$j][$m]['nota'] = intval(array_sum($promsett) / count($promsett));

                                    }
                                }
                            } else {
                                $promcomt[$j][$m]['nota'] = 0;
                            }

                        } else {


                            $promcomt[$j][$m]['nota'] = 0;
                        }
                        $promcomt[$j][$m]['idAsignatura'] = $datosasignaturascombinada[$i]['idAsignatura'];
                        $promcomt[$j][$m]['coef'] = 1;
                        $promcomt[$j][$m]['tiempo'] = 5;


                    }
                    $m++;
                }

            }
        }


        //Taller Por Segmento Curso Completo
        $datostallersem = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(3));
        $datostallersemseg = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(4));
        $datostallersemter = $modelasignatura->gettaller($id, $idperiodo, array(1, 2), 1, array(5));
        $largotallerprimero = count($datostallersem);
        $largotallersegundo = count($datostallersemseg);
        $largotallertercero = count($datostallersemter);


        $promediotaller = array();
        if ($largotallerprimero > 0) {

            for ($i = 0; $i < $largotallerprimero; $i++) {
                if (!empty($datostallersem[$i]['idConfiguracionTaller'])) {
                    $validataller[$i] = $datostallersem[$i]['idAsignaturaTaller'];
                    for ($j = 0; $j < $largoalumnos; $j++) {
                        $promediofinal = 0;
                        $datosalumnostaller = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 3, $id, $datostallersem[$i]['idAsignatura']);


                        for ($k = 0; $k < count($datosalumnostaller); $k++) {
                            if ($datostaller[$i]['idAsignatura'] == $datosalumnostaller[$k]['idAsignatura']) {
                                if ($datosalumnostaller[$k]['coef'] == 2) {
                                    if ($datosalumnostaller[$k]['nota'] > 0) {
                                        $promediotaller[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                        $promediotaller[$j][$i][] = $datosalumnostaller[$k]['nota'];

                                    } else {
                                        $promediotaller[$j][$i][] = 0;
                                        $promediotaller[$j][$i][] = 0;
                                    }

                                } else {
                                    if ($datosalumnostaller[$k]['nota'] > 0) {
                                        $promediotaller[$j][$i][] = $datosalumnostaller[$k]['nota'];
                                    } else {
                                        $promediotaller[$j][$i][] = 0;
                                    }

                                }


                            }

                        }


                        //Primer Semestre
                        if (!empty($promediotaller[$j][$i])) {
                            $promset = array_diff($promediotaller[$j][$i], array('0'));
                        } else {
                            $promset = 0;
                        }

                        if (is_array($promset)) {
                            if (count($promset) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    $promtaller[$j][$i]['nota'] = round(array_sum($promset) / count($promset));

                                } else {
                                    $promtaller[$j][$i]['nota'] = intval(array_sum($promset) / count($promset));
                                }
                            } else {
                                $promtaller[$j][$i]['nota'] = 0;
                            }

                        } else {
                            $promtaller[$j][$i]['nota'] = 0;
                        }


                        $promtaller[$j][$i]['idAsignatura'] = $datostallersem[$i]['idAsignaturaTaller'];
                        $promtaller[$j][$i]['coef'] = 1;
                        $promtaller[$j][$i]['tiempo'] = 3;
                        $promtaller[$j][$i]['forma'] = $datostallersem[$i]['forma'];
                        $promtaller[$j][$i]['porcentaje'] = $datostallersem[$i]['porcentaje'];


                    }

                }


            }
        }

        //Segundo Trimestre
        if ($largotallersegundo > 0) {

            for ($i = 0; $i < $largotallersegundo; $i++) {
                if (!empty($datostallersemseg[$i]['idConfiguracionTaller'])) {
                    $validatallers[$i] = $datostallersemseg[$i]['idAsignaturaTaller'];
                    for ($j = 0; $j < $largoalumnos; $j++) {
                        $promediofinal = 0;
                        $datosalumnostallers = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 4, $id, $datostallersemseg[$i]['idAsignatura']);

                        for ($k = 0; $k < count($datosalumnostallers); $k++) {
                            if ($datostallersemseg[$i]['idAsignatura'] == $datosalumnostallers[$k]['idAsignatura']) {
                                if ($datosalumnostallers[$k]['coef'] == 2) {
                                    if ($datosalumnostallers[$k]['nota'] > 0) {
                                        $promediotallers[$j][$i][] = $datosalumnostallers[$k]['nota'];
                                        $promediotallers[$j][$i][] = $datosalumnostallers[$k]['nota'];

                                    } else {
                                        $promediotallers[$j][$i][] = 0;
                                        $promediotallers[$j][$i][] = 0;
                                    }

                                } else {
                                    if ($datosalumnostallers[$k]['nota'] > 0) {
                                        $promediotallers[$j][$i][] = $datosalumnostallers[$k]['nota'];
                                    } else {
                                        $promediotallers[$j][$i][] = 0;
                                    }

                                }


                            }


                        }
                        if (!empty($promediotallers[$j][$i])) {
                            $promsets = array_diff($promediotallers[$j][$i], array('0'));
                        } else {
                            $promsets = 0;
                        }

                        if (is_array($promsets)) {
                            if (count($promsets) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    $auxtallers = round(array_sum($promsets) / count($promsets));
                                    $promtallers[$j][$i]['nota'] = intval($auxtallers);

                                } else {
                                    $promtallers[$j][$i]['nota'] = intval(array_sum($promsets) / count($promsets));
                                }
                            } else {
                                $promtallers[$j][$i]['nota'] = 0;
                            }

                        } else {
                            $promtallers[$j][$i]['nota'] = 0;
                        }


                        $promtallers[$j][$i]['idAsignatura'] = $datostallersemseg[$i]['idAsignaturaTaller'];
                        $promtallers[$j][$i]['coef'] = 1;
                        $promtallers[$j][$i]['tiempo'] = 4;
                        $promtallers[$j][$i]['forma'] = $datostallersemseg[$i]['forma'];
                        $promtallers[$j][$i]['porcentaje'] = $datostallersemseg[$i]['porcentaje'];


                    }

                }


            }
        }

        //Tercer Trimestre
        if ($largotallertercero > 0) {

            for ($i = 0; $i < $largotallertercero; $i++) {
                if (!empty($datostallersemter[$i]['idConfiguracionTaller'])) {
                    $validatallert[$i] = $datostallersemter[$i]['idAsignaturaTaller'];
                    for ($j = 0; $j < $largoalumnos; $j++) {
                        $promediofinal = 0;
                        $datosalumnostallert = $modelnotas->listarpromedioalumnotaller($listaalumnos[$j]['idAlumnos'], $idperiodo, 5, $id, $datostallersemter[$i]['idAsignatura']);

                        for ($k = 0; $k < count($datosalumnostallert); $k++) {
                            if ($datostallersemter[$i]['idAsignatura'] == $datosalumnostallert[$k]['idAsignatura']) {
                                if ($datosalumnostallert[$k]['coef'] == 2) {
                                    if ($datosalumnostallert[$k]['nota'] > 0) {
                                        $promediotallert[$j][$i][] = $datosalumnostallert[$k]['nota'];
                                        $promediotallert[$j][$i][] = $datosalumnostallert[$k]['nota'];

                                    } else {
                                        $promediotallert[$j][$i][] = 0;
                                        $promediotallert[$j][$i][] = 0;
                                    }

                                } else {
                                    if ($datosalumnostallert[$k]['nota'] > 0) {
                                        $promediotallert[$j][$i][] = $datosalumnostallert[$k]['nota'];
                                    } else {
                                        $promediotallert[$j][$i][] = 0;
                                    }

                                }


                            }


                        }
                        if (!empty($promediotallert[$j][$i])) {
                            $promsett = array_diff($promediotallert[$j][$i], array('0'));
                        } else {
                            $promsett = 0;
                        }

                        if (is_array($promsett)) {
                            if (count($promsett) > 0) {
                                if ($datoscurso[0]['aproxAsignatura'] == 1) {
                                    $auxtallert = round(array_sum($promsett) / count($promsett));
                                    $promtallert[$j][$i]['nota'] = intval($auxtallert);

                                } else {
                                    $promtallert[$j][$i]['nota'] = intval(array_sum($promsett) / count($promsett));
                                }
                            } else {
                                $promtallert[$j][$i]['nota'] = 0;
                            }

                        } else {
                            $promtallert[$j][$i]['nota'] = 0;
                        }


                        $promtallert[$j][$i]['idAsignatura'] = $datostallersemter[$i]['idAsignaturaTaller'];
                        $promtallert[$j][$i]['coef'] = 1;
                        $promtallert[$j][$i]['tiempo'] = 5;
                        $promtallert[$j][$i]['forma'] = $datostallersemter[$i]['forma'];
                        $promtallert[$j][$i]['porcentaje'] = $datostallersemter[$i]['porcentaje'];


                    }

                }


            }
        }


        if ($largoalumnos == 0) {
            echo "<script type=\"text/javascript\">alert(\"Sin Notas\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            exit;

        }


        for ($i = 0; $i < $largoalumnos; $i++) {

            $valores = $modelnotas->listarnotasporalumno($listaalumnos[$i]['idAlumnos'], $idperiodo, $id);
            if ($valores != '' || !empty($valores)) {
                $listaalumnos[$i]['listanotas'] = $valores;
            } else {
                $listaalumnos[$i]['listanotas'] = 0;

            }


            foreach ($promcom[$i] as $a => $j) {
                $listaalumnos[$i]['listanotas'][] = $promcom[$i][$a];
            }

            foreach ($promcoms[$i] as $a => $j) {
                $listaalumnos[$i]['listanotas'][] = $promcoms[$i][$a];
            }

            foreach ($promcomt[$i] as $a => $j) {
                $listaalumnos[$i]['listanotas'][] = $promcomt[$i][$a];
            }

            //Primer Trimestre
            for ($j = 0; $j < count($promtaller[$i]); $j++) {
                $listaalumnos[$i]['listanotas'][] = $promtaller[$i][$j];
            }
            //Segundo Trimestre
            for ($j = 0; $j < count($promtallers[$i]); $j++) {
                $listaalumnos[$i]['listanotas'][] = $promtallers[$i][$j];
            }

            //Tercer Trimestre
            for ($j = 0; $j < count($promtallert[$i]); $j++) {
                $listaalumnos[$i]['listanotas'][] = $promtallert[$i][$j];
            }


            if ($listapromediostaller[$i]) {
                for ($j = 0; $j < count($listapromediostaller[$i]); $j++) {
                    $listaalumnos[$i]['listanotas'][] = $listapromediostaller[$i][$j];
                }
            }

            if ($listapromediostallers[$i]) {
                for ($j = 0; $j < count($listapromediostallers[$i]); $j++) {
                    $listaalumnos[$i]['listanotas'][] = $listapromediostallers[$i][$j];
                }
            }


        }


        $nombreseg = 'FINAL';
        $logo = getcwd();
        $logo .= "/application/documentos/logos/" . $datoscurso[0]['extension'];


        // variables para encabezado
        $titulo = strtoupper($datoscurso[0]['nombreEstablecimiento']) . '<br>' . strtoupper($nombreseg);

        if (file_exists($logo)) {
            $encabezado = '<img style="position:absolute;top:10px;left:30px;"  src="' . $logo . '" /><h4 style="position:absolute;top:50px;text-align:center">' . $titulo . '</h4>';

        } else {
            $encabezado = '<p style="position:absolute;top:10px;left: 30px"></p><h4 style="position:absolute;top:50px;text-align:center">' . $titulo . '</h4>';

        }

        //Agregamos cantidad de notas por alumno y la asignamos a cada aisgnatura


        if (!empty($datosasignaturas)) {
            $largoasignatura = count($datosasignaturas);
            for ($i = 0; $i < $largoasignatura; $i++) {

                $datoscuenta[$i] = $modelnotas->listarcantidadnotasanual($id, $idperiodo, $datosasignaturas[$i]['idAsignatura']);
                if (empty($datoscuenta[$i]) && $datosasignaturas[$i]['tipoAsignatura'] == 1) {
                    $datosasig[$i] = 0;
                } else {
                    $largonotas = count($datoscuenta[$i]);
                    $datosasig[$i] = 0;

                    //Primer Trimestre
                    for ($j = 0; $j < count($validataller); $j++) {
                        if ($datosasignaturas[$i]['idAsignatura'] == $validataller[$j]) {
                            $datosasig[$i] += 1;
                        }
                    }
                    //Segundo Trimestre
                    for ($j = 0; $j < count($validatallers); $j++) {
                        if ($datosasignaturas[$i]['idAsignatura'] == $validatallers[$j]) {
                            $datosasig[$i] += 1;
                        }
                    }

                    //Tercer Trimestre
                    for ($j = 0; $j < count($validatallert); $j++) {
                        if ($datosasignaturas[$i]['idAsignatura'] == $validatallert[$j]) {
                            $datosasig[$i] += 1;
                        }
                    }
                    for ($j = 0; $j < count($validacom); $j++) {
                        foreach ($validacom[$j] as $a => $h) {
                            if ($datosasignaturas[$i]['idAsignatura'] == $validacom[$j][$a]) {
                                $datosasig[$i] += 1;
                            }
                        }

                    }

                    for ($j = 0; $j < count($datostalleres); $j++) {
                        if ($datosasignaturas[$i]['idAsignatura'] == $datostalleres[$j]['idAsignaturaTaller']) {
                            $datosasig[$i] += 1;
                        }
                    }

                    for ($j = 0; $j < $largonotas; $j++) {

                        if ($datoscuenta[$i][$j]['coef'] == 2) {
                            $datosasig[$i] += 2;
                        } else {
                            $datosasig[$i] += 1;
                        }

                    }


                }

                //Si la configuracion indica que se utiliza examen
                if ($datoscurso[0]['examen'] == 1) {
                    $modeloprueba = new Application_Model_DbTable_Pruebas();
                    //Veficiamos que las asignaturas posean examen
                    $datosexamenes[$i] = $modeloprueba->getexamen($id, $idperiodo, $datosasignaturas[$i]['idAsignatura'], 6);

                }
            }
        } else {
            echo "<script type=\"text/javascript\">alert(\"El Curso no Posee Asignaturas en el periodo\");</script>";
            echo "<script>parent.$.fancybox.close();</script>";
            exit;

        }


        //Estilo pdf
        $style = "body{
font:12px ,Arial, Tahoma, Verdana, Helvetica, sans-serif;

color:#000;
}
img{
  width:60px;
  height:70px;
}


table{
font-size:10px;
width:100%;
height:auto;
margin:10px 0 10px 0;
border-collapse:collapse;
text-align:center;
text-justify:inter-word;
color:#000000;
}

table td,th{
border:1px solid black;
}

table th{
padding:1px;
background-color: #ccc;
}
";

        $pag = 0;
        $cuentapag = 0;
        if ($paso) {
            $max = 7;
        } else {
            $max = 50;
        }


        $html[$pag] = $encabezado;
        $html[$pag] .= "<div style='position:absolute;top:75px;left:25px;'><br> Curso: <b>" . $datoscurso[0]['nombreGrado'] . " " . $datoscurso[0]['letra'] . "</b><br> Fecha : <b>" . $fecha_final . "</b></div>";

        $html[$pag] .= '<table align="left" style="margin-left:20px"><tr><th>Nº</th><th>Alumnos</th>';


        for ($i = 0; $i < $largoasignatura; $i++) {


            //obtenemos cuantas notas existen en cada asignatura
            $cuentapag += 1;

            // si la cantidad de notas supera las 28 sumamos al contador de pag
            if ($cuentapag > $max) {
                $pag++;
                if ($pag == 1) {
                    $max = 14;
                }
                if ($pag == 2) {
                    $max = 21;
                }

                $html[$pag] = '<table align="left" style="margin-left:20px"><tr><th>Nº</th><th>Alumno</th>';

            }

            if ($datosexamenes[$i]) {
                $html[$pag] .= '<th style="width:80px;text-align:justify;" colspan="6">' . $datosasignaturas[$i]["nombreAsignatura"] . '</th>';

            } else {
                $html[$pag] .= '<th style="width:80px;text-align:justify;" colspan="4">' . $datosasignaturas[$i]["nombreAsignatura"] . '</th>';

            }


        }

        $html[$pag] .= "<th>PROM</th><th>Días</th><th>Días</th><th>%</th>";


        $pag = 0;
        $cuentapag = 0;
        if ($paso) {
            $max = 7;
        } else {
            $max = 50;
        }

        $cuentapag2 = array();
        $contadorpag = 0;


        $html[$pag] .= '</tr><tr><th colspan="2">Promedios</th>';

        for ($i = 0; $i < $largoasignatura; $i++) {
            $cuentapag += 1;

            // si la cantidad de notas supera las notas que ingresan en una hoja
            if ($cuentapag > $max) {
                $html[$pag] .= '</tr>';
                $pag++;
                if ($pag == 1) {
                    $max = 14;
                }
                if ($pag == 2) {
                    $max = 21;
                }

                $html[$pag] .= '</tr><tr><th colspan="2">Promedios</th>';

            }


            if ($datosexamenes[$i]) {
                $html[$pag] .= '<th>I TRIM</th>';
                $html[$pag] .= '<th>II TRIM</th>';
                $html[$pag] .= '<th>II TRIM</th>';
                $html[$pag] .= '<th>FIN</th>';
                $html[$pag] .= '<th>EX <br>' . $datosexamenes[$i][0]['porcentajeExamen'] . ' %</th>';
                $html[$pag] .= '<th>FIN + <br>EX ' . $datosexamenes[$i][0]['porcentajeExamen'] . ' %</th>';
                $contadorpag++;
                $cuentapag2[$pag] += 6;
            } else {
                $html[$pag] .= '<th>I TRIM</th>';
                $html[$pag] .= '<th>II TRIM</th>';
                $html[$pag] .= '<th>II TRIM</th>';
                $html[$pag] .= '<th>FIN</th>';
                $contadorpag++;
                $cuentapag2[$pag] += 4;
            }


        }


        $html[$pag] .= '<th>PROM</th>';
        $cuentapag2[$pag] += 1;
        $html[$pag] .= '<th>Trab</th><th>Inas</th><th>Asis</th>';


        $html[$pag] .= '</tr>';


        if (!empty($listaalumnos)) {
            $r = 0;

            for ($i = 0; $i < $largoalumnos; $i++) {


                $pag = 0;
                $cuentapag = 0;
                if ($paso) {
                    $max = 7;
                } else {
                    $max = 50;
                }
                $html[$pag] .= '<tr><td>' . ($i + 1) . '</td><td style="text-align: left;">' . $listaalumnos[$i]["apaterno"] . ' ' . $listaalumnos[$i]["amaterno"] . ' ' . $listaalumnos[$i]["nombres"] . '</td>';
                $r = 0;


                for ($j = 0; $j < $largoasignatura; $j++) {

                    $promtalleraux = array();
                    $porcentajetaller = array();
                    $sumataller = 0;
                    $promtallerauxs = array();
                    $porcentajetallers = array();
                    $sumatallers = 0;

                    $promtallerauxt = array();
                    $porcentajetallert = array();
                    $sumatallert = 0;
                    $row = $datosasig[$j];
                    $cuentapag += 1;

                    if ($cuentapag > $max) {
                        $html[$pag] .= '</tr>';
                        $pag++;
                        if ($pag == 1) {
                            $max = 14;
                        }
                        if ($pag == 2) {
                            $max = 21;
                        }


                        $html[$pag] .= '<tr><td>' . ($i + 1) . '</td><td style="text-align: left;">' . $listaalumnos[$i]["apaterno"] . ' ' . $listaalumnos[$i]["amaterno"] . ' ' . $listaalumnos[$i]["nombres"] . '</td>';

                    }

                    $promedio = 0;
                    $contador = 0;
                    $contadorpromedio = 0;
                    $promedios = 0;
                    $contadorpromedios = 0;
                    $promediot = 0;
                    $contadorpromediot = 0;
                    if ($row != 0) {
                        $largolistanota = count($listaalumnos[$i]['listanotas']);
                        for ($z = 0; $z < $largolistanota; $z++) {
                            $contadoraux = 0;

                            if ($datosasignaturas[$j]['idAsignatura'] == $listaalumnos[$i]['listanotas'][$z]['idAsignatura']) {


                                //Primer Trimestre
                                if ($listaalumnos[$i]['listanotas'][$z]['tiempo'] == 3) {

                                    if ($listaalumnos[$i]['listanotas'][$z]['coef'] == 2) {
                                        $contador += 2;
                                        if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == NULL || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {
                                            $promedio += 0;
                                            $contadorpromedio += 0;


                                        } else {
                                            $promedio += ($listaalumnos[$i]['listanotas'][$z]['nota'] + $listaalumnos[$i]['listanotas'][$z]['nota']);
                                            $contadorpromedio += 2;

                                        }

                                    } else {
                                        $contador += 1;

                                        if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == NULL || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {
                                            if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"])) {
                                                if ($listaalumnos[$i]["listanotas"][$z]["nota"] == 0) {

                                                    $promedio += 0;
                                                    $contadorpromedio += 0;

                                                }

                                            } else {
                                                $promedio += 0;
                                                $contadorpromedio += 0;


                                            }


                                        } else {
                                            if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"]) && $listaalumnos[$i]["listanotas"][$z]["forma"] == 2) {

                                                $contadorauxtaller = true;
                                                $promtalleraux[] = $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $porcentajetaller[] = $listaalumnos[$i]["listanotas"][$z]["porcentaje"];


                                            } else {

                                                $promedio += $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $contadorpromedio += 1;


                                            }


                                        }


                                    }
                                }

                                //Segundo Trimestre
                                if ($listaalumnos[$i]['listanotas'][$z]['tiempo'] == 4) {


                                    if ($listaalumnos[$i]['listanotas'][$z]['coef'] == 2) {
                                        $contador += 2;
                                        if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == NULL || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {
                                            $promedios += 0;
                                            $contadorpromedios += 0;


                                        } else {
                                            $promedios += ($listaalumnos[$i]['listanotas'][$z]['nota'] + $listaalumnos[$i]['listanotas'][$z]['nota']);
                                            $contadorpromedios += 2;

                                        }

                                    } else {


                                        $contador += 1;

                                        if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == NULL || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {
                                            if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"])) {
                                                if ($listaalumnos[$i]["listanotas"][$z]["nota"] == 0) {

                                                    $promedios += 0;
                                                    $contadorpromedios += 0;

                                                }

                                            } else {
                                                $promedios += 0;
                                                $contadorpromedios += 0;


                                            }


                                        } else {
                                            if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"]) && $listaalumnos[$i]["listanotas"][$z]["forma"] == 2) {

                                                $contadorauxtallers = true;
                                                $promtallerauxs[] = $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $porcentajetallers[] = $listaalumnos[$i]["listanotas"][$z]["porcentaje"];


                                            } else {

                                                $promedios += $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $contadorpromedios += 1;


                                            }


                                        }


                                    }
                                }

                                //Tercer Trimestre
                                if ($listaalumnos[$i]['listanotas'][$z]['tiempo'] == 5) {


                                    if ($listaalumnos[$i]['listanotas'][$z]['coef'] == 2) {
                                        $contador += 2;
                                        if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == NULL || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {
                                            $promediot += 0;
                                            $contadorpromediot += 0;


                                        } else {
                                            $promediot += ($listaalumnos[$i]['listanotas'][$z]['nota'] + $listaalumnos[$i]['listanotas'][$z]['nota']);
                                            $contadorpromediot += 2;

                                        }

                                    } else {


                                        $contador += 1;

                                        if ($listaalumnos[$i]['listanotas'][$z]['nota'] == 0 || empty($listaalumnos[$i]['listanotas'][$z]['nota']) || $listaalumnos[$i]['listanotas'][$z]['nota'] == NULL || $listaalumnos[$i]['listanotas'][$z]['nota'] == '') {
                                            if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"])) {
                                                if ($listaalumnos[$i]["listanotas"][$z]["nota"] == 0) {

                                                    $promediot += 0;
                                                    $contadorpromediot += 0;

                                                }

                                            } else {
                                                $promediot += 0;
                                                $contadorpromediot += 0;


                                            }


                                        } else {
                                            if (!empty($listaalumnos[$i]["listanotas"][$z]["forma"]) && $listaalumnos[$i]["listanotas"][$z]["forma"] == 2) {

                                                $contadorauxtallert = true;
                                                $promtallerauxt[] = $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $porcentajetallert[] = $listaalumnos[$i]["listanotas"][$z]["porcentaje"];


                                            } else {

                                                $promediot += $listaalumnos[$i]['listanotas'][$z]['nota'];
                                                $contadorpromediot += 1;


                                            }


                                        }


                                    }
                                }


                                //Promedios por notas

                                if ($contador == $row) {


                                    //Primer Trimestre
                                    if ($contadorpromedio != 0 && $promedio != 0) {
                                        $promedioaux = 0;
                                        if ($contadorauxtaller) {
                                            $totalporcentaje = 100;
                                            if (count($promtalleraux) > 1) {
                                                for ($t = 0; $t < count($promtalleraux); $t++) {
                                                    $totalporcentaje = $totalporcentaje - $porcentajetaller[$t];
                                                    $sumataller += $promtalleraux[$t] * ($porcentajetaller[$t] / 100);
                                                }

                                            } else {
                                                $totalporcentaje = 100 - $porcentajetaller[0];
                                                $sumataller = $promtalleraux[0] * ($porcentajetaller[0] / 100);

                                            }


                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioaux = round($promedio / $contadorpromedio);
                                                $promedioaux = ($promedioaux * ($totalporcentaje / 100)) + $sumataller;
                                                $promedioaux = round($promedioaux);
                                                $notamatriz[$r][] = $promedioaux;

                                            } else {
                                                $promedioaux = round($promedio / $contadorpromedio);
                                                $promedioaux = ($promedioaux * ($totalporcentaje / 100)) + $sumataller;
                                                $promedioaux = intval($promedioaux);
                                                $notamatriz[$r][] = $promedioaux;
                                            }

                                        } else {

                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioaux = round($promedio / $contadorpromedio);
                                                $promfinal[$i][] = $promedioaux;
                                                $notamatriz[$r][] = $promedioaux;

                                            } else {
                                                $promedioaux = intval($promedio / $contadorpromedio);
                                                $promfinal[$i][] = $promedioaux;
                                                $notamatriz[$r][] = $promedioaux;
                                            }

                                        }
                                        $r++;


                                        $html[$pag] .= '<td>' . $promedioaux . '</td>';


                                    } else {
                                        $promedioaux = 0;
                                        $promfinal[$i][] = 0;
                                        $notamatriz[$r][] = 0;
                                        $html[$pag] .= '<td>-</td>';
                                        $r++;


                                    }


                                    //Segundo Trimestre
                                    if ($contadorpromedios != 0 && $promedios != 0) {
                                        $promedioauxs = 0;
                                        //SI el Taller es por porcentaje
                                        if ($contadorauxtallers) {
                                            $totalporcentajes = 100;
                                            if (count($promtallerauxs) > 1) {
                                                for ($t = 0; $t < count($promtallerauxs); $t++) {
                                                    $totalporcentajes = $totalporcentajes - $porcentajetallers[$t];
                                                    $sumatallers += $promtallerauxs[$t] * ($porcentajetallers[$t] / 100);
                                                }

                                            } else {
                                                $totalporcentajes = 100 - $porcentajetallers[0];
                                                $sumatallers = $promtallerauxs[0] * ($porcentajetallers[0] / 100);

                                            }


                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioauxs = round($promedios / $contadorpromedios);
                                                $promedioauxs = ($promedioauxs * ($totalporcentajes / 100)) + $sumatallers;
                                                $promedioauxs = round($promedioauxs);
                                                $notamatriz[$r][] = $promedioauxs;

                                            } else {
                                                $promedioauxs = round($promedios / $contadorpromedios);
                                                $promedioauxs = ($promedioauxs * ($totalporcentajes / 100)) + $sumatallers;
                                                $promedioauxs = intval($promedioauxs);
                                                $notamatriz[$r][] = $promedioauxs;
                                            }

                                        } else {

                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioauxs = round($promedios / $contadorpromedios);
                                                $promfinal[$i][] = $promedioauxs;
                                                $notamatriz[$r][] = $promedioauxs;

                                            } else {
                                                $promedioauxs = intval($promedios / $contadorpromedios);
                                                $promfinal[$i][] = $promedioauxs;
                                                $notamatriz[$r][] = $promedioauxs;
                                            }
                                        }
                                        $r++;


                                        $html[$pag] .= '<td>' . $promedioauxs . '</td>';


                                    } else {
                                        $promedioauxs = 0;
                                        $promfinal[$i][] = 0;
                                        $notamatriz[$r][] = 0;
                                        $html[$pag] .= '<td>-</td>';
                                        $r++;


                                    }

                                    //Tercer Trimestre
                                    if ($contadorpromediot != 0 && $promediot != 0) {
                                        $promedioauxt = 0;
                                        //SI el Taller es por porcentaje
                                        if ($contadorauxtallert) {
                                            $totalporcentajet = 100;
                                            if (count($promtallerauxt) > 1) {
                                                for ($t = 0; $t < count($promtallerauxt); $t++) {
                                                    $totalporcentajet = $totalporcentajet - $porcentajetallert[$t];
                                                    $sumatallert += $promtallerauxt[$t] * ($porcentajetallert[$t] / 100);
                                                }

                                            } else {
                                                $totalporcentajet = 100 - $porcentajetallert[0];
                                                $sumatallert = $promtallerauxt[0] * ($porcentajetallert[0] / 100);

                                            }


                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioauxt = round($promediot / $contadorpromediot);
                                                $promedioauxt = ($promedioauxt * ($totalporcentajet / 100)) + $sumatallert;
                                                $promedioauxt = round($promedioauxt);
                                                $notamatriz[$r][] = $promedioauxt;

                                            } else {
                                                $promedioauxt = round($promediot / $contadorpromediot);
                                                $promedioauxt = ($promedioauxt * ($totalporcentajet / 100)) + $sumatallert;
                                                $promedioauxt = intval($promedioauxt);
                                                $notamatriz[$r][] = $promedioauxt;
                                            }

                                        } else {

                                            if ($datoscurso[0]['aproxAsignatura'] == 1) {//Aproxima
                                                $promedioauxt = round($promediot / $contadorpromediot);
                                                $promfinal[$i][] = $promedioauxt;
                                                $notamatriz[$r][] = $promedioauxt;

                                            } else {
                                                $promedioauxt = intval($promediot / $contadorpromediot);
                                                $promfinal[$i][] = $promedioauxt;
                                                $notamatriz[$r][] = $promedioauxt;
                                            }
                                        }
                                        $r++;


                                        $html[$pag] .= '<td>' . $promedioauxt . '</td>';


                                    } else {
                                        $promedioauxt = 0;
                                        $promfinal[$i][] = 0;
                                        $notamatriz[$r][] = 0;
                                        $html[$pag] .= '<td>-</td>';
                                        $r++;


                                    }


                                    //Promedio Final De Asignatura

                                    $promedio_aux_asignatura = array($promedioaux, $promedioauxs, $promedioauxt);
                                    $resultado_auxiliar_asignatura = array_values(array_diff($promedio_aux_asignatura, array('0')));

                                    if (!empty($resultado_auxiliar_asignatura)) {


                                        if ($datoscurso[0]['aproxAnual'] == 1) {

                                            $finalasignatura = round((array_sum($resultado_auxiliar_asignatura)) / count($resultado_auxiliar_asignatura));

                                        } else {
                                            $finalasignatura = intval((array_sum($resultado_auxiliar_asignatura)) / count($resultado_auxiliar_asignatura));

                                        }

                                        if ($agregadecimas) {
                                            if ($finalasignatura >= 60) {
                                                $finalasignatura += 2;
                                                if ($finalasignatura > 70) {
                                                    $finalasignatura = 70;

                                                }

                                            }
                                        }
                                    } else {
                                        $finalasignatura = 0;
                                    }


                                    //Inicio Examen

                                    if (count($datosexamenes[$j]) > 0) {
                                        //$promediototal[$i][] = $finalasignatura;
                                        $html[$pag] .= '<td>' . $finalasignatura . '</td>';
                                        $notamatriz[$r][] = $finalasignatura;
                                        $r++;

                                        $datosalumnosexamen = $modelnotas->getnotasexamenalumno($datosexamenes[$j][0]['idEvaluacion'], $id, $datosasignaturas[$j]['idAsignatura'], $idperiodo, 6, $listaalumnos[$i]['idAlumnos']);


                                        if (count($datosalumnosexamen) > 0) {


                                            if ($datosalumnosexamen[0]['nota'] > 0) {
                                                $html[$pag] .= '<td>' . $datosalumnosexamen[0]['nota'] . '</td>';
                                                $notamatriz[$r][] = $datosalumnosexamen[0]['nota'];
                                                $r++;

                                                $totalex = 100 - $datosexamenes[$j][0]['porcentajeExamen'];

                                                //nota d examen

                                                $sumaex = $datosalumnosexamen[0]['nota'] * ($datosexamenes[$i][0]['porcentajeExamen'] / 100);

                                                if ($datoscurso[0]['aproxExamen'] == 1) {
                                                    $finalasignatura = round(($finalasignatura * ($totalex / 100)) + $sumaex);
                                                } else {
                                                    $finalasignatura = intval(($finalasignatura * ($totalex / 100)) + $sumaex);
                                                }


                                            } else {
                                                $html[$pag] .= '<td>-</td>';
                                                $notamatriz[$r][] = $datosalumnosexamen[0]['nota'];
                                                $r++;
                                                $finalasignatura = $finalasignatura;
                                            }

                                        } else {
                                            $html[$pag] .= '<td>-</td>';
                                            $notamatriz[$r][] = 0;
                                            $r++;
                                        }
                                        //Promedio FInal
                                        $promediototal[$i][] = $finalasignatura;
                                        $html[$pag] .= '<td>' . $finalasignatura . '</td>';
                                        $notamatriz[$r][] = $finalasignatura;
                                        $r++;
                                    } else {
                                        $promediototal[$i][] = $finalasignatura;
                                        $html[$pag] .= '<td>' . $finalasignatura . '</td>';
                                        $notamatriz[$r][] = $finalasignatura;
                                        $r++;
                                    }

                                }// fin promedio por notas

                            }

                        }// fin for


                    } else {
                        $html[$pag] .= '<td>-</td><td>-</td><td>-</td><td>-</td>';
                        $notamatriz[$r][] = 0;
                        $r++;
                        $notamatriz[$r][] = 0;
                        $r++;
                        $notamatriz[$r][] = 0;
                        $r++;
                        $notamatriz[$r][] = 0;
                        $r++;


                    } //fin if row


                } //fin for Asignaturas


                if ($promediototal[$i] != '' || $promediototal[$i] != null) {

                    if ($datoscurso[0]['aproxFinal'] == 1) {//Aproxima
                        $promediototal[$i] = array_diff($promediototal[$i], array('0'));
                        $promediofinal = round(array_sum($promediototal[$i]) / count($promediototal[$i]));

                    } else {
                        $promediototal[$i] = array_diff($promediototal[$i], array('0'));
                        $promediofinal = intval(array_sum($promediototal[$i]) / count($promediototal[$i]));


                    }


                    $html[$pag] .= '<td>' . $promediofinal . '</td>';
                    $notamatriz[$r][] = $promediofinal;

                } else {
                    $html[$pag] .= '<td>-</td>';
                    $notamatriz[$r][] = 0;
                }


                $detallealumnoprimer = $modeldetalle->listardetalleperiodo($listaalumnos[$i]['idAlumnosActual'], 1, $idperiodo);
                $detallealumnosegundo = $modeldetalle->listardetalleperiodo($listaalumnos[$i]['idAlumnosActual'], 2, $idperiodo);

                $diasin = $detallealumnoprimer[0]['diasInasistencia'] + $detallealumnosegundo[0]['diasInasistencia'];
                $diastrabajados = $detallealumnoprimer[0]['diasTrabajado'] + $detallealumnosegundo[0]['diasTrabajado'];
                if ($diasin != 0 && $diastrabajados > 0) {
                    $valor = $diasin / $diastrabajados;
                    $aux = 1 - $valor;
                    $totald = $aux * 100;
                } elseif (($diasin == 0 || $diasin == '') && $diastrabajados > 0) {
                    $valor = $diasin / $diastrabajados;
                    $aux = 1 - $valor;
                    $totald = $aux * 100;
                } else {
                    $totald = 0;
                    $diastrabajados = "-";
                    $diasin = "-";
                }

                $html[$pag] .= '<td>' . $diastrabajados . '</td><td>' . $diasin . '</td><td>' . intval($totald) . '%</td>';


                $html[$pag] .= '</tr>';


            }

            $aux = 0;
            $max = 0;
            $largocuenta = 0;
            $largoes = count($cuentapag2);

            //Estadistica de notas
            for ($i = 0; $i < count($cuentapag2); $i++) {
                $max = $max + $cuentapag2[$i];
                if ($i > 0) {
                    $aux = $aux + $cuentapag2[$i - 1];
                    $largocuenta = $largocuenta + $cuentapag2[$i];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Promedio Generales</td>';
                } else {

                    $aux = 0;
                    $largocuenta = $cuentapag2[$i];
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Promedio Generales</td>';
                }


                for ($y = $aux; $y < $largocuenta; $y++) {
                    $notamatrizset = array_diff($notamatriz[$y], array('0'));
                    if (array_sum($notamatrizset) != 0) {
                        $html[$i] .= '<td>' . round(array_sum($notamatrizset) / count($notamatrizset)) . '</td>';
                    } else {
                        $html[$i] .= '<td>-</td>';
                    }


                }
                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';


                //Minimos
                if ($i > 0) {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Mínimo</td>';
                } else {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Mínimo</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {

                    $valormin = array_sum($notamatriz[$y]);
                    if ($valormin != 0) {
                        $html[$i] .= '<td>' . min(array_diff($notamatriz[$y], array(0))) . '</td>';
                    } else {
                        $html[$i] .= '<td>-</td>';
                    }


                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';

                //Maximos
                if ($i > 0) {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Máximo</td>';
                } else {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Máximo</td>';
                }


                for ($y = $aux; $y < $largocuenta; $y++) {
                    $valormax = array_sum($notamatriz[$y]);
                    if ($valormax != 0) {
                        $html[$i] .= '<td>' . max(array_diff($notamatriz[$y], array(0))) . '</td>';
                    } else {
                        $html[$i] .= '<td>-</td>';
                    }
                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';

                //Adecuado

                if ($i > 0) {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Adecuado</td>';
                } else {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Adecuado</td>';
                }


                for ($y = $aux; $y < $largocuenta; $y++) {
                    $contadorinicial = 0;
                    $largomatriz = count($notamatriz[$y]);
                    for ($v = 0; $v < $largomatriz; $v++) {
                        if ($notamatriz[$y][$v] > 59 && $notamatriz[$y][$v] <= 70) {
                            $contadorinicial = $contadorinicial + 1;

                        }
                    }
                    $totaladecuado[$y] = $contadorinicial;

                    $html[$i] .= '<td>' . $contadorinicial . '</td>';

                }
                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';

                //Elemntal
                if ($i > 0) {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Elemental</td>';
                } else {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Elemental</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {
                    $contadorinicial = 0;
                    $largomatriz = count($notamatriz[$y]);
                    for ($v = 0; $v < $largomatriz; $v++) {
                        if ($notamatriz[$y][$v] > 39 && $notamatriz[$y][$v] < 60) {
                            $contadorinicial = $contadorinicial + 1;

                        }
                    }

                    $totalelemental[$y] = $contadorinicial;
                    $html[$i] .= '<td>' . $contadorinicial . '</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';


                //Insuficiente
                if ($i > 0) {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Insuficiente</td>';
                } else {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Insuficiente</td>';
                }


                for ($y = $aux; $y < $largocuenta; $y++) {
                    $contadorinicial = 0;
                    $largomatriz = count($notamatriz[$y]);
                    for ($v = 0; $v < $largomatriz; $v++) {
                        if ($notamatriz[$y][$v] > 10 && $notamatriz[$y][$v] < 40) {
                            $contadorinicial = $contadorinicial + 1;

                        }
                    }

                    $totalinsuficiente[$y] = $contadorinicial;

                    $html[$i] .= '<td>' . $contadorinicial . '</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';


                //Totales
                if ($i > 0) {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Total</td>';
                } else {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">Total</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {
                    $total[$y] = ($totaladecuado[$y] + $totalelemental[$y] + $totalinsuficiente[$y]);

                    $html[$i] .= '<td>' . $total[$y] . '</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';


                //Porcentaje Adecuado

                if ($i > 0) {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Adecuado</td>';
                } else {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Adecuado</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {

                    if ($total[$y] > 0) {
                        $porcentaje = ($totaladecuado[$y] / $total[$y]) * 100;
                    } else {
                        $porcentaje = 0;
                    }

                    $html[$i] .= '<td>' . round($porcentaje) . '%</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';

                //Porcentaje Elemental
                if ($i > 0) {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Elemental</td>';
                } else {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Elemental</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {

                    if ($total[$y] > 0) {
                        $porcentaje = ($totalelemental[$y] / $total[$y]) * 100;
                    } else {
                        $porcentaje = 0;
                    }

                    $html[$i] .= '<td>' . round($porcentaje) . '%</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';

                //Porcentaje Suficiente

                if ($i > 0) {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Insuficiente</td>';
                } else {
                    $html[$i] .= '<tr bgcolor="#f0ffff"><td colspan="2">% Insuficiente</td>';
                }

                for ($y = $aux; $y < $largocuenta; $y++) {

                    if ($total[$y] > 0) {
                        $porcentaje = ($totalinsuficiente[$y] / $total[$y]) * 100;
                    } else {
                        $porcentaje = 0;
                    }

                    $html[$i] .= '<td>' . round($porcentaje) . '%</td>';

                }

                if ($i == ($largoes - 1)) {
                    $html[$i] .= '<td>-</td><td>-</td><td>-</td>';
                }

                $html[$i] .= '</tr>';


            }

        }

        if ($paso) {
            if ($html != '') {

                require 'fpdf/html2pdf.class.php';
                try {
                    $width_in_mm = 216;
                    $height_in_mm = 330;
                    $pdf = new HTML2PDF('L', array($width_in_mm, $height_in_mm), 'es', true, 'UTF-8', array(0, 0, 0, 0) /*márgenes*/); //los márgenes también pueden definirse en <page> ver documentación
                    $pdf->pdf->SetDisplayMode('fullpage');
                    for ($i = 0; $i < count($html); $i++) {

                        $pdf->WriteHTML('<page><html>
                        <head>
                            <style>' . $style . '</style>
                        </head>
                        <body>' . $html[$i] . '</table></body></html></page>');
                    }

                    if (preg_match("/MSIE/i", $_SERVER["HTTP_USER_AGENT"])) {
                        header("Content-type: application/PDF");
                    } else {
                        header("Content-type: application/PDF");
                        header("Content-Type: application/pdf");
                    }

                    $pdf->Output('Planificacion.pdf', I);
                } catch (HTML2PDF_exception $e) {
                    //echo "<script type=\"text/javascript\">alert(\"No se Puede generar el documento, intente nuevamente\");</script>";
                    //echo "<script>parent.$.fancybox.close();</script>";
                    echo $e;
                }
            }
        } else {


            $filename = "Informe Promedios " . strftime("%A %d de %B del %Y") . "";
            $tmpfile = tempnam(sys_get_temp_dir(), 'html');
            file_put_contents($tmpfile, $html);

            $reader = new \PhpOffice\PhpSpreadsheet\Reader\Html();
            $spreadsheet = $reader->load($tmpfile);
            $writer = new \PhpOffice\PhpSpreadsheet\Writer\Xlsx($spreadsheet);
            $writer->save('export.xlsx');
            header('Content-Type: application/vnd.ms-excel');
            header('Content-Disposition: attachment; filename="' . $filename . '.xlsx"');
            $writer->save("php://output");
            unlink($tmpfile); // delete temporary file because it isn't needed anymore
            exit;


        }
    }

    public function getpromediopre($lista_notas,$lista_equivalencia){

        $valor_promedio=0;
        $largo = count($lista_notas);
        $promedio=array();

            for ($i = 0; $i < $largo; $i++) {
                $valor_aux = $this->equivalencias_notas($lista_equivalencia, $lista_notas[$i]['porcentajenota']);
                $promedio[$i] = $valor_aux;

            }

        $promaux = array_diff($promedio, array('0'));

        $valor_promedio = round(array_sum($promaux) / count($promaux));
        return $valor_promedio;
    }

    private function promedioaconcepto($promedio){
        $concepto='';

        if ($promedio >= 61 && $promedio <= 70) {
            $concepto = 'IT';

        } elseif ($promedio >= 40 && $promedio <= 60) {

            $concepto = 'AV';
        } elseif ($promedio >= 1 && $promedio <= 39) {
            $concepto = 'IN';
        }
        return $concepto;
    }


}
